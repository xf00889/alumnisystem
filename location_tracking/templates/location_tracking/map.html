{% extends 'base.html' %}
{% load static %}

{% block title %}Alumni Location Tracking{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<!-- Add Leaflet.markercluster CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
<!-- Custom styles for clusters -->
<style>
    /* Add avatar background classes */
    .avatar-bg-default {
        background-image: url('{% static "images/default-avatar.png" %}');
    }

    :root {
        --primary-color: #2b3c6b;
        --secondary-color: #3c4f8a;
        --accent-color: #4CAF50;
        --background-light: #f8f9fa;
        --background-dark: #1a1a1a;
        --text-light: #ffffff;
        --text-dark: #333333;
        --shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    /* Dark mode styles */
    [data-theme="dark"] {
        --background-color: var(--background-dark);
        --text-color: var(--text-light);
    }

    .map-interface {
        font-family: 'Roboto', sans-serif;
        padding: 20px;
    }

    .map-container {
        background: var(--background-light);
        border-radius: 12px;
        box-shadow: var(--shadow);
        padding: 20px;
        margin-bottom: 20px;
    }

    .controls-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .search-box {
        position: relative;
        margin-bottom: 15px;
    }

    .search-box input {
        width: 100%;
        padding: 12px 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s ease;
    }

    .search-box input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(43, 60, 107, 0.2);
        outline: none;
    }

    .filters-container {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }

    .filter-select {
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background-color: white;
        min-width: 150px;
        font-size: 14px;
    }

    #map {
        height: 700px;
        width: 100%;
        border-radius: 12px;
        box-shadow: var(--shadow);
        z-index: 1;
    }

    .location-info {
        padding: 15px;
        background: white;
        border-radius: 8px;
        box-shadow: var(--shadow);
        max-width: 300px;
    }

    .location-info h4 {
        margin: 0 0 10px 0;
        color: var(--primary-color);
        font-size: 16px;
    }

    .location-info p {
        margin: 5px 0;
        font-size: 14px;
        color: #666;
    }

    .location-badge {
        display: inline-block;
        padding: 4px 8px;
        background: var(--primary-color);
        color: white;
        border-radius: 4px;
        font-size: 12px;
        margin-top: 5px;
    }

    .stats-container {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        margin-bottom: 20px;
    }

    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: var(--shadow);
        text-align: center;
        transition: all 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }

    .stat-card h3 {
        color: var(--primary-color);
        margin: 0;
        font-size: 32px;
        font-weight: 700;
    }

    .stat-card p {
        color: #666;
        margin: 5px 0 0 0;
        font-size: 14px;
        font-weight: 500;
    }

    /* Loading indicator */
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        border-radius: 12px;
    }

    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Responsive adjustments */
    @media (max-width: 992px) {
        .stats-container {
            grid-template-columns: repeat(3, 1fr);
        }
        
        .controls-container {
            grid-template-columns: 1fr;
        }
    }
    
    @media (max-width: 768px) {
        .stats-container {
            grid-template-columns: 1fr;
        }

        #map {
            height: 500px;
        }
    }

    .marker-popup {
        font-family: 'Roboto', sans-serif;
        padding: 10px;
    }

    .marker-popup .popup-header {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }

    .marker-popup .popup-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 10px;
        background: var(--bg-secondary);
        object-fit: cover;
    }

    .marker-popup .popup-name {
        font-size: 16px;
        font-weight: 500;
        color: var(--text-primary);
    }

    .marker-popup .popup-details {
        font-size: 14px;
        color: var(--text-secondary);
    }

    .marker-popup .popup-detail-item {
        display: flex;
        align-items: center;
        margin: 5px 0;
    }

    .marker-popup .popup-detail-item i {
        margin-right: 8px;
        width: 16px;
    }

    /* Location button styles */
    .location-button {
        position: fixed;
        bottom: 80px;
        right: 20px;
        z-index: 1000;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        cursor: pointer;
        box-shadow: var(--shadow);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .location-button:hover {
        transform: scale(1.1);
        background: var(--secondary-color);
    }

    .location-button i {
        font-size: 20px;
    }

    .avatar-mini {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background-color: #ced4da;
        background-size: cover;
        background-position: center;
        flex-shrink: 0;
    }

    .batch-groups {
        max-height: 400px;
        overflow-y: auto;
        padding-right: 10px;
    }

    .user-name {
        font-size: 14px;
        font-weight: 500;
    }

    .batch-group h4 {
        border-bottom: 1px solid #e9ecef;
        padding-bottom: 8px;
        margin-bottom: 10px;
    }

    /* Style scrollbar for batch groups */
    .batch-groups::-webkit-scrollbar {
        width: 6px;
    }

    .batch-groups::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    .batch-groups::-webkit-scrollbar-thumb {
        background: #2b3c6b;
        border-radius: 10px;
    }

    .users-stats-container {
        background-color: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        height: 100%;
    }
    
    .users-list-container {
        display: flex;
        flex-direction: column;
        height: 100%;
    }
    
    .batch-header {
        background-color: var(--primary-color);
        color: white;
        border-radius: 8px;
        padding: 8px 15px;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .user-item {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 8px 12px;
        margin-bottom: 8px;
        transition: all 0.2s ease;
    }
    
    .user-item:hover {
        background-color: #e9ecef;
        transform: translateX(5px);
    }
    
    .page-title {
        color: var(--primary-color);
        margin-bottom: 20px;
        font-weight: 700;
        border-left: 5px solid var(--primary-color);
        padding-left: 15px;
    }
    
    .alert-info {
        border-left: 4px solid #0dcaf0;
    }
    
    .alert-warning {
        border-left: 4px solid #ffc107;
    }
    
    .badge {
        font-size: 12px;
        font-weight: 500;
        padding: 5px 10px;
        border-radius: 20px;
    }

    .alumni-item {
        cursor: pointer;
        position: relative;
        border-left: 3px solid transparent;
        transition: all 0.2s ease;
        padding-left: 10px;
    }
    
    .alumni-item.active {
        background-color: #e2e8f0;
        border-left: 3px solid var(--primary-color);
    }
    
    .alumni-item::after {
        content: '\f05b';
        font-family: 'Font Awesome 5 Free';
        font-weight: 900;
        position: absolute;
        right: 10px;
        color: var(--primary-color);
        opacity: 0;
        transition: opacity 0.2s ease;
    }
    
    .alumni-item:hover {
        background-color: #f0f4f8;
        transform: translateX(5px);
    }
    
    .alumni-item:hover::after {
        opacity: 1;
    }
    
    /* Add pulsing effect to active user on map */
    .alumni-item.active::before {
        content: '';
        position: absolute;
        left: -3px;
        top: 0;
        height: 100%;
        width: 3px;
        background-color: var(--primary-color);
        /* Remove the animation that causes vibration */
    }
    
    @keyframes pulse-border {
        /* This animation is no longer used */
    }

    /* Add tooltip and hover effects for alumni items */
    .user-list {
        position: relative;
    }
    
    .user-list::before {
        content: 'Click on an alumni to see their location on the map';
        position: absolute;
        top: -30px;
        left: 0;
        right: 0;
        background-color: rgba(43, 60, 107, 0.8);
        color: white;
        font-size: 12px;
        padding: 5px 10px;
        border-radius: 4px;
        text-align: center;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
        z-index: 10;
    }
    
    .user-list:hover::before {
        opacity: 1;
    }

    /* Add marker styles */
    .custom-marker {
        background: transparent;
        border: none;
    }
    
    .marker-container {
        position: relative;
        width: 50px;
        height: 50px;
    }
    
    .marker {
        width: 50px;
        height: 50px;
        background: #2b3c6b;
        border: 3px solid #ffffff;
        border-radius: 50%;
        box-shadow: 0 3px 15px rgba(0, 0, 0, 0.3);
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        overflow: hidden;
        animation: markerAppear 0.3s ease-out;
        z-index: 2;
    }
    
    /* Add highlight effect styles */
    .highlight-marker .marker {
        border-color: #ffc107;
        box-shadow: 0 0 0 8px rgba(255, 193, 7, 0.3);
    }
    
    @keyframes highlight-pulse {
        /* This animation is no longer used */
    }

    .marker-cluster {
        background-color: rgba(43, 60, 107, 0.6);
        border-radius: 50%;
        width: 30px !important;
        height: 30px !important;
        display: flex !important;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        text-align: center;
        box-shadow: 0 0 0 4px rgba(43, 60, 107, 0.3);
    }
    
    .marker-cluster-small {
        background-color: rgba(43, 60, 107, 0.6);
    }
    
    .marker-cluster-medium {
        background-color: rgba(43, 60, 107, 0.7);
    }
    
    .marker-cluster-large {
        background-color: rgba(43, 60, 107, 0.8);
    }
    
    .marker-cluster div {
        background-color: rgba(43, 60, 107, 0.9);
        width: 26px;
        height: 26px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-left: 2px;
        margin-top: 2px;
        color: white;
    }
</style>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="map-interface">
    <div class="container-fluid">
        <h1 class="page-title h3">Alumni Location Tracking</h1>
        
        <!-- Stats Overview -->
        <div class="stats-container">
            <div class="stat-card">
                <h3 id="totalAlumni">{{ total_users }}</h3>
                <p>Total Alumni Online</p>
            </div>
            <div class="stat-card">
                <h3 id="totalBatches">{{ batch_groups|length }}</h3>
                <p>Batches Represented</p>
            </div>
            <div class="stat-card">
                <h3 id="totalCourses">2</h3>
                <p>Different Courses</p>
            </div>
        </div>

        <div class="row">
            <!-- Controls Section -->
            <div class="col-md-4 mb-4">
                <div class="users-stats-container">
                    <div class="users-list-container">
                        <h3 class="h5 mb-3">
                            Active Alumni Locations
                            {% if total_users > 0 %}
                            <span class="badge bg-primary">{{ total_users }}</span>
                            {% endif %}
                        </h3>
                        
                        <div class="search-box mb-3">
                            <input type="text" id="alumniSearch" placeholder="Search alumni..." class="form-control" />
                        </div>
                        
                        <div class="filters-container mb-3">
                            <select class="form-select mb-2" id="batchFilter">
                                <option value="">All Batches</option>
                            </select>
                            <select class="form-select mb-2" id="courseFilter">
                                <option value="">All Courses</option>
                            </select>
                            <select class="form-select" id="locationFilter">
                                <option value="">All Locations</option>
                            </select>
                        </div>
                        
                        {% if total_users > 0 %}
                            <div class="alert alert-info">
                                <p class="mb-1"><strong>{{ total_users }}</strong> alumni currently sharing their location</p>
                                <small>Updated every 5 minutes</small>
                            </div>
                            
                            <div class="batch-groups mt-4">
                                {% for batch, users in batch_groups.items %}
                                <div class="batch-group mb-3">
                                    <div class="batch-header">
                                        <h4 class="h6 mb-0">Batch {{ batch }}</h4>
                                        <span class="badge bg-light text-dark">{{ users|length }}</span>
                                    </div>
                                    <div class="user-list">
                                        {% for user in users %}
                                        <div class="user-item d-flex align-items-center alumni-item" 
                                             data-lat="{{ user.latitude|default:'' }}" 
                                             data-lng="{{ user.longitude|default:'' }}"
                                             data-name="{{ user.name }}"
                                             style="cursor: pointer;">
                                            {% if user.avatar %}
                                            <div class="avatar-mini me-2" style="background-image: url('{{ user.avatar }}');"></div>
                                            {% else %}
                                            <div class="avatar-mini me-2 avatar-bg-default"></div>
                                            {% endif %}
                                            <div>
                                                <div class="user-name">{{ user.name }}</div>
                                                <small class="text-muted">{{ user.course }}</small>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <span>No alumni are currently sharing their location</span>
                            </div>
                            <p class="text-muted small">Location sharing requires:</p>
                            <ol class="text-muted small">
                                <li>User to be logged in to their account</li>
                                <li>Browser location permissions to be granted</li>
                                <li>Device to have GPS or location services enabled</li>
                            </ol>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Map Container -->
            <div class="col-md-8 mb-4">
                <div class="map-container">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <h5 class="mb-0"><i class="fas fa-map-marked-alt me-2"></i>Alumni Map</h5>
                        <button id="refreshMap" class="btn btn-sm btn-primary">
                            <i class="fas fa-sync-alt me-1"></i> Refresh Map
                        </button>
                    </div>
                    <div style="position: relative;">
                        <div id="map"></div>
                        <div class="loading-overlay">
                            <div class="loading-spinner"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Location Button -->
<button class="location-button" id="locationButton" title="Go to my location">
    <i class="fas fa-crosshairs"></i>
</button>
{% endblock %}

{% block page_specific_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Add Leaflet.markercluster JS -->
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<script src="{% static 'js/location_tracking.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize the map
    const map = L.map('map').setView([8.6538, 123.3458], 13);

    // Custom marker icon with avatar
    function createCustomMarker(alumni) {
        return L.divIcon({
            className: 'custom-marker',
            html: `
                <div class="marker-container">
                    <div class="pulse"></div>
                    <div class="marker">
                        <div class="avatar" style="background-image: url('${alumni.avatar || '{% static "images/default-avatar.png" %}'}')"></div>
                    </div>
                </div>
            `,
            iconSize: [50, 50],
            iconAnchor: [25, 50],
            popupAnchor: [0, -50]
        });
    }

    // Add marker styles
    const markerStyles = `
        <style>
            .custom-marker {
                background: transparent;
                border: none;
            }
            
            .marker-container {
                position: relative;
                width: 50px;
                height: 50px;
            }
            
            .marker {
                width: 50px;
                height: 50px;
                background: #2b3c6b;
                border: 3px solid #ffffff;
                border-radius: 50%;
                box-shadow: 0 3px 15px rgba(0, 0, 0, 0.3);
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                overflow: hidden;
                animation: markerAppear 0.3s ease-out;
                z-index: 2;
            }

            .avatar {
                width: 100%;
                height: 100%;
                background-size: cover;
                background-position: center;
                background-repeat: no-repeat;
                background-color: #2b3c6b;
            }

            .pulse {
                width: 50px;
                height: 50px;
                background: rgba(43, 60, 107, 0.4);
                border-radius: 50%;
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                animation: pulse 2s infinite;
            }

            @keyframes pulse {
                0% {
                    transform: translate(-50%, -50%) scale(0.5);
                    opacity: 1;
                }
                100% {
                    transform: translate(-50%, -50%) scale(2);
                    opacity: 0;
                }
            }

            @keyframes markerAppear {
                0% {
                    transform: translate(-50%, -50%) scale(0);
                    opacity: 0;
                }
                50% {
                    transform: translate(-50%, -50%) scale(1.2);
                }
                100% {
                    transform: translate(-50%, -50%) scale(1);
                    opacity: 1;
                }
            }

            .leaflet-popup {
                margin-bottom: 10px;
            }

            .leaflet-popup-content-wrapper {
                border-radius: 12px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
                overflow: hidden;
            }

            .leaflet-popup-content {
                margin: 0;
                padding: 0;
            }

            .location-info {
                padding: 20px;
                background: white;
                border-radius: 12px;
            }

            .location-info .avatar-header {
                display: flex;
                align-items: center;
                gap: 12px;
                margin-bottom: 15px;
            }

            .location-info .avatar-small {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                background-size: cover;
                background-position: center;
                background-repeat: no-repeat;
                border: 2px solid #2b3c6b;
                background-color: #2b3c6b;
            }

            .location-info h4 {
                color: #2b3c6b;
                font-size: 18px;
                font-weight: 600;
                margin: 0;
            }

            .location-info p {
                display: flex;
                align-items: center;
                gap: 8px;
                margin: 8px 0;
                color: #555;
            }

            .location-info i {
                color: #2b3c6b;
                width: 20px;
                text-align: center;
            }

            .location-badge {
                background: #4CAF50;
                color: white;
                padding: 6px 12px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 500;
                display: inline-flex;
                align-items: center;
                gap: 5px;
                margin-top: 10px;
            }

            .location-badge::before {
                content: '';
                display: inline-block;
                width: 8px;
                height: 8px;
                background: #fff;
                border-radius: 50%;
            }
        </style>
    `;
    document.head.insertAdjacentHTML('beforeend', markerStyles);

    // Add map tiles with English labels
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Create a marker cluster group instead of individual markers
    let markerClusterGroup = L.markerClusterGroup({
        maxClusterRadius: function(zoom) {
            // Adjust cluster radius based on zoom level
            // When zoomed out, cluster more aggressively
            if (zoom < 10) return 80;
            if (zoom < 12) return 60;
            if (zoom < 14) return 40;
            if (zoom < 16) return 20;
            return 10; // When zoomed in very close, cluster less
        },
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        zoomToBoundsOnClick: true,
        disableClusteringAtZoom: 16, // Disable clustering at zoom level 16 and higher
        iconCreateFunction: function(cluster) {
            // Create custom cluster icon
            const count = cluster.getChildCount();
            let size = 'small';
            
            if (count > 10) size = 'medium';
            if (count > 20) size = 'large';
            
            return L.divIcon({
                html: `<div><span>${count}</span></div>`,
                className: `marker-cluster marker-cluster-${size}`,
                iconSize: L.point(40, 40)
            });
        }
    });
    
    // Add marker cluster group to map
    map.addLayer(markerClusterGroup);

    const markers = {};
    let alumniData = [];
    let filteredData = [];
    
    // Store alumni positions keyed by name
    let alumniPositions = {};

    // Cache for batch and course data
    const batchesSet = new Set();
    const coursesSet = new Set();
    const locationsSet = new Set();

    // Flag to prevent multiple simultaneous operations
    let isProcessingClick = false;
    
    // Active alumni state management
    let activeAlumniName = null;
    let lastActivePopup = null;
    let shouldKeepPopupOpen = false;
    let isUpdatingLocations = false;
    
    // Add popups tracker for better management
    const popupTracker = {
        lastOpened: null,
        isPopupVisible: false,
        
        setActive: function(name, marker) {
            this.lastOpened = name;
            this.isPopupVisible = true;
            lastActivePopup = marker.getPopup();
        },
        
        closeAll: function() {
            if (!shouldKeepPopupOpen) {
                this.isPopupVisible = false;
                map.closePopup();
            }
        },
        
        restore: function() {
            if (this.lastOpened && markers[this.lastOpened] && shouldKeepPopupOpen) {
                // Only try to restore if it was previously visible
                if (this.isPopupVisible) {
                    // Use a timeout to ensure the map has finished other operations
                    setTimeout(() => {
                        if (markers[this.lastOpened]) {
                            markers[this.lastOpened].openPopup();
                        }
                    }, 100);
                }
            }
        }
    };

    function updateFilters() {
        const batchFilter = document.getElementById('batchFilter');
        const courseFilter = document.getElementById('courseFilter');
        const locationFilter = document.getElementById('locationFilter');

        // Update filter options
        batchesSet.forEach(batch => {
            if (!batchFilter.querySelector(`option[value="${batch}"]`)) {
                const option = document.createElement('option');
                option.value = batch;
                option.textContent = `Batch ${batch}`;
                batchFilter.appendChild(option);
            }
        });

        coursesSet.forEach(course => {
            if (!courseFilter.querySelector(`option[value="${course}"]`)) {
                const option = document.createElement('option');
                option.value = course;
                option.textContent = course;
                courseFilter.appendChild(option);
            }
        });

        locationsSet.forEach(location => {
            if (!locationFilter.querySelector(`option[value="${location}"]`)) {
                const option = document.createElement('option');
                option.value = location;
                option.textContent = location;
                locationFilter.appendChild(option);
            }
        });
    }

    function filterMarkers() {
        // Save the state of currently open popup before filtering
        const wasPopupVisible = popupTracker.isPopupVisible;
        
        if (!shouldKeepPopupOpen) {
            popupTracker.closeAll();
        }

        const searchTerm = document.getElementById('alumniSearch').value.toLowerCase();
        const selectedBatch = document.getElementById('batchFilter').value;
        const selectedCourse = document.getElementById('courseFilter').value;
        const selectedLocation = document.getElementById('locationFilter').value;

        filteredData = alumniData.filter(alumni => {
            const matchesSearch = alumni.user.toLowerCase().includes(searchTerm) ||
                                alumni.batch.toString().includes(searchTerm) ||
                                alumni.course.toLowerCase().includes(searchTerm);
            const matchesBatch = !selectedBatch || alumni.batch.toString() === selectedBatch;
            const matchesCourse = !selectedCourse || alumni.course === selectedCourse;
            const matchesLocation = !selectedLocation || alumni.location === selectedLocation;

            return matchesSearch && matchesBatch && matchesCourse && matchesLocation;
        });

        // Track if the active alumni is still in the filtered set
        let isActiveAlumniVisible = false;
        if (activeAlumniName) {
            isActiveAlumniVisible = filteredData.some(alumni => alumni.user === activeAlumniName);
        }

        // Clear existing markers and the cluster group
        markerClusterGroup.clearLayers();
        Object.keys(markers).forEach(key => delete markers[key]);

        // Add new markers with custom icon to the cluster group
        filteredData.forEach(alumni => {
            const position = [alumni.latitude, alumni.longitude];
            const marker = L.marker(position, { icon: createCustomMarker(alumni) })
                .bindPopup(createPopupContent(alumni), {
                    autoClose: false,
                    closeOnClick: false
                });
                
            markers[alumni.user] = marker;
            markerClusterGroup.addLayer(marker);
        });

        // Update stats
        document.getElementById('totalAlumni').textContent = filteredData.length;
        document.getElementById('totalBatches').textContent = new Set(filteredData.map(a => a.batch)).size;
        document.getElementById('totalCourses').textContent = new Set(filteredData.map(a => a.course)).size;

        // Fit bounds if we have markers and aren't trying to keep a specific view
        if (filteredData.length > 0 && !shouldKeepPopupOpen) {
            map.fitBounds(markerClusterGroup.getBounds());
        }
        
        // Restore active alumni highlight if it still exists in the filtered data
        if (activeAlumniName && isActiveAlumniVisible && markers[activeAlumniName]) {
            // Highlight the item in the list
            const activeItem = document.querySelector(`.alumni-item[data-name="${activeAlumniName}"]`);
            if (activeItem) {
                document.querySelectorAll('.alumni-item').forEach(el => {
                    el.classList.remove('active');
                });
                activeItem.classList.add('active');
            }
            
            // Highlight the marker
            const markerEl = markers[activeAlumniName].getElement();
            if (markerEl) {
                clearHighlightedMarkers();
                markerEl.classList.add('highlight-marker');
            }
            
            // Restore popup if it was open before
            if (wasPopupVisible && shouldKeepPopupOpen) {
                // We need to do this after the marker cluster has finished rendering
                setTimeout(() => {
                    if (markers[activeAlumniName]) {
                        markerClusterGroup.zoomToShowLayer(markers[activeAlumniName], function() {
                            markers[activeAlumniName].openPopup();
                            popupTracker.setActive(activeAlumniName, markers[activeAlumniName]);
                        });
                    }
                }, 300);
            }
        } else if (!isActiveAlumniVisible) {
            // If the active alumni is no longer visible, clear the highlight
            activeAlumniName = null;
            shouldKeepPopupOpen = false;
            document.querySelectorAll('.alumni-item').forEach(el => {
                el.classList.remove('active');
            });
            clearHighlightedMarkers();
        }
    }

    function createPopupContent(alumni) {
        return `
            <div class="location-info">
                <div class="avatar-header">
                    <div class="avatar-small" style="background-image: url('${alumni.avatar || '{% static "images/default-avatar.png" %}'}')"></div>
                    <h4>${alumni.user}</h4>
                </div>
                <p><i class="fas fa-graduation-cap"></i> ${alumni.course}</p>
                <p><i class="fas fa-calendar"></i> Batch ${alumni.batch}</p>
                <p><i class="fas fa-map-marker-alt"></i> ${alumni.location}</p>
                <p><i class="fas fa-clock"></i> Last updated: ${alumni.timestamp}</p>
                <span class="location-badge">Online</span>
            </div>
        `;
    }
    
    // Function to clear any highlighted markers
    function clearHighlightedMarkers() {
        document.querySelectorAll('.highlight-marker').forEach(el => {
            el.classList.remove('highlight-marker');
        });
    }
    
    // Function to handle alumni item clicks 
    function handleAlumniItemClick(e) {
        // Prevent multiple simultaneous clicks
        if (isProcessingClick || isUpdatingLocations) return;
        isProcessingClick = true;
        
        const item = e.currentTarget;
        const lat = parseFloat(item.dataset.lat);
        const lng = parseFloat(item.dataset.lng);
        const name = item.dataset.name;
        
        // Check if this alumni is already active
        const isAlreadyActive = activeAlumniName === name;
        
        // Set this alumni as active
        activeAlumniName = name;
        shouldKeepPopupOpen = true;
        
        // Remove active class from all items
        document.querySelectorAll('.alumni-item').forEach(el => {
            el.classList.remove('active');
        });
        
        // Add active class to clicked item
        item.classList.add('active');
        
        // Clear any existing highlighted markers
        clearHighlightedMarkers();
        
        // Center map if coordinates are valid
        if (!isNaN(lat) && !isNaN(lng)) {
            // If this alumni is already active, just ensure popup is open without animation
            if (isAlreadyActive && markers[name]) {
                // Just make sure the popup is open
                if (!markers[name].isPopupOpen()) {
                    markerClusterGroup.zoomToShowLayer(markers[name], function() {
                        markers[name].openPopup();
                        popupTracker.setActive(name, markers[name]);
                        
                        // Add highlight effect to the marker
                        const markerEl = markers[name].getElement();
                        if (markerEl) {
                            markerEl.classList.add('highlight-marker');
                        }
                    });
                }
                
                // Allow clicking again immediately
                isProcessingClick = false;
                return;
            }
            
            // Close all existing popups first
            popupTracker.closeAll();
            
            // Use a simpler animation approach to prevent shaking
            const targetZoom = 16; // High enough to disable clustering
            
            // If the marker exists, handle it
            if (markers[name]) {
                // First, close all clusters to ensure a clean animation
                markerClusterGroup.unspiderfy();
                
                // Use a single smooth animation to move to the location
                map.flyTo([lat, lng], targetZoom, {
                    duration: 1.5,
                    easeLinearity: 0.25
                });
                
                // Wait for the animation to complete before showing popup
                setTimeout(() => {
                    // Find the marker and ensure it's visible
                    markerClusterGroup.zoomToShowLayer(markers[name], function() {
                        // Open the popup
                        markers[name].openPopup();
                        
                        // Update popup tracker
                        popupTracker.setActive(name, markers[name]);
                        
                        // Add highlight effect to the marker
                        const markerEl = markers[name].getElement();
                        if (markerEl) {
                            markerEl.classList.add('highlight-marker');
                        }
                    });
                    
                    // Allow clicking again
                    isProcessingClick = false;
                }, 1600); // Slightly longer than the animation duration
            } else {
                // If marker not found, just move the map
                map.flyTo([lat, lng], targetZoom, {
                    duration: 1.5,
                    easeLinearity: 0.25
                });
                
                setTimeout(() => {
                    isProcessingClick = false;
                }, 1600);
            }
        } else {
            // If coordinates are invalid, allow clicking again
            isProcessingClick = false;
        }
    }
    
    // Add a function to manually close all popups
    function closeAllPopups() {
        shouldKeepPopupOpen = false; // Signal that we don't want to keep popups open
        popupTracker.closeAll();
    }
    
    // Setup click events for alumni list items - only called once
    function setupAlumniItemClicks() {
        // Use event delegation instead of attaching to each item
        const batchGroups = document.querySelector('.batch-groups');
        if (!batchGroups) return;
        
        // Remove any existing listener to prevent duplicates
        batchGroups.removeEventListener('click', delegateAlumniClick);
        // Add the event listener to the container
        batchGroups.addEventListener('click', delegateAlumniClick);
        
        // Also add a click handler to the map to detect clicks on the popup close button
        map.on('popupclose', function(e) {
            // When a popup is manually closed, stop keeping it open
            if (e.popup === lastActivePopup) {
                shouldKeepPopupOpen = false;
                popupTracker.isPopupVisible = false;
            }
        });
    }
    
    // Event delegation function
    function delegateAlumniClick(e) {
        // Find the alumni-item parent if clicked on a child element
        let target = e.target;
        while (target !== this && !target.classList.contains('alumni-item')) {
            target = target.parentElement;
        }
        
        // If we found an alumni item, handle the click
        if (target.classList.contains('alumni-item')) {
            handleAlumniItemClick({currentTarget: target});
        }
    }
    
    // Event listeners for filters - update to close popups before filtering
    document.getElementById('alumniSearch').addEventListener('input', function() {
        closeAllPopups();
        filterMarkers();
    });
    document.getElementById('batchFilter').addEventListener('change', function() {
        closeAllPopups();
        filterMarkers();
    });
    document.getElementById('courseFilter').addEventListener('change', function() {
        closeAllPopups();
        filterMarkers();
    });
    document.getElementById('locationFilter').addEventListener('change', function() {
        closeAllPopups();
        filterMarkers();
    });

    // Add location button functionality
    const locationButton = document.getElementById('locationButton');
    locationButton.addEventListener('click', () => {
        closeAllPopups(); // Close any open popup when going to own location
        
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    map.setView([lat, lng], 15);
                },
                (error) => {
                    console.error('Error getting location:', error);
                    alert('Unable to get your location. Please check your browser settings.');
                }
            );
        } else {
            alert('Geolocation is not supported by your browser.');
        }
    });

    // Function to update locations with loading indicator
    async function updateLocations() {
        // Set flag to prevent interactions during update
        isUpdatingLocations = true;
        
        // Remember the active popup state
        const wasPopupVisible = popupTracker.isPopupVisible;
        const previousActiveAlumni = activeAlumniName;
        
        const loadingOverlay = document.querySelector('.loading-overlay');
        loadingOverlay.style.display = 'flex';

        try {
            const response = await fetch('{% url "location_tracking:get_locations" %}');
            const data = await response.json();
            
            alumniData = data.locations.map(location => ({
                ...location,
                // Use actual data from backend instead of random values
                batch: location.batch || Math.floor(Math.random() * (2024 - 2010) + 2010),
                course: location.course || ['Computer Science', 'Engineering', 'Business'][Math.floor(Math.random() * 3)],
                location: location.location || ['Dumaguete', 'Cebu', 'Manila'][Math.floor(Math.random() * 3)],
                avatar: location.avatar || '{% static "images/default-avatar.png" %}'
            }));
            
            // Store alumni positions for click handling
            alumniData.forEach(alumni => {
                alumniPositions[alumni.user] = [alumni.latitude, alumni.longitude];
            });

            // Update sets for filters
            alumniData.forEach(alumni => {
                if (alumni.batch) batchesSet.add(alumni.batch);
                if (alumni.course) coursesSet.add(alumni.course);
                if (alumni.location) locationsSet.add(alumni.location);
            });

            // Check if active alumni still exists
            if (previousActiveAlumni) {
                const stillExists = alumniData.some(alumni => alumni.user === previousActiveAlumni);
                if (!stillExists) {
                    activeAlumniName = null;
                    shouldKeepPopupOpen = false;
                }
            }

            // Clear existing markers and cluster group
            markerClusterGroup.clearLayers();
            Object.keys(markers).forEach(key => delete markers[key]);

            // Add new markers with custom icon to the cluster group
            alumniData.forEach(alumni => {
                const position = [alumni.latitude, alumni.longitude];
                const marker = L.marker(position, { icon: createCustomMarker(alumni) })
                    .bindPopup(createPopupContent(alumni), {
                        autoClose: false,
                        closeOnClick: false
                    });
                    
                markers[alumni.user] = marker;
                markerClusterGroup.addLayer(marker);
            });

            updateFilters();
            filterMarkers();
            
            // Update the data attributes of alumni items
            updateAlumniItemAttributes();
            
            // Restore active popup if needed
            if (wasPopupVisible && shouldKeepPopupOpen && activeAlumniName && markers[activeAlumniName]) {
                setTimeout(() => {
                    if (markers[activeAlumniName]) {
                        markerClusterGroup.zoomToShowLayer(markers[activeAlumniName], function() {
                            markers[activeAlumniName].openPopup();
                            popupTracker.setActive(activeAlumniName, markers[activeAlumniName]);
                        });
                    }
                }, 300);
            }
        } catch (error) {
            console.error('Error fetching locations:', error);
        } finally {
            loadingOverlay.style.display = 'none';
            isUpdatingLocations = false;
        }
    }
    
    // Update data attributes on alumni items
    function updateAlumniItemAttributes() {
        const alumniItems = document.querySelectorAll('.alumni-item');
        alumniItems.forEach(item => {
            const name = item.dataset.name;
            if (name && alumniPositions[name]) {
                const [lat, lng] = alumniPositions[name];
                item.dataset.lat = lat;
                item.dataset.lng = lng;
            }
        });
    }

    // Add event listener for zoom level changes to adjust marker size based on zoom
    map.on('zoomend', function() {
        const currentZoom = map.getZoom();
        const markerElements = document.querySelectorAll('.marker');
        
        // If streets aren't visible (typically zoom < 15), make markers smaller
        if (currentZoom < 15) {
            markerElements.forEach(marker => {
                marker.style.width = '30px';
                marker.style.height = '30px';
            });
        } else {
            // Reset to normal size
            markerElements.forEach(marker => {
                marker.style.width = '50px';
                marker.style.height = '50px';
            });
        }
    });

    // Initial update
    updateLocations();
    
    // Periodic updates with a longer interval to avoid disruptions
    setInterval(() => {
        if (!isProcessingClick) {
            updateLocations();
        }
    }, 30000); // Increase to 30 seconds to reduce interference
    
    // Run setup ONCE after initial page load
    setTimeout(setupAlumniItemClicks, 1000);

    // Handle map resize
    window.addEventListener('resize', () => map.invalidateSize());
    setTimeout(() => map.invalidateSize(), 500);

    // Add refresh button event listener
    document.getElementById('refreshMap').addEventListener('click', function() {
        updateLocations();
    });
});
</script>
{% endblock %} 