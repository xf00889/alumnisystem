{% extends "base.html" %}
{% load static %}

{% block title %}Quick SMTP Setup - NORSU Alumni Admin{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #2b3c6b;
        --primary-hover: #1d4ed8;
        --secondary-color: #64748b;
        --accent-color: #0ea5e9;
        --success-color: #10b981;
        --warning-color: #f59e0b;
        --danger-color: #ef4444;
        --info-color: #3b82f6;
        
        --text-primary: #1e293b;
        --text-secondary: #64748b;
        --text-light: #ffffff;
        --text-muted: #94a3b8;
        
        --bg-primary: #ffffff;
        --bg-secondary: #f8fafc;
        --bg-accent: #f1f5f9;
        
        --ui-border: #e2e8f0;
        --ui-hover: #f8fafc;
        --ui-focus: #dbeafe;
        
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        
        --radius-sm: 0.25rem;
        --radius-md: 0.5rem;
        --radius-lg: 0.75rem;
        --radius-xl: 1rem;
    }

    .container-fluid {
        padding: 2rem;
        max-width: 1000px;
        margin: 0 auto;
    }

    .dashboard-header {
        background: var(--primary-color);
        color: var(--text-light);
        padding: 1.75rem;
        border-radius: var(--radius-md);
        margin-bottom: 1.25rem;
        box-shadow: var(--shadow-sm);
        font-size: 0.875rem;
        font-family: 'Poppins', sans-serif;
    }

    .dashboard-header h1 {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
    }

    .dashboard-header p {
        opacity: 0.9;
        font-size: 0.875rem;
    }

    .dashboard-card {
        background: var(--bg-primary);
        border-radius: var(--radius-xl);
        padding: 2rem;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--ui-border);
        margin-bottom: 1.5rem;
    }
    
    .setup-body {
        padding: 30px;
    }
    
    .provider-card {
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 20px;
        transition: all 0.3s ease;
        cursor: pointer;
        background: white;
    }
    
    .provider-card:hover {
        border-color: #667eea;
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
        transform: translateY(-2px);
    }
    
    .provider-card.selected {
        border-color: #667eea;
        background: #f8f9ff;
    }
    
    .provider-header {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .provider-icon {
        width: 50px;
        height: 50px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        font-size: 24px;
        color: white;
    }
    
    .gmail-icon {
        background: linear-gradient(135deg, #ea4335 0%, #fbbc04 100%);
    }
    
    .outlook-icon {
        background: linear-gradient(135deg, #0078d4 0%, #106ebe 100%);
    }
    
    .yahoo-icon {
        background: linear-gradient(135deg, #6001d2 0%, #7b1fa2 100%);
    }
    
    .brevo-icon {
        background: linear-gradient(135deg, #00a2ff 0%, #0066cc 100%);
    }
    
    .custom-icon {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    }
    
    .provider-name {
        font-size: 18px;
        font-weight: 600;
        color: #2d3748;
        margin: 0;
    }
    
    .provider-description {
        color: #6c757d;
        font-size: 14px;
        margin-bottom: 15px;
    }
    
    .provider-settings {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        font-size: 13px;
        color: #495057;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-label {
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 8px;
        display: block;
    }
    
    .form-control {
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 12px 15px;
        font-size: 14px;
        transition: all 0.3s ease;
    }
    
    .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 8px;
        padding: 12px 30px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }
    
    .btn-secondary {
        background: #6c757d;
        border: none;
        border-radius: 8px;
        padding: 12px 30px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-secondary:hover {
        background: #5a6268;
        transform: translateY(-2px);
    }
    
    .step-indicator {
        display: flex;
        justify-content: center;
        margin-bottom: 30px;
    }
    
    .step {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 10px;
        font-weight: 600;
        color: white;
        background: #e9ecef;
        transition: all 0.3s ease;
    }
    
    .step.active {
        background: #667eea;
    }
    
    .step.completed {
        background: #28a745;
    }
    
    .step-line {
        width: 50px;
        height: 2px;
        background: #e9ecef;
        margin-top: 19px;
    }
    
    .step-line.completed {
        background: #28a745;
    }
    
    .alert {
        border-radius: 8px;
        border: none;
        padding: 15px 20px;
        margin-bottom: 20px;
    }
    
    .alert-info {
        background: #d1ecf1;
        color: #0c5460;
    }
    
    .alert-warning {
        background: #fff3cd;
        color: #856404;
    }
    
    .alert-success {
        background: #d4edda;
        color: #155724;
    }
    
    .alert-danger {
        background: #f8d7da;
        color: #721c24;
    }
    
    .test-result {
        margin-top: 20px;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid;
    }
    
    .test-success {
        background: #d4edda;
        border-left-color: #28a745;
        color: #155724;
    }
    
    .test-error {
        background: #f8d7da;
        border-left-color: #dc3545;
        color: #721c24;
    }
    
    .hidden {
        display: none;
    }
    
    .loading {
        opacity: 0.6;
        pointer-events: none;
    }
    
    .spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 10px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Standard Dashboard Header -->
    <div class="dashboard-header">
        <h1><i class="fas fa-magic"></i> Quick SMTP Setup</h1>
        <p>Choose your email provider and we'll configure the settings automatically</p>
    </div>
    
    <div class="dashboard-card">
                    <!-- Step Indicator -->
                    <div class="step-indicator">
                        <div class="step active" id="step1">1</div>
                        <div class="step-line"></div>
                        <div class="step" id="step2">2</div>
                        <div class="step-line"></div>
                        <div class="step" id="step3">3</div>
                    </div>
                    
                    <!-- Step 1: Provider Selection -->
                    <div id="step1-content">
                        <h4 class="mb-4">Choose Your Email Provider</h4>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="provider-card" data-provider="gmail">
                                    <div class="provider-header">
                                        <div class="provider-icon gmail-icon">
                                            <i class="fab fa-google"></i>
                                        </div>
                                        <h5 class="provider-name">Gmail</h5>
                                    </div>
                                    <p class="provider-description">Use your Gmail account with App Password</p>
                                    <div class="provider-settings">
                                        <strong>Settings:</strong><br>
                                        Host: smtp.gmail.com<br>
                                        Port: 587<br>
                                        Encryption: TLS
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <div class="provider-card" data-provider="outlook">
                                    <div class="provider-header">
                                        <div class="provider-icon outlook-icon">
                                            <i class="fab fa-microsoft"></i>
                                        </div>
                                        <h5 class="provider-name">Outlook/Hotmail</h5>
                                    </div>
                                    <p class="provider-description">Use your Outlook or Hotmail account</p>
                                    <div class="provider-settings">
                                        <strong>Settings:</strong><br>
                                        Host: smtp-mail.outlook.com<br>
                                        Port: 587<br>
                                        Encryption: TLS
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <div class="provider-card" data-provider="yahoo">
                                    <div class="provider-header">
                                        <div class="provider-icon yahoo-icon">
                                            <i class="fab fa-yahoo"></i>
                                        </div>
                                        <h5 class="provider-name">Yahoo Mail</h5>
                                    </div>
                                    <p class="provider-description">Use your Yahoo Mail account with App Password</p>
                                    <div class="provider-settings">
                                        <strong>Settings:</strong><br>
                                        Host: smtp.mail.yahoo.com<br>
                                        Port: 587<br>
                                        Encryption: TLS
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <div class="provider-card" data-provider="brevo">
                                    <div class="provider-header">
                                        <div class="provider-icon brevo-icon">
                                            <i class="fas fa-paper-plane"></i>
                                        </div>
                                        <h5 class="provider-name">Brevo API</h5>
                                    </div>
                                    <p class="provider-description">Modern email service with high deliverability</p>
                                    <div class="provider-settings">
                                        <strong>Settings:</strong><br>
                                        API Key based authentication<br>
                                        No SMTP server needed
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <div class="provider-card" data-provider="custom">
                                    <div class="provider-header">
                                        <div class="provider-icon custom-icon">
                                            <i class="fas fa-server"></i>
                                        </div>
                                        <h5 class="provider-name">Custom SMTP</h5>
                                    </div>
                                    <p class="provider-description">Configure your own SMTP server</p>
                                    <div class="provider-settings">
                                        <strong>Settings:</strong><br>
                                        You'll provide all settings manually
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center mt-4">
                            <button type="button" class="btn btn-primary" id="next-step1" disabled>
                                Next Step <i class="fas fa-arrow-right ms-2"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Step 2: Configuration Form -->
                    <div id="step2-content" class="hidden">
                        <h4 class="mb-4">Configure Your Email Settings</h4>
                        
                        <form id="email-form">
                            {% csrf_token %}
                            <input type="hidden" id="provider" name="provider" value="">
                            
                            <!-- Common Fields -->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label" for="name">Configuration Name</label>
                                        <input type="text" class="form-control" id="name" name="name" 
                                               placeholder="e.g., Gmail Production" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label" for="from_email">From Email</label>
                                        <input type="email" class="form-control" id="from_email" name="from_email" 
                                               placeholder="noreply@yourdomain.com" required>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- SMTP Fields -->
                            <div id="smtp-fields">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label" for="host">SMTP Host</label>
                                            <input type="text" class="form-control" id="host" name="host">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label" for="port">Port</label>
                                            <input type="number" class="form-control" id="port" name="port">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label" for="username">Username/Email</label>
                                            <input type="text" class="form-control" id="username" name="username">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label" for="password">Password/App Password</label>
                                            <input type="password" class="form-control" id="password" name="password">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label">Encryption</label>
                                            <select class="form-control" id="encryption" name="encryption">
                                                <option value="tls">TLS (Recommended)</option>
                                                <option value="ssl">SSL</option>
                                                <option value="none">None (Not Recommended)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label" for="timeout">Timeout (seconds)</label>
                                            <input type="number" class="form-control" id="timeout" name="timeout" 
                                                   value="10" min="5" max="60">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>For Gmail/Yahoo:</strong> You need to use an App Password instead of your regular password. 
                                    Enable 2-factor authentication and generate an App Password in your account settings.
                                </div>
                            </div>
                            
                            <!-- Brevo Fields -->
                            <div id="brevo-fields" class="hidden">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label" for="api_key">Brevo API Key</label>
                                            <input type="password" class="form-control" id="api_key" name="api_key" 
                                                   placeholder="Your Brevo API key">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label" for="from_name">From Name (Optional)</label>
                                            <input type="text" class="form-control" id="from_name" name="from_name" 
                                                   placeholder="NORSU Alumni System">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>Important:</strong> Your Brevo account needs SMTP API activation. Contact <a href="mailto:contact@brevo.com">contact@brevo.com</a> to request activation.
                                </div>
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>For Brevo:</strong> Get your API key from Brevo dashboard → Settings → SMTP & API → API Keys. 
                                    Make sure your sender email is verified in Brevo.
                                </div>
                            </div>
                            
                            <div class="text-center mt-4">
                                <button type="button" class="btn btn-secondary me-3" id="back-step2">
                                    <i class="fas fa-arrow-left me-2"></i>Back
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    Test & Save <i class="fas fa-vial ms-2"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Step 3: Test Results -->
                    <div id="step3-content" class="hidden">
                        <h4 class="mb-4">Configuration Complete</h4>
                        
                        <div id="test-result" class="test-result hidden">
                            <!-- Test results will be displayed here -->
                        </div>
                        
                        <div class="text-center mt-4">
                            <a href="{% url 'core:smtp_configuration_list' %}" class="btn btn-primary">
                                <i class="fas fa-check me-2"></i>View Configurations
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const providerCards = document.querySelectorAll('.provider-card');
    const nextStep1Btn = document.getElementById('next-step1');
    const backStep2Btn = document.getElementById('back-step2');
    const emailForm = document.getElementById('email-form');
    
    let selectedProvider = '';
    
    // Provider selection
    providerCards.forEach(card => {
        card.addEventListener('click', function() {
            providerCards.forEach(c => c.classList.remove('selected'));
            this.classList.add('selected');
            selectedProvider = this.dataset.provider;
            nextStep1Btn.disabled = false;
        });
    });
    
    // Step navigation
    nextStep1Btn.addEventListener('click', function() {
        if (selectedProvider) {
            showStep(2);
            configureProvider(selectedProvider);
        }
    });
    
    backStep2Btn.addEventListener('click', function() {
        showStep(1);
    });
    
    // Form submission
    emailForm.addEventListener('submit', function(e) {
        e.preventDefault();
        testAndSaveConfiguration();
    });
    
    function showStep(step) {
        // Hide all steps
        document.getElementById('step1-content').classList.add('hidden');
        document.getElementById('step2-content').classList.add('hidden');
        document.getElementById('step3-content').classList.add('hidden');
        
        // Show current step
        document.getElementById(`step${step}-content`).classList.remove('hidden');
        
        // Update step indicators
        for (let i = 1; i <= 3; i++) {
            const stepEl = document.getElementById(`step${i}`);
            if (i < step) {
                stepEl.classList.add('completed');
                stepEl.classList.remove('active');
            } else if (i === step) {
                stepEl.classList.add('active');
                stepEl.classList.remove('completed');
            } else {
                stepEl.classList.remove('active', 'completed');
            }
        }
    }
    
    function configureProvider(provider) {
        const configs = {
            gmail: {
                host: 'smtp.gmail.com',
                port: 587,
                encryption: 'tls',
                name: 'Gmail Configuration'
            },
            outlook: {
                host: 'smtp-mail.outlook.com',
                port: 587,
                encryption: 'tls',
                name: 'Outlook Configuration'
            },
            yahoo: {
                host: 'smtp.mail.yahoo.com',
                port: 587,
                encryption: 'tls',
                name: 'Yahoo Configuration'
            },
            brevo: {
                name: 'Brevo Configuration'
            },
            custom: {
                host: '',
                port: 587,
                encryption: 'tls',
                name: 'Custom Configuration'
            }
        };
        
        const config = configs[provider];
        document.getElementById('provider').value = provider;
        document.getElementById('name').value = config.name;
        
        // Show/hide appropriate fields
        const smtpFields = document.getElementById('smtp-fields');
        const brevoFields = document.getElementById('brevo-fields');
        
        if (provider === 'brevo') {
            smtpFields.classList.add('hidden');
            brevoFields.classList.remove('hidden');
            // Clear SMTP fields
            document.getElementById('host').value = '';
            document.getElementById('port').value = '';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        } else {
            smtpFields.classList.remove('hidden');
            brevoFields.classList.add('hidden');
            // Clear Brevo fields
            document.getElementById('api_key').value = '';
            document.getElementById('from_name').value = '';
            
            // Set SMTP values
            if (config.host) {
                document.getElementById('host').value = config.host;
                document.getElementById('port').value = config.port;
                document.getElementById('encryption').value = config.encryption;
            }
        }
    }
    
    function testAndSaveConfiguration() {
        const formData = new FormData(emailForm);
        const submitBtn = emailForm.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        // Show loading state
        submitBtn.innerHTML = '<span class="spinner"></span>Testing...';
        submitBtn.disabled = true;
        emailForm.classList.add('loading');
        
        fetch('{% url "core:smtp_quick_setup" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                return response.json();
            } else {
                throw new Error('Response is not JSON');
            }
        })
        .then(data => {
            showStep(3);
            displayTestResult(data);
        })
        .catch(error => {
            console.error('Error:', error);
            displayTestResult({
                success: false,
                message: 'An error occurred while testing the configuration.',
                details: error.message
            });
        })
        .finally(() => {
            // Reset button state
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            emailForm.classList.remove('loading');
        });
    }
    
    function displayTestResult(data) {
        const resultDiv = document.getElementById('test-result');
        resultDiv.classList.remove('hidden', 'test-success', 'test-error');
        
        if (data.success) {
            resultDiv.classList.add('test-success');
            resultDiv.innerHTML = `
                <h5><i class="fas fa-check-circle me-2"></i>Configuration Saved Successfully!</h5>
                <p>${data.message}</p>
                <p><strong>Configuration Name:</strong> ${data.config_name}</p>
                <p><strong>Status:</strong> ${data.is_active ? 'Active' : 'Inactive'}</p>
            `;
        } else {
            resultDiv.classList.add('test-error');
            resultDiv.innerHTML = `
                <h5><i class="fas fa-exclamation-triangle me-2"></i>Configuration Failed</h5>
                <p>${data.message}</p>
                ${data.details ? `<p><strong>Details:</strong> ${data.details}</p>` : ''}
            `;
        }
    }
});
</script>
{% endblock %}
