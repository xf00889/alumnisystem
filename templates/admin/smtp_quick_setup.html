{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Quick SMTP Setup - NORSU Alumni Admin{% endblock %}

{% block extra_css %}
<style>
    .setup-container {
        max-width: 800px;
        margin: 0 auto;
    }
    
    .setup-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        overflow: hidden;
    }
    
    .setup-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
    }
    
    .setup-body {
        padding: 40px;
    }
    
    .provider-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .provider-card {
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 25px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
    }
    
    .provider-card:hover {
        border-color: #2b3c6b;
        box-shadow: 0 5px 15px rgba(43, 60, 107, 0.1);
        transform: translateY(-2px);
    }
    
    .provider-card.selected {
        border-color: #2b3c6b;
        background: #f8f9ff;
    }
    
    .provider-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 15px;
        font-size: 24px;
        color: white;
    }
    
    .provider-gmail .provider-icon {
        background: linear-gradient(135deg, #ea4335 0%, #fbbc04 100%);
    }
    
    .provider-outlook .provider-icon {
        background: linear-gradient(135deg, #0078d4 0%, #106ebe 100%);
    }
    
    .provider-yahoo .provider-icon {
        background: linear-gradient(135deg, #6001d2 0%, #7c3aed 100%);
    }
    
    .provider-name {
        font-size: 18px;
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 10px;
    }
    
    .provider-description {
        color: #6c757d;
        font-size: 14px;
        margin-bottom: 15px;
    }
    
    .provider-help {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        font-size: 12px;
        color: #495057;
        text-align: left;
    }
    
    .form-section {
        display: none;
        background: #f8f9fa;
        border-radius: 10px;
        padding: 30px;
        margin-top: 30px;
    }
    
    .form-section.active {
        display: block;
    }
    
    .form-group {
        margin-bottom: 25px;
    }
    
    .form-label {
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 8px;
        display: block;
    }
    
    .form-control {
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 12px 15px;
        font-size: 16px;
        transition: all 0.3s ease;
        width: 100%;
    }
    
    .form-control:focus {
        border-color: #2b3c6b;
        box-shadow: 0 0 0 0.2rem rgba(43, 60, 107, 0.25);
        outline: none;
    }
    
    .btn-setup {
        background: linear-gradient(135deg, #2b3c6b 0%, #4a5568 100%);
        border: none;
        border-radius: 10px;
        padding: 15px 30px;
        font-size: 16px;
        font-weight: 600;
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        width: 100%;
    }
    
    .btn-setup:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(43, 60, 107, 0.3);
    }
    
    .btn-back {
        background: #6c757d;
        border: none;
        border-radius: 8px;
        padding: 10px 20px;
        font-size: 14px;
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-right: 15px;
    }
    
    .btn-back:hover {
        background: #5a6268;
        transform: translateY(-1px);
    }
    
    .help-section {
        background: #e3f2fd;
        border: 1px solid #bbdefb;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 30px;
    }
    
    .help-section h5 {
        color: #1976d2;
        margin-bottom: 15px;
    }
    
    .help-section ul {
        margin: 0;
        padding-left: 20px;
    }
    
    .help-section li {
        margin-bottom: 8px;
        color: #424242;
    }
    
    .step-indicator {
        display: flex;
        justify-content: center;
        margin-bottom: 30px;
    }
    
    .step {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e9ecef;
        color: #6c757d;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        margin: 0 10px;
        transition: all 0.3s ease;
    }
    
    .step.active {
        background: #2b3c6b;
        color: white;
    }
    
    .step.completed {
        background: #28a745;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="setup-container">
                <!-- Setup Header -->
                <div class="setup-card">
                    <div class="setup-header">
                        <h2 class="mb-0"><i class="fas fa-magic me-3"></i>Quick SMTP Setup</h2>
                        <p class="mb-0 mt-2">Choose your email provider and we'll configure everything for you</p>
                    </div>
                </div>
                
                <!-- Step Indicator -->
                <div class="step-indicator">
                    <div class="step active" id="step1">1</div>
                    <div class="step" id="step2">2</div>
                    <div class="step" id="step3">3</div>
                </div>
                
                <!-- Provider Selection -->
                <div class="setup-card" id="providerSelection">
                    <div class="setup-body">
                        <h4 class="mb-4">Step 1: Choose Your Email Provider</h4>
                        
                        <div class="provider-grid">
                            {% for provider in providers %}
                            <div class="provider-card provider-{{ provider.id }}" data-provider="{{ provider.id }}">
                                <div class="provider-icon">
                                    {% if provider.id == 'gmail' %}
                                        <i class="fab fa-google"></i>
                                    {% elif provider.id == 'outlook' %}
                                        <i class="fab fa-microsoft"></i>
                                    {% elif provider.id == 'yahoo' %}
                                        <i class="fab fa-yahoo"></i>
                                    {% endif %}
                                </div>
                                <div class="provider-name">{{ provider.name }}</div>
                                <div class="provider-description">{{ provider.description }}</div>
                                <div class="provider-help">
                                    <strong>Setup Tip:</strong> {{ provider.help }}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <div class="help-section">
                            <h5><i class="fas fa-info-circle me-2"></i>Need Help?</h5>
                            <ul>
                                <li><strong>Gmail:</strong> Enable 2-Factor Authentication and create an App Password</li>
                                <li><strong>Outlook:</strong> Use your regular email and password</li>
                                <li><strong>Yahoo:</strong> Enable 2-Factor Authentication and create an App Password</li>
                                <li>Don't use your regular password for Gmail/Yahoo - create an App Password instead</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- Configuration Form -->
                <div class="setup-card" id="configurationForm" style="display: none;">
                    <div class="setup-body">
                        <h4 class="mb-4">Step 2: Enter Your Email Credentials</h4>
                        
                        <form method="post" id="smtpSetupForm">
                            {% csrf_token %}
                            <input type="hidden" name="provider" id="selectedProvider">
                            
                            <div class="form-group">
                                <label for="email" class="form-label">Email Address</label>
                                <input type="email" 
                                       class="form-control" 
                                       id="email" 
                                       name="email" 
                                       placeholder="your-email@example.com"
                                       required>
                            </div>
                            
                            <div class="form-group">
                                <label for="password" class="form-label">Password / App Password</label>
                                <input type="password" 
                                       class="form-control" 
                                       id="password" 
                                       name="password" 
                                       placeholder="Enter your password or app password"
                                       required>
                                <small class="text-muted">
                                    For Gmail/Yahoo: Use App Password (not your regular password)
                                </small>
                            </div>
                            
                            <div class="form-group">
                                <label for="from_name" class="form-label">From Name (Optional)</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="from_name" 
                                       name="from_name" 
                                       placeholder="NORSU Alumni"
                                       value="NORSU Alumni">
                                <small class="text-muted">
                                    This will appear as the sender name in emails
                                </small>
                            </div>
                            
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn-back" id="backToProviders">
                                    <i class="fas fa-arrow-left me-2"></i>Back to Providers
                                </button>
                                <button type="submit" class="btn-setup">
                                    <i class="fas fa-cog me-2"></i>Configure & Test
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Success Message -->
                <div class="setup-card" id="successMessage" style="display: none;">
                    <div class="setup-body text-center">
                        <div class="mb-4">
                            <i class="fas fa-check-circle text-success" style="font-size: 64px;"></i>
                        </div>
                        <h4 class="text-success mb-3">Configuration Successful!</h4>
                        <p class="text-muted mb-4">Your SMTP configuration has been created and tested successfully.</p>
                        <a href="{% url 'core:smtp_configuration_list' %}" class="btn-setup">
                            <i class="fas fa-list me-2"></i>View All Configurations
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const providerCards = document.querySelectorAll('.provider-card');
    const providerSelection = document.getElementById('providerSelection');
    const configurationForm = document.getElementById('configurationForm');
    const successMessage = document.getElementById('successMessage');
    const selectedProviderInput = document.getElementById('selectedProvider');
    const backToProvidersBtn = document.getElementById('backToProviders');
    const smtpSetupForm = document.getElementById('smtpSetupForm');
    
    let selectedProvider = null;
    
    // Provider selection
    providerCards.forEach(card => {
        card.addEventListener('click', function() {
            // Remove selected class from all cards
            providerCards.forEach(c => c.classList.remove('selected'));
            
            // Add selected class to clicked card
            this.classList.add('selected');
            
            // Store selected provider
            selectedProvider = this.dataset.provider;
            selectedProviderInput.value = selectedProvider;
            
            // Update step indicator
            updateStepIndicator(2);
            
            // Show configuration form
            providerSelection.style.display = 'none';
            configurationForm.style.display = 'block';
        });
    });
    
    // Back to providers
    backToProvidersBtn.addEventListener('click', function() {
        configurationForm.style.display = 'none';
        providerSelection.style.display = 'block';
        updateStepIndicator(1);
    });
    
    // Form submission
    smtpSetupForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Show loading state
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Configuring...';
        submitBtn.disabled = true;
        
        // Submit form
        fetch(this.action || window.location.href, {
            method: 'POST',
            body: new FormData(this)
        })
        .then(response => {
            if (response.ok) {
                // Show success message
                configurationForm.style.display = 'none';
                successMessage.style.display = 'block';
                updateStepIndicator(3);
            } else {
                throw new Error('Configuration failed');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Configuration failed. Please check your credentials and try again.');
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
    });
    
    function updateStepIndicator(activeStep) {
        const steps = document.querySelectorAll('.step');
        steps.forEach((step, index) => {
            step.classList.remove('active', 'completed');
            if (index + 1 < activeStep) {
                step.classList.add('completed');
            } else if (index + 1 === activeStep) {
                step.classList.add('active');
            }
        });
    }
    
    // Auto-focus email field when form is shown
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                if (configurationForm.style.display === 'block') {
                    document.getElementById('email').focus();
                }
            }
        });
    });
    
    observer.observe(configurationForm, { attributes: true });
});
</script>
{% endblock %}
