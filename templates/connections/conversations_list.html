{% extends 'base.html' %}
{% load static %}

{% block title %}Messages - Alumni System{% endblock %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
    /* System Color Scheme */
    :root {
        /* Primary Colors */
        --primary-color: #2b3c6b;
        
        /* Secondary Colors */
        --secondary-color: #4a5568;
        
        /* UI Colors */
        --ui-background: #f7fafc;
        --ui-surface: #ffffff;
        --ui-border: #e2e8f0;
        --ui-hover: #edf2f7;
        
        /* Text Colors */
        --text-primary: #2d3748;
        --text-secondary: #718096;
        --text-muted: #a0aec0;
        --text-light: #ffffff;
        
        /* Feedback Colors */
        --feedback-success: #48bb78;
        --feedback-warning: #ed8936;
        --feedback-error: #e53e3e;
        --feedback-info: #4299e1;

        /* Feedback Background Colors */
        --feedback-success-bg: #f0fff4;
        --feedback-info-bg: #ebf8ff;
        
        /* Shadows */
        --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
        --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
        
        /* Border Radius */
        --radius-sm: 0.25rem;
        --radius-md: 0.375rem;
        --radius-lg: 0.5rem;
    }
    
    body {
        background-color: var(--ui-background);
        font-family: 'Poppins', sans-serif;
        font-size: 0.875rem;
    }
    
    .messages-header {
        background: var(--primary-color);
        color: var(--text-light);
        padding: 1.75rem;
        border-radius: var(--radius-md);
        margin-bottom: 1.25rem;
        box-shadow: var(--shadow-sm);
        font-family: 'Poppins', sans-serif;
    }
    
    .messages-header h2 {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
        color: var(--text-light);
    }
    
    .messages-card {
        background: var(--ui-surface);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--ui-border);
        font-family: 'Poppins', sans-serif;
        overflow: hidden;
    }
    
    .messages-card:hover {
        box-shadow: var(--shadow-md);
    }
    
    .conversation-item {
        cursor: pointer;
        transition: all 0.3s ease;
        border-bottom: 1px solid var(--ui-border);
        padding: 1.25rem;
        background: var(--ui-surface);
        font-family: 'Poppins', sans-serif;
    }
    
    .conversation-item:last-child {
        border-bottom: none;
    }
    
    .conversation-item:hover {
        background-color: var(--ui-hover);
    }
    
    .conversation-item.active {
        background-color: rgba(43, 60, 107, 0.1);
        border-left: 4px solid var(--primary-color);
    }
    
    .conversation-item.unread {
        font-weight: 600;
        background-color: rgba(237, 137, 54, 0.1);
    }
    
    .avatar-sm {
        width: 55px;
        height: 55px;
        object-fit: cover;
        border: 2px solid var(--ui-border);
        transition: all 0.3s ease;
    }
    
    .conversation-item:hover .avatar-sm {
        border-color: var(--primary-color);
    }
    
    .unread-badge {
        background: linear-gradient(135deg, var(--primary-color) 0%, #3d4f7a 100%);
        color: var(--text-light);
        font-size: 0.7rem;
        font-weight: 600;
        padding: 0.25rem 0.5rem;
        border-radius: 50px;
        box-shadow: var(--shadow-sm);
    }
    
    .message-preview {
        color: var(--text-secondary);
        font-size: 0.875rem;
        font-weight: 400;
        line-height: 1.4;
    }
    
    .conversation-time {
        font-size: 0.75rem;
        color: var(--text-muted);
        font-weight: 500;
    }
    
    .conversation-name {
        color: var(--text-primary);
        font-weight: 600;
        font-size: 0.95rem;
        margin-bottom: 0.25rem;
    }
    
    .conversation-position {
        color: var(--text-secondary);
        font-size: 0.8rem;
        font-weight: 500;
        margin-bottom: 0.5rem;
    }
    
    .no-conversations {
        text-align: center;
        padding: 4rem 2rem;
        color: var(--text-secondary);
        font-family: 'Poppins', sans-serif;
    }
    
    .no-conversations i {
        color: var(--text-muted);
        margin-bottom: 1.5rem;
    }
    
    .no-conversations h5 {
        color: var(--text-primary);
        font-weight: 600;
        margin-bottom: 1rem;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, var(--primary-color) 0%, #3d4f7a 100%);
        border: none;
        border-radius: var(--radius-md);
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        font-family: 'Poppins', sans-serif;
        transition: all 0.3s ease;
        box-shadow: var(--shadow-sm);
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
        background: linear-gradient(135deg, #3d4f7a 0%, var(--primary-color) 100%);
    }
    
    .btn-outline-primary {
        border: 2px solid var(--primary-color);
        color: var(--primary-color);
        border-radius: var(--radius-md);
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        font-family: 'Poppins', sans-serif;
        transition: all 0.3s ease;
        background: transparent;
    }
    
    .btn-outline-primary:hover {
        background: var(--primary-color);
        color: var(--text-light);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }
    
    .filter-controls {
        background: var(--ui-surface);
        padding: 1rem;
        border-radius: var(--radius-md);
        margin-bottom: 1.25rem;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--ui-border);
        font-family: 'Poppins', sans-serif;
    }
    
    .search-input {
        border: 2px solid var(--ui-border);
        border-radius: var(--radius-md);
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
        font-family: 'Poppins', sans-serif;
        transition: all 0.3s ease;
    }
    
    .search-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(43, 60, 107, 0.1);
    }
    
    /* Create Message Modal Styles */
    .modal-content {
        border: none;
        border-radius: var(--radius-lg);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    }
    
    .modal-header {
        background: var(--primary-color);
        color: var(--text-light);
        border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        border-bottom: none;
    }
    
    .modal-title {
        font-weight: 600;
        font-family: 'Poppins', sans-serif;
    }
    
    .btn-close {
        filter: invert(1);
    }
    
    .search-results-container {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid var(--ui-border);
        border-radius: var(--radius-md);
        background: var(--ui-surface);
    }
    
    .search-result-item {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid var(--ui-border);
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
    }
    
    .search-result-item:last-child {
        border-bottom: none;
    }
    
    .search-result-item:hover {
        background-color: var(--ui-hover);
    }
    
    .search-result-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 0.75rem;
        border: 2px solid var(--ui-border);
    }
    
    .search-result-info {
        flex-grow: 1;
    }
    
    .search-result-name {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.25rem;
        font-size: 0.9rem;
    }
    
    .search-result-title {
        color: var(--text-secondary);
        font-size: 0.8rem;
    }
    
    .selected-user-card {
        background: var(--ui-hover);
        border: 2px solid var(--primary-color);
        border-radius: var(--radius-md);
        padding: 1rem;
    }
    
    .selected-user-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid var(--primary-color);
    }
    
    .selected-user-name {
        color: var(--text-primary);
        font-size: 1rem;
    }
    
    .selected-user-title {
        font-size: 0.85rem;
    }
    
    .search-loading {
        color: var(--text-secondary);
    }
    
    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
    }
    
    #messageContent:disabled {
        background-color: var(--ui-hover);
        opacity: 0.7;
    }
    
    #messageContent:enabled {
        border-color: var(--primary-color);
    }
    
    .form-label.fw-semibold {
        color: var(--text-primary);
        font-weight: 600;
    }

    /* Inline Message Interface Styles */
    #newMessageInterface {
        border-top: 3px solid var(--primary-color);
        background: linear-gradient(135deg, #f8fafc 0%, #edf2f7 100%);
        transition: all 0.3s ease;
    }

    #newMessageInterface h6 {
        color: var(--primary-color);
        font-weight: 600;
    }

    #inlineMessageContent:disabled {
        background-color: var(--ui-hover);
        opacity: 0.7;
    }

    #inlineMessageContent:enabled {
        border-color: var(--primary-color);
    }

    .inline-search-results-list {
        max-height: 250px;
        overflow-y: auto;
    }

    /* Group Chat Interface Styles */
    #groupChatInterface {
        border-top: 3px solid var(--success-color);
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        transition: all 0.3s ease;
    }

    #groupChatInterface h6 {
        color: var(--success-color);
        font-weight: 600;
    }

    .group-search-results-list {
        max-height: 200px;
        overflow-y: auto;
    }

    .selected-participants-container {
        min-height: 60px;
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid var(--ui-border);
        border-radius: var(--radius-md);
        padding: 0.75rem;
        background: var(--ui-background);
    }

    .participant-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        background: var(--ui-surface);
        border: 1px solid var(--ui-border);
        border-radius: var(--radius-sm);
        transition: all 0.2s ease;
    }

    .participant-item:hover {
        background: var(--ui-hover);
    }

    .participant-item:last-child {
        margin-bottom: 0;
    }

    .participant-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid var(--ui-border);
    }

    .remove-participant-btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
    }

    /* Participants Modal Styles */
    .participant-item {
        display: flex;
        align-items: center;
        padding: 0.75rem;
        border-radius: var(--radius-md);
        margin-bottom: 0.5rem;
        background: var(--ui-surface);
        border: 1px solid var(--ui-border);
        transition: all 0.2s ease;
    }

    .participant-item:hover {
        background: var(--ui-hover);
        border-color: var(--primary-color);
    }

    .participant-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid var(--ui-border);
        margin-right: 0.75rem;
        flex-shrink: 0;
    }

    .participant-info {
        flex-grow: 1;
    }

    .participant-name {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.25rem;
    }

    .participant-role {
        font-size: 0.875rem;
        color: var(--text-secondary);
    }

    .participant-status {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: var(--radius-sm);
        font-weight: 500;
    }

    .participant-status.creator {
        background: var(--feedback-success-bg);
        color: var(--feedback-success);
    }

    .participant-status.member {
        background: var(--feedback-info-bg);
        color: var(--feedback-info);
    }

    .participant-actions {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .remove-participant-btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        border-radius: var(--radius-sm);
        transition: all 0.2s ease;
        min-width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .remove-participant-btn:hover {
        background-color: var(--feedback-error);
        border-color: var(--feedback-error);
        color: white;
        transform: scale(1.05);
    }

    .remove-participant-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    /* Add Members Modal Styles */
    .search-results-container {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid var(--ui-border);
        border-radius: var(--radius-md);
        padding: 0.5rem;
    }

    .search-result-item {
        display: flex;
        align-items: center;
        padding: 0.75rem;
        border-radius: var(--radius-md);
        margin-bottom: 0.5rem;
        background: var(--ui-surface);
        border: 1px solid var(--ui-border);
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .search-result-item:hover {
        background: var(--ui-hover);
        border-color: var(--primary-color);
    }

    .search-result-item.selected {
        background: var(--primary-bg);
        border-color: var(--primary-color);
    }

    .search-result-checkbox {
        margin-right: 0.75rem;
    }

    .search-result-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid var(--ui-border);
        margin-right: 0.75rem;
        flex-shrink: 0;
    }

    .search-result-info {
        flex-grow: 1;
    }

    .search-result-name {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.25rem;
    }

    .search-result-details {
        font-size: 0.875rem;
        color: var(--text-secondary);
    }

    .selected-members-container {
        max-height: 150px;
        overflow-y: auto;
        border: 1px solid var(--ui-border);
        border-radius: var(--radius-md);
        padding: 0.5rem;
        background: var(--ui-surface);
    }

    .selected-member-tag {
        display: inline-flex;
        align-items: center;
        background: var(--primary-color);
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: var(--radius-sm);
        margin: 0.25rem;
        font-size: 0.875rem;
    }

    .selected-member-remove {
        margin-left: 0.5rem;
        cursor: pointer;
        opacity: 0.8;
    }

    .selected-member-remove:hover {
        opacity: 1;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="messages-header">
        <h2><i class="fas fa-comments me-2"></i>Your Messages</h2>
    </div>

    <!-- Main Content Area -->
    <div class="row g-3">
        <!-- Conversations Sidebar -->
        <div class="col-lg-4">
            <div class="messages-card h-100">
                <!-- Search and Filter -->
                <div class="p-3 border-bottom">
                    <div class="mb-3">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" class="form-control" id="searchInput" placeholder="Search conversations...">
                        </div>
                    </div>
                    <select class="form-select" id="sortSelect">
                        <option value="recent">Most Recent</option>
                        <option value="unread">Unread First</option>
                        <option value="alphabetical">Alphabetical</option>
                    </select>
                </div>
                
                <!-- Conversations Header -->
                <div class="card-header bg-white border-bottom">
                    <div class="d-flex justify-content-between align-items-center p-3">
                        <h5 class="mb-0">Your Conversations</h5>
                        <div class="btn-group">
                            <button type="button" class="btn btn-primary btn-sm" id="toggleNewMessage" onclick="console.log('Button clicked!'); toggleNewMessageInterface();">
                                <i class="fas fa-plus me-1"></i>New Message
                            </button>
                            <button type="button" class="btn btn-primary btn-sm dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
                                <span class="visually-hidden">Toggle Dropdown</span>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="toggleNewMessageInterface()">
                                    <i class="fas fa-user me-2"></i>Direct Message
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="toggleGroupChatInterface()">
                                    <i class="fas fa-users me-2"></i>Create Group
                                </a></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <script>
                // Immediate test function
                function toggleNewMessageInterface() {
                    console.log('=== toggleNewMessageInterface called ===');
                    const newMessageInterface = document.getElementById('newMessageInterface');
                    const toggleBtn = document.getElementById('toggleNewMessage');

                    console.log('Elements found:', {
                        newMessageInterface: !!newMessageInterface,
                        toggleBtn: !!toggleBtn
                    });

                    if (!newMessageInterface) {
                        console.error('newMessageInterface element not found!');
                        alert('Interface not found. Please refresh the page.');
                        return;
                    }

                    if (newMessageInterface.style.display === 'none' || !newMessageInterface.style.display) {
                        // Show interface
                        console.log('Showing interface');
                        newMessageInterface.style.display = 'block';
                        if (toggleBtn) {
                            toggleBtn.innerHTML = '<i class="fas fa-minus me-1"></i>Hide';
                        }
                    } else {
                        // Hide interface and reset state
                        console.log('Hiding interface');
                        newMessageInterface.style.display = 'none';
                        if (toggleBtn) {
                            toggleBtn.innerHTML = '<i class="fas fa-plus me-1"></i>New Message';
                        }
                    }
                }

                // Search functionality
                function performInlineUserSearch() {
                    console.log('=== performInlineUserSearch called ===');

                    const userSearch = document.getElementById('inlineUserSearch');
                    const searchResults = document.getElementById('inlineSearchResults');
                    const searchResultsList = document.querySelector('.inline-search-results-list');
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');

                    if (!userSearch || !searchResults || !searchResultsList || !csrfToken) {
                        console.error('Required elements not found');
                        return;
                    }

                    const query = userSearch.value.trim();
                    console.log('Search query:', query);

                    if (query.length < 2) {
                        searchResults.style.display = 'none';
                        return;
                    }

                    // Show loading state
                    searchResultsList.innerHTML = `
                        <div class="text-center p-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Searching...</span>
                            </div>
                            <div class="mt-2">Searching for "${query}"...</div>
                        </div>
                    `;
                    searchResults.style.display = 'block';

                    // Make API call
                    const apiUrl = `/profile/api/search-connected-users/?q=${encodeURIComponent(query)}`;
                    console.log('Making API call to:', apiUrl);

                    fetch(apiUrl, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': csrfToken.value
                        },
                        credentials: 'same-origin'
                    })
                    .then(response => {
                        console.log('API Response received:', response.status);
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(users => {
                        console.log('API Response data:', users);
                        searchResultsList.innerHTML = '';

                        if (!Array.isArray(users) || users.length === 0) {
                            searchResultsList.innerHTML = `
                                <div class="text-center p-4">
                                    <i class="fas fa-user-slash fa-2x text-muted mb-2"></i>
                                    <p class="mb-0">No connected alumni found matching "${query}"</p>
                                </div>
                            `;
                        } else {
                            users.forEach(user => {
                                const userItem = document.createElement('div');
                                userItem.className = 'search-result-item';
                                userItem.style.cursor = 'pointer';
                                userItem.onclick = () => selectInlineUser(user);

                                const avatarHtml = user.avatar_url && user.avatar_url !== '/static/images/default-avatar.png'
                                    ? `<img src="${user.avatar_url}" alt="${user.full_name}" class="search-result-avatar" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                       ${createInitialsAvatar(user, 'search-result-avatar d-none', 40, 16)}`
                                    : createInitialsAvatar(user, 'search-result-avatar', 40, 16);

                                userItem.innerHTML = `
                                    ${avatarHtml}
                                    <div class="search-result-info">
                                        <div class="search-result-name">${user.full_name}</div>
                                        <div class="search-result-title">@${user.username}</div>
                                    </div>
                                `;

                                searchResultsList.appendChild(userItem);
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error searching users:', error);
                        searchResultsList.innerHTML = `
                            <div class="text-center p-4">
                                <i class="fas fa-exclamation-triangle fa-2x text-danger mb-2"></i>
                                <p class="mb-0">Error: ${error.message}</p>
                            </div>
                        `;
                    });
                }

                // User selection
                let selectedUserId = null;

                function selectInlineUser(user) {
                    console.log('Selecting user:', user);

                    if (!user || !user.id) {
                        console.error('Invalid user data:', user);
                        return;
                    }

                    selectedUserId = user.id;

                    // Hide search results
                    const searchResults = document.getElementById('inlineSearchResults');
                    const userSearch = document.getElementById('inlineUserSearch');
                    const selectedUserDiv = document.getElementById('inlineSelectedUser');
                    const messageContent = document.getElementById('inlineMessageContent');
                    const sendMessageBtn = document.getElementById('inlineSendMessage');

                    console.log('Found elements:', {
                        searchResults: !!searchResults,
                        userSearch: !!userSearch,
                        selectedUserDiv: !!selectedUserDiv,
                        messageContent: !!messageContent,
                        sendMessageBtn: !!sendMessageBtn
                    });

                    if (searchResults) searchResults.style.display = 'none';
                    if (userSearch) userSearch.value = '';

                    // Show selected user
                    if (selectedUserDiv) {
                        selectedUserDiv.style.display = 'block';
                        const avatar = selectedUserDiv.querySelector('.selected-user-avatar');
                        const name = selectedUserDiv.querySelector('.selected-user-name');
                        const title = selectedUserDiv.querySelector('.selected-user-title');

                        if (avatar) {
                            avatar.src = user.avatar_url || '/static/images/default-avatar.png';
                            avatar.alt = user.full_name || user.username || 'User';
                            avatar.onerror = function() { this.src = '/static/images/default-avatar.png'; };
                        }
                        if (name) name.textContent = user.full_name || user.username || 'Unknown User';
                        if (title) title.textContent = `@${user.username || 'unknown'}`;
                    }

                    // Enable message input and send button
                    if (messageContent) {
                        console.log('Enabling message content textarea');
                        messageContent.disabled = false;
                        messageContent.focus();
                    } else {
                        console.error('Message content textarea not found!');
                    }

                    if (sendMessageBtn) {
                        console.log('Enabling send message button');
                        sendMessageBtn.disabled = false;
                    } else {
                        console.error('Send message button not found!');
                    }

                    const formText = document.querySelector('#inlineMessageContent + .form-text');
                    if (formText) {
                        formText.textContent = 'Type your message here';
                    }

                    console.log('User selected successfully:', user.full_name);
                }

                // Clear user selection
                function clearInlineUserSelection() {
                    console.log('Clearing user selection');
                    selectedUserId = null;

                    const selectedUserDiv = document.getElementById('inlineSelectedUser');
                    const messageContent = document.getElementById('inlineMessageContent');
                    const sendMessageBtn = document.getElementById('inlineSendMessage');

                    // Hide selected user
                    if (selectedUserDiv) {
                        selectedUserDiv.style.display = 'none';
                    }

                    // Disable message input and send button
                    if (messageContent) {
                        messageContent.disabled = true;
                        messageContent.value = '';
                    }
                    if (sendMessageBtn) {
                        sendMessageBtn.disabled = true;
                    }

                    const formText = document.querySelector('#inlineMessageContent + .form-text');
                    if (formText) {
                        formText.textContent = 'Select a user first to enable message input';
                    }
                }

                // Send message function
                function sendInlineMessage() {
                    console.log('Sending inline message');
                    const messageContent = document.getElementById('inlineMessageContent').value.trim();
                    const sendMessageBtn = document.getElementById('inlineSendMessage');

                    if (!selectedUserId || !messageContent) {
                        alert('Please select a user and enter a message.');
                        return;
                    }

                    // Disable button to prevent double submission
                    if (sendMessageBtn) {
                        sendMessageBtn.disabled = true;
                        sendMessageBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Sending...';
                    }

                    // Get CSRF token
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                    // Send message
                    fetch(`/connections/send-message/${selectedUserId}/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': csrfToken,
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: `content=${encodeURIComponent(messageContent)}`
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            console.log('Message sent successfully, updating interface');

                            // Hide the interface and reset state
                            toggleNewMessageInterface();

                            // Update the conversations list and load conversation detail
                            updateConversationsAndLoadDetail(selectedUserId);
                        } else {
                            alert(data.error || 'Failed to send message. Please try again.');
                        }
                    })
                    .catch(error => {
                        console.error('Send message error:', error);
                        alert('Failed to send message. Please try again.');
                    })
                    .finally(() => {
                        // Re-enable button
                        if (sendMessageBtn) {
                            sendMessageBtn.disabled = false;
                            sendMessageBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Send Message';
                        }
                    });
                }

                // Function to update conversations list and load conversation detail
                function updateConversationsAndLoadDetail(userId) {
                    console.log('Updating conversations and loading detail for user:', userId);

                    // First, load the conversation detail in the right panel using HTMX-style approach
                    const conversationDetail = document.getElementById('conversation-detail');
                    if (conversationDetail) {
                        // Show loading state in conversation detail
                        conversationDetail.innerHTML = `
                            <div class="card-body d-flex align-items-center justify-content-center" style="min-height: 500px;">
                                <div class="text-center text-muted">
                                    <div class="spinner-border text-primary mb-3" role="status">
                                        <span class="visually-hidden">Loading conversation...</span>
                                    </div>
                                    <h5>Loading conversation...</h5>
                                </div>
                            </div>
                        `;

                        // Load the conversation detail using HTMX-style request
                        fetch(`/connections/messages/${userId}/`, {
                            method: 'GET',
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest',
                                'HX-Request': 'true',  // This tells the server to return the partial template
                                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                            },
                            credentials: 'same-origin'
                        })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                            }
                            return response.text();
                        })
                        .then(html => {
                            // The response should be the partial template content directly
                            conversationDetail.innerHTML = html;
                            console.log('Conversation detail loaded successfully');

                            // Re-initialize any scripts in the loaded content
                            const scripts = conversationDetail.querySelectorAll('script');
                            scripts.forEach(script => {
                                const newScript = document.createElement('script');
                                newScript.textContent = script.textContent;
                                script.parentNode.replaceChild(newScript, script);
                            });

                            // Scroll to bottom of messages if there's a messages container
                            const messagesContainer = conversationDetail.querySelector('#messagesContainer');
                            if (messagesContainer) {
                                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                            }
                        })
                        .catch(error => {
                            console.error('Error loading conversation detail:', error);
                            conversationDetail.innerHTML = `
                                <div class="card-body d-flex align-items-center justify-content-center" style="min-height: 500px;">
                                    <div class="text-center text-muted">
                                        <i class="fas fa-exclamation-triangle fa-3x mb-3 text-danger"></i>
                                        <h5>Error loading conversation</h5>
                                        <p>Please refresh the page and try again.</p>
                                        <button class="btn btn-primary" onclick="window.location.reload()">
                                            <i class="fas fa-refresh me-1"></i>Refresh Page
                                        </button>
                                    </div>
                                </div>
                            `;
                        });
                    }

                    // Refresh the conversations list to show the new/updated conversation
                    refreshConversationsList(userId);
                }

                // Function to refresh the conversations list
                function refreshConversationsList(activeUserId = null) {
                    console.log('Refreshing conversations list');

                    // Reload the current page to get updated conversations list
                    // We'll use a more sophisticated approach to just update the conversations
                    fetch(window.location.href, {
                        method: 'GET',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        credentials: 'same-origin'
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        return response.text();
                    })
                    .then(html => {
                        // Extract the conversations list from the response
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        const newConversationsList = doc.getElementById('conversationsList');
                        const currentConversationsList = document.getElementById('conversationsList');

                        if (newConversationsList && currentConversationsList) {
                            // Update the conversations list
                            currentConversationsList.innerHTML = newConversationsList.innerHTML;
                            console.log('Conversations list updated successfully');

                            // Re-initialize HTMX for new conversation items
                            console.log('Re-initializing HTMX for new conversation items');
                            if (typeof htmx !== 'undefined') {
                                htmx.process(currentConversationsList);
                                console.log('HTMX re-initialized for conversation list');
                            } else {
                                console.warn('HTMX not available for re-initialization');
                            }

                            // Re-initialize avatars after updating conversation list
                            setTimeout(() => {
                                console.log('Re-initializing avatars after conversation list refresh');
                                initializeAllAvatars();
                            }, 50);

                            // Re-attach any additional event listeners if needed
                            setTimeout(() => {
                                console.log('Re-attaching conversation list event listeners');

                                // Ensure search functionality still works
                                const searchInput = document.getElementById('searchInput');
                                if (searchInput && !searchInput.hasAttribute('data-listeners-attached')) {
                                    // Mark as processed to avoid duplicate listeners
                                    searchInput.setAttribute('data-listeners-attached', 'true');
                                }

                                // Ensure sort functionality still works
                                const sortSelect = document.getElementById('sortSelect');
                                if (sortSelect && !sortSelect.hasAttribute('data-listeners-attached')) {
                                    // Mark as processed to avoid duplicate listeners
                                    sortSelect.setAttribute('data-listeners-attached', 'true');
                                }

                                console.log('Event listeners re-attachment complete');
                            }, 100);

                            // If we have an active user ID, highlight that conversation
                            if (activeUserId) {
                                setTimeout(() => {
                                    highlightActiveConversation(activeUserId);
                                }, 150);
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error refreshing conversations list:', error);
                        // Fallback: reload the page
                        console.log('Falling back to page reload');
                        window.location.reload();
                    });
                }

                // Function to highlight the active conversation
                function highlightActiveConversation(userId) {
                    console.log('Highlighting active conversation for user:', userId);

                    // Remove active class from all conversations
                    document.querySelectorAll('.conversation-item').forEach(item => {
                        item.classList.remove('active');
                    });

                    // Find and highlight the conversation with the specified user
                    const conversations = document.querySelectorAll('.conversation-item');
                    conversations.forEach(conversation => {
                        // Check if this conversation is for the specified user
                        // We can check the hx-get attribute or data attributes
                        const hxGet = conversation.getAttribute('hx-get');
                        if (hxGet && hxGet.includes(`/messages/${userId}/`)) {
                            conversation.classList.add('active');
                            console.log('Found and highlighted conversation');

                            // Scroll the conversation into view if needed
                            conversation.scrollIntoView({
                                behavior: 'smooth',
                                block: 'nearest'
                            });
                        }
                    });
                }

                // Add event listeners when DOM is ready
                document.addEventListener('DOMContentLoaded', function() {
                    console.log('DOM loaded, adding event listeners');

                    const searchBtn = document.getElementById('inlineSearchBtn');
                    const userSearch = document.getElementById('inlineUserSearch');
                    const clearSelection = document.getElementById('inlineClearSelection');
                    const sendMessageBtn = document.getElementById('inlineSendMessage');
                    const closeBtn = document.getElementById('closeNewMessage');
                    const cancelBtn = document.getElementById('inlineCancelMessage');

                    if (searchBtn) {
                        searchBtn.addEventListener('click', function(e) {
                            e.preventDefault();
                            console.log('Search button clicked');
                            performInlineUserSearch();
                        });
                    }

                    if (userSearch) {
                        userSearch.addEventListener('keypress', function(e) {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                console.log('Enter pressed');
                                performInlineUserSearch();
                            }
                        });

                        // Auto-search with debounce
                        let searchTimeout;
                        userSearch.addEventListener('input', function(e) {
                            const query = e.target.value.trim();

                            if (searchTimeout) {
                                clearTimeout(searchTimeout);
                            }

                            if (query.length >= 2) {
                                searchTimeout = setTimeout(() => {
                                    console.log('Auto-searching for:', query);
                                    performInlineUserSearch();
                                }, 500);
                            } else if (query.length === 0) {
                                const searchResults = document.getElementById('inlineSearchResults');
                                if (searchResults) {
                                    searchResults.style.display = 'none';
                                }
                            }
                        });
                    }

                    // Clear selection button
                    if (clearSelection) {
                        clearSelection.addEventListener('click', function(e) {
                            e.preventDefault();
                            console.log('Clear selection clicked');
                            clearInlineUserSelection();
                        });
                    }

                    // Send message button
                    if (sendMessageBtn) {
                        sendMessageBtn.addEventListener('click', function(e) {
                            e.preventDefault();
                            console.log('Send message clicked');
                            sendInlineMessage();
                        });
                    }

                    // Close and cancel buttons
                    if (closeBtn) {
                        closeBtn.addEventListener('click', function(e) {
                            e.preventDefault();
                            console.log('Close button clicked');
                            toggleNewMessageInterface();
                        });
                    }

                    if (cancelBtn) {
                        cancelBtn.addEventListener('click', function(e) {
                            e.preventDefault();
                            console.log('Cancel button clicked');
                            toggleNewMessageInterface();
                        });
                    }

                    // Group chat event listeners
                    const groupSearchBtn = document.getElementById('groupSearchBtn');
                    const groupUserSearch = document.getElementById('groupUserSearch');
                    const groupNameInput = document.getElementById('groupNameInput');
                    const createGroupBtn = document.getElementById('createGroupBtn');
                    const closeGroupChat = document.getElementById('closeGroupChat');
                    const cancelGroupChat = document.getElementById('cancelGroupChat');

                    if (groupSearchBtn) {
                        groupSearchBtn.addEventListener('click', function(e) {
                            e.preventDefault();
                            performGroupUserSearch();
                        });
                    }

                    if (groupUserSearch) {
                        groupUserSearch.addEventListener('keypress', function(e) {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                performGroupUserSearch();
                            }
                        });

                        // Auto-search with debounce
                        let groupSearchTimeout;
                        groupUserSearch.addEventListener('input', function(e) {
                            const query = e.target.value.trim();

                            if (groupSearchTimeout) {
                                clearTimeout(groupSearchTimeout);
                            }

                            if (query.length >= 2) {
                                groupSearchTimeout = setTimeout(() => {
                                    performGroupUserSearch();
                                }, 300);
                            } else {
                                document.getElementById('groupSearchResults').style.display = 'none';
                            }
                        });
                    }

                    if (groupNameInput) {
                        groupNameInput.addEventListener('input', function() {
                            updateCreateGroupButton();
                        });
                    }

                    if (createGroupBtn) {
                        createGroupBtn.addEventListener('click', function(e) {
                            e.preventDefault();
                            createGroupChat();
                        });
                    }

                    if (closeGroupChat) {
                        closeGroupChat.addEventListener('click', function(e) {
                            e.preventDefault();
                            toggleGroupChatInterface();
                        });
                    }

                    if (cancelGroupChat) {
                        cancelGroupChat.addEventListener('click', function(e) {
                            e.preventDefault();
                            toggleGroupChatInterface();
                        });
                    }

                    console.log('All event listeners added (including group chat)');
                });

                // Test function for user selection
                window.testUserSelection = function() {
                    console.log('=== Testing user selection ===');
                    const testUser = {
                        id: 123,
                        username: 'testuser',
                        full_name: 'Test User',
                        avatar_url: '/static/images/default-avatar.png'
                    };
                    selectInlineUser(testUser);
                };

                // Debug function to check textarea state
                window.debugTextarea = function() {
                    const messageContent = document.getElementById('inlineMessageContent');
                    const sendBtn = document.getElementById('inlineSendMessage');
                    console.log('Textarea state:', {
                        found: !!messageContent,
                        disabled: messageContent ? messageContent.disabled : 'N/A',
                        value: messageContent ? messageContent.value : 'N/A',
                        sendBtnDisabled: sendBtn ? sendBtn.disabled : 'N/A'
                    });
                    return { messageContent, sendBtn };
                };

                // Test function for post-send behavior
                window.testPostSendBehavior = function(userId = 1) {
                    console.log('=== Testing post-send behavior ===');
                    console.log('This will simulate the post-send actions without actually sending a message');

                    // Hide the interface
                    toggleNewMessageInterface();

                    // Update conversations and load detail
                    updateConversationsAndLoadDetail(userId);
                };

                // Test function to load conversation detail directly
                window.testLoadConversation = function(userId = 1) {
                    console.log('=== Testing conversation detail loading ===');
                    const conversationDetail = document.getElementById('conversation-detail');

                    if (!conversationDetail) {
                        console.error('conversation-detail element not found');
                        return;
                    }

                    conversationDetail.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-primary" role="status"></div><div class="mt-2">Loading conversation...</div></div>';

                    fetch(`/connections/messages/${userId}/`, {
                        method: 'GET',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'HX-Request': 'true',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        credentials: 'same-origin'
                    })
                    .then(response => {
                        console.log('Response status:', response.status);
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        return response.text();
                    })
                    .then(html => {
                        console.log('Received HTML length:', html.length);
                        conversationDetail.innerHTML = html;
                        console.log('Conversation loaded successfully');

                        // Highlight the conversation
                        highlightActiveConversation(userId);
                    })
                    .catch(error => {
                        console.error('Error loading conversation:', error);
                        conversationDetail.innerHTML = `
                            <div class="text-center p-4">
                                <i class="fas fa-exclamation-triangle fa-2x text-danger mb-2"></i>
                                <p>Error loading conversation: ${error.message}</p>
                                <button class="btn btn-outline-primary" onclick="testLoadConversation(${userId})">Try Again</button>
                            </div>
                        `;
                    });
                };

                // Group Chat Functions
                let selectedParticipants = [];

                function toggleGroupChatInterface() {
                    console.log('=== toggleGroupChatInterface called ===');
                    const groupChatInterface = document.getElementById('groupChatInterface');
                    const newMessageInterface = document.getElementById('newMessageInterface');

                    if (!groupChatInterface) {
                        console.error('groupChatInterface element not found!');
                        return;
                    }

                    // Hide direct message interface if open
                    if (newMessageInterface && newMessageInterface.style.display !== 'none') {
                        newMessageInterface.style.display = 'none';
                    }

                    if (groupChatInterface.style.display === 'none' || !groupChatInterface.style.display) {
                        // Show interface
                        groupChatInterface.style.display = 'block';
                        resetGroupChatForm();
                    } else {
                        // Hide interface
                        groupChatInterface.style.display = 'none';
                        resetGroupChatForm();
                    }
                }

                function resetGroupChatForm() {
                    document.getElementById('groupNameInput').value = '';
                    document.getElementById('groupUserSearch').value = '';
                    selectedParticipants = [];
                    updateParticipantsList();
                    document.getElementById('groupSearchResults').style.display = 'none';
                    updateCreateGroupButton();
                }

                function performGroupUserSearch() {
                    const searchTerm = document.getElementById('groupUserSearch').value.trim();
                    const resultsContainer = document.getElementById('groupSearchResults');
                    const resultsList = document.querySelector('.group-search-results-list');

                    if (searchTerm.length < 2) {
                        resultsContainer.style.display = 'none';
                        return;
                    }

                    // Show loading
                    resultsList.innerHTML = '<div class="text-center p-3"><div class="spinner-border spinner-border-sm" role="status"></div><span class="ms-2">Searching...</span></div>';
                    resultsContainer.style.display = 'block';

                    fetch(`/profile/api/search-connected-users/?q=${encodeURIComponent(searchTerm)}`, {
                        method: 'GET',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        // The connected users API returns an array directly
                        if (Array.isArray(data) && data.length > 0) {
                            displayGroupSearchResults(data);
                        } else {
                            resultsList.innerHTML = '<div class="text-center p-3 text-muted">No users found</div>';
                        }
                    })
                    .catch(error => {
                        console.error('Search error:', error);
                        resultsList.innerHTML = '<div class="text-center p-3 text-danger">Search failed</div>';
                    });
                }

                function displayGroupSearchResults(users) {
                    const resultsList = document.querySelector('.group-search-results-list');

                    if (users.length === 0) {
                        resultsList.innerHTML = '<div class="text-center p-3 text-muted">No users found</div>';
                        return;
                    }

                    const html = users.map(user => {
                        const isAlreadySelected = selectedParticipants.some(p => p.id === user.id);
                        const buttonClass = isAlreadySelected ? 'btn-secondary' : 'btn-outline-primary';
                        const buttonText = isAlreadySelected ? 'Added' : 'Add';
                        const buttonDisabled = isAlreadySelected ? 'disabled' : '';

                        const avatarHtml = user.avatar_url && user.avatar_url !== '/static/images/default-avatar.png'
                            ? `<img src="${user.avatar_url}" alt="${user.full_name}" class="rounded-circle me-3" width="40" height="40" style="object-fit: cover;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                               ${createInitialsAvatar(user, 'rounded-circle me-3 d-none', 40, 16)}`
                            : createInitialsAvatar(user, 'rounded-circle me-3', 40, 16);

                        return `
                            <div class="search-result-item d-flex align-items-center justify-content-between p-2 border-bottom">
                                <div class="d-flex align-items-center">
                                    ${avatarHtml}
                                    <div>
                                        <div class="fw-semibold">${user.full_name}</div>
                                        <div class="text-muted small">${user.username || 'Alumni'}</div>
                                    </div>
                                </div>
                                <button type="button"
                                        class="btn btn-sm ${buttonClass}"
                                        onclick="addParticipant(${user.id}, '${user.full_name}', '${user.avatar_url || ''}', '${user.username || 'Alumni'}')"
                                        ${buttonDisabled}>
                                    ${buttonText}
                                </button>
                            </div>
                        `;
                    }).join('');

                    resultsList.innerHTML = html;
                }

                function addParticipant(userId, fullName, profilePicture, title) {
                    // Check if already added
                    if (selectedParticipants.some(p => p.id === userId)) {
                        return;
                    }

                    selectedParticipants.push({
                        id: userId,
                        full_name: fullName,
                        avatar_url: profilePicture,
                        username: title
                    });

                    updateParticipantsList();
                    updateCreateGroupButton();

                    // Refresh search results to show "Added" state
                    const searchTerm = document.getElementById('groupUserSearch').value.trim();
                    if (searchTerm.length >= 2) {
                        performGroupUserSearch();
                    }
                }

                function removeParticipant(userId) {
                    selectedParticipants = selectedParticipants.filter(p => p.id !== userId);
                    updateParticipantsList();
                    updateCreateGroupButton();

                    // Refresh search results to show "Add" state
                    const searchTerm = document.getElementById('groupUserSearch').value.trim();
                    if (searchTerm.length >= 2) {
                        performGroupUserSearch();
                    }
                }

                function updateParticipantsList() {
                    const participantsList = document.getElementById('participantsList');
                    const participantCount = document.getElementById('participantCount');

                    participantCount.textContent = selectedParticipants.length;

                    if (selectedParticipants.length === 0) {
                        participantsList.innerHTML = '<div class="text-muted small">No participants selected yet. Add at least 2 participants.</div>';
                        return;
                    }

                    const html = selectedParticipants.map(participant => {
                        const avatarHtml = participant.avatar_url && participant.avatar_url !== '/static/images/default-avatar.png'
                            ? `<img src="${participant.avatar_url}" alt="${participant.full_name}" class="participant-avatar me-3" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                               ${createInitialsAvatar(participant, 'participant-avatar me-3 d-none', 32, 14)}`
                            : createInitialsAvatar(participant, 'participant-avatar me-3', 32, 14);

                        return `
                            <div class="participant-item">
                                <div class="d-flex align-items-center">
                                    ${avatarHtml}
                                    <div>
                                        <div class="fw-semibold">${participant.full_name}</div>
                                        <div class="text-muted small">${participant.username}</div>
                                    </div>
                                </div>
                                <button type="button"
                                        class="btn btn-outline-danger btn-sm remove-participant-btn"
                                        onclick="removeParticipant(${participant.id})">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        `;
                    }).join('');

                    participantsList.innerHTML = html;
                }

                function updateCreateGroupButton() {
                    const createBtn = document.getElementById('createGroupBtn');
                    const groupName = document.getElementById('groupNameInput').value.trim();

                    const isValid = groupName.length > 0 && selectedParticipants.length >= 2;
                    createBtn.disabled = !isValid;
                }

                function createGroupChat() {
                    const groupName = document.getElementById('groupNameInput').value.trim();

                    if (!groupName) {
                        alert('Please enter a group name');
                        return;
                    }

                    if (selectedParticipants.length < 2) {
                        alert('Please select at least 2 participants');
                        return;
                    }

                    const createBtn = document.getElementById('createGroupBtn');
                    createBtn.disabled = true;
                    createBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Creating...';

                    const participantIds = selectedParticipants.map(p => p.id);

                    fetch('/connections/api/create-group/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        body: JSON.stringify({
                            group_name: groupName,
                            participant_ids: participantIds
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            console.log('Group created successfully');

                            // Hide the interface
                            toggleGroupChatInterface();

                            // Load the new group conversation
                            loadGroupConversation(data.conversation_id);

                            // Refresh conversations list
                            refreshConversationsList();
                        } else {
                            alert(data.error || 'Failed to create group. Please try again.');
                        }
                    })
                    .catch(error => {
                        console.error('Create group error:', error);
                        alert('Failed to create group. Please try again.');
                    })
                    .finally(() => {
                        createBtn.disabled = false;
                        createBtn.innerHTML = '<i class="fas fa-users me-1"></i>Create Group';
                    });
                }

                function loadGroupConversation(conversationId) {
                    const conversationDetail = document.getElementById('conversation-detail');

                    if (!conversationDetail) {
                        console.error('conversation-detail element not found');
                        return;
                    }

                    conversationDetail.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-primary" role="status"></div><div class="mt-2">Loading group chat...</div></div>';

                    fetch(`/connections/group/${conversationId}/`, {
                        method: 'GET',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'HX-Request': 'true',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        credentials: 'same-origin'
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        return response.text();
                    })
                    .then(html => {
                        conversationDetail.innerHTML = html;
                        console.log('Group conversation loaded successfully');

                        // Scroll to bottom of messages if there's a messages container
                        const messagesContainer = conversationDetail.querySelector('#messagesContainer');
                        if (messagesContainer) {
                            messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        }
                    })
                    .catch(error => {
                        console.error('Error loading group conversation:', error);
                        conversationDetail.innerHTML = `
                            <div class="text-center p-4">
                                <i class="fas fa-exclamation-triangle fa-2x text-danger mb-2"></i>
                                <p>Error loading group conversation: ${error.message}</p>
                                <button class="btn btn-outline-primary" onclick="loadGroupConversation(${conversationId})">Try Again</button>
                            </div>
                        `;
                    });
                }

                // Make functions available globally
                window.toggleNewMessageInterface = toggleNewMessageInterface;
                window.performInlineUserSearch = performInlineUserSearch;
                window.selectInlineUser = selectInlineUser;
                window.clearInlineUserSelection = clearInlineUserSelection;
                window.sendInlineMessage = sendInlineMessage;
                window.updateConversationsAndLoadDetail = updateConversationsAndLoadDetail;
                window.refreshConversationsList = refreshConversationsList;
                window.highlightActiveConversation = highlightActiveConversation;

                // Group chat functions
                window.toggleGroupChatInterface = toggleGroupChatInterface;
                window.performGroupUserSearch = performGroupUserSearch;
                window.addParticipant = addParticipant;
                window.removeParticipant = removeParticipant;
                window.createGroupChat = createGroupChat;
                window.loadGroupConversation = loadGroupConversation;

                // Function to set active conversation (ensure it's available globally)
                function setActiveConversation(element) {
                    console.log('Setting active conversation');
                    // Remove active class from all conversation items
                    document.querySelectorAll('.conversation-item').forEach(function(item) {
                        item.classList.remove('active');
                    });

                    // Add active class to clicked item
                    element.classList.add('active');
                }

                // Make setActiveConversation available globally
                window.setActiveConversation = setActiveConversation;

                // Global message sending functions
                function sendMessage(event, userId) {
                    event.preventDefault();
                    console.log('Sending direct message to user:', userId);

                    const form = event.target;
                    const formData = new FormData(form);
                    const messageInput = form.querySelector('input[name="content"]');
                    const submitBtn = form.querySelector('button[type="submit"]');

                    if (!messageInput || !messageInput.value.trim()) {
                        alert('Please enter a message');
                        return;
                    }

                    // Disable form while sending
                    messageInput.disabled = true;
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

                    fetch(`/connections/send-message/${userId}/`, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Clear the form
                            form.reset();

                            // Add the new message to the container if message_html is provided
                            if (data.message_html) {
                                const messagesContainer = document.getElementById('messagesContainer');
                                if (messagesContainer) {
                                    console.log('=== ADDING NEW MESSAGE TO DOM ===');
                                    console.log('Message HTML:', data.message_html);
                                    messagesContainer.insertAdjacentHTML('beforeend', data.message_html);
                                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                                    console.log('Message added to DOM, starting avatar initialization...');

                                    // Initialize avatars in the newly added message
                                    console.log('=== INITIALIZING AVATARS IN NEWLY SENT MESSAGE ===');
                                    setTimeout(function() {
                                        // Initialize user avatars in the new message (including hidden ones)
                                        const newMessageAvatars = messagesContainer.querySelectorAll('.message:last-child .user-avatar');
                                        console.log(`Found ${newMessageAvatars.length} avatars in new message`);

                                        // Also check for profile images in the new message
                                        const newMessageImages = messagesContainer.querySelectorAll('.message:last-child img.message-avatar');
                                        console.log(`Found ${newMessageImages.length} profile images in new message`);

                                        newMessageAvatars.forEach((avatar, index) => {
                                            const userId = parseInt(avatar.getAttribute('data-user-id'));
                                            const firstName = avatar.getAttribute('data-first-name');
                                            const lastName = avatar.getAttribute('data-last-name');
                                            const username = avatar.getAttribute('data-username');

                                            console.log(`Initializing avatar ${index + 1}: User ${userId}, Name: ${firstName} ${lastName}`);
                                            console.log(`Avatar element:`, avatar);
                                            console.log(`Avatar classes:`, avatar.className);
                                            console.log(`Avatar current display:`, avatar.style.display);
                                            console.log(`Avatar current text:`, avatar.textContent);

                                            // Generate initials
                                            let initials = '?';
                                            if (firstName && lastName) {
                                                initials = (firstName.charAt(0) + lastName.charAt(0)).toUpperCase();
                                            } else if (firstName) {
                                                initials = firstName.substring(0, 2).toUpperCase();
                                            } else if (username) {
                                                initials = username.substring(0, 2).toUpperCase();
                                            }

                                            console.log(`Generated initials: "${initials}"`);

                                            // Check if this avatar should be visible
                                            const isHidden = avatar.classList.contains('d-none');
                                            console.log(`Avatar is hidden (d-none): ${isHidden}`);

                                            // Apply gradient
                                            const gradients = [
                                                'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                                'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                                                'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                                                'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                                                'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                                                'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
                                                'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)',
                                                'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)'
                                            ];

                                            const gradientIndex = userId % gradients.length;
                                            avatar.style.background = gradients[gradientIndex];
                                            avatar.textContent = initials;

                                            // Ensure avatar is visible if it's supposed to be shown
                                            // (This handles cases where profile image fails to load)
                                            const profileImg = avatar.previousElementSibling;
                                            console.log(`Profile image element:`, profileImg);

                                            if (profileImg && profileImg.tagName === 'IMG') {
                                                console.log(`Found profile image for user ${userId}:`, profileImg.src);
                                                console.log(`Profile image complete: ${profileImg.complete}, naturalWidth: ${profileImg.naturalWidth}`);

                                                // Set up proper error handling for profile image
                                                profileImg.onerror = function() {
                                                    console.log(`🔥 Profile image FAILED for user ${userId}, showing initialized avatar`);
                                                    this.style.display = 'none';
                                                    avatar.style.display = 'flex';
                                                    avatar.classList.remove('d-none');
                                                    avatar.classList.add('d-flex');
                                                    console.log(`Avatar now visible with initials: "${initials}"`);
                                                };

                                                // Check if image is already broken
                                                if (profileImg.complete && profileImg.naturalWidth === 0) {
                                                    console.log(`Profile image already broken, triggering error handler`);
                                                    profileImg.onerror();
                                                } else {
                                                    console.log(`Profile image appears to be loading/loaded successfully`);
                                                }
                                            } else {
                                                console.log(`No profile image found - avatar should be visible by default`);
                                                // If no profile image, make sure avatar is visible
                                                avatar.style.display = 'flex';
                                                avatar.classList.remove('d-none');
                                                avatar.classList.add('d-flex');
                                            }

                                            console.log(`New message avatar initialized: User ${userId} → "${initials}" with gradient ${gradientIndex}`);
                                        });

                                        // Also initialize any chat header avatars that might need updating
                                        initializeChatHeaderAvatars();
                                    }, 100);
                                }
                            }

                            // Update conversations list
                            if (window.refreshConversationsList) {
                                window.refreshConversationsList();

                                // Re-initialize avatars after conversation list refresh
                                setTimeout(function() {
                                    console.log('Re-initializing avatars after conversation list refresh');
                                    initializeAllAvatars();
                                }, 100);
                            }
                        } else {
                            alert(data.error || 'Failed to send message');
                        }
                    })
                    .catch(error => {
                        console.error('Error sending message:', error);
                        alert('Failed to send message. Please try again.');
                    })
                    .finally(() => {
                        // Re-enable form
                        messageInput.disabled = false;
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                        messageInput.focus();
                    });
                }

                function sendGroupMessage(event, conversationId) {
                    event.preventDefault();
                    console.log('Sending group message to conversation:', conversationId);

                    const form = event.target;
                    const formData = new FormData(form);
                    const messageInput = form.querySelector('input[name="content"]');
                    const submitBtn = form.querySelector('button[type="submit"]');

                    if (!messageInput || !messageInput.value.trim()) {
                        alert('Please enter a message');
                        return;
                    }

                    // Disable form while sending
                    messageInput.disabled = true;
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

                    fetch(`/connections/group/${conversationId}/send/`, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Clear the form
                            form.reset();

                            // Add the new message to the container if message_html is provided
                            if (data.message_html) {
                                const messagesContainer = document.getElementById('messagesContainer');
                                if (messagesContainer) {
                                    messagesContainer.insertAdjacentHTML('beforeend', data.message_html);
                                    messagesContainer.scrollTop = messagesContainer.scrollHeight;

                                    // Initialize avatars in the newly added group message
                                    console.log('Initializing avatars in newly sent group message');
                                    setTimeout(function() {
                                        // Initialize user avatars in the new message (including hidden ones)
                                        const newMessageAvatars = messagesContainer.querySelectorAll('.message:last-child .user-avatar');
                                        console.log(`Found ${newMessageAvatars.length} avatars in new group message`);

                                        newMessageAvatars.forEach((avatar, index) => {
                                            const userId = parseInt(avatar.getAttribute('data-user-id'));
                                            const firstName = avatar.getAttribute('data-first-name');
                                            const lastName = avatar.getAttribute('data-last-name');
                                            const username = avatar.getAttribute('data-username');

                                            console.log(`Initializing group avatar ${index + 1}: User ${userId}, Name: ${firstName} ${lastName}`);

                                            // Generate initials
                                            let initials = '?';
                                            if (firstName && lastName) {
                                                initials = (firstName.charAt(0) + lastName.charAt(0)).toUpperCase();
                                            } else if (firstName) {
                                                initials = firstName.substring(0, 2).toUpperCase();
                                            } else if (username) {
                                                initials = username.substring(0, 2).toUpperCase();
                                            }

                                            // Apply gradient
                                            const gradients = [
                                                'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                                'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                                                'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                                                'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                                                'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                                                'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
                                                'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)',
                                                'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)'
                                            ];

                                            const gradientIndex = userId % gradients.length;
                                            avatar.style.background = gradients[gradientIndex];
                                            avatar.textContent = initials;

                                            // Ensure avatar is visible if it's supposed to be shown
                                            // (This handles cases where profile image fails to load)
                                            const profileImg = avatar.previousElementSibling;
                                            if (profileImg && profileImg.tagName === 'IMG') {
                                                // Set up proper error handling for profile image
                                                profileImg.onerror = function() {
                                                    console.log(`Profile image failed for user ${userId}, showing initialized avatar`);
                                                    this.style.display = 'none';
                                                    avatar.style.display = 'flex';
                                                    avatar.classList.remove('d-none');
                                                    avatar.classList.add('d-flex');
                                                };

                                                // Check if image is already broken
                                                if (profileImg.complete && profileImg.naturalWidth === 0) {
                                                    profileImg.onerror();
                                                }
                                            }

                                            console.log(`New group message avatar initialized: User ${userId} → "${initials}" with gradient ${gradientIndex}`);
                                        });

                                        // Also initialize any chat header avatars that might need updating
                                        initializeChatHeaderAvatars();
                                    }, 100);
                                }
                            }

                            // Update conversations list
                            if (window.refreshConversationsList) {
                                window.refreshConversationsList();

                                // Re-initialize avatars after conversation list refresh
                                setTimeout(function() {
                                    console.log('Re-initializing avatars after group conversation list refresh');
                                    initializeAllAvatars();
                                }, 100);
                            }
                        } else {
                            alert(data.error || 'Failed to send message');
                        }
                    })
                    .catch(error => {
                        console.error('Error sending group message:', error);
                        alert('Failed to send message. Please try again.');
                    })
                    .finally(() => {
                        // Re-enable form
                        messageInput.disabled = false;
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                        messageInput.focus();
                    });
                }

                // Make message sending functions available globally
                window.sendMessage = sendMessage;
                window.sendGroupMessage = sendGroupMessage;

                // Test function for group chat creation
                window.testGroupChatCreation = function() {
                    console.log('=== Testing Group Chat Creation ===');

                    // Show the group chat interface
                    toggleGroupChatInterface();

                    // Fill in test data
                    setTimeout(() => {
                        document.getElementById('groupNameInput').value = 'Test Group Chat';
                        console.log('Group name set');

                        // Simulate adding participants (you'll need to search and add real users)
                        console.log('To complete the test:');
                        console.log('1. Search for users in the participant search');
                        console.log('2. Add at least 2 participants');
                        console.log('3. Click "Create Group" button');
                        console.log('4. The group should be created and loaded');
                    }, 100);
                };

                // Test function to verify all group chat features
                window.testGroupChatFeatures = function() {
                    console.log('=== Testing All Group Chat Features ===');

                    console.log('✓ Group Chat Interface Toggle');
                    console.log('  - toggleGroupChatInterface() function available:', typeof toggleGroupChatInterface === 'function');

                    console.log('✓ Participant Management');
                    console.log('  - addParticipant() function available:', typeof addParticipant === 'function');
                    console.log('  - removeParticipant() function available:', typeof removeParticipant === 'function');

                    console.log('✓ Group Creation');
                    console.log('  - createGroupChat() function available:', typeof createGroupChat === 'function');

                    console.log('✓ Group Conversation Loading');
                    console.log('  - loadGroupConversation() function available:', typeof loadGroupConversation === 'function');

                    console.log('✓ Search Functionality');
                    console.log('  - performGroupUserSearch() function available:', typeof performGroupUserSearch === 'function');

                    // Check if UI elements exist
                    const groupInterface = document.getElementById('groupChatInterface');
                    const groupNameInput = document.getElementById('groupNameInput');
                    const groupUserSearch = document.getElementById('groupUserSearch');
                    const createGroupBtn = document.getElementById('createGroupBtn');

                    console.log('✓ UI Elements');
                    console.log('  - Group chat interface element:', !!groupInterface);
                    console.log('  - Group name input:', !!groupNameInput);
                    console.log('  - User search input:', !!groupUserSearch);
                    console.log('  - Create group button:', !!createGroupBtn);

                    // Test the interface toggle
                    if (groupInterface) {
                        console.log('✓ Testing Interface Toggle');
                        const initialDisplay = groupInterface.style.display;
                        toggleGroupChatInterface();
                        const afterToggle = groupInterface.style.display;
                        console.log('  - Initial display:', initialDisplay);
                        console.log('  - After toggle:', afterToggle);

                        // Toggle back
                        if (afterToggle !== 'none') {
                            toggleGroupChatInterface();
                        }
                    }

                    console.log('=== Group Chat Features Test Complete ===');
                    console.log('All core functionality appears to be implemented correctly!');

                    // Test the search functionality
                    console.log('✓ Testing Search Functionality');
                    fetch('/accounts/api/search-connected-users/?q=test', {
                        method: 'GET',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        }
                    })
                    .then(response => {
                        console.log('  - Search API response status:', response.status);
                        return response.json();
                    })
                    .then(data => {
                        console.log('  - Search API data type:', Array.isArray(data) ? 'Array' : typeof data);
                        console.log('  - Search API data length:', Array.isArray(data) ? data.length : 'N/A');
                        if (Array.isArray(data) && data.length > 0) {
                            console.log('  - Sample user data:', data[0]);
                        }
                    })
                    .catch(error => {
                        console.log('  - Search API error:', error.message);
                    });
                };

                // Test API endpoints
                window.testGroupChatAPI = function() {
                    console.log('=== Testing Group Chat API Endpoints ===');

                    // Test create group endpoint (with invalid data to check error handling)
                    fetch('/connections/api/create-group/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        body: JSON.stringify({
                            group_name: '',  // Invalid: empty name
                            participant_ids: []  // Invalid: no participants
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('✓ Create Group API Response:', data);
                        console.log('  - Should show error for empty name:', data.success === false);
                    })
                    .catch(error => {
                        console.log('✗ Create Group API Error:', error);
                    });

                    // Test search endpoint
                    fetch('/profile/api/search-connected-users/?q=test', {
                        method: 'GET',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('✓ User Search API Response:', data);
                        console.log('  - Search endpoint working:', data.success !== undefined);
                    })
                    .catch(error => {
                        console.log('✗ User Search API Error:', error);
                    });
                };

                // Comprehensive test for the search fix
                window.testSearchFix = function() {
                    console.log('=== Testing Search Fix ===');

                    // Test the endpoint directly
                    console.log('1. Testing search endpoint directly...');
                    fetch('/profile/api/search-connected-users/?q=test', {
                        method: 'GET',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        }
                    })
                    .then(response => {
                        console.log('   - Response status:', response.status);
                        console.log('   - Response headers:', response.headers.get('content-type'));
                        return response.text();
                    })
                    .then(text => {
                        console.log('   - Response text (first 100 chars):', text.substring(0, 100));

                        // Try to parse as JSON
                        try {
                            const data = JSON.parse(text);
                            console.log('   ✓ Response is valid JSON');
                            console.log('   - Data type:', Array.isArray(data) ? 'Array' : typeof data);
                            console.log('   - Data length:', Array.isArray(data) ? data.length : 'N/A');
                            if (Array.isArray(data) && data.length > 0) {
                                console.log('   - Sample user:', data[0]);
                            }
                        } catch (e) {
                            console.log('   ✗ Response is NOT valid JSON:', e.message);
                        }
                    })
                    .catch(error => {
                        console.log('   ✗ Request failed:', error.message);
                    });

                    // Test the group search function
                    console.log('2. Testing group search function...');
                    setTimeout(() => {
                        // Open group interface
                        toggleGroupChatInterface();

                        // Set a test search term
                        const searchInput = document.getElementById('groupUserSearch');
                        if (searchInput) {
                            searchInput.value = 'test';
                            console.log('   - Set search term to "test"');

                            // Trigger search
                            performGroupUserSearch();
                            console.log('   - Triggered group user search');
                        } else {
                            console.log('   ✗ Group search input not found');
                        }
                    }, 1000);
                };

                // Test function to verify the fixes
                window.testMessagingFixes = function() {
                    console.log('=== Testing Messaging Functionality Fixes ===');

                    console.log('1. Testing setActiveConversation function:');
                    console.log('   - Function available:', typeof window.setActiveConversation === 'function');

                    console.log('2. Testing sendMessage function:');
                    console.log('   - Function available:', typeof window.sendMessage === 'function');

                    console.log('3. Testing sendGroupMessage function:');
                    console.log('   - Function available:', typeof window.sendGroupMessage === 'function');

                    console.log('4. Testing conversation item clicks:');
                    const conversationItems = document.querySelectorAll('.conversation-item');
                    console.log('   - Found conversation items:', conversationItems.length);

                    if (conversationItems.length > 0) {
                        console.log('   - Testing setActiveConversation on first item...');
                        try {
                            setActiveConversation(conversationItems[0]);
                            console.log('   ✓ setActiveConversation worked without errors');
                        } catch (error) {
                            console.log('   ✗ setActiveConversation error:', error.message);
                        }
                    }

                    console.log('5. All functions should now be available globally for message sending');
                    console.log('   - Try clicking on conversations and sending messages');
                    console.log('   - Both direct messages and group messages should work without page refreshes');
                };

                // Quick debug function to check all global functions
                window.debugGlobalFunctions = function() {
                    console.log('=== Global Functions Debug ===');
                    const functions = [
                        'setActiveConversation',
                        'sendMessage',
                        'sendGroupMessage',
                        'toggleGroupChatInterface',
                        'createGroupChat',
                        'loadGroupConversation'
                    ];

                    functions.forEach(funcName => {
                        console.log(`${funcName}:`, typeof window[funcName] === 'function' ? '✓ Available' : '✗ Missing');
                    });
                };

                // Debug function to check avatar issues
                window.debugAvatarIssues = function() {
                    console.log('=== Debugging Avatar Issues ===');

                    // Check all images in conversation list
                    const conversationItems = document.querySelectorAll('.conversation-item');
                    console.log(`Found ${conversationItems.length} conversation items`);

                    conversationItems.forEach((item, index) => {
                        const avatar = item.querySelector('.avatar-sm');
                        if (avatar) {
                            console.log(`Conversation ${index + 1}:`);
                            console.log(`  - Tag: ${avatar.tagName}`);
                            if (avatar.tagName === 'IMG') {
                                console.log(`  - Src: ${avatar.src}`);
                                console.log(`  - Alt: ${avatar.alt}`);
                                console.log(`  - Complete: ${avatar.complete}`);
                                console.log(`  - Natural width: ${avatar.naturalWidth}`);
                                console.log(`  - Natural height: ${avatar.naturalHeight}`);
                            } else {
                                console.log(`  - Background: ${avatar.style.background}`);
                                console.log(`  - Inner HTML: ${avatar.innerHTML}`);
                            }
                        }
                    });

                    // Test default avatar accessibility
                    console.log('Testing default avatar accessibility...');
                    const testImg = new Image();
                    testImg.onload = function() {
                        console.log('✓ Default avatar loads successfully');
                        console.log(`  - Size: ${this.naturalWidth}x${this.naturalHeight}`);
                    };
                    testImg.onerror = function() {
                        console.log('✗ Default avatar failed to load');
                    };
                    testImg.src = '/static/images/default-avatar.png';

                    // Check message avatars if conversation is loaded
                    const messageAvatars = document.querySelectorAll('.message-avatar');
                    if (messageAvatars.length > 0) {
                        console.log(`Found ${messageAvatars.length} message avatars`);
                        messageAvatars.forEach((avatar, index) => {
                            console.log(`Message avatar ${index + 1}:`);
                            if (avatar.tagName === 'IMG') {
                                console.log(`  - Src: ${avatar.src}`);
                                console.log(`  - Complete: ${avatar.complete}`);
                                console.log(`  - Natural size: ${avatar.naturalWidth}x${avatar.naturalHeight}`);
                            }
                        });
                    }
                };

                // Test function to verify avatar updates
                window.testAvatarUpdates = function() {
                    console.log('=== Testing Avatar Updates ===');

                    console.log('1. Checking conversation list avatars:');
                    const conversationAvatars = document.querySelectorAll('.conversation-item .avatar-sm');
                    console.log(`   - Found ${conversationAvatars.length} conversation avatars`);

                    conversationAvatars.forEach((avatar, index) => {
                        if (avatar.tagName === 'IMG') {
                            console.log(`   - Avatar ${index + 1}: Using image src="${avatar.src}"`);
                            console.log(`     Has onerror handler: ${avatar.onerror ? 'Yes' : 'No'}`);
                        } else {
                            console.log(`   - Avatar ${index + 1}: Using div/icon (group chat)`);
                        }
                    });

                    console.log('2. Checking message avatars in conversation detail:');
                    const messageAvatars = document.querySelectorAll('.message-avatar');
                    console.log(`   - Found ${messageAvatars.length} message avatars`);

                    messageAvatars.forEach((avatar, index) => {
                        if (avatar.tagName === 'IMG') {
                            console.log(`   - Message avatar ${index + 1}: Using image src="${avatar.src}"`);
                            console.log(`     Has onerror handler: ${avatar.onerror ? 'Yes' : 'No'}`);
                        } else {
                            console.log(`   - Message avatar ${index + 1}: Using div/icon`);
                        }
                    });

                    console.log('3. Testing default avatar fallback:');
                    console.log('   - Default avatar path: /static/images/default-avatar.png');

                    // Test if default avatar is accessible
                    const testImg = new Image();
                    testImg.onload = function() {
                        console.log('   ✓ Default avatar image is accessible');
                    };
                    testImg.onerror = function() {
                        console.log('   ✗ Default avatar image is NOT accessible');
                    };
                    testImg.src = '/static/images/default-avatar.png';

                    console.log('4. Avatar update summary:');
                    console.log('   ✓ All templates updated to use actual profile pictures');
                    console.log('   ✓ Fallback to default avatar when no profile picture');
                    console.log('   ✓ onerror handlers added for broken image links');
                    console.log('   ✓ Consistent implementation across all avatar displays');
                };

                // Final test function to verify all avatar fixes
                window.testAvatarFixes = function() {
                    console.log('=== Testing Avatar System Fixes ===');

                    console.log('1. Testing API endpoint field names:');
                    fetch('/profile/api/search-connected-users/?q=test', {
                        method: 'GET',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('   - API Response:', data);
                        if (Array.isArray(data) && data.length > 0) {
                            const user = data[0];
                            console.log('   - Sample user fields:', Object.keys(user));
                            console.log('   - Has avatar_url:', 'avatar_url' in user);
                            console.log('   - Avatar URL:', user.avatar_url);
                        }
                    })
                    .catch(error => {
                        console.log('   - API Error:', error);
                    });

                    console.log('2. Testing conversation list avatars:');
                    const avatars = document.querySelectorAll('.conversation-item .avatar-sm');
                    console.log(`   - Found ${avatars.length} conversation avatars`);

                    avatars.forEach((avatar, index) => {
                        if (avatar.tagName === 'IMG') {
                            console.log(`   - Avatar ${index + 1}:`);
                            console.log(`     * Src: ${avatar.src}`);
                            console.log(`     * Complete: ${avatar.complete}`);
                            console.log(`     * Natural size: ${avatar.naturalWidth}x${avatar.naturalHeight}`);
                            console.log(`     * Has onerror: ${!!avatar.onerror}`);
                        }
                    });

                    console.log('3. Testing message avatars:');
                    const messageAvatars = document.querySelectorAll('.message-avatar');
                    console.log(`   - Found ${messageAvatars.length} message avatars`);

                    messageAvatars.forEach((avatar, index) => {
                        if (avatar.tagName === 'IMG') {
                            console.log(`   - Message avatar ${index + 1}:`);
                            console.log(`     * Src: ${avatar.src}`);
                            console.log(`     * Complete: ${avatar.complete}`);
                            console.log(`     * Natural size: ${avatar.naturalWidth}x${avatar.naturalHeight}`);
                        }
                    });

                    console.log('4. Summary of fixes applied:');
                    console.log('   ✓ Changed profile_picture to avatar in all templates');
                    console.log('   ✓ Added onerror handlers for broken images');
                    console.log('   ✓ Updated API endpoints to use correct field names');
                    console.log('   ✓ Consistent fallback to /static/images/default-avatar.png');
                    console.log('   ✓ Fixed both conversation list and message avatars');
                };

                // Function to generate initials from user data
                function generateInitials(user) {
                    if (user.first_name && user.last_name) {
                        return (user.first_name.charAt(0) + user.last_name.charAt(0)).toUpperCase();
                    } else if (user.full_name) {
                        const names = user.full_name.trim().split(' ');
                        if (names.length >= 2) {
                            return (names[0].charAt(0) + names[names.length - 1].charAt(0)).toUpperCase();
                        } else if (names.length === 1) {
                            return names[0].substring(0, 2).toUpperCase();
                        }
                    } else if (user.username) {
                        return user.username.substring(0, 2).toUpperCase();
                    }
                    return '?';
                }

                // Function to generate initials from group name
                function generateGroupInitials(groupName) {
                    if (!groupName || groupName.trim() === '') {
                        return 'GC'; // Default for Group Chat
                    }

                    const words = groupName.trim().split(/\s+/);
                    if (words.length >= 2) {
                        // Take first letter of first and last word
                        return (words[0].charAt(0) + words[words.length - 1].charAt(0)).toUpperCase();
                    } else if (words.length === 1) {
                        // Take first two letters of single word
                        return words[0].substring(0, 2).toUpperCase();
                    }

                    return 'GC';
                }

                // Function to create initials avatar HTML
                function createInitialsAvatar(user, cssClass = '', size = 40, fontSize = 16) {
                    const initials = generateInitials(user);
                    const gradients = [
                        'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                        'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                        'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                        'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                        'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                        'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
                        'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)',
                        'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)'
                    ];

                    // Use user ID to consistently pick a gradient
                    const gradientIndex = user.id ? user.id % gradients.length : 0;
                    const gradient = gradients[gradientIndex];

                    return `
                        <div class="${cssClass} d-flex align-items-center justify-content-center text-white fw-bold"
                             style="background: ${gradient}; font-size: ${fontSize}px; width: ${size}px; height: ${size}px;">
                            ${initials}
                        </div>
                    `;
                }

                // Function to create group initials avatar HTML
                function createGroupInitialsAvatar(groupName, groupId, cssClass = '', size = 40, fontSize = 16) {
                    const initials = generateGroupInitials(groupName);
                    const gradients = [
                        'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                        'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                        'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                        'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                        'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                        'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
                        'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)',
                        'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)'
                    ];

                    // Use group ID to consistently pick a gradient
                    const gradientIndex = groupId ? groupId % gradients.length : 0;
                    const gradient = gradients[gradientIndex];

                    return `
                        <div class="${cssClass} d-flex align-items-center justify-content-center text-white fw-bold"
                             style="background: ${gradient}; font-size: ${fontSize}px; width: ${size}px; height: ${size}px;">
                            ${initials}
                        </div>
                    `;
                }

                // Test function for initials avatar system
                window.testInitialsAvatars = function() {
                    console.log('=== Testing Initials Avatar System ===');

                    // Test user initials generation
                    const testUsers = [
                        { id: 1, first_name: 'Juna', last_name: 'Cruz', full_name: 'Juna Deal Cruz', username: 'juna.cruz' },
                        { id: 2, full_name: 'Maria Santos', username: 'maria.santos' },
                        { id: 3, username: 'john.doe' },
                        { id: 4, first_name: 'Ana', username: 'ana' },
                        { id: 5, full_name: 'Single', username: 'single' }
                    ];

                    console.log('1. Testing user initials generation:');
                    testUsers.forEach(user => {
                        const initials = generateInitials(user);
                        console.log(`   - ${user.full_name || user.username}: "${initials}"`);
                    });

                    // Test group initials generation
                    const testGroups = [
                        'Project Team',
                        'Study Group',
                        'Development',
                        'Marketing Team Alpha',
                        'Research',
                        '',
                        'Single'
                    ];

                    console.log('2. Testing group initials generation:');
                    testGroups.forEach(groupName => {
                        const initials = generateGroupInitials(groupName);
                        console.log(`   - "${groupName}": "${initials}"`);
                    });

                    console.log('3. Testing avatar HTML generation:');
                    testUsers.forEach(user => {
                        const avatarHtml = createInitialsAvatar(user, 'test-avatar', 40, 16);
                        console.log(`   - User ${user.id}: Generated avatar HTML`);
                    });

                    console.log('4. Checking existing avatars in conversation list:');
                    const conversationAvatars = document.querySelectorAll('.conversation-item .avatar-sm');
                    let initialsCount = 0;
                    let imageCount = 0;
                    let groupCount = 0;

                    conversationAvatars.forEach((avatar, index) => {
                        if (avatar.tagName === 'IMG') {
                            imageCount++;
                        } else if (avatar.tagName === 'DIV') {
                            if (avatar.classList.contains('group-avatar')) {
                                groupCount++;
                                console.log(`   - Group ${index + 1}: "${avatar.textContent.trim()}" (${avatar.getAttribute('data-group-name')})`);
                            } else {
                                initialsCount++;
                                console.log(`   - User ${index + 1}: Initials avatar "${avatar.textContent.trim()}"`);
                            }
                        }
                    });

                    console.log(`   - Found ${imageCount} image avatars, ${initialsCount} user initials, and ${groupCount} group initials`);

                    console.log('5. Testing user avatar initialization:');
                    initializeUserAvatars();
                    const userAvatars = document.querySelectorAll('.user-avatar');
                    console.log(`   - Found ${userAvatars.length} user avatars`);
                    userAvatars.forEach((avatar, index) => {
                        const userId = avatar.getAttribute('data-user-id');
                        const initials = avatar.textContent.trim();
                        console.log(`   - User avatar ${index + 1}: User ${userId} → "${initials}"`);
                    });

                    console.log('6. Testing group avatar initialization:');
                    initializeGroupAvatars();

                    console.log('7. Testing chat header avatar initialization:');
                    initializeChatHeaderAvatars();
                    const headerAvatars = document.querySelectorAll('.chat-header-avatar');
                    console.log(`   - Found ${headerAvatars.length} chat header avatars`);
                    headerAvatars.forEach((avatar, index) => {
                        const userId = avatar.getAttribute('data-user-id');
                        const initials = avatar.textContent.trim();
                        console.log(`   - Header avatar ${index + 1}: User ${userId} → "${initials}"`);
                    });

                    console.log('8. Summary of initials avatar features:');
                    console.log('   ✓ Dynamic initials generation from user names');
                    console.log('   ✓ Dynamic initials generation from group names');
                    console.log('   ✓ Fallback logic: first+last name → full name → username');
                    console.log('   ✓ Group fallback logic: first+last word → first two letters → "GC"');
                    console.log('   ✓ Colorful gradient backgrounds for visual appeal');
                    console.log('   ✓ Consistent colors based on user/group ID');
                    console.log('   ✓ Applied to all avatar displays in messaging system');
                    console.log('   ✓ User avatars in conversation list with dynamic gradients');
                    console.log('   ✓ Chat header avatars with dynamic gradients');
                    console.log('   ✓ Graceful fallback when profile pictures fail to load');
                };

                // Function to initialize group chat avatars
                function initializeGroupAvatars() {
                    console.log('Initializing group avatars...');
                    const groupAvatars = document.querySelectorAll('.group-avatar');
                    console.log(`Found ${groupAvatars.length} group avatars`);

                    groupAvatars.forEach(avatar => {
                        const groupName = avatar.getAttribute('data-group-name');
                        const groupId = parseInt(avatar.getAttribute('data-group-id'));

                        // Generate initials
                        const initials = generateGroupInitials(groupName);

                        // Select gradient based on group ID
                        const gradients = [
                            'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                            'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                            'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                            'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                            'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                            'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
                            'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)',
                            'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)'
                        ];

                        const gradientIndex = groupId % gradients.length;
                        const gradient = gradients[gradientIndex];

                        // Apply styling and content
                        avatar.style.background = gradient;
                        avatar.textContent = initials;

                        console.log(`Group avatar initialized: "${groupName}" → "${initials}" (ID: ${groupId})`);
                    });
                }

                // Function to initialize user avatars in conversation list
                function initializeUserAvatars() {
                    console.log('Initializing user avatars...');
                    const userAvatars = document.querySelectorAll('.user-avatar');
                    console.log(`Found ${userAvatars.length} user avatars`);

                    userAvatars.forEach((avatar, index) => {
                        const userId = parseInt(avatar.getAttribute('data-user-id'));
                        const firstName = avatar.getAttribute('data-first-name');
                        const lastName = avatar.getAttribute('data-last-name');
                        const username = avatar.getAttribute('data-username');

                        console.log(`Initializing user avatar ${index + 1}: User ${userId}, Name: ${firstName} ${lastName}`);

                        // Generate initials using the same logic
                        let initials = '?';
                        if (firstName && lastName) {
                            initials = (firstName.charAt(0) + lastName.charAt(0)).toUpperCase();
                        } else if (firstName) {
                            initials = firstName.substring(0, 2).toUpperCase();
                        } else if (username) {
                            initials = username.substring(0, 2).toUpperCase();
                        }

                        // Select gradient based on user ID
                        const gradients = [
                            'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                            'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                            'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                            'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                            'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                            'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
                            'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)',
                            'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)'
                        ];

                        const gradientIndex = userId % gradients.length;
                        const gradient = gradients[gradientIndex];

                        // Apply styling and content
                        avatar.style.background = gradient;
                        avatar.textContent = initials;

                        // Handle profile image fallback for message avatars
                        const profileImg = avatar.previousElementSibling;
                        if (profileImg && profileImg.tagName === 'IMG') {
                            // Set up proper error handling for profile image
                            profileImg.onerror = function() {
                                console.log(`Profile image failed for user ${userId}, showing initialized avatar`);
                                this.style.display = 'none';
                                avatar.style.display = 'flex';
                                avatar.classList.remove('d-none');
                                avatar.classList.add('d-flex');
                            };

                            // Check if image is already broken
                            if (profileImg.complete && profileImg.naturalWidth === 0) {
                                profileImg.onerror();
                            }
                        }

                        console.log(`User avatar initialized: User ${userId} → "${initials}" with gradient ${gradientIndex}`);
                    });
                }

                // Initialize all avatars when page loads
                document.addEventListener('DOMContentLoaded', function() {
                    console.log('DOM loaded, initializing all avatars...');
                    initializeAllAvatars();
                });

                // Also try to initialize immediately if DOM is already loaded
                if (document.readyState === 'loading') {
                    // DOM is still loading
                } else {
                    // DOM is already loaded
                    console.log('DOM already loaded, initializing all avatars immediately...');
                    setTimeout(function() {
                        initializeAllAvatars();
                    }, 100);
                }

                // Also initialize after any dynamic content updates
                window.initializeGroupAvatars = initializeGroupAvatars;
                window.initializeUserAvatars = initializeUserAvatars;

                // Function to initialize chat header avatars (handles both user and group avatars)
                function initializeChatHeaderAvatars() {
                    const headerAvatars = document.querySelectorAll('.chat-header-avatar');

                    headerAvatars.forEach(avatar => {
                        // Check if this is a group avatar or user avatar
                        const groupId = avatar.getAttribute('data-group-id');
                        const groupName = avatar.getAttribute('data-group-name');

                        if (groupId && groupName) {
                            // Handle group chat header avatar
                            console.log(`Initializing group chat header avatar: Group ${groupId} - "${groupName}"`);

                            let initials = 'GC';
                            if (groupName && groupName !== 'Group Chat') {
                                const words = groupName.trim().split(/\s+/);
                                if (words.length >= 2) {
                                    initials = (words[0].charAt(0) + words[words.length - 1].charAt(0)).toUpperCase();
                                } else if (words.length === 1) {
                                    initials = words[0].substring(0, 2).toUpperCase();
                                }
                            }

                            const gradients = [
                                'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                                'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                                'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                                'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                                'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
                                'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)',
                                'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)'
                            ];

                            const gradientIndex = parseInt(groupId) % gradients.length;
                            const gradient = gradients[gradientIndex];

                            avatar.style.background = gradient;
                            avatar.textContent = initials;

                            console.log(`Group chat header avatar initialized: Group ${groupId} → "${initials}" with gradient ${gradientIndex}`);

                        } else {
                            // Handle user chat header avatar
                            const userId = parseInt(avatar.getAttribute('data-user-id'));
                            const firstName = avatar.getAttribute('data-first-name');
                            const lastName = avatar.getAttribute('data-last-name');
                            const username = avatar.getAttribute('data-username');

                            // Generate initials using the same logic
                            let initials = '?';
                            if (firstName && lastName) {
                                initials = (firstName.charAt(0) + lastName.charAt(0)).toUpperCase();
                            } else if (firstName) {
                                initials = firstName.substring(0, 2).toUpperCase();
                            } else if (username) {
                                initials = username.substring(0, 2).toUpperCase();
                            }

                            // Select gradient based on user ID (same system as conversation list)
                            const gradients = [
                                'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                                'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                                'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                                'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                                'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
                                'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)',
                                'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)'
                            ];

                            const gradientIndex = userId % gradients.length;
                            const gradient = gradients[gradientIndex];

                            // Apply styling and content
                            avatar.style.background = gradient;
                            avatar.textContent = initials;

                            console.log(`User chat header avatar initialized: User ${userId} → "${initials}"`);
                        }
                    });
                }

                // Comprehensive HTMX integration for avatar persistence
                document.addEventListener('htmx:afterSwap', function(event) {
                    console.log('HTMX afterSwap event:', event.detail.target.id);

                    // Re-initialize avatars based on what was swapped
                    if (event.detail.target.id === 'conversation-detail') {
                        console.log('Conversation detail swapped - initializing chat header avatars');
                        initializeChatHeaderAvatars();
                    }

                    if (event.detail.target.id === 'conversationsList') {
                        console.log('Conversations list swapped - initializing all conversation avatars');
                        initializeUserAvatars();
                        initializeGroupAvatars();
                    }

                    // Always check for any avatar elements that might have been added
                    const newUserAvatars = event.detail.target.querySelectorAll('.user-avatar');
                    const newGroupAvatars = event.detail.target.querySelectorAll('.group-avatar');
                    const newChatHeaderAvatars = event.detail.target.querySelectorAll('.chat-header-avatar');

                    if (newUserAvatars.length > 0 || newGroupAvatars.length > 0 || newChatHeaderAvatars.length > 0) {
                        console.log(`Found new avatars after swap: ${newUserAvatars.length} user, ${newGroupAvatars.length} group, ${newChatHeaderAvatars.length} header`);
                        setTimeout(function() {
                            initializeAllAvatars();
                        }, 50);
                    }
                });

                // Handle HTMX before swap to preserve avatar state if needed
                document.addEventListener('htmx:beforeSwap', function(event) {
                    console.log('HTMX beforeSwap event:', event.detail.target.id);
                    // Could store avatar states here if needed for restoration
                });

                // Handle any other HTMX events that might affect avatars
                document.addEventListener('htmx:afterRequest', function(event) {
                    // Re-initialize avatars after any HTMX request completes
                    setTimeout(function() {
                        const userAvatars = document.querySelectorAll('.user-avatar');
                        const groupAvatars = document.querySelectorAll('.group-avatar');

                        // Only re-initialize if we find avatars without backgrounds
                        const uninitializedUserAvatars = Array.from(userAvatars).filter(a => !a.style.background);
                        const uninitializedGroupAvatars = Array.from(groupAvatars).filter(a => !a.style.background);

                        if (uninitializedUserAvatars.length > 0 || uninitializedGroupAvatars.length > 0) {
                            console.log(`Re-initializing ${uninitializedUserAvatars.length} user and ${uninitializedGroupAvatars.length} group avatars after HTMX request`);
                            initializeAllAvatars();
                        }
                    }, 100);
                });

                // Make function globally available
                window.initializeChatHeaderAvatars = initializeChatHeaderAvatars;

                // Master function to initialize all avatars
                function initializeAllAvatars() {
                    console.log('Initializing all avatar types...');
                    initializeUserAvatars();
                    initializeGroupAvatars();
                    initializeChatHeaderAvatars();
                }

                // Make master function globally available
                window.initializeAllAvatars = initializeAllAvatars;

                // Periodic avatar check to ensure persistence
                function checkAvatarPersistence() {
                    const userAvatars = document.querySelectorAll('.user-avatar');
                    const groupAvatars = document.querySelectorAll('.group-avatar');

                    const uninitializedUserAvatars = Array.from(userAvatars).filter(a => !a.style.background || a.style.background === '');
                    const uninitializedGroupAvatars = Array.from(groupAvatars).filter(a => !a.style.background || a.style.background === '');

                    if (uninitializedUserAvatars.length > 0 || uninitializedGroupAvatars.length > 0) {
                        console.log(`Found ${uninitializedUserAvatars.length} uninitialized user avatars and ${uninitializedGroupAvatars.length} uninitialized group avatars - re-initializing`);
                        initializeAllAvatars();
                    }
                }

                // Run periodic check every 2 seconds to ensure avatar persistence
                setInterval(checkAvatarPersistence, 2000);

                // Make persistence check available globally
                window.checkAvatarPersistence = checkAvatarPersistence;

                // Comprehensive debugging function for all avatar systems
                window.debugAllAvatars = function() {
                    console.log('=== COMPREHENSIVE AVATAR SYSTEM DEBUG ===');

                    console.log('1. Checking conversation list user avatars:');
                    const userAvatars = document.querySelectorAll('.user-avatar');
                    console.log(`   - Found ${userAvatars.length} user avatars`);
                    userAvatars.forEach((avatar, index) => {
                        console.log(`   - User Avatar ${index + 1}:`);
                        console.log(`     * User ID: ${avatar.getAttribute('data-user-id')}`);
                        console.log(`     * First Name: ${avatar.getAttribute('data-first-name')}`);
                        console.log(`     * Last Name: ${avatar.getAttribute('data-last-name')}`);
                        console.log(`     * Username: ${avatar.getAttribute('data-username')}`);
                        console.log(`     * Current Text: "${avatar.textContent.trim()}"`);
                        console.log(`     * Background: ${avatar.style.background}`);
                        console.log(`     * Classes: ${avatar.className}`);
                    });

                    console.log('2. Checking group chat avatars:');
                    const groupAvatars = document.querySelectorAll('.group-avatar');
                    console.log(`   - Found ${groupAvatars.length} group avatars`);
                    groupAvatars.forEach((avatar, index) => {
                        console.log(`   - Group Avatar ${index + 1}:`);
                        console.log(`     * Group ID: ${avatar.getAttribute('data-group-id')}`);
                        console.log(`     * Group Name: ${avatar.getAttribute('data-group-name')}`);
                        console.log(`     * Current Text: "${avatar.textContent.trim()}"`);
                        console.log(`     * Background: ${avatar.style.background}`);
                    });

                    console.log('3. Checking chat header avatars:');
                    const headerAvatars = document.querySelectorAll('.chat-header-avatar');
                    console.log(`   - Found ${headerAvatars.length} chat header avatars`);
                    headerAvatars.forEach((avatar, index) => {
                        console.log(`   - Header Avatar ${index + 1}:`);
                        console.log(`     * User ID: ${avatar.getAttribute('data-user-id')}`);
                        console.log(`     * Current Text: "${avatar.textContent.trim()}"`);
                        console.log(`     * Background: ${avatar.style.background}`);
                    });

                    console.log('4. Checking message avatars:');
                    const messageAvatars = document.querySelectorAll('.message-avatar');
                    console.log(`   - Found ${messageAvatars.length} message avatars`);

                    console.log('5. Running initialization functions:');
                    console.log('   - Initializing user avatars...');
                    initializeUserAvatars();
                    console.log('   - Initializing group avatars...');
                    initializeGroupAvatars();
                    console.log('   - Initializing chat header avatars...');
                    initializeChatHeaderAvatars();

                    console.log('6. Re-checking after initialization:');
                    const userAvatarsAfter = document.querySelectorAll('.user-avatar');
                    console.log(`   - User avatars with backgrounds: ${Array.from(userAvatarsAfter).filter(a => a.style.background).length}`);
                    const groupAvatarsAfter = document.querySelectorAll('.group-avatar');
                    console.log(`   - Group avatars with backgrounds: ${Array.from(groupAvatarsAfter).filter(a => a.style.background).length}`);

                    console.log('=== DEBUG COMPLETE ===');
                };

                // Simple test function to run manually
                window.testAvatarsNow = function() {
                    console.log('=== MANUAL AVATAR TEST ===');

                    // Check if elements exist
                    const userAvatars = document.querySelectorAll('.user-avatar');
                    const groupAvatars = document.querySelectorAll('.group-avatar');

                    console.log(`Found ${userAvatars.length} user avatars`);
                    console.log(`Found ${groupAvatars.length} group avatars`);

                    // Test user avatar initialization
                    userAvatars.forEach((avatar, index) => {
                        console.log(`User Avatar ${index + 1}:`);
                        console.log(`  - User ID: ${avatar.getAttribute('data-user-id')}`);
                        console.log(`  - First Name: ${avatar.getAttribute('data-first-name')}`);
                        console.log(`  - Last Name: ${avatar.getAttribute('data-last-name')}`);
                        console.log(`  - Current background: ${avatar.style.background}`);
                        console.log(`  - Current text: "${avatar.textContent}"`);

                        // Manually set avatar
                        const userId = parseInt(avatar.getAttribute('data-user-id')) || 1;
                        const firstName = avatar.getAttribute('data-first-name') || '';
                        const lastName = avatar.getAttribute('data-last-name') || '';
                        const username = avatar.getAttribute('data-username') || '';

                        let initials = '?';
                        if (firstName && lastName) {
                            initials = (firstName.charAt(0) + lastName.charAt(0)).toUpperCase();
                        } else if (firstName) {
                            initials = firstName.substring(0, 2).toUpperCase();
                        } else if (username) {
                            initials = username.substring(0, 2).toUpperCase();
                        }

                        const gradients = [
                            'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                            'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                            'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                            'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                            'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                            'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
                            'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)',
                            'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)'
                        ];

                        const gradientIndex = userId % gradients.length;
                        const gradient = gradients[gradientIndex];

                        avatar.style.background = gradient;
                        avatar.textContent = initials;

                        console.log(`  - Set to: "${initials}" with gradient ${gradientIndex}`);
                    });

                    // Test group avatar initialization
                    groupAvatars.forEach((avatar, index) => {
                        console.log(`Group Avatar ${index + 1}:`);
                        console.log(`  - Group ID: ${avatar.getAttribute('data-group-id')}`);
                        console.log(`  - Group Name: ${avatar.getAttribute('data-group-name')}`);

                        const groupName = avatar.getAttribute('data-group-name') || 'Group Chat';
                        const groupId = parseInt(avatar.getAttribute('data-group-id')) || 1;

                        let initials = 'GC';
                        if (groupName && groupName !== 'Group Chat') {
                            const words = groupName.trim().split(/\s+/);
                            if (words.length >= 2) {
                                initials = (words[0].charAt(0) + words[words.length - 1].charAt(0)).toUpperCase();
                            } else if (words.length === 1) {
                                initials = words[0].substring(0, 2).toUpperCase();
                            }
                        }

                        const gradients = [
                            'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                            'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                            'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                            'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                            'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                            'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
                            'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)',
                            'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)'
                        ];

                        const gradientIndex = groupId % gradients.length;
                        const gradient = gradients[gradientIndex];

                        avatar.style.background = gradient;
                        avatar.textContent = initials;

                        console.log(`  - Set to: "${initials}" with gradient ${gradientIndex}`);
                    });

                    console.log('=== MANUAL TEST COMPLETE ===');
                };

                // Function to create test avatar elements for demonstration
                window.createTestAvatars = function() {
                    console.log('=== CREATING TEST AVATARS ===');

                    const conversationsList = document.getElementById('conversationsList');
                    if (!conversationsList) {
                        console.log('❌ Conversations list not found');
                        return;
                    }

                    // Clear existing content
                    conversationsList.innerHTML = '';

                    // Create test user conversation
                    const userConversationHTML = `
                        <div class="conversation-item">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0 me-3">
                                    <div class="rounded-circle avatar-sm d-flex align-items-center justify-content-center text-white fw-bold user-avatar"
                                         data-user-id="1"
                                         data-first-name="John"
                                         data-last-name="Doe"
                                         data-username="john.doe"
                                         style="font-size: 20px;">
                                        <!-- Will be set by JavaScript -->
                                    </div>
                                </div>
                                <div class="flex-grow-1 min-w-0">
                                    <h6 class="conversation-name text-truncate mb-0">John Doe</h6>
                                    <p class="conversation-preview text-muted mb-0">Test conversation</p>
                                </div>
                            </div>
                        </div>
                    `;

                    // Create test group conversation
                    const groupConversationHTML = `
                        <div class="conversation-item">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0 me-3">
                                    <div class="rounded-circle avatar-sm d-flex align-items-center justify-content-center text-white fw-bold group-avatar"
                                         data-group-name="Project Team"
                                         data-group-id="1"
                                         style="font-size: 20px;">
                                        <!-- Will be set by JavaScript -->
                                    </div>
                                </div>
                                <div class="flex-grow-1 min-w-0">
                                    <h6 class="conversation-name text-truncate mb-0">Project Team</h6>
                                    <p class="conversation-preview text-muted mb-0">Group conversation</p>
                                </div>
                            </div>
                        </div>
                    `;

                    // Add both test conversations
                    conversationsList.innerHTML = userConversationHTML + groupConversationHTML;

                    console.log('✅ Test avatars created');

                    // Initialize the avatars
                    setTimeout(function() {
                        console.log('Initializing test avatars...');
                        initializeUserAvatars();
                        initializeGroupAvatars();
                    }, 100);
                };

                // Simple page status check
                window.checkPageStatus = function() {
                    console.log('=== PAGE STATUS CHECK ===');

                    // Check if conversations exist
                    const conversationsList = document.getElementById('conversationsList');
                    const noConversations = document.querySelector('.no-conversations');
                    const conversationItems = document.querySelectorAll('.conversation-item');

                    console.log('Conversations list element:', conversationsList ? 'Found' : 'Not found');
                    console.log('No conversations message:', noConversations ? 'Visible' : 'Hidden');
                    console.log('Number of conversation items:', conversationItems.length);

                    if (conversationItems.length === 0) {
                        console.log('❌ NO CONVERSATIONS FOUND - This is why avatars are not showing!');
                        console.log('💡 You need to create some conversations first to test the avatar system.');
                        console.log('💡 Try sending a message to a connected user or creating a group chat.');
                        console.log('💡 OR run createTestAvatars() to create test avatar elements for demonstration.');
                        return false;
                    }

                    // Check avatar elements
                    const userAvatars = document.querySelectorAll('.user-avatar');
                    const groupAvatars = document.querySelectorAll('.group-avatar');

                    console.log('User avatars found:', userAvatars.length);
                    console.log('Group avatars found:', groupAvatars.length);

                    if (userAvatars.length === 0 && groupAvatars.length === 0) {
                        console.log('❌ NO AVATAR ELEMENTS FOUND');
                        console.log('💡 Check if the template is rendering correctly');
                        return false;
                    }

                    console.log('✅ Page has conversations and avatar elements');
                    return true;
                };

                // Run page status check immediately
                setTimeout(function() {
                    console.log('Running automatic page status check...');
                    checkPageStatus();
                }, 500);

                // Test function for avatar persistence during messaging operations
                window.testAvatarPersistence = function() {
                    console.log('=== TESTING AVATAR PERSISTENCE ===');

                    // Create test avatars first
                    createTestAvatars();

                    setTimeout(function() {
                        console.log('1. Initial avatar state:');
                        const userAvatars = document.querySelectorAll('.user-avatar');
                        const groupAvatars = document.querySelectorAll('.group-avatar');

                        userAvatars.forEach((avatar, index) => {
                            console.log(`   User Avatar ${index + 1}: Background="${avatar.style.background}", Text="${avatar.textContent}"`);
                        });

                        groupAvatars.forEach((avatar, index) => {
                            console.log(`   Group Avatar ${index + 1}: Background="${avatar.style.background}", Text="${avatar.textContent}"`);
                        });

                        console.log('2. Testing conversation list refresh (simulates message sending):');

                        // Simulate what happens during message sending
                        if (window.refreshConversationsList) {
                            console.log('   - Calling refreshConversationsList()...');
                            refreshConversationsList();

                            setTimeout(function() {
                                console.log('3. Avatar state after refresh:');
                                const userAvatarsAfter = document.querySelectorAll('.user-avatar');
                                const groupAvatarsAfter = document.querySelectorAll('.group-avatar');

                                let persistenceSuccess = true;

                                userAvatarsAfter.forEach((avatar, index) => {
                                    const hasBackground = avatar.style.background && avatar.style.background !== '';
                                    const hasText = avatar.textContent && avatar.textContent.trim() !== '';
                                    console.log(`   User Avatar ${index + 1}: Background="${avatar.style.background}", Text="${avatar.textContent}" - ${hasBackground && hasText ? '✅ PERSISTENT' : '❌ LOST'}`);
                                    if (!hasBackground || !hasText) persistenceSuccess = false;
                                });

                                groupAvatarsAfter.forEach((avatar, index) => {
                                    const hasBackground = avatar.style.background && avatar.style.background !== '';
                                    const hasText = avatar.textContent && avatar.textContent.trim() !== '';
                                    console.log(`   Group Avatar ${index + 1}: Background="${avatar.style.background}", Text="${avatar.textContent}" - ${hasBackground && hasText ? '✅ PERSISTENT' : '❌ LOST'}`);
                                    if (!hasBackground || !hasText) persistenceSuccess = false;
                                });

                                console.log(`4. Overall persistence test: ${persistenceSuccess ? '✅ SUCCESS' : '❌ FAILED'}`);

                                if (!persistenceSuccess) {
                                    console.log('   - Running manual re-initialization...');
                                    initializeAllAvatars();
                                }

                            }, 1000);
                        } else {
                            console.log('   - refreshConversationsList function not found');
                        }

                    }, 500);
                };

                // Test function specifically for group chat header avatars
                window.testGroupChatHeader = function() {
                    console.log('=== TESTING GROUP CHAT HEADER AVATAR ===');

                    // Check if we're in a group conversation view
                    const chatContainer = document.querySelector('.chat-container');
                    if (!chatContainer) {
                        console.log('❌ No chat container found - not in a conversation view');
                        console.log('💡 Open a group conversation first to test the header avatar');
                        return;
                    }

                    // Look for group chat header avatar
                    const groupHeaderAvatar = document.querySelector('.chat-header-avatar.group-avatar');
                    if (!groupHeaderAvatar) {
                        console.log('❌ No group header avatar found');
                        console.log('💡 This might be a direct conversation, not a group chat');

                        // Check if there's any chat header avatar
                        const anyHeaderAvatar = document.querySelector('.chat-header-avatar');
                        if (anyHeaderAvatar) {
                            console.log('ℹ️ Found a chat header avatar, but it\'s not a group avatar');
                            console.log('   - Classes:', anyHeaderAvatar.className);
                            console.log('   - Data attributes:', {
                                userId: anyHeaderAvatar.getAttribute('data-user-id'),
                                groupId: anyHeaderAvatar.getAttribute('data-group-id'),
                                groupName: anyHeaderAvatar.getAttribute('data-group-name')
                            });
                        }
                        return;
                    }

                    console.log('✅ Found group chat header avatar');
                    console.log('   - Group ID:', groupHeaderAvatar.getAttribute('data-group-id'));
                    console.log('   - Group Name:', groupHeaderAvatar.getAttribute('data-group-name'));
                    console.log('   - Current Text:', `"${groupHeaderAvatar.textContent.trim()}"`);
                    console.log('   - Current Background:', groupHeaderAvatar.style.background);
                    console.log('   - Classes:', groupHeaderAvatar.className);

                    // Test initialization
                    console.log('🔧 Testing avatar initialization...');
                    initializeGroupAvatars();
                    initializeChatHeaderAvatars();

                    setTimeout(function() {
                        console.log('📊 After initialization:');
                        console.log('   - Text:', `"${groupHeaderAvatar.textContent.trim()}"`);
                        console.log('   - Background:', groupHeaderAvatar.style.background);

                        if (groupHeaderAvatar.style.background && groupHeaderAvatar.textContent.trim()) {
                            console.log('✅ Group chat header avatar is working!');
                        } else {
                            console.log('❌ Group chat header avatar initialization failed');

                            // Manual fix
                            const groupName = groupHeaderAvatar.getAttribute('data-group-name') || 'Group Chat';
                            const groupId = parseInt(groupHeaderAvatar.getAttribute('data-group-id')) || 1;

                            let initials = 'GC';
                            if (groupName && groupName !== 'Group Chat') {
                                const words = groupName.trim().split(/\s+/);
                                if (words.length >= 2) {
                                    initials = (words[0].charAt(0) + words[words.length - 1].charAt(0)).toUpperCase();
                                } else if (words.length === 1) {
                                    initials = words[0].substring(0, 2).toUpperCase();
                                }
                            }

                            const gradients = [
                                'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                                'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                                'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                                'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                                'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
                                'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)',
                                'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)'
                            ];

                            const gradientIndex = groupId % gradients.length;
                            const gradient = gradients[gradientIndex];

                            groupHeaderAvatar.style.background = gradient;
                            groupHeaderAvatar.textContent = initials;

                            console.log('🔧 Applied manual fix:');
                            console.log('   - Initials:', initials);
                            console.log('   - Gradient:', gradient);
                        }
                    }, 200);
                };

                // Function to create a test group conversation
                window.createTestGroupConversation = function() {
                    console.log('=== CREATING TEST GROUP CONVERSATION ===');
                    console.log('💡 This will simulate opening a group conversation to test the header avatar');

                    const conversationDetail = document.getElementById('conversation-detail');
                    if (!conversationDetail) {
                        console.log('❌ Conversation detail container not found');
                        return;
                    }

                    // Create test group conversation HTML
                    const testGroupHTML = `
                        <div class="chat-container h-100">
                            <!-- Chat Header -->
                            <div class="chat-header p-3">
                                <div class="d-flex align-items-center">
                                    <div class="me-3">
                                        <div class="rounded-circle d-flex align-items-center justify-content-center text-white fw-bold group-avatar chat-header-avatar"
                                             data-group-name="Test Project Team"
                                             data-group-id="1"
                                             style="width: 50px; height: 50px; border: 2px solid var(--ui-border); font-size: 18px;">
                                            <!-- Initials and gradient will be set by JavaScript -->
                                        </div>
                                    </div>

                                    <div class="flex-grow-1">
                                        <div class="chat-title">Test Project Team</div>
                                        <div class="chat-subtitle">
                                            3 participants • Created by Test User
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Messages Container -->
                            <div class="messages-container flex-grow-1" id="messagesContainer" style="max-height: 400px; overflow-y: auto;">
                                <div class="text-center text-muted p-4">
                                    <i class="fas fa-comments fa-2x mb-2"></i>
                                    <p>Test group conversation created!</p>
                                    <p>The header should show a colorful avatar with "TP" initials.</p>
                                </div>
                            </div>
                        </div>
                    `;

                    conversationDetail.innerHTML = testGroupHTML;

                    // Initialize the avatar
                    setTimeout(function() {
                        console.log('🔧 Initializing test group header avatar...');
                        initializeGroupAvatars();
                        initializeChatHeaderAvatars();

                        setTimeout(function() {
                            console.log('✅ Test group conversation created! Check the header for the avatar.');
                            testGroupChatHeader();
                        }, 200);
                    }, 100);
                };

                // Test function for conversation list interactivity after message sending
                window.testConversationListInteractivity = function() {
                    console.log('=== TESTING CONVERSATION LIST INTERACTIVITY ===');

                    const conversationItems = document.querySelectorAll('.conversation-item');
                    console.log(`Found ${conversationItems.length} conversation items`);

                    if (conversationItems.length === 0) {
                        console.log('❌ No conversation items found');
                        console.log('💡 Create some conversations first or run createTestAvatars()');
                        return;
                    }

                    // Test HTMX attributes
                    console.log('1. Checking HTMX attributes:');
                    conversationItems.forEach((item, index) => {
                        const hxGet = item.getAttribute('hx-get');
                        const onclick = item.getAttribute('onclick');
                        console.log(`   Conversation ${index + 1}:`);
                        console.log(`     - hx-get: ${hxGet ? '✅ Present' : '❌ Missing'}`);
                        console.log(`     - onclick: ${onclick ? '✅ Present' : '❌ Missing'}`);
                        console.log(`     - Classes: ${item.className}`);
                    });

                    // Test click functionality
                    console.log('2. Testing click functionality:');
                    if (conversationItems.length > 0) {
                        const firstItem = conversationItems[0];
                        console.log('   - Testing click on first conversation item...');

                        // Add a temporary click listener to test
                        const testClickHandler = function(e) {
                            console.log('   ✅ Click event fired successfully!');
                            console.log('   - Event target:', e.target);
                            console.log('   - HTMX will handle the request');
                            firstItem.removeEventListener('click', testClickHandler);
                        };

                        firstItem.addEventListener('click', testClickHandler);

                        // Simulate click
                        setTimeout(() => {
                            console.log('   - Simulating click...');
                            firstItem.click();
                        }, 100);
                    }

                    // Test HTMX processing
                    console.log('3. Testing HTMX processing:');
                    if (typeof htmx !== 'undefined') {
                        console.log('   ✅ HTMX is available');
                        console.log('   - Re-processing conversation list...');
                        const conversationsList = document.getElementById('conversationsList');
                        if (conversationsList) {
                            htmx.process(conversationsList);
                            console.log('   ✅ HTMX re-processing complete');
                        }
                    } else {
                        console.log('   ❌ HTMX not available');
                    }

                    console.log('4. Summary:');
                    console.log('   - If you see click events firing, conversation list is interactive');
                    console.log('   - If HTMX is available and processed, conversations should be clickable');
                    console.log('   - Test by clicking on different conversation items');
                };

                // Test function specifically for post-message-send interactivity
                window.testPostMessageInteractivity = function() {
                    console.log('=== TESTING POST-MESSAGE INTERACTIVITY ===');
                    console.log('This simulates what happens after sending a message');

                    // Simulate the refreshConversationsList process
                    console.log('1. Simulating conversation list refresh...');
                    if (window.refreshConversationsList) {
                        refreshConversationsList();

                        setTimeout(() => {
                            console.log('2. Testing interactivity after refresh...');
                            testConversationListInteractivity();
                        }, 1000);
                    } else {
                        console.log('❌ refreshConversationsList function not found');
                    }
                };

                // Test function for message avatar persistence after sending messages
                window.testMessageAvatarPersistence = function() {
                    console.log('=== TESTING MESSAGE AVATAR PERSISTENCE ===');

                    // Check if we're in a conversation view
                    const messagesContainer = document.getElementById('messagesContainer');
                    if (!messagesContainer) {
                        console.log('❌ No messages container found - not in a conversation view');
                        console.log('💡 Open a conversation first to test message avatars');
                        return;
                    }

                    // Find all message avatars
                    const messageAvatars = messagesContainer.querySelectorAll('.user-avatar');
                    console.log(`Found ${messageAvatars.length} message avatars`);

                    if (messageAvatars.length === 0) {
                        console.log('❌ No message avatars found');
                        console.log('💡 Send some messages first to test avatar persistence');
                        return;
                    }

                    // Check each message avatar
                    console.log('1. Checking current message avatar states:');
                    let uninitializedCount = 0;
                    let initializedCount = 0;

                    messageAvatars.forEach((avatar, index) => {
                        const userId = avatar.getAttribute('data-user-id');
                        const firstName = avatar.getAttribute('data-first-name');
                        const lastName = avatar.getAttribute('data-last-name');
                        const username = avatar.getAttribute('data-username');
                        const currentText = avatar.textContent.trim();
                        const currentBackground = avatar.style.background;

                        console.log(`   Message Avatar ${index + 1}:`);
                        console.log(`     - User ID: ${userId}`);
                        console.log(`     - Name: ${firstName} ${lastName} (${username})`);
                        console.log(`     - Current Text: "${currentText}"`);
                        console.log(`     - Has Background: ${currentBackground ? 'Yes' : 'No'}`);

                        if (currentText === '?' || !currentBackground) {
                            console.log(`     - Status: ❌ UNINITIALIZED`);
                            uninitializedCount++;
                        } else {
                            console.log(`     - Status: ✅ INITIALIZED`);
                            initializedCount++;
                        }
                    });

                    console.log(`2. Summary: ${initializedCount} initialized, ${uninitializedCount} uninitialized`);

                    // Test initialization
                    if (uninitializedCount > 0) {
                        console.log('3. Fixing uninitialized message avatars...');

                        messageAvatars.forEach(avatar => {
                            const userId = parseInt(avatar.getAttribute('data-user-id'));
                            const firstName = avatar.getAttribute('data-first-name');
                            const lastName = avatar.getAttribute('data-last-name');
                            const username = avatar.getAttribute('data-username');

                            if (avatar.textContent.trim() === '?' || !avatar.style.background) {
                                // Generate initials
                                let initials = '?';
                                if (firstName && lastName) {
                                    initials = (firstName.charAt(0) + lastName.charAt(0)).toUpperCase();
                                } else if (firstName) {
                                    initials = firstName.substring(0, 2).toUpperCase();
                                } else if (username) {
                                    initials = username.substring(0, 2).toUpperCase();
                                }

                                // Apply gradient
                                const gradients = [
                                    'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                    'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                                    'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                                    'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                                    'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                                    'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
                                    'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)',
                                    'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)'
                                ];

                                const gradientIndex = userId % gradients.length;
                                avatar.style.background = gradients[gradientIndex];
                                avatar.textContent = initials;

                                console.log(`   Fixed: User ${userId} → "${initials}"`);
                            }
                        });

                        console.log('✅ Message avatar initialization complete');
                    } else {
                        console.log('3. ✅ All message avatars are properly initialized');
                    }

                    // Test chat header avatar
                    console.log('4. Checking chat header avatar:');
                    const chatHeaderAvatar = document.querySelector('.chat-header-avatar');
                    if (chatHeaderAvatar) {
                        const headerText = chatHeaderAvatar.textContent.trim();
                        const headerBackground = chatHeaderAvatar.style.background;
                        console.log(`   - Header Avatar Text: "${headerText}"`);
                        console.log(`   - Header Avatar Background: ${headerBackground ? 'Present' : 'Missing'}`);

                        if (headerText === '?' || !headerBackground) {
                            console.log('   - Status: ❌ Chat header avatar needs initialization');
                            initializeChatHeaderAvatars();
                        } else {
                            console.log('   - Status: ✅ Chat header avatar is properly initialized');
                        }
                    } else {
                        console.log('   - No chat header avatar found');
                    }

                    console.log('=== MESSAGE AVATAR PERSISTENCE TEST COMPLETE ===');
                };

                // Function to initialize message avatars specifically
                window.initializeMessageAvatars = function() {
                    console.log('Initializing message avatars...');
                    const messagesContainer = document.getElementById('messagesContainer');
                    if (messagesContainer) {
                        const messageAvatars = messagesContainer.querySelectorAll('.user-avatar');
                        console.log(`Found ${messageAvatars.length} message avatars to initialize`);

                        messageAvatars.forEach(avatar => {
                            const userId = parseInt(avatar.getAttribute('data-user-id'));
                            const firstName = avatar.getAttribute('data-first-name');
                            const lastName = avatar.getAttribute('data-last-name');
                            const username = avatar.getAttribute('data-username');

                            // Generate initials
                            let initials = '?';
                            if (firstName && lastName) {
                                initials = (firstName.charAt(0) + lastName.charAt(0)).toUpperCase();
                            } else if (firstName) {
                                initials = firstName.substring(0, 2).toUpperCase();
                            } else if (username) {
                                initials = username.substring(0, 2).toUpperCase();
                            }

                            // Apply gradient
                            const gradients = [
                                'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                                'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                                'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                                'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                                'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
                                'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)',
                                'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)'
                            ];

                            const gradientIndex = userId % gradients.length;
                            avatar.style.background = gradients[gradientIndex];
                            avatar.textContent = initials;
                        });

                        console.log('Message avatars initialization complete');
                    }
                };

                // Debug function to test avatar initialization on the last message
                window.debugLastMessageAvatar = function() {
                    console.log('=== DEBUGGING LAST MESSAGE AVATAR ===');

                    const messagesContainer = document.getElementById('messagesContainer');
                    if (!messagesContainer) {
                        console.log('❌ No messages container found');
                        return;
                    }

                    const lastMessage = messagesContainer.querySelector('.message:last-child');
                    if (!lastMessage) {
                        console.log('❌ No messages found');
                        return;
                    }

                    console.log('Last message element:', lastMessage);

                    const avatars = lastMessage.querySelectorAll('.user-avatar');
                    console.log(`Found ${avatars.length} avatars in last message`);

                    const profileImages = lastMessage.querySelectorAll('img.message-avatar');
                    console.log(`Found ${profileImages.length} profile images in last message`);

                    avatars.forEach((avatar, index) => {
                        console.log(`\n--- Avatar ${index + 1} ---`);
                        console.log('Element:', avatar);
                        console.log('Classes:', avatar.className);
                        console.log('Display:', avatar.style.display);
                        console.log('Text content:', `"${avatar.textContent}"`);
                        console.log('Background:', avatar.style.background);

                        const userId = avatar.getAttribute('data-user-id');
                        const firstName = avatar.getAttribute('data-first-name');
                        const lastName = avatar.getAttribute('data-last-name');
                        const username = avatar.getAttribute('data-username');

                        console.log('Data attributes:');
                        console.log(`  - User ID: ${userId}`);
                        console.log(`  - First Name: ${firstName}`);
                        console.log(`  - Last Name: ${lastName}`);
                        console.log(`  - Username: ${username}`);

                        // Check for profile image
                        const profileImg = avatar.previousElementSibling;
                        if (profileImg && profileImg.tagName === 'IMG') {
                            console.log('Profile image:', profileImg);
                            console.log('Profile image src:', profileImg.src);
                            console.log('Profile image display:', profileImg.style.display);
                            console.log('Profile image complete:', profileImg.complete);
                            console.log('Profile image naturalWidth:', profileImg.naturalWidth);
                        } else {
                            console.log('No profile image found');
                        }
                    });

                    console.log('\n=== MANUAL AVATAR INITIALIZATION TEST ===');

                    // Try to initialize the avatars manually
                    avatars.forEach((avatar, index) => {
                        const userId = parseInt(avatar.getAttribute('data-user-id'));
                        const firstName = avatar.getAttribute('data-first-name');
                        const lastName = avatar.getAttribute('data-last-name');
                        const username = avatar.getAttribute('data-username');

                        // Generate initials
                        let initials = '?';
                        if (firstName && lastName) {
                            initials = (firstName.charAt(0) + lastName.charAt(0)).toUpperCase();
                        } else if (firstName) {
                            initials = firstName.substring(0, 2).toUpperCase();
                        } else if (username) {
                            initials = username.substring(0, 2).toUpperCase();
                        }

                        // Apply gradient
                        const gradients = [
                            'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                            'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                            'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                            'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                            'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                            'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
                            'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)',
                            'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)'
                        ];

                        const gradientIndex = userId % gradients.length;
                        avatar.style.background = gradients[gradientIndex];
                        avatar.textContent = initials;

                        // Make sure it's visible
                        avatar.style.display = 'flex';
                        avatar.classList.remove('d-none');
                        avatar.classList.add('d-flex');

                        console.log(`✅ Manually initialized avatar ${index + 1}: User ${userId} → "${initials}"`);
                    });
                };

                // Global group photo functions
                window.showGroupPhotoUpload = function(conversationId) {
                    console.log('Opening group photo upload modal for conversation:', conversationId);

                    // Function to ensure modal exists and is properly initialized
                    function ensureModalExists() {
                        let modal = document.getElementById('groupPhotoModal');

                        if (!modal) {
                            console.log('Modal not found, creating it dynamically...');

                            // Create modal HTML dynamically
                            const modalHTML = `
                                <div class="modal fade" id="groupPhotoModal" tabindex="-1" aria-labelledby="groupPhotoModalLabel" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="groupPhotoModalLabel">Set Group Photo</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <form id="groupPhotoForm" enctype="multipart/form-data">
                                                    <input type="hidden" name="csrfmiddlewaretoken" value="${document.querySelector('[name=csrfmiddlewaretoken]').value}">
                                                    <div class="mb-3">
                                                        <label for="groupPhotoInput" class="form-label">Choose Group Photo</label>
                                                        <input type="file" class="form-control" id="groupPhotoInput" name="group_photo" accept="image/*" required>
                                                        <div class="form-text">Upload a group photo (JPG, PNG, GIF). Max size: 5MB</div>
                                                    </div>
                                                    <div id="photoPreview" class="mb-3" style="display: none;">
                                                        <img id="previewImage" src="" alt="Preview" class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
                                                    </div>
                                                </form>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                <button type="button" class="btn btn-primary" id="uploadPhotoBtn">Upload Photo</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;

                            // Insert modal into DOM
                            document.body.insertAdjacentHTML('beforeend', modalHTML);
                            modal = document.getElementById('groupPhotoModal');

                            // Initialize modal functionality
                            initializeModalFunctionality();
                        }

                        return modal;
                    }

                    // Get or create modal
                    const modal = ensureModalExists();

                    if (!modal) {
                        console.error('Failed to create or find group photo modal');
                        alert('Unable to open group photo upload. Please refresh the page and try again.');
                        return;
                    }

                    // Store conversation ID for later use
                    modal.setAttribute('data-conversation-id', conversationId);

                    // Show the modal
                    const bootstrapModal = new bootstrap.Modal(modal);
                    bootstrapModal.show();
                };

                window.removeGroupPhoto = function(conversationId) {
                    console.log('Removing group photo for conversation:', conversationId);

                    if (!confirm('Are you sure you want to remove the group photo?')) {
                        return;
                    }

                    fetch(`/connections/group/${conversationId}/remove-photo/`, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Show success message
                            showToast(data.message || 'Group photo removed successfully!', 'success');

                            // Update UI to show fallback avatars
                            updateGroupAvatarsToFallback(conversationId);

                            // Refresh the conversation detail
                            setTimeout(() => {
                                refreshGroupConversationDetail(conversationId);
                            }, 500);
                        } else {
                            showToast('Error: ' + (data.message || 'Failed to remove group photo'), 'danger');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showToast('An error occurred while removing the group photo', 'danger');
                    });
                };

                // Function to immediately update group avatars with uploaded photo
                window.updateGroupAvatarsWithPhoto = function(conversationId, photoUrl) {
                    console.log('=== UPDATE GROUP AVATARS FUNCTION CALLED ===');
                    console.log(`Conversation ID: ${conversationId} (type: ${typeof conversationId})`);
                    console.log(`Photo URL: ${photoUrl}`);

                    // Update conversation list avatar
                    console.log('--- Searching for conversation list items ---');
                    const conversationItems = document.querySelectorAll('.conversation-item');
                    console.log(`Found ${conversationItems.length} conversation items`);

                    let foundConversationItem = false;
                    conversationItems.forEach((item, index) => {
                        console.log(`Checking conversation item ${index + 1}:`);

                        // Check if this is the right group conversation
                        const groupAvatar = item.querySelector('.group-avatar');
                        if (groupAvatar) {
                            const groupId = groupAvatar.getAttribute('data-group-id');
                            const groupName = groupAvatar.getAttribute('data-group-name');
                            console.log(`  - Group ID: ${groupId} (type: ${typeof groupId})`);
                            console.log(`  - Group Name: ${groupName}`);
                            console.log(`  - Match: ${groupId == conversationId}`);

                            if (groupId == conversationId) {
                                foundConversationItem = true;
                                console.log('✅ Found matching conversation list item to update');

                                // Check current state
                                console.log('Current avatar state:', {
                                    display: groupAvatar.style.display,
                                    classes: groupAvatar.className,
                                    visible: !groupAvatar.classList.contains('d-none')
                                });

                                // Create new image element
                                const newImg = document.createElement('img');
                                newImg.src = photoUrl;
                                newImg.alt = groupName || 'Group Chat';
                                newImg.className = 'rounded-circle avatar-sm';
                                newImg.style.cssText = 'width: 40px; height: 40px; object-fit: cover;';

                                console.log('Created new image element:', {
                                    src: newImg.src,
                                    className: newImg.className,
                                    style: newImg.style.cssText
                                });

                                // Set up error handling
                                newImg.onerror = function() {
                                    console.error('❌ Image failed to load, falling back to avatar');
                                    this.style.display = 'none';
                                    groupAvatar.style.display = 'flex';
                                    groupAvatar.classList.remove('d-none');
                                    groupAvatar.classList.add('d-flex');
                                };

                                newImg.onload = function() {
                                    console.log('✅ Image loaded successfully');
                                };

                                // Replace the avatar with the image
                                const avatarContainer = groupAvatar.parentElement;
                                console.log('Avatar container:', avatarContainer);

                                // Check if there's already an image
                                const existingImg = avatarContainer.querySelector('img');
                                if (existingImg) {
                                    console.log('Removing existing image');
                                    existingImg.remove();
                                }

                                avatarContainer.insertBefore(newImg, groupAvatar);
                                groupAvatar.style.display = 'none';
                                groupAvatar.classList.add('d-none');
                                groupAvatar.classList.remove('d-flex');

                                console.log('✅ Updated conversation list avatar');
                                console.log('New avatar state:', {
                                    display: groupAvatar.style.display,
                                    classes: groupAvatar.className,
                                    imageInserted: !!avatarContainer.querySelector('img')
                                });
                            }
                        } else {
                            console.log(`  - No group avatar found in item ${index + 1}`);
                        }
                    });

                    if (!foundConversationItem) {
                        console.error('❌ No matching conversation item found in list');
                    }

                    // Update chat header avatar using the new template structure
                    console.log('--- Updating chat header avatar with new structure ---');
                    const groupPhotoImg = document.getElementById(`group-photo-img-${conversationId}`);
                    const groupAvatarFallback = document.getElementById(`group-avatar-fallback-${conversationId}`);

                    console.log('Group photo img element:', !!groupPhotoImg);
                    console.log('Group avatar fallback element:', !!groupAvatarFallback);

                    if (groupPhotoImg && groupAvatarFallback) {
                        console.log('✅ Found chat header elements to update');

                        // Update the image source
                        groupPhotoImg.src = photoUrl;

                        // Set up error handling
                        groupPhotoImg.onerror = function() {
                            console.error('❌ Header image failed to load, showing fallback avatar');
                            this.style.display = 'none';
                            this.classList.add('d-none');
                            groupAvatarFallback.style.display = 'flex';
                            groupAvatarFallback.classList.remove('d-none');
                            groupAvatarFallback.classList.add('d-flex');
                        };

                        groupPhotoImg.onload = function() {
                            console.log('✅ Header image loaded successfully');
                            // Show the image and hide the fallback
                            this.style.display = 'block';
                            this.classList.remove('d-none');
                            groupAvatarFallback.style.display = 'none';
                            groupAvatarFallback.classList.add('d-none');
                            groupAvatarFallback.classList.remove('d-flex');
                        };

                        console.log('✅ Updated chat header avatar with new photo');
                    } else {
                        console.log('❌ Chat header elements not found with new structure');

                        // Let's see what chat header avatars exist
                        const allChatHeaders = document.querySelectorAll('.chat-header-avatar');
                        console.log(`Found ${allChatHeaders.length} chat header avatars total:`);
                        allChatHeaders.forEach((avatar, index) => {
                            console.log(`  ${index + 1}. Group ID: ${avatar.getAttribute('data-group-id')}, Name: ${avatar.getAttribute('data-group-name')}`);
                        });
                    }

                    console.log('=== GROUP AVATAR UPDATE COMPLETE ===');
                };

                // Global participants functionality
                window.showParticipants = function(conversationId) {
                    console.log('=== SHOW PARTICIPANTS CALLED ===');
                    console.log('Conversation ID:', conversationId);

                    // Check if Bootstrap is available
                    if (typeof bootstrap === 'undefined') {
                        console.error('Bootstrap is not loaded!');
                        alert('Bootstrap is not loaded. Please refresh the page and try again.');
                        return;
                    }

                    // Check if modal element exists (try multiple locations)
                    let modalElement = document.getElementById('participantsModal');
                    console.log('Modal element found in main page:', !!modalElement);

                    // If not found in main page, try looking in the conversation detail container
                    if (!modalElement) {
                        const conversationDetail = document.getElementById('conversation-detail');
                        if (conversationDetail) {
                            modalElement = conversationDetail.querySelector('#participantsModal');
                            console.log('Modal element found in conversation detail:', !!modalElement);
                        }
                    }

                    if (!modalElement) {
                        console.error('Participants modal element not found in DOM!');
                        console.log('Available modals:', document.querySelectorAll('[id*="modal"], [id*="Modal"]'));
                        alert('Modal not found. Please refresh the page and try again.');
                        return;
                    }

                    try {
                        // Initialize and show the modal with minimal options first
                        console.log('Initializing Bootstrap modal...');
                        let modal;

                        // Try different initialization approaches
                        try {
                            // First try: minimal options
                            modal = new bootstrap.Modal(modalElement);
                            console.log('Modal initialized with minimal options');
                        } catch (error) {
                            console.error('Error with minimal options:', error);
                            // Second try: no options at all
                            modal = new bootstrap.Modal(modalElement, {});
                            console.log('Modal initialized with empty options');
                        }

                        console.log('Modal initialized successfully, showing modal...');
                        modal.show();

                        // Load participants data
                        console.log('Fetching participants data...');
                        fetch(`/connections/group/${conversationId}/participants/`)
                            .then(response => {
                                console.log('Response received:', response.status);
                                return response.json();
                            })
                            .then(data => {
                                console.log('Data received:', data);
                                if (data.success) {
                                    renderParticipants(data.participants, data.current_user_is_creator, data.current_user_id, conversationId);
                                } else {
                                    showParticipantsError(data.error || 'Failed to load participants');
                                }
                            })
                            .catch(error => {
                                console.error('Error loading participants:', error);
                                showParticipantsError('Failed to load participants. Please try again.');
                            });

                    } catch (error) {
                        console.error('Error initializing modal:', error);
                        alert('Error opening participants modal: ' + error.message);
                    }
                };

                function renderParticipants(participants, currentUserIsCreator, currentUserId, conversationId) {
                    const container = document.getElementById('participantsContent');

                    if (!participants || participants.length === 0) {
                        container.innerHTML = `
                            <div class="text-center text-muted">
                                <i class="fas fa-users fa-2x mb-3"></i>
                                <p>No participants found</p>
                            </div>
                        `;
                        return;
                    }

                    const participantsHtml = participants.map(participant => `
                        <div class="participant-item">
                            <div class="participant-avatar-container">
                                ${participant.avatar ?
                                    `<img src="${participant.avatar}" alt="${participant.name}" class="participant-avatar"
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                     <div class="participant-avatar d-none align-items-center justify-content-center text-white fw-bold user-avatar"
                                          data-user-id="${participant.id}"
                                          data-first-name="${participant.first_name}"
                                          data-last-name="${participant.last_name}"
                                          data-username="${participant.username}"
                                          style="font-size: 14px; width: 40px; height: 40px;">
                                     </div>` :
                                    `<div class="participant-avatar d-flex align-items-center justify-content-center text-white fw-bold user-avatar"
                                          data-user-id="${participant.id}"
                                          data-first-name="${participant.first_name}"
                                          data-last-name="${participant.last_name}"
                                          data-username="${participant.username}"
                                          style="font-size: 14px; width: 40px; height: 40px;">
                                     </div>`
                                }
                            </div>
                            <div class="participant-info">
                                <div class="participant-name">${participant.name}</div>
                                <div class="participant-role">${participant.position || 'Alumni'}</div>
                            </div>
                            <div class="participant-actions">
                                <div class="participant-status ${participant.is_creator ? 'creator' : 'member'}">
                                    ${participant.is_creator ? 'Creator' : 'Member'}
                                </div>
                                ${currentUserIsCreator && !participant.is_creator && participant.id !== currentUserId ?
                                    `<button class="btn btn-sm btn-outline-danger ms-2 remove-participant-btn"
                                             onclick="removeParticipant(${conversationId}, ${participant.id}, '${participant.name}')"
                                             title="Remove ${participant.name} from group">
                                        <i class="fas fa-user-minus"></i>
                                     </button>` : ''
                                }
                            </div>
                        </div>
                    `).join('');

                    container.innerHTML = `
                        <div class="participants-list">
                            <div class="mb-3">
                                <small class="text-muted">${participants.length} participant${participants.length !== 1 ? 's' : ''}</small>
                            </div>
                            ${participantsHtml}
                        </div>
                    `;

                    // Initialize avatars for participants without profile photos
                    setTimeout(() => {
                        const avatars = container.querySelectorAll('.user-avatar');
                        avatars.forEach(avatar => {
                            if (window.initializeUserAvatar) {
                                window.initializeUserAvatar(avatar);
                            }
                        });
                    }, 100);
                }

                function showParticipantsError(message) {
                    const container = document.getElementById('participantsContent');
                    container.innerHTML = `
                        <div class="text-center text-danger">
                            <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                            <p>${message}</p>
                        </div>
                    `;
                }

                // Remove participant functionality
                window.removeParticipant = function(conversationId, participantId, participantName) {
                    console.log('=== REMOVE PARTICIPANT CALLED ===');
                    console.log('Conversation ID:', conversationId);
                    console.log('Participant ID:', participantId);
                    console.log('Participant Name:', participantName);

                    // Show confirmation dialog
                    if (!confirm(`Are you sure you want to remove ${participantName} from this group?`)) {
                        console.log('Removal cancelled by user');
                        return;
                    }

                    // Show loading state
                    const removeBtn = document.querySelector(`button[onclick*="removeParticipant(${conversationId}, ${participantId}"]`);
                    if (removeBtn) {
                        removeBtn.disabled = true;
                        removeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    }

                    // Get CSRF token
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                    // Send removal request
                    fetch(`/connections/group/${conversationId}/remove-participant/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': csrfToken,
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: `participant_id=${participantId}`
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Remove participant response:', data);

                        if (data.success) {
                            // Show success message
                            alert(data.message);

                            // Refresh the participants list
                            window.showParticipants(conversationId);

                            // Optionally refresh the conversation list to update participant count
                            if (window.loadConversations) {
                                window.loadConversations();
                            }
                        } else {
                            alert('Error: ' + (data.error || 'Failed to remove participant'));

                            // Restore button state
                            if (removeBtn) {
                                removeBtn.disabled = false;
                                removeBtn.innerHTML = '<i class="fas fa-user-minus"></i>';
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error removing participant:', error);
                        alert('Failed to remove participant. Please try again.');

                        // Restore button state
                        if (removeBtn) {
                            removeBtn.disabled = false;
                            removeBtn.innerHTML = '<i class="fas fa-user-minus"></i>';
                        }
                    });
                };

                // Add Members functionality - Global namespace
                window.AddMembersManager = window.AddMembersManager || {
                    selectedMembers: new Set(),
                    currentConversationId: null,

                    init: function() {
                        console.log('AddMembersManager initialized');
                    },

                    showModal: function(conversationId) {
                        console.log('=== SHOW ADD MEMBERS CALLED ===');
                        console.log('Conversation ID:', conversationId);

                        this.currentConversationId = conversationId;
                        this.selectedMembers.clear();

                        // Reset modal state
                        const memberSearchInput = document.getElementById('memberSearchInput');
                        const addSelectedMembersBtn = document.getElementById('addSelectedMembersBtn');

                        if (memberSearchInput) memberSearchInput.value = '';

                        const sections = ['searchResultsSection', 'selectedMembersSection', 'searchLoadingState', 'noResultsState'];
                        sections.forEach(sectionId => {
                            const section = document.getElementById(sectionId);
                            if (section) section.style.display = 'none';
                        });

                        if (addSelectedMembersBtn) addSelectedMembersBtn.disabled = true;

                        // Show the modal
                        const modalElement = document.getElementById('addMembersModal');
                        if (modalElement) {
                            const modal = new bootstrap.Modal(modalElement);
                            modal.show();

                            // Set up event listeners
                            this.setupEventListeners();
                        } else {
                            console.error('Add Members modal not found');
                        }
                    }
                };

                // Global function for backward compatibility
                window.showAddMembers = function(conversationId) {
                    window.AddMembersManager.showModal(conversationId);
                };

                // Add setupEventListeners to the AddMembersManager
                window.AddMembersManager.setupEventListeners = function() {
                    console.log('Setting up Add Members event listeners');

                    const searchInput = document.getElementById('memberSearchInput');
                    const searchBtn = document.getElementById('searchMembersBtn');
                    const selectAllBtn = document.getElementById('selectAllBtn');
                    const addSelectedBtn = document.getElementById('addSelectedMembersBtn');

                    console.log('Elements found:', {
                        searchInput: !!searchInput,
                        searchBtn: !!searchBtn,
                        selectAllBtn: !!selectAllBtn,
                        addSelectedBtn: !!addSelectedBtn
                    });

                    // Remove existing listeners to prevent duplicates
                    if (searchInput) {
                        searchInput.removeEventListener('keypress', this.handleSearchKeypress);
                        searchInput.addEventListener('keypress', this.handleSearchKeypress.bind(this));
                    }

                    if (searchBtn) {
                        searchBtn.removeEventListener('click', this.performMemberSearch);
                        searchBtn.addEventListener('click', this.performMemberSearch.bind(this));
                    }

                    if (selectAllBtn) {
                        selectAllBtn.removeEventListener('click', this.selectAllMembers);
                        selectAllBtn.addEventListener('click', this.selectAllMembers.bind(this));
                    }

                    if (addSelectedBtn) {
                        addSelectedBtn.removeEventListener('click', this.addSelectedMembers);
                        addSelectedBtn.addEventListener('click', this.addSelectedMembers.bind(this));
                        console.log('Add Selected Members button event listener attached');
                    } else {
                        console.error('Add Selected Members button not found!');
                    }
                };

                // Add handleSearchKeypress to the AddMembersManager
                window.AddMembersManager.handleSearchKeypress = function(event) {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        this.performMemberSearch();
                    }
                };

                // Add performMemberSearch to the AddMembersManager
                window.AddMembersManager.performMemberSearch = function() {
                    const query = document.getElementById('memberSearchInput').value.trim();

                    if (query.length < 2) {
                        alert('Please enter at least 2 characters to search');
                        return;
                    }

                    console.log('Searching for members:', query);

                    // Show loading state
                    const loadingState = document.getElementById('searchLoadingState');
                    const resultsSection = document.getElementById('searchResultsSection');
                    const noResultsState = document.getElementById('noResultsState');

                    if (loadingState) loadingState.style.display = 'block';
                    if (resultsSection) resultsSection.style.display = 'none';
                    if (noResultsState) noResultsState.style.display = 'none';

                    // Perform search
                    fetch(`/connections/group/${this.currentConversationId}/search-members/?q=${encodeURIComponent(query)}`)
                        .then(response => response.json())
                        .then(data => {
                            console.log('Search results:', data);

                            if (loadingState) loadingState.style.display = 'none';

                            if (data.success) {
                                if (data.users && data.users.length > 0) {
                                    this.renderSearchResults(data.users);
                                } else {
                                    if (noResultsState) noResultsState.style.display = 'block';
                                }
                            } else {
                                alert('Error: ' + (data.error || 'Failed to search for members'));
                            }
                        })
                        .catch(error => {
                            console.error('Error searching for members:', error);
                            if (loadingState) loadingState.style.display = 'none';
                            alert('Failed to search for members. Please try again.');
                        });
                };

                function renderSearchResults(users) {
                    const container = document.getElementById('searchResults');

                    const resultsHtml = users.map(user => `
                        <div class="search-result-item" data-user-id="${user.id}" onclick="toggleMemberSelection(${user.id})">
                            <input type="checkbox" class="form-check-input search-result-checkbox"
                                   id="user_${user.id}" onchange="toggleMemberSelection(${user.id})">
                            <div class="search-result-avatar-container">
                                ${user.avatar ?
                                    `<img src="${user.avatar}" alt="${user.name}" class="search-result-avatar"
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                     <div class="search-result-avatar d-none align-items-center justify-content-center text-white fw-bold user-avatar"
                                          data-user-id="${user.id}"
                                          data-first-name="${user.first_name}"
                                          data-last-name="${user.last_name}"
                                          data-username="${user.username}"
                                          style="font-size: 14px; width: 40px; height: 40px;">
                                     </div>` :
                                    `<div class="search-result-avatar d-flex align-items-center justify-content-center text-white fw-bold user-avatar"
                                          data-user-id="${user.id}"
                                          data-first-name="${user.first_name}"
                                          data-last-name="${user.last_name}"
                                          data-username="${user.username}"
                                          style="font-size: 14px; width: 40px; height: 40px;">
                                     </div>`
                                }
                            </div>
                            <div class="search-result-info">
                                <div class="search-result-name">${user.name}</div>
                                <div class="search-result-details">
                                    @${user.username}${user.position ? ` • ${user.position}` : ''}${user.graduation_year ? ` • Class of ${user.graduation_year}` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('');

                    container.innerHTML = resultsHtml;
                    document.getElementById('searchResultsSection').style.display = 'block';

                    // Initialize avatars for users without profile photos
                    setTimeout(() => {
                        const avatars = container.querySelectorAll('.user-avatar');
                        avatars.forEach(avatar => {
                            if (window.initializeUserAvatar) {
                                window.initializeUserAvatar(avatar);
                            }
                        });
                    }, 100);
                }

                window.toggleMemberSelection = function(userId) {
                    const checkbox = document.getElementById(`user_${userId}`);
                    const resultItem = document.querySelector(`[data-user-id="${userId}"]`);

                    if (selectedMembers.has(userId)) {
                        selectedMembers.delete(userId);
                        checkbox.checked = false;
                        resultItem.classList.remove('selected');
                    } else {
                        selectedMembers.add(userId);
                        checkbox.checked = true;
                        resultItem.classList.add('selected');
                    }

                    updateSelectedMembersDisplay();
                    updateAddButton();
                };

                function selectAllMembers() {
                    const checkboxes = document.querySelectorAll('.search-result-checkbox');
                    const allSelected = Array.from(checkboxes).every(cb => cb.checked);

                    checkboxes.forEach(checkbox => {
                        const userId = parseInt(checkbox.id.replace('user_', ''));
                        const resultItem = document.querySelector(`[data-user-id="${userId}"]`);

                        if (allSelected) {
                            selectedMembers.delete(userId);
                            checkbox.checked = false;
                            resultItem.classList.remove('selected');
                        } else {
                            selectedMembers.add(userId);
                            checkbox.checked = true;
                            resultItem.classList.add('selected');
                        }
                    });

                    updateSelectedMembersDisplay();
                    updateAddButton();

                    // Update button text
                    const selectAllBtn = document.getElementById('selectAllBtn');
                    selectAllBtn.textContent = allSelected ? 'Select All' : 'Deselect All';
                }

                function updateSelectedMembersDisplay() {
                    const container = document.getElementById('selectedMembers');
                    const countElement = document.getElementById('selectedCount');
                    const section = document.getElementById('selectedMembersSection');

                    countElement.textContent = selectedMembers.size;

                    if (selectedMembers.size === 0) {
                        section.style.display = 'none';
                        return;
                    }

                    section.style.display = 'block';

                    const selectedHtml = Array.from(selectedMembers).map(userId => {
                        const resultItem = document.querySelector(`[data-user-id="${userId}"]`);
                        const nameElement = resultItem.querySelector('.search-result-name');
                        const name = nameElement.textContent;

                        return `
                            <span class="selected-member-tag">
                                ${name}
                                <span class="selected-member-remove" onclick="toggleMemberSelection(${userId})">
                                    <i class="fas fa-times"></i>
                                </span>
                            </span>
                        `;
                    }).join('');

                    container.innerHTML = selectedHtml;
                }

                function updateAddButton() {
                    const addBtn = document.getElementById('addSelectedMembersBtn');
                    addBtn.disabled = selectedMembers.size === 0;

                    if (selectedMembers.size > 0) {
                        addBtn.innerHTML = `<i class="fas fa-user-plus me-1"></i>Add ${selectedMembers.size} Member${selectedMembers.size > 1 ? 's' : ''}`;
                    } else {
                        addBtn.innerHTML = `<i class="fas fa-user-plus me-1"></i>Add Selected Members`;
                    }
                }

                // Add addSelectedMembers to the AddMembersManager
                window.AddMembersManager.addSelectedMembers = function() {
                    console.log('=== ADD SELECTED MEMBERS CLICKED ===');
                    console.log('Selected members size:', this.selectedMembers.size);
                    console.log('Selected member IDs:', Array.from(this.selectedMembers));

                    if (this.selectedMembers.size === 0) {
                        console.log('No members selected, returning');
                        return;
                    }

                    console.log('=== ADDING SELECTED MEMBERS ===');
                    console.log('Conversation ID:', this.currentConversationId);

                    // Show loading state
                    const addBtn = document.getElementById('addSelectedMembersBtn');
                    if (!addBtn) {
                        console.error('Add button not found!');
                        return;
                    }

                    const originalText = addBtn.innerHTML;
                    addBtn.disabled = true;
                    addBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Adding Members...';

                    // Get CSRF token
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                    if (!csrfToken) {
                        console.error('CSRF token not found!');
                        alert('Security token not found. Please refresh the page and try again.');
                        addBtn.disabled = false;
                        addBtn.innerHTML = originalText;
                        return;
                    }

                    // Prepare form data
                    const formData = new FormData();
                    Array.from(this.selectedMembers).forEach(userId => {
                        formData.append('user_ids', userId);
                    });

                    // Send add members request
                    fetch(`/connections/group/${this.currentConversationId}/add-members/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrfToken,
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Add members response:', data);

                        if (data.success) {
                            // Show success message
                            alert(data.message);

                            // Close the modal
                            const modalElement = document.getElementById('addMembersModal');
                            if (modalElement) {
                                const modal = bootstrap.Modal.getInstance(modalElement);
                                if (modal) modal.hide();
                            }

                            // Refresh the participants list if it's open
                            const participantsModal = document.getElementById('participantsModal');
                            if (participantsModal && participantsModal.classList.contains('show')) {
                                if (window.showParticipants) {
                                    window.showParticipants(this.currentConversationId);
                                }
                            }

                            // Optionally refresh the conversation list to update participant count
                            if (window.loadConversations) {
                                window.loadConversations();
                            }
                        } else {
                            alert('Error: ' + (data.error || 'Failed to add members'));

                            // Restore button state
                            addBtn.disabled = false;
                            addBtn.innerHTML = originalText;
                        }
                    })
                    .catch(error => {
                        console.error('Error adding members:', error);
                        alert('Failed to add members. Please try again.');

                        // Restore button state
                        addBtn.disabled = false;
                        addBtn.innerHTML = originalText;
                    });
                };

                // Add renderSearchResults to the AddMembersManager
                window.AddMembersManager.renderSearchResults = function(users) {
                    const container = document.getElementById('searchResults');
                    if (!container) {
                        console.error('Search results container not found');
                        return;
                    }

                    const resultsHtml = users.map(user => `
                        <div class="search-result-item" data-user-id="${user.id}" onclick="window.AddMembersManager.toggleMemberSelection(${user.id})">
                            <input type="checkbox" class="form-check-input search-result-checkbox"
                                   id="user_${user.id}" onchange="window.AddMembersManager.toggleMemberSelection(${user.id})">
                            <div class="search-result-avatar-container">
                                ${user.avatar ?
                                    `<img src="${user.avatar}" alt="${user.name}" class="search-result-avatar"
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                     <div class="search-result-avatar d-none align-items-center justify-content-center text-white fw-bold user-avatar"
                                          data-user-id="${user.id}"
                                          data-first-name="${user.first_name}"
                                          data-last-name="${user.last_name}"
                                          data-username="${user.username}"
                                          style="font-size: 14px; width: 40px; height: 40px;">
                                     </div>` :
                                    `<div class="search-result-avatar d-flex align-items-center justify-content-center text-white fw-bold user-avatar"
                                          data-user-id="${user.id}"
                                          data-first-name="${user.first_name}"
                                          data-last-name="${user.last_name}"
                                          data-username="${user.username}"
                                          style="font-size: 14px; width: 40px; height: 40px;">
                                     </div>`
                                }
                            </div>
                            <div class="search-result-info">
                                <div class="search-result-name">${user.name}</div>
                                <div class="search-result-details">
                                    @${user.username}${user.position ? ` • ${user.position}` : ''}${user.graduation_year ? ` • Class of ${user.graduation_year}` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('');

                    container.innerHTML = resultsHtml;
                    const resultsSection = document.getElementById('searchResultsSection');
                    if (resultsSection) resultsSection.style.display = 'block';

                    // Initialize avatars for users without profile photos
                    setTimeout(() => {
                        const avatars = container.querySelectorAll('.user-avatar');
                        avatars.forEach(avatar => {
                            if (window.initializeUserAvatar) {
                                window.initializeUserAvatar(avatar);
                            }
                        });
                    }, 100);
                };

                // Add toggleMemberSelection to the AddMembersManager
                window.AddMembersManager.toggleMemberSelection = function(userId) {
                    console.log('Toggle member selection:', userId);

                    const checkbox = document.getElementById(`user_${userId}`);
                    const resultItem = document.querySelector(`[data-user-id="${userId}"]`);

                    if (!checkbox || !resultItem) {
                        console.error('Checkbox or result item not found for user:', userId);
                        return;
                    }

                    if (this.selectedMembers.has(userId)) {
                        this.selectedMembers.delete(userId);
                        checkbox.checked = false;
                        resultItem.classList.remove('selected');
                    } else {
                        this.selectedMembers.add(userId);
                        checkbox.checked = true;
                        resultItem.classList.add('selected');
                    }

                    this.updateSelectedMembersDisplay();
                    this.updateAddButton();
                };

                // Add updateAddButton to the AddMembersManager
                window.AddMembersManager.updateAddButton = function() {
                    const addBtn = document.getElementById('addSelectedMembersBtn');
                    if (!addBtn) {
                        console.error('Add button not found in updateAddButton');
                        return;
                    }

                    console.log('Updating add button, selected count:', this.selectedMembers.size);
                    addBtn.disabled = this.selectedMembers.size === 0;

                    if (this.selectedMembers.size > 0) {
                        addBtn.innerHTML = `<i class="fas fa-user-plus me-1"></i>Add ${this.selectedMembers.size} Member${this.selectedMembers.size > 1 ? 's' : ''}`;
                    } else {
                        addBtn.innerHTML = `<i class="fas fa-user-plus me-1"></i>Add Selected Members`;
                    }
                };

                // Add updateSelectedMembersDisplay to the AddMembersManager
                window.AddMembersManager.updateSelectedMembersDisplay = function() {
                    const container = document.getElementById('selectedMembers');
                    const countElement = document.getElementById('selectedCount');
                    const section = document.getElementById('selectedMembersSection');

                    if (countElement) countElement.textContent = this.selectedMembers.size;

                    if (this.selectedMembers.size === 0) {
                        if (section) section.style.display = 'none';
                        return;
                    }

                    if (section) section.style.display = 'block';

                    if (container) {
                        const selectedHtml = Array.from(this.selectedMembers).map(userId => {
                            const resultItem = document.querySelector(`[data-user-id="${userId}"]`);
                            const nameElement = resultItem ? resultItem.querySelector('.search-result-name') : null;
                            const name = nameElement ? nameElement.textContent : `User ${userId}`;

                            return `
                                <span class="selected-member-tag">
                                    ${name}
                                    <span class="selected-member-remove" onclick="window.AddMembersManager.toggleMemberSelection(${userId})">
                                        <i class="fas fa-times"></i>
                                    </span>
                                </span>
                            `;
                        }).join('');

                        container.innerHTML = selectedHtml;
                    }
                };

                // Add selectAllMembers to the AddMembersManager
                window.AddMembersManager.selectAllMembers = function() {
                    const checkboxes = document.querySelectorAll('.search-result-checkbox');
                    const allSelected = Array.from(checkboxes).every(cb => cb.checked);

                    checkboxes.forEach(checkbox => {
                        const userId = parseInt(checkbox.id.replace('user_', ''));
                        const resultItem = document.querySelector(`[data-user-id="${userId}"]`);

                        if (allSelected) {
                            this.selectedMembers.delete(userId);
                            checkbox.checked = false;
                            if (resultItem) resultItem.classList.remove('selected');
                        } else {
                            this.selectedMembers.add(userId);
                            checkbox.checked = true;
                            if (resultItem) resultItem.classList.add('selected');
                        }
                    });

                    this.updateSelectedMembersDisplay();
                    this.updateAddButton();

                    // Update button text
                    const selectAllBtn = document.getElementById('selectAllBtn');
                    if (selectAllBtn) {
                        selectAllBtn.textContent = allSelected ? 'Select All' : 'Deselect All';
                    }
                };

                // Initialize the AddMembersManager
                window.AddMembersManager.init();

                // Debug function for Add Members functionality
                window.debugAddMembers = function() {
                    console.log('=== ADD MEMBERS DEBUG ===');

                    // Check if AddMembersManager exists
                    console.log('AddMembersManager exists:', !!window.AddMembersManager);

                    // Check modal elements
                    const modal = document.getElementById('addMembersModal');
                    const button = document.getElementById('addSelectedMembersBtn');
                    const searchInput = document.getElementById('memberSearchInput');

                    console.log('Modal elements:', {
                        modal: !!modal,
                        button: !!button,
                        searchInput: !!searchInput
                    });

                    if (button) {
                        console.log('Button details:', {
                            disabled: button.disabled,
                            innerHTML: button.innerHTML,
                            onclick: button.onclick,
                            eventListeners: getEventListeners ? getEventListeners(button) : 'getEventListeners not available'
                        });
                    }

                    // Check AddMembersManager state
                    if (window.AddMembersManager) {
                        console.log('AddMembersManager state:', {
                            selectedMembers: window.AddMembersManager.selectedMembers.size,
                            currentConversationId: window.AddMembersManager.currentConversationId,
                            hasAddFunction: typeof window.AddMembersManager.addSelectedMembers === 'function'
                        });
                    }

                    // Test button click manually
                    if (button && !button.disabled) {
                        console.log('Testing manual button click...');
                        try {
                            window.AddMembersManager.addSelectedMembers();
                        } catch (error) {
                            console.error('Error in manual button click:', error);
                        }
                    }
                };

                // Debug function for participants modal
                window.debugParticipantsModal = function() {
                    console.log('=== PARTICIPANTS MODAL DEBUG ===');

                    // Check Bootstrap
                    console.log('Bootstrap available:', typeof bootstrap !== 'undefined');
                    if (typeof bootstrap !== 'undefined') {
                        console.log('Bootstrap version:', bootstrap.Modal ? 'Modal class available' : 'Modal class missing');
                    }

                    // Check modal element in multiple locations
                    const modalElement = document.getElementById('participantsModal');
                    console.log('Modal element exists in main page:', !!modalElement);

                    const conversationDetail = document.getElementById('conversation-detail');
                    const modalInDetail = conversationDetail ? conversationDetail.querySelector('#participantsModal') : null;
                    console.log('Modal element exists in conversation detail:', !!modalInDetail);

                    const activeModal = modalElement || modalInDetail;
                    if (activeModal) {
                        console.log('Active modal element details:');
                        console.log('  - ID:', activeModal.id);
                        console.log('  - Classes:', activeModal.className);
                        console.log('  - Has modal-dialog:', !!activeModal.querySelector('.modal-dialog'));
                        console.log('  - Has modal-content:', !!activeModal.querySelector('.modal-content'));
                        console.log('  - Has participantsContent:', !!document.getElementById('participantsContent'));

                        // Try to create modal instance
                        try {
                            const testModal = new bootstrap.Modal(activeModal);
                            console.log('  - Modal instance created successfully');
                            console.log('  - Modal instance:', testModal);
                        } catch (error) {
                            console.error('  - Error creating modal instance:', error);
                        }
                    }

                    // Check for duplicate modals
                    const allModals = document.querySelectorAll('#participantsModal');
                    console.log('Number of participantsModal elements:', allModals.length);

                    // Check global functions
                    console.log('showParticipants function available:', typeof window.showParticipants === 'function');
                    console.log('renderParticipants function available:', typeof renderParticipants === 'function');
                    console.log('showParticipantsError function available:', typeof showParticipantsError === 'function');
                };

                // Simple test function to verify modal works
                window.testParticipantsModal = function() {
                    console.log('=== TESTING PARTICIPANTS MODAL ===');

                    let modalElement = document.getElementById('participantsModal');

                    // If not found in main page, try conversation detail
                    if (!modalElement) {
                        const conversationDetail = document.getElementById('conversation-detail');
                        if (conversationDetail) {
                            modalElement = conversationDetail.querySelector('#participantsModal');
                        }
                    }

                    if (!modalElement) {
                        console.error('Modal element not found in either location!');
                        return;
                    }

                    try {
                        // Try the simplest possible modal initialization
                        const modal = new bootstrap.Modal(modalElement);
                        console.log('Modal created successfully');

                        // Try to show it
                        modal.show();
                        console.log('Modal show() called successfully');

                        // Hide it after 2 seconds
                        setTimeout(() => {
                            modal.hide();
                            console.log('Modal hidden successfully');
                        }, 2000);

                    } catch (error) {
                        console.error('Error in modal test:', error);
                        console.error('Error stack:', error.stack);
                    }
                };

                // Function to initialize modal functionality (can be called multiple times)
                function initializeModalFunctionality() {
                    const photoInput = document.getElementById('groupPhotoInput');
                    const previewDiv = document.getElementById('photoPreview');
                    const previewImage = document.getElementById('previewImage');
                    const uploadBtn = document.getElementById('uploadPhotoBtn');

                    console.log('Initializing modal functionality...', {
                        photoInput: !!photoInput,
                        previewDiv: !!previewDiv,
                        previewImage: !!previewImage,
                        uploadBtn: !!uploadBtn
                    });

                    // Photo preview functionality
                    if (photoInput && !photoInput.hasAttribute('data-listener-attached')) {
                        photoInput.setAttribute('data-listener-attached', 'true');
                        photoInput.addEventListener('change', function(e) {
                            const file = e.target.files[0];
                            if (file) {
                                // Validate file size (5MB max)
                                if (file.size > 5 * 1024 * 1024) {
                                    alert('File size cannot exceed 5MB');
                                    this.value = '';
                                    previewDiv.style.display = 'none';
                                    return;
                                }

                                // Validate file type
                                if (!file.type.startsWith('image/')) {
                                    alert('Please select an image file');
                                    this.value = '';
                                    previewDiv.style.display = 'none';
                                    return;
                                }

                                // Show preview
                                const reader = new FileReader();
                                reader.onload = function(e) {
                                    previewImage.src = e.target.result;
                                    previewDiv.style.display = 'block';
                                };
                                reader.readAsDataURL(file);
                            } else {
                                previewDiv.style.display = 'none';
                            }
                        });
                    }

                    // Upload button functionality
                    if (uploadBtn && !uploadBtn.hasAttribute('data-listener-attached')) {
                        uploadBtn.setAttribute('data-listener-attached', 'true');
                        uploadBtn.addEventListener('click', function() {
                            const modal = document.getElementById('groupPhotoModal');
                            const conversationId = modal.getAttribute('data-conversation-id');
                            const fileInput = document.getElementById('groupPhotoInput');
                            const file = fileInput.files[0];

                            if (!file) {
                                alert('Please select a photo to upload');
                                return;
                            }

                            // Check DOM state before upload
                            console.log('=== STARTING UPLOAD PROCESS ===');
                            const domState = checkDOMBeforeUpload(conversationId);
                            console.log('DOM state before upload:', domState);

                            // Disable button and show loading
                            uploadBtn.disabled = true;
                            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';

                            // Create form data
                            const formData = new FormData();
                            formData.append('group_photo', file);

                            let csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
                            if (!csrfToken) {
                                // Try alternative selectors for CSRF token
                                csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]') ||
                                           document.querySelector('meta[name="csrf-token"]') ||
                                           document.querySelector('[data-csrf-token]');
                            }

                            if (!csrfToken) {
                                console.error('❌ CSRF token not found!');
                                console.error('Available forms:', document.querySelectorAll('form').length);
                                console.error('Available inputs:', document.querySelectorAll('input[name*="csrf"]').length);
                                showToast('Error: CSRF token not found. Please refresh the page.', 'danger');
                                return;
                            }

                            const tokenValue = csrfToken.value || csrfToken.content || csrfToken.getAttribute('data-csrf-token');
                            if (!tokenValue) {
                                console.error('❌ CSRF token value is empty!');
                                showToast('Error: CSRF token is empty. Please refresh the page.', 'danger');
                                return;
                            }

                            formData.append('csrfmiddlewaretoken', tokenValue);

                            console.log('=== FORM DATA DETAILS ===');
                            console.log('File name:', file.name);
                            console.log('File size:', file.size);
                            console.log('File type:', file.type);
                            console.log('CSRF token:', tokenValue.substring(0, 10) + '...');
                            console.log('Upload URL:', `/connections/group/${conversationId}/upload-photo/`);

                            // Upload photo
                            fetch(`/connections/group/${conversationId}/upload-photo/`, {
                                method: 'POST',
                                body: formData,
                                headers: {
                                    'X-Requested-With': 'XMLHttpRequest'
                                }
                            })
                            .then(response => {
                                console.log('=== RAW RESPONSE RECEIVED ===');
                                console.log('Response status:', response.status);
                                console.log('Response headers:', response.headers);
                                console.log('Response ok:', response.ok);

                                if (!response.ok) {
                                    console.error('❌ HTTP Error:', response.status, response.statusText);
                                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                                }

                                return response.json();
                            })
                            .then(data => {
                                console.log('=== UPLOAD RESPONSE RECEIVED ===');
                                console.log('Full response data:', data);
                                console.log('Data type:', typeof data);
                                console.log('Data keys:', Object.keys(data || {}));
                                console.log('Success:', data.success);
                                console.log('Message:', data.message);
                                console.log('Group photo URL:', data.group_photo_url);
                                console.log('Debug info:', data.debug_info);
                                console.log('Errors:', data.errors);

                                if (data.success) {
                                    console.log('Photo upload successful:', data);

                                    // Show success message with better UX
                                    showToast(data.message || 'Group photo updated successfully!', 'success');

                                    // Hide modal
                                    bootstrap.Modal.getInstance(modal).hide();

                                    // Update avatars immediately with the new photo URL
                                    if (data.group_photo_url) {
                                        console.log('=== CALLING IMMEDIATE UPDATE ===');
                                        console.log('Conversation ID:', conversationId);
                                        console.log('Photo URL:', data.group_photo_url);

                                        // Test if the photo URL is accessible
                                        const testImg = new Image();
                                        testImg.onload = function() {
                                            console.log('✅ Photo URL is accessible');
                                            updateGroupAvatarsWithPhoto(conversationId, data.group_photo_url);

                                            // Refresh the conversation detail to ensure consistency
                                            setTimeout(() => {
                                                refreshGroupConversationDetail(conversationId);
                                            }, 500);
                                        };
                                        testImg.onerror = function() {
                                            console.error('❌ Photo URL is not accessible:', data.group_photo_url);
                                            // Still try to update, might work
                                            updateGroupAvatarsWithPhoto(conversationId, data.group_photo_url);

                                            // Refresh the conversation detail
                                            setTimeout(() => {
                                                refreshGroupConversationDetail(conversationId);
                                            }, 500);
                                        };
                                        testImg.src = data.group_photo_url;
                                    } else {
                                        console.error('❌ No group_photo_url in response');
                                        // Refresh the conversation detail anyway
                                        setTimeout(() => {
                                            refreshGroupConversationDetail(conversationId);
                                        }, 500);
                                    }
                                } else {
                                    console.error('=== UPLOAD FAILED ===');
                                    console.error('Full error data:', data);
                                    console.error('Error data type:', typeof data);
                                    console.error('Error data keys:', Object.keys(data || {}));
                                    console.error('Success flag:', data.success);
                                    console.error('Message:', data.message);
                                    console.error('Errors:', data.errors);

                                    let errorMessage = 'Failed to upload photo';

                                    // Check for specific error message
                                    if (data.message) {
                                        errorMessage = data.message;
                                    } else if (data.errors) {
                                        if (typeof data.errors === 'object') {
                                            if (Array.isArray(data.errors)) {
                                                errorMessage = data.errors.join(', ');
                                            } else {
                                                errorMessage = Object.values(data.errors).flat().join(', ');
                                            }
                                        } else {
                                            errorMessage = data.errors;
                                        }
                                    }

                                    console.error('Final error message:', errorMessage);
                                    showToast('Error: ' + errorMessage, 'danger');
                                }
                            })
                            .catch(error => {
                                console.error('=== UPLOAD ERROR ===');
                                console.error('Error type:', typeof error);
                                console.error('Error message:', error.message);
                                console.error('Error stack:', error.stack);
                                console.error('Full error:', error);

                                let errorMessage = 'An error occurred while uploading the photo. Please try again.';
                                if (error.message) {
                                    errorMessage = `Upload failed: ${error.message}`;
                                }

                                showToast(errorMessage, 'danger');
                            })
                            .finally(() => {
                                // Re-enable button
                                uploadBtn.disabled = false;
                                uploadBtn.innerHTML = 'Upload Photo';
                            });
                        });
                    }

                    // Reset form when modal is hidden
                    const modal = document.getElementById('groupPhotoModal');
                    if (modal && !modal.hasAttribute('data-reset-listener-attached')) {
                        modal.setAttribute('data-reset-listener-attached', 'true');
                        modal.addEventListener('hidden.bs.modal', function() {
                            const form = document.getElementById('groupPhotoForm');
                            const preview = document.getElementById('photoPreview');
                            if (form) form.reset();
                            if (preview) preview.style.display = 'none';
                        });
                    }
                }

                // Group photo modal functionality - initialize on DOM ready
                document.addEventListener('DOMContentLoaded', function() {
                    console.log('DOM loaded, initializing group photo modal...');
                    initializeModalFunctionality();
                });

                // Debug function to check modal availability
                window.debugGroupPhotoModal = function() {
                    console.log('=== GROUP PHOTO MODAL DEBUG ===');
                    const modal = document.getElementById('groupPhotoModal');
                    console.log('Modal element:', modal);
                    console.log('Modal exists:', !!modal);

                    if (modal) {
                        console.log('Modal HTML:', modal.outerHTML.substring(0, 200) + '...');
                        console.log('Modal form:', document.getElementById('groupPhotoForm'));
                        console.log('Modal input:', document.getElementById('groupPhotoInput'));
                        console.log('Modal button:', document.getElementById('uploadPhotoBtn'));
                    } else {
                        console.log('❌ Modal not found in DOM');
                        console.log('Available elements with "modal" in ID:');
                        const allElements = document.querySelectorAll('[id*="modal"], [id*="Modal"]');
                        allElements.forEach(el => console.log('  -', el.id, el.tagName));
                    }

                    console.log('showGroupPhotoUpload function:', typeof window.showGroupPhotoUpload);
                    console.log('removeGroupPhoto function:', typeof window.removeGroupPhoto);
                };

                // Function to check DOM state before upload
                window.checkDOMBeforeUpload = function(conversationId) {
                    console.log('=== DOM STATE BEFORE UPLOAD ===');
                    console.log('Target conversation ID:', conversationId);

                    // Check all conversation items
                    const conversationItems = document.querySelectorAll('.conversation-item');
                    console.log(`Total conversation items: ${conversationItems.length}`);

                    conversationItems.forEach((item, index) => {
                        const groupAvatar = item.querySelector('.group-avatar');
                        if (groupAvatar) {
                            const groupId = groupAvatar.getAttribute('data-group-id');
                            console.log(`Item ${index + 1}: Group ID ${groupId}, Target: ${groupId == conversationId}`);
                        }
                    });

                    // Check chat header
                    const chatHeader = document.querySelector('.chat-header-avatar[data-group-id="' + conversationId + '"]');
                    console.log('Chat header found:', !!chatHeader);

                    return {
                        conversationItems: conversationItems.length,
                        targetFound: !!document.querySelector('.group-avatar[data-group-id="' + conversationId + '"]'),
                        chatHeaderFound: !!chatHeader
                    };
                };

                // Debug function to check group photo status
                window.debugGroupPhoto = function(conversationId) {
                    console.log('=== GROUP PHOTO DEBUG ===');
                    console.log('Conversation ID:', conversationId);

                    // Check conversation list avatar
                    const conversationItems = document.querySelectorAll('.conversation-item');
                    conversationItems.forEach((item, index) => {
                        const groupAvatar = item.querySelector('.group-avatar');
                        if (groupAvatar) {
                            const groupId = groupAvatar.getAttribute('data-group-id');
                            const groupName = groupAvatar.getAttribute('data-group-name');
                            console.log(`Conversation ${index + 1}:`, {
                                groupId: groupId,
                                groupName: groupName,
                                isTargetConversation: groupId == conversationId,
                                avatarVisible: !groupAvatar.classList.contains('d-none'),
                                avatarDisplay: groupAvatar.style.display
                            });

                            // Check for existing image
                            const existingImg = item.querySelector('img');
                            if (existingImg) {
                                console.log('  - Has image:', existingImg.src);
                            } else {
                                console.log('  - No image found');
                            }
                        }
                    });

                    // Check chat header avatar
                    const chatHeaderAvatar = document.querySelector('.chat-header-avatar[data-group-id="' + conversationId + '"]');
                    if (chatHeaderAvatar) {
                        console.log('Chat header avatar found:', {
                            groupId: chatHeaderAvatar.getAttribute('data-group-id'),
                            groupName: chatHeaderAvatar.getAttribute('data-group-name'),
                            visible: !chatHeaderAvatar.classList.contains('d-none'),
                            display: chatHeaderAvatar.style.display
                        });

                        // Check for existing image in header
                        const headerContainer = chatHeaderAvatar.parentElement;
                        const headerImg = headerContainer.querySelector('img');
                        if (headerImg) {
                            console.log('  - Header has image:', headerImg.src);
                        } else {
                            console.log('  - Header has no image');
                        }
                    } else {
                        console.log('No chat header avatar found for conversation', conversationId);
                    }
                };

                // Function to test photo URL accessibility
                window.testPhotoURL = function(url) {
                    console.log('Testing photo URL:', url);

                    const img = new Image();
                    img.onload = function() {
                        console.log('✅ Photo URL is accessible');
                        console.log('Image dimensions:', this.naturalWidth, 'x', this.naturalHeight);
                    };
                    img.onerror = function() {
                        console.error('❌ Photo URL is not accessible');
                    };
                    img.src = url;

                    // Also try fetch
                    fetch(url)
                        .then(response => {
                            console.log('Fetch response status:', response.status);
                            console.log('Fetch response ok:', response.ok);
                            return response.blob();
                        })
                        .then(blob => {
                            console.log('Fetch blob size:', blob.size);
                            console.log('Fetch blob type:', blob.type);
                        })
                        .catch(error => {
                            console.error('Fetch error:', error);
                        });
                };

                console.log('All functions loaded, including group chat functionality and messaging fixes');
                </script>

                <!-- In-Page Message Creation Interface -->
                <div id="newMessageInterface" class="border-bottom" style="display: none;">
                    <div class="p-3 bg-light">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0 text-primary">
                                <i class="fas fa-paper-plane me-2"></i>Create New Message
                            </h6>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="closeNewMessage">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <!-- User Search -->
                        <div class="mb-3">
                            <label for="inlineUserSearch" class="form-label fw-semibold">
                                <i class="fas fa-search me-1"></i>Search for a user
                            </label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="inlineUserSearch" placeholder="Start typing a name..." autocomplete="off">
                                <button class="btn btn-outline-primary" type="button" id="inlineSearchBtn">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                            <div class="form-text">Search for connected alumni to send a message</div>
                        </div>

                        <!-- Search Results -->
                        <div id="inlineSearchResults" class="mb-3" style="display: none;">
                            <div class="search-results-container">
                                <div class="inline-search-results-list"></div>
                            </div>
                        </div>

                        <!-- Selected User -->
                        <div id="inlineSelectedUser" class="mb-3" style="display: none;">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-user me-1"></i>Sending to
                            </label>
                            <div class="selected-user-card">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div class="d-flex align-items-center">
                                        <img class="selected-user-avatar me-3" src="" alt="" width="40" height="40">
                                        <div>
                                            <div class="selected-user-name fw-semibold"></div>
                                            <div class="selected-user-title text-muted small"></div>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" id="inlineClearSelection">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Message Input -->
                        <div class="mb-3">
                            <label for="inlineMessageContent" class="form-label fw-semibold">
                                <i class="fas fa-comment me-1"></i>Your message
                            </label>
                            <textarea class="form-control" id="inlineMessageContent" rows="3" placeholder="Type your message here..." disabled></textarea>
                            <div class="form-text">Select a user first to enable message input</div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex justify-content-end gap-2">
                            <button type="button" class="btn btn-secondary btn-sm" id="inlineCancelMessage">
                                <i class="fas fa-times me-1"></i>Cancel
                            </button>
                            <button type="button" class="btn btn-primary btn-sm" id="inlineSendMessage" disabled>
                                <i class="fas fa-paper-plane me-1"></i>Send Message
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Group Chat Creation Interface -->
                <div id="groupChatInterface" class="border-bottom" style="display: none;">
                    <div class="p-3 bg-light">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0 text-primary">
                                <i class="fas fa-users me-2"></i>Create Group Chat
                            </h6>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="closeGroupChat">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <!-- Group Name -->
                        <div class="mb-3">
                            <label for="groupNameInput" class="form-label fw-semibold">
                                <i class="fas fa-tag me-1"></i>Group Name
                            </label>
                            <input type="text" class="form-control" id="groupNameInput" placeholder="Enter group name..." maxlength="100">
                            <div class="form-text">Choose a name for your group chat</div>
                        </div>

                        <!-- Participant Search -->
                        <div class="mb-3">
                            <label for="groupUserSearch" class="form-label fw-semibold">
                                <i class="fas fa-search me-1"></i>Add Participants
                            </label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="groupUserSearch" placeholder="Search for users to add..." autocomplete="off">
                                <button class="btn btn-outline-primary" type="button" id="groupSearchBtn">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                            <div class="form-text">Search for connected alumni to add to the group</div>
                        </div>

                        <!-- Search Results for Group -->
                        <div id="groupSearchResults" class="mb-3" style="display: none;">
                            <div class="search-results-container">
                                <div class="group-search-results-list"></div>
                            </div>
                        </div>

                        <!-- Selected Participants -->
                        <div id="selectedParticipants" class="mb-3">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-users me-1"></i>Participants (<span id="participantCount">0</span>)
                            </label>
                            <div id="participantsList" class="selected-participants-container">
                                <div class="text-muted small">No participants selected yet. Add at least 2 participants.</div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex justify-content-end gap-2">
                            <button type="button" class="btn btn-secondary btn-sm" id="cancelGroupChat">
                                <i class="fas fa-times me-1"></i>Cancel
                            </button>
                            <button type="button" class="btn btn-primary btn-sm" id="createGroupBtn" disabled>
                                <i class="fas fa-users me-1"></i>Create Group
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Conversations List -->
                <div class="card-body p-0" id="conversationsList" style="max-height: 600px; overflow-y: auto;">
                    {% if conversations %}
                        {% for conv in conversations %}
                        <div class="conversation-item {% if conv.unread_count > 0 %}unread{% endif %}"
                             {% if conv.is_group_chat %}
                                 onclick="loadGroupConversation({{ conv.conversation.id }}); setActiveConversation(this);"
                             {% else %}
                                 hx-get="{% url 'connections:direct_messages' conv.other_user.id %}"
                                 hx-target="#conversation-detail"
                                 hx-swap="innerHTML"
                                 onclick="setActiveConversation(this)"
                             {% endif %}>

                            <div class="d-flex align-items-center">
                                <!-- Profile Picture / Group Icon -->
                                <div class="flex-shrink-0 me-3">
                                    {% if conv.is_group_chat %}
                                        {% if conv.conversation.group_photo %}
                                            <img src="{{ conv.conversation.group_photo.url }}"
                                                 alt="{{ conv.group_name|default:'Group Chat' }}"
                                                 class="rounded-circle avatar-sm"
                                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                            <div class="rounded-circle avatar-sm d-none align-items-center justify-content-center text-white fw-bold group-avatar"
                                                 data-group-name="{{ conv.group_name|default:'Group Chat' }}"
                                                 data-group-id="{{ conv.conversation.id }}"
                                                 style="font-size: 20px;">
                                                <!-- Initials will be set by JavaScript -->
                                            </div>
                                        {% else %}
                                            <div class="rounded-circle avatar-sm d-flex align-items-center justify-content-center text-white fw-bold group-avatar"
                                                 data-group-name="{{ conv.group_name|default:'Group Chat' }}"
                                                 data-group-id="{{ conv.conversation.id }}"
                                                 style="font-size: 20px;">
                                                <!-- Initials will be set by JavaScript -->
                                            </div>
                                        {% endif %}
                                    {% else %}
                                        {% if conv.other_user.profile.avatar %}
                                            <img src="{{ conv.other_user.profile.avatar.url }}"
                                                 alt="{{ conv.other_user.get_full_name }}"
                                                 class="rounded-circle avatar-sm"
                                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                            <div class="rounded-circle avatar-sm d-none align-items-center justify-content-center text-white fw-bold user-avatar"
                                                 data-user-id="{{ conv.other_user.id }}"
                                                 data-first-name="{{ conv.other_user.first_name }}"
                                                 data-last-name="{{ conv.other_user.last_name }}"
                                                 data-username="{{ conv.other_user.username }}"
                                                 style="font-size: 20px;">
                                                <!-- Initials and gradient will be set by JavaScript -->
                                            </div>
                                        {% else %}
                                            <div class="rounded-circle avatar-sm d-flex align-items-center justify-content-center text-white fw-bold user-avatar"
                                                 data-user-id="{{ conv.other_user.id }}"
                                                 data-first-name="{{ conv.other_user.first_name }}"
                                                 data-last-name="{{ conv.other_user.last_name }}"
                                                 data-username="{{ conv.other_user.username }}"
                                                 style="font-size: 20px;">
                                                <!-- Initials and gradient will be set by JavaScript -->
                                            </div>
                                        {% endif %}
                                    {% endif %}
                                </div>
                                
                                <!-- Conversation Info -->
                                <div class="flex-grow-1 min-w-0">
                                    <!-- Name and Unread Badge -->
                                    <div class="d-flex justify-content-between align-items-start mb-1">
                                        <h6 class="conversation-name text-truncate mb-0">
                                            {% if conv.is_group_chat %}
                                                {{ conv.group_name }}
                                            {% else %}
                                                {{ conv.other_user.get_full_name|default:conv.other_user.username }}
                                            {% endif %}
                                        </h6>

                                        <!-- Unread Badge -->
                                        {% if conv.unread_count > 0 %}
                                        <span class="unread-badge ms-2">
                                            {{ conv.unread_count }}
                                        </span>
                                        {% endif %}
                                    </div>

                                    <!-- Job Title/Position or Participant Count -->
                                    {% if conv.is_group_chat %}
                                    <div class="conversation-position text-truncate">
                                        <i class="fas fa-users me-1" style="font-size: 0.7rem;"></i>
                                        {{ conv.participant_count }} participant{{ conv.participant_count|pluralize }}
                                    </div>
                                    {% else %}
                                        {% if conv.other_user.profile.current_job_title %}
                                        <div class="conversation-position text-truncate">
                                            <i class="fas fa-briefcase me-1" style="font-size: 0.7rem;"></i>
                                            {{ conv.other_user.profile.current_job_title }}
                                        </div>
                                        {% endif %}
                                    {% endif %}
                                    
                                    <!-- Last Message Preview and Timestamp -->
                                    <div class="d-flex justify-content-between align-items-end">
                                        <div class="message-preview flex-grow-1 me-2">
                                            {% if conv.last_message %}
                                                {% if conv.last_message.sender == user %}
                                                    <span style="color: var(--primary-color); font-weight: 600;">You:</span>
                                                {% endif %}
                                                {{ conv.last_message.content|truncatechars:45 }}
                                            {% else %}
                                                <em style="color: var(--text-muted);">Start a conversation...</em>
                                            {% endif %}
                                        </div>
                                        
                                        <!-- Timestamp -->
                                        <div class="conversation-time flex-shrink-0">
                                            <i class="fas fa-clock me-1" style="font-size: 0.65rem;"></i>
                                            {% if conv.last_message %}
                                                {{ conv.last_message.created_at|timesince }} ago
                                            {% else %}
                                                {{ conv.conversation.created_at|timesince }} ago
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="no-conversations">
                            <i class="fas fa-comments fa-3x mb-3"></i>
                            <h5>No conversations yet</h5>
                            <p class="mb-3">Start messaging your connections to see conversations here.</p>
                            <a href="{% url 'connections:my_connections' %}" class="btn btn-primary">
                                <i class="fas fa-users me-1"></i>View My Connections
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Conversation Detail Area -->
        <div class="col-lg-8">
            <div class="messages-card h-100" id="conversation-detail">
                <div class="card-body d-flex align-items-center justify-content-center" style="min-height: 500px;">
                    <div class="text-center text-muted">
                        <i class="fas fa-comments fa-3x mb-3"></i>
                        <h5>Select a conversation</h5>
                        <p>Choose a conversation from the left to start messaging</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CSRF Token for AJAX requests -->
{% csrf_token %}
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/htmx.org@1.9.10"></script>

<script>
// Additional functionality for conversations list
// Main new message functionality is defined in the inline script above

// Search functionality for conversations list
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const sortSelect = document.getElementById('sortSelect');

    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const conversations = document.querySelectorAll('.conversation-item');

            conversations.forEach(function(conversation) {
                const name = conversation.querySelector('.conversation-name').textContent.toLowerCase();
                const position = conversation.querySelector('.conversation-position');
                const positionText = position ? position.textContent.toLowerCase() : '';
                const messagePreview = conversation.querySelector('.message-preview').textContent.toLowerCase();

                if (name.includes(searchTerm) || positionText.includes(searchTerm) || messagePreview.includes(searchTerm)) {
                    conversation.style.display = 'block';
                } else {
                    conversation.style.display = 'none';
                }
            });
        });
    }

    // Sort functionality
    if (sortSelect) {
        sortSelect.addEventListener('change', function() {
            const sortBy = this.value;
            const container = document.getElementById('conversationsList');
            const conversations = Array.from(document.querySelectorAll('.conversation-item'));

            conversations.sort(function(a, b) {
                switch(sortBy) {
                    case 'alphabetical':
                        const nameA = a.querySelector('.conversation-name').textContent.trim();
                        const nameB = b.querySelector('.conversation-name').textContent.trim();
                        return nameA.localeCompare(nameB);

                    case 'unread':
                        const unreadA = a.classList.contains('unread') ? 1 : 0;
                        const unreadB = b.classList.contains('unread') ? 1 : 0;
                        return unreadB - unreadA;

                    case 'recent':
                    default:
                        // Keep original order for recent
                        return 0;
                }
            });

            // Re-append sorted conversations
            conversations.forEach(function(conversation) {
                container.appendChild(conversation);
            });
        });
    }
});

// Helper function to show toast notifications
function showToast(message, type = 'info') {
    // Create toast container if it doesn't exist
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
    }

    // Create toast element
    const toastId = 'toast-' + Date.now();
    const toastHtml = `
        <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;

    toastContainer.insertAdjacentHTML('beforeend', toastHtml);

    // Show toast
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, { delay: 5000 });
    toast.show();

    // Remove toast element after it's hidden
    toastElement.addEventListener('hidden.bs.toast', function() {
        toastElement.remove();
    });
}

// Helper function to update group avatars to fallback (when photo is removed)
function updateGroupAvatarsToFallback(conversationId) {
    console.log('=== UPDATING GROUP AVATARS TO FALLBACK ===');
    console.log(`Conversation ID: ${conversationId}`);

    // Update conversation list avatar
    const conversationItems = document.querySelectorAll('.conversation-item');
    conversationItems.forEach((item) => {
        const groupAvatar = item.querySelector('.group-avatar');
        if (groupAvatar) {
            const groupId = groupAvatar.getAttribute('data-group-id');
            if (groupId == conversationId) {
                // Remove any existing image and show the fallback avatar
                const avatarContainer = groupAvatar.parentElement;
                const existingImg = avatarContainer.querySelector('img');
                if (existingImg) {
                    existingImg.remove();
                }

                groupAvatar.style.display = 'flex';
                groupAvatar.classList.remove('d-none');
                groupAvatar.classList.add('d-flex');
                console.log('✅ Updated conversation list avatar to fallback');
            }
        }
    });

    // Update chat header avatar using the new template structure
    const groupPhotoImg = document.getElementById(`group-photo-img-${conversationId}`);
    const groupAvatarFallback = document.getElementById(`group-avatar-fallback-${conversationId}`);

    if (groupPhotoImg && groupAvatarFallback) {
        // Hide the image and show the fallback
        groupPhotoImg.style.display = 'none';
        groupPhotoImg.classList.add('d-none');
        groupAvatarFallback.style.display = 'flex';
        groupAvatarFallback.classList.remove('d-none');
        groupAvatarFallback.classList.add('d-flex');
        console.log('✅ Updated chat header avatar to fallback');
    }
}

// Helper function to refresh group conversation detail
function refreshGroupConversationDetail(conversationId) {
    console.log('Refreshing group conversation detail for ID:', conversationId);

    const conversationDetail = document.getElementById('conversation-detail');
    if (!conversationDetail) {
        console.log('No conversation detail element found');
        return;
    }

    // Check if this conversation is currently active
    const activeConversationItem = document.querySelector('.conversation-item.active');
    if (!activeConversationItem) {
        console.log('No active conversation found');
        return;
    }

    const activeGroupAvatar = activeConversationItem.querySelector('.group-avatar');
    if (!activeGroupAvatar) {
        console.log('Active conversation is not a group chat');
        return;
    }

    const activeGroupId = activeGroupAvatar.getAttribute('data-group-id');
    if (activeGroupId != conversationId) {
        console.log('Active conversation is different group');
        return;
    }

    // Refresh the conversation detail
    loadGroupConversation(conversationId);
}

// Test function to verify upload endpoint accessibility
window.testUploadEndpoint = function(conversationId) {
    console.log('Testing upload endpoint accessibility...');
    fetch(`/connections/group/${conversationId}/upload-photo/`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        console.log('Test response status:', response.status);
        console.log('Test response ok:', response.ok);
        if (response.status === 405) {
            console.log('✅ Endpoint exists (Method Not Allowed is expected for GET)');
        } else if (response.status === 404) {
            console.log('❌ Endpoint not found');
        } else {
            console.log('Unexpected response:', response.status);
        }
    })
    .catch(error => {
        console.error('Test error:', error);
    });
};

// Make functions globally accessible for debugging (after they're defined)
window.performUserSearch = performUserSearch;
window.selectUser = selectUser;
window.clearUserSelection = clearUserSelection;
window.showToast = showToast;
window.refreshGroupConversationDetail = refreshGroupConversationDetail;
window.updateGroupAvatarsToFallback = updateGroupAvatarsToFallback;
// setActiveConversation is already defined above
</script>

<!-- Group Photo Upload Modal -->
<div class="modal fade" id="groupPhotoModal" tabindex="-1" aria-labelledby="groupPhotoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="groupPhotoModalLabel">Set Group Photo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="groupPhotoForm" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="groupPhotoInput" class="form-label">Choose Group Photo</label>
                        <input type="file" class="form-control" id="groupPhotoInput" name="group_photo" accept="image/*" required>
                        <div class="form-text">Upload a group photo (JPG, PNG, GIF). Max size: 5MB</div>
                    </div>
                    <div id="photoPreview" class="mb-3" style="display: none;">
                        <img id="previewImage" src="" alt="Preview" class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="uploadPhotoBtn">Upload Photo</button>
            </div>
        </div>
    </div>
</div>

<!-- Participants Modal -->
<div class="modal fade" id="participantsModal" tabindex="-1" aria-labelledby="participantsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="participantsModalLabel">
                    <i class="fas fa-users me-2"></i>Group Participants
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="participantsContent">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading participants...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Members Modal -->
<div class="modal fade" id="addMembersModal" tabindex="-1" aria-labelledby="addMembersModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addMembersModalLabel">
                    <i class="fas fa-user-plus me-2"></i>Add Members to Group
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Search Section -->
                <div class="mb-4">
                    <div class="input-group">
                        <input type="text" id="memberSearchInput" class="form-control"
                               placeholder="Search for alumni by name or username..."
                               autocomplete="off">
                        <button class="btn btn-primary" type="button" id="searchMembersBtn">
                            <i class="fas fa-search"></i> Search
                        </button>
                    </div>
                    <small class="text-muted">Search for alumni to add to this group conversation</small>
                </div>

                <!-- Search Results Section -->
                <div id="searchResultsSection" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">Search Results</h6>
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="selectAllBtn">
                            Select All
                        </button>
                    </div>
                    <div id="searchResults" class="search-results-container">
                        <!-- Search results will be populated here -->
                    </div>
                </div>

                <!-- Selected Members Section -->
                <div id="selectedMembersSection" style="display: none;">
                    <h6 class="mb-3">Selected Members (<span id="selectedCount">0</span>)</h6>
                    <div id="selectedMembers" class="selected-members-container">
                        <!-- Selected members will be shown here -->
                    </div>
                </div>

                <!-- Loading State -->
                <div id="searchLoadingState" class="text-center" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Searching...</span>
                    </div>
                    <p class="mt-2 text-muted">Searching for members...</p>
                </div>

                <!-- No Results State -->
                <div id="noResultsState" class="text-center text-muted" style="display: none;">
                    <i class="fas fa-search fa-2x mb-3"></i>
                    <p>No alumni found matching your search criteria</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="addSelectedMembersBtn" disabled>
                    <i class="fas fa-user-plus me-1"></i>Add Selected Members
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}