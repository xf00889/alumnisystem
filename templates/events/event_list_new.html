{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Events{% endblock %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
    /* NORSU Alumni System - Events Design */
    :root {
        /* NORSU Brand Colors */
        --primary-color: #2b3c6b;
        --primary-dark: #1a2544;
        --primary-light: #3c4f8a;
        --secondary-color: #4a5568;
        --accent-color: #c8a882;
        
        /* UI Colors - Consistent with system */
        --ui-background: #f8f9fa;
        --ui-surface: #ffffff;
        --ui-border: #e2e8f0;
        --ui-hover: #edf2f7;
        --ui-selected: #e3f2fd;
        
        /* Text Colors */
        --text-primary: #2d3748;
        --text-secondary: #718096;
        --text-muted: #a0aec0;
        --text-light: #ffffff;
        
        /* Feedback Colors - NORSU Theme */
        --feedback-success: #28a745;
        --feedback-warning: #ffc107;
        --feedback-error: #dc3545;
        --feedback-info: #17a2b8;
        
        /* Event Status Colors */
        --status-draft: #6c757d;
        --status-published: #28a745;
        --status-cancelled: #dc3545;
        --status-completed: #17a2b8;
        
        /* Spacing Scale */
        --space-1: 0.25rem;
        --space-2: 0.5rem;
        --space-3: 0.75rem;
        --space-4: 1rem;
        --space-5: 1.25rem;
        --space-6: 1.5rem;
        --space-8: 2rem;
        
        /* Border Radius */
        --radius-sm: 0.25rem;
        --radius-md: 0.375rem;
        --radius-lg: 0.5rem;
        --radius-xl: 0.75rem;
        
        /* Shadows */
        --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
        --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
    }

    body {
        background-color: var(--ui-background);
        font-size: 0.875rem;
        font-family: 'Poppins', sans-serif;
    }
    
    .container-fluid {
        padding: 1.5rem;
        width: 100%;
        max-width: 100%;
        margin: 0 auto;
    }

    /* Header Section */
    .directory-header {
        background: var(--primary-color);
        color: var(--text-light);
        padding: 2rem;
        border-radius: var(--radius-md);
        margin-bottom: 1.5rem;
        box-shadow: var(--shadow-sm);
        text-align: center;
        font-family: 'Poppins', sans-serif;
    }
    
    .directory-title {
        font-size: 2rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        font-family: 'Poppins', sans-serif;
    }
    
    .directory-subtitle {
        opacity: 0.9;
        font-size: 1rem;
        margin: 0;
        font-family: 'Poppins', sans-serif;
    }
    
    /* View Toggle Section */
    .view-toggle-section {
        background: var(--ui-surface);
        padding: var(--space-4);
        border-radius: var(--radius-md);
        margin-bottom: 1.5rem;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--ui-border);
    }
    
    .view-toggle-container {
        display: flex;
        align-items: center;
        gap: var(--space-4);
    }
    
    .view-toggle-label {
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
    }
    
    .view-toggle-buttons {
        display: flex;
        gap: var(--space-2);
    }
    
    .view-toggle-btn {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        padding: var(--space-2) var(--space-4);
        border: 2px solid var(--ui-border);
        background: var(--ui-surface);
        color: var(--text-secondary);
        border-radius: var(--radius-md);
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .view-toggle-btn:hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
    }
    
    .view-toggle-btn.active {
        background: var(--primary-color);
        color: var(--text-light);
        border-color: var(--primary-color);
    }
    
    /* Search Section */
    .search-section {
        background: var(--ui-surface);
        padding: 2rem;
        border-radius: var(--radius-md);
        margin-bottom: 1.5rem;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--ui-border);
        font-family: 'Poppins', sans-serif;
    }
    
    .search-form {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 2rem;
        align-items: end;
    }
    
    .search-group {
        display: flex;
        flex-direction: column;
    }
    
    .form-label {
        font-weight: 500;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
        font-family: 'Poppins', sans-serif;
    }
    
    .search-container {
        position: relative;
    }
    
    .search-icon {
        position: absolute;
        left: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
        z-index: 2;
    }
    
    .search-input {
        width: 100%;
        padding: 0.75rem 1rem 0.75rem 2.5rem;
        border: 1px solid var(--ui-border);
        border-radius: var(--radius-sm);
        font-size: 0.875rem;
        transition: all var(--transition-normal);
        background: var(--ui-surface);
        color: var(--text-primary);
        font-family: 'Poppins', sans-serif;
    }
    
    .search-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(43, 60, 107, 0.1);
    }
    
    .filter-group {
        display: flex;
        flex-direction: column;
    }
    
    .filter-buttons {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.5rem;
    }
    
    .filter-button {
        padding: 0.5rem 1rem;
        border: 1px solid var(--ui-border);
        background: var(--ui-surface);
        color: var(--text-primary);
        border-radius: var(--radius-sm);
        font-size: 0.75rem;
        font-weight: 500;
        cursor: pointer;
        transition: all var(--transition-normal);
        font-family: 'Poppins', sans-serif;
    }
    
    .filter-button:hover {
        border-color: var(--primary-color);
        background: var(--ui-hover);
    }
    
    .filter-button.active {
        border-color: var(--primary-color);
        background: var(--ui-selected);
        color: var(--primary-color);
    }
    
    .action-group {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }
    
    .btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: var(--radius-sm);
        font-size: 0.75rem;
        font-weight: 500;
        font-family: 'Poppins', sans-serif;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        justify-content: center;
    }
    
    .btn-primary {
        background: var(--primary-color);
        color: var(--text-light);
    }
    
    .btn-primary:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
        text-decoration: none;
        color: var(--text-light);
    }
    
    .btn-secondary {
        background: var(--ui-hover);
        color: var(--text-primary);
        border: 1px solid var(--ui-border);
    }
    
    .btn-secondary:hover {
        background: var(--ui-border);
        color: var(--text-primary);
        text-decoration: none;
    }
    
    /* Events Grid */
    .events-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .event-content {
        margin-bottom: 1.5rem;
    }

    .event-card {
        background: var(--ui-surface);
        border-radius: var(--radius-md);
        padding: 1.5rem;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--ui-border);
        font-family: 'Poppins', sans-serif;
        transition: all 0.3s ease;
        position: relative;
    }

    .event-card:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
    }
    
    .event-card.selected {
        border-color: var(--primary-color);
        background: var(--ui-selected);
    }
    
    .event-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
    }
    
    .event-checkbox {
        position: absolute;
        top: 1rem;
        left: 1rem;
    }
    
    .event-status {
        margin-left: 2rem;
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: var(--space-1);
        padding: var(--space-1) var(--space-2);
        border-radius: var(--radius-sm);
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .status-draft {
        background: var(--status-draft);
        color: var(--text-light);
    }

    .status-published {
        background: var(--status-published);
        color: var(--text-light);
    }

    .status-cancelled {
        background: var(--status-cancelled);
        color: var(--text-light);
    }

    .status-completed {
        background: var(--status-completed);
        color: var(--text-light);
    }

    .event-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0 0 0.75rem 0;
        font-family: 'Poppins', sans-serif;
    }
    
    .event-title a {
        color: var(--text-primary);
        text-decoration: none;
        transition: color var(--transition-fast);
    }
    
    .event-title a:hover {
        color: var(--primary-color);
    }
    
    .event-preview {
        color: var(--text-secondary);
        font-size: 0.875rem;
        line-height: 1.5;
        margin: 0;
    }

    .event-meta {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
    }
    
    .meta-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.75rem;
        color: var(--text-secondary);
        font-family: 'Poppins', sans-serif;
    }
    
    .meta-item i {
        width: 14px;
        color: var(--primary-color);
    }

    .event-actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }
    
    .view-details-btn {
        flex: 1;
        min-width: 120px;
    }
    
    .btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: var(--radius-sm);
        font-size: 0.75rem;
        font-weight: 500;
        font-family: 'Poppins', sans-serif;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        justify-content: center;
    }

    .btn-primary {
        background: var(--primary-color);
        color: var(--text-light);
    }

    .btn-primary:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
        text-decoration: none;
        color: var(--text-light);
    }

    .btn-warning {
        background: var(--feedback-warning);
        color: var(--text-primary);
    }

    .btn-warning:hover {
        background: #e0a800;
        transform: translateY(-1px);
    }

    .btn-danger {
        background: var(--feedback-error);
        color: var(--text-light);
    }

    .btn-danger:hover {
        background: #c82333;
        transform: translateY(-1px);
    }

    /* Table View Styles */
    .events-table {
        display: none;
        background: var(--ui-surface);
        border-radius: var(--radius-md);
        overflow: hidden;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--ui-border);
        margin-bottom: 2rem;
    }
    
    .events-table.show {
        display: block;
    }
    
    .events-table table {
        width: 100%;
        border-collapse: collapse;
        font-family: 'Poppins', sans-serif;
    }
    
    .events-table th {
        background: var(--primary-color);
        color: var(--text-light);
        padding: var(--space-4);
        text-align: left;
        font-weight: 600;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .events-table td {
        padding: var(--space-4);
        border-bottom: 1px solid var(--ui-border);
        vertical-align: top;
    }
    
    .events-table tr:hover {
        background: var(--ui-hover);
    }
    
    .events-table tr:last-child td {
        border-bottom: none;
    }
    
    .table-title {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--space-1);
        cursor: pointer;
    }
    
    .table-title:hover {
        color: var(--primary-color);
    }
    
    .table-description {
        color: var(--text-secondary);
        font-size: 0.875rem;
        line-height: 1.4;
        margin-bottom: var(--space-2);
    }
    
    .table-meta {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-3);
        font-size: 0.75rem;
        color: var(--text-muted);
    }
    
    .table-actions {
        display: flex;
        gap: var(--space-2);
    }
    
    .table-action-btn {
        padding: var(--space-1) var(--space-2);
        border: 1px solid var(--ui-border);
        background: var(--ui-surface);
        color: var(--text-secondary);
        border-radius: var(--radius-sm);
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .table-action-btn:hover {
        background: var(--primary-color);
        color: var(--text-light);
        border-color: var(--primary-color);
    }
    
    .table-checkbox {
        margin-right: var(--space-2);
    }

    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        animation: fadeIn 0.3s ease;
    }

    .modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
    }

     .modal-dialog {
         background: var(--ui-surface);
         border-radius: var(--radius-lg);
         box-shadow: var(--shadow-lg);
         max-width: 800px;
         width: 90%;
         max-height: 80vh;
         overflow-y: auto;
         animation: slideIn 0.3s ease;
         pointer-events: auto;
     }

    .modal-header {
        padding: var(--space-6);
        border-bottom: 1px solid var(--ui-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--primary-color);
        color: var(--text-light);
        border-radius: var(--radius-lg) var(--radius-lg) 0 0;
    }

    .modal-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0;
    }

    .modal-close {
        background: none;
        border: none;
        color: var(--text-light);
        font-size: 1.5rem;
        cursor: pointer;
        padding: var(--space-1);
        border-radius: var(--radius-sm);
        transition: background 0.2s ease;
    }

    .modal-close:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    .modal-body {
        padding: var(--space-6);
    }

    .modal-footer {
        padding: var(--space-4) var(--space-6);
        border-top: 1px solid var(--ui-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--ui-hover);
        border-radius: 0 0 var(--radius-lg) var(--radius-lg);
        pointer-events: auto;
    }
    
    .modal-actions {
        display: flex;
        gap: var(--space-2);
        align-items: center;
    }

    .modal-share {
        display: flex;
        gap: var(--space-2);
        align-items: center;
    }

    .modal-share-button {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        transition: all 0.3s ease;
        text-decoration: none;
        z-index: 10;
    }

    .modal-share-button:hover {
        transform: scale(1.1);
        box-shadow: var(--shadow-md);
    }

    .modal-share-button:active {
        transform: scale(0.95);
    }

    .share-facebook { background: #1877f2; color: white; }
    .share-twitter { background: #1da1f2; color: white; }
    .share-linkedin { background: #0077b5; color: white; }
    .share-whatsapp { background: #25d366; color: white; }
    .share-telegram { background: #0088cc; color: white; }
    .share-email { background: #ea4335; color: white; }
    .share-copy { background: #6c757d; color: white; }
    .share-more { background: #ffc107; color: #000; }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideIn {
        from { 
            opacity: 0;
            transform: translateY(-50px) scale(0.9);
        }
        to { 
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
        .search-form {
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }
        
        .action-group {
            grid-column: 1 / -1;
            justify-self: start;
            margin-top: 1rem;
        }
    }
    
    @media (max-width: 768px) {
        .events-grid {
            grid-template-columns: 1fr;
        }
        
        .search-form {
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
        
        .event-meta {
            grid-template-columns: 1fr;
        }

        /* Hide view mode container and toggle controls on mobile */
        .view-toggle-section,
        .view-toggle-container,
        .view-toggle-buttons,
        .view-toggle-btn {
            display: none !important;
        }
        
        .view-toggle-container {
            flex-direction: column;
            align-items: flex-start;
            gap: var(--space-3);
        }
        
        .view-toggle-buttons {
            width: 100%;
        }
        
        .view-toggle-btn {
            flex: 1;
            justify-content: center;
        }
        
        .events-table {
            overflow-x: auto;
        }
        
        .events-table table {
            min-width: 600px;
        }
        
        .table-actions {
            flex-direction: column;
            gap: var(--space-1);
        }
        
        .filter-buttons {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    
    @media (max-width: 480px) {
        .filter-buttons {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="directory-header">
        <h1 class="directory-title">Events</h1>
        <p class="directory-subtitle">Discover and manage upcoming events and activities</p>
    </div>
    
    <!-- View Toggle Section -->
    <div class="view-toggle-section">
        <div class="view-toggle-container">
            <label class="view-toggle-label">View Mode:</label>
            <div class="view-toggle-buttons">
                <button type="button" id="cardViewBtn" class="view-toggle-btn active" data-view="card">
                    <i class="fas fa-th-large"></i>
                    Card View
                </button>
                <button type="button" id="tableViewBtn" class="view-toggle-btn" data-view="table">
                    <i class="fas fa-table"></i>
                    Tabular View
                </button>
            </div>
        </div>
    </div>

    <!-- Search Section -->
    <div class="search-section">
        <div class="search-form">
            <div class="search-group">
                <label for="searchInput" class="form-label">Search Events</label>
                <div class="search-container">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" 
                           id="searchInput" 
                           class="search-input" 
                           placeholder="Search by title or description...">
                </div>
            </div>
            <div class="filter-group">
                <label class="form-label">Filter by Status</label>
                <div class="filter-buttons">
                    <button class="filter-button active" data-filter="all">All</button>
                    <button class="filter-button" data-filter="published">Published</button>
                    <button class="filter-button" data-filter="draft">Draft</button>
                    <button class="filter-button" data-filter="cancelled">Cancelled</button>
                    <button class="filter-button" data-filter="completed">Completed</button>
                </div>
            </div>
            <div class="action-group">
                {% if user.is_staff %}
                    <a href="{% url 'events:event_create' %}" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>New Event
                    </a>
                    <button class="btn btn-secondary" onclick="handleExport()">
                        <i class="fas fa-download me-2"></i>Export
                    </button>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Events Grid -->
    {% if events %}
    <div class="events-grid" id="eventsGrid">
        {% for event in events %}
        <div class="event-card" data-id="{{ event.pk }}">
            <div class="event-header">
                <div class="event-checkbox">
                    <input type="checkbox" class="row-checkbox form-check-input" 
                           value="{{ event.pk }}">
                </div>
                <div class="event-status">
                    <span class="status-badge status-{{ event.status }}">
                        <i class="fas {% if event.status == 'published' %}fa-check-circle{% elif event.status == 'draft' %}fa-edit{% elif event.status == 'cancelled' %}fa-times-circle{% else %}fa-calendar-check{% endif %}"></i>
                        {{ event.get_status_display }}
                    </span>
                </div>
            </div>
            
            <div class="event-content">
                <h3 class="event-title">
                    <a href="{% url 'events:event_detail' event.pk %}">
                        {{ event.title }}
                    </a>
                </h3>
                <p class="event-preview">
                    {{ event.description|striptags|truncatewords:20 }}
                </p>
            </div>

            <div class="event-meta">
                <div class="meta-item">
                    <i class="fas fa-calendar"></i>
                    <span>{{ event.start_date|date:"M d, Y" }}</span>
                </div>
                <div class="meta-item">
                    <i class="fas fa-clock"></i>
                    <span>{{ event.start_date|date:"g:i A" }}</span>
                </div>
                <div class="meta-item">
                    <i class="fas {% if event.is_virtual %}fa-video{% else %}fa-map-marker-alt{% endif %}"></i>
                    <span>{% if event.is_virtual %}Virtual Event{% else %}{{ event.location }}{% endif %}</span>
                </div>
                <div class="meta-item">
                    <i class="fas fa-users"></i>
                    <span>{{ event.rsvps.count }} RSVPs</span>
                </div>
            </div>

            <div class="event-actions">
                <button class="btn btn-primary view-details-btn" 
                        data-event-id="{{ event.pk }}">
                    <i class="fas fa-eye me-1"></i>
                    View Details
                </button>
                {% if user.is_staff %}
                <a href="{% url 'events:event_update' event.pk %}" 
                   class="btn btn-warning">
                    <i class="fas fa-edit"></i>
                </a>
                <a href="{% url 'events:event_delete' event.pk %}" 
                   class="btn btn-danger"
                   data-event-id="{{ event.pk }}"
                   data-event-title="{{ event.title }}">
                    <i class="fas fa-trash"></i>
                </a>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Table View -->
    <div class="events-table" id="eventsTable">
        <table>
            <thead>
                <tr>
                    <th width="5%">
                        <input type="checkbox" id="selectAllTable" class="form-check-input">
                    </th>
                    <th width="25%">Title</th>
                    <th width="35%">Description</th>
                    <th width="15%">Status</th>
                    <th width="10%">Date</th>
                    <th width="10%">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for event in events %}
                <tr data-id="{{ event.pk }}">
                    <td>
                        <input type="checkbox" class="row-checkbox form-check-input table-checkbox" 
                               value="{{ event.pk }}">
                    </td>
                    <td>
                        <div class="table-title" onclick="openEventModal({{ event.pk }})">{{ event.title }}</div>
                        <div class="table-meta">
                            <span><i class="fas fa-calendar"></i> {{ event.start_date|date:"M d, Y" }}</span>
                            <span><i class="fas fa-users"></i> {{ event.rsvps.count }} RSVPs</span>
                        </div>
                    </td>
                    <td>
                        <div class="table-description">{{ event.description|truncatewords:20 }}</div>
                        <div class="table-meta">
                            <span><i class="fas {% if event.is_virtual %}fa-video{% else %}fa-map-marker-alt{% endif %}"></i> {% if event.is_virtual %}Virtual Event{% else %}{{ event.location }}{% endif %}</span>
                        </div>
                    </td>
                    <td>
                        <span class="status-badge status-{{ event.status }}">
                            <i class="fas {% if event.status == 'published' %}fa-check-circle{% elif event.status == 'draft' %}fa-edit{% elif event.status == 'cancelled' %}fa-times-circle{% else %}fa-calendar-check{% endif %}"></i>
                            {{ event.get_status_display }}
                        </span>
                    </td>
                    <td>
                        <div class="table-meta">
                            <span>{{ event.start_date|date:"M d, Y" }}</span>
                            <span>{{ event.start_date|date:"g:i A" }}</span>
                        </div>
                    </td>
                    <td>
                        <div class="table-actions">
                            <button class="table-action-btn view-details-btn" data-event-id="{{ event.pk }}">
                                <i class="fas fa-eye"></i>
                            </button>
                            {% if user.is_staff %}
                            <a href="{% url 'events:event_update' event.pk %}" class="table-action-btn">
                                <i class="fas fa-edit"></i>
                            </a>
                            <button class="table-action-btn delete-btn" data-event-id="{{ event.pk }}">
                                <i class="fas fa-trash"></i>
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% else %}
    <div class="text-center py-5">
        <div class="mb-4">
            <i class="fas fa-calendar-times fa-3x text-muted"></i>
        </div>
        <h4 class="text-muted mb-3">No events found</h4>
        <p class="text-muted">Get started by creating your first event.</p>
        {% if user.is_authenticated %}
        <a href="{% url 'events:event_create' %}" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>Create Event
        </a>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- Event Modal -->
<div class="modal" id="eventModal">
    <div class="modal-dialog">
        <div class="modal-header">
            <h2 class="modal-title">Event Details</h2>
            <button class="modal-close" onclick="closeEventModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" id="modalBody">
            <!-- Content will be loaded dynamically -->
        </div>
        <div class="modal-footer">
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeEventModal()">
                    <i class="fas fa-times me-1"></i>Close
                </button>
                <button class="btn btn-primary" id="modalEditBtn" style="display: none;">
                    <i class="fas fa-edit me-1"></i>Edit
                </button>
                <button class="btn btn-danger" id="modalDeleteBtn" style="display: none;">
                    <i class="fas fa-trash me-1"></i>Delete
                </button>
            </div>
            <div class="modal-share">
                <span class="me-2">Share:</span>
                <a href="#" class="modal-share-button share-facebook" data-platform="facebook">
                    <i class="fab fa-facebook-f"></i>
                </a>
                <a href="#" class="modal-share-button share-twitter" data-platform="twitter">
                    <i class="fab fa-twitter"></i>
                </a>
                <a href="#" class="modal-share-button share-linkedin" data-platform="linkedin">
                    <i class="fab fa-linkedin-in"></i>
                </a>
                <a href="#" class="modal-share-button share-whatsapp" data-platform="whatsapp">
                    <i class="fab fa-whatsapp"></i>
                </a>
                <a href="#" class="modal-share-button share-telegram" data-platform="telegram">
                    <i class="fab fa-telegram-plane"></i>
                </a>
                <a href="#" class="modal-share-button share-email" data-platform="email">
                    <i class="fas fa-envelope"></i>
                </a>
                <button class="modal-share-button share-copy" data-platform="copy">
                    <i class="fas fa-copy"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
class EventsTable {
    constructor() {
        this.selectedRows = new Set();
        this.searchInput = document.getElementById('searchInput');
        this.currentView = localStorage.getItem('eventsView') || 'card';
        this.initViewToggle();
        this.selectedCount = document.getElementById('selectedCount');
        this.filterButtons = document.querySelectorAll('.filter-button');
        this.cards = document.querySelectorAll('.event-card');
        
        this.init();
    }
    
    init() {
        this.setupSearch();
        this.setupFilters();
        this.setupCheckboxes();
        this.setInitialView();
    }
    
    initViewToggle() {
        const cardViewBtn = document.getElementById('cardViewBtn');
        const tableViewBtn = document.getElementById('tableViewBtn');
        const eventsGrid = document.getElementById('eventsGrid');
        const eventsTable = document.getElementById('eventsTable');
        
        if (cardViewBtn) {
            cardViewBtn.addEventListener('click', () => {
                this.switchView('card');
            });
        }
        
        if (tableViewBtn) {
            tableViewBtn.addEventListener('click', () => {
                this.switchView('table');
            });
        }
    }
    
    switchView(view) {
        const cardViewBtn = document.getElementById('cardViewBtn');
        const tableViewBtn = document.getElementById('tableViewBtn');
        const eventsGrid = document.getElementById('eventsGrid');
        const eventsTable = document.getElementById('eventsTable');
        
        // Update button states
        if (view === 'card') {
            cardViewBtn.classList.add('active');
            tableViewBtn.classList.remove('active');
            eventsGrid.style.display = 'grid';
            eventsTable.classList.remove('show');
        } else {
            tableViewBtn.classList.add('active');
            cardViewBtn.classList.remove('active');
            eventsGrid.style.display = 'none';
            eventsTable.classList.add('show');
        }
        
        // Save preference
        localStorage.setItem('eventsView', view);
        this.currentView = view;
    }
    
    setInitialView() {
        this.switchView(this.currentView);
    }
    
    setupSearch() {
        if (this.searchInput) {
            this.searchInput.addEventListener('input', this.debounce((e) => {
                this.filterCards();
            }, 300));
        }
    }
    
    setupFilters() {
        this.filterButtons.forEach(button => {
            button.addEventListener('click', () => {
                // Remove active class from all buttons
                this.filterButtons.forEach(btn => btn.classList.remove('active'));
                // Add active class to clicked button
                button.classList.add('active');
                
                this.filterCards();
            });
        });
    }
    
    setupCheckboxes() {
        // Select all checkbox
        const selectAllCheckbox = document.getElementById('selectAllTable');
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', (e) => {
                const checkboxes = document.querySelectorAll('.row-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = e.target.checked;
                    if (e.target.checked) {
                        this.selectedRows.add(checkbox.value);
                    } else {
                        this.selectedRows.delete(checkbox.value);
                    }
                });
                this.updateSelectedCount();
            });
        }
        
        // Individual checkboxes
        document.addEventListener('change', (e) => {
            if (e.target.classList.contains('row-checkbox')) {
                if (e.target.checked) {
                    this.selectedRows.add(e.target.value);
                } else {
                    this.selectedRows.delete(e.target.value);
                }
                this.updateSelectedCount();
            }
        });
    }
    
    filterCards() {
        const searchTerm = this.searchInput.value.toLowerCase();
        const activeFilter = document.querySelector('.filter-button.active').dataset.filter;
        
        this.cards.forEach(card => {
            const title = card.querySelector('.event-title').textContent.toLowerCase();
            const description = card.querySelector('.event-description').textContent.toLowerCase();
            const status = card.querySelector('.status-badge').classList.contains(`status-${activeFilter}`);
            
            const matchesSearch = title.includes(searchTerm) || description.includes(searchTerm);
            const matchesFilter = activeFilter === 'all' || status;
            
            if (matchesSearch && matchesFilter) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    }
    
    updateSelectedCount() {
        if (this.selectedCount) {
            this.selectedCount.textContent = this.selectedRows.size;
        }
    }
    
    debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
}

// Initialize the events table
document.addEventListener('DOMContentLoaded', function() {
    new EventsTable();
});

// Handle view details button clicks
document.addEventListener('click', (e) => {
    if (e.target.closest('.view-details-btn')) {
        const button = e.target.closest('.view-details-btn');
        const eventId = button.dataset.eventId;
        openEventModal(eventId);
    }
});

// SweetAlert Utils
const SweetAlertUtils = {
    confirmDelete: (title, text) => {
        return Swal.fire({
            title: title,
            text: text,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, delete it!'
        });
    },
    
    success: (title, text) => {
        return Swal.fire({
            title: title,
            text: text,
            icon: 'success',
            confirmButtonText: 'OK'
        });
    },
    
    error: (title, text) => {
        return Swal.fire({
            title: title,
            text: text,
            icon: 'error',
            confirmButtonText: 'OK'
        });
    }
};

function handleExport() {
    SweetAlertUtils.success('Export Started', 'Exporting all events...');
}

// Modal Functions
function openEventModal(eventId) {
    console.log('Opening modal for event ID:', eventId);
    
    if (!eventId || eventId === 'undefined') {
        console.error('Invalid event ID:', eventId);
        alert('Error: Invalid event ID');
        return;
    }
    
    const modal = document.getElementById('eventModal');
    const modalBody = document.getElementById('modalBody');
    const modalEditBtn = document.getElementById('modalEditBtn');
    const modalDeleteBtn = document.getElementById('modalDeleteBtn');
            
    // Show loading state
    modalBody.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading event details...</p>
        </div>
    `;
    
    // Show modal
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
    
    // Fetch event details
    console.log('Fetching from URL:', `/events/${eventId}/modal/`);
    fetch(`/events/${eventId}/modal/`)
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.text();
        })
        .then(html => {
            console.log('Received HTML response');
            // The response is already the modal content
            modalBody.innerHTML = html;
            
            // Show action buttons only for staff users
            const isAuthenticated = document.body.dataset.userAuthenticated === 'true';
            const isStaff = document.body.dataset.userIsStaff === 'true';
            
            if (modalEditBtn && modalDeleteBtn && isAuthenticated && isStaff) {
                modalEditBtn.style.display = 'inline-block';
                modalDeleteBtn.style.display = 'inline-block';
                
                modalEditBtn.onclick = () => {
                    window.location.href = `/events/${eventId}/update/`;
                };
                
                modalDeleteBtn.onclick = () => {
                    const eventTitle = document.querySelector('#eventModal .modal-title').textContent;
                    deleteEvent(eventId, eventTitle);
                };
            }
            
            // Setup RSVP form handler for regular users
            if (isAuthenticated && !isStaff) {
                const rsvpForm = modalBody.querySelector('.rsvp-form');
                if (rsvpForm) {
                    rsvpForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        
                        const submitBtn = rsvpForm.querySelector('button[type="submit"]');
                        const originalBtnText = submitBtn.innerHTML;
                        
                        // Disable button and show loading state
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Submitting...';
                        
                        const formData = new FormData(rsvpForm);
                        
                        fetch(rsvpForm.action, {
                            method: 'POST',
                            body: formData,
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest',
                                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            // Re-enable button
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = originalBtnText;
                            
                            if (data.success) {
                                // Show success alert
                                Swal.fire({
                                    icon: 'success',
                                    title: 'RSVP Recorded!',
                                    text: data.message,
                                    confirmButtonText: 'OK',
                                    confirmButtonColor: '#2b3c6b'
                                });
                            } else {
                                // Show error alert
                                Swal.fire({
                                    icon: 'error',
                                    title: 'RSVP Failed',
                                    text: data.message || 'There was an error submitting your RSVP. Please try again.',
                                    confirmButtonText: 'OK',
                                    confirmButtonColor: '#2b3c6b'
                                });
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            
                            // Re-enable button
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = originalBtnText;
                            
                            // Show error alert
                            Swal.fire({
                                icon: 'error',
                                title: 'Connection Error',
                                text: 'Unable to submit your RSVP. Please check your connection and try again.',
                                confirmButtonText: 'OK',
                                confirmButtonColor: '#2b3c6b'
                            });
                        });
                    });
                }
            }
        })
        .catch(error => {
            console.error('Error loading event:', error);
            console.error('Error details:', error.message);
            modalBody.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                    <h4>Error Loading Event</h4>
                    <p class="text-muted">Unable to load event details. Please try again.</p>
                    <p class="text-danger small">Error: ${error.message}</p>
                    <button class="btn btn-primary" onclick="openEventModal('${eventId}')">
                        <i class="fas fa-refresh me-1"></i>
                        Retry
                    </button>
                </div>
            `;
        });
}

function closeEventModal() {
    const modal = document.getElementById('eventModal');
    modal.classList.remove('show');
    document.body.style.overflow = 'auto';
}

// Handle modal backdrop clicks
document.addEventListener('click', (e) => {
    const modal = document.getElementById('eventModal');
    const modalDialog = modal.querySelector('.modal-dialog');
    
    if (e.target === modal && !modalDialog.contains(e.target)) {
        closeEventModal();
    }
});

// Handle escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeEventModal();
    }
});

// Handle share button clicks
document.addEventListener('click', (e) => {
    if (e.target.closest('.modal-share-button')) {
        e.preventDefault();
        e.stopPropagation();
        handleShareClick(e.target.closest('.modal-share-button'));
    }
});

function handleShareClick(button) {
    const platform = button.dataset.platform;
    const currentUrl = window.location.href;
    const eventTitle = document.querySelector('.modal-title').textContent;
    
    switch(platform) {
        case 'facebook':
            shareToFacebook(currentUrl, eventTitle);
            break;
        case 'twitter':
            shareToTwitter(currentUrl, eventTitle);
            break;
        case 'linkedin':
            shareToLinkedIn(currentUrl, eventTitle);
            break;
        case 'whatsapp':
            shareToWhatsApp(currentUrl, eventTitle);
            break;
        case 'telegram':
            shareToTelegram(currentUrl, eventTitle);
            break;
        case 'email':
            shareToEmail(currentUrl, eventTitle);
            break;
        case 'copy':
            copyToClipboard(currentUrl);
            break;
    }
}

function shareToFacebook(url, title) {
    window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`, '_blank');
}

function shareToTwitter(url, title) {
    window.open(`https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}&text=${encodeURIComponent(title)}`, '_blank');
}

function shareToLinkedIn(url, title) {
    window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}`, '_blank');
}

function shareToWhatsApp(url, title) {
    window.open(`https://wa.me/?text=${encodeURIComponent(title + ' ' + url)}`, '_blank');
}

function shareToTelegram(url, title) {
    window.open(`https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(title)}`, '_blank');
}

function shareToEmail(url, title) {
    window.open(`mailto:?subject=${encodeURIComponent(title)}&body=${encodeURIComponent(url)}`, '_blank');
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        SweetAlertUtils.success('Copied!', 'Link copied to clipboard');
    }).catch(() => {
        SweetAlertUtils.error('Error', 'Failed to copy link');
    });
}

// Delete event functionality with SweetAlert and AJAX
function deleteEvent(eventId, eventTitle) {
    Swal.fire({
        title: 'Delete Event',
        html: `Are you sure you want to delete <strong>"${eventTitle}"</strong>?<br><br><small class="text-muted">This action cannot be undone.</small>`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: '<i class="fas fa-trash me-1"></i>Yes, delete it!',
        cancelButtonText: '<i class="fas fa-times me-1"></i>Cancel',
        reverseButtons: true,
        focusCancel: true
    }).then((result) => {
        if (result.isConfirmed) {
            // Show loading
            Swal.fire({
                title: 'Deleting Event...',
                text: 'Please wait while we delete the event.',
                allowOutsideClick: false,
                allowEscapeKey: false,
                showConfirmButton: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // Make AJAX request to delete event
            const deleteUrl = `/events/${eventId}/delete/`;
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                              document.querySelector('input[name="csrfmiddlewaretoken"]')?.value ||
                              getCookie('csrftoken');
            
            fetch(deleteUrl, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.message || 'Failed to delete event');
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    Swal.fire({
                        title: 'Deleted!',
                        text: data.message || 'The event has been deleted.',
                        icon: 'success',
                        confirmButtonText: 'OK'
                    }).then(() => {
                        // Reload the page to reflect the changes
                        window.location.reload();
                    });
                } else {
                    throw new Error(data.message || 'Failed to delete event');
                }
            })
            .catch(error => {
                Swal.fire({
                    title: 'Error!',
                    text: error.message || 'An error occurred while deleting the event.',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            });
        }
    });
}

// Helper function to get CSRF token from cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Initialize delete button event handlers
document.addEventListener('DOMContentLoaded', function() {
    // Handle card view delete buttons
    document.querySelectorAll('.event-card .btn-danger').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            // Get ID from data attribute (preferred) or fallback to parsing href
            let eventId = this.getAttribute('data-event-id');
            let eventTitle = this.getAttribute('data-event-title');
            
            // Fallback: try to extract from href if data attributes not available
            if (!eventId) {
                const href = this.getAttribute('href');
                if (href) {
                    // Extract ID from href like /events/123/delete/
                    const parts = href.split('/').filter(part => part !== '' && !isNaN(part));
                    eventId = parts.find(part => !isNaN(parseInt(part)));
                }
            }
            
            // Fallback: try to get title from DOM
            if (!eventTitle) {
                const titleElement = this.closest('.event-card')?.querySelector('.event-title a');
                eventTitle = titleElement ? titleElement.textContent.trim() : 'this event';
            }
            
            if (!eventId) {
                console.error('Could not determine event ID');
                Swal.fire({
                    title: 'Error!',
                    text: 'Could not determine event ID',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
                return;
            }
            
            deleteEvent(eventId, eventTitle);
        });
    });
    
    // Handle table view delete buttons
    document.querySelectorAll('.delete-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const eventId = this.getAttribute('data-id') || this.getAttribute('data-event-id');
            const eventTitle = this.closest('tr')?.querySelector('.table-title')?.textContent?.trim() || 'this event';
            
            if (!eventId) {
                console.error('Could not determine event ID');
                Swal.fire({
                    title: 'Error!',
                    text: 'Could not determine event ID',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
                return;
            }
            
            deleteEvent(eventId, eventTitle);
        });
    });
});
</script>
{% endblock %}
