{% extends "base.html" %}
{% load static %}
{% load mentorship_extras %}

{% block title %}Mentor Dashboard{% endblock %}

{% block extra_css %}
<style>
:root {
  --bs-primary: #2b3c6b;
  --bs-primary-rgb: 43, 60, 107;
  --primary-color: #2b3c6b;
  --feedback-success: #48bb78;
  --feedback-warning: #ed8936;
  --feedback-info: #4299e1;
  --text-light: #ffffff;
  --ui-border: #e2e8f0;
  --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
  --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
}

/* Metric Cards (Matching Admin Dashboard) */
.metric-card {
  background: var(--ui-surface);
  border-radius: 0.375rem;
  padding: 1.5rem;
  margin-bottom: 1.5rem;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--ui-border);
  transition: all 0.3s ease;
  height: 100%;
}

.metric-card:hover {
  box-shadow: var(--shadow-md);
  transform: translateY(-2px);
}

.metric-card.bg-primary {
  background: var(--primary-color) !important;
  border-color: var(--primary-color);
}

.metric-card.bg-success {
  background: var(--feedback-success) !important;
  border-color: var(--feedback-success);
}

.metric-card.bg-info {
  background: var(--feedback-info) !important;
  border-color: var(--feedback-info);
}

.metric-card.bg-warning {
  background: var(--feedback-warning) !important;
  border-color: var(--feedback-warning);
}

.metric-card h3 {
  font-size: 2rem;
  font-weight: 700;
  margin-bottom: 0.5rem;
  color: var(--text-light);
}

.metric-card p {
  font-size: 1rem;
  font-weight: 600;
  margin-bottom: 0.25rem;
  color: var(--text-light);
}

.metric-card small {
  font-size: 0.875rem;
  opacity: 0.8;
  color: var(--text-light);
}

.metric-card i {
  opacity: 0.8;
  color: var(--text-light);
}

.card-hover {
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.card-hover:hover {
  transform: translateY(-4px);
  box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.15) !important;
}

.letter-spacing-1 {
  letter-spacing: 0.5px;
}

.progress-bar-gradient {
  background: linear-gradient(90deg, #4481eb 0%, #04befe 100%);
}

.milestone-marker {
  position: absolute;
  top: 50%;
  transform: translate(-50%, -50%);
  width: 12px;
  height: 12px;
  background: white;
  border: 2px solid #4481eb;
  border-radius: 50%;
  z-index: 2;
}

@media (max-width: 767.98px) {
  .btn-sm {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
  }
  
  .display-4 {
    font-size: 2rem;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-3 px-lg-4 py-4">
  
  <!-- Dashboard Header -->
  <div class="bg-primary text-white p-4 rounded-bottom shadow-sm mb-4">
    <div class="row align-items-center">
      <div class="col-lg-8">
        <div class="d-flex align-items-center gap-3">
          {% if mentor.user.profile.avatar %}
            <img src="{{ mentor.user.profile.avatar.url }}" 
                 alt="{{ mentor.user.get_full_name }}" 
                 class="rounded-circle border border-3 border-white shadow-sm" 
                 style="width: 60px; height: 60px; object-fit: cover;">
          {% else %}
            <div class="rounded-circle border border-3 border-white shadow-sm bg-white text-primary d-flex align-items-center justify-content-center" 
                 style="width: 60px; height: 60px; font-size: 1.5rem; font-weight: bold;">
              {{ mentor.user.get_full_name|slice:":1"|upper }}
            </div>
          {% endif %}
          <div>
            <h2 class="mb-1 fw-semibold">Welcome back, {{ mentor.user.get_full_name }}</h2>
            <p class="mb-0 text-white-50 small">
              {% if mentor.user.profile.current_position %}
                <i class="fas fa-briefcase me-1"></i> {{ mentor.user.profile.current_position }}
              {% endif %}
            </p>
          </div>
        </div>
      </div>
      <div class="col-lg-4 text-lg-end mt-3 mt-lg-0">
        {% if not is_disabled %}
          <div class="form-check form-switch d-inline-block me-3">
            <input class="form-check-input" type="checkbox" id="availabilityToggle" 
                   {% if mentor.accepting_mentees %}checked{% endif %}
                   onchange="toggleAvailability()">
            <label class="form-check-label text-white" for="availabilityToggle">
              Available for Mentees
            </label>
          </div>
          <a href="{% url 'accounts:profile_detail' mentor.user.username %}" 
             class="btn btn-outline-light btn-sm">
            <i class="fas fa-edit me-1"></i> Edit Profile
          </a>
        {% else %}
          <div class="alert alert-warning mb-0">
            <i class="fas fa-exclamation-triangle me-2"></i>
            Your mentor account is currently disabled.
            {% if has_pending_reactivation %}
              <br><small>Reactivation request pending approval.</small>
            {% endif %}
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Analytics Cards -->
  <div class="row mb-4">
    <!-- Active Mentees Card -->
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="metric-card bg-primary">
        <div class="d-flex justify-content-between">
          <div>
            <h3>{{ total_active_mentees|default:0 }}</h3>
            <p>Active Mentees</p>
            <small>Currently mentoring</small>
          </div>
          <div class="align-self-center">
            <i class="fas fa-users fa-2x"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Pending Requests Card -->
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="metric-card bg-warning">
        <div class="d-flex justify-content-between">
          <div>
            <h3>{{ total_pending_requests|default:0 }}</h3>
            <p>Pending Requests</p>
            <small>Awaiting response</small>
          </div>
          <div class="align-self-center">
            <i class="fas fa-clock fa-2x"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Upcoming Meetings Card -->
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="metric-card bg-info">
        <div class="d-flex justify-content-between">
          <div>
            <h3>{{ upcoming_meetings.count|default:0 }}</h3>
            <p>Upcoming Meetings</p>
            <small>Scheduled sessions</small>
          </div>
          <div class="align-self-center">
            <i class="fas fa-calendar-alt fa-2x"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Unread Messages Card -->
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="metric-card bg-success">
        <div class="d-flex justify-content-between">
          <div>
            <h3>{{ unread_messages|default:0 }}</h3>
            <p>Unread Messages</p>
            <small>New conversations</small>
          </div>
          <div class="align-self-center">
            <i class="fas fa-envelope fa-2x"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="row g-4">
    <!-- Left Column -->
    <div class="col-lg-8">
      
      <!-- Pending Requests Section -->
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white border-bottom py-3">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0 fw-semibold">Pending Requests</h5>
            {% if pending_requests %}
            <span class="badge bg-warning text-dark">{{ pending_requests.count }}</span>
            {% endif %}
          </div>
        </div>
        {% if pending_requests %}
        <div class="card-body p-0">
          <ul class="list-group list-group-flush">
            {% for request in pending_requests %}
            <li class="list-group-item py-3">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <h6 class="mb-1 fw-semibold">{{ request.mentee.get_full_name }}</h6>
                <small class="text-muted">{{ request.created_at|timesince }} ago</small>
              </div>
              <p class="mb-2 text-muted small">{{ request.message|truncatewords:30 }}</p>
              <div class="d-flex gap-2">
                <button class="btn btn-sm btn-success" onclick="updateRequestStatus({{ request.id }}, 'APPROVED')">
                  <i class="fas fa-check me-1"></i> Accept
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="updateRequestStatus({{ request.id }}, 'REJECTED')">
                  <i class="fas fa-times me-1"></i> Decline
                </button>
              </div>
            </li>
            {% endfor %}
          </ul>
        </div>
        {% else %}
        <div class="card-body text-center py-4">
          <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
          <p class="text-muted mb-0">No pending requests</p>
        </div>
        {% endif %}
      </div>

      <!-- Active Mentorships Section -->
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white border-bottom py-3">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0 fw-semibold">Active Mentorships</h5>
            {% if active_mentorships %}
            <span class="badge bg-primary">{{ active_mentorships.count }}</span>
            {% endif %}
          </div>
        </div>
        <div class="card-body">
          {% if active_mentorships %}
          <div class="accordion accordion-flush" id="mentorshipAccordion">
            {% for mentorship in active_mentorships %}
            <div class="accordion-item border rounded mb-3">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" 
                        data-bs-toggle="collapse" data-bs-target="#mentorship-{{ mentorship.id }}">
                  <span class="fw-semibold me-2">{{ mentorship.mentee.get_full_name }}</span>
                  <span class="badge bg-primary">{{ mentorship.get_status_display }}</span>
                </button>
              </h2>
              <div id="mentorship-{{ mentorship.id }}" class="accordion-collapse collapse">
                <div class="accordion-body">
                  
                  <!-- Progress Bar -->
                  <div class="mb-3">
                    <div class="d-flex justify-content-between mb-2">
                      <small class="text-muted fw-semibold">Overall Progress</small>
                      <small class="text-muted fw-semibold">{{ mentorship.progress_percentage|default:0 }}%</small>
                    </div>
                    <div class="progress" style="height: 24px;">
                      <div class="progress-bar progress-bar-gradient" role="progressbar" 
                           style="width: {{ mentorship.progress_percentage|default:0 }}%">
                        {{ mentorship.progress_percentage|default:0 }}%
                      </div>
                    </div>
                  </div>

                  <!-- Goals and Skills -->
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <h6 class="fw-semibold mb-2">Goals</h6>
                      <p class="small text-muted">{{ mentorship.goals|default:"No goals set yet" }}</p>
                    </div>
                    <div class="col-md-6">
                      <h6 class="fw-semibold mb-2">Skills Seeking</h6>
                      <p class="small text-muted">{{ mentorship.skills_seeking|default:"No skills specified" }}</p>
                    </div>
                  </div>

                  <!-- Timeline -->
                  {% if mentorship.timeline_milestones %}
                  <div class="mb-3">
                    <h6 class="fw-semibold mb-2">Timeline Milestones</h6>
                    <div class="bg-light p-3 rounded">
                      <pre class="mb-0 small">{{ mentorship.timeline_milestones }}</pre>
                    </div>
                  </div>
                  {% endif %}

                  <!-- Action Buttons -->
                  <div class="d-flex gap-2 flex-wrap">
                    <button class="btn btn-sm btn-primary" 
                            data-bs-toggle="modal" 
                            data-bs-target="#scheduleMeetingModal"
                            onclick="setMentorshipId({{ mentorship.id }})">
                      <i class="fas fa-calendar-plus me-1"></i> Schedule Meeting
                    </button>
                    <button class="btn btn-sm btn-secondary"
                            data-bs-toggle="modal"
                            data-bs-target="#sendMessageModal"
                            onclick="setMenteeInfo({{ mentorship.id }}, '{{ mentorship.mentee.get_full_name|escapejs }}')">
                      <i class="fas fa-envelope me-1"></i> Send Message
                    </button>
                    <button class="btn btn-sm btn-info"
                            data-bs-toggle="modal"
                            data-bs-target="#progressUpdateModal"
                            onclick="setMentorshipId({{ mentorship.id }})">
                      <i class="fas fa-chart-line me-1"></i> Update Progress
                    </button>
                    <button class="btn btn-sm btn-outline-secondary"
                            data-bs-toggle="modal"
                            data-bs-target="#timelineModal"
                            onclick="setMentorshipId({{ mentorship.id }})">
                      <i class="fas fa-tasks me-1"></i> Manage Timeline
                    </button>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="text-center py-4">
            <i class="fas fa-user-friends fa-2x text-muted mb-2"></i>
            <p class="text-muted mb-0">No active mentorships</p>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Recent Progress Updates Section -->
      {% if recent_progress %}
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white border-bottom py-3">
          <h5 class="mb-0 fw-semibold">Recent Progress Updates</h5>
        </div>
        <div class="card-body p-0">
          <ul class="list-group list-group-flush">
            {% for progress in recent_progress %}
            <li class="list-group-item py-3">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                  <h6 class="mb-1 fw-semibold">{{ progress.mentorship.mentee.get_full_name }}</h6>
                  <small class="text-muted">
                    <i class="far fa-clock me-1"></i> {{ progress.created_at|timesince }} ago
                    {% if progress.created_by %}
                      by {{ progress.created_by.get_full_name }}
                    {% endif %}
                  </small>
                </div>
                {% if progress.mentorship.progress_percentage %}
                <span class="badge bg-primary">{{ progress.mentorship.progress_percentage }}%</span>
                {% endif %}
              </div>
              <p class="mb-0 small text-muted">{{ progress.notes|truncatewords:30 }}</p>
            </li>
            {% endfor %}
          </ul>
        </div>
      </div>
      {% endif %}

      <!-- Completed Mentorships Section -->
      {% if completed_mentorships %}
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white border-bottom py-3">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0 fw-semibold">Completed Mentorships</h5>
            <button class="btn btn-link text-decoration-none p-0" 
                    data-bs-toggle="collapse" data-bs-target="#completedMentorships">
              <i class="fas fa-chevron-down"></i> Show
            </button>
          </div>
        </div>
        <div id="completedMentorships" class="collapse">
          <div class="card-body p-0">
            <ul class="list-group list-group-flush">
              {% for mentorship in completed_mentorships %}
              <li class="list-group-item">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <h6 class="mb-1 fw-semibold">{{ mentorship.mentee.get_full_name }}</h6>
                    <small class="text-muted">Completed on {{ mentorship.end_date|date:"F d, Y" }}</small>
                  </div>
                  <span class="badge bg-success">Completed</span>
                </div>
              </li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>
      {% endif %}



    </div>

    <!-- Right Column - Upcoming Meetings -->
    <div class="col-lg-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white border-bottom py-3">
          <h5 class="mb-0 fw-semibold">Upcoming Meetings</h5>
        </div>
        <div class="card-body">
          {% if upcoming_meetings %}
            {% for meeting in upcoming_meetings %}
            <div class="{% if not forloop.last %}border-bottom{% endif %} py-3">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <h6 class="mb-1 fw-semibold">{{ meeting.title }}</h6>
                <small class="text-muted">{{ meeting.meeting_date|date:"M d" }}</small>
              </div>
              <p class="mb-2 small text-muted">
                with {{ meeting.mentorship.mentee.get_full_name }}<br>
                <i class="far fa-clock me-1"></i> {{ meeting.meeting_date|date:"h:i a" }}
              </p>
              {% if meeting.meeting_link %}
              <a href="{{ meeting.meeting_link }}" target="_blank" class="btn btn-primary w-100 mb-2">
                <i class="fas fa-video me-2"></i>Join Meeting
              </a>
              {% endif %}
              <button class="btn btn-sm btn-outline-danger w-100" 
                      onclick="cancelMeeting({{ meeting.id }})">
                <i class="fas fa-trash-alt me-1"></i>Cancel Meeting
              </button>
            </div>
            {% endfor %}
          {% else %}
            <div class="text-center py-4">
              <i class="far fa-calendar-times fa-3x text-muted mb-3"></i>
              <p class="text-muted mb-0">No upcoming meetings</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Modals -->

<!-- Schedule Meeting Modal -->
<div class="modal fade" id="scheduleMeetingModal" tabindex="-1" aria-labelledby="scheduleMeetingModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="scheduleMeetingModalLabel">Schedule Meeting</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="scheduleMeetingForm">
          <input type="hidden" id="meetingMentorshipId" name="mentorship_id">
          
          <div class="mb-3">
            <label for="meetingTitle" class="form-label">Meeting Title</label>
            <input type="text" class="form-control" id="meetingTitle" name="title" required>
          </div>
          
          <div class="mb-3">
            <label for="meetingDate" class="form-label">Date & Time</label>
            <input type="datetime-local" class="form-control" id="meetingDate" name="meeting_date" required>
          </div>
          
          <div class="mb-3">
            <label for="meetingLink" class="form-label">Meeting Link (Optional)</label>
            <input type="url" class="form-control" id="meetingLink" name="meeting_link" 
                   placeholder="https://zoom.us/j/...">
            <div class="form-text">Add a video call link for virtual meetings</div>
          </div>
          
          <div class="mb-3">
            <label for="meetingNotes" class="form-label">Notes (Optional)</label>
            <textarea class="form-control" id="meetingNotes" name="notes" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="scheduleMeeting()">
          <span class="spinner-border spinner-border-sm d-none" id="scheduleMeetingSpinner"></span>
          Schedule Meeting
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Send Message Modal -->
<div class="modal fade" id="sendMessageModal" tabindex="-1" aria-labelledby="sendMessageModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="sendMessageModalLabel">Send Message</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="sendMessageForm">
          <input type="hidden" id="messageMentorshipId" name="mentorship_id">
          
          <div class="mb-3">
            <label class="form-label">To:</label>
            <p class="fw-semibold" id="messageRecipient"></p>
          </div>
          
          <div class="mb-3">
            <label for="messageSubject" class="form-label">Subject</label>
            <input type="text" class="form-control" id="messageSubject" name="subject" required>
          </div>
          
          <div class="mb-3">
            <label for="messageContent" class="form-label">Message</label>
            <textarea class="form-control" id="messageContent" name="content" rows="5" required></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="sendMessage()">
          <span class="spinner-border spinner-border-sm d-none" id="sendMessageSpinner"></span>
          Send Message
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Progress Update Modal -->
<div class="modal fade" id="progressUpdateModal" tabindex="-1" aria-labelledby="progressUpdateModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="progressUpdateModalLabel">Update Progress</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="progressUpdateForm">
          <input type="hidden" id="progressMentorshipId" name="mentorship_id">
          
          <div class="mb-3">
            <label for="progressPercentage" class="form-label">Progress Percentage</label>
            <input type="range" class="form-range" id="progressPercentage" name="progress_percentage" 
                   min="0" max="100" value="0" oninput="updateProgressLabel(this.value)">
            <div class="d-flex justify-content-between">
              <small class="text-muted">0%</small>
              <small class="fw-semibold" id="progressLabel">0%</small>
              <small class="text-muted">100%</small>
            </div>
          </div>
          
          <div class="mb-3">
            <label for="progressNotes" class="form-label">Progress Notes</label>
            <textarea class="form-control" id="progressNotes" name="notes" rows="4" required></textarea>
            <div class="form-text">Describe the progress made and any achievements</div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="updateProgress()">
          <span class="spinner-border spinner-border-sm d-none" id="progressUpdateSpinner"></span>
          Update Progress
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Timeline Management Modal -->
<div class="modal fade" id="timelineModal" tabindex="-1" aria-labelledby="timelineModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="timelineModalLabel">Manage Timeline</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="timelineForm">
          <input type="hidden" id="timelineMentorshipId" name="mentorship_id">
          
          <div class="mb-3">
            <label for="expectedEndDate" class="form-label">Expected End Date</label>
            <input type="date" class="form-control" id="expectedEndDate" name="expected_end_date">
          </div>
          
          <div class="mb-3">
            <label for="timelineMilestones" class="form-label">Timeline Milestones</label>
            <textarea class="form-control" id="timelineMilestones" name="timeline_milestones" rows="8"
                      placeholder="Week/Day 1: Initial meeting and goal setting&#10;Week/Day 2: First project review&#10;Week/Day 3: Mid-point assessment"></textarea>
            <div class="form-text">Enter milestones one per line</div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="updateTimeline()">
          <span class="spinner-border spinner-border-sm d-none" id="timelineUpdateSpinner"></span>
          Update Timeline
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// CSRF Token Setup
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

const csrftoken = getCookie('csrftoken');

// Toast Notification Function
function showToast(message, type = 'success') {
  const toastContainer = document.getElementById('toastContainer') || createToastContainer();
  
  const toastEl = document.createElement('div');
  toastEl.className = `toast align-items-center text-white bg-${type} border-0`;
  toastEl.setAttribute('role', 'alert');
  toastEl.setAttribute('aria-live', 'assertive');
  toastEl.setAttribute('aria-atomic', 'true');
  
  toastEl.innerHTML = `
    <div class="d-flex">
      <div class="toast-body">${message}</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  `;
  
  toastContainer.appendChild(toastEl);
  const toast = new bootstrap.Toast(toastEl);
  toast.show();
  
  toastEl.addEventListener('hidden.bs.toast', () => {
    toastEl.remove();
  });
}

function createToastContainer() {
  const container = document.createElement('div');
  container.id = 'toastContainer';
  container.className = 'toast-container position-fixed top-0 end-0 p-3';
  container.style.zIndex = '9999';
  document.body.appendChild(container);
  return container;
}

// Toggle Availability
function toggleAvailability() {
  const checkbox = document.getElementById('availabilityToggle');
  const isAvailable = checkbox.checked;
  
  fetch(`/api/mentors/{{ mentor.id }}/toggle_availability/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrftoken
    },
    body: JSON.stringify({ is_available: isAvailable })
  })
  .then(response => response.json())
  .then(data => {
    showToast(data.message, 'success');
  })
  .catch(error => {
    console.error('Error:', error);
    showToast('Failed to update availability', 'danger');
    checkbox.checked = !isAvailable;
  });
}

// Update Request Status
function updateRequestStatus(requestId, status) {
  if (!confirm(`Are you sure you want to ${status.toLowerCase()} this request?`)) {
    return;
  }
  
  fetch(`/mentorship/requests/${requestId}/update_status/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrftoken
    },
    body: JSON.stringify({ status: status })
  })
  .then(response => response.json())
  .then(data => {
    showToast(data.message, 'success');
    setTimeout(() => location.reload(), 1000);
  })
  .catch(error => {
    console.error('Error:', error);
    showToast('Failed to update request status', 'danger');
  });
}

// Modal Helper Functions
function setMentorshipId(mentorshipId) {
  document.getElementById('meetingMentorshipId').value = mentorshipId;
  document.getElementById('progressMentorshipId').value = mentorshipId;
  document.getElementById('timelineMentorshipId').value = mentorshipId;
}

function setMenteeInfo(mentorshipId, menteeName) {
  document.getElementById('messageMentorshipId').value = mentorshipId;
  document.getElementById('messageRecipient').textContent = menteeName;
}

// Schedule Meeting
function scheduleMeeting() {
  const form = document.getElementById('scheduleMeetingForm');
  const formData = new FormData(form);
  const spinner = document.getElementById('scheduleMeetingSpinner');
  
  if (!form.checkValidity()) {
    form.reportValidity();
    return;
  }
  
  spinner.classList.remove('d-none');
  
  fetch('/api/mentorship-meetings/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrftoken
    },
    body: JSON.stringify(Object.fromEntries(formData))
  })
  .then(response => response.json())
  .then(data => {
    showToast('Meeting scheduled successfully', 'success');
    bootstrap.Modal.getInstance(document.getElementById('scheduleMeetingModal')).hide();
    form.reset();
    setTimeout(() => location.reload(), 1000);
  })
  .catch(error => {
    console.error('Error:', error);
    showToast('Failed to schedule meeting', 'danger');
  })
  .finally(() => {
    spinner.classList.add('d-none');
  });
}

// Send Message
function sendMessage() {
  const form = document.getElementById('sendMessageForm');
  const formData = new FormData(form);
  const spinner = document.getElementById('sendMessageSpinner');
  
  if (!form.checkValidity()) {
    form.reportValidity();
    return;
  }
  
  spinner.classList.remove('d-none');
  
  fetch('/api/mentorship-messages/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrftoken
    },
    body: JSON.stringify(Object.fromEntries(formData))
  })
  .then(response => response.json())
  .then(data => {
    showToast('Message sent successfully', 'success');
    bootstrap.Modal.getInstance(document.getElementById('sendMessageModal')).hide();
    form.reset();
  })
  .catch(error => {
    console.error('Error:', error);
    showToast('Failed to send message', 'danger');
  })
  .finally(() => {
    spinner.classList.add('d-none');
  });
}

// Update Progress
function updateProgressLabel(value) {
  document.getElementById('progressLabel').textContent = value + '%';
}

function updateProgress() {
  const form = document.getElementById('progressUpdateForm');
  const formData = new FormData(form);
  const spinner = document.getElementById('progressUpdateSpinner');
  const mentorshipId = document.getElementById('progressMentorshipId').value;
  
  if (!form.checkValidity()) {
    form.reportValidity();
    return;
  }
  
  spinner.classList.remove('d-none');
  
  fetch(`/api/mentorship-requests/${mentorshipId}/update_timeline/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrftoken
    },
    body: JSON.stringify({
      progress_percentage: parseInt(formData.get('progress_percentage')),
      notes: formData.get('notes')
    })
  })
  .then(response => response.json())
  .then(data => {
    showToast('Progress updated successfully', 'success');
    bootstrap.Modal.getInstance(document.getElementById('progressUpdateModal')).hide();
    form.reset();
    setTimeout(() => location.reload(), 1000);
  })
  .catch(error => {
    console.error('Error:', error);
    showToast('Failed to update progress', 'danger');
  })
  .finally(() => {
    spinner.classList.add('d-none');
  });
}

// Update Timeline
function updateTimeline() {
  const form = document.getElementById('timelineForm');
  const formData = new FormData(form);
  const spinner = document.getElementById('timelineUpdateSpinner');
  const mentorshipId = document.getElementById('timelineMentorshipId').value;
  
  spinner.classList.remove('d-none');
  
  fetch(`/api/mentorship-requests/${mentorshipId}/update_timeline/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrftoken
    },
    body: JSON.stringify({
      expected_end_date: formData.get('expected_end_date'),
      timeline_milestones: formData.get('timeline_milestones')
    })
  })
  .then(response => response.json())
  .then(data => {
    showToast('Timeline updated successfully', 'success');
    bootstrap.Modal.getInstance(document.getElementById('timelineModal')).hide();
    form.reset();
    setTimeout(() => location.reload(), 1000);
  })
  .catch(error => {
    console.error('Error:', error);
    showToast('Failed to update timeline', 'danger');
  })
  .finally(() => {
    spinner.classList.add('d-none');
  });
}

// Cancel Meeting
function cancelMeeting(meetingId) {
  if (!confirm('Are you sure you want to cancel this meeting?')) {
    return;
  }
  
  fetch(`/api/mentorship-meetings/${meetingId}/`, {
    method: 'DELETE',
    headers: {
      'X-CSRFToken': csrftoken
    }
  })
  .then(response => {
    if (response.ok) {
      showToast('Meeting cancelled successfully', 'success');
      setTimeout(() => location.reload(), 1000);
    } else {
      throw new Error('Failed to cancel meeting');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showToast('Failed to cancel meeting', 'danger');
  });
}

// Initialize Bootstrap components
document.addEventListener('DOMContentLoaded', function() {
  // Initialize tooltips
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
});
</script>
{% endblock %}
