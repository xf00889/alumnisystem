{% extends "base.html" %}
{% load static %}
{% load mentorship_extras %}

{% block title %}Mentor Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/mentorship.css' %}">
<style>
    /* Dashboard Layout */
    .dashboard-container {
        padding: 2rem;
        width: 100%;
        max-width: 100%;
        margin: 0 auto;
    }
    
    /* Gradient Backgrounds */
    .bg-gradient-primary {
        background: linear-gradient(45deg, #4e73df 0%, #224abe 100%);
    }

    .bg-gradient-success {
        background: linear-gradient(45deg, #1cc88a 0%, #13855c 100%);
    }

    .bg-gradient-info {
        background: linear-gradient(45deg, #36b9cc 0%, #258391 100%);
    }

    .bg-gradient-warning {
        background: linear-gradient(45deg, #f6c23e 0%, #dda20a 100%);
    }
    
    /* Card Enhancements */
    .card {
        border: none;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        transition: transform 0.2s ease-in-out;
    }
    
    .card:hover {
        transform: translateY(-3px);
    }

    /* Stats Card Icons */
    .stats-icon {
        width: 3rem;
        height: 3rem;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
    }

    /* Mentorship Item Styles */
    .mentorship-item {
        border: none;
        margin-bottom: 1rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }

    .mentorship-item .accordion-button {
        padding: 1rem;
        background: #fff;
        border: none;
    }

    .mentorship-item .accordion-button:not(.collapsed) {
        background: #f8f9fa;
        color: #4e73df;
    }

    .mentorship-title {
        font-weight: 600;
        color: #5a5c69;
    }

    /* Progress Bars */
    .progress {
        height: 1rem;
        border-radius: 0.5rem;
        background-color: #eaecf4;
    }
    
    .progress-bar {
        border-radius: 0.5rem;
    }

    /* Timeline Styles */
    .timeline-visualization {
        padding: 1.5rem;
        background: #f8f9fa;
        border-radius: 0.5rem;
    }

    /* Buttons */
    .btn {
        padding: 0.375rem 1rem;
        font-weight: 500;
        border-radius: 0.5rem;
    }
    
    .btn-primary {
        background-color: #4e73df;
        border-color: #4e73df;
    }
    
    .btn-primary:hover {
        background-color: #2e59d9;
        border-color: #2653d4;
    }
    
    /* Badges */
    .badge {
        padding: 0.5em 0.75em;
        font-weight: 500;
        border-radius: 0.5rem;
    }

    /* Form Elements */
    .form-check-input:checked {
        background-color: #4e73df;
        border-color: #4e73df;
    }
    
    /* Responsive Adjustments */
    @media (max-width: 768px) {
        .dashboard-container {
            padding: 1rem;
        }

        .card {
            margin-bottom: 1rem;
        }
    }
    
    /* Enhanced Timeline Visualization Styles */
    .enhanced-timeline-container {
        height: 120px;
        padding: 15px 30px; /* Increased horizontal padding */
        position: relative;
        margin: 30px 0;
        overflow: visible;
    }

    .enhanced-timeline-line {
        position: absolute;
        height: 6px;
        background-color: #e9ecef;
        top: 50%;
        transform: translateY(-50%);
        z-index: 1;
        left: 0;
        right: 0;
        border-radius: 3px;
    }

    .enhanced-timeline-progress-fill {
        position: absolute;
        height: 6px;
        background: linear-gradient(90deg, #4e73df 0%, #36b9cc 100%);
        top: 50%;
        transform: translateY(-50%);
        z-index: 2;
        left: 0;
        width: 0%;
        transition: width 1s ease;
        border-radius: 3px;
        box-shadow: 0 0 10px rgba(78, 115, 223, 0.5);
    }

    .enhanced-milestone-marker-wrapper {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        z-index: 3;
        cursor: pointer;
    }

    .enhanced-milestone-marker {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
        transition: all 0.3s ease;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        position: relative;
    }

    .enhanced-milestone-marker.not-started {
        background-color: #6c757d;
        border: 2px solid #fff;
    }

    .enhanced-milestone-marker.in-progress {
        background-color: #f6c23e;
        border: 2px solid #fff;
    }

    .enhanced-milestone-marker.completed {
        background-color: #1cc88a;
        border: 2px solid #fff;
    }

    .enhanced-milestone-marker:hover {
        transform: scale(1.2);
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }

    .enhanced-milestone-labels {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        margin-top: 10px;
    }

    .enhanced-milestone-label {
        position: absolute;
        transform: translateX(-50%);
        font-size: 0.8rem;
        color: #495057;
        text-align: center;
        max-width: 100px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .enhanced-milestone-tooltip {
        position: absolute;
        bottom: 45px;
        left: 50%;
        transform: translateX(-50%) scale(0.9);
        background-color: white;
        color: #333;
        padding: 0;
        border-radius: 8px;
        font-size: 0.85rem;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        z-index: 1000;
        width: 220px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        pointer-events: none;
        border: 1px solid rgba(0,0,0,0.1);
        /* Ensure tooltip doesn't go off-screen */
        max-width: 90vw;
    }

    /* Adjust tooltip position for edge milestones */
    .enhanced-milestone-marker-wrapper:first-child .enhanced-milestone-tooltip {
        transform: translateX(-20%) scale(0.9);
    }
    
    .enhanced-milestone-marker-wrapper:first-child:hover .enhanced-milestone-tooltip {
        transform: translateX(-20%) scale(1);
    }
    
    .enhanced-milestone-marker-wrapper:last-child .enhanced-milestone-tooltip {
        transform: translateX(-80%) scale(0.9);
    }
    
    .enhanced-milestone-marker-wrapper:last-child:hover .enhanced-milestone-tooltip {
        transform: translateX(-80%) scale(1);
    }

    .enhanced-milestone-tooltip::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -8px;
        border-width: 8px;
        border-style: solid;
        border-color: white transparent transparent transparent;
    }
    
    /* Adjust arrow position for edge milestones */
    .enhanced-milestone-marker-wrapper:first-child .enhanced-milestone-tooltip::after {
        left: 20%;
    }
    
    .enhanced-milestone-marker-wrapper:last-child .enhanced-milestone-tooltip::after {
        left: 80%;
    }

    .enhanced-milestone-marker-wrapper:hover .enhanced-milestone-tooltip {
        opacity: 1;
        visibility: visible;
        transform: translateX(-50%) scale(1);
    }

    .tooltip-header {
        padding: 8px 12px;
        border-bottom: 1px solid rgba(0,0,0,0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #f8f9fa;
        border-radius: 8px 8px 0 0;
    }

    .tooltip-title {
        font-weight: bold;
        color: #495057;
    }

    .tooltip-status {
        font-size: 0.75rem;
        padding: 2px 6px;
        border-radius: 12px;
        font-weight: bold;
    }

    .tooltip-status.not-started {
        background-color: #e9ecef;
        color: #495057;
    }

    .tooltip-status.in-progress {
        background-color: #fff3cd;
        color: #856404;
    }

    .tooltip-status.completed {
        background-color: #d4edda;
        color: #155724;
    }

    .tooltip-body {
        padding: 10px 12px;
        line-height: 1.4;
    }

    .enhanced-current-position-marker {
        position: absolute;
        top: 0;
        transform: translateX(-50%);
        color: #e74a3b;
        font-size: 1.5rem;
        z-index: 4;
        filter: drop-shadow(0 2px 3px rgba(0,0,0,0.3));
        animation: bounce 2s infinite;
    }

    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% {
            transform: translateX(-50%) translateY(0);
        }
        40% {
            transform: translateX(-50%) translateY(-10px);
        }
        60% {
            transform: translateX(-50%) translateY(-5px);
        }
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .enhanced-timeline-container {
            height: 150px;
            margin: 40px 0;
            padding: 15px 20px;
        }
        
        .enhanced-milestone-label {
            font-size: 0.7rem;
        }
        
        .enhanced-milestone-tooltip {
            width: 180px;
        }
    }

    .timeline-visual-container {
        height: 150px;
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 15px 30px; /* Increased horizontal padding */
        position: relative;
        overflow: visible;
        margin: 15px 0 45px; /* Increased bottom margin to accommodate labels */
        border: 1px solid rgba(0,0,0,0.05);
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    /* Progress Bar Styles */
    .progress {
        cursor: pointer;
        transition: all 0.3s ease;
        overflow: visible;
    }

    .progress:hover {
        box-shadow: 0 0 10px rgba(0,123,255,0.5);
    }

    .progress-bar {
        position: relative;
    }

    /* Progress Tooltip */
    .progress-tooltip {
        position: absolute;
        top: -40px;
        right: 0;
        background-color: #343a40;
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.8rem;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
        z-index: 1000;
        white-space: nowrap;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .progress-tooltip::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: #343a40 transparent transparent transparent;
    }

    .progress:hover .progress-tooltip {
        opacity: 1;
        visibility: visible;
    }

    /* Progress Details Modal Styles */
    .progress-lg {
        height: 25px !important;
        border-radius: 15px;
        overflow: hidden;
    }

    .progress-lg .progress-bar {
        line-height: 25px;
        font-weight: bold;
    }

    .progress-stat-card {
        transition: all 0.3s ease;
        border: 1px solid #dee2e6;
    }

    .progress-stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .stat-value {
        font-size: 1.8rem;
        font-weight: bold;
    }
    
    .milestone-marker {
        position: absolute;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        transition: all 0.3s ease;
        z-index: 2;
    }

    .milestone-marker.not-started {
        background-color: #6c757d;
        border: 2px solid #fff;
    }

    .milestone-marker.in-progress {
        background-color: #ffc107;
        border: 2px solid #fff;
    }
    
    .milestone-marker.completed {
        background-color: #28a745;
        border: 2px solid #fff;
    }

    .milestone-marker:hover {
        transform: translateY(-50%) scale(1.2);
        box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }

    .milestone-line {
        position: absolute;
        height: 4px;
        background-color: #dee2e6;
        top: 50%;
        transform: translateY(-50%);
        z-index: 1;
        left: 0;
        right: 0;
    }

    .milestone-progress-fill {
        position: absolute;
        height: 4px;
        background: linear-gradient(90deg, #4481eb 0%, #04befe 100%);
        top: 50%;
        transform: translateY(-50%);
        z-index: 1;
        left: 0;
        width: 0%;
        transition: width 1s ease;
    }

    .milestone-tooltip {
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background-color: #343a40;
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.8rem;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
        z-index: 1000;
        white-space: nowrap;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        pointer-events: none;
    }

    .milestone-tooltip::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: #343a40 transparent transparent transparent;
    }

    .milestone-marker:hover .milestone-tooltip {
        opacity: 1;
        visibility: visible;
    }

    .timeline-status-badge {
        display: inline-block;
        padding: 0.25em 0.6em;
        font-size: 0.75em;
        font-weight: 700;
        line-height: 1;
        text-align: center;
        white-space: nowrap;
        vertical-align: baseline;
        border-radius: 0.25rem;
    }

    .timeline-status-badge.not-started {
        background-color: #6c757d;
        color: white;
    }

    .timeline-status-badge.in-progress {
        background-color: #ffc107;
        color: #212529;
    }

    .timeline-status-badge.completed {
        background-color: #28a745;
        color: white;
    }

    /* Loading indicator styles */
    .loading-spinner-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 38px; /* Standard height of a form-select element */
        background-color: rgba(255, 255, 255, 0.8);
        border-radius: 0.25rem;
    }

    /* Success and error highlight styles for form elements */
    .border-success {
        border-color: #28a745 !important;
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25) !important;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    .border-danger {
        border-color: #dc3545 !important;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
{% csrf_token %}
    <!-- Dashboard Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="d-flex align-items-center">
                {% if mentor.user.profile.avatar %}
                    <img src="{{ mentor.user.profile.avatar.url }}" alt="{{ mentor.user.get_full_name }}" class="rounded-circle me-3" style="width: 60px; height: 60px; object-fit: cover;">
                {% else %}
                    <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-3" style="width: 60px; height: 60px;">
                        <i class="fas fa-user fa-2x"></i>
                </div>
                {% endif %}
                <div>
                    <h2 class="mb-0">Welcome back, {{ mentor.user.get_full_name }}</h2>
                    <p class="text-muted mb-0">
                        <i class="fas fa-map-marker-alt me-1"></i> {{ mentor.user.profile.location|default:"Location not set" }}
                        {% if mentor.user.profile.current_position %}
                            <span class="mx-2">|</span>
                            <i class="fas fa-briefcase me-1"></i> {{ mentor.user.profile.current_position }}
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
        <div class="col-md-4 text-end d-flex align-items-center justify-content-end">
            <div class="me-3">
                <!-- Availability Toggle -->
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="availabilityToggle"
                           {% if mentor.accepting_mentees %}checked{% endif %}
                           data-mentor-id="{{ mentor.id }}"
                           onchange="toggleAvailability()">
                    <label class="form-check-label" for="availabilityToggle">
                        Accepting New Mentees
                    </label>
                </div>
            </div>
            <a href="{% url 'accounts:profile_detail' mentor.user.username %}" class="btn btn-outline-primary">
                <i class="fas fa-user-edit me-1"></i> Edit Profile
            </a>
        </div>
        </div>

        <!-- Stats Overview -->
    <div class="row mb-4">
            <div class="col-md-3">
            <div class="card bg-gradient-primary text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="rounded-circle bg-white bg-opacity-25 p-3">
                            <i class="fas fa-users fa-2x text-white"></i>
                        </div>
                        <h2 class="mb-0">{{ total_active_mentees }}</h2>
                    </div>
                    <h5 class="card-title mb-0">Active Mentees</h5>
                    <div class="progress bg-white bg-opacity-25 mt-3" style="height: 5px;">
                        <div class="progress-bar bg-white" style="width: {{ total_active_mentees|default:0|multiply:20 }}%"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
            <div class="card bg-gradient-warning text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="rounded-circle bg-white bg-opacity-25 p-3">
                            <i class="fas fa-clock fa-2x text-white"></i>
                        </div>
                        <h2 class="mb-0">{{ total_pending_requests }}</h2>
                    </div>
                    <h5 class="card-title mb-0">Pending Requests</h5>
                    <div class="progress bg-white bg-opacity-25 mt-3" style="height: 5px;">
                        <div class="progress-bar bg-white" style="width: {{ total_pending_requests|default:0|multiply:20 }}%"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
            <div class="card bg-gradient-info text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="rounded-circle bg-white bg-opacity-25 p-3">
                            <i class="fas fa-calendar-check fa-2x text-white"></i>
                        </div>
                        <h2 class="mb-0">{{ upcoming_meetings.count }}</h2>
                    </div>
                    <h5 class="card-title mb-0">Upcoming Meetings</h5>
                    <div class="progress bg-white bg-opacity-25 mt-3" style="height: 5px;">
                        <div class="progress-bar bg-white" style="width: {{ upcoming_meetings.count|default:0|multiply:20 }}%"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
            <div class="card bg-gradient-success text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="rounded-circle bg-white bg-opacity-25 p-3">
                            <i class="fas fa-envelope fa-2x text-white"></i>
                        </div>
                        <h2 class="mb-0">{{ unread_messages }}</h2>
                    </div>
                    <h5 class="card-title mb-0">Unread Messages</h5>
                    <div class="progress bg-white bg-opacity-25 mt-3" style="height: 5px;">
                        <div class="progress-bar bg-white" style="width: {{ unread_messages|default:0|multiply:20 }}%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="row">
            <!-- Left Column -->
            <div class="col-md-8">
                <!-- Pending Requests -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Pending Requests</h5>
                        {% if pending_requests %}
                        <span class="badge bg-warning">{{ pending_requests|length }}</span>
                        {% endif %}
                    </div>
                    <div class="card-body">
                    {% if pending_requests %}
                        <div class="list-group">
                        {% for request in pending_requests %}
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">{{ request.mentee.get_full_name }}</h6>
                                <small>{{ request.created_at|timesince }} ago</small>
                            </div>
                                <p class="mb-1">{{ request.message|truncatewords:30 }}</p>
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-success" onclick="updateStatus('{{ request.id }}', 'APPROVED')">
                                        Accept
                                </button>
                                    <button class="btn btn-sm btn-danger" onclick="updateStatus('{{ request.id }}', 'REJECTED')">
                                        Decline
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-muted">No pending requests</p>
                    {% endif %}
                </div>
            </div>

            <!-- Active Mentorships -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Active Mentorships</h5>
                </div>
                <div class="card-body">
                {% if active_mentorships %}
                    <div class="active-mentorships">
                    <div class="accordion" id="mentorshipAccordion">
                    {% for mentorship in active_mentorships %}
                            <div class="accordion-item mentorship-item" data-mentorship-id="{{ mentorship.id }}">
                            <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#mentorship-{{ mentorship.id }}" aria-expanded="false" aria-controls="mentorship-{{ mentorship.id }}">
                                        <span class="mentorship-title">{{ mentorship.mentee.get_full_name }}</span>
                                        <span class="badge bg-primary ms-2">{{ mentorship.get_status_display }}</span>
                                </button>
                            </h2>
                                <div id="mentorship-{{ mentorship.id }}" class="accordion-collapse collapse" data-bs-parent="#mentorshipAccordion">
                                    <div class="accordion-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                            <h6>Goals</h6>
                                            <ul class="list-unstyled">
                                                {% for goal in mentorship.mentorship_goals.all %}
                                                <li>
                                                    <i class="fas fa-check-circle text-{{ goal.status|lower }}"></i>
                                                    {{ goal.title }}
                                                </li>
                                                {% endfor %}
                                            </ul>
                                                    </div>
                                        <div class="col-md-6">
                                            <h6>Skills Progress</h6>
                                            {% for skill in mentorship.skill_progress.all %}
                                            <div class="mb-2">
                                                <small>{{ skill.skill_name }}</small>
                                                <div class="progress">
                                                        <div class="progress-bar progress-bar-skill-{{ forloop.counter }}" 
                                                             role="progressbar"
                                                        aria-valuemin="0"
                                                             aria-valuemax="100"
                                                             data-skill-proficiency="{{ skill.current_proficiency }}">
                                                        {{ skill.get_current_proficiency_display }}
                                                </div>
                                                    </div>
                                                        </div>
                    {% endfor %}
                                                    </div>
                                                </div>
                                    
                                    {% if mentorship.timeline_milestones %}
                                    <div class="mt-3">
                                        <h6>Timeline</h6>
                                            <div class="progress mb-2" style="height: 20px; cursor: pointer;" onclick="showProgressDetails('{{ mentorship.id }}')">
                                                <div class="progress-bar bg-success progress-bar-mentorship-{{ mentorship.id }}" 
                                                     role="progressbar"
                                                         aria-valuemin="0" 
                                                     aria-valuemax="100"
                                                     data-percentage="{{ mentorship.progress_percentage }}">
                                                        {{ mentorship.progress_percentage }}%
                                            </div>
                                                                        </div>
                                                
                                            <!-- Step-Based Progress Tracker removed as requested -->
                                                
                                            <div class="d-flex mt-3">
                                                <button class="btn btn-sm btn-primary me-2" onclick="showProgressDetails('{{ mentorship.id }}')">
                                                    <i class="fas fa-chart-line me-1"></i> View Progress
                                                </button>
                                                <!-- Update Status button removed as requested -->
                                                <button class="btn btn-sm btn-secondary" onclick="setTimeline('{{ mentorship.id }}')">
                                                    <i class="fas fa-calendar-alt me-1"></i> Set Timeline
                                                </button>
                                                <div class="dropdown ms-2">
                                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="mentorshipStatusDropdown{{ mentorship.id }}" data-bs-toggle="dropdown" aria-expanded="false">
                                                        <i class="fas fa-cog me-1"></i> Manage
                                                    </button>
                                                    <ul class="dropdown-menu" aria-labelledby="mentorshipStatusDropdown{{ mentorship.id }}">
                                                        {% if mentorship.status == 'PAUSED' %}
                                                        <li><a class="dropdown-item" href="javascript:void(0)" onclick="updateMentorshipStatus('{{ mentorship.id }}', 'APPROVED')"><i class="fas fa-play me-2"></i> Resume Mentorship</a></li>
                                                        {% else %}
                                                        <li><a class="dropdown-item" href="javascript:void(0)" onclick="updateMentorshipStatus('{{ mentorship.id }}', 'PAUSED')"><i class="fas fa-pause me-2"></i> Pause Mentorship</a></li>
                                                                        {% endif %}
                                                        <li><a class="dropdown-item" href="javascript:void(0)" onclick="updateMentorshipStatus('{{ mentorship.id }}', 'COMPLETED')"><i class="fas fa-check-circle me-2"></i> Complete Mentorship</a></li>
                                                        <li><a class="dropdown-item" href="javascript:void(0)" onclick="updateMentorshipStatus('{{ mentorship.id }}', 'CANCELLED')"><i class="fas fa-times-circle me-2"></i> Cancel Mentorship</a></li>
                                                    </ul>
                                                                    </div>
                                                                </div>
                                            
                                            <!-- Hidden timeline text for data storage -->
                                            <pre class="mb-0 small timeline-text" style="display: none;">{{ mentorship.timeline_milestones }}</pre>
                                                            </div>
                                                        {% else %}
                                    <div class="mt-3">
                                        <h6>Timeline</h6>
                                            <div class="progress mb-2" style="height: 20px;">
                                                <div class="progress-bar bg-secondary" role="progressbar" 
                                                     style="width: 0%" 
                                                     aria-valuenow="0" 
                                                     aria-valuemin="0" 
                                                     aria-valuemax="100">
                                                    0%
                                                    </div>
                                                </div>
                                            <div class="d-flex">
                                                <button class="btn btn-sm btn-success me-2" onclick="updateProgress('{{ mentorship.id }}')">
                                                        <i class="fas fa-chart-line me-1"></i> Update Progress
                                                </button>
                                                <button class="btn btn-sm btn-secondary" onclick="setTimeline('{{ mentorship.id }}')">
                                                    <i class="fas fa-calendar-alt me-1"></i> Set Timeline
                                                </button>
                                                <div class="dropdown ms-2">
                                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="mentorshipStatusDropdown{{ mentorship.id }}" data-bs-toggle="dropdown" aria-expanded="false">
                                                        <i class="fas fa-cog me-1"></i> Manage
                                                    </button>
                                                    <ul class="dropdown-menu" aria-labelledby="mentorshipStatusDropdown{{ mentorship.id }}">
                                                        {% if mentorship.status == 'PAUSED' %}
                                                        <li><a class="dropdown-item" href="#" onclick="updateMentorshipStatus('{{ mentorship.id }}', 'APPROVED')"><i class="fas fa-play me-2"></i> Resume Mentorship</a></li>
                                                        {% else %}
                                                        <li><a class="dropdown-item" href="#" onclick="updateMentorshipStatus('{{ mentorship.id }}', 'PAUSED')"><i class="fas fa-pause me-2"></i> Pause Mentorship</a></li>
                                                        {% endif %}
                                                        <li><a class="dropdown-item" href="#" onclick="updateMentorshipStatus('{{ mentorship.id }}', 'COMPLETED')"><i class="fas fa-check-circle me-2"></i> Complete Mentorship</a></li>
                                                        <li><a class="dropdown-item" href="#" onclick="updateMentorshipStatus('{{ mentorship.id }}', 'CANCELLED')"><i class="fas fa-times-circle me-2"></i> Cancel Mentorship</a></li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                {% endif %}
                                    
                                    <div class="mt-3">
                                        <button class="btn btn-sm btn-primary" onclick="scheduleMeeting('{{ mentorship.id }}')">
                                            Schedule Meeting
                                        </button>
                                        <button class="btn btn-sm btn-info" onclick="sendMessage('{{ mentorship.id }}')">
                                            Send Message
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Finished Mentorships Section -->
                    <div class="finished-mentorships" style="display: none;">
                        <div class="finished-mentorships-header">
                            <h5>Completed Mentorships</h5>
                            <span class="finished-mentorships-toggle" onclick="toggleFinishedMentorships()">
                                <i class="fas fa-chevron-down"></i> Show
                            </span>
                        </div>
                        <div class="finished-mentorships-content">
                            <!-- Completed mentorships will be moved here -->
                        </div>
                    </div>
                    {% else %}
                    <p class="text-muted">No active mentorships</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Right Column -->
    <div class="col-md-4">
        <!-- Upcoming Meetings -->
        <div class="card mb-4">
                <div class="card-header">
                <h5 class="mb-0">Upcoming Meetings</h5>
            </div>
            <div class="card-body">
                {% if upcoming_meetings %}
                    <div class="list-group">
                    {% for meeting in upcoming_meetings %}
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">{{ meeting.title }}</h6>
                                <small>{{ meeting.meeting_date|date:"M d, h:i a" }}</small>
                                </div>
                            <p class="mb-1">with {{ meeting.mentorship.mentee.get_full_name }}</p>
                            {% if meeting.meeting_link %}
                            <a href="{{ meeting.meeting_link }}" class="btn btn-primary mt-2 w-100" target="_blank">
                                <i class="fas fa-video me-1"></i> Join Meeting
                            </a>
                            <div class="form-text small mt-1 text-center">
                                Click to join the video call with your mentee
                            </div>
                            {% else %}
                            <div class="alert alert-warning mt-2 p-2 small">
                                <i class="fas fa-exclamation-triangle me-1"></i> No meeting link added
                                <button class="btn btn-sm btn-primary ms-2" onclick="editMeeting('{{ meeting.id }}')">
                                    <i class="fas fa-plus-circle me-1"></i> Add Link
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted">No upcoming meetings</p>
                {% endif %}
            </div>
        </div>

            <!-- Recent Progress -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Recent Progress Updates</h5>
                        </div>
                <div class="card-body">
                    {% if recent_progress %}
                    <div class="list-group">
                        {% for progress in recent_progress %}
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ progress.title }}</h6>
                                <small>{{ progress.created_at|timesince }} ago</small>
                            </div>
                            <p class="mb-1">{{ progress.description|truncatewords:20 }}</p>
                            <small>by {{ progress.mentorship.mentee.get_full_name }}</small>
                    </div>
                    {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted">No recent progress updates</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
</div>

<!-- JavaScript for Interactions -->
<script>
// Single DOMContentLoaded event listener
document.addEventListener('DOMContentLoaded', function() {
    // Initialize all progress bars
    initializeProgressBars();
    
    // Setup error handling for AJAX requests
    setupErrorHandling();
    
    // Initialize Bootstrap components
    initializeBootstrapComponents();
    
    // Initialize milestone buttons
    initializeMilestoneButtons();
    
    // Organize completed mentorships
    organizeCompletedMentorships();
    
    // Load timeline milestones for active mentorships (with debounce)
    setTimeout(() => {
        loadAllTimelineMilestones();
        enhanceTimelineDisplay();
    }, 100);
    
    // Setup mutation observer with throttle
    let timeout;
    const observer = new MutationObserver((mutations) => {
        if (timeout) {
            clearTimeout(timeout);
        }
        timeout = setTimeout(() => {
            updateProgressBars();
        }, 200);
    });
    
    // Observe progress bars with optimized config
    const progressBars = document.querySelectorAll('.progress');
    const config = { 
        attributes: true,
        attributeFilter: ['style']
    };
    
    progressBars.forEach(progress => {
        observer.observe(progress, config);
    });
    
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Initialize popovers
    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
    var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
        return new bootstrap.Popover(popoverTriggerEl);
    });
    
    // Initialize progress bars
    document.querySelectorAll('.progress-bar-mentorship').forEach(function(progressBar) {
        const percentage = progressBar.getAttribute('data-percentage');
        progressBar.style.width = `${percentage}%`;
        progressBar.setAttribute('aria-valuenow', percentage);
    });
    
    // Initialize skill progress bars
    document.querySelectorAll('[data-skill-proficiency]').forEach(function(progressBar) {
        const proficiency = progressBar.getAttribute('data-skill-proficiency');
        const percentage = (proficiency / 5) * 100;
        progressBar.style.width = `${percentage}%`;
        progressBar.setAttribute('aria-valuenow', percentage);
    });
    
    // Step-based progress tracker code removed as requested
});

// Function to initialize milestone buttons
function initializeMilestoneButtons() {
    const addMilestoneBtn = document.getElementById('add-milestone-btn');
    if (addMilestoneBtn) {
        addMilestoneBtn.addEventListener('click', function() {
            const milestonesContainer = document.getElementById('milestones-container');
            const template = document.getElementById('milestone-template');
            
            if (template) {
                const newMilestone = template.querySelector('.milestone-entry').cloneNode(true);
                
                // Add to the container
                milestonesContainer.appendChild(newMilestone);
                
                // Add event listener to the remove button
                const removeBtn = newMilestone.querySelector('.remove-milestone-btn');
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        const milestoneEntry = this.closest('.milestone-entry');
                        if (milestoneEntry && milestoneEntry.parentNode) {
                            // Check if this is the last milestone entry
                            const allEntries = milestonesContainer.querySelectorAll('.milestone-entry');
                            if (allEntries.length === 1) {
                                // If it's the last one, just clear the inputs instead of removing
                                const periodInput = milestoneEntry.querySelector('.milestone-period');
                                const descriptionInput = milestoneEntry.querySelector('.milestone-description');
                                const dateInput = milestoneEntry.querySelector('.milestone-date');
                                
                                if (periodInput) periodInput.value = '';
                                if (descriptionInput) descriptionInput.value = '';
                                if (dateInput) {
                                    dateInput.value = '';
                                    dateInput.classList.remove('is-invalid');
                                }
                            } else {
                                // Otherwise remove it
                                milestoneEntry.parentNode.removeChild(milestoneEntry);
                            }
                            
                            // Re-validate after changes
                            validateAllMilestoneDates();
                        }
                    });
                }
            } else {
                console.error("Milestone template not found");
            }
        });
    }
    
    // Add event listeners to existing remove buttons
    document.querySelectorAll('.remove-milestone-btn').forEach(button => {
        button.addEventListener('click', function() {
            const milestoneEntry = this.closest('.milestone-entry');
            const milestonesContainer = document.getElementById('milestones-container');
            
            if (milestoneEntry && milestoneEntry.parentNode) {
                // Check if this is the last milestone entry
                const allEntries = milestonesContainer.querySelectorAll('.milestone-entry');
                if (allEntries.length === 1) {
                    // If it's the last one, just clear the inputs instead of removing
                    const periodInput = milestoneEntry.querySelector('.milestone-period');
                    const descriptionInput = milestoneEntry.querySelector('.milestone-description');
                    const dateInput = milestoneEntry.querySelector('.milestone-date');
                    
                    if (periodInput) periodInput.value = '';
                    if (descriptionInput) descriptionInput.value = '';
                    if (dateInput) {
                        dateInput.value = '';
                        dateInput.classList.remove('is-invalid');
                    }
                } else {
                    // Otherwise remove it
                    milestoneEntry.parentNode.removeChild(milestoneEntry);
                }
                
                // Re-validate after changes
                validateAllMilestoneDates();
            }
        });
    });
}

// Function to calculate total mentoring days
function calculateMentoringDays() {
    const expectedEndDate = document.getElementById('expectedEndDate');
    const mentoringDaysInfo = document.getElementById('mentoringDaysInfo');
    const totalDaysText = document.getElementById('totalDaysText');
    
    if (!expectedEndDate || !expectedEndDate.value) {
        if (mentoringDaysInfo) mentoringDaysInfo.classList.add('d-none');
        return;
    }
    
    const endDate = new Date(expectedEndDate.value);
    const today = new Date();
    today.setHours(0, 0, 0, 0); // Reset hours to get exact days
    
    // Calculate difference in days
    const diffTime = endDate - today;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays < 0) {
        totalDaysText.textContent = `End date cannot be in the past. Please select a future date.`;
        mentoringDaysInfo.classList.remove('alert-info');
        mentoringDaysInfo.classList.add('alert-danger');
    } else {
        const weeks = Math.floor(diffDays / 7);
        const remainingDays = diffDays % 7;
        
        let timeMessage = '';
        if (weeks > 0) {
            timeMessage += `${weeks} week${weeks > 1 ? 's' : ''}`;
        }
        if (remainingDays > 0) {
            if (weeks > 0) timeMessage += ' and ';
            timeMessage += `${remainingDays} day${remainingDays > 1 ? 's' : ''}`;
        }
        
        totalDaysText.textContent = `Total mentoring time: ${diffDays} days (${timeMessage}).`;
        mentoringDaysInfo.classList.remove('alert-danger');
        mentoringDaysInfo.classList.add('alert-info');
        
        // Validate all milestone dates against this new end date
        validateAllMilestoneDates();
    }
    
    mentoringDaysInfo.classList.remove('d-none');
}

// Function to validate a single milestone date
function validateMilestoneDate(dateInput) {
    const expectedEndDateInput = document.getElementById('expectedEndDate');
    
    if (!expectedEndDateInput || !expectedEndDateInput.value) {
        showToast('warning', 'Please set an expected end date first');
        dateInput.classList.add('is-invalid');
        return false;
    }
    
    const endDate = new Date(expectedEndDateInput.value);
    endDate.setHours(23, 59, 59, 999); // End of the day
    
    const milestoneDate = new Date(dateInput.value);
    milestoneDate.setHours(0, 0, 0, 0); // Start of the day
    
    const today = new Date();
    today.setHours(0, 0, 0, 0); // Start of the day
    today.setDate(today.getDate() - 1); // Allow today by setting comparison to yesterday
    
    if (milestoneDate <= today) { // Using <= to compare with yesterday
        showToast('warning', 'Milestone date cannot be in the past');
        dateInput.classList.add('is-invalid');
        return false;
    }
    
    if (milestoneDate > endDate) {
        showToast('warning', 'Milestone date cannot be after the expected end date');
        dateInput.classList.add('is-invalid');
        return false;
    }
    
    dateInput.classList.remove('is-invalid');
    return true;
}

// Function to validate all milestone dates
function validateAllMilestoneDates() {
    const milestonesContainer = document.getElementById('milestones-container');
    const dateInputs = milestonesContainer.querySelectorAll('.milestone-date');
    
    let allValid = true;
    dateInputs.forEach(input => {
        if (input.value) {
            const isValid = validateMilestoneDate(input);
            if (!isValid) allValid = false;
        }
    });
    
    return allValid;
}

// Toggle between date picker and text input for date
function toggleDateDisplay(element) {
    const inputGroup = element.closest('.input-group');
    const dateInput = inputGroup.querySelector('.milestone-date');
    
    if (dateInput.type === 'date') {
        // Format the date for display as mm/dd/yyyy
        if (dateInput.value) {
            const date = new Date(dateInput.value);
            const formattedDate = `${(date.getMonth()+1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}/${date.getFullYear()}`;
            dateInput.type = 'text';
            dateInput.value = formattedDate;
        } else {
            dateInput.type = 'text';
            dateInput.placeholder = 'mm/dd/yyyy';
        }
    } else {
        dateInput.type = 'date';
    }
}

// Function to toggle availability
function toggleAvailability() {
    const toggle = document.getElementById('availabilityToggle');
    const isAvailable = toggle.checked;
    const mentorId = toggle.dataset.mentorId;
    
    // Debug logging
    console.log('Toggle availability with:', { mentorId, isAvailable });
    
    if (!mentorId) {
        console.error('No mentor ID found in data attribute');
        showToast('error', 'Failed to update availability: No mentor ID found');
        return;
    }

    $.ajax({
        url: `/mentorship/mentor/${mentorId}/toggle-availability/`,
        type: 'POST',
        data: JSON.stringify({ is_available: isAvailable }),
        contentType: 'application/json',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        beforeSend: function(xhr, settings) {
            console.log('Making request to:', settings.url);
        },
        success: function(response) {
            console.log('Toggle success:', response);
            showToast('success', `Availability ${response.accepting_mentees ? 'enabled' : 'disabled'} successfully`);
        },
        error: function(xhr, status, error) {
            console.error('Error toggling availability:', xhr.responseText || error);
            console.error('Status:', status);
            console.error('Status code:', xhr.status);
            let errorMessage = 'Failed to update availability';
            
            // Try to get more specific error message from response
            try {
                const errorData = JSON.parse(xhr.responseText);
                errorMessage = errorData.detail || errorData.message || errorMessage;
            } catch (e) {
                // If we can't parse the response, use the status text
                errorMessage = xhr.statusText ? `Error: ${xhr.statusText}` : errorMessage;
            }
            
            showToast('error', errorMessage);
            // Revert the toggle to its previous state
            toggle.checked = !isAvailable;
        }
    });
}

function updateStatus(requestId, status) {
    if (!confirm('Are you sure you want to update this request?')) {
        return;
    }

    $.ajax({
        url: `{% url "mentorship:update_request_status" 0 %}`.replace('0', requestId),
        type: 'POST',
        data: {
            'status': status,
            'csrfmiddlewaretoken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        success: function(response) {
            showToast('Success', response.message, 'success');
            setTimeout(() => window.location.reload(), 1500);
        },
        error: function(xhr, status, error) {
            showToast('Error', 'Failed to update request status', 'error');
        }
        });
}

function scheduleMeeting(mentorshipId) {
    const modal = new bootstrap.Modal(document.getElementById('scheduleMeetingModal'));
    document.getElementById('mentorshipIdInput').value = mentorshipId;
    modal.show();
}

function sendMessage(mentorshipId) {
    const modal = new bootstrap.Modal(document.getElementById('sendMessageModal'));
    document.getElementById('messageRecipientId').value = mentorshipId;
    modal.show();
}

function updateProgress(mentorshipId) {
    // Show progress update modal
    var progressModal = document.getElementById('progressModal');
    var modal = bootstrap.Modal.getInstance(progressModal) || new bootstrap.Modal(progressModal);
    document.getElementById('mentorshipIdForProgress').value = mentorshipId;
    
    // Fetch current progress percentage
    fetch(`/mentorship/api/requests/${mentorshipId}/`, {
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        // Set current progress percentage
        const progressSlider = document.getElementById('progressPercentage');
        const progressValue = document.getElementById('progressPercentageValue');
        if (progressSlider && progressValue && data.progress_percentage) {
            progressSlider.value = data.progress_percentage;
            progressValue.textContent = data.progress_percentage + '%';
        }
        
        modal.show();
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Failed to fetch current progress. Using default values.');
        modal.show(); // Show modal anyway
    });
}

// Submit progress form
function submitProgress() {
    const mentorshipId = document.getElementById('mentorshipIdForProgress').value;
    const progressTitle = document.getElementById('progressTitle').value;
    const progressDescription = document.getElementById('progressDescription').value;
    const progressPercentage = document.getElementById('progressPercentage').value;
    
    // First create the progress update
    fetch('/mentorship/api/progress/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            mentorship: mentorshipId,
            title: progressTitle,
            description: progressDescription
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to create progress update');
        }
        return response.json();
    })
    .then(data => {
        // Then update the progress percentage
        return fetch(`/mentorship/api/requests/${mentorshipId}/update_timeline/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                progress_percentage: progressPercentage
            })
        });
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to update progress percentage');
        }
        return response.json();
    })
    .then(data => {
        var progressModal = document.getElementById('progressModal');
        var modal = bootstrap.Modal.getInstance(progressModal);
        if (modal) modal.hide();
        
        showToast('success', 'Progress updated successfully');
        setTimeout(() => location.reload(), 1500);
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Failed to update progress. Please try again.');
    });
}

// Submit meeting form
function submitMeeting() {
    const mentorshipId = document.getElementById('mentorshipIdForMeeting').value;
    const meetingTitle = document.getElementById('meetingTitle').value;
    const meetingDate = document.getElementById('meetingDate').value;
    const meetingLink = document.getElementById('meetingLink').value;
    const meetingDescription = document.getElementById('meetingDescription')?.value || '';
    
    // Validate that required fields are filled
    if (!meetingTitle || !meetingDate || !meetingLink) {
        showToast('error', 'Please fill out all required fields, including the meeting link.');
        return;
    }
    
    // Validate that the meeting link is valid
    if (!meetingLink.startsWith('http://') && !meetingLink.startsWith('https://')) {
        showToast('error', 'Please enter a valid meeting link starting with http:// or https://');
        return;
    }
    
    fetch('/mentorship/api/meetings/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            mentorship: mentorshipId,
            title: meetingTitle,
            meeting_date: meetingDate,
            meeting_link: meetingLink,
            description: meetingDescription,
            status: 'SCHEDULED'
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to schedule meeting');
        }
        return response.json();
    })
    .then(data => {
        var meetingModal = document.getElementById('meetingModal');
        var modal = bootstrap.Modal.getInstance(meetingModal);
        if (modal) modal.hide();
        
        showToast('success', 'Meeting scheduled successfully with the link provided');
        setTimeout(() => location.reload(), 1500);
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Failed to schedule meeting. Please try again.');
    });
}

// Submit message form
function submitMessage() {
    const mentorshipId = document.getElementById('mentorshipIdForMessage').value;
    const messageContent = document.getElementById('messageContent').value;
    const messageAttachment = document.getElementById('messageAttachment').files[0];
    
    const formData = new FormData();
    formData.append('mentorship', mentorshipId);
    formData.append('content', messageContent);
    if (messageAttachment) {
        formData.append('attachment', messageAttachment);
    }
    
    fetch('/mentorship/api/messages/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to send message');
        }
        return response.json();
    })
    .then(data => {
        var messageModal = document.getElementById('messageModal');
        var modal = bootstrap.Modal.getInstance(messageModal);
        if (modal) modal.hide();
        
        showToast('success', 'Message sent successfully');
        setTimeout(() => location.reload(), 1500);
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Failed to send message. Please try again.');
    });
}

// Show toast notification
    function showToast(type, message) {
        const toast = document.createElement('div');
        toast.className = `toast toast-${type} show`;
        toast.innerHTML = `
            <div class="toast-header">
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
                <strong class="me-auto">${type === 'success' ? 'Success' : 'Error'}</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        `;
        
        // Add toast container if it doesn't exist
        let container = document.querySelector('.toast-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'toast-container';
            container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            container.style.zIndex = '9999'; // Increased from 1050 to ensure it's always on top
            document.body.appendChild(container);
        }
        
        container.appendChild(toast);
        
        // Initialize Bootstrap toast
        const bsToast = new bootstrap.Toast(toast, {
            autohide: true,
            delay: 3000
        });
        bsToast.show();
        
        // Remove toast after it's hidden
        toast.addEventListener('hidden.bs.toast', () => {
            toast.remove();
        });
    }

// CSRF Token helper
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Function to parse existing timeline milestones when editing
function parseExistingMilestones(timelineText) {
    if (!timelineText) return;
    
    const milestonesContainer = document.getElementById('milestones-container');
    if (!milestonesContainer) {
        console.error('Milestones container not found');
        return;
    }

    // Clear existing milestone entries
    // Use the newer milestone-row class if it exists, otherwise fall back to milestone-entry
    const rowSelector = milestonesContainer.querySelector('.milestone-row') ? '.milestone-row' : '.milestone-entry';
    const existingEntries = milestonesContainer.querySelectorAll(rowSelector);
    
    // Remove all existing entries except the first one
    if (existingEntries.length > 0) {
        for (let i = 1; i < existingEntries.length; i++) {
            milestonesContainer.removeChild(existingEntries[i]);
        }
        
        // Reset the first entry
        const firstEntry = existingEntries[0];
        if (firstEntry) {
            const periodInput = firstEntry.querySelector('.milestone-period');
            const descriptionInput = firstEntry.querySelector('.milestone-description');
            
            if (periodInput) periodInput.value = '';
            if (descriptionInput) descriptionInput.value = '';
        }
    } else {
        // If no entries exist, try to add one using the new function
        if (typeof addNewMilestone === 'function') {
            console.log('Adding first milestone entry using addNewMilestone');
            addNewMilestone();
        } else {
            console.error('No milestone entries found and addNewMilestone function not available');
        }
    }
    
    // Parse the timeline text
    const lines = timelineText.split('\n');
    let additionalNotes = '';
    let inAdditionalNotes = false;
    
    lines.forEach((line, index) => {
        line = line.trim();
        if (!line) return;
        
        if (line.startsWith('Additional Notes:')) {
            inAdditionalNotes = true;
            return;
        }
        
        if (inAdditionalNotes) {
            additionalNotes += line + '\n';
            return;
        }
        
        const weekDayMatch = line.match(/^Week\/Day\s+([^:]+):\s*(.+)$/);
        if (weekDayMatch) {
            const period = weekDayMatch[1];
            let description = weekDayMatch[2];
            
            // Remove status if present
            if (description.includes('[')) {
                description = description.split('[')[0].trim();
            }
            
            // Use newer milestone-row class if it exists, otherwise fall back to milestone-entry
            const rowSelector = milestonesContainer.querySelector('.milestone-row') ? '.milestone-row' : '.milestone-entry';
            const existingEntries = milestonesContainer.querySelectorAll(rowSelector);
            
            if (index === 0 && existingEntries.length > 0) {
                // Use the first entry
                const firstEntry = existingEntries[0];
                if (firstEntry) {
                    const periodInput = firstEntry.querySelector('.milestone-period');
                    const descriptionInput = firstEntry.querySelector('.milestone-description');
                    
                    if (periodInput) periodInput.value = period;
                    if (descriptionInput) descriptionInput.value = description;
                }
            } else {
                // Add a new entry using the newer function if available
                if (typeof addNewMilestone === 'function') {
                    addNewMilestone();
                    
                    // Get the newly created row (should be the last one)
                    const newEntries = milestonesContainer.querySelectorAll(rowSelector);
                    if (newEntries.length > 0) {
                        const newEntry = newEntries[newEntries.length - 1];
                        const periodInput = newEntry.querySelector('.milestone-period');
                        const descriptionInput = newEntry.querySelector('.milestone-description');
                        
                        if (periodInput) periodInput.value = period;
                        if (descriptionInput) descriptionInput.value = description;
                    }
                } else {
                    // Fall back to using the add-milestone-btn click
                    const addMilestoneBtn = document.getElementById('add-milestone-btn');
                    if (addMilestoneBtn) {
                        addMilestoneBtn.click();
                        
                        // Find the new entry (should be the last one)
                        const allEntries = milestonesContainer.querySelectorAll(rowSelector);
                        if (allEntries.length > 0) {
                            const newEntry = allEntries[allEntries.length - 1];
                            if (newEntry) {
                                const periodInput = newEntry.querySelector('.milestone-period');
                                const descriptionInput = newEntry.querySelector('.milestone-description');
                                
                                if (periodInput) periodInput.value = period;
                                if (descriptionInput) descriptionInput.value = description;
                            } else {
                                console.error('Failed to create new milestone entry');
                            }
                        }
                    } else {
                        console.error('Add milestone button not found');
                    }
                }
            }
        }
    });
    
    // Update additional notes field
    if (additionalNotes) {
        const notesField = document.getElementById('timelineMilestones');
        if (notesField) {
            notesField.value = additionalNotes.trim();
        }
    }
}

// Function to set timeline
function setTimeline(mentorshipId) {
    // Show timeline modal
    var timelineModal = document.getElementById('timelineModal');
    if (!timelineModal) {
        console.error('Timeline modal element not found');
        showToast('error', 'Timeline modal not found. Please refresh the page and try again.');
        return;
    }
    
    var modal = bootstrap.Modal.getInstance(timelineModal) || new bootstrap.Modal(timelineModal);
    
    const mentorshipIdInput = document.getElementById('mentorshipIdForTimeline');
    if (!mentorshipIdInput) {
        console.error('Mentorship ID input element not found');
        showToast('error', 'Form elements not found. Please refresh the page and try again.');
        return;
    }
    mentorshipIdInput.value = mentorshipId;
    
    // Clear any previous error
    const errorContainer = document.getElementById('timeline-error-message');
    if (errorContainer) {
        errorContainer.classList.add('d-none');
    }
    
    // Fetch existing timeline data if available
    fetch(`/mentorship/api/requests/${mentorshipId}/`, {
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        const expectedEndDateInput = document.getElementById('expectedEndDate');
        if (expectedEndDateInput && data.expected_end_date) {
            expectedEndDateInput.value = data.expected_end_date.split('T')[0];
        }
        
        if (data.timeline_milestones) {
            parseExistingMilestones(data.timeline_milestones);
        } else {
            // Reset form if no existing timeline
            const milestonesContainer = document.getElementById('milestones-container');
            if (milestonesContainer) {
                const existingEntries = milestonesContainer.querySelectorAll('.milestone-entry');
                if (existingEntries.length > 0) {
                    // Keep only the first entry and reset it
                    for (let i = 1; i < existingEntries.length; i++) {
                        milestonesContainer.removeChild(existingEntries[i]);
                    }
                    const firstEntry = existingEntries[0];
                    if (firstEntry) {
                        const periodInput = firstEntry.querySelector('.milestone-period');
                        const descriptionInput = firstEntry.querySelector('.milestone-description');
                        if (periodInput) periodInput.value = '';
                        if (descriptionInput) descriptionInput.value = '';
                    }
                }
            }
            
            const timelineMilestonesInput = document.getElementById('timelineMilestones');
            if (timelineMilestonesInput) {
                timelineMilestonesInput.value = '';
            }
        }
        modal.show();
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Failed to fetch timeline data. Please try again.');
        modal.show(); // Show modal anyway
    });
}

// Modified submitTimeline function to include validation
function submitTimeline() {
    // Validate dates before submission
    validateAllMilestoneDates();
    
    // Get the timeline alert to check for errors
    const timelineAlert = document.getElementById('timeline-alert');
    if (timelineAlert && !timelineAlert.classList.contains('d-none')) {
        // There are validation errors, don't submit
        showToast('error', 'Please fix the timeline date errors before saving.');
        return;
    }
    
    // Original function continues here...
    const mentorshipId = document.getElementById('mentorshipIdForTimeline').value;
    const expectedEndDate = document.getElementById('expectedEndDate').value;
    const additionalNotes = document.getElementById('timelineMilestones').value;
    
    // Validate required fields
    if (!expectedEndDate) {
        showToast('error', 'Please select an expected end date');
        return;
    }
    
    // Collect all milestone entries
    const milestoneEntries = document.querySelectorAll('.milestone-entry');
    
    // Check if there are any milestone entries
    if (milestoneEntries.length === 0) {
        // Add a new milestone entry if none exist
        const addMilestoneBtn = document.getElementById('add-milestone-btn');
        if (addMilestoneBtn) {
            addMilestoneBtn.click();
            showToast('error', 'Please add at least one milestone with both period and description');
            return;
        }
    }
    
    let formattedMilestones = '';
    let hasValidMilestones = false;
    
    milestoneEntries.forEach(entry => {
        const periodInput = entry.querySelector('.milestone-period');
        const descriptionInput = entry.querySelector('.milestone-description');
        const dateInput = entry.querySelector('.milestone-date');
        
        if (!periodInput || !descriptionInput) return;
        
        const period = periodInput.value.trim();
        const description = descriptionInput.value.trim();
        const date = dateInput ? dateInput.value.trim() : '';
        
        if (period && description) {
            let formattedDescription = description;
            if (date) {
                formattedDescription = `${description} [Date: ${date}]`;
            }
            formattedMilestones += `Week/Day ${period}: ${formattedDescription}\n`;
            hasValidMilestones = true;
        } else if (period || description) {
            // If one field is filled but not the other, highlight the empty field
            if (!period) {
                periodInput.classList.add('is-invalid');
                setTimeout(() => periodInput.classList.remove('is-invalid'), 3000);
            }
            if (!description) {
                descriptionInput.classList.add('is-invalid');
                setTimeout(() => descriptionInput.classList.remove('is-invalid'), 3000);
            }
        }
    });
    
    if (!hasValidMilestones) {
        showToast('error', 'Please add at least one milestone with both period and description');
        return;
    }
    
    // Add additional notes if provided
    if (additionalNotes) {
        formattedMilestones += `\nAdditional Notes:\n${additionalNotes}`;
    }
    
    // Show loading state
    const submitButton = document.querySelector('#timelineModal .btn-primary');
    const originalText = submitButton.textContent;
    submitButton.disabled = true;
    submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
    
    fetch(`/mentorship/api/requests/${mentorshipId}/update_timeline/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            expected_end_date: expectedEndDate,
            timeline_milestones: formattedMilestones
        })
    })
    .then(async response => {
        if (!response.ok) {
            // Try to get error details from response
            const errorData = await response.json().catch(() => null);
            throw new Error(errorData?.detail || `Error: ${response.status} ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        var timelineModal = document.getElementById('timelineModal');
        var modal = bootstrap.Modal.getInstance(timelineModal);
        if (modal) modal.hide();
        
        showToast('success', 'Mentorship timeline updated successfully');
        setTimeout(() => location.reload(), 1500);
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', error.message || 'Failed to update timeline. Please try again.');
        
        // Reset button state
        submitButton.disabled = false;
        submitButton.innerHTML = originalText;
    });
}

// Enhance the timeline display with milestone markers
function enhanceTimelineDisplay() {
    document.querySelectorAll('.timeline-container').forEach(container => {
        const timelineText = container.querySelector('.timeline-text').textContent;
        const progressBar = container.querySelector('.progress');
        let progressPercentage = 0;
        
        // Get the progress percentage from the progress bar if it exists
        if (progressBar && progressBar.querySelector('.progress-bar')) {
            const progressBarStyle = progressBar.querySelector('.progress-bar').getAttribute('style');
            const percentMatch = progressBarStyle.match(/width:\s*(\d+)%/);
            if (percentMatch && percentMatch[1]) {
                progressPercentage = parseInt(percentMatch[1]);
            } else {
                // Fallback to aria-valuenow
                progressPercentage = parseInt(progressBar.querySelector('.progress-bar').getAttribute('aria-valuenow') || 0);
            }
        }
        
        if (!timelineText) return;
        
        // Parse the timeline text to extract milestones
        const lines = timelineText.split('\n');
        let milestones = [];
        let inAdditionalNotes = false;
        
        lines.forEach(line => {
            line = line.trim();
            if (!line) return;
            
            if (line.startsWith('Additional Notes:')) {
                inAdditionalNotes = true;
                return;
            }
            
            if (inAdditionalNotes) {
                return;
            }
            
            const weekDayMatch = line.match(/^Week\/Day\s+([^:]+):\s*(.+)$/);
            if (weekDayMatch) {
                const period = weekDayMatch[1];
                const description = weekDayMatch[2];
                
                // Extract status if available
                let status = 'NOT_STARTED';
                const statusMatch = description.match(/(.+)\s+\[([A-Z_]+)\]$/);
                const cleanDescription = statusMatch ? statusMatch[1].trim() : description;
                if (statusMatch) {
                    status = statusMatch[2];
                }
                
                // Parse the period to get a position for the marker
                let position = 0;
                if (period.includes('-')) {
                    const [start, end] = period.split('-').map(p => parseInt(p.trim()));
                    position = (start + end) / 2;
                } else {
                    position = parseInt(period);
                }
                
                milestones.push({
                    period: period,
                    description: cleanDescription,
                    status: status,
                    position: position
                });
            }
        });
        
        // Create thermometer-style progress bar if milestones exist
        if (milestones.length > 0) {
            // Find the maximum position to scale properly
            const maxPosition = Math.max(...milestones.map(m => m.position));
            
            // Sort milestones by position
            milestones.sort((a, b) => a.position - b.position);
            
            // Calculate completion status
            const totalMilestones = milestones.length;
            const completedMilestones = milestones.filter(m => m.status === 'COMPLETED').length;
            const inProgressMilestones = milestones.filter(m => m.status === 'IN_PROGRESS').length;
            
            // Calculate actual percentage based on milestone completion
            const calculatedPercentage = Math.round((completedMilestones + (inProgressMilestones * 0.5)) / totalMilestones * 100);
            
            // Use the calculated percentage if it's available, otherwise use the one from the progress bar
            const displayPercentage = calculatedPercentage || progressPercentage;
            
            // Create a thermometer-style progress container
            const thermometerContainer = document.createElement('div');
            thermometerContainer.style.position = 'relative';
            thermometerContainer.style.margin = '40px 0 60px';
            thermometerContainer.style.padding = '0 10px';
            
            // Add status text
            const statusElement = document.createElement('div');
            statusElement.style.position = 'absolute';
            statusElement.style.top = '-35px';
            statusElement.style.left = '10px';
            statusElement.style.fontSize = '0.85rem';
            statusElement.style.fontWeight = '500';
            statusElement.style.color = '#495057';
            
            let statusText = '';
            if (displayPercentage === 100) {
                statusText = 'Completed';
            } else if (displayPercentage > 0) {
                statusText = 'In Progress';
            } else {
                statusText = 'Not Started';
            }
            statusElement.textContent = statusText;
            thermometerContainer.appendChild(statusElement);
            
            // Add dates
            const datesContainer = document.createElement('div');
            datesContainer.style.display = 'flex';
            datesContainer.style.justifyContent = 'space-between';
            datesContainer.style.marginBottom = '10px';
            datesContainer.style.fontSize = '0.85rem';
            datesContainer.style.color = '#495057';
            datesContainer.style.fontWeight = '500';
            
            const startDateElement = container.closest('.card-body').querySelector('small:first-child');
            const endDateElement = container.closest('.card-body').querySelector('small:last-child');
            
            const startDate = startDateElement ? startDateElement.textContent.replace('Started: ', '') : 'Start';
            const endDate = endDateElement ? endDateElement.textContent.replace('Target End: ', '') : 'End';
            
            datesContainer.innerHTML = `
                <span>${startDate}</span>
                <span>${endDate}</span>
            `;
            
            thermometerContainer.appendChild(datesContainer);
            
            // Add percentage indicator
            const percentageElement = document.createElement('div');
            percentageElement.style.position = 'absolute';
            percentageElement.style.top = '-35px';
            percentageElement.style.right = '10px';
            percentageElement.style.backgroundColor = '#343a40';
            percentageElement.style.color = 'white';
            percentageElement.style.padding = '4px 10px';
            percentageElement.style.borderRadius = '20px';
            percentageElement.style.fontSize = '0.85rem';
            percentageElement.style.fontWeight = 'bold';
            percentageElement.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
            percentageElement.textContent = `${displayPercentage}%`;
            thermometerContainer.appendChild(percentageElement);
            
            // Create the thermometer track
            const trackElement = document.createElement('div');
            trackElement.style.height = '16px';
            trackElement.style.backgroundColor = '#e9ecef';
            trackElement.style.borderRadius = '8px';
            trackElement.style.position = 'relative';
            trackElement.style.boxShadow = 'inset 0 1px 3px rgba(0,0,0,0.1)';
            trackElement.style.overflow = 'hidden';
            
            // Create the thermometer fill
            const fillElement = document.createElement('div');
            fillElement.style.position = 'absolute';
            fillElement.style.top = '0';
            fillElement.style.left = '0';
            fillElement.style.height = '100%';
            fillElement.style.background = 'linear-gradient(90deg, #4481eb 0%, #04befe 100%)';
            fillElement.style.borderRadius = '8px';
            fillElement.style.transition = 'width 0.6s ease';
            fillElement.style.width = `${displayPercentage}%`;
            
            trackElement.appendChild(fillElement);
            thermometerContainer.appendChild(trackElement);
            
            // Add thermometer bulb
            const bulbElement = document.createElement('div');
            bulbElement.style.position = 'absolute';
            bulbElement.style.left = `${displayPercentage}%`;
            bulbElement.style.top = '8px';
            bulbElement.style.transform = 'translate(-50%, -50%)';
            bulbElement.style.width = '30px';
            bulbElement.style.height = '30px';
            bulbElement.style.background = 'linear-gradient(135deg, #4481eb 0%, #04befe 100%)';
            bulbElement.style.borderRadius = '50%';
            bulbElement.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
            bulbElement.style.zIndex = '2';
            bulbElement.style.border = '3px solid #fff';
            
            // Add shine effect to bulb
            const bulbShine = document.createElement('div');
            bulbShine.style.position = 'absolute';
            bulbShine.style.top = '50%';
            bulbShine.style.left = '50%';
            bulbShine.style.transform = 'translate(-50%, -50%)';
            bulbShine.style.width = '15px';
            bulbShine.style.height = '15px';
            bulbShine.style.background = 'rgba(255, 255, 255, 0.3)';
            bulbShine.style.borderRadius = '50%';
            
            bulbElement.appendChild(bulbShine);
            thermometerContainer.appendChild(bulbElement);
            
            // Create scale marks
            const scaleContainer = document.createElement('div');
            scaleContainer.style.position = 'absolute';
            scaleContainer.style.bottom = '-25px';
            scaleContainer.style.left = '0';
            scaleContainer.style.right = '0';
            
            // Add scale marks at 0%, 25%, 50%, 75%, and 100%
            [0, 25, 50, 75, 100].forEach(percent => {
                const scaleMark = document.createElement('div');
                scaleMark.style.position = 'absolute';
                scaleMark.style.width = '1px';
                scaleMark.style.height = '10px';
                scaleMark.style.backgroundColor = '#6c757d';
                scaleMark.style.bottom = '15px';
                scaleMark.style.left = `${percent}%`;
                
                const scaleLabel = document.createElement('div');
                scaleLabel.style.position = 'absolute';
                scaleLabel.style.transform = 'translateX(-50%)';
                scaleLabel.style.bottom = '0';
                scaleLabel.style.left = `${percent}%`;
                scaleLabel.style.fontSize = '0.75rem';
                scaleLabel.style.color = '#6c757d';
                scaleLabel.textContent = `${percent}%`;
                
                scaleContainer.appendChild(scaleMark);
                scaleContainer.appendChild(scaleLabel);
            });
            
            thermometerContainer.appendChild(scaleContainer);
            
            // Create milestone markers container
            const markersContainer = document.createElement('div');
            markersContainer.style.position = 'relative';
            markersContainer.style.height = '60px';
            markersContainer.style.marginTop = '10px';
            
            // Add milestone markers
            milestones.forEach((milestone, index) => {
                const position = (milestone.position / maxPosition) * 100;
                
                const markerElement = document.createElement('div');
                markerElement.style.position = 'absolute';
                markerElement.style.transform = 'translateX(-50%)';
                markerElement.style.left = `${position}%`;
                
                // Create marker line
                const markerLine = document.createElement('div');
                markerLine.style.width = '2px';
                markerLine.style.height = milestone.status === 'COMPLETED' ? '15px' : 
                                          milestone.status === 'IN_PROGRESS' ? '12px' : '10px';
                markerLine.style.backgroundColor = milestone.status === 'COMPLETED' ? '#28a745' : 
                                                  milestone.status === 'IN_PROGRESS' ? '#ffc107' : '#6c757d';
                markerLine.style.margin = '0 auto 5px';
                
                // Create marker dot
                const markerDot = document.createElement('div');
                markerDot.style.width = '24px';
                markerDot.style.height = '24px';
                markerDot.style.borderRadius = '50%';
                markerDot.style.backgroundColor = milestone.status === 'COMPLETED' ? '#28a745' : 
                                                 milestone.status === 'IN_PROGRESS' ? '#ffc107' : '#e9ecef';
                markerDot.style.border = '3px solid #fff';
                markerDot.style.boxShadow = milestone.status === 'COMPLETED' ? '0 0 0 2px rgba(40, 167, 69, 0.3)' : 
                                           milestone.status === 'IN_PROGRESS' ? '0 0 0 2px rgba(255, 193, 7, 0.3)' : '0 0 0 2px #e9ecef';
                markerDot.style.margin = '0 auto 8px';
                markerDot.style.position = 'relative';
                markerDot.style.zIndex = '3';
                markerDot.style.cursor = 'pointer';
                
                // Create marker label
                const markerLabel = document.createElement('div');
                markerLabel.style.fontSize = '0.8rem';
                markerLabel.style.color = '#495057';
                markerLabel.style.textAlign = 'center';
                markerLabel.style.maxWidth = '100px';
                markerLabel.style.overflow = 'hidden';
                markerLabel.style.textOverflow = 'ellipsis';
                markerLabel.style.whiteSpace = 'nowrap';
                markerLabel.style.fontWeight = '500';
                markerLabel.style.position = 'relative';
                markerLabel.textContent = `Day ${milestone.period}`;
                
                // Create tooltip
                const tooltip = document.createElement('div');
                tooltip.style.position = 'absolute';
                tooltip.style.bottom = '100%';
                tooltip.style.left = '50%';
                tooltip.style.transform = 'translateX(-50%)';
                tooltip.style.backgroundColor = '#343a40';
                tooltip.style.color = 'white';
                tooltip.style.padding = '8px 12px';
                tooltip.style.borderRadius = '4px';
                tooltip.style.fontSize = '0.8rem';
                tooltip.style.whiteSpace = 'nowrap';
                tooltip.style.opacity = '0';
                tooltip.style.visibility = 'hidden';
                tooltip.style.transition = 'opacity 0.3s, visibility 0.3s';
                tooltip.style.zIndex = '10';
                tooltip.style.pointerEvents = 'none';
                tooltip.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
                tooltip.style.minWidth = '150px';
                tooltip.style.textAlign = 'center';
                tooltip.style.marginBottom = '10px';
                
                let statusText = 'Not Started';
                if (milestone.status === 'IN_PROGRESS') {
                    statusText = 'In Progress';
                } else if (milestone.status === 'COMPLETED') {
                    statusText = 'Completed';
                }
                
                tooltip.innerHTML = `
                    <div>${milestone.description}</div>
                    <div style="margin-top: 5px; font-weight: bold; color: ${
                        milestone.status === 'COMPLETED' ? '#28a745' : 
                        milestone.status === 'IN_PROGRESS' ? '#ffc107' : '#6c757d'
                    }">
                        ${statusText}
                    </div>
                `;
                
                // Add tooltip arrow
                const tooltipArrow = document.createElement('div');
                tooltipArrow.style.position = 'absolute';
                tooltipArrow.style.top = '100%';
                tooltipArrow.style.left = '50%';
                tooltipArrow.style.transform = 'translateX(-50%)';
                tooltipArrow.style.borderWidth = '6px';
                tooltipArrow.style.borderStyle = 'solid';
                tooltipArrow.style.borderColor = '#343a40 transparent transparent transparent';
                
                tooltip.appendChild(tooltipArrow);
                
                // Show tooltip on hover
                markerDot.addEventListener('mouseenter', () => {
                    tooltip.style.opacity = '1';
                    tooltip.style.visibility = 'visible';
                });
                
                markerDot.addEventListener('mouseleave', () => {
                    tooltip.style.opacity = '0';
                    tooltip.style.visibility = 'hidden';
                });
                
                markerElement.appendChild(tooltip);
                markerElement.appendChild(markerLine);
                markerElement.appendChild(markerDot);
                markerElement.appendChild(markerLabel);
                
                markersContainer.appendChild(markerElement);
            });
            
            thermometerContainer.appendChild(markersContainer);
            
            // Replace the original progress bar with our thermometer version
            if (progressBar) {
                progressBar.style.display = 'none';
                progressBar.parentNode.insertBefore(thermometerContainer, progressBar.nextSibling);
            } else {
                // If no progress bar exists, just add it to the container
                container.insertBefore(thermometerContainer, container.firstChild);
            }
            
            // Hide the original timeline text
            const timelineTextElement = container.querySelector('.timeline-text');
            timelineTextElement.style.display = 'none';
            
            // Add a button to toggle the original text
            const toggleButton = document.createElement('button');
            toggleButton.className = 'btn btn-sm btn-outline-secondary mt-2';
            toggleButton.textContent = 'Show Original Timeline';
            toggleButton.addEventListener('click', function() {
                if (timelineTextElement.style.display === 'none') {
                    timelineTextElement.style.display = 'block';
                    this.textContent = 'Hide Original Timeline';
                } else {
                    timelineTextElement.style.display = 'none';
                    this.textContent = 'Show Original Timeline';
                }
            });
            
            thermometerContainer.parentNode.insertBefore(toggleButton, thermometerContainer.nextSibling);
        }
    });
}

// Function to show the timeline status modal
function showTimelineStatusModal(mentorshipId) {
    // Show timeline status modal
    var statusModal = document.getElementById('timelineStatusModal');
    var modal = bootstrap.Modal.getInstance(statusModal) || new bootstrap.Modal(statusModal);
    document.getElementById('mentorshipIdForStatus').value = mentorshipId;
    
    // Fetch timeline milestones
    fetch(`/mentorship/api/requests/${mentorshipId}/`, {
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        loadTimelineMilestones(data.timeline_milestones, mentorshipId);
        modal.show();
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Failed to fetch timeline data. Please try again.');
        modal.show(); // Show modal anyway
    });
}

// Function to load timeline milestones
function loadTimelineMilestones(timelineText, mentorshipId) {
    const container = document.getElementById('milestone-status-container');
    const noMilestonesMessage = document.getElementById('no-milestones-message');
    
    // Clear existing content
    container.innerHTML = '';
    
    if (!timelineText) {
        container.appendChild(noMilestonesMessage);
        return;
    }
    
    // Parse the timeline text to extract milestones
    const lines = timelineText.split('\n');
    let milestones = [];
    let inAdditionalNotes = false;
    
    lines.forEach(line => {
        line = line.trim();
        if (!line) return;
        
        if (line.startsWith('Additional Notes:')) {
            inAdditionalNotes = true;
            return;
        }
        
        if (inAdditionalNotes) {
            return;
        }
        
        const weekDayMatch = line.match(/^Week\/Day\s+([^:]+):\s*(.+)$/);
        if (weekDayMatch) {
            const period = weekDayMatch[1];
            const description = weekDayMatch[2];
            
            // Extract status if available
            let status = 'NOT_STARTED';
            const statusMatch = description.match(/(.+)\s+\[([A-Z_]+)\]$/);
            const cleanDescription = statusMatch ? statusMatch[1].trim() : description;
            if (statusMatch) {
                status = statusMatch[2];
            }
            
            milestones.push({
                period: period,
                description: cleanDescription,
                status: status
            });
        }
    });
    
    if (milestones.length === 0) {
        container.appendChild(noMilestonesMessage);
        return;
    }
    
    // Create milestone status items
    milestones.forEach(milestone => {
        const statusItem = document.createElement('div');
        statusItem.className = 'milestone-status-item';
        
        statusItem.innerHTML = `
            <div class="milestone-title">Week/Day ${milestone.period}</div>
            <div class="milestone-description">${milestone.description}</div>
            <div class="form-group">
                <label class="form-label">Status</label>
                <select class="form-select milestone-status" data-period="${milestone.period}" data-description="${milestone.description}">
                    <option value="NOT_STARTED" ${milestone.status === 'NOT_STARTED' ? 'selected' : ''}>Not Started</option>
                    <option value="IN_PROGRESS" ${milestone.status === 'IN_PROGRESS' ? 'selected' : ''}>In Progress</option>
                    <option value="COMPLETED" ${milestone.status === 'COMPLETED' ? 'selected' : ''}>Completed</option>
                </select>
            </div>
        `;
        
        container.appendChild(statusItem);
    });
    
    // Also update the enhanced timeline display
    updateEnhancedTimelineDisplay(mentorshipId, milestones);
}

// Function to save timeline status
function saveTimelineStatus() {
    const mentorshipId = document.getElementById('mentorshipIdForStatus').value;
    
    // Collect milestone status updates
    const milestoneStatuses = [];
    document.querySelectorAll('.milestone-status').forEach(dropdown => {
        milestoneStatuses.push({
            period: dropdown.getAttribute('data-period'),
            description: dropdown.getAttribute('data-description'),
            status: dropdown.value
        });
    });
    
    // Update milestone statuses
    fetch('/mentorship/api/milestones/update_batch/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            mentorship: mentorshipId,
            milestones: milestoneStatuses
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to update milestone statuses');
        }
        return response.json();
    })
    .then(data => {
        // Then update the timeline text with status
        return fetch(`/mentorship/api/requests/${mentorshipId}/update_timeline/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                update_milestones_in_timeline: true,
                milestone_statuses: milestoneStatuses
            })
        });
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to update timeline');
        }
        return response.json();
    })
    .then(data => {
        var statusModal = document.getElementById('timelineStatusModal');
        var modal = bootstrap.Modal.getInstance(statusModal);
        if (modal) modal.hide();
        
        showToast('success', 'Timeline status updated successfully');
        setTimeout(() => location.reload(), 1500);
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Failed to update timeline status. Please try again.');
    });
}

// Function to update the enhanced timeline display
function updateEnhancedTimelineDisplay(mentorshipId, milestones) {
    const timelineContainer = document.getElementById(`timeline-milestones-${mentorshipId}`);
    if (!timelineContainer) return;
    
    // Clear existing content
    timelineContainer.innerHTML = '';
    
    // Sort milestones by period
    milestones.sort((a, b) => {
        const periodA = a.period.includes('-') ? 
            parseInt(a.period.split('-')[0]) : parseInt(a.period);
        const periodB = b.period.includes('-') ? 
            parseInt(b.period.split('-')[0]) : parseInt(b.period);
        return periodA - periodB;
    });
    
    // Create milestone cards
    milestones.forEach((milestone, index) => {
        const milestoneElement = document.createElement('div');
        milestoneElement.className = 'timeline-milestone';
        
        // Extract topics from description (if any)
        let description = milestone.description;
        let topics = [];
        
        // Check if description contains topics (bullet points)
        if (description.includes('')) {
            const parts = description.split('');
            description = parts[0].trim();
            topics = parts.slice(1).map(topic => topic.trim()).filter(topic => topic);
        }
        
        // Determine status class
        const statusClass = milestone.status.toLowerCase().replace('_', '-');
        
        // Create milestone card
        milestoneElement.innerHTML = `
            <div class="timeline-milestone-card">
                <div class="timeline-milestone-header ${statusClass}">
                    <span>Week/Day ${milestone.period}</span>
                    <span>${milestone.status === 'COMPLETED' ? 'Completed' : 
                           milestone.status === 'IN_PROGRESS' ? 'In Progress' : 'Not Started'}</span>
                </div>
                <div class="timeline-milestone-title">${description}</div>
                ${topics.length > 0 ? `
                <div class="timeline-milestone-topics">
                    <div class="timeline-milestone-topics-title">Topics/Activities:</div>
                    <ul>
                        ${topics.map(topic => `<li>${topic}</li>`).join('')}
                    </ul>
                </div>
                ` : ''}
                <select class="timeline-milestone-status-select" 
                        data-period="${milestone.period}" 
                        data-description="${milestone.description}"
                        onchange="updateMilestoneStatus(this, '${mentorshipId}')">
                    <option value="NOT_STARTED" ${milestone.status === 'NOT_STARTED' ? 'selected' : ''}>Not Started</option>
                    <option value="IN_PROGRESS" ${milestone.status === 'IN_PROGRESS' ? 'selected' : ''}>In Progress</option>
                    <option value="COMPLETED" ${milestone.status === 'COMPLETED' ? 'selected' : ''}>Completed</option>
                </select>
            </div>
            <div class="timeline-milestone-dot ${statusClass}"></div>
        `;
        
        timelineContainer.appendChild(milestoneElement);
    });
}

// Function to update a single milestone status directly from the timeline
function updateMilestoneStatus(selectElement, mentorshipId) {
    const period = selectElement.getAttribute('data-period');
    const description = selectElement.getAttribute('data-description');
    const status = selectElement.value;
    
    // Update milestone status
    fetch('/mentorship/api/milestones/update_batch/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            mentorship: mentorshipId,
            milestones: [{
                period: period,
                description: description,
                status: status
            }]
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to update milestone status');
        }
        return response.json();
    })
    .then(data => {
        // Then update the timeline text with status
        return fetch(`/mentorship/api/requests/${mentorshipId}/update_timeline/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                update_milestones_in_timeline: true,
                milestone_statuses: [{
                    period: period,
                    description: description,
                    status: status
                }]
            })
        });
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to update timeline');
        }
        return response.json();
    })
    .then(data => {
        showToast('success', 'Milestone status updated');
        
        // Update the UI without reloading
        const card = selectElement.closest('.timeline-milestone-card');
        const header = card.querySelector('.timeline-milestone-header');
        const dot = selectElement.closest('.timeline-milestone').querySelector('.timeline-milestone-dot');
        
        // Update status classes
        header.className = 'timeline-milestone-header';
        dot.className = 'timeline-milestone-dot';
        
        const statusClass = status.toLowerCase().replace('_', '-');
        header.classList.add(statusClass);
        dot.classList.add(statusClass);
        
        // Update status text
        const statusText = status === 'COMPLETED' ? 'Completed' : 
                          status === 'IN_PROGRESS' ? 'In Progress' : 'Not Started';
        header.querySelector('span:last-child').textContent = statusText;
        
        // Calculate new progress percentage
        calculateProgressPercentage(mentorshipId);
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Failed to update milestone status');
        
        // Reset the select to its previous value
        selectElement.value = selectElement.getAttribute('data-previous-value');
    });
    
    // Store the current value for potential rollback
    selectElement.setAttribute('data-previous-value', status);
}

// Function to calculate progress percentage based on milestone statuses
function calculateProgressPercentage(mentorshipId) {
    // Get all milestone status selects
    const selects = document.querySelectorAll(`#timeline-milestones-${mentorshipId} .timeline-milestone-status-select`);
    if (selects.length === 0) return;
    
    // Count completed and in-progress milestones
    let completed = 0;
    let inProgress = 0;
    
    selects.forEach(select => {
        if (select.value === 'COMPLETED') {
            completed++;
        } else if (select.value === 'IN_PROGRESS') {
            inProgress++;
        }
    });
    
    // Calculate percentage (completed + half of in-progress)
    const total = selects.length;
    const percentage = Math.round((completed + (inProgress * 0.5)) / total * 100);
    
    // Update progress bar
    const progressBar = document.querySelector(`#mentorship${mentorshipId} .progress-bar`);
    if (progressBar) {
        progressBar.style.width = `${percentage}%`;
        progressBar.setAttribute('aria-valuenow', percentage);
        progressBar.textContent = `${percentage}%`;
        
        // Step-progress-bar update code removed as requested
        
        // Also update the progress percentage on the server
        fetch(`/mentorship/api/requests/${mentorshipId}/update_timeline/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                progress_percentage: percentage
            })
        })
        .catch(error => {
            console.error('Error updating progress percentage:', error);
        });
    }
}

// Function to toggle timeline text view
function toggleTimelineText(mentorshipId) {
    const timelineText = document.querySelector(`#mentorship${mentorshipId} .timeline-text`);
    const toggleButton = document.querySelector(`#toggle-text-${mentorshipId}`);
    
    if (timelineText.style.display === 'none') {
        timelineText.style.display = 'block';
        toggleButton.textContent = 'Hide Text View';
    } else {
        timelineText.style.display = 'none';
        toggleButton.textContent = 'Show Text View';
    }
}

// Initialize enhanced timeline displays when the DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // ... existing code ...
    
    // Initialize enhanced timeline displays
    document.querySelectorAll('.timeline-container').forEach(container => {
        const mentorshipId = container.closest('.accordion-collapse').id.replace('mentorship-', '');
        const timelineText = container.querySelector('.timeline-text').textContent;
        
        if (timelineText) {
            // Parse the timeline text to extract milestones
            const lines = timelineText.split('\n');
            let milestones = [];
            let inAdditionalNotes = false;
            
            lines.forEach(line => {
                line = line.trim();
                if (!line) return;
                
                if (line.startsWith('Additional Notes:')) {
                    inAdditionalNotes = true;
                    return;
                }
                
                if (inAdditionalNotes) {
                    return;
                }
                
                const weekDayMatch = line.match(/^Week\/Day\s+([^:]+):\s*(.+)$/);
                if (weekDayMatch) {
                    const period = weekDayMatch[1];
                    const description = weekDayMatch[2];
                    
                    // Extract status if available
                    let status = 'NOT_STARTED';
                    const statusMatch = description.match(/(.+)\s+\[([A-Z_]+)\]$/);
                    const cleanDescription = statusMatch ? statusMatch[1].trim() : description;
                    if (statusMatch) {
                        status = statusMatch[2];
                    }
                    
                    milestones.push({
                        period: period,
                        description: cleanDescription,
                        status: status
                    });
                }
            });
            
            // Update the enhanced timeline display
            updateEnhancedTimelineDisplay(mentorshipId, milestones);
        }
    });
});

// Function to show progress details modal
function showProgressDetails(mentorshipId) {
    try {
        // Validate mentorshipId
        if (!mentorshipId || mentorshipId === '') {
            console.error('Invalid mentorship ID');
            showToast('error', 'Error loading progress details: Invalid mentorship ID');
            return;
        }
        
        // Show progress details modal
        var progressDetailsModal = document.getElementById('progressDetailsModal');
        if (!progressDetailsModal) {
            console.error('Progress details modal element not found');
            showToast('error', 'Error loading progress details: Modal not found');
            return;
        }
        
        var modal = bootstrap.Modal.getInstance(progressDetailsModal) || new bootstrap.Modal(progressDetailsModal);
        
        // Log the mentorship ID to help with debugging
        console.log('Fetching details for mentorship ID:', mentorshipId);
        
        // Fetch mentorship data
        fetch(`/mentorship/api/requests/${mentorshipId}/`, {
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            if (!response.ok) {
                // More detailed error handling
                if (response.status === 404) {
                    throw new Error('Mentorship not found. It may have been deleted or you may not have access.');
                } else if (response.status === 403) {
                    throw new Error('Permission denied. You do not have access to this mentorship.');
                } else if (response.status >= 500) {
                    throw new Error('Server error. Please try again later.');
                } else {
                    // Try to get more details from the response if possible
                    return response.json()
                        .then(errData => {
                            throw new Error(errData.detail || errData.message || `Network response error: ${response.status} ${response.statusText}`);
                        })
                        .catch(jsonErr => {
                            // If we can't parse the JSON, just use the status
                            throw new Error(`Network response error: ${response.status} ${response.statusText}`);
                        });
                }
            }
            return response.json();
        })
        .then(data => {
            try {
                // Update progress percentage
                const progressPercentage = data.progress_percentage || 0;
                const progressBar = document.querySelector('#progressDetailsModal .progress-bar');
                const progressDisplay = document.querySelector('#progressDetailsModal .progress-percentage-display');
                
                if (progressBar) {
                    progressBar.style.width = `${progressPercentage}%`;
                    progressBar.setAttribute('aria-valuenow', progressPercentage);
                    progressBar.textContent = `${progressPercentage}%`;
                }
                
                if (progressDisplay) {
                    progressDisplay.textContent = `${progressPercentage}%`;
                }
                
                // Parse timeline milestones
                if (data.timeline_milestones) {
                    parseMilestonesForDetails(data.timeline_milestones, mentorshipId);
                } else {
                    // Clear milestone displays if no timeline
                    const elements = {
                        completed: document.getElementById('completed-milestones'),
                        inProgress: document.getElementById('in-progress-milestones'),
                        notStarted: document.getElementById('not-started-milestones'),
                        total: document.getElementById('total-milestones'),
                        container: document.getElementById('timeline-visual-container'),
                        tableBody: document.getElementById('milestone-table-body')
                    };
                    
                    // Safely update elements if they exist
                    if (elements.completed) elements.completed.textContent = '0';
                    if (elements.inProgress) elements.inProgress.textContent = '0';
                    if (elements.notStarted) elements.notStarted.textContent = '0';
                    if (elements.total) elements.total.textContent = '0';
                    
                    if (elements.container) {
                        elements.container.innerHTML = '<div class="text-center py-4 text-muted"><i class="fas fa-info-circle me-2"></i>No timeline milestones found</div>';
                    }
                    
                    if (elements.tableBody) {
                        elements.tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No milestones found</td></tr>';
                    }
                }
                
                // Show the modal
                modal.show();
            } catch (innerError) {
                console.error('Error processing mentorship data:', innerError);
                showToast('error', 'Error processing mentorship data');
            }
        })
        .catch(error => {
            console.error('Error fetching mentorship data:', error);
            // Show a more informative error message to the user
            showToast('error', `Failed to fetch progress details: ${error.message || 'Please try again.'}`);
            // Optionally close the modal if it's showing a loading state
            if (modal && typeof modal.hide === 'function') {
                modal.hide();
            }
        });
    } catch (error) {
        console.error('Error in showProgressDetails:', error);
        showToast('error', 'An unexpected error occurred');
    }
}

// Function to parse milestones for the details modal
function parseMilestonesForDetails(timelineText, mentorshipId) {
    try {
        if (!timelineText) {
            console.warn('No timeline text provided to parseMilestonesForDetails');
            return;
        }
        
        // Parse the timeline text to extract milestones
        const lines = timelineText.split('\n');
        let milestones = [];
        let inAdditionalNotes = false;
        
        lines.forEach(line => {
            line = line.trim();
            if (!line) return;
            
            if (line.startsWith('Additional Notes:')) {
                inAdditionalNotes = true;
                return;
            }
            
            if (inAdditionalNotes) {
                return;
            }
            
            const weekDayMatch = line.match(/^Week\/Day\s+([^:]+):\s*(.+)$/);
            if (weekDayMatch) {
                const period = weekDayMatch[1];
                const description = weekDayMatch[2];
                
                // Extract status if available
                let status = 'NOT_STARTED';
                const statusMatch = description.match(/(.+)\s+\[([A-Z_]+)\]$/);
                const cleanDescription = statusMatch ? statusMatch[1].trim() : description;
                if (statusMatch) {
                    status = statusMatch[2];
                }
                
                // Parse the period to get a position for the marker
                let position = 0;
                try {
                    if (period.includes('-')) {
                        const [start, end] = period.split('-').map(p => parseInt(p.trim()));
                        position = (start + end) / 2;
                    } else {
                        position = parseInt(period);
                    }
                    
                    // Handle NaN case
                    if (isNaN(position)) {
                        position = milestones.length + 1;
                    }
                } catch (error) {
                    console.warn('Error parsing period position:', error);
                    position = milestones.length + 1;
                }
                
                milestones.push({
                    period: period,
                    description: cleanDescription,
                    status: status,
                    position: position
                });
            }
        });
        
        // Sort milestones by position
        milestones.sort((a, b) => a.position - b.position);
        
        // Update milestone statistics
        const completedCount = milestones.filter(m => m.status === 'COMPLETED').length;
        const inProgressCount = milestones.filter(m => m.status === 'IN_PROGRESS').length;
        const notStartedCount = milestones.filter(m => m.status === 'NOT_STARTED').length;
        const totalCount = milestones.length;
        
        // Safely update DOM elements
        const elements = {
            completed: document.getElementById('completed-milestones'),
            inProgress: document.getElementById('in-progress-milestones'),
            notStarted: document.getElementById('not-started-milestones'),
            total: document.getElementById('total-milestones')
        };
        
        if (elements.completed) elements.completed.textContent = completedCount;
        if (elements.inProgress) elements.inProgress.textContent = inProgressCount;
        if (elements.notStarted) elements.notStarted.textContent = notStartedCount;
        if (elements.total) elements.total.textContent = totalCount;
        
        // Render timeline visualization
        renderTimelineVisualization(milestones);
        
        // Render milestone table
        renderMilestoneTable(milestones, mentorshipId);
    } catch (error) {
        console.error('Error parsing milestones:', error);
        showToast('error', 'Error parsing milestone data');
    }
}

// Function to render timeline visualization
function renderTimelineVisualization(milestones) {
    try {
        const container = document.getElementById('timeline-visual-container');
        if (!container) {
            console.error('Timeline container element not found');
            return;
        }
        
        container.innerHTML = '';
        
        if (!milestones || milestones.length === 0) {
            container.innerHTML = '<div class="text-center py-4 text-muted"><i class="fas fa-info-circle me-2"></i>No timeline milestones found</div>';
            return;
        }
        
        // Find the maximum position to scale properly
        const maxPosition = Math.max(...milestones.map(m => m.position));
        
        // Create the timeline container with enhanced styling
        const timelineContainer = document.createElement('div');
        timelineContainer.className = 'enhanced-timeline-container';
        container.appendChild(timelineContainer);
        
        // Create the timeline line
        const timelineLine = document.createElement('div');
        timelineLine.className = 'enhanced-timeline-line';
        timelineContainer.appendChild(timelineLine);
        
        // Create the progress fill
        const progressFill = document.createElement('div');
        progressFill.className = 'enhanced-timeline-progress-fill';
        timelineContainer.appendChild(progressFill);
        
        // Calculate progress percentage based on milestones
        const completedMilestones = milestones.filter(m => m.status === 'COMPLETED').length;
        const inProgressMilestones = milestones.filter(m => m.status === 'IN_PROGRESS').length;
        const progressPercentage = Math.round((completedMilestones + (inProgressMilestones * 0.5)) / milestones.length * 100);
        
        // Update the progress badge
        const progressBadge = document.getElementById('timeline-progress-badge');
        if (progressBadge) {
            progressBadge.textContent = `${progressPercentage}%`;
            
            // Update badge color based on progress
            progressBadge.className = 'badge';
            if (progressPercentage < 25) {
                progressBadge.classList.add('bg-danger');
            } else if (progressPercentage < 50) {
                progressBadge.classList.add('bg-warning');
            } else if (progressPercentage < 75) {
                progressBadge.classList.add('bg-info');
            } else if (progressPercentage < 100) {
                progressBadge.classList.add('bg-primary');
            } else {
                progressBadge.classList.add('bg-success');
            }
        }
        
        // Animate the progress fill
        setTimeout(() => {
            progressFill.style.width = `${progressPercentage}%`;
        }, 300);
        
        // Add padding to ensure markers don't overflow
        // Use 10% padding on each side to keep markers within bounds
        const paddingPercentage = 10;
        const usableWidth = 100 - (paddingPercentage * 2);
        
        // Add milestone markers with enhanced styling
        milestones.forEach((milestone, index) => {
            try {
                // Calculate position with padding to prevent overflow
                // Map the position from 0-100% to paddingPercentage-(100-paddingPercentage)%
                const rawPosition = (milestone.position / maxPosition) * 100;
                const adjustedPosition = (rawPosition * usableWidth / 100) + paddingPercentage;
                
                // Create milestone marker wrapper
                const markerWrapper = document.createElement('div');
                markerWrapper.className = 'enhanced-milestone-marker-wrapper';
                markerWrapper.style.left = `${adjustedPosition}%`;
                timelineContainer.appendChild(markerWrapper);
                
                // Create the actual marker
                const markerElement = document.createElement('div');
                markerElement.className = `enhanced-milestone-marker ${milestone.status.toLowerCase().replace('_', '-')}`;
                
                // Add milestone number inside marker
                markerElement.innerHTML = `<span>${index + 1}</span>`;
                markerWrapper.appendChild(markerElement);
                
                // Create tooltip with enhanced styling
                const tooltip = document.createElement('div');
                tooltip.className = 'enhanced-milestone-tooltip';
                
                let statusText = 'Not Started';
                let statusClass = 'not-started';
                if (milestone.status === 'IN_PROGRESS') {
                    statusText = 'In Progress';
                    statusClass = 'in-progress';
                } else if (milestone.status === 'COMPLETED') {
                    statusText = 'Completed';
                    statusClass = 'completed';
                }
                
                tooltip.innerHTML = `
                    <div class="tooltip-header">
                        <span class="tooltip-title">Week/Day ${milestone.period}</span>
                        <span class="tooltip-status ${statusClass}">${statusText}</span>
                    </div>
                    <div class="tooltip-body">${milestone.description}</div>
                `;
                
                markerWrapper.appendChild(tooltip);
                
                // Add click event to show milestone details
                markerWrapper.addEventListener('click', function() {
                    try {
                        // Highlight the corresponding row in the milestone table
                        const tableRows = document.querySelectorAll('#milestone-table-body tr');
                        tableRows.forEach((row, rowIndex) => {
                            if (rowIndex === index) {
                                row.classList.add('table-active');
                                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            } else {
                                row.classList.remove('table-active');
                            }
                        });
                    } catch (clickError) {
                        console.warn('Error in milestone click handler:', clickError);
                    }
                });
            } catch (milestoneError) {
                console.warn(`Error rendering milestone ${index}:`, milestoneError);
            }
        });
        
        // Add current position indicator if there are in-progress milestones
        if (inProgressMilestones > 0) {
            try {
                const currentPositionMarker = document.createElement('div');
                currentPositionMarker.className = 'enhanced-current-position-marker';
                currentPositionMarker.innerHTML = '<i class="fas fa-map-marker-alt"></i>';
                
                // Adjust the position of the current marker to match the progress fill
                const adjustedProgressPosition = (progressPercentage * usableWidth / 100) + paddingPercentage;
                currentPositionMarker.style.left = `${adjustedProgressPosition}%`;
                
                timelineContainer.appendChild(currentPositionMarker);
            } catch (markerError) {
                console.warn('Error adding current position marker:', markerError);
            }
        }
        
        // Removed the milestone labels below the timeline as requested
    } catch (error) {
        console.error('Error rendering timeline visualization:', error);
        const container = document.getElementById('timeline-visual-container');
        if (container) {
            container.innerHTML = '<div class="text-center py-4 text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error rendering timeline</div>';
        }
    }
}

// Function to render milestone table
function renderMilestoneTable(milestones, mentorshipId) {
    try {
        const tableBody = document.getElementById('milestone-table-body');
        if (!tableBody) {
            console.error('Milestone table body element not found');
            return;
        }
        
        tableBody.innerHTML = '';
        
        if (!milestones || milestones.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No milestones found</td></tr>';
            return;
        }
        
        milestones.forEach((milestone, index) => {
            try {
                const row = document.createElement('tr');
                
                let statusText = 'Not Started';
                let statusClass = 'not-started';
                if (milestone.status === 'IN_PROGRESS') {
                    statusText = 'In Progress';
                    statusClass = 'in-progress';
                } else if (milestone.status === 'COMPLETED') {
                    statusText = 'Completed';
                    statusClass = 'completed';
                }
                
                // Safely escape HTML to prevent XSS
                const safeDescription = milestone.description
                    ? milestone.description.replace(/</g, '&lt;').replace(/>/g, '&gt;')
                    : '';
                const safePeriod = milestone.period
                    ? milestone.period.replace(/</g, '&lt;').replace(/>/g, '&gt;')
                    : '';
                
                row.innerHTML = `
                    <td>Week/Day ${safePeriod}</td>
                    <td>${safeDescription}</td>
                    <td><span class="timeline-status-badge ${statusClass}">${statusText}</span></td>
                    <td>
                        <select class="form-select form-select-sm milestone-quick-status" 
                                data-period="${safePeriod}" 
                                data-description="${safeDescription}"
                                data-mentorship="${mentorshipId}"
                                onchange="updateQuickMilestoneStatus(this)">
                            <option value="NOT_STARTED" ${milestone.status === 'NOT_STARTED' ? 'selected' : ''}>Not Started</option>
                            <option value="IN_PROGRESS" ${milestone.status === 'IN_PROGRESS' ? 'selected' : ''}>In Progress</option>
                            <option value="COMPLETED" ${milestone.status === 'COMPLETED' ? 'selected' : ''}>Completed</option>
                        </select>
                    </td>
                `;
                
                tableBody.appendChild(row);
            } catch (rowError) {
                console.warn(`Error rendering milestone row ${index}:`, rowError);
            }
        });
    } catch (error) {
        console.error('Error rendering milestone table:', error);
        const tableBody = document.getElementById('milestone-table-body');
        if (tableBody) {
            tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error rendering milestone table</td></tr>';
        }
    }
}

// Function to update a single milestone status from the details modal
function updateQuickMilestoneStatus(selectElement) {
    try {
        const period = selectElement.getAttribute('data-period');
        const description = selectElement.getAttribute('data-description');
        const mentorshipId = selectElement.getAttribute('data-mentorship');
        const status = selectElement.value;
        
        // Validate required data
        if (!period || !mentorshipId || !status) {
            console.error('Missing required data for milestone update:', { period, mentorshipId, status });
            showToast('error', 'Missing required data for milestone update');
            return;
        }
        
        // Store the original select element and its parent for later reference
        const parentElement = selectElement.parentElement;
        const originalHtml = parentElement.innerHTML;
        
        // Create and insert a loading spinner that preserves the width of the original element
        const originalWidth = parentElement.offsetWidth;
        parentElement.innerHTML = `<div class="d-flex justify-content-center align-items-center" style="min-width: ${originalWidth}px;">
            <div class="spinner-border spinner-border-sm text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>`;
        
        // Skip the milestone update API and go directly to the timeline update
        // This avoids the need for milestone IDs which we don't have in the UI
        fetch(`/mentorship/api/requests/${mentorshipId}/update_timeline/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                update_milestones_in_timeline: true,
                milestone_statuses: [{
                    period: period,
                    description: description,
                    status: status
                }]
            })
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    try {
                        // Try to parse as JSON
                        const errorData = JSON.parse(text);
                        throw new Error(`Failed to update timeline: ${JSON.stringify(errorData)}`);
                    } catch (e) {
                        // If not JSON, use text
                        throw new Error(`Failed to update timeline: ${text || response.statusText}`);
                    }
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Timeline update successful:', data);
            showToast('success', 'Milestone status updated');
            
            // Update the UI to reflect the changes
            try {
                // Update the milestone status in the UI
                const milestoneMarkers = document.querySelectorAll('.enhanced-milestone-marker-wrapper');
                milestoneMarkers.forEach((marker, index) => {
                    const tooltip = marker.querySelector('.tooltip-status');
                    if (tooltip) {
                        const tooltipTitle = marker.querySelector('.tooltip-title');
                        if (tooltipTitle && tooltipTitle.textContent.includes(period)) {
                            // Update the status class
                            tooltip.className = 'tooltip-status';
                            tooltip.classList.add(status.toLowerCase().replace('_', '-'));
                            
                            // Update the status text
                            let statusText = 'Not Started';
                            if (status === 'IN_PROGRESS') statusText = 'In Progress';
                            if (status === 'COMPLETED') statusText = 'Completed';
                            tooltip.textContent = statusText;
                            
                            // Update the marker class
                            const markerElement = marker.querySelector('.enhanced-milestone-marker');
                            if (markerElement) {
                                markerElement.className = 'enhanced-milestone-marker';
                                markerElement.classList.add(status.toLowerCase().replace('_', '-'));
                            }
                        }
                    }
                });
                
                // Update the table row status
                const tableRows = document.querySelectorAll('#milestone-table-body tr');
                tableRows.forEach(row => {
                    const periodCell = row.querySelector('td:first-child');
                    if (periodCell && periodCell.textContent.includes(period)) {
                        const statusCell = row.querySelector('td:nth-child(3) .timeline-status-badge');
                        if (statusCell) {
                            statusCell.className = 'timeline-status-badge';
                            let statusClass = 'not-started';
                            let statusText = 'Not Started';
                            
                            if (status === 'IN_PROGRESS') {
                                statusClass = 'in-progress';
                                statusText = 'In Progress';
                            } else if (status === 'COMPLETED') {
                                statusClass = 'completed';
                                statusText = 'Completed';
                            }
                            
                            statusCell.classList.add(statusClass);
                            statusCell.textContent = statusText;
                        }
                    }
                });
                
                // Update the progress stats
                updateProgressStats();
            } catch (updateError) {
                console.warn('Error updating UI after status change:', updateError);
            } finally {
                // Always restore the select element with the updated value
                if (parentElement) {
                    parentElement.innerHTML = originalHtml;
                    // Re-select the current value
                    const newSelect = parentElement.querySelector('select');
                    if (newSelect) {
                        newSelect.value = status;
                        // Add a brief highlight effect to indicate the update was successful
                        newSelect.classList.add('border-success');
                        setTimeout(() => {
                            newSelect.classList.remove('border-success');
                        }, 1500);
                    }
                }
            }
        })
        .catch(error => {
            console.error('Error in milestone update process:', error);
            showToast('error', error.message || 'Failed to update milestone status');
            
            // Restore the original HTML
            if (parentElement) {
                parentElement.innerHTML = originalHtml;
                // Highlight the error
                const newSelect = parentElement.querySelector('select');
                if (newSelect) {
                    newSelect.classList.add('border-danger');
                    setTimeout(() => {
                        newSelect.classList.remove('border-danger');
                    }, 1500);
                }
            }
        });
    } catch (error) {
        console.error('Unexpected error in updateQuickMilestoneStatus:', error);
        showToast('error', 'An unexpected error occurred');
        
        // Try to restore the original state
        try {
            if (selectElement && selectElement.parentElement) {
                selectElement.parentElement.innerHTML = originalHtml;
            }
        } catch (e) {
            console.warn('Could not restore original HTML:', e);
        }
    }
}

// Function to update progress stats without refreshing the entire modal
function updateProgressStats() {
    try {
        const milestones = [];
        const tableRows = document.querySelectorAll('#milestone-table-body tr');
        
        // Collect milestone data from the table
        tableRows.forEach(row => {
            const statusBadge = row.querySelector('.timeline-status-badge');
            if (statusBadge) {
                let status = 'NOT_STARTED';
                if (statusBadge.classList.contains('in-progress')) status = 'IN_PROGRESS';
                if (statusBadge.classList.contains('completed')) status = 'COMPLETED';
                milestones.push({ status });
            }
        });
        
        // Calculate stats
        const completedCount = milestones.filter(m => m.status === 'COMPLETED').length;
        const inProgressCount = milestones.filter(m => m.status === 'IN_PROGRESS').length;
        const notStartedCount = milestones.filter(m => m.status === 'NOT_STARTED').length;
        const totalCount = milestones.length;
        
        // Update the stats display
        const elements = {
            completed: document.getElementById('completed-milestones'),
            inProgress: document.getElementById('in-progress-milestones'),
            notStarted: document.getElementById('not-started-milestones'),
            total: document.getElementById('total-milestones')
        };
        
        if (elements.completed) elements.completed.textContent = completedCount;
        if (elements.inProgress) elements.inProgress.textContent = inProgressCount;
        if (elements.notStarted) elements.notStarted.textContent = notStartedCount;
        if (elements.total) elements.total.textContent = totalCount;
        
        // Calculate progress percentage
        const progressPercentage = Math.round((completedCount + (inProgressCount * 0.5)) / totalCount * 100);
        
        // Update progress bar
        const progressBar = document.querySelector('#progressDetailsModal .progress-bar');
        const progressDisplay = document.querySelector('#progressDetailsModal .progress-percentage-display');
        const progressBadge = document.getElementById('timeline-progress-badge');
        
        if (progressBar) {
            progressBar.style.width = `${progressPercentage}%`;
            progressBar.setAttribute('aria-valuenow', progressPercentage);
            progressBar.textContent = `${progressPercentage}%`;
        }
        
        if (progressDisplay) {
            progressDisplay.textContent = `${progressPercentage}%`;
        }
        
        if (progressBadge) {
            progressBadge.textContent = `${progressPercentage}%`;
            
            // Update badge color based on progress
            progressBadge.className = 'badge';
            if (progressPercentage < 25) {
                progressBadge.classList.add('bg-danger');
            } else if (progressPercentage < 50) {
                progressBadge.classList.add('bg-warning');
            } else if (progressPercentage < 75) {
                progressBadge.classList.add('bg-info');
            } else if (progressPercentage < 100) {
                progressBadge.classList.add('bg-primary');
            } else {
                progressBadge.classList.add('bg-success');
            }
        }
        
        // Update progress fill in the timeline visualization
        const progressFill = document.querySelector('.enhanced-timeline-progress-fill');
        if (progressFill) {
            progressFill.style.width = `${progressPercentage}%`;
        }
        
        // Update current position marker if it exists
        const currentPositionMarker = document.querySelector('.enhanced-current-position-marker');
        if (currentPositionMarker && inProgressCount > 0) {
            // Calculate the adjusted position
            const paddingPercentage = 10;
            const usableWidth = 100 - (paddingPercentage * 2);
            const adjustedProgressPosition = (progressPercentage * usableWidth / 100) + paddingPercentage;
            currentPositionMarker.style.left = `${adjustedProgressPosition}%`;
        }
    } catch (error) {
        console.warn('Error updating progress stats:', error);
    }
}

// Function to update quick progress removed as it's no longer needed

// Add event listener to progress bars to show the details modal
document.addEventListener('DOMContentLoaded', function() {
    // Add click event to progress bars
    document.querySelectorAll('.progress').forEach(progressBar => {
        progressBar.addEventListener('click', function() {
            const mentorshipId = this.closest('.accordion-collapse').id.replace('mentorship-', '');
            showProgressDetails(mentorshipId);
        });
        
        // Add tooltip to progress bars
        const tooltip = document.createElement('div');
        tooltip.className = 'progress-tooltip';
        tooltip.textContent = 'Click for detailed progress';
        progressBar.appendChild(tooltip);
    });
});

// Function to load all timeline milestones
function loadAllTimelineMilestones() {
    document.querySelectorAll('[id^="timeline-milestones-"]').forEach(function(container) {
        const mentorshipId = container.id.replace('timeline-milestones-', '');
        const timelineText = document.querySelector(`#mentorship-${mentorshipId} .timeline-text`);
        if (timelineText && timelineText.textContent) {
            updateEnhancedTimelineDisplay(mentorshipId, parseTimelineText(timelineText.textContent));
        }
    });
    
    // Step-based progress tracker code removed as requested
}

// Function to check if a mentorship is completed
function isMentorshipCompleted(mentorship) {
    // Consider a mentorship completed if progress is 100% or all milestones are completed
    return mentorship.progress_percentage >= 100;
}

// Function to move completed mentorships to the finished section
function organizeCompletedMentorships() {
    const activeMentorshipsContainer = document.querySelector('.active-mentorships');
    const finishedMentorshipsContainer = document.querySelector('.finished-mentorships-content');
    
    if (!activeMentorshipsContainer || !finishedMentorshipsContainer) return;
    
    // Check each mentorship
    document.querySelectorAll('.mentorship-item').forEach(function(mentorshipItem) {
        const mentorshipId = mentorshipItem.getAttribute('data-mentorship-id');
        const progressBar = mentorshipItem.querySelector('.progress-bar');
        
        if (progressBar) {
            const progressPercentage = parseInt(progressBar.getAttribute('aria-valuenow') || 0);
            
            // If progress is 100%, move to finished section
            if (progressPercentage >= 100) {
                // Clone the item to avoid removing event listeners
                const clonedItem = mentorshipItem.cloneNode(true);
                finishedMentorshipsContainer.appendChild(clonedItem);
                
                // Add a completed badge
                const badge = document.createElement('span');
                badge.className = 'badge bg-success ms-2';
                badge.textContent = 'Completed';
                clonedItem.querySelector('.mentorship-title').appendChild(badge);
                
                // Hide the original item
                mentorshipItem.style.display = 'none';
            }
        }
    });
    
    // Show the finished mentorships section if there are any
    if (finishedMentorshipsContainer.children.length > 0) {
        document.querySelector('.finished-mentorships').style.display = 'block';
    } else {
        document.querySelector('.finished-mentorships').style.display = 'none';
    }
}

// Toggle finished mentorships visibility
function toggleFinishedMentorships() {
    const content = document.querySelector('.finished-mentorships-content');
    const toggleButton = document.querySelector('.finished-mentorships-toggle');
    
    if (content.classList.contains('show')) {
        content.classList.remove('show');
        toggleButton.innerHTML = '<i class="fas fa-chevron-down"></i> Show';
    } else {
        content.classList.add('show');
        toggleButton.innerHTML = '<i class="fas fa-chevron-up"></i> Hide';
    }
}

// Function to parse timeline text into milestone objects
function parseTimelineText(timelineText) {
    if (!timelineText) return [];
    
    const lines = timelineText.split('\n');
    let milestones = [];
    let inAdditionalNotes = false;
    
    lines.forEach(line => {
        line = line.trim();
        if (!line) return;
        
        if (line.startsWith('Additional Notes:')) {
            inAdditionalNotes = true;
            return;
        }
        
        if (inAdditionalNotes) {
            return;
        }
        
        const weekDayMatch = line.match(/^Week\/Day\s+([^:]+):\s*(.+)$/);
        if (weekDayMatch) {
            const period = weekDayMatch[1];
            const description = weekDayMatch[2];
            
            // Extract status if available
            let status = 'NOT_STARTED';
            const statusMatch = description.match(/(.+)\s+\[([A-Z_]+)\]$/);
            const cleanDescription = statusMatch ? statusMatch[1].trim() : description;
            if (statusMatch) {
                status = statusMatch[2];
            }
            
            milestones.push({
                period: period,
                description: cleanDescription,
                status: status
            });
        }
    });
    
    return milestones;
}

// Function to initialize all progress bars
function initializeProgressBars() {
    document.querySelectorAll('.progress-bar').forEach(progressBar => {
        const percentage = progressBar.dataset.percentage || '0';
        progressBar.style.width = `${percentage}%`;
        progressBar.setAttribute('aria-valuenow', percentage);
        progressBar.textContent = `${percentage}%`;
    });

    document.querySelectorAll('.progress-bar-skill').forEach((skillBar, index) => {
        const proficiency = skillBar.dataset.skillProficiency || '0';
        skillBar.style.width = `${proficiency}%`;
        skillBar.style.backgroundColor = getSkillColor(index);
    });
}

// Function to get color for skill progress bars
function getSkillColor(index) {
    const colors = [
        '#4e73df', // Primary
        '#1cc88a', // Success
        '#36b9cc', // Info
        '#f6c23e', // Warning
        '#e74a3b'  // Danger
    ];
    return colors[index % colors.length];
}

// Function to setup error handling
function setupErrorHandling() {
    $(document).ajaxError(function(event, jqXHR, settings, error) {
        console.error('AJAX Error:', error);
        showToast('Error', 'An error occurred. Please try again.', 'error');
    });
}

// Function to initialize Bootstrap components
function initializeBootstrapComponents() {
    // Initialize tooltips
    const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    tooltips.forEach(tooltip => new bootstrap.Tooltip(tooltip));

    // Initialize popovers
    const popovers = document.querySelectorAll('[data-bs-toggle="popover"]');
    popovers.forEach(popover => new bootstrap.Popover(popover));
}

// Function to setup mutation observer
function setupMutationObserver() {
    const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            if (mutation.type === 'childList' || mutation.type === 'attributes') {
                initializeProgressBars();
            }
        });
    });

    const config = { 
        attributes: true, 
        childList: true, 
        subtree: true 
    };

    document.querySelectorAll('.progress').forEach(progress => {
        observer.observe(progress, config);
    });
}

// Function to update mentorship status
function updateMentorshipStatus(mentorshipId, newStatus) {
    // Show a confirmation modal with reason input
    const statusLabels = {
        'PAUSED': 'Pause',
        'APPROVED': 'Resume',
        'COMPLETED': 'Complete',
        'CANCELLED': 'Cancel'
    };
    
    const actionLabel = statusLabels[newStatus] || 'Update';
    
    // Create and show modal
    const modalHtml = `
        <div class="modal fade" id="updateStatusModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">${actionLabel} Mentorship</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
                    <div class="modal-body">
                        <p>Are you sure you want to ${actionLabel.toLowerCase()} this mentorship?</p>
                        <div class="mb-3">
                            <label for="statusReason" class="form-label">Reason (optional)</label>
                            <textarea class="form-control" id="statusReason" rows="3" placeholder="Please provide a reason for this status change..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="confirmStatusUpdate">Confirm</button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Remove any existing modal
    const existingModal = document.getElementById('updateStatusModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add the modal to the DOM
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Initialize the modal
    const modal = new bootstrap.Modal(document.getElementById('updateStatusModal'));
    modal.show();
    
    // Handle confirmation
    document.getElementById('confirmStatusUpdate').addEventListener('click', function() {
        const reason = document.getElementById('statusReason').value;
        
        // Send AJAX request to update status
    $.ajax({
            url: `/mentorship/api/update-mentorship-status/${mentorshipId}/`,
        type: 'POST',
            data: JSON.stringify({ 
                status: newStatus,
                reason: reason
            }),
            contentType: 'application/json',
        success: function(response) {
                modal.hide();
                showToast('success', response.message);
                
                // Update UI based on the new status
                const mentorshipItem = document.querySelector(`.mentorship-item[data-mentorship-id="${mentorshipId}"]`);
                if (mentorshipItem) {
                    const statusBadge = mentorshipItem.querySelector('.badge');
                    if (statusBadge) {
                        // Update badge text and class
                        statusBadge.textContent = newStatus.charAt(0) + newStatus.slice(1).toLowerCase();
                        
                        // Remove existing status classes
                        statusBadge.classList.remove('bg-primary', 'bg-warning', 'bg-success', 'bg-danger');
                        
                        // Add appropriate class based on status
                        if (newStatus === 'PAUSED') {
                            statusBadge.classList.add('bg-warning');
                        } else if (newStatus === 'COMPLETED') {
                            statusBadge.classList.add('bg-success');
                            
                            // Move to finished mentorships section if completed or cancelled
                            const finishedSection = document.querySelector('.finished-mentorships-content');
                            if (finishedSection && (newStatus === 'COMPLETED' || newStatus === 'CANCELLED')) {
                                finishedSection.appendChild(mentorshipItem);
                                
                                // Show the finished mentorships section if it was hidden
                                document.querySelector('.finished-mentorships').style.display = 'block';
                            }
                        } else if (newStatus === 'CANCELLED') {
                            statusBadge.classList.add('bg-danger');
                            
                            // Move to finished mentorships section if completed or cancelled
                            const finishedSection = document.querySelector('.finished-mentorships-content');
                            if (finishedSection && (newStatus === 'COMPLETED' || newStatus === 'CANCELLED')) {
                                finishedSection.appendChild(mentorshipItem);
                                
                                // Show the finished mentorships section if it was hidden
                                document.querySelector('.finished-mentorships').style.display = 'block';
                            }
                        } else {
                            statusBadge.classList.add('bg-primary');
                        }
                    }
                    
                    // Update dropdown options based on new status
                    const dropdownMenu = mentorshipItem.querySelector('.dropdown-menu');
                    if (dropdownMenu) {
                        if (newStatus === 'PAUSED') {
                            dropdownMenu.innerHTML = `
                                <li><a class="dropdown-item" href="#" onclick="updateMentorshipStatus('${mentorshipId}', 'APPROVED')"><i class="fas fa-play me-2"></i> Resume Mentorship</a></li>
                                <li><a class="dropdown-item" href="#" onclick="updateMentorshipStatus('${mentorshipId}', 'COMPLETED')"><i class="fas fa-check-circle me-2"></i> Complete Mentorship</a></li>
                                <li><a class="dropdown-item" href="#" onclick="updateMentorshipStatus('${mentorshipId}', 'CANCELLED')"><i class="fas fa-times-circle me-2"></i> Cancel Mentorship</a></li>
                            `;
                        } else if (newStatus === 'APPROVED') {
                            dropdownMenu.innerHTML = `
                                <li><a class="dropdown-item" href="#" onclick="updateMentorshipStatus('${mentorshipId}', 'PAUSED')"><i class="fas fa-pause me-2"></i> Pause Mentorship</a></li>
                                <li><a class="dropdown-item" href="#" onclick="updateMentorshipStatus('${mentorshipId}', 'COMPLETED')"><i class="fas fa-check-circle me-2"></i> Complete Mentorship</a></li>
                                <li><a class="dropdown-item" href="#" onclick="updateMentorshipStatus('${mentorshipId}', 'CANCELLED')"><i class="fas fa-times-circle me-2"></i> Cancel Mentorship</a></li>
                            `;
                        }
                    }
                }
                
                // Reload the page if completed or cancelled to refresh the mentorship lists
                if (newStatus === 'COMPLETED' || newStatus === 'CANCELLED') {
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                }
            },
            error: function(xhr) {
                console.error('Error updating mentorship status:', xhr);
                showToast('error', xhr.responseJSON?.error || 'Failed to update mentorship status');
            }
        });
    });
}

// ... existing code ...
</script>

<!-- Timeline Modal -->
<div class="modal fade" id="timelineModal" tabindex="-1" aria-labelledby="timelineModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="timelineModalLabel">
                    <i class="fas fa-calendar-alt me-2"></i>Set Mentorship Timeline
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <form id="timelineForm">
                    <input type="hidden" id="mentorshipIdForTimeline">
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card shadow-sm border-0 h-100">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">
                                        <i class="fas fa-calendar-check me-2 text-primary"></i>Timeline Period
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <label for="expectedEndDate" class="form-label">Expected End Date</label>
                                    <div class="input-group mb-3">
                                        <span class="input-group-text bg-primary text-white">
                                            <i class="fas fa-flag-checkered"></i>
                                        </span>
                                        <input type="date" class="form-control form-control-lg" id="expectedEndDate" required onchange="calculateMentoringDays()">
                                    </div>
                                    <div class="form-text">Set the target date for completing this mentorship</div>
                                    <div id="mentoringDaysInfo" class="mt-3 alert alert-info d-flex align-items-center">
                                        <i class="fas fa-info-circle me-3 fs-4"></i>
                                        <span id="totalDaysText" class="fw-bold"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card shadow-sm border-0 h-100">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">
                                        <i class="fas fa-clipboard-list me-2 text-primary"></i>Predefined Templates
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <label for="templateSelector" class="form-label">Select a Template</label>
                                    <div class="input-group mb-3">
                                        <select class="form-select form-select-lg" id="templateSelector">
                                            <option value="" selected>Select a template (optional)</option>
                                            <option value="technical-8-week">8-Week Technical Mentorship</option>
                                            <option value="career-12-week">12-Week Career Development</option>
                                            <option value="research-project">Research Project Mentorship</option>
                                            <option value="startup-mentoring">Startup Mentoring</option>
                                            <option value="leadership-development">Leadership Development</option>
                                        </select>
                                        <button class="btn btn-primary px-4" type="button" id="applyTemplateBtn">
                                            <i class="fas fa-check me-2"></i>Apply
                                        </button>
                                    </div>
                                    <div class="form-text">Choose a template to automatically populate milestones based on best practices</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card shadow-sm border-0 mb-4">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="fas fa-map-marker-alt me-2 text-primary"></i>Timeline Milestones
                            </h6>
                            <button type="button" class="btn btn-primary btn-sm" id="add-milestone-btn">
                                <i class="fas fa-plus me-1"></i> Add Milestone
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="timeline-alert" class="alert alert-danger d-none">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <span id="timeline-alert-message"></span>
                            </div>
                            
                            <div id="milestones-container">
                                <!-- Milestone entries will be dynamically added here -->
                            </div>
                            
                            <!-- Hidden template for new milestone rows -->
                            <table id="milestone-template-table" style="display: none;">
                                <tbody>
                                    <tr class="milestone-row row mb-3 pb-3 border-bottom align-items-center">
                                        <td class="col-md-2">
                                            <label class="form-label d-md-none">Week/Day:</label>
                                            <input type="text" class="form-control milestone-period" placeholder="1-2" required>
                                        </td>
                                        <td class="col-md-3">
                                            <label class="form-label d-md-none">Date:</label>
                                            <div class="input-group">
                                                <input type="date" class="form-control milestone-date" onchange="validateMilestoneDate(this)">
                                                <span class="input-group-text date-toggle" onclick="toggleDateDisplay(this)">
                                                    <i class="fas fa-calendar-alt"></i>
                                                </span>
                                            </div>
                                        </td>
                                        <td class="col-md-6">
                                            <label class="form-label d-md-none">Description:</label>
                                            <input type="text" class="form-control milestone-description" placeholder="Milestone description" required>
                                        </td>
                                        <td class="col-md-1 text-center">
                                            <button type="button" class="btn btn-outline-danger remove-milestone-btn mt-md-0 mt-2">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="card shadow-sm border-0 mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="fas fa-sticky-note me-2 text-primary"></i>Additional Notes
                            </h6>
                        </div>
                        <div class="card-body">
                            <textarea class="form-control" id="timelineMilestones" rows="3" placeholder="Any additional notes or details about the timeline"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer bg-light justify-content-between">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary btn-lg px-4" id="saveTimeline" onclick="submitTimeline()">
                    <i class="fas fa-save me-2"></i>Save Timeline
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Update the initializeMilestoneButtons function to work with the new table layout
function initializeMilestoneButtons() {
    const addMilestoneBtn = document.getElementById('add-milestone-btn');
    if (addMilestoneBtn) {
        addMilestoneBtn.addEventListener('click', function() {
            const milestonesContainer = document.getElementById('milestones-container');
            const templateTable = document.getElementById('milestone-template-table');
            
            if (templateTable) {
                const templateRow = templateTable.querySelector('tr').cloneNode(true);
                
                // Add to the table
                milestonesContainer.appendChild(templateRow);
                
                // Add event listener to the remove button
                const removeBtn = templateRow.querySelector('.remove-milestone-btn');
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        const milestoneEntry = this.closest('.milestone-entry');
                        if (milestoneEntry && milestoneEntry.parentNode) {
                            // Check if this is the last milestone entry
                            const allEntries = milestonesContainer.querySelectorAll('.milestone-entry');
                            if (allEntries.length === 1) {
                                // If it's the last one, just clear the inputs instead of removing
                                const periodInput = milestoneEntry.querySelector('.milestone-period');
                                const descriptionInput = milestoneEntry.querySelector('.milestone-description');
                                const dateInput = milestoneEntry.querySelector('.milestone-date');
                                
                                if (periodInput) periodInput.value = '';
                                if (descriptionInput) descriptionInput.value = '';
                                if (dateInput) {
                                    dateInput.value = '';
                                    dateInput.classList.remove('is-invalid');
                                }
                            } else {
                                // Otherwise remove it
                                milestoneEntry.parentNode.removeChild(milestoneEntry);
                            }
                            
                            // Re-validate after changes
                            validateAllMilestoneDates();
                        }
                    });
                }
            } else {
                console.error("Template table not found");
            }
        });
    }
    
    // Add event listeners to existing remove buttons
    document.querySelectorAll('.remove-milestone-btn').forEach(button => {
        button.addEventListener('click', function() {
            const milestoneEntry = this.closest('.milestone-entry');
            const milestonesContainer = document.getElementById('milestones-container');
            
            if (milestoneEntry && milestoneEntry.parentNode) {
                // Check if this is the last milestone entry
                const allEntries = milestonesContainer.querySelectorAll('.milestone-entry');
                if (allEntries.length === 1) {
                    // If it's the last one, just clear the inputs instead of removing
                    const periodInput = milestoneEntry.querySelector('.milestone-period');
                    const descriptionInput = milestoneEntry.querySelector('.milestone-description');
                    const dateInput = milestoneEntry.querySelector('.milestone-date');
                    
                    if (periodInput) periodInput.value = '';
                    if (descriptionInput) descriptionInput.value = '';
                    if (dateInput) {
                        dateInput.value = '';
                        dateInput.classList.remove('is-invalid');
                    }
                } else {
                    // Otherwise remove it
                    milestoneEntry.parentNode.removeChild(milestoneEntry);
                }
                
                // Re-validate after changes
                validateAllMilestoneDates();
            }
        });
    });
}

// Function to apply a milestone template - updated for table layout
function applyMilestoneTemplate(templateId) {
    const template = milestoneTemplates[templateId];
    if (!template) {
        showToast('error', 'Template not found');
        return;
    }
    
    // Get end date to calculate milestone dates
    const expectedEndDateInput = document.getElementById('expectedEndDate');
    if (!expectedEndDateInput || !expectedEndDateInput.value) {
        // If end date is not set, set it automatically based on template
        setExpectedEndDateFromTemplate(templateId);
        
        if (!expectedEndDateInput.value) {
            showToast('warning', 'Could not set expected end date');
            return;
        }
    }
    
    // Clear existing milestones
    const milestonesContainer = document.getElementById('milestones-container');
    milestonesContainer.innerHTML = '';
    
    // Calculate dates based on the timeline span
    // Start from TOMORROW instead of today
    const startDate = new Date();
    startDate.setDate(startDate.getDate() + 1); // Add 1 day to get tomorrow
    startDate.setHours(0, 0, 0, 0);
    
    const endDate = new Date(expectedEndDateInput.value);
    endDate.setHours(0, 0, 0, 0);
    
    // Calculate total duration in days
    const totalDuration = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24));
    
    // Get the template's original duration
    const templateDuration = getTemplateDuration(templateId) - 7; // Subtract the buffer we added
    
    // Apply template milestones
    template.forEach((milestone, index) => {
        // Calculate adjusted day offset based on the actual timeline duration
        let adjustedDayOffset;
        
        if (templateDuration <= 0) {
            // Fallback: Distribute evenly if template duration is invalid
            adjustedDayOffset = Math.floor((totalDuration * index) / (template.length - 1));
        } else {
            // Scale the day offset proportionally to fit the actual timeline
            const scaleFactor = totalDuration / templateDuration;
            adjustedDayOffset = Math.floor(milestone.days * scaleFactor);
        }
        
        // Calculate milestone date
        const milestoneDate = new Date(startDate);
        milestoneDate.setDate(milestoneDate.getDate() + adjustedDayOffset);
        
        // Make sure the date doesn't exceed the end date
        const finalDate = milestoneDate > endDate ? endDate : milestoneDate;
        
        // Format date for the input
        const formattedDate = finalDate.toISOString().split('T')[0]; // YYYY-MM-DD format
        
        // Create new milestone entry - for the table layout
        const newRow = document.createElement('tr');
        newRow.className = 'milestone-entry';
        newRow.innerHTML = `
            <td style="width: 12%">
                <input type="text" class="form-control form-control-sm milestone-period" placeholder="1-2" required value="${milestone.period}">
            </td>
            <td style="width: 18%">
                <div class="input-group">
                    <input type="date" class="form-control form-control-sm milestone-date" onchange="validateMilestoneDate(this)" value="${formattedDate}">
                    <span class="input-group-text date-toggle" onclick="toggleDateDisplay(this)">
                        <i class="fas fa-calendar-alt"></i>
                    </span>
                </div>
            </td>
            <td style="width: 60%">
                <input type="text" class="form-control form-control-sm milestone-description" placeholder="Milestone description" required value="${milestone.description}">
            </td>
            <td style="width: 10%; text-align: center;">
                <button type="button" class="btn btn-outline-danger btn-sm remove-milestone-btn">
                    <i class="fas fa-times"></i>
                </button>
            </td>
        `;
        milestonesContainer.appendChild(newRow);
        
        // Add event listener to the remove button
        const removeBtn = newRow.querySelector('.remove-milestone-btn');
        removeBtn.addEventListener('click', function() {
            if (milestonesContainer.querySelectorAll('.milestone-entry').length > 1) {
                milestonesContainer.removeChild(newRow);
            } else {
                // Clear inputs if it's the last one
                const periodInput = newRow.querySelector('.milestone-period');
                const descriptionInput = newRow.querySelector('.milestone-description');
                const dateInput = newRow.querySelector('.milestone-date');
                
                if (periodInput) periodInput.value = '';
                if (descriptionInput) descriptionInput.value = '';
                if (dateInput) {
                    dateInput.value = '';
                    dateInput.classList.remove('is-invalid');
                }
            }
            validateAllMilestoneDates();
        });
    });
    
    // Validate all milestone dates
    validateAllMilestoneDates();
    
    showToast('success', `Applied ${template.length} milestones from template`);
}

// Ensure mentoringDaysInfo is visible by default
document.addEventListener('DOMContentLoaded', function() {
    // Update modal visibility handling
    const timelineModal = document.getElementById('timelineModal');
    if (timelineModal) {
        timelineModal.addEventListener('shown.bs.modal', function() {
            // Make info visible by default
            const mentoringDaysInfo = document.getElementById('mentoringDaysInfo');
            if (mentoringDaysInfo) {
                mentoringDaysInfo.classList.remove('d-none');
                // Set initial text if no date is selected
                if (!document.getElementById('expectedEndDate').value) {
                    document.getElementById('totalDaysText').textContent = 'Select an end date to see mentoring duration';
                }
            }
            
            // Calculate and show mentoring days if end date is already set
            calculateMentoringDays();
            
            // Validate all milestone dates
            setTimeout(validateAllMilestoneDates, 100);
        });
    }
});
</script>

<!-- Meeting Modal -->
<div class="modal fade" id="meetingModal" tabindex="-1" aria-labelledby="meetingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="meetingModalLabel">Schedule Meeting</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="meetingForm">
                    <input type="hidden" id="mentorshipIdForMeeting">
                    
                    <div class="mb-3">
                        <label for="meetingTitle" class="form-label">Meeting Title</label>
                        <input type="text" class="form-control" id="meetingTitle" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="meetingDate" class="form-label">Date & Time</label>
                        <input type="datetime-local" class="form-control" id="meetingDate" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="meetingLink" class="form-label"><i class="fas fa-video me-1"></i> Meeting Link</label>
                        <input type="url" class="form-control" id="meetingLink" placeholder="https://meet.google.com/... or https://zoom.us/..." required>
                        <div class="form-text">
                            Add a video call link (Zoom, Google Meet, etc.) that mentees can click to join the meeting directly.
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="meetingDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="meetingDescription" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitMeeting()">Schedule</button>
            </div>
        </div>
    </div>
</div>

<!-- Message Modal -->
<div class="modal fade" id="messageModal" tabindex="-1" aria-labelledby="messageModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="messageModalLabel">Send Message</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="messageForm">
                    <input type="hidden" id="mentorshipIdForMessage">
                    
                    <div class="mb-3">
                        <label for="messageContent" class="form-label">Message</label>
                        <textarea class="form-control" id="messageContent" rows="5" required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="messageAttachment" class="form-label">Attachment (optional)</label>
                        <input type="file" class="form-control" id="messageAttachment">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitMessage()">Send</button>
            </div>
        </div>
    </div>
</div>

<!-- Progress Modal -->
<div class="modal fade" id="progressModal" tabindex="-1" aria-labelledby="progressModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="progressModalLabel">Update Progress</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="progressForm">
                    <input type="hidden" id="mentorshipIdForProgress">
                    
                    <div class="mb-3">
                        <label for="progressTitle" class="form-label">Progress Title</label>
                        <input type="text" class="form-control" id="progressTitle" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="progressDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="progressDescription" rows="3" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitProgress()">Save Progress</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Styles -->
<style>
.toast-container {
    z-index: 9999; /* Increased from 1050 to ensure it's always on top */
}

.toast {
    min-width: 250px;
}

.toast-success {
    background-color: #d4edda;
    border-color: #c3e6cb;
    color: #155724;
}

.toast-error {
    background-color: #f8d7da;
    border-color: #f5c6cb;
    color: #721c24;
}

.toast-success .toast-header {
    background-color: #c3e6cb;
    color: #155724;
}

.toast-error .toast-header {
    background-color: #f5c6cb;
    color: #721c24;
}

/* Loading indicator styles */
.loading-spinner-container {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 38px; /* Standard height of a form-select element */
    background-color: rgba(255, 255, 255, 0.8);
    border-radius: 0.25rem;
}

/* Success and error highlight styles for form elements */
.border-success {
    border-color: #28a745 !important;
    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25) !important;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.border-danger {
    border-color: #dc3545 !important;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}
</style>

<!-- Timeline Status Modal -->
<div class="modal fade timeline-status-modal" id="timelineStatusModal" tabindex="-1" aria-labelledby="timelineStatusModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="timelineStatusModalLabel">Update Timeline Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="timelineStatusForm">
                    <input type="hidden" id="mentorshipIdForStatus">
                    
                    <div id="milestone-status-container">
                        <!-- Milestone status items will be loaded here -->
                        <div class="text-center py-3 text-muted" id="no-milestones-message">
                            <i class="fas fa-info-circle me-2"></i>No milestones found. Please set up a timeline first.
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveTimelineStatus()">Save Status</button>
            </div>
        </div>
    </div>
</div>

<!-- Progress Details Modal -->
<div class="modal fade" id="progressDetailsModal" tabindex="-1" aria-labelledby="progressDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="progressDetailsModalLabel">Mentorship Progress Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="progress-details-container">
                            <div class="progress-overview mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0">Overall Progress</h6>
                                    <span class="progress-percentage-display fs-4 fw-bold text-primary">0%</span>
                                </div>
                                <div class="progress progress-lg" style="height: 25px;">
                                    <div class="progress-bar progress-bar-animated progress-bar-striped bg-primary" 
                                         role="progressbar" style="width: 0%;" 
                                         aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                </div>
                            </div>
                            
                            <div class="progress-stats row text-center mb-4">
                                <div class="col-md-3">
                                    <div class="progress-stat-card bg-light p-3 rounded">
                                        <div class="stat-icon mb-2"><i class="fas fa-calendar-check text-success"></i></div>
                                        <div class="stat-value" id="completed-milestones">0</div>
                                        <div class="stat-label">Completed</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="progress-stat-card bg-light p-3 rounded">
                                        <div class="stat-icon mb-2"><i class="fas fa-spinner text-warning"></i></div>
                                        <div class="stat-value" id="in-progress-milestones">0</div>
                                        <div class="stat-label">In Progress</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="progress-stat-card bg-light p-3 rounded">
                                        <div class="stat-icon mb-2"><i class="fas fa-hourglass-start text-secondary"></i></div>
                                        <div class="stat-value" id="not-started-milestones">0</div>
                                        <div class="stat-label">Not Started</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="progress-stat-card bg-light p-3 rounded">
                                        <div class="stat-icon mb-2"><i class="fas fa-tasks text-primary"></i></div>
                                        <div class="stat-value" id="total-milestones">0</div>
                                        <div class="stat-label">Total Milestones</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="timeline-visualization mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>Timeline Visualization</h6>
                                    <span class="badge bg-primary" id="timeline-progress-badge">0%</span>
                                </div>
                                <p class="text-muted small mb-3">Track your mentorship progress through milestones. Click on any milestone for details.</p>
                                <div class="timeline-visual-container" id="timeline-visual-container">
                                    <!-- Timeline visualization will be rendered here -->
                                </div>
                            </div>
                            
                            <div class="milestone-list">
                                <h6>Milestones</h6>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Period</th>
                                                <th>Description</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="milestone-table-body">
                                            <!-- Milestone rows will be added here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Update Overall Progress section and Quick Note feature removed as requested -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                <!-- Update Progress and Update Milestones buttons removed as requested -->
            </div>
        </div>
    </div>
</div>

<!-- Progress Bar Tooltip/Popover Styles -->
<style>
/* Progress Bar Styles */
.progress {
    cursor: pointer;
    transition: all 0.3s ease;
    overflow: visible;
}

.progress:hover {
    box-shadow: 0 0 10px rgba(0,123,255,0.5);
}

.progress-bar {
    position: relative;
}

/* Progress Tooltip */
.progress-tooltip {
    position: absolute;
    top: -40px;
    right: 0;
    background-color: #343a40;
    color: white;
    padding: 5px 10px;
    border-radius: 4px;
    font-size: 0.8rem;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s;
    z-index: 1000;
    white-space: nowrap;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

.progress-tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    margin-left: -5px;
    border-width: 5px;
    border-style: solid;
    border-color: #343a40 transparent transparent transparent;
}

.progress:hover .progress-tooltip {
    opacity: 1;
    visibility: visible;
}

/* Progress Details Modal Styles */
.progress-lg {
    height: 25px !important;
    border-radius: 15px;
    overflow: hidden;
}

.progress-lg .progress-bar {
    line-height: 25px;
    font-weight: bold;
}

.progress-stat-card {
    transition: all 0.3s ease;
    border: 1px solid #dee2e6;
}

.progress-stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.stat-value {
    font-size: 1.8rem;
    font-weight: bold;
}

.timeline-visual-container {
    height: 150px;
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 15px 30px; /* Increased horizontal padding */
    position: relative;
    overflow: visible;
    margin: 15px 0 45px; /* Increased bottom margin to accommodate labels */
    border: 1px solid rgba(0,0,0,0.05);
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}

.milestone-marker {
    position: absolute;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    top: 50%;
    transform: translateY(-50%);
    cursor: pointer;
    transition: all 0.3s ease;
    z-index: 2;
}

.milestone-marker.not-started {
    background-color: #6c757d;
    border: 2px solid #fff;
}

.milestone-marker.in-progress {
    background-color: #ffc107;
    border: 2px solid #fff;
}

.milestone-marker.completed {
    background-color: #28a745;
    border: 2px solid #fff;
}

.milestone-marker:hover {
    transform: translateY(-50%) scale(1.2);
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
}

.milestone-line {
    position: absolute;
    height: 4px;
    background-color: #dee2e6;
    top: 50%;
    transform: translateY(-50%);
    z-index: 1;
    left: 0;
    right: 0;
}

.milestone-progress-fill {
    position: absolute;
    height: 4px;
    background: linear-gradient(90deg, #4481eb 0%, #04befe 100%);
    top: 50%;
    transform: translateY(-50%);
    z-index: 1;
    left: 0;
    width: 0%;
    transition: width 1s ease;
}

.milestone-tooltip {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background-color: #343a40;
    color: white;
    padding: 5px 10px;
    border-radius: 4px;
    font-size: 0.8rem;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s;
    z-index: 1000;
    white-space: nowrap;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    pointer-events: none;
}

.milestone-tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    margin-left: -5px;
    border-width: 5px;
    border-style: solid;
    border-color: #343a40 transparent transparent transparent;
}

.milestone-marker:hover .milestone-tooltip {
    opacity: 1;
    visibility: visible;
}

.timeline-status-badge {
    display: inline-block;
    padding: 0.25em 0.6em;
    font-size: 0.75em;
    font-weight: 700;
    line-height: 1;
    text-align: center;
    white-space: nowrap;
    vertical-align: baseline;
    border-radius: 0.25rem;
}

.timeline-status-badge.not-started {
    background-color: #6c757d;
    color: white;
}

.timeline-status-badge.in-progress {
    background-color: #ffc107;
    color: #212529;
}

.timeline-status-badge.completed {
    background-color: #28a745;
    color: white;
}
</style>

<!-- Schedule Meeting Modal -->
<div class="modal fade" id="scheduleMeetingModal" tabindex="-1" aria-labelledby="scheduleMeetingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="scheduleMeetingModalLabel">Schedule Meeting</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="scheduleMeetingForm" onsubmit="submitScheduleMeeting(event); return false;">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" id="mentorshipIdInput" name="mentorship_id">
                    <div class="mb-3">
                        <label for="meetingTitle" class="form-label">Meeting Title</label>
                        <input type="text" class="form-control" id="meetingTitle" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="meetingDate" class="form-label">Date & Time</label>
                        <input type="datetime-local" class="form-control" id="meetingDate" name="meeting_date" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="meetingLink" class="form-label">Meeting Link (optional)</label>
                        <input type="url" class="form-control" id="meetingLink" name="meeting_link" placeholder="https://meet.google.com/...">
                    </div>
                    <div class="mb-3">
                        <label for="meetingAgenda" class="form-label">Agenda</label>
                        <textarea class="form-control" id="meetingAgenda" name="agenda" rows="3" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Schedule Meeting</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Send Message Modal -->
<div class="modal fade" id="sendMessageModal" tabindex="-1" aria-labelledby="sendMessageModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="sendMessageModalLabel">Send Message</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="sendMessageForm" action="{% url 'mentorship:send_message' %}" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" id="messageRecipientId" name="recipient_id">
                    <div class="mb-3">
                        <label for="messageSubject" class="form-label">Subject</label>
                        <input type="text" class="form-control" id="messageSubject" name="subject" required>
                    </div>
                    <div class="mb-3">
                        <label for="messageContent" class="form-label">Message</label>
                        <textarea class="form-control" id="messageContent" name="content" rows="5" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-info text-white">Send Message</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div id="toast-container" class="toast-container position-fixed bottom-0 end-0 p-3"></div>

<!-- Template Handling Script -->
<script>
// Function to handle schedule meeting form submission
function submitScheduleMeeting(event) {
    event.preventDefault();
    
    const mentorshipId = document.getElementById('mentorshipIdInput').value;
    const meetingTitle = document.getElementById('meetingTitle').value;
    const meetingDate = document.getElementById('meetingDate').value;
    const meetingLink = document.getElementById('meetingLink').value;
    const meetingAgenda = document.getElementById('meetingAgenda').value;
    
    // Validate required fields
    if (!mentorshipId || !meetingTitle || !meetingDate || !meetingAgenda) {
        showToast('error', 'Please fill out all required fields.');
        return;
    }
    
    // Create form data
    const formData = {
        mentorship: mentorshipId,
        title: meetingTitle,
        scheduled_date: meetingDate,
        meeting_link: meetingLink || "",
        agenda: meetingAgenda,
        status: 'SCHEDULED'
    };
    
    // Submit the data
    fetch('/mentorship/api/meetings/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(formData)
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.detail || 'Error scheduling meeting');
            });
        }
        return response.json();
    })
    .then(data => {
        // Close the modal
        bootstrap.Modal.getInstance(document.getElementById('scheduleMeetingModal')).hide();
        // Show success message
        showToast('success', 'Meeting scheduled successfully!');
        // Reload the page after a short delay to show the new meeting
        setTimeout(() => {
            window.location.reload();
        }, 1000);
    })
    .catch(error => {
        console.error('Error scheduling meeting:', error);
        showToast('error', `Error scheduling meeting: ${error.message}`);
    });
}


// Define predefined milestone templates
const milestoneTemplates = {
    'technical-8-week': [
        { period: '1', description: 'Introduction and skills assessment', days: 0 },
        { period: '2', description: 'Core concept review and learning path setup', days: 7 },
        { period: '3-4', description: 'Hands-on practice with fundamental skills', days: 14 },
        { period: '5', description: 'Mid-point assessment and progress review', days: 28 },
        { period: '6-7', description: 'Advanced topics and project implementation', days: 35 },
        { period: '8', description: 'Final review and future development planning', days: 49 }
    ],
    'career-12-week': [
        { period: '1', description: 'Career goals assessment and planning', days: 0 },
        { period: '2-3', description: 'Resume and portfolio enhancement', days: 7 },
        { period: '4-5', description: 'Personal branding and networking strategies', days: 21 },
        { period: '6', description: 'Mid-point review and strategy adjustment', days: 35 },
        { period: '7-8', description: 'Interview preparation and practice', days: 42 },
        { period: '9-10', description: 'Job search strategies and application process', days: 56 },
        { period: '11-12', description: 'Final assessment and long-term career planning', days: 70 }
    ],
    'research-project': [
        { period: '1', description: 'Research question definition and literature review', days: 0 },
        { period: '2', description: 'Methodology selection and planning', days: 7 },
        { period: '3-4', description: 'Data collection preparation', days: 14 },
        { period: '5-6', description: 'Data collection implementation', days: 28 },
        { period: '7-8', description: 'Data analysis', days: 42 },
        { period: '9', description: 'Results interpretation', days: 56 },
        { period: '10', description: 'Report/paper writing', days: 63 },
        { period: '11-12', description: 'Presentation preparation and delivery', days: 70 }
    ],
    'startup-mentoring': [
        { period: '1', description: 'Business idea validation and market research', days: 0 },
        { period: '2', description: 'Target audience and customer persona development', days: 7 },
        { period: '3', description: 'Business model canvas creation', days: 14 },
        { period: '4-5', description: 'MVP (Minimum Viable Product) planning', days: 21 },
        { period: '6-7', description: 'MVP development and testing', days: 35 },
        { period: '8', description: 'Initial marketing strategy', days: 49 },
        { period: '9-10', description: 'Funding options and pitch deck preparation', days: 56 },
        { period: '11-12', description: 'Launch strategy and growth planning', days: 70 }
    ],
    'leadership-development': [
        { period: '1', description: 'Leadership style assessment and strengths identification', days: 0 },
        { period: '2-3', description: 'Communication and interpersonal skills development', days: 7 },
        { period: '4', description: 'Team management and delegation strategies', days: 21 },
        { period: '5-6', description: 'Conflict resolution and problem solving', days: 28 },
        { period: '7', description: 'Emotional intelligence in leadership', days: 42 },
        { period: '8-9', description: 'Strategic thinking and decision making', days: 49 },
        { period: '10-11', description: 'Change management and organizational development', days: 63 },
        { period: '12', description: 'Personal leadership vision and ongoing growth plan', days: 77 }
    ]
};

// Function to get template duration in days
function getTemplateDuration(templateId) {
    const template = milestoneTemplates[templateId];
    if (!template || template.length === 0) return 0;
    
    // Find the milestone with the highest day value
    let maxDays = 0;
    template.forEach(milestone => {
        if (milestone.days > maxDays) {
            maxDays = milestone.days;
        }
    });
    
    // Add 7 days buffer to the end for final wrap-up
    return maxDays + 7;
}

// Function to set the expected end date based on template
function setExpectedEndDateFromTemplate(templateId) {
    const duration = getTemplateDuration(templateId);
    if (duration <= 0) return;
    
    const expectedEndDateInput = document.getElementById('expectedEndDate');
    if (!expectedEndDateInput) return;
    
    // Calculate end date as today + duration days
    const endDate = new Date();
    endDate.setDate(endDate.getDate() + duration);
    
    // Format the date for the input field (YYYY-MM-DD)
    const formattedDate = endDate.toISOString().split('T')[0];
    expectedEndDateInput.value = formattedDate;
    
    // Update the mentoring days display
    calculateMentoringDays();
}

// Function to apply a milestone template
function applyMilestoneTemplate(templateId) {
    const template = milestoneTemplates[templateId];
    if (!template) {
        showToast('error', 'Template not found');
        return;
    }
    
    // Get end date to calculate milestone dates
    const expectedEndDateInput = document.getElementById('expectedEndDate');
    if (!expectedEndDateInput || !expectedEndDateInput.value) {
        // If end date is not set, set it automatically based on template
        setExpectedEndDateFromTemplate(templateId);
        
        if (!expectedEndDateInput.value) {
            showToast('warning', 'Could not set expected end date');
            return;
        }
    }
    
    // Clear existing milestones
    const milestonesContainer = document.getElementById('milestones-container');
    milestonesContainer.innerHTML = '';
    
    // Calculate dates based on the timeline span
    // Start from TOMORROW instead of today
    const startDate = new Date();
    startDate.setDate(startDate.getDate() + 1); // Add 1 day to get tomorrow
    startDate.setHours(0, 0, 0, 0);
    
    const endDate = new Date(expectedEndDateInput.value);
    endDate.setHours(0, 0, 0, 0);
    
    // Calculate total duration in days
    const totalDuration = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24));
    
    // Get the template's original duration
    const templateDuration = getTemplateDuration(templateId) - 7; // Subtract the buffer we added
    
    // Apply template milestones
    template.forEach((milestone, index) => {
        // Calculate adjusted day offset based on the actual timeline duration
        let adjustedDayOffset;
        
        if (templateDuration <= 0) {
            // Fallback: Distribute evenly if template duration is invalid
            adjustedDayOffset = Math.floor((totalDuration * index) / (template.length - 1));
        } else {
            // Scale the day offset proportionally to fit the actual timeline
            const scaleFactor = totalDuration / templateDuration;
            adjustedDayOffset = Math.floor(milestone.days * scaleFactor);
        }
        
        // Calculate milestone date
        const milestoneDate = new Date(startDate);
        milestoneDate.setDate(milestoneDate.getDate() + adjustedDayOffset);
        
        // Make sure the date doesn't exceed the end date
        const finalDate = milestoneDate > endDate ? endDate : milestoneDate;
        
        // Format date for the input
        const formattedDate = finalDate.toISOString().split('T')[0]; // YYYY-MM-DD format
        
        // Create new milestone entry
        const newMilestone = document.createElement('div');
        newMilestone.className = 'milestone-entry mb-3';
        newMilestone.innerHTML = `
            <div class="row g-2">
                <div class="col">
                    <div class="input-group">
                        <span class="input-group-text">Week/Day</span>
                        <input type="text" class="form-control milestone-period" placeholder="1-2" required value="${milestone.period}">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="input-group">
                        <input type="date" class="form-control milestone-date" onchange="validateMilestoneDate(this)" value="${formattedDate}">
                        <span class="input-group-text date-toggle" onclick="toggleDateDisplay(this)">
                            <i class="fas fa-calendar-alt"></i>
                        </span>
                    </div>
                </div>
                <div class="col-md-6">
                    <input type="text" class="form-control milestone-description" placeholder="Introduction and goal setting" required value="${milestone.description}">
                </div>
                <div class="col-md-1 text-center">
                    <button type="button" class="btn btn-outline-danger remove-milestone-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        `;
        milestonesContainer.appendChild(newMilestone);
        
        // Add event listener to the remove button
        const removeBtn = newMilestone.querySelector('.remove-milestone-btn');
        removeBtn.addEventListener('click', function() {
            if (milestonesContainer.querySelectorAll('.milestone-entry').length > 1) {
                milestonesContainer.removeChild(newMilestone);
            } else {
                // Clear inputs if it's the last one
                const periodInput = newMilestone.querySelector('.milestone-period');
                const descriptionInput = newMilestone.querySelector('.milestone-description');
                const dateInput = newMilestone.querySelector('.milestone-date');
                
                if (periodInput) periodInput.value = '';
                if (descriptionInput) descriptionInput.value = '';
                if (dateInput) {
                    dateInput.value = '';
                    dateInput.classList.remove('is-invalid');
                }
            }
            validateAllMilestoneDates();
        });
    });
    
    // Validate all milestone dates
    validateAllMilestoneDates();
    
    showToast('success', `Applied ${template.length} milestones from template`);
}

// Add initialization for the template apply button
document.addEventListener('DOMContentLoaded', function() {
    // Initialize template selector to update expected end date on change
    const templateSelector = document.getElementById('templateSelector');
    if (templateSelector) {
        templateSelector.addEventListener('change', function() {
            if (this.value) {
                setExpectedEndDateFromTemplate(this.value);
            }
        });
    }
    
    // Initialize apply template button
    const applyTemplateBtn = document.getElementById('applyTemplateBtn');
    if (applyTemplateBtn) {
        applyTemplateBtn.addEventListener('click', function() {
            const templateSelector = document.getElementById('templateSelector');
            if (templateSelector && templateSelector.value) {
                applyMilestoneTemplate(templateSelector.value);
            } else {
                showToast('warning', 'Please select a template first');
            }
        });
    }
});
</script>

<!-- Find the script section for timeline handling and add these functions -->
<script>
// Function to add a new milestone
function addNewMilestone() {
    const milestonesContainer = document.getElementById('milestones-container');
    
    const milestoneRow = document.createElement('div');
    milestoneRow.className = 'milestone-row row mb-3 pb-3 border-bottom align-items-center';
    
    milestoneRow.innerHTML = `
        <div class="col-md-2">
            <label class="form-label d-md-none">Week/Day:</label>
            <input type="text" class="form-control milestone-period" placeholder="1-2" required>
        </div>
        <div class="col-md-3">
            <label class="form-label d-md-none">Date:</label>
            <div class="input-group">
                <input type="date" class="form-control milestone-date" onchange="validateMilestoneDate(this)">
                <span class="input-group-text date-toggle" onclick="toggleDateDisplay(this)">
                    <i class="fas fa-calendar-alt"></i>
                </span>
            </div>
        </div>
        <div class="col-md-6">
            <label class="form-label d-md-none">Description:</label>
            <input type="text" class="form-control milestone-description" placeholder="Milestone description" required>
        </div>
        <div class="col-md-1 text-center">
            <button type="button" class="btn btn-outline-danger remove-milestone-btn mt-md-0 mt-2">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    
    milestonesContainer.appendChild(milestoneRow);
    
    const removeBtn = milestoneRow.querySelector('.remove-milestone-btn');
    removeBtn.addEventListener('click', function() {
        removeMilestone(milestoneRow);
    });
}

// Function to remove a milestone
function removeMilestone(milestoneRow) {
    if (!milestoneRow) return;
    
    const milestonesContainer = document.getElementById('milestones-container');
    const allRows = milestonesContainer.querySelectorAll('.milestone-row');
    
    if (allRows.length <= 1) {
        // If it's the last row, just clear the inputs instead of removing
        const periodInput = milestoneRow.querySelector('.milestone-period');
        const descriptionInput = milestoneRow.querySelector('.milestone-description');
        const dateInput = milestoneRow.querySelector('.milestone-date');
        
        if (periodInput) periodInput.value = '';
        if (descriptionInput) descriptionInput.value = '';
        if (dateInput) {
            dateInput.value = '';
            dateInput.classList.remove('is-invalid');
        }
    } else {
        // Otherwise remove the row
        milestonesContainer.removeChild(milestoneRow);
    }
    
    // Re-validate after changes
    validateAllMilestoneDates();
}

// Initialize milestone buttons
document.addEventListener('DOMContentLoaded', function() {
    const timelineModal = document.getElementById('timelineModal');
    if (timelineModal) {
        timelineModal.addEventListener('shown.bs.modal', function() {
            // Initialize the add milestone button
            const addMilestoneBtn = document.getElementById('add-milestone-btn');
            if (addMilestoneBtn) {
                // Remove any existing event listeners
                const newBtn = addMilestoneBtn.cloneNode(true);
                addMilestoneBtn.parentNode.replaceChild(newBtn, addMilestoneBtn);
                
                // Add new event listener
                newBtn.addEventListener('click', addNewMilestone);
            }
            
            // Initialize existing remove buttons
            document.querySelectorAll('.remove-milestone-btn').forEach(button => {
                const newBtn = button.cloneNode(true);
                button.parentNode.replaceChild(newBtn, button);
                newBtn.addEventListener('click', function() {
                    removeMilestone(this.closest('.milestone-row'));
                });
            });
        });
    }
});

// Update the applyMilestoneTemplate function to use the new structure
const originalApplyMilestoneTemplate = applyMilestoneTemplate;
applyMilestoneTemplate = function(templateId) {
    const template = milestoneTemplates[templateId];
    if (!template) {
        showToast('error', 'Template not found');
        return;
    }
    
    // Get end date to calculate milestone dates
    const expectedEndDateInput = document.getElementById('expectedEndDate');
    if (!expectedEndDateInput || !expectedEndDateInput.value) {
        // If end date is not set, set it automatically based on template
        setExpectedEndDateFromTemplate(templateId);
        
        if (!expectedEndDateInput.value) {
            showToast('warning', 'Could not set expected end date');
            return;
        }
    }
    
    // Clear existing milestones
    const milestonesContainer = document.getElementById('milestones-container');
    milestonesContainer.innerHTML = '';
    
    // Calculate dates based on the timeline span
    // Start from TOMORROW instead of today
    const startDate = new Date();
    startDate.setDate(startDate.getDate() + 1); // Add 1 day to get tomorrow
    startDate.setHours(0, 0, 0, 0);
    
    const endDate = new Date(expectedEndDateInput.value);
    endDate.setHours(0, 0, 0, 0);
    
    // Calculate total duration in days
    const totalDuration = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24));
    
    // Get the template's original duration
    const templateDuration = getTemplateDuration(templateId) - 7; // Subtract the buffer we added
    
    // Apply template milestones
    template.forEach((milestone, index) => {
        // Calculate adjusted day offset based on the actual timeline duration
        let adjustedDayOffset;
        
        if (templateDuration <= 0) {
            // Fallback: Distribute evenly if template duration is invalid
            adjustedDayOffset = Math.floor((totalDuration * index) / (template.length - 1));
        } else {
            // Scale the day offset proportionally to fit the actual timeline
            const scaleFactor = totalDuration / templateDuration;
            adjustedDayOffset = Math.floor(milestone.days * scaleFactor);
        }
        
        // Calculate milestone date
        const milestoneDate = new Date(startDate);
        milestoneDate.setDate(milestoneDate.getDate() + adjustedDayOffset);
        
        // Make sure the date doesn't exceed the end date
        const finalDate = milestoneDate > endDate ? endDate : milestoneDate;
        
        // Format date for the input
        const formattedDate = finalDate.toISOString().split('T')[0]; // YYYY-MM-DD format
        
        // Create new milestone row
        const milestoneRow = document.createElement('div');
        milestoneRow.className = 'milestone-row row mb-3 pb-3 border-bottom align-items-center';
        
        milestoneRow.innerHTML = `
            <div class="col-md-2">
                <label class="form-label d-md-none">Week/Day:</label>
                <input type="text" class="form-control milestone-period" placeholder="1-2" value="${milestone.period}" required>
            </div>
            <div class="col-md-3">
                <label class="form-label d-md-none">Date:</label>
                <div class="input-group">
                    <input type="date" class="form-control milestone-date" value="${formattedDate}" onchange="validateMilestoneDate(this)">
                    <span class="input-group-text date-toggle" onclick="toggleDateDisplay(this)">
                        <i class="fas fa-calendar-alt"></i>
                    </span>
                </div>
            </div>
            <div class="col-md-6">
                <label class="form-label d-md-none">Description:</label>
                <input type="text" class="form-control milestone-description" placeholder="Milestone description" value="${milestone.description}" required>
            </div>
            <div class="col-md-1 text-center">
                <button type="button" class="btn btn-outline-danger remove-milestone-btn mt-md-0 mt-2">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        milestonesContainer.appendChild(milestoneRow);
        
        // Add event listener to the remove button
        const removeBtn = milestoneRow.querySelector('.remove-milestone-btn');
        removeBtn.addEventListener('click', function() {
            removeMilestone(milestoneRow);
        });
    });
    
    // Validate all milestone dates
    validateAllMilestoneDates();
    
    showToast('success', `Applied ${template.length} milestones from template`);
};

// Function to submit the timeline - update to use the new structure
const originalSubmitTimeline = submitTimeline;
submitTimeline = function() {
    // Check if the original function exists and call it if it does
    if (typeof originalSubmitTimeline === 'function') {
        // Check if we need to modify the data collection logic
        try {
            // Get all milestone entries
            const milestonesContainer = document.getElementById('milestones-container');
            const milestoneRows = milestonesContainer.querySelectorAll('.milestone-row');
            
            if (milestoneRows.length > 0) {
                // We have the new structure, so we'll override the data collection
                const expectedEndDateInput = document.getElementById('expectedEndDate');
                const mentorshipIdInput = document.getElementById('mentorshipIdForTimeline');
                const notesTextarea = document.getElementById('timelineMilestones');
                
                // Verify required fields
                if (!expectedEndDateInput || !expectedEndDateInput.value) {
                    showToast('error', 'Please set an expected end date');
                    return;
                }
                
                // Collect milestone data
                const milestones = [];
                let hasEmptyFields = false;
                
                milestoneRows.forEach(row => {
                    const periodInput = row.querySelector('.milestone-period');
                    const dateInput = row.querySelector('.milestone-date');
                    const descriptionInput = row.querySelector('.milestone-description');
                    
                    // Check if required fields are filled
                    if (!periodInput.value.trim() || !descriptionInput.value.trim()) {
                        hasEmptyFields = true;
                        return;
                    }
                    
                    milestones.push({
                        period: periodInput.value.trim(),
                        date: dateInput.value || '',
                        description: descriptionInput.value.trim()
                    });
                });
                
                if (hasEmptyFields) {
                    showToast('error', 'Please fill in all required milestone fields');
                    return;
                }
                
                if (milestones.length === 0) {
                    showToast('error', 'Please add at least one milestone');
                    return;
                }
                
                // Validate milestone dates
                if (!validateAllMilestoneDates()) {
                    return;
                }
                
                // Show loading state
                const saveButton = document.getElementById('saveTimeline');
                if (saveButton) {
                    saveButton.disabled = true;
                    saveButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Saving...';
                }
                
                // Send the data to the server
                fetch('/mentorship/set-timeline/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        mentorship_id: mentorshipIdInput ? mentorshipIdInput.value : '',
                        expected_end_date: expectedEndDateInput.value,
                        milestones: milestones,
                        notes: notesTextarea ? notesTextarea.value : ''
                    })
                })
                .then(response => {
                    // First check if the response is ok
                    if (!response.ok) {
                        // Try to get status code info to provide better error messages
                        const errorMsg = `Server error: ${response.status} ${response.statusText}`;
                        console.error(errorMsg);
                        throw new Error(errorMsg);
                    }
                    
                    // Check content type to avoid JSON parse errors
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        console.error('Response is not JSON. Content-Type:', contentType);
                        throw new Error('Server returned an invalid response format');
                    }
                    
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        showToast('success', 'Timeline saved successfully');
                        // Close the modal
                        const closeBtn = document.querySelector('#timelineModal .btn-close');
                        if (closeBtn) closeBtn.click();
                        // Refresh the page
                        setTimeout(() => window.location.reload(), 1000);
                    } else {
                        showToast('error', data.error || 'Failed to save timeline');
                        if (saveButton) {
                            saveButton.disabled = false;
                            saveButton.innerHTML = '<i class="fas fa-save me-2"></i>Save Timeline';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('error', `An error occurred while saving: ${error.message || 'Unknown error'}`);
                    if (saveButton) {
                        saveButton.disabled = false;
                        saveButton.innerHTML = '<i class="fas fa-save me-2"></i>Save Timeline';
                    }
                });
                
                // We've handled submission with the new structure
                return;
            }
        } catch (e) {
            console.error('Error detecting milestone structure:', e);
        }
        
        // Fall back to the original function if we couldn't handle it with the new structure
        return originalSubmitTimeline();
    }
    
    // If original function doesn't exist, show an error
    showToast('error', 'Timeline submission function not found');
};

function updateMeetingLink() {
    const meetingId = document.getElementById('editMeetingId').value;
    const meetingLink = document.getElementById('editMeetingLink').value;
    
    // Validate meeting link
    if (!meetingLink) {
        showToast('error', 'Please enter a meeting link');
        return;
    }
    
    // Validate that the meeting link is valid
    if (!meetingLink.startsWith('http://') && !meetingLink.startsWith('https://')) {
        showToast('error', 'Please enter a valid meeting link starting with http:// or https://');
        return;
    }
    
    fetch(`/mentorship/api/meetings/${meetingId}/`, {
        method: 'PATCH',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            meeting_link: meetingLink
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to update meeting link');
        }
        return response.json();
    })
    .then(data => {
        var editMeetingModal = document.getElementById('editMeetingModal');
        var modal = bootstrap.Modal.getInstance(editMeetingModal);
        if (modal) modal.hide();
        
        showToast('success', 'Meeting link updated successfully');
        setTimeout(() => location.reload(), 1500);
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Failed to update meeting link. Please try again.');
    });
}
</script>

// Function to handle schedule meeting form submission
function submitScheduleMeeting(event) {
    event.preventDefault();
    
    const mentorshipId = document.getElementById('mentorshipIdInput').value;
    const meetingTitle = document.getElementById('meetingTitle').value;
    const meetingDate = document.getElementById('meetingDate').value;
    const meetingLink = document.getElementById('meetingLink').value;
    const meetingAgenda = document.getElementById('meetingAgenda').value;
    
    // Validate required fields
    if (!mentorshipId || !meetingTitle || !meetingDate || !meetingAgenda) {
        showToast('error', 'Please fill out all required fields.');
        return;
    }
    
    // Create form data
    const formData = {
        mentorship: mentorshipId,
        title: meetingTitle,
        meeting_date: meetingDate,
        meeting_link: meetingLink,
        description: meetingAgenda,
        status: 'SCHEDULED'
    };
    
    // Submit using fetch API
    fetch('/mentorship/api/meetings/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to schedule meeting');
        }
        return response.json();
    })
    .then(data => {
        // Close the modal
        const scheduleMeetingModal = document.getElementById('scheduleMeetingModal');
        const modal = bootstrap.Modal.getInstance(scheduleMeetingModal);
        if (modal) modal.hide();
        
        // Show success message
        showToast('success', 'Meeting scheduled successfully!');
        
        // Reload the page after a short delay
        setTimeout(() => location.reload(), 1500);
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Failed to schedule meeting. Please try again.');
    });
}

// Function to parse existing timeline milestones when editing
function parseExistingMilestones(timelineText) {
    if (!timelineText) return;
    
    const milestonesContainer = document.getElementById('milestones-container');
    if (!milestonesContainer) {
        console.error('Milestones container not found');
        return;
    }

    // Clear existing milestone entries
    // Use the newer milestone-row class if it exists, otherwise fall back to milestone-entry
    const rowSelector = milestonesContainer.querySelector('.milestone-row') ? '.milestone-row' : '.milestone-entry';
    const existingEntries = milestonesContainer.querySelectorAll(rowSelector);
    
    // Remove all existing entries except the first one
    if (existingEntries.length > 0) {
        for (let i = 1; i < existingEntries.length; i++) {
            milestonesContainer.removeChild(existingEntries[i]);
        }
        
        // Reset the first entry
        const firstEntry = existingEntries[0];
        if (firstEntry) {
            const periodInput = firstEntry.querySelector('.milestone-period');
            const descriptionInput = firstEntry.querySelector('.milestone-description');
            
            if (periodInput) periodInput.value = '';
            if (descriptionInput) descriptionInput.value = '';
        }
    } else {
        // If no entries exist, try to add one using the new function
        if (typeof addNewMilestone === 'function') {
            console.log('Adding first milestone entry using addNewMilestone');
            addNewMilestone();
        } else {
            console.error('No milestone entries found and addNewMilestone function not available');
        }
    }
    
    // Parse the timeline text
    const lines = timelineText.split('\n');
    let additionalNotes = '';
    let inAdditionalNotes = false;
    
    lines.forEach((line, index) => {
        line = line.trim();
        if (!line) return;
        
        if (line.startsWith('Additional Notes:')) {
            inAdditionalNotes = true;
            return;
        }
        
        if (inAdditionalNotes) {
            additionalNotes += line + '\n';
            return;
        }
        
        const weekDayMatch = line.match(/^Week\/Day\s+([^:]+):\s*(.+)$/);
        if (weekDayMatch) {
            const period = weekDayMatch[1];
            let description = weekDayMatch[2];
            
            // Remove status if present
            if (description.includes('[')) {
                description = description.split('[')[0].trim();
            }
            
            // Use newer milestone-row class if it exists, otherwise fall back to milestone-entry
            const rowSelector = milestonesContainer.querySelector('.milestone-row') ? '.milestone-row' : '.milestone-entry';
            const existingEntries = milestonesContainer.querySelectorAll(rowSelector);
            
            if (index === 0 && existingEntries.length > 0) {
                // Use the first entry
                const firstEntry = existingEntries[0];
                if (firstEntry) {
                    const periodInput = firstEntry.querySelector('.milestone-period');
                    const descriptionInput = firstEntry.querySelector('.milestone-description');
                    
                    if (periodInput) periodInput.value = period;
                    if (descriptionInput) descriptionInput.value = description;
                }
            } else {
                // Add a new entry using the newer function if available
                if (typeof addNewMilestone === 'function') {
                    addNewMilestone();
                    
                    // Get the newly created row (should be the last one)
                    const newEntries = milestonesContainer.querySelectorAll(rowSelector);
                    if (newEntries.length > 0) {
                        const newEntry = newEntries[newEntries.length - 1];
                        const periodInput = newEntry.querySelector('.milestone-period');
                        const descriptionInput = newEntry.querySelector('.milestone-description');
                        
                        if (periodInput) periodInput.value = period;
                        if (descriptionInput) descriptionInput.value = description;
                    }
                } else {
                    // Fall back to using the add-milestone-btn click
                    const addMilestoneBtn = document.getElementById('add-milestone-btn');
                    if (addMilestoneBtn) {
                        addMilestoneBtn.click();
                        
                        // Find the new entry (should be the last one)
                        const allEntries = milestonesContainer.querySelectorAll(rowSelector);
                        if (allEntries.length > 0) {
                            const newEntry = allEntries[allEntries.length - 1];
                            if (newEntry) {
                                const periodInput = newEntry.querySelector('.milestone-period');
                                const descriptionInput = newEntry.querySelector('.milestone-description');
                                
                                if (periodInput) periodInput.value = period;
                                if (descriptionInput) descriptionInput.value = description;
                            } else {
                                console.error('Failed to create new milestone entry');
                            }
                        }
                    } else {
                        console.error('Add milestone button not found');
                    }
                }
            }
        }
    });
    
    // Update additional notes field
    if (additionalNotes) {
        const notesField = document.getElementById('timelineMilestones');
        if (notesField) {
            notesField.value = additionalNotes.trim();
        }
    }
}

// Function to set timeline
function setTimeline(mentorshipId) {
    // Show timeline modal
    var timelineModal = document.getElementById('timelineModal');
    if (!timelineModal) {
        console.error('Timeline modal element not found');
        showToast('error', 'Timeline modal not found. Please refresh the page and try again.');
        return;
    }
    
    var modal = bootstrap.Modal.getInstance(timelineModal) || new bootstrap.Modal(timelineModal);
    
    const mentorshipIdInput = document.getElementById('mentorshipIdForTimeline');
    if (!mentorshipIdInput) {
        console.error('Mentorship ID input element not found');
        showToast('error', 'Form elements not found. Please refresh the page and try again.');
        return;
    }
    mentorshipIdInput.value = mentorshipId;
    
    // Clear any previous error
    const errorContainer = document.getElementById('timeline-error-message');
    if (errorContainer) {
        errorContainer.classList.add('d-none');
    }
    
    // Fetch existing timeline data if available
    fetch(`/mentorship/api/requests/${mentorshipId}/`, {
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        const expectedEndDateInput = document.getElementById('expectedEndDate');
        if (expectedEndDateInput && data.expected_end_date) {
            expectedEndDateInput.value = data.expected_end_date.split('T')[0];
        }
        
        if (data.timeline_milestones) {
            parseExistingMilestones(data.timeline_milestones);
        } else {
            // Reset form if no existing timeline
            const milestonesContainer = document.getElementById('milestones-container');
            if (milestonesContainer) {
                const existingEntries = milestonesContainer.querySelectorAll('.milestone-entry');
                if (existingEntries.length > 0) {
                    // Keep only the first entry and reset it
                    for (let i = 1; i < existingEntries.length; i++) {
                        milestonesContainer.removeChild(existingEntries[i]);
                    }
                    const firstEntry = existingEntries[0];
                    if (firstEntry) {
                        const periodInput = firstEntry.querySelector('.milestone-period');
                        const descriptionInput = firstEntry.querySelector('.milestone-description');
                        if (periodInput) periodInput.value = '';
                        if (descriptionInput) descriptionInput.value = '';
                    }
                }
            }
            
            const timelineMilestonesInput = document.getElementById('timelineMilestones');
            if (timelineMilestonesInput) {
                timelineMilestonesInput.value = '';
            }
        }
        modal.show();
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Failed to fetch timeline data. Please try again.');
        modal.show(); // Show modal anyway
    });
}

// Modified submitTimeline function to include validation
function submitTimeline() {
    // Validate dates before submission
    validateAllMilestoneDates();
    
    // Get the timeline alert to check for errors
    const timelineAlert = document.getElementById('timeline-alert');
    if (timelineAlert && !timelineAlert.classList.contains('d-none')) {
        // There are validation errors, don't submit
        showToast('error', 'Please fix the timeline date errors before saving.');
        return;
    }
    
    // Original function continues here...
    const mentorshipId = document.getElementById('mentorshipIdForTimeline').value;
    const expectedEndDate = document.getElementById('expectedEndDate').value;
    const additionalNotes = document.getElementById('timelineMilestones').value;
    
    // Validate required fields
    if (!expectedEndDate) {
        showToast('error', 'Please select an expected end date');
        return;
    }
    
    // Collect all milestone entries
    const milestoneEntries = document.querySelectorAll('.milestone-entry');
    
    // Check if there are any milestone entries
    if (milestoneEntries.length === 0) {
        // Add a new milestone entry if none exist
        const addMilestoneBtn = document.getElementById('add-milestone-btn');
        if (addMilestoneBtn) {
            addMilestoneBtn.click();
            showToast('error', 'Please add at least one milestone with both period and description');
            return;
        }
    }
    
    let formattedMilestones = '';
    let hasValidMilestones = false;
    
    milestoneEntries.forEach(entry => {
        const periodInput = entry.querySelector('.milestone-period');
        const descriptionInput = entry.querySelector('.milestone-description');
        const dateInput = entry.querySelector('.milestone-date');
        
        if (!periodInput || !descriptionInput) return;
        
        const period = periodInput.value.trim();
        const description = descriptionInput.value.trim();
        const date = dateInput ? dateInput.value.trim() : '';
        
        if (period && description) {
            let formattedDescription = description;
            if (date) {
                formattedDescription = `${description} [Date: ${date}]`;
            }
            formattedMilestones += `Week/Day ${period}: ${formattedDescription}\n`;
            hasValidMilestones = true;
        } else if (period || description) {
            // If one field is filled but not the other, highlight the empty field
            if (!period) {
                periodInput.classList.add('is-invalid');
                setTimeout(() => periodInput.classList.remove('is-invalid'), 3000);
            }
            if (!description) {
                descriptionInput.classList.add('is-invalid');
                setTimeout(() => descriptionInput.classList.remove('is-invalid'), 3000);
            }
        }
    });
    
    if (!hasValidMilestones) {
        showToast('error', 'Please add at least one milestone with both period and description');
        return;
    }
    
    // Add additional notes if provided
    if (additionalNotes) {
        formattedMilestones += `\nAdditional Notes:\n${additionalNotes}`;
    }
    
    // Show loading state
    const submitButton = document.querySelector('#timelineModal .btn-primary');
    const originalText = submitButton.textContent;
    submitButton.disabled = true;
    submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
    
    fetch(`/mentorship/api/requests/${mentorshipId}/update_timeline/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            expected_end_date: expectedEndDate,
            timeline_milestones: formattedMilestones
        })
    })
    .then(async response => {
        if (!response.ok) {
            // Try to get error details from response
            const errorData = await response.json().catch(() => null);
            throw new Error(errorData?.detail || `Error: ${response.status} ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        var timelineModal = document.getElementById('timelineModal');
        var modal = bootstrap.Modal.getInstance(timelineModal);
        if (modal) modal.hide();
        
        showToast('success', 'Mentorship timeline updated successfully');
        setTimeout(() => location.reload(), 1500);
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', error.message || 'Failed to update timeline. Please try again.');
        
        // Reset button state
        submitButton.disabled = false;
        submitButton.innerHTML = originalText;
    });
}

// Enhance the timeline display with milestone markers
function enhanceTimelineDisplay() {
    document.querySelectorAll('.timeline-container').forEach(container => {
        const timelineText = container.querySelector('.timeline-text').textContent;
        const progressBar = container.querySelector('.progress');
        let progressPercentage = 0;
        
        // Get the progress percentage from the progress bar if it exists
        if (progressBar && progressBar.querySelector('.progress-bar')) {
            const progressBarStyle = progressBar.querySelector('.progress-bar').getAttribute('style');
            const percentMatch = progressBarStyle.match(/width:\s*(\d+)%/);
            if (percentMatch && percentMatch[1]) {
                progressPercentage = parseInt(percentMatch[1]);
            } else {
                // Fallback to aria-valuenow
                progressPercentage = parseInt(progressBar.querySelector('.progress-bar').getAttribute('aria-valuenow') || 0);
            }
        }
        
        if (!timelineText) return;
        
        // Parse the timeline text to extract milestones
        const lines = timelineText.split('\n');
        let milestones = [];
        let inAdditionalNotes = false;
        
        lines.forEach(line => {
            line = line.trim();
            if (!line) return;
            
            if (line.startsWith('Additional Notes:')) {
                inAdditionalNotes = true;
                return;
            }
            
            if (inAdditionalNotes) {
                return;
            }
            
            const weekDayMatch = line.match(/^Week\/Day\s+([^:]+):\s*(.+)$/);
            if (weekDayMatch) {
                const period = weekDayMatch[1];
                const description = weekDayMatch[2];
                
                // Extract status if available
                let status = 'NOT_STARTED';
                const statusMatch = description.match(/(.+)\s+\[([A-Z_]+)\]$/);
                const cleanDescription = statusMatch ? statusMatch[1].trim() : description;
                if (statusMatch) {
                    status = statusMatch[2];
                }
                
                // Parse the period to get a position for the marker
                let position = 0;
                if (period.includes('-')) {
                    const [start, end] = period.split('-').map(p => parseInt(p.trim()));
                    position = (start + end) / 2;
                } else {
                    position = parseInt(period);
                }
                
                milestones.push({
                    period: period,
                    description: cleanDescription,
                    status: status,
                    position: position
                });
            }
        });
        
        // Create thermometer-style progress bar if milestones exist
        if (milestones.length > 0) {
            // Find the maximum position to scale properly
            const maxPosition = Math.max(...milestones.map(m => m.position));
            
            // Sort milestones by position
            milestones.sort((a, b) => a.position - b.position);
            
            // Calculate completion status
            const totalMilestones = milestones.length;
            const completedMilestones = milestones.filter(m => m.status === 'COMPLETED').length;
            const inProgressMilestones = milestones.filter(m => m.status === 'IN_PROGRESS').length;
            
            // Calculate actual percentage based on milestone completion
            const calculatedPercentage = Math.round((completedMilestones + (inProgressMilestones * 0.5)) / totalMilestones * 100);
            
            // Use the calculated percentage if it's available, otherwise use the one from the progress bar
            const displayPercentage = calculatedPercentage || progressPercentage;
            
            // Create a thermometer-style progress container
            const thermometerContainer = document.createElement('div');
            thermometerContainer.style.position = 'relative';
            thermometerContainer.style.margin = '40px 0 60px';
            thermometerContainer.style.padding = '0 10px';
            
            // Add status text
            const statusElement = document.createElement('div');
            statusElement.style.position = 'absolute';
            statusElement.style.top = '-35px';
            statusElement.style.left = '10px';
            statusElement.style.fontSize = '0.85rem';
            statusElement.style.fontWeight = '500';
            statusElement.style.color = '#495057';
            
            let statusText = '';
            if (displayPercentage === 100) {
                statusText = 'Completed';
            } else if (displayPercentage > 0) {
                statusText = 'In Progress';
            } else {
                statusText = 'Not Started';
            }
            statusElement.textContent = statusText;
            thermometerContainer.appendChild(statusElement);
            
            // Add dates
            const datesContainer = document.createElement('div');
            datesContainer.style.display = 'flex';
            datesContainer.style.justifyContent = 'space-between';
            datesContainer.style.marginBottom = '10px';
            datesContainer.style.fontSize = '0.85rem';
            datesContainer.style.color = '#495057';
            datesContainer.style.fontWeight = '500';
            
            const startDateElement = container.closest('.card-body').querySelector('small:first-child');
            const endDateElement = container.closest('.card-body').querySelector('small:last-child');
            
            const startDate = startDateElement ? startDateElement.textContent.replace('Started: ', '') : 'Start';
            const endDate = endDateElement ? endDateElement.textContent.replace('Target End: ', '') : 'End';
            
            datesContainer.innerHTML = `
                <span>${startDate}</span>
                <span>${endDate}</span>
            `;
            
            thermometerContainer.appendChild(datesContainer);
            
            // Add percentage indicator
            const percentageElement = document.createElement('div');
            percentageElement.style.position = 'absolute';
            percentageElement.style.top = '-35px';
            percentageElement.style.right = '10px';
            percentageElement.style.backgroundColor = '#343a40';
            percentageElement.style.color = 'white';
            percentageElement.style.padding = '4px 10px';
            percentageElement.style.borderRadius = '20px';
            percentageElement.style.fontSize = '0.85rem';
            percentageElement.style.fontWeight = 'bold';
            percentageElement.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
            percentageElement.textContent = `${displayPercentage}%`;
            thermometerContainer.appendChild(percentageElement);
            
            // Create the thermometer track
            const trackElement = document.createElement('div');
            trackElement.style.height = '16px';
            trackElement.style.backgroundColor = '#e9ecef';
            trackElement.style.borderRadius = '8px';
            trackElement.style.position = 'relative';
            trackElement.style.boxShadow = 'inset 0 1px 3px rgba(0,0,0,0.1)';
            trackElement.style.overflow = 'hidden';
            
            // Create the thermometer fill
            const fillElement = document.createElement('div');
            fillElement.style.position = 'absolute';
            fillElement.style.top = '0';
            fillElement.style.left = '0';
            fillElement.style.height = '100%';
            fillElement.style.background = 'linear-gradient(90deg, #4481eb 0%, #04befe 100%)';
            fillElement.style.borderRadius = '8px';
            fillElement.style.transition = 'width 0.6s ease';
            fillElement.style.width = `${displayPercentage}%`;
            
            trackElement.appendChild(fillElement);
            thermometerContainer.appendChild(trackElement);
            
            // Add thermometer bulb
            const bulbElement = document.createElement('div');
            bulbElement.style.position = 'absolute';
            bulbElement.style.left = `${displayPercentage}%`;
            bulbElement.style.top = '8px';
            bulbElement.style.transform = 'translate(-50%, -50%)';
            bulbElement.style.width = '30px';
            bulbElement.style.height = '30px';
            bulbElement.style.background = 'linear-gradient(135deg, #4481eb 0%, #04befe 100%)';
            bulbElement.style.borderRadius = '50%';
            bulbElement.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
            bulbElement.style.zIndex = '2';
            bulbElement.style.border = '3px solid #fff';
            
            // Add shine effect to bulb
            const bulbShine = document.createElement('div');
            bulbShine.style.position = 'absolute';
            bulbShine.style.top = '50%';
            bulbShine.style.left = '50%';
            bulbShine.style.transform = 'translate(-50%, -50%)';
            bulbShine.style.width = '15px';
            bulbShine.style.height = '15px';
            bulbShine.style.background = 'rgba(255, 255, 255, 0.3)';
            bulbShine.style.borderRadius = '50%';
            
            bulbElement.appendChild(bulbShine);
            thermometerContainer.appendChild(bulbElement);
            
            // Create scale marks
            const scaleContainer = document.createElement('div');
            scaleContainer.style.position = 'absolute';
            scaleContainer.style.bottom = '-25px';
            scaleContainer.style.left = '0';
            scaleContainer.style.right = '0';
            
            // Add scale marks at 0%, 25%, 50%, 75%, and 100%
            [0, 25, 50, 75, 100].forEach(percent => {
                const scaleMark = document.createElement('div');
                scaleMark.style.position = 'absolute';
                scaleMark.style.width = '1px';
                scaleMark.style.height = '10px';
                scaleMark.style.backgroundColor = '#6c757d';
                scaleMark.style.bottom = '15px';
                scaleMark.style.left = `${percent}%`;
                
                const scaleLabel = document.createElement('div');
                scaleLabel.style.position = 'absolute';
                scaleLabel.style.transform = 'translateX(-50%)';
                scaleLabel.style.bottom = '0';
                scaleLabel.style.left = `${percent}%`;
                scaleLabel.style.fontSize = '0.75rem';
                scaleLabel.style.color = '#6c757d';
                scaleLabel.textContent = `${percent}%`;
                
                scaleContainer.appendChild(scaleMark);
                scaleContainer.appendChild(scaleLabel);
            });
            
            thermometerContainer.appendChild(scaleContainer);
            
            // Create milestone markers container
            const markersContainer = document.createElement('div');
            markersContainer.style.position = 'relative';
            markersContainer.style.height = '60px';
            markersContainer.style.marginTop = '10px';
            
            // Add milestone markers
            milestones.forEach((milestone, index) => {
                const position = (milestone.position / maxPosition) * 100;
                
                const markerElement = document.createElement('div');
                markerElement.style.position = 'absolute';
                markerElement.style.transform = 'translateX(-50%)';
                markerElement.style.left = `${position}%`;
                
                // Create marker line
                const markerLine = document.createElement('div');
                markerLine.style.width = '2px';
                markerLine.style.height = milestone.status === 'COMPLETED' ? '15px' : 
                                          milestone.status === 'IN_PROGRESS' ? '12px' : '10px';
                markerLine.style.backgroundColor = milestone.status === 'COMPLETED' ? '#28a745' : 
                                                  milestone.status === 'IN_PROGRESS' ? '#ffc107' : '#6c757d';
                markerLine.style.margin = '0 auto 5px';
                
                // Create marker dot
                const markerDot = document.createElement('div');
                markerDot.style.width = '24px';
                markerDot.style.height = '24px';
                markerDot.style.borderRadius = '50%';
                markerDot.style.backgroundColor = milestone.status === 'COMPLETED' ? '#28a745' : 
                                                 milestone.status === 'IN_PROGRESS' ? '#ffc107' : '#e9ecef';
                markerDot.style.border = '3px solid #fff';
                markerDot.style.boxShadow = milestone.status === 'COMPLETED' ? '0 0 0 2px rgba(40, 167, 69, 0.3)' : 
                                           milestone.status === 'IN_PROGRESS' ? '0 0 0 2px rgba(255, 193, 7, 0.3)' : '0 0 0 2px #e9ecef';
                markerDot.style.margin = '0 auto 8px';
                markerDot.style.position = 'relative';
                markerDot.style.zIndex = '3';
                markerDot.style.cursor = 'pointer';
                
                // Create marker label
                const markerLabel = document.createElement('div');
                markerLabel.style.fontSize = '0.8rem';
                markerLabel.style.color = '#495057';
                markerLabel.style.textAlign = 'center';
                markerLabel.style.maxWidth = '100px';
                markerLabel.style.overflow = 'hidden';
                markerLabel.style.textOverflow = 'ellipsis';
                markerLabel.style.whiteSpace = 'nowrap';
                markerLabel.style.fontWeight = '500';
                markerLabel.style.position = 'relative';
                markerLabel.textContent = `Day ${milestone.period}`;
                
                // Create tooltip
                const tooltip = document.createElement('div');
                tooltip.style.position = 'absolute';
                tooltip.style.bottom = '100%';
                tooltip.style.left = '50%';
                tooltip.style.transform = 'translateX(-50%)';
                tooltip.style.backgroundColor = '#343a40';
                tooltip.style.color = 'white';
                tooltip.style.padding = '8px 12px';
                tooltip.style.borderRadius = '4px';
                tooltip.style.fontSize = '0.8rem';
                tooltip.style.whiteSpace = 'nowrap';
                tooltip.style.opacity = '0';
                tooltip.style.visibility = 'hidden';
                tooltip.style.transition = 'opacity 0.3s, visibility 0.3s';
                tooltip.style.zIndex = '10';
                tooltip.style.pointerEvents = 'none';
                tooltip.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
                tooltip.style.minWidth = '150px';
                tooltip.style.textAlign = 'center';
                tooltip.style.marginBottom = '10px';
                
                let statusText = 'Not Started';
                if (milestone.status === 'IN_PROGRESS') {
                    statusText = 'In Progress';
                } else if (milestone.status === 'COMPLETED') {
                    statusText = 'Completed';
                }
                
                tooltip.innerHTML = `
                    <div>${milestone.description}</div>
                    <div style="margin-top: 5px; font-weight: bold; color: ${
                        milestone.status === 'COMPLETED' ? '#28a745' : 
                        milestone.status === 'IN_PROGRESS' ? '#ffc107' : '#6c757d'
                    }">
                        ${statusText}
                    </div>
                `;
                
                markerWrapper.appendChild(tooltip);
                
                // Add click event to show milestone details
                markerWrapper.addEventListener('click', function() {
                    try {
                        // Highlight the corresponding row in the milestone table
                        const tableRows = document.querySelectorAll('#milestone-table-body tr');
                        tableRows.forEach((row, rowIndex) => {
                            if (rowIndex === index) {
                                row.classList.add('table-active');
                                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            } else {
                                row.classList.remove('table-active');
                            }
                        });
                    } catch (clickError) {
                        console.warn('Error in milestone click handler:', clickError);
                    }
                });
            } catch (milestoneError) {
                console.warn(`Error rendering milestone ${index}:`, milestoneError);
            }
        });
        
        // Add current position indicator if there are in-progress milestones
        if (inProgressMilestones > 0) {
            try {
                const currentPositionMarker = document.createElement('div');
                currentPositionMarker.className = 'enhanced-current-position-marker';
                currentPositionMarker.innerHTML = '<i class="fas fa-map-marker-alt"></i>';
                
                // Adjust the position of the current marker to match the progress fill
                const adjustedProgressPosition = (progressPercentage * usableWidth / 100) + paddingPercentage;
                currentPositionMarker.style.left = `${adjustedProgressPosition}%`;
                
                timelineContainer.appendChild(currentPositionMarker);
            } catch (markerError) {
                console.warn('Error adding current position marker:', markerError);
            }
        }
        
        // Removed the milestone labels below the timeline as requested
    } catch (error) {
        console.error('Error rendering timeline visualization:', error);
        const container = document.getElementById('timeline-visual-container');
        if (container) {
            container.innerHTML = '<div class="text-center py-4 text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error rendering timeline</div>';
        }
    }
}

// Function to show the timeline status modal
function showTimelineStatusModal(mentorshipId) {
    // Show timeline status modal
    var statusModal = document.getElementById('timelineStatusModal');
    var modal = bootstrap.Modal.getInstance(statusModal) || new bootstrap.Modal(statusModal);
    document.getElementById('mentorshipIdForStatus').value = mentorshipId;
    
    // Fetch timeline milestones
    fetch(`/mentorship/api/requests/${mentorshipId}/`, {
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        loadTimelineMilestones(data.timeline_milestones, mentorshipId);
        modal.show();
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Failed to fetch timeline data. Please try again.');
        modal.show(); // Show modal anyway
    });
}

// Function to load timeline milestones
function loadTimelineMilestones(timelineText, mentorshipId) {
    const container = document.getElementById('milestone-status-container');
    const noMilestonesMessage = document.getElementById('no-milestones-message');
    
    // Clear existing content
    container.innerHTML = '';
    
    if (!timelineText) {
        container.appendChild(noMilestonesMessage);
        return;
    }
    
    // Parse the timeline text to extract milestones
    const lines = timelineText.split('\n');
    let milestones = [];
    let inAdditionalNotes = false;
    
    lines.forEach(line => {
        line = line.trim();
        if (!line) return;
        
        if (line.startsWith('Additional Notes:')) {
            inAdditionalNotes = true;
            return;
        }
        
        if (inAdditionalNotes) {
            return;
        }
        
        const weekDayMatch = line.match(/^Week\/Day\s+([^:]+):\s*(.+)$/);
        if (weekDayMatch) {
            const period = weekDayMatch[1];
            const description = weekDayMatch[2];
            
            // Extract status if available
            let status = 'NOT_STARTED';
            const statusMatch = description.match(/(.+)\s+\[([A-Z_]+)\]$/);
            const cleanDescription = statusMatch ? statusMatch[1].trim() : description;
            if (statusMatch) {
                status = statusMatch[2];
            }
            
            milestones.push({
                period: period,
                description: cleanDescription,
                status: status
            });
        }
    });
    
    if (milestones.length === 0) {
        container.appendChild(noMilestonesMessage);
        return;
    }
    
    // Create milestone status items
    milestones.forEach(milestone => {
        const statusItem = document.createElement('div');
        statusItem.className = 'milestone-status-item';
        
        statusItem.innerHTML = `
            <div class="milestone-title">Week/Day ${milestone.period}</div>
            <div class="milestone-description">${milestone.description}</div>
            <div class="form-group">
                <label class="form-label">Status</label>
                <select class="form-select milestone-status" data-period="${milestone.period}" data-description="${milestone.description}">
                    <option value="NOT_STARTED" ${milestone.status === 'NOT_STARTED' ? 'selected' : ''}>Not Started</option>
                    <option value="IN_PROGRESS" ${milestone.status === 'IN_PROGRESS' ? 'selected' : ''}>In Progress</option>
                    <option value="COMPLETED" ${milestone.status === 'COMPLETED' ? 'selected' : ''}>Completed</option>
                </select>
            </div>
        `;
        
        container.appendChild(statusItem);
    });
    
    // Also update the enhanced timeline display
    updateEnhancedTimelineDisplay(mentorshipId, milestones);
}

// Function to save timeline status
function saveTimelineStatus() {
    const mentorshipId = document.getElementById('mentorshipIdForStatus').value;
    
    // Collect milestone status updates
    const milestoneStatuses = [];
    document.querySelectorAll('.milestone-status').forEach(dropdown => {
        milestoneStatuses.push({
            period: dropdown.getAttribute('data-period'),
            description: dropdown.getAttribute('data-description'),
            status: dropdown.value
        });
    });
    
    // Update milestone statuses
    fetch('/mentorship/api/milestones/update_batch/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            mentorship: mentorshipId,
            milestones: milestoneStatuses
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to update milestone statuses');
        }
        return response.json();
    })
    .then(data => {
        // Then update the timeline text with status
        return fetch(`/mentorship/api/requests/${mentorshipId}/update_timeline/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                update_milestones_in_timeline: true,
                milestone_statuses: milestoneStatuses
            })
        });
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to update timeline');
        }
        return response.json();
    })
    .then(data => {
        var statusModal = document.getElementById('timelineStatusModal');
        var modal = bootstrap.Modal.getInstance(statusModal);
        if (modal) modal.hide();
        
        showToast('success', 'Timeline status updated successfully');
        setTimeout(() => location.reload(), 1500);
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Failed to update timeline status. Please try again.');
    });
}

// Function to update the enhanced timeline display
function updateEnhancedTimelineDisplay(mentorshipId, milestones) {
    const timelineContainer = document.getElementById(`timeline-milestones-${mentorshipId}`);
    if (!timelineContainer) return;
    
    // Clear existing content
    timelineContainer.innerHTML = '';
    
    // Sort milestones by period
    milestones.sort((a, b) => {
        const periodA = a.period.includes('-') ? 
            parseInt(a.period.split('-')[0]) : parseInt(a.period);
        const periodB = b.period.includes('-') ? 
            parseInt(b.period.split('-')[0]) : parseInt(b.period);
        return periodA - periodB;
    });
    
    // Create milestone cards
    milestones.forEach((milestone, index) => {
        const milestoneElement = document.createElement('div');
        milestoneElement.className = 'timeline-milestone';
        
        // Extract topics from description (if any)
        let description = milestone.description;
        let topics = [];
        
        // Check if description contains topics (bullet points)
        if (description.includes('')) {
            const parts = description.split('');
            description = parts[0].trim();
            topics = parts.slice(1).map(topic => topic.trim()).filter(topic => topic);
        }
        
        // Determine status class
        const statusClass = milestone.status.toLowerCase().replace('_', '-');
        
        // Create milestone card
        milestoneElement.innerHTML = `
            <div class="timeline-milestone-card">
                <div class="timeline-milestone-header ${statusClass}">
                    <span>Week/Day ${milestone.period}</span>
                    <span>${milestone.status === 'COMPLETED' ? 'Completed' : 
                           milestone.status === 'IN_PROGRESS' ? 'In Progress' : 'Not Started'}</span>
                </div>
                <div class="timeline-milestone-title">${description}</div>
                ${topics.length > 0 ? `
                <div class="timeline-milestone-topics">
                    <div class="timeline-milestone-topics-title">Topics/Activities:</div>
                    <ul>
                        ${topics.map(topic => `<li>${topic}</li>`).join('')}
                    </ul>
                </div>
                ` : ''}
                <select class="timeline-milestone-status-select" 
                        data-period="${milestone.period}" 
                        data-description="${milestone.description}"
                        onchange="updateMilestoneStatus(this, '${mentorshipId}')">
                    <option value="NOT_STARTED" ${milestone.status === 'NOT_STARTED' ? 'selected' : ''}>Not Started</option>
                    <option value="IN_PROGRESS" ${milestone.status === 'IN_PROGRESS' ? 'selected' : ''}>In Progress</option>
                    <option value="COMPLETED" ${milestone.status === 'COMPLETED' ? 'selected' : ''}>Completed</option>
                </select>
            </div>
            <div class="timeline-milestone-dot ${statusClass}"></div>
        `;
        
        timelineContainer.appendChild(milestoneElement);
    });
}

// Function to update a single milestone status directly from the timeline
function updateMilestoneStatus(selectElement, mentorshipId) {
    const period = selectElement.getAttribute('data-period');
    const description = selectElement.getAttribute('data-description');
    const status = selectElement.value;
    
    // Update milestone status
    fetch('/mentorship/api/milestones/update_batch/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            mentorship: mentorshipId,
            milestones: [{
                period: period,
                description: description,
                status: status
            }]
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to update milestone status');
        }
        return response.json();
    })
    .then(data => {
        // Then update the timeline text with status
        return fetch(`/mentorship/api/requests/${mentorshipId}/update_timeline/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                update_milestones_in_timeline: true,
                milestone_statuses: [{
                    period: period,
                    description: description,
                    status: status
                }]
            })
        });
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to update timeline');
        }
        return response.json();
    })
    .then(data => {
        showToast('success', 'Milestone status updated');
        
        // Update the UI without reloading
        const card = selectElement.closest('.timeline-milestone-card');
        const header = card.querySelector('.timeline-milestone-header');
        const dot = selectElement.closest('.timeline-milestone').querySelector('.timeline-milestone-dot');
        
        // Update status classes
        header.className = 'timeline-milestone-header';
        dot.className = 'timeline-milestone-dot';
        
        const statusClass = status.toLowerCase().replace('_', '-');
        header.classList.add(statusClass);
        dot.classList.add(statusClass);
        
        // Update status text
        const statusText = status === 'COMPLETED' ? 'Completed' : 
                          status === 'IN_PROGRESS' ? 'In Progress' : 'Not Started';
        header.querySelector('span:last-child').textContent = statusText;
        
        // Calculate new progress percentage
        calculateProgressPercentage(mentorshipId);
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Failed to update milestone status');
        
        // Reset the select to its previous value
        selectElement.value = selectElement.getAttribute('data-previous-value');
    });
    
    // Store the current value for potential rollback
    selectElement.setAttribute('data-previous-value', status);
}

// Function to calculate progress percentage based on milestone statuses
function calculateProgressPercentage(mentorshipId) {
    // Get all milestone status selects
    const selects = document.querySelectorAll(`#timeline-milestones-${mentorshipId} .timeline-milestone-status-select`);
    if (selects.length === 0) return;
    
    // Count completed and in-progress milestones
    let completed = 0;
    let inProgress = 0;
    
    selects.forEach(select => {
        if (select.value === 'COMPLETED') {
            completed++;
        } else if (select.value === 'IN_PROGRESS') {
            inProgress++;
        }
    });
    
    // Calculate percentage (completed + half of in-progress)
    const total = selects.length;
    const percentage = Math.round((completed + (inProgress * 0.5)) / total * 100);
    
    // Update progress bar
    const progressBar = document.querySelector(`#mentorship${mentorshipId} .progress-bar`);
    if (progressBar) {
        progressBar.style.width = `${percentage}%`;
        progressBar.setAttribute('aria-valuenow', percentage);
        progressBar.textContent = `${percentage}%`;
        
        // Step-progress-bar update code removed as requested
        
        // Also update the progress percentage on the server
        fetch(`/mentorship/api/requests/${mentorshipId}/update_timeline/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                progress_percentage: percentage
            })
        })
        .catch(error => {
            console.error('Error updating progress percentage:', error);
        });
    }
}

// Function to toggle timeline text view
function toggleTimelineText(mentorshipId) {
    const timelineText = document.querySelector(`#mentorship${mentorshipId} .timeline-text`);
    const toggleButton = document.querySelector(`#toggle-text-${mentorshipId}`);
    
    if (timelineText.style.display === 'none') {
        timelineText.style.display = 'block';
        toggleButton.textContent = 'Hide Text View';
    } else {
        timelineText.style.display = 'none';
        toggleButton.textContent = 'Show Text View';
    }
}

// Initialize enhanced timeline displays when the DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // ... existing code ...
    
    // Initialize enhanced timeline displays
    document.querySelectorAll('.timeline-container').forEach(container => {
        const mentorshipId = container.closest('.accordion-collapse').id.replace('mentorship-', '');
        const timelineText = container.querySelector('.timeline-text').textContent;
        
        if (timelineText) {
            // Parse the timeline text to extract milestones
            const lines = timelineText.split('\n');
            let milestones = [];
            let inAdditionalNotes = false;
            
            lines.forEach(line => {
                line = line.trim();
                if (!line) return;
                
                if (line.startsWith('Additional Notes:')) {
                    inAdditionalNotes = true;
                    return;
                }
                
                if (inAdditionalNotes) {
                    return;
                }
                
                const weekDayMatch = line.match(/^Week\/Day\s+([^:]+):\s*(.+)$/);
                if (weekDayMatch) {
                    const period = weekDayMatch[1];
                    const description = weekDayMatch[2];
                    
                    // Extract status if available
                    let status = 'NOT_STARTED';
                    const statusMatch = description.match(/(.+)\s+\[([A-Z_]+)\]$/);
                    const cleanDescription = statusMatch ? statusMatch[1].trim() : description;
                    if (statusMatch) {
                        status = statusMatch[2];
                    }
                    
                    milestones.push({
                        period: period,
                        description: cleanDescription,
                        status: status
                    });
                }
            });
            
            // Update the enhanced timeline display
            updateEnhancedTimelineDisplay(mentorshipId, milestones);
        }
    });
});

// Function to show progress details modal
function showProgressDetails(mentorshipId) {
    try {
        // Validate mentorshipId
        if (!mentorshipId || mentorshipId === '') {
            console.error('Invalid mentorship ID');
            showToast('error', 'Error loading progress details: Invalid mentorship ID');
            return;
        }
        
        // Show progress details modal
        var progressDetailsModal = document.getElementById('progressDetailsModal');
        if (!progressDetailsModal) {
            console.error('Progress details modal element not found');
            showToast('error', 'Error loading progress details: Modal not found');
            return;
        }
        
        var modal = bootstrap.Modal.getInstance(progressDetailsModal) || new bootstrap.Modal(progressDetailsModal);
        
        // Log the mentorship ID to help with debugging
        console.log('Fetching details for mentorship ID:', mentorshipId);
        
        // Fetch mentorship data
        fetch(`/mentorship/api/requests/${mentorshipId}/`, {
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            if (!response.ok) {
                // More detailed error handling
                if (response.status === 404) {
                    throw new Error('Mentorship not found. It may have been deleted or you may not have access.');
                } else if (response.status === 403) {
                    throw new Error('Permission denied. You do not have access to this mentorship.');
                } else if (response.status >= 500) {
                    throw new Error('Server error. Please try again later.');
                } else {
                    // Try to get more details from the response if possible
                    return response.json()
                        .then(errData => {
                            throw new Error(errData.detail || errData.message || `Network response error: ${response.status} ${response.statusText}`);
                        })
                        .catch(jsonErr => {
                            // If we can't parse the JSON, just use the status
                            throw new Error(`Network response error: ${response.status} ${response.statusText}`);
                        });
                }
            }
            return response.json();
        })
        .then(data => {
            // Update the modal content with the fetched data
            const modalBody = document.getElementById('progressDetailsModalBody');
            modalBody.innerHTML = `
                <p><strong>Mentorship ID:</strong> ${data.id}</p>
                <p><strong>Mentor:</strong> ${data.mentor.full_name}</p>
                <p><strong>Mentee:</strong> ${data.mentee.full_name}</p>
                <p><strong>Status:</strong> ${data.status}</p>
                <p><strong>Progress:</strong> ${data.progress_percentage}%</p>
                <p><strong>Start Date:</strong> ${data.start_date}</p>
                <p><strong>End Date:</strong> ${data.end_date}</p>
                <p><strong>Additional Notes:</strong> ${data.additional_notes || 'None'}</p>
            `;
            
            // Show the modal
            modal.show();
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('error', 'Failed to load progress details. Please try again.');
        });
    } catch (error) {
        console.error('Error:', error);
        showToast('error', 'An unexpected error occurred. Please try again.');
    }
}

// Function to handle schedule meeting form submission
function submitScheduleMeeting(event) {
    event.preventDefault();
    
    const mentorshipId = document.getElementById('mentorshipIdInput').value;
    const meetingTitle = document.getElementById('meetingTitle').value;
    const meetingDate = document.getElementById('meetingDate').value;
    const meetingLink = document.getElementById('meetingLink').value;
    const meetingAgenda = document.getElementById('meetingAgenda').value;
    
    // Validate required fields
    if (!mentorshipId || !meetingTitle || !meetingDate || !meetingAgenda) {
        showToast('error', 'Please fill out all required fields.');
        return;
    }
    
    // Create form data
    const formData = {
        mentorship: mentorshipId,
        title: meetingTitle,
        meeting_date: meetingDate,
        meeting_link: meetingLink,
        description: meetingAgenda,
        status: 'SCHEDULED'
    };
    
    // Submit using fetch API
    fetch('/mentorship/api/meetings/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to schedule meeting');
        }
        return response.json();
    })
    .then(data => {
        // Close the modal
        const scheduleMeetingModal = document.getElementById('scheduleMeetingModal');
        const modal = bootstrap.Modal.getInstance(scheduleMeetingModal);
        if (modal) modal.hide();
        
        // Show success message
        showToast('success', 'Meeting scheduled successfully!');
        
        // Reload the page after a short delay
        setTimeout(() => location.reload(), 1500);
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Failed to schedule meeting. Please try again.');
    });
}

{% extends "base.html" %}
{% load static %}
{% load mentorship_extras %}

{% block title %}Mentor Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/mentorship.css' %}">
<style>
    /* Dashboard Layout */
    .dashboard-container {
        padding: 2rem;
        width: 100%;
        max-width: 100%;
        margin: 0 auto;
    }
    
    /* Gradient Backgrounds */
    .bg-gradient-primary {
        background: linear-gradient(45deg, #4e73df 0%, #224abe 100%);
    }

    .bg-gradient-success {
        background: linear-gradient(45deg, #1cc88a 0%, #13855c 100%);
    }

    .bg-gradient-info {
        background: linear-gradient(45deg, #36b9cc 0%, #258391 100%);
    }

    .bg-gradient-warning {
        background: linear-gradient(45deg, #f6c23e 0%, #dda20a 100%);
    }
    
    /* Card Enhancements */
    .card {
        border: none;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        transition: transform 0.2s ease-in-out;
    }
    
    .card:hover {
        transform: translateY(-3px);
    }

    /* Stats Card Icons */
    .stats-icon {
        width: 3rem;
        height: 3rem;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
    }

    /* Mentorship Item Styles */
    .mentorship-item {
        border: none;
        margin-bottom: 1rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }

    .mentorship-item .accordion-button {
        padding: 1rem;
        background: #fff;
        border: none;
    }

    .mentorship-item .accordion-button:not(.collapsed) {
        background: #f8f9fa;
        color: #4e73df;
    }

    .mentorship-title {
        font-weight: 600;
        color: #5a5c69;
    }

    /* Progress Bars */
    .progress {
        height: 1rem;
        border-radius: 0.5rem;
        background-color: #eaecf4;
    }
    
    .progress-bar {
        border-radius: 0.5rem;
    }

    /* Timeline Styles */
    .timeline-visualization {
        padding: 1.5rem;
        background: #f8f9fa;
        border-radius: 0.5rem;
    }

    /* Buttons */
    .btn {
        padding: 0.375rem 1rem;
        font-weight: 500;
        border-radius: 0.5rem;
    }
    
    .btn-primary {
        background-color: #4e73df;
        border-color: #4e73df;
    }
    
    .btn-primary:hover {
        background-color: #2e59d9;
        border-color: #2653d4;
    }
    
    /* Badges */
    .badge {
        padding: 0.5em 0.75em;
        font-weight: 500;
        border-radius: 0.5rem;
    }

    /* Form Elements */
    .form-check-input:checked {
        background-color: #4e73df;
        border-color: #4e73df;
    }
    
    /* Responsive Adjustments */
    @media (max-width: 768px) {
        .dashboard-container {
            padding: 1rem;
        }

        .card {
            margin-bottom: 1rem;
        }
    }
    
    /* Enhanced Timeline Visualization Styles */
    .enhanced-timeline-container {
        height: 120px;
        padding: 15px 30px; /* Increased horizontal padding */
        position: relative;
        margin: 30px 0;
        overflow: visible;
    }

    .enhanced-timeline-line {
        position: absolute;
        height: 6px;
        background-color: #e9ecef;
        top: 50%;
        transform: translateY(-50%);
        z-index: 1;
        left: 0;
        right: 0;
        border-radius: 3px;
    }

    .enhanced-timeline-progress-fill {
        position: absolute;
        height: 6px;
        background: linear-gradient(90deg, #4e73df 0%, #36b9cc 100%);
        top: 50%;
        transform: translateY(-50%);
        z-index: 2;
        left: 0;
        width: 0%;
        transition: width 1s ease;
        border-radius: 3px;
        box-shadow: 0 0 10px rgba(78, 115, 223, 0.5);
    }

    .enhanced-milestone-marker-wrapper {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        z-index: 3;
        cursor: pointer;
    }

    .enhanced-milestone-marker {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
        transition: all 0.3s ease;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        position: relative;
    }

    .enhanced-milestone-marker.not-started {
        background-color: #6c757d;
        border: 2px solid #fff;
    }

    .enhanced-milestone-marker.in-progress {
        background-color: #f6c23e;
        border: 2px solid #fff;
    }

    .enhanced-milestone-marker.completed {
        background-color: #1cc88a;
        border: 2px solid #fff;
    }

    .enhanced-milestone-marker:hover {
        transform: scale(1.2);
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }

    .enhanced-milestone-labels {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        margin-top: 10px;
    }

    .enhanced-milestone-label {
        position: absolute;
        transform: translateX(-50%);
        font-size: 0.8rem;
        color: #495057;
        text-align: center;
        max-width: 100px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .enhanced-milestone-tooltip {
        position: absolute;
        bottom: 45px;
        left: 50%;
        transform: translateX(-50%) scale(0.9);
        background-color: white;
        color: #333;
        padding: 0;
        border-radius: 8px;
        font-size: 0.85rem;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        z-index: 1000;
        width: 220px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        pointer-events: none;
        border: 1px solid rgba(0,0,0,0.1);
        /* Ensure tooltip doesn't go off-screen */
        max-width: 90vw;
    }

    /* Adjust tooltip position for edge milestones */
    .enhanced-milestone-marker-wrapper:first-child .enhanced-milestone-tooltip {
        transform: translateX(-20%) scale(0.9);
    }
    
    .enhanced-milestone-marker-wrapper:first-child:hover .enhanced-milestone-tooltip {
        transform: translateX(-20%) scale(1);
    }
    
    .enhanced-milestone-marker-wrapper:last-child .enhanced-milestone-tooltip {
        transform: translateX(-80%) scale(0.9);
    }
    
    .enhanced-milestone-marker-wrapper:last-child:hover .enhanced-milestone-tooltip {
        transform: translateX(-80%) scale(1);
    }

    .enhanced-milestone-tooltip::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -8px;
        border-width: 8px;
        border-style: solid;
        border-color: white transparent transparent transparent;
    }
    
    /* Adjust arrow position for edge milestones */
    .enhanced-milestone-marker-wrapper:first-child .enhanced-milestone-tooltip::after {
        left: 20%;
    }
    
    .enhanced-milestone-marker-wrapper:last-child .enhanced-milestone-tooltip::after {
        left: 80%;
    }

    .enhanced-milestone-marker-wrapper:hover .enhanced-milestone-tooltip {
        opacity: 1;
        visibility: visible;
        transform: translateX(-50%) scale(1);
    }

    .tooltip-header {
        padding: 8px 12px;
        border-bottom: 1px solid rgba(0,0,0,0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #f8f9fa;
        border-radius: 8px 8px 0 0;
    }

    .tooltip-title {
        font-weight: bold;
        color: #495057;
    }

    .tooltip-status {
        font-size: 0.75rem;
        padding: 2px 6px;
        border-radius: 12px;
        font-weight: bold;
    }

    .tooltip-status.not-started {
        background-color: #e9ecef;
        color: #495057;
    }

    .tooltip-status.in-progress {
        background-color: #fff3cd;
        color: #856404;
    }

    .tooltip-status.completed {
        background-color: #d4edda;
        color: #155724;
    }

    .tooltip-body {
        padding: 10px 12px;
        line-height: 1.4;
    }

    .enhanced-current-position-marker {
        position: absolute;
        top: 0;
        transform: translateX(-50%);
        color: #e74a3b;
        font-size: 1.5rem;
        z-index: 4;
        filter: drop-shadow(0 2px 3px rgba(0,0,0,0.3));
        animation: bounce 2s infinite;
    }

    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% {
            transform: translateX(-50%) translateY(0);
        }
        40% {
            transform: translateX(-50%) translateY(-10px);
        }
        60% {
            transform: translateX(-50%) translateY(-5px);
        }
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .enhanced-timeline-container {
            height: 150px;
            margin: 40px 0;
            padding: 15px 20px;
        }
        
        .enhanced-milestone-label {
            font-size: 0.7rem;
        }
        
        .enhanced-milestone-tooltip {
            width: 180px;
        }
    }

    .timeline-visual-container {
        height: 150px;
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 15px 30px; /* Increased horizontal padding */
        position: relative;
        overflow: visible;
        margin: 15px 0 45px; /* Increased bottom margin to accommodate labels */
        border: 1px solid rgba(0,0,0,0.05);
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    /* Progress Bar Styles */
    .progress {
        cursor: pointer;
        transition: all 0.3s ease;
        overflow: visible;
    }

    .progress:hover {
        box-shadow: 0 0 10px rgba(0,123,255,0.5);
    }

    .progress-bar {
        position: relative;
    }

    /* Progress Tooltip */
    .progress-tooltip {
        position: absolute;
        top: -40px;
        right: 0;
        background-color: #343a40;
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.8rem;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
        z-index: 1000;
        white-space: nowrap;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .progress-tooltip::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: #343a40 transparent transparent transparent;
    }

    .progress:hover .progress-tooltip {
        opacity: 1;
        visibility: visible;
    }

    /* Progress Details Modal Styles */
    .progress-lg {
        height: 25px !important;
        border-radius: 15px;
        overflow: hidden;
    }

    .progress-lg .progress-bar {
        line-height: 25px;
        font-weight: bold;
    }

    .progress-stat-card {
        transition: all 0.3s ease;
        border: 1px solid #dee2e6;
    }

    .progress-stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .stat-value {
        font-size: 1.8rem;
        font-weight: bold;
    }
    
    .milestone-marker {
        position: absolute;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        transition: all 0.3s ease;
        z-index: 2;
    }

    .milestone-marker.not-started {
        background-color: #6c757d;
        border: 2px solid #fff;
    }

    .milestone-marker.in-progress {
        background-color: #ffc107;
        border: 2px solid #fff;
    }
    
    .milestone-marker.completed {
        background-color: #28a745;
        border: 2px solid #fff;
    }

    .milestone-marker:hover {
        transform: translateY(-50%) scale(1.2);
        box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }

    .milestone-line {
        position: absolute;
        height: 4px;
        background-color: #dee2e6;
        top: 50%;
        transform: translateY(-50%);
        z-index: 1;
        left: 0;
        right: 0;
    }

    .milestone-progress-fill {
        position: absolute;
        height: 4px;
        background: linear-gradient(90deg, #4481eb 0%, #04befe 100%);
        top: 50%;
        transform: translateY(-50%);
        z-index: 1;
        left: 0;
        width: 0%;
        transition: width 1s ease;
    }

    .milestone-tooltip {
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background-color: #343a40;
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.8rem;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
        z-index: 1000;
        white-space: nowrap;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        pointer-events: none;
    }

    .milestone-tooltip::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: #343a40 transparent transparent transparent;
    }

    .milestone-marker:hover .milestone-tooltip {
        opacity: 1;
        visibility: visible;
    }

    .timeline-status-badge {
        display: inline-block;
        padding: 0.25em 0.6em;
        font-size: 0.75em;
        font-weight: 700;
        line-height: 1;
        text-align: center;
        white-space: nowrap;
        vertical-align: baseline;
        border-radius: 0.25rem;
    }

    .timeline-status-badge.not-started {
        background-color: #6c757d;
        color: white;
    }

    .timeline-status-badge.in-progress {
        background-color: #ffc107;
        color: #212529;
    }

    .timeline-status-badge.completed {
        background-color: #28a745;
        color: white;
    }

    /* Loading indicator styles */
    .loading-spinner-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 38px; /* Standard height of a form-select element */
        background-color: rgba(255, 255, 255, 0.8);
        border-radius: 0.25rem;
    }

    /* Success and error highlight styles for form elements */
    .border-success {
        border-color: #28a745 !important;
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25) !important;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    .border-danger {
        border-color: #dc3545 !important;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
{% csrf_token %}
    <!-- Dashboard Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="d-flex align-items-center">
                {% if mentor.user.profile.avatar %}
                    <img src="{{ mentor.user.profile.avatar.url }}" alt="{{ mentor.user.get_full_name }}" class="rounded-circle me-3" style="width: 60px; height: 60px; object-fit: cover;">
                {% else %}
                    <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-3" style="width: 60px; height: 60px;">
                        <i class="fas fa-user fa-2x"></i>
                </div>
                {% endif %}
                <div>
                    <h2 class="mb-0">Welcome back, {{ mentor.user.get_full_name }}</h2>
                    <p class="text-muted mb-0">
                        <i class="fas fa-map-marker-alt me-1"></i> {{ mentor.user.profile.location|default:"Location not set" }}
                        {% if mentor.user.profile.current_position %}
                            <span class="mx-2">|</span>
                            <i class="fas fa-briefcase me-1"></i> {{ mentor.user.profile.current_position }}
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
        <div class="col-md-4 text-end d-flex align-items-center justify-content-end">
            <div class="me-3">
                <!-- Availability Toggle -->
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="availabilityToggle"
                           {% if mentor.accepting_mentees %}checked{% endif %}
                           data-mentor-id="{{ mentor.id }}"
                           onchange="toggleAvailability()">
                    <label class="form-check-label" for="availabilityToggle">
                        Accepting New Mentees
                    </label>
                </div>
            </div>
            <a href="{% url 'accounts:profile_detail' mentor.user.username %}" class="btn btn-outline-primary">
                <i class="fas fa-user-edit me-1"></i> Edit Profile
            </a>
        </div>
        </div>

        <!-- Stats Overview -->
    <div class="row mb-4">
            <div class="col-md-3">
            <div class="card bg-gradient-primary text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="rounded-circle bg-white bg-opacity-25 p-3">
                            <i class="fas fa-users fa-2x text-white"></i>
                        </div>
                        <h2 class="mb-0">{{ total_active_mentees }}</h2>
                    </div>
                    <h5 class="card-title mb-0">Active Mentees</h5>
                    <div class="progress bg-white bg-opacity-25 mt-3" style="height: 5px;">
                        <div class="progress-bar bg-white" style="width: {{ total_active_mentees|default:0|multiply:20 }}%"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
            <div class="card bg-gradient-warning text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="rounded-circle bg-white bg-opacity-25 p-3">
                            <i class="fas fa-clock fa-2x text-white"></i>
                        </div>
                        <h2 class="mb-0">{{ total_pending_requests }}</h2>
                    </div>
                    <h5 class="card-title mb-0">Pending Requests</h5>
                    <div class="progress bg-white bg-opacity-25 mt-3" style="height: 5px;">
                        <div class="progress-bar bg-white" style="width: {{ total_pending_requests|default:0|multiply:20 }}%"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
            <div class="card bg-gradient-info text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="rounded-circle bg-white bg-opacity-25 p-3">
                            <i class="fas fa-calendar-check fa-2x text-white"></i>
                        </div>
                        <h2 class="mb-0">{{ upcoming_meetings.count }}</h2>
                    </div>
                    <h5 class="card-title mb-0">Upcoming Meetings</h5>
                    <div class="progress bg-white bg-opacity-25 mt-3" style="height: 5px;">
                        <div class="progress-bar bg-white" style="width: {{ upcoming_meetings.count|default:0|multiply:20 }}%"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
            <div class="card bg-gradient-success text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="rounded-circle bg-white bg-opacity-25 p-3">
                            <i class="fas fa-envelope fa-2x text-white"></i>
                        </div>
                        <h2 class="mb-0">{{ unread_messages }}</h2>
                    </div>
                    <h5 class="card-title mb-0">Unread Messages</h5>
                    <div class="progress bg-white bg-opacity-25 mt-3" style="height: 5px;">
                        <div class="progress-bar bg-white" style="width: {{ unread_messages|default:0|multiply:20 }}%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="row">
            <!-- Left Column -->
            <div class="col-md-8">
                <!-- Pending Requests -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Pending Requests</h5>
                        {% if pending_requests %}
                        <span class="badge bg-warning">{{ pending_requests|length }}</span>
                        {% endif %}
                    </div>
                    <div class="card-body">
                    {% if pending_requests %}
                        <div class="list-group">
                        {% for request in pending_requests %}
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">{{ request.mentee.get_full_name }}</h6>
                                <small>{{ request.created_at|timesince }} ago</small>
                            </div>
                                <p class="mb-1">{{ request.message|truncatewords:30 }}</p>
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-success" onclick="updateStatus('{{ request.id }}', 'APPROVED')">
                                        Accept
                                </button>
                                    <button class="btn btn-sm btn-danger" onclick="updateStatus('{{ request.id }}', 'REJECTED')">
                                        Decline
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-muted">No pending requests</p>
                    {% endif %}
                </div>
            </div>

            <!-- Active Mentorships -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Active Mentorships</h5>
                </div>
                <div class="card-body">
                {% if active_mentorships %}
                    <div class="active-mentorships">
                    <div class="accordion" id="mentorshipAccordion">
                    {% for mentorship in active_mentorships %}
                            <div class="accordion-item mentorship-item" data-mentorship-id="{{ mentorship.id }}">
                            <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#mentorship-{{ mentorship.id }}" aria-expanded="false" aria-controls="mentorship-{{ mentorship.id }}">
                                        <span class="mentorship-title">{{ mentorship.mentee.get_full_name }}</span>
                                        <span class="badge bg-primary ms-2">{{ mentorship.get_status_display }}</span>
                                </button>
                            </h2>
                                <div id="mentorship-{{ mentorship.id }}" class="accordion-collapse collapse" data-bs-parent="#mentorshipAccordion">
                                    <div class="accordion-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                            <h6>Goals</h6>
                                            <ul class="list-unstyled">
                                                {% for goal in mentorship.mentorship_goals.all %}
                                                <li>
                                                    <i class="fas fa-check-circle text-{{ goal.status|lower }}"></i>
                                                    {{ goal.title }}
                                                </li>
                                                {% endfor %}
                                            </ul>
                                                    </div>
                                        <div class="col-md-6">
                                            <h6>Skills Progress</h6>
                                            {% for skill in mentorship.skill_progress.all %}
                                            <div class="mb-2">
                                                <small>{{ skill.skill_name }}</small>
                                                <div class="progress">
                                                        <div class="progress-bar progress-bar-skill-{{ forloop.counter }}" 
                                                             role="progressbar"
                                                        aria-valuemin="0"
                                                             aria-valuemax="100"
                                                             data-skill-proficiency="{{ skill.current_proficiency }}">
                                                        {{ skill.get_current_proficiency_display }}
                                                </div>
                                                    </div>
                                                        </div>
                    {% endfor %}
                                                    </div>
                                                </div>
                                    
                                    {% if mentorship.timeline_milestones %}
                                    <div class="mt-3">
                                        <h6>Timeline</h6>
                                            <div class="progress mb-2" style="height: 20px; cursor: pointer;" onclick="showProgressDetails('{{ mentorship.id }}')">
                                                <div class="progress-bar bg-success progress-bar-mentorship-{{ mentorship.id }}" 
                                                     role="progressbar"
                                                         aria-valuemin="0" 
                                                     aria-valuemax="100"
                                                     data-percentage="{{ mentorship.progress_percentage }}">
                                                        {{ mentorship.progress_percentage }}%
                                            </div>
                                                                        </div>
                                                
                                            <!-- Step-Based Progress Tracker removed as requested -->
                                                
                                            <div class="d-flex mt-3">
                                                <button class="btn btn-sm btn-primary me-2" onclick="showProgressDetails('{{ mentorship.id }}')">
                                                    <i class="fas fa-chart-line me-1"></i> View Progress
                                                </button>
                                                <!-- Update Status button removed as requested -->
                                                <button class="btn btn-sm btn-secondary" onclick="setTimeline('{{ mentorship.id }}')">
                                                    <i class="fas fa-calendar-alt me-1"></i> Set Timeline
                                                </button>
                                                <div class="dropdown ms-2">
                                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="mentorshipStatusDropdown{{ mentorship.id }}" data-bs-toggle="dropdown" aria-expanded="false">
                                                        <i class="fas fa-cog me-1"></i> Manage
                                                    </button>
                                                    <ul class="dropdown-menu" aria-labelledby="mentorshipStatusDropdown{{ mentorship.id }}">
                                                        {% if mentorship.status == 'PAUSED' %}
                                                        <li><a class="dropdown-item" href="#" onclick="updateMentorshipStatus('{{ mentorship.id }}', 'APPROVED')"><i class="fas fa-play me-2"></i> Resume Mentorship</a></li>
                                                        {% else %}
                                                        <li><a class="dropdown-item" href="#" onclick="updateMentorshipStatus('{{ mentorship.id }}', 'PAUSED')"><i class="fas fa-pause me-2"></i> Pause Mentorship</a></li>
                                                                        {% endif %}
                                                        <li><a class="dropdown-item" href="#" onclick="updateMentorshipStatus('{{ mentorship.id }}', 'COMPLETED')"><i class="fas fa-check-circle me-2"></i> Complete Mentorship</a></li>
                                                        <li><a class="dropdown-item" href="#" onclick="updateMentorshipStatus('{{ mentorship.id }}', 'CANCELLED')"><i class="fas fa-times-circle me-2"></i> Cancel Mentorship</a></li>
                                                    </ul>
                                                                    </div>
                                                                </div>
                                            
                                            <!-- Hidden timeline text for data storage -->
                                            <pre class="mb-0 small timeline-text" style="display: none;">{{ mentorship.timeline_milestones }}</pre>
                                                            </div>
                                                        {% else %}
                                    <div class="mt-3">
                                        <h6>Timeline</h6>
                                            <div class="progress mb-2" style="height: 20px;">
                                                <div class="progress-bar bg-secondary" role="progressbar" 
                                                     style="width: 0%" 
                                                     aria-valuenow="0" 
                                                     aria-valuemin="0" 
                                                     aria-valuemax="100">
                                                    0%
                                                    </div>
                                                </div>
                                            <div class="d-flex">
                                                <button class="btn btn-sm btn-success me-2" onclick="updateProgress('{{ mentorship.id }}')">
                                                        <i class="fas fa-chart-line me-1"></i> Update Progress
                                                </button>
                                                <button class="btn btn-sm btn-secondary" onclick="setTimeline('{{ mentorship.id }}')">
                                                    <i class="fas fa-calendar-alt me-1"></i> Set Timeline
                                                </button>
                                                <div class="dropdown ms-2">
                                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="mentorshipStatusDropdown{{ mentorship.id }}" data-bs-toggle="dropdown" aria-expanded="false">
                                                        <i class="fas fa-cog me-1"></i> Manage
                                                    </button>
                                                    <ul class="dropdown-menu" aria-labelledby="mentorshipStatusDropdown{{ mentorship.id }}">
                                                        {% if mentorship.status == 'PAUSED' %}
                                                        <li><a class="dropdown-item" href="#" onclick="updateMentorshipStatus('{{ mentorship.id }}', 'APPROVED')"><i class="fas fa-play me-2"></i> Resume Mentorship</a></li>
                                                        {% else %}
                                                        <li><a class="dropdown-item" href="#" onclick="updateMentorshipStatus('{{ mentorship.id }}', 'PAUSED')"><i class="fas fa-pause me-2"></i> Pause Mentorship</a></li>
                                                        {% endif %}
                                                        <li><a class="dropdown-item" href="#" onclick="updateMentorshipStatus('{{ mentorship.id }}', 'COMPLETED')"><i class="fas fa-check-circle me-2"></i> Complete Mentorship</a></li>
                                                        <li><a class="dropdown-item" href="#" onclick="updateMentorshipStatus('{{ mentorship.id }}', 'CANCELLED')"><i class="fas fa-times-circle me-2"></i> Cancel Mentorship</a></li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                {% endif %}
                                    
                                    <div class="mt-3">
                                        <button class="btn btn-sm btn-primary" onclick="scheduleMeeting('{{ mentorship.id }}')">
                                            Schedule Meeting
                                        </button>
                                        <button class="btn btn-sm btn-info" onclick="sendMessage('{{ mentorship.id }}')">
                                            Send Message
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Finished Mentorships Section -->
                    <div class="finished-mentorships" style="display: none;">
                        <div class="finished-mentorships-header">
                            <h5>Completed Mentorships</h5>
                            <span class="finished-mentorships-toggle" onclick="toggleFinishedMentorships()">
                                <i class="fas fa-chevron-down"></i> Show
                            </span>
                        </div>
                        <div class="finished-mentorships-content">
                            <!-- Completed mentorships will be moved here -->
                        </div>
                    </div>
                    {% else %}
                    <p class="text-muted">No active mentorships</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Right Column -->
    <div class="col-md-4">
        <!-- Upcoming Meetings -->
        <div class="card mb-4">
                <div class="card-header">
                <h5 class="mb-0">Upcoming Meetings</h5>
            </div>
            <div class="card-body">
                {% if upcoming_meetings %}
                    <div class="list-group">
                    {% for meeting in upcoming_meetings %}
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">{{ meeting.title }}</h6>
                                <small>{{ meeting.meeting_date|date:"M d, h:i a" }}</small>
                                </div>
                            <p class="mb-1">with {{ meeting.mentorship.mentee.get_full_name }}</p>
                            {% if meeting.meeting_link %}
                            <a href="{{ meeting.meeting_link }}" class="btn btn-primary mt-2 w-100" target="_blank">
                                <i class="fas fa-video me-1"></i> Join Meeting
                            </a>
                            <div class="form-text small mt-1 text-center">
                                Click to join the video call with your mentee
                            </div>
                            {% else %}
                            <div class="alert alert-warning mt-2 p-2 small">
                                <i class="fas fa-exclamation-triangle me-1"></i> No meeting link added
                                <button class="btn btn-sm btn-primary ms-2" onclick="editMeeting('{{ meeting.id }}')">
                                    <i class="fas fa-plus-circle me-1"></i> Add Link
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted">No upcoming meetings</p>
                {% endif %}
            </div>
        </div>

            <!-- Recent Progress -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Recent Progress Updates</h5>
                        </div>
                <div class="card-body">
                    {% if recent_progress %}
                    <div class="list-group">
                        {% for progress in recent_progress %}
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ progress.title }}</h6>
                                <small>{{ progress.created_at|timesince }} ago</small>
                            </div>
                            <p class="mb-1">{{ progress.description|truncatewords:20 }}</p>
                            <small>by {{ progress.mentorship.mentee.get_full_name }}</small>
                    </div>
                    {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted">No recent progress updates</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
</div>

<!-- JavaScript for Interactions -->
<script>
// Single DOMContentLoaded event listener
document.addEventListener('DOMContentLoaded', function() {
    // Initialize all progress bars
    initializeProgressBars();
    
    // Setup error handling for AJAX requests
    setupErrorHandling();
    
    // Initialize Bootstrap components
    initializeBootstrapComponents();
    
    // Initialize milestone buttons
    initializeMilestoneButtons();
    
    // Organize completed mentorships
    organizeCompletedMentorships();
    
    // Load timeline milestones for active mentorships (with debounce)
    setTimeout(() => {
        loadAllTimelineMilestones();
        enhanceTimelineDisplay();
    }, 100);
    
    // Setup mutation observer with throttle
    let timeout;
    const observer = new MutationObserver((mutations) => {
        if (timeout) {
            clearTimeout(timeout);
        }
        timeout = setTimeout(() => {
            updateProgressBars();
        }, 200);
    });
    
    // Observe progress bars with optimized config
    const progressBars = document.querySelectorAll('.progress');
    const config = { 
        attributes: true,
        attributeFilter: ['style']
    };
    
    progressBars.forEach(progress => {
        observer.observe(progress, config);
    });
    
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Initialize popovers
    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
    var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
        return new bootstrap.Popover(popoverTriggerEl);
    });
    
    // Initialize progress bars
    document.querySelectorAll('.progress-bar-mentorship').forEach(function(progressBar) {
        const percentage = progressBar.getAttribute('data-percentage');
        progressBar.style.width = `${percentage}%`;
        progressBar.setAttribute('aria-valuenow', percentage);
    });
    
    // Initialize skill progress bars
    document.querySelectorAll('[data-skill-proficiency]').forEach(function(progressBar) {
        const proficiency = progressBar.getAttribute('data-skill-proficiency');
        const percentage = (proficiency / 5) * 100;
        progressBar.style.width = `${percentage}%`;
        progressBar.setAttribute('aria-valuenow', percentage);
    });
    
    // Step-based progress tracker code removed as requested
});

// Function to initialize milestone buttons
function initializeMilestoneButtons() {
    const addMilestoneBtn = document.getElementById('add-milestone-btn');
    if (addMilestoneBtn) {
        addMilestoneBtn.addEventListener('click', function() {
            const milestonesContainer = document.getElementById('milestones-container');
            const template = document.getElementById('milestone-template');
            
            if (template) {
                const newMilestone = template.querySelector('.milestone-entry').cloneNode(true);
                
                // Add to the container
                milestonesContainer.appendChild(newMilestone);
                
                // Add event listener to the remove button
                const removeBtn = newMilestone.querySelector('.remove-milestone-btn');
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        const milestoneEntry = this.closest('.milestone-entry');
                        if (milestoneEntry && milestoneEntry.parentNode) {
                            // Check if this is the last milestone entry
                            const allEntries = milestonesContainer.querySelectorAll('.milestone-entry');
                            if (allEntries.length === 1) {
                                // If it's the last one, just clear the inputs instead of removing
                                const periodInput = milestoneEntry.querySelector('.milestone-period');
                                const descriptionInput = milestoneEntry.querySelector('.milestone-description');
                                const dateInput = milestoneEntry.querySelector('.milestone-date');
                                
                                if (periodInput) periodInput.value = '';
                                if (descriptionInput) descriptionInput.value = '';
                                if (dateInput) {
                                    dateInput.value = '';
                                    dateInput.classList.remove('is-invalid');
                                }
                            } else {
                                // Otherwise remove it
                                milestoneEntry.parentNode.removeChild(milestoneEntry);
                            }
                            
                            // Re-validate after changes
                            validateAllMilestoneDates();
                        }
                    });
                }
            } else {
                console.error("Milestone template not found");
            }
        });
    }
    
    // Add event listeners to existing remove buttons
    document.querySelectorAll('.remove-milestone-btn').forEach(button => {
        button.addEventListener('click', function() {
            const milestoneEntry = this.closest('.milestone-entry');
            const milestonesContainer = document.getElementById('milestones-container');
            
            if (milestoneEntry && milestoneEntry.parentNode) {
                // Check if this is the last milestone entry
                const allEntries = milestonesContainer.querySelectorAll('.milestone-entry');
                if (allEntries.length === 1) {
                    // If it's the last one, just clear the inputs instead of removing
                    const periodInput = milestoneEntry.querySelector('.milestone-period');
                    const descriptionInput = milestoneEntry.querySelector('.milestone-description');
                    const dateInput = milestoneEntry.querySelector('.milestone-date');
                    
                    if (periodInput) periodInput.value = '';
                    if (descriptionInput) descriptionInput.value = '';
                    if (dateInput) {
                        dateInput.value = '';
                        dateInput.classList.remove('is-invalid');
                    }
                } else {
                    // Otherwise remove it
                    milestoneEntry.parentNode.removeChild(milestoneEntry);
                }
                
                // Re-validate after changes
                validateAllMilestoneDates();
            }
        });
    });
}

// Function to calculate total mentoring days
function calculateMentoringDays() {
    const expectedEndDate = document.getElementById('expectedEndDate');
    const mentoringDaysInfo = document.getElementById('mentoringDaysInfo');
    const totalDaysText = document.getElementById('totalDaysText');
    
    if (!expectedEndDate || !expectedEndDate.value) {
        if (mentoringDaysInfo) mentoringDaysInfo.classList.add('d-none');
        return;
    }
    
    const endDate = new Date(expectedEndDate.value);
    const today = new Date();
    today.setHours(0, 0, 0, 0); // Reset hours to get exact days
    
    // Calculate difference in days
    const diffTime = endDate - today;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays < 0) {
        totalDaysText.textContent = `End date cannot be in the past. Please select a future date.`;
        mentoringDaysInfo.classList.remove('alert-info');
        mentoringDaysInfo.classList.add('alert-danger');
    } else {
        const weeks = Math.floor(diffDays / 7);
        const remainingDays = diffDays % 7;
        
        let timeMessage = '';
        if (weeks > 0) {
            timeMessage += `${weeks} week${weeks > 1 ? 's' : ''}`;
        }
        if (remainingDays > 0) {
            if (weeks > 0) timeMessage += ' and ';
            timeMessage += `${remainingDays} day${remainingDays > 1 ? 's' : ''}`;
        }
        
        totalDaysText.textContent = `Total mentoring time: ${diffDays} days (${timeMessage}).`;
        mentoringDaysInfo.classList.remove('alert-danger');
        mentoringDaysInfo.classList.add('alert-info');
        
        // Validate all milestone dates against this new end date
        validateAllMilestoneDates();
    }
    
    mentoringDaysInfo.classList.remove('d-none');
}

// Function to validate a single milestone date
function validateMilestoneDate(dateInput) {
    const expectedEndDateInput = document.getElementById('expectedEndDate');
    
    if (!expectedEndDateInput || !expectedEndDateInput.value) {
        showToast('warning', 'Please set an expected end date first');
        dateInput.classList.add('is-invalid');
        return false;
    }
    
    const endDate = new Date(expectedEndDateInput.value);
    endDate.setHours(23, 59, 59, 999); // End of the day
    
    const milestoneDate = new Date(dateInput.value);
    milestoneDate.setHours(0, 0, 0, 0); // Start of the day
    
    const today = new Date();
    today.setHours(0, 0, 0, 0); // Start of the day
    today.setDate(today.getDate() - 1); // Allow today by setting comparison to yesterday
    
    if (milestoneDate <= today) { // Using <= to compare with yesterday
        showToast('warning', 'Milestone date cannot be in the past');
        dateInput.classList.add('is-invalid');
        return false;
    }
    
    if (milestoneDate > endDate) {
        showToast('warning', 'Milestone date cannot be after the expected end date');
        dateInput.classList.add('is-invalid');
        return false;
    }
    
    dateInput.classList.remove('is-invalid');
    return true;
}

// Function to validate all milestone dates
function validateAllMilestoneDates() {
    const milestonesContainer = document.getElementById('milestones-container');
    const dateInputs = milestonesContainer.querySelectorAll('.milestone-date');
    
    let allValid = true;
    dateInputs.forEach(input => {
        if (input.value) {
            const isValid = validateMilestoneDate(input);
            if (!isValid) allValid = false;
        }
    });
    
    return allValid;
}

// Toggle between date picker and text input for date
function toggleDateDisplay(element) {
    const inputGroup = element.closest('.input-group');
    const dateInput = inputGroup.querySelector('.milestone-date');
    
    if (dateInput.type === 'date') {
        // Format the date for display as mm/dd/yyyy
        if (dateInput.value) {
            const date = new Date(dateInput.value);
            const formattedDate = `${(date.getMonth()+1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}/${date.getFullYear()}`;
            dateInput.type = 'text';
            dateInput.value = formattedDate;
        } else {
            dateInput.type = 'text';
            dateInput.placeholder = 'mm/dd/yyyy';
        }
    } else {
        dateInput.type = 'date';
    }
}

// Function to toggle availability
function toggleAvailability() {
    const toggle = document.getElementById('availabilityToggle');
    const isAvailable = toggle.checked;
    const mentorId = toggle.dataset.mentorId;
    
    // Debug logging
    console.log('Toggle availability with:', { mentorId, isAvailable });
    
    if (!mentorId) {
        console.error('No mentor ID found in data attribute');
        showToast('error', 'Failed to update availability: No mentor ID found');
        return;
    }

    $.ajax({
        url: `/mentorship/mentor/${mentorId}/toggle-availability/`,
        type: 'POST',
        data: JSON.stringify({ is_available: isAvailable }),
        contentType: 'application/json',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        beforeSend: function(xhr, settings) {
            console.log('Making request to:', settings.url);
        },
        success: function(response) {
            console.log('Toggle success:', response);
            showToast('success', `Availability ${response.accepting_mentees ? 'enabled' : 'disabled'} successfully`);
        },
        error: function(xhr, status, error) {
            console.error('Error toggling availability:', xhr.responseText || error);
            console.error('Status:', status);
            console.error('Status code:', xhr.status);
            let errorMessage = 'Failed to update availability';
            
            // Try to get more specific error message from response
            try {
                const errorData = JSON.parse(xhr.responseText);
                errorMessage = errorData.detail || errorData.message || errorMessage;
            } catch (e) {
                // If we can't parse the response, use the status text
                errorMessage = xhr.statusText ? `Error: ${xhr.statusText}` : errorMessage;
            }
            
            showToast('error', errorMessage);
            // Revert the toggle to its previous state
            toggle.checked = !isAvailable;
        }
    });
}

function updateStatus(requestId, status) {
    if (!confirm('Are you sure you want to update this request?')) {
        return;
    }

    $.ajax({
        url: `{% url "mentorship:update_request_status" 0 %}`.replace('0', requestId),
        type: 'POST',
        data: {
            'status': status,
            'csrfmiddlewaretoken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        success: function(response) {
            showToast('Success', response.message, 'success');
            setTimeout(() => window.location.reload(), 1500);
        },
        error: function(xhr, status, error) {
            showToast('Error', 'Failed to update request status', 'error');
        }
        });
}

function scheduleMeeting(mentorshipId) {
    const modal = new bootstrap.Modal(document.getElementById('scheduleMeetingModal'));
    document.getElementById('mentorshipIdInput').value = mentorshipId;
    modal.show();
}

function sendMessage(mentorshipId) {
    const modal = new bootstrap.Modal(document.getElementById('sendMessageModal'));
    document.getElementById('messageRecipientId').value = mentorshipId;
    modal.show();
}

function updateProgress(mentorshipId) {
    // Show progress update modal
    var progressModal = document.getElementById('progressModal');
    var modal = bootstrap.Modal.getInstance(progressModal) || new bootstrap.Modal(progressModal);
    document.getElementById('mentorshipIdForProgress').value = mentorshipId;
    
    // Fetch current progress percentage
    fetch(`/mentorship/api/requests/${mentorshipId}/`, {
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        // Set current progress percentage
        const progressSlider = document.getElementById('progressPercentage');
        const progressValue = document.getElementById('progressPercentageValue');
        if (progressSlider && progressValue && data.progress_percentage) {
            progressSlider.value = data.progress_percentage;
            progressValue.textContent = data.progress_percentage + '%';
        }
        
        modal.show();
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Failed to fetch current progress. Using default values.');
        modal.show(); // Show modal anyway
    });
}

// Submit progress form
function submitProgress() {
    const mentorshipId = document.getElementById('mentorshipIdForProgress').value;
    const progressTitle = document.getElementById('progressTitle').value;
    const progressDescription = document.getElementById('progressDescription').value;
    const progressPercentage = document.getElementById('progressPercentage').value;
    
    // First create the progress update
    fetch('/mentorship/api/progress/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            mentorship: mentorshipId,
            title: progressTitle,
            description: progressDescription
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to create progress update');
        }
        return response.json();
    })
    .then(data => {
        // Then update the progress percentage
        return fetch(`/mentorship/api/requests/${mentorshipId}/update_timeline/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                progress_percentage: progressPercentage
            })
        });
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to update progress percentage');
        }
        return response.json();
    })
    .then(data => {
        var progressModal = document.getElementById('progressModal');
        var modal = bootstrap.Modal.getInstance(progressModal);
        if (modal) modal.hide();
        
        showToast('success', 'Progress updated successfully');
        setTimeout(() => location.reload(), 1500);
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Failed to update progress. Please try again.');
    });
}

// Submit meeting form
function submitMeeting() {
    const mentorshipId = document.getElementById('mentorshipIdForMeeting').value;
    const meetingTitle = document.getElementById('meetingTitle').value;
    const meetingDate = document.getElementById('meetingDate').value;
    const meetingLink = document.getElementById('meetingLink').value;
    const meetingDescription = document.getElementById('meetingDescription')?.value || '';
    
    // Validate that required fields are filled
    if (!meetingTitle || !meetingDate || !meetingLink) {
        showToast('error', 'Please fill out all required fields, including the meeting link.');
        return;
    }
    
    // Validate that the meeting link is valid
    if (!meetingLink.startsWith('http://') && !meetingLink.startsWith('https://')) {
        showToast('error', 'Please enter a valid meeting link starting with http:// or https://');
        return;
    }
    
    fetch('/mentorship/api/meetings/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            mentorship: mentorshipId,
            title: meetingTitle,
            meeting_date: meetingDate,
            meeting_link: meetingLink,
            description: meetingDescription,
            status: 'SCHEDULED'
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to schedule meeting');
        }
        return response.json();
    })
    .then(data => {
        var meetingModal = document.getElementById('meetingModal');
        var modal = bootstrap.Modal.getInstance(meetingModal);
        if (modal) modal.hide();
        
        showToast('success', 'Meeting scheduled successfully with the link provided');
        setTimeout(() => location.reload(), 1500);
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Failed to schedule meeting. Please try again.');
    });
}

// Submit message form
function submitMessage() {
    const mentorshipId = document.getElementById('mentorshipIdForMessage').value;
    const messageContent = document.getElementById('messageContent').value;
    const messageAttachment = document.getElementById('messageAttachment').files[0];
    
    const formData = new FormData();
    formData.append('mentorship', mentorshipId);
    formData.append('content', messageContent);
    if (messageAttachment) {
        formData.append('attachment', messageAttachment);
    }
    
    fetch('/mentorship/api/messages/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to send message');
        }
        return response.json();
    })
    .then(data => {
        var messageModal = document.getElementById('messageModal');
        var modal = bootstrap.Modal.getInstance(messageModal);
        if (modal) modal.hide();
        
        showToast('success', 'Message sent successfully');
        setTimeout(() => location.reload(), 1500);
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Failed to send message. Please try again.');
    });
}

// Show toast notification
    function showToast(type, message) {
        const toast = document.createElement('div');
        toast.className = `toast toast-${type} show`;
        toast.innerHTML = `
            <div class="toast-header">
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
                <strong class="me-auto">${type === 'success' ? 'Success' : 'Error'}</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        `;
        
        // Add toast container if it doesn't exist
        let container = document.querySelector('.toast-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'toast-container';
            container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            container.style.zIndex = '9999'; // Increased from 1050 to ensure it's always on top
            document.body.appendChild(container);
        }
        
        container.appendChild(toast);
        
        // Initialize Bootstrap toast
        const bsToast = new bootstrap.Toast(toast, {
            autohide: true,
            delay: 3000
        });
        bsToast.show();
        
        // Remove toast after it's hidden
        toast.addEventListener('hidden.bs.toast', () => {
            toast.remove();
        });
    }

// CSRF Token helper
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Function to parse existing timeline milestones when editing
function parseExistingMilestones(timelineText) {
    if (!timelineText) return;
    
    const milestonesContainer = document.getElementById('milestones-container');
    if (!milestonesContainer) {
        console.error('Milestones container not found');
        return;
    }

    // Clear existing milestone entries
    // Use the newer milestone-row class if it exists, otherwise fall back to milestone-entry
    const rowSelector = milestonesContainer.querySelector('.milestone-row') ? '.milestone-row' : '.milestone-entry';
    const existingEntries = milestonesContainer.querySelectorAll(rowSelector);
    
    // Remove all existing entries except the first one
    if (existingEntries.length > 0) {
        for (let i = 1; i < existingEntries.length; i++) {
            milestonesContainer.removeChild(existingEntries[i]);
        }
        
        // Reset the first entry
        const firstEntry = existingEntries[0];
        if (firstEntry) {
            const periodInput = firstEntry.querySelector('.milestone-period');
            const descriptionInput = firstEntry.querySelector('.milestone-description');
            
            if (periodInput) periodInput.value = '';
            if (descriptionInput) descriptionInput.value = '';
        }
    } else {
        // If no entries exist, try to add one using the new function
        if (typeof addNewMilestone === 'function') {
            console.log('Adding first milestone entry using addNewMilestone');
            addNewMilestone();
        } else {
            console.error('No milestone entries found and addNewMilestone function not available');
        }
    }
    
    // Parse the timeline text
    const lines = timelineText.split('\n');
    let additionalNotes = '';
    let inAdditionalNotes = false;
    
    lines.forEach((line, index) => {
        line = line.trim();
        if (!line) return;
        
        if (line.startsWith('Additional Notes:')) {
            inAdditionalNotes = true;
            return;
        }
        
        if (inAdditionalNotes) {
            additionalNotes += line + '\n';
            return;
        }
        
        const weekDayMatch = line.match(/^Week\/Day\s+([^:]+):\s*(.+)$/);
        if (weekDayMatch) {
            const period = weekDayMatch[1];
            let description = weekDayMatch[2];
            
            // Remove status if present
            if (description.includes('[')) {
                description = description.split('[')[0].trim();
            }
            
            // Use newer milestone-row class if it exists, otherwise fall back to milestone-entry
            const rowSelector = milestonesContainer.querySelector('.milestone-row') ? '.milestone-row' : '.milestone-entry';
            const existingEntries = milestonesContainer.querySelectorAll(rowSelector);
            
            if (index === 0 && existingEntries.length > 0) {
                // Use the first entry
                const firstEntry = existingEntries[0];
                if (firstEntry) {
                    const periodInput = firstEntry.querySelector('.milestone-period');
                    const descriptionInput = firstEntry.querySelector('.milestone-description');
                    
                    if (periodInput) periodInput.value = period;
                    if (descriptionInput) descriptionInput.value = description;
                }
            } else {
                // Add a new entry using the newer function if available
                if (typeof addNewMilestone === 'function') {
                    addNewMilestone();
                    
                    // Get the newly created row (should be the last one)
                    const newEntries = milestonesContainer.querySelectorAll(rowSelector);
                    if (newEntries.length > 0) {
                        const newEntry = newEntries[newEntries.length - 1];
                        const periodInput = newEntry.querySelector('.milestone-period');
                        const descriptionInput = newEntry.querySelector('.milestone-description');
                        
                        if (periodInput) periodInput.value = period;
                        if (descriptionInput) descriptionInput.value = description;
                    }
                } else {
                    // Fall back to using the add-milestone-btn click
                    const addMilestoneBtn = document.getElementById('add-milestone-btn');
                    if (addMilestoneBtn) {
                        addMilestoneBtn.click();
                        
                        // Find the new entry (should be the last one)
                        const allEntries = milestonesContainer.querySelectorAll(rowSelector);
                        if (allEntries.length > 0) {
                            const newEntry = allEntries[allEntries.length - 1];
                            if (newEntry) {
                                const periodInput = newEntry.querySelector('.milestone-period');
                                const descriptionInput = newEntry.querySelector('.milestone-description');
                                
                                if (periodInput) periodInput.value = period;
                                if (descriptionInput) descriptionInput.value = description;
                            } else {
                                console.error('Failed to create new milestone entry');
                            }
                        }
                    } else {
                        console.error('Add milestone button not found');
                    }
                }
            }
        }
    });
    
    // Update additional notes field
    if (additionalNotes) {
        const notesField = document.getElementById('timelineMilestones');
        if (notesField) {
            notesField.value = additionalNotes.trim();
        }
    }
}

// Function to set timeline
function setTimeline(mentorshipId) {
    // Show timeline modal
    var timelineModal = document.getElementById('timelineModal');
    if (!timelineModal) {
        console.error('Timeline modal element not found');
        showToast('error', 'Timeline modal not found. Please refresh the page and try again.');
        return;
    }
    
    var modal = bootstrap.Modal.getInstance(timelineModal) || new bootstrap.Modal(timelineModal);
    
    const mentorshipIdInput = document.getElementById('mentorshipIdForTimeline');
    if (!mentorshipIdInput) {
        console.error('Mentorship ID input element not found');
        showToast('error', 'Form elements not found. Please refresh the page and try again.');
        return;
    }
    mentorshipIdInput.value = mentorshipId;
    
    // Clear any previous error
    const errorContainer = document.getElementById('timeline-error-message');
    if (errorContainer) {
        errorContainer.classList.add('d-none');
    }
    
    // Fetch existing timeline data if available
    fetch(`/mentorship/api/requests/${mentorshipId}/`, {
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        const expectedEndDateInput = document.getElementById('expectedEndDate');
        if (expectedEndDateInput && data.expected_end_date) {
            expectedEndDateInput.value = data.expected_end_date.split('T')[0];
        }
        
        if (data.timeline_milestones) {
            parseExistingMilestones(data.timeline_milestones);
        } else {
            // Reset form if no existing timeline
            const milestonesContainer = document.getElementById('milestones-container');
            if (milestonesContainer) {
                const existingEntries = milestonesContainer.querySelectorAll('.milestone-entry');
                if (existingEntries.length > 0) {
                    // Keep only the first entry and reset it
                    for (let i = 1; i < existingEntries.length; i++) {
                        milestonesContainer.removeChild(existingEntries[i]);
                    }
                    const firstEntry = existingEntries[0];
                    if (firstEntry) {
                        const periodInput = firstEntry.querySelector('.milestone-period');
                        const descriptionInput = firstEntry.querySelector('.milestone-description');
                        if (periodInput) periodInput.value = '';
                        if (descriptionInput) descriptionInput.value = '';
                    }
                }
            }
            
            const timelineMilestonesInput = document.getElementById('timelineMilestones');
            if (timelineMilestonesInput) {
                timelineMilestonesInput.value = '';
            }
        }
        modal.show();
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Failed to fetch timeline data. Please try again.');
        modal.show(); // Show modal anyway
    });
}

// Modified submitTimeline function to include validation
function submitTimeline() {
    // Validate dates before submission
    validateAllMilestoneDates();
    
    // Get the timeline alert to check for errors
    const timelineAlert = document.getElementById('timeline-alert');
    if (timelineAlert && !timelineAlert.classList.contains('d-none')) {
        // There are validation errors, don't submit
        showToast('error', 'Please fix the timeline date errors before saving.');
        return;
    }
    
    // Original function continues here...
    const mentorshipId = document.getElementById('mentorshipIdForTimeline').value;
    const expectedEndDate = document.getElementById('expectedEndDate').value;
    const additionalNotes = document.getElementById('timelineMilestones').value;
    
    // Validate required fields
    if (!expectedEndDate) {
        showToast('error', 'Please select an expected end date');
        return;
    }
    
    // Collect all milestone entries
    const milestoneEntries = document.querySelectorAll('.milestone-entry');
    
    // Check if there are any milestone entries
    if (milestoneEntries.length === 0) {
        // Add a new milestone entry if none exist
        const addMilestoneBtn = document.getElementById('add-milestone-btn');
        if (addMilestoneBtn) {
            addMilestoneBtn.click();
            showToast('error', 'Please add at least one milestone with both period and description');
            return;
        }
    }
    
    let formattedMilestones = '';
    let hasValidMilestones = false;
    
    milestoneEntries.forEach(entry => {
        const periodInput = entry.querySelector('.milestone-period');
        const descriptionInput = entry.querySelector('.milestone-description');
        const dateInput = entry.querySelector('.milestone-date');
        
        if (!periodInput || !descriptionInput) return;
        
        const period = periodInput.value.trim();
        const description = descriptionInput.value.trim();
        const date = dateInput ? dateInput.value.trim() : '';
        
        if (period && description) {
            let formattedDescription = description;
            if (date) {
                formattedDescription = `${description} [Date: ${date}]`;
            }
            formattedMilestones += `Week/Day ${period}: ${formattedDescription}\n`;
            hasValidMilestones = true;
        } else if (period || description) {
            // If one field is filled but not the other, highlight the empty field
            if (!period) {
                periodInput.classList.add('is-invalid');
                setTimeout(() => periodInput.classList.remove('is-invalid'), 3000);
            }
            if (!description) {
                descriptionInput.classList.add('is-invalid');
                setTimeout(() => descriptionInput.classList.remove('is-invalid'), 3000);
            }
        }
    });
    
    if (!hasValidMilestones) {
        showToast('error', 'Please add at least one milestone with both period and description');
        return;
    }
    
    // Add additional notes if provided
    if (additionalNotes) {
        formattedMilestones += `\nAdditional Notes:\n${additionalNotes}`;
    }
    
    // Show loading state
    const submitButton = document.querySelector('#timelineModal .btn-primary');
    const originalText = submitButton.textContent;
    submitButton.disabled = true;
    submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
    
    fetch(`/mentorship/api/requests/${mentorshipId}/update_timeline/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            expected_end_date: expectedEndDate,
            timeline_milestones: formattedMilestones
        })
    })
    .then(async response => {
        if (!response.ok) {
            // Try to get error details from response
            const errorData = await response.json().catch(() => null);
            throw new Error(errorData?.detail || `Error: ${response.status} ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        var timelineModal = document.getElementById('timelineModal');
        var modal = bootstrap.Modal.getInstance(timelineModal);
        if (modal) modal.hide();
        
        showToast('success', 'Mentorship timeline updated successfully');
        setTimeout(() => location.reload(), 1500);
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', error.message || 'Failed to update timeline. Please try again.');
        
        // Reset button state
        submitButton.disabled = false;
        submitButton.innerHTML = originalText;
    });
}

// Enhance the timeline display with milestone markers
function enhanceTimelineDisplay() {
    document.querySelectorAll('.timeline-container').forEach(container => {
        const timelineText = container.querySelector('.timeline-text').textContent;
        const progressBar = container.querySelector('.progress');
        let progressPercentage = 0;
        
        // Get the progress percentage from the progress bar if it exists
        if (progressBar && progressBar.querySelector('.progress-bar')) {
            const progressBarStyle = progressBar.querySelector('.progress-bar').getAttribute('style');
            const percentMatch = progressBarStyle.match(/width:\s*(\d+)%/);
            if (percentMatch && percentMatch[1]) {
                progressPercentage = parseInt(percentMatch[1]);
            } else {
                // Fallback to aria-valuenow
                progressPercentage = parseInt(progressBar.querySelector('.progress-bar').getAttribute('aria-valuenow') || 0);
            }
        }
        
        if (!timelineText) return;
        
        // Parse the timeline text to extract milestones
        const lines = timelineText.split('\n');
        let milestones = [];
        let inAdditionalNotes = false;
        
        lines.forEach(line => {
            line = line.trim();
            if (!line) return;
            
            if (line.startsWith('Additional Notes:')) {
                inAdditionalNotes = true;
                return;
            }
            
            if (inAdditionalNotes) {
                return;
            }
            
            const weekDayMatch = line.match(/^Week\/Day\s+([^:]+):\s*(.+)$/);
            if (weekDayMatch) {
                const period = weekDayMatch[1];
                const description = weekDayMatch[2];
                
                // Extract status if available
                let status = 'NOT_STARTED';
                const statusMatch = description.match(/(.+)\s+\[([A-Z_]+)\]$/);
                const cleanDescription = statusMatch ? statusMatch[1].trim() : description;
                if (statusMatch) {
                    status = statusMatch[2];
                }
                
                // Parse the period to get a position for the marker
                let position = 0;
                if (period.includes('-')) {
                    const [start, end] = period.split('-').map(p => parseInt(p.trim()));
                    position = (start + end) / 2;
                } else {
                    position = parseInt(period);
                }
                
                milestones.push({
                    period: period,
                    description: cleanDescription,
                    status: status,
                    position: position
                });
            }
        });
        
        // Create thermometer-style progress bar if milestones exist
        if (milestones.length > 0) {
            // Find the maximum position to scale properly
            const maxPosition = Math.max(...milestones.map(m => m.position));
            
            // Sort milestones by position
            milestones.sort((a, b) => a.position - b.position);
            
            // Calculate completion status
            const totalMilestones = milestones.length;
            const completedMilestones = milestones.filter(m => m.status === 'COMPLETED').length;
            const inProgressMilestones = milestones.filter(m => m.status === 'IN_PROGRESS').length;
            
            // Calculate actual percentage based on milestone completion
            const calculatedPercentage = Math.round((completedMilestones + (inProgressMilestones * 0.5)) / totalMilestones * 100);
            
            // Use the calculated percentage if it's available, otherwise use the one from the progress bar
            const displayPercentage = calculatedPercentage || progressPercentage;
            
            // Create a thermometer-style progress container
            const thermometerContainer = document.createElement('div');
            thermometerContainer.style.position = 'relative';
            thermometerContainer.style.margin = '40px 0 60px';
            thermometerContainer.style.padding = '0 10px';
            
            // Add status text
            const statusElement = document.createElement('div');
            statusElement.style.position = 'absolute';
            statusElement.style.top = '-35px';
            statusElement.style.left = '10px';
            statusElement.style.fontSize = '0.85rem';
            statusElement.style.fontWeight = '500';
            statusElement.style.color = '#495057';
            
            let statusText = '';
            if (displayPercentage === 100) {
                statusText = 'Completed';
            } else if (displayPercentage > 0) {
                statusText = 'In Progress';
            } else {
                statusText = 'Not Started';
            }
            statusElement.textContent = statusText;
            thermometerContainer.appendChild(statusElement);
            
            // Add dates
            const datesContainer = document.createElement('div');
            datesContainer.style.display = 'flex';
            datesContainer.style.justifyContent = 'space-between';
            datesContainer.style.marginBottom = '10px';
            datesContainer.style.fontSize = '0.85rem';
            datesContainer.style.color = '#495057';
            datesContainer.style.fontWeight = '500';
            
            const startDateElement = container.closest('.card-body').querySelector('small:first-child');
            const endDateElement = container.closest('.card-body').querySelector('small:last-child');
            
            const startDate = startDateElement ? startDateElement.textContent.replace('Started: ', '') : 'Start';
            const endDate = endDateElement ? endDateElement.textContent.replace('Target End: ', '') : 'End';
            
            datesContainer.innerHTML = `
                <span>${startDate}</span>
                <span>${endDate}</span>
            `;
            
            thermometerContainer.appendChild(datesContainer);
            
            // Add percentage indicator
            const percentageElement = document.createElement('div');
            percentageElement.style.position = 'absolute';
            percentageElement.style.top = '-35px';
            percentageElement.style.right = '10px';
            percentageElement.style.backgroundColor = '#343a40';
            percentageElement.style.color = 'white';
            percentageElement.style.padding = '4px 10px';
            percentageElement.style.borderRadius = '20px';
            percentageElement.style.fontSize = '0.85rem';
            percentageElement.style.fontWeight = 'bold';
            percentageElement.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
            percentageElement.textContent = `${displayPercentage}%`;
            thermometerContainer.appendChild(percentageElement);
            
            // Create the thermometer track
            const trackElement = document.createElement('div');
            trackElement.style.height = '16px';
            trackElement.style.backgroundColor = '#e9ecef';
            trackElement.style.borderRadius = '8px';
            trackElement.style.position = 'relative';
            trackElement.style.boxShadow = 'inset 0 1px 3px rgba(0,0,0,0.1)';
            trackElement.style.overflow = 'hidden';
            
            // Create the thermometer fill
            const fillElement = document.createElement('div');
            fillElement.style.position = 'absolute';
            fillElement.style.top = '0';
            fillElement.style.left = '0';
            fillElement.style.height = '100%';
            fillElement.style.background = 'linear-gradient(90deg, #4481eb 0%, #04befe 100%)';
            fillElement.style.borderRadius = '8px';
            fillElement.style.transition = 'width 0.6s ease';
            fillElement.style.width = `${displayPercentage}%`;
            
            trackElement.appendChild(fillElement);
            thermometerContainer.appendChild(trackElement);
            
            // Add thermometer bulb
            const bulbElement = document.createElement('div');
            bulbElement.style.position = 'absolute';
            bulbElement.style.left = `${displayPercentage}%`;
            bulbElement.style.top = '8px';
            bulbElement.style.transform = 'translate(-50%, -50%)';
            bulbElement.style.width = '30px';
            bulbElement.style.height = '30px';
            bulbElement.style.background = 'linear-gradient(135deg, #4481eb 0%, #04befe 100%)';
            bulbElement.style.borderRadius = '50%';
            bulbElement.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
            bulbElement.style.zIndex = '2';
            bulbElement.style.border = '3px solid #fff';
            
            // Add shine effect to bulb
            const bulbShine = document.createElement('div');
            bulbShine.style.position = 'absolute';
            bulbShine.style.top = '50%';
            bulbShine.style.left = '50%';
            bulbShine.style.transform = 'translate(-50%, -50%)';
            bulbShine.style.width = '15px';
            bulbShine.style.height = '15px';
            bulbShine.style.background = 'rgba(255, 255, 255, 0.3)';
            bulbShine.style.borderRadius = '50%';
            
            bulbElement.appendChild(bulbShine);
            thermometerContainer.appendChild(bulbElement);
            
            // Create scale marks
            const scaleContainer = document.createElement('div');
            scaleContainer.style.position = 'absolute';
            scaleContainer.style.bottom = '-25px';
            scaleContainer.style.left = '0';
            scaleContainer.style.right = '0';
            
            // Add scale marks at 0%, 25%, 50%, 75%, and 100%
            [0, 25, 50, 75, 100].forEach(percent => {
                const scaleMark = document.createElement('div');
                scaleMark.style.position = 'absolute';
                scaleMark.style.width = '1px';
                scaleMark.style.height = '10px';
                scaleMark.style.backgroundColor = '#6c757d';
                scaleMark.style.bottom = '15px';
                scaleMark.style.left = `${percent}%`;
                
                const scaleLabel = document.createElement('div');
                scaleLabel.style.position = 'absolute';
                scaleLabel.style.transform = 'translateX(-50%)';
                scaleLabel.style.bottom = '0';
                scaleLabel.style.left = `${percent}%`;
                scaleLabel.style.fontSize = '0.75rem';
                scaleLabel.style.color = '#6c757d';
                scaleLabel.textContent = `${percent}%`;
                
                scaleContainer.appendChild(scaleMark);
                scaleContainer.appendChild(scaleLabel);
            });
            
            thermometerContainer.appendChild(scaleContainer);
            
            // Create milestone markers container
            const markersContainer = document.createElement('div');
            markersContainer.style.position = 'relative';
            markersContainer.style.height = '60px';
            markersContainer.style.marginTop = '10px';
            
            // Add milestone markers
            milestones.forEach((milestone, index) => {
                const position = (milestone.position / maxPosition) * 100;
                
                const markerElement = document.createElement('div');
                markerElement.style.position = 'absolute';
                markerElement.style.transform = 'translateX(-50%)';
                markerElement.style.left = `${position}%`;
                
                // Create marker line
                const markerLine = document.createElement('div');
                markerLine.style.width = '2px';
                markerLine.style.height = milestone.status === 'COMPLETED' ? '15px' : 
                                          milestone.status === 'IN_PROGRESS' ? '12px' : '10px';
                markerLine.style.backgroundColor = milestone.status === 'COMPLETED' ? '#28a745' : 
                                                  milestone.status === 'IN_PROGRESS' ? '#ffc107' : '#6c757d';
                markerLine.style.margin = '0 auto 5px';
                
                // Create marker dot
                const markerDot = document.createElement('div');
                markerDot.style.width = '24px';
                markerDot.style.height = '24px';
                markerDot.style.borderRadius = '50%';
                markerDot.style.backgroundColor = milestone.status === 'COMPLETED' ? '#28a745' : 
                                                 milestone.status === 'IN_PROGRESS' ? '#ffc107' : '#e9ecef';
                markerDot.style.border = '3px solid #fff';
                markerDot.style.boxShadow = milestone.status === 'COMPLETED' ? '0 0 0 2px rgba(40, 167, 69, 0.3)' : 
                                           milestone.status === 'IN_PROGRESS' ? '0 0 0 2px rgba(255, 193, 7, 0.3)' : '0 0 0 2px #e9ecef';
                markerDot.style.margin = '0 auto 8px';
                markerDot.style.position = 'relative';
                markerDot.style.zIndex = '3';
                markerDot.style.cursor = 'pointer';
                
                // Create marker label
                const markerLabel = document.createElement('div');
                markerLabel.style.fontSize = '0.8rem';
                markerLabel.style.color = '#495057';
                markerLabel.style.textAlign = 'center';
                markerLabel.style.maxWidth = '100px';
                markerLabel.style.overflow = 'hidden';
                markerLabel.style.textOverflow = 'ellipsis';
                markerLabel.style.whiteSpace = 'nowrap';
                markerLabel.style.fontWeight = '500';
                markerLabel.style.position = 'relative';
                markerLabel.textContent = `Day ${milestone.period}`;
                
                // Create tooltip
                const tooltip = document.createElement('div');
                tooltip.style.position = 'absolute';
                tooltip.style.bottom = '100%';
                tooltip.style.left = '50%';
                tooltip.style.transform = 'translateX(-50%)';
                tooltip.style.backgroundColor = '#343a40';
                tooltip.style.color = 'white';
                tooltip.style.padding = '8px 12px';
                tooltip.style.borderRadius = '4px';
                tooltip.style.fontSize = '0.8rem';
                tooltip.style.whiteSpace = 'nowrap';
                tooltip.style.opacity = '0';
                tooltip.style.visibility = 'hidden';
                tooltip.style.transition = 'opacity 0.3s, visibility 0.3s';
                tooltip.style.zIndex = '10';
                tooltip.style.pointerEvents = 'none';
                tooltip.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
                tooltip.style.minWidth = '150px';
                tooltip.style.textAlign = 'center';
                tooltip.style.marginBottom = '10px';
                
                let statusText = 'Not Started';
                if (milestone.status === 'IN_PROGRESS') {
                    statusText = 'In Progress';
                } else if (milestone.status === 'COMPLETED') {
                    statusText = 'Completed';
                }
                
                tooltip.innerHTML = `
                    <div>${milestone.description}</div>
                    <div style="margin-top: 5px; font-weight: bold; color: ${
                        milestone.status === 'COMPLETED' ? '#28a745' : 
                        milestone.status === 'IN_PROGRESS' ? '#ffc107' : '#6c757d'
                    }">
                        ${statusText}
                    </div>
                `;
                
                // Add tooltip arrow
                const tooltipArrow = document.createElement('div');
                tooltipArrow.style.position = 'absolute';
                tooltipArrow.style.top = '100%';
                tooltipArrow.style.left = '50%';
                tooltipArrow.style.transform = 'translateX(-50%)';
                tooltipArrow.style.borderWidth = '6px';
                tooltipArrow.style.borderStyle = 'solid';
                tooltipArrow.style.borderColor = '#343a40 transparent transparent transparent';
                
                tooltip.appendChild(tooltipArrow);
                
                // Show tooltip on hover
                markerDot.addEventListener('mouseenter', () => {
                    tooltip.style.opacity = '1';
                    tooltip.style.visibility = 'visible';
                });
                
                markerDot.addEventListener('mouseleave', () => {
                    tooltip.style.opacity = '0';
                    tooltip.style.visibility = 'hidden';
                });
                
                markerElement.appendChild(tooltip);
                markerElement.appendChild(markerLine);
                markerElement.appendChild(markerDot);
                markerElement.appendChild(markerLabel);
                
                markersContainer.appendChild(markerElement);
            });
            
            thermometerContainer.appendChild(markersContainer);
            
            // Replace the original progress bar with our thermometer version
            if (progressBar) {
                progressBar.style.display = 'none';
                progressBar.parentNode.insertBefore(thermometerContainer, progressBar.nextSibling);
            } else {
                // If no progress bar exists, just add it to the container
                container.insertBefore(thermometerContainer, container.firstChild);
            }
            
            // Hide the original timeline text
            const timelineTextElement = container.querySelector('.timeline-text');
            timelineTextElement.style.display = 'none';
            
            // Add a button to toggle the original text
            const toggleButton = document.createElement('button');
            toggleButton.className = 'btn btn-sm btn-outline-secondary mt-2';
            toggleButton.textContent = 'Show Original Timeline';
            toggleButton.addEventListener('click', function() {
                if (timelineTextElement.style.display === 'none') {
                    timelineTextElement.style.display = 'block';
                    this.textContent = 'Hide Original Timeline';
                } else {
                    timelineTextElement.style.display = 'none';
                    this.textContent = 'Show Original Timeline';
                }
            });
            
            thermometerContainer.parentNode.insertBefore(toggleButton, thermometerContainer.nextSibling);
        }
    });
}

// Function to show the timeline status modal
function showTimelineStatusModal(mentorshipId) {
    // Show timeline status modal
    var statusModal = document.getElementById('timelineStatusModal');
    var modal = bootstrap.Modal.getInstance(statusModal) || new bootstrap.Modal(statusModal);
    document.getElementById('mentorshipIdForStatus').value = mentorshipId;
    
    // Fetch timeline milestones
    fetch(`/mentorship/api/requests/${mentorshipId}/`, {
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        loadTimelineMilestones(data.timeline_milestones, mentorshipId);
        modal.show();
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Failed to fetch timeline data. Please try again.');
        modal.show(); // Show modal anyway
    });
}

// Function to load timeline milestones
function loadTimelineMilestones(timelineText, mentorshipId) {
    const container = document.getElementById('milestone-status-container');
    const noMilestonesMessage = document.getElementById('no-milestones-message');
    
    // Clear existing content
    container.innerHTML = '';
    
    if (!timelineText) {
        container.appendChild(noMilestonesMessage);
        return;
    }
    
    // Parse the timeline text to extract milestones
    const lines = timelineText.split('\n');
    let milestones = [];
    let inAdditionalNotes = false;
    
    lines.forEach(line => {
        line = line.trim();
        if (!line) return;
        
        if (line.startsWith('Additional Notes:')) {
            inAdditionalNotes = true;
            return;
        }
        
        if (inAdditionalNotes) {
            return;
        }
        
        const weekDayMatch = line.match(/^Week\/Day\s+([^:]+):\s*(.+)$/);
        if (weekDayMatch) {
            const period = weekDayMatch[1];
            const description = weekDayMatch[2];
            
            // Extract status if available
            let status = 'NOT_STARTED';
            const statusMatch = description.match(/(.+)\s+\[([A-Z_]+)\]$/);
            const cleanDescription = statusMatch ? statusMatch[1].trim() : description;
            if (statusMatch) {
                status = statusMatch[2];
            }
            
            milestones.push({
                period: period,
                description: cleanDescription,
                status: status
            });
        }
    });
    
    if (milestones.length === 0) {
        container.appendChild(noMilestonesMessage);
        return;
    }
    
    // Create milestone status items
    milestones.forEach(milestone => {
        const statusItem = document.createElement('div');
        statusItem.className = 'milestone-status-item';
        
        statusItem.innerHTML = `
            <div class="milestone-title">Week/Day ${milestone.period}</div>
            <div class="milestone-description">${milestone.description}</div>
            <div class="form-group">
                <label class="form-label">Status</label>
                <select class="form-select milestone-status" data-period="${milestone.period}" data-description="${milestone.description}">
                    <option value="NOT_STARTED" ${milestone.status === 'NOT_STARTED' ? 'selected' : ''}>Not Started</option>
                    <option value="IN_PROGRESS" ${milestone.status === 'IN_PROGRESS' ? 'selected' : ''}>In Progress</option>
                    <option value="COMPLETED" ${milestone.status === 'COMPLETED' ? 'selected' : ''}>Completed</option>
                </select>
            </div>
        `;
        
        container.appendChild(statusItem);
    });
    
    // Also update the enhanced timeline display
    updateEnhancedTimelineDisplay(mentorshipId, milestones);
}

// Function to save timeline status
function saveTimelineStatus() {
    const mentorshipId = document.getElementById('mentorshipIdForStatus').value;
    
    // Collect milestone status updates
    const milestoneStatuses = [];
    document.querySelectorAll('.milestone-status').forEach(dropdown => {
        milestoneStatuses.push({
            period: dropdown.getAttribute('data-period'),
            description: dropdown.getAttribute('data-description'),
            status: dropdown.value
        });
    });
    
    // Update milestone statuses
    fetch('/mentorship/api/milestones/update_batch/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            mentorship: mentorshipId,
            milestones: milestoneStatuses
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to update milestone statuses');
        }
        return response.json();
    })
    .then(data => {
        // Then update the timeline text with status
        return fetch(`/mentorship/api/requests/${mentorshipId}/update_timeline/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                update_milestones_in_timeline: true,
                milestone_statuses: milestoneStatuses
            })
        });
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to update timeline');
        }
        return response.json();
    })
    .then(data => {
        var statusModal = document.getElementById('timelineStatusModal');
        var modal = bootstrap.Modal.getInstance(statusModal);
        if (modal) modal.hide();
        
        showToast('success', 'Timeline status updated successfully');
        setTimeout(() => location.reload(), 1500);
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Failed to update timeline status. Please try again.');
    });
}

// Function to update the enhanced timeline display
function updateEnhancedTimelineDisplay(mentorshipId, milestones) {
    const timelineContainer = document.getElementById(`timeline-milestones-${mentorshipId}`);
    if (!timelineContainer) return;
    
    // Clear existing content
    timelineContainer.innerHTML = '';
    
    // Sort milestones by period
    milestones.sort((a, b) => {
        const periodA = a.period.includes('-') ? 
            parseInt(a.period.split('-')[0]) : parseInt(a.period);
        const periodB = b.period.includes('-') ? 
            parseInt(b.period.split('-')[0]) : parseInt(b.period);
        return periodA - periodB;
    });
    
    // Create milestone cards
    milestones.forEach((milestone, index) => {
        const milestoneElement = document.createElement('div');
        milestoneElement.className = 'timeline-milestone';
        
        // Extract topics from description (if any)
        let description = milestone.description;
        let topics = [];
        
        // Check if description contains topics (bullet points)
        if (description.includes('')) {
            const parts = description.split('');
            description = parts[0].trim();
            topics = parts.slice(1).map(topic => topic.trim()).filter(topic => topic);
        }
        
        // Determine status class
        const statusClass = milestone.status.toLowerCase().replace('_', '-');
        
        // Create milestone card
        milestoneElement.innerHTML = `
            <div class="timeline-milestone-card">
                <div class="timeline-milestone-header ${statusClass}">
                    <span>Week/Day ${milestone.period}</span>
                    <span>${milestone.status === 'COMPLETED' ? 'Completed' : 
                           milestone.status === 'IN_PROGRESS' ? 'In Progress' : 'Not Started'}</span>
                </div>
                <div class="timeline-milestone-title">${description}</div>
                ${topics.length > 0 ? `
                <div class="timeline-milestone-topics">
                    <div class="timeline-milestone-topics-title">Topics/Activities:</div>
                    <ul>
                        ${topics.map(topic => `<li>${topic}</li>`).join('')}
                    </ul>
                </div>
                ` : ''}
                <select class="timeline-milestone-status-select" 
                        data-period="${milestone.period}" 
                        data-description="${milestone.description}"
                        onchange="updateMilestoneStatus(this, '${mentorshipId}')">
                    <option value="NOT_STARTED" ${milestone.status === 'NOT_STARTED' ? 'selected' : ''}>Not Started</option>
                    <option value="IN_PROGRESS" ${milestone.status === 'IN_PROGRESS' ? 'selected' : ''}>In Progress</option>
                    <option value="COMPLETED" ${milestone.status === 'COMPLETED' ? 'selected' : ''}>Completed</option>
                </select>
            </div>
            <div class="timeline-milestone-dot ${statusClass}"></div>
        `;
        
        timelineContainer.appendChild(milestoneElement);
    });
}

// Function to update a single milestone status directly from the timeline
function updateMilestoneStatus(selectElement, mentorshipId) {
    const period = selectElement.getAttribute('data-period');
    const description = selectElement.getAttribute('data-description');
    const status = selectElement.value;
    
    // Update milestone status
    fetch('/mentorship/api/milestones/update_batch/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            mentorship: mentorshipId,
            milestones: [{
                period: period,
                description: description,
                status: status
            }]
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to update milestone status');
        }
        return response.json();
    })
    .then(data => {
        // Then update the timeline text with status
        return fetch(`/mentorship/api/requests/${mentorshipId}/update_timeline/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                update_milestones_in_timeline: true,
                milestone_statuses: [{
                    period: period,
                    description: description,
                    status: status
                }]
            })
        });
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to update timeline');
        }
        return response.json();
    })
    .then(data => {
        showToast('success', 'Milestone status updated');
        
        // Update the UI without reloading
        const card = selectElement.closest('.timeline-milestone-card');
        const header = card.querySelector('.timeline-milestone-header');
        const dot = selectElement.closest('.timeline-milestone').querySelector('.timeline-milestone-dot');
        
        // Update status classes
        header.className = 'timeline-milestone-header';
        dot.className = 'timeline-milestone-dot';
        
        const statusClass = status.toLowerCase().replace('_', '-');
        header.classList.add(statusClass);
        dot.classList.add(statusClass);
        
        // Update status text
        const statusText = status === 'COMPLETED' ? 'Completed' : 
                          status === 'IN_PROGRESS' ? 'In Progress' : 'Not Started';
        header.querySelector('span:last-child').textContent = statusText;
        
        // Calculate new progress percentage
        calculateProgressPercentage(mentorshipId);
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Failed to update milestone status');
        
        // Reset the select to its previous value
        selectElement.value = selectElement.getAttribute('data-previous-value');
    });
    
    // Store the current value for potential rollback
    selectElement.setAttribute('data-previous-value', status);
}

// Function to calculate progress percentage based on milestone statuses
function calculateProgressPercentage(mentorshipId) {
    // Get all milestone status selects
    const selects = document.querySelectorAll(`#timeline-milestones-${mentorshipId} .timeline-milestone-status-select`);
    if (selects.length === 0) return;
    
    // Count completed and in-progress milestones
    let completed = 0;
    let inProgress = 0;
    
    selects.forEach(select => {
        if (select.value === 'COMPLETED') {
            completed++;
        } else if (select.value === 'IN_PROGRESS') {
            inProgress++;
        }
    });
    
    // Calculate percentage (completed + half of in-progress)
    const total = selects.length;
    const percentage = Math.round((completed + (inProgress * 0.5)) / total * 100);
    
    // Update progress bar
    const progressBar = document.querySelector(`#mentorship${mentorshipId} .progress-bar`);
    if (progressBar) {
        progressBar.style.width = `${percentage}%`;
        progressBar.setAttribute('aria-valuenow', percentage);
        progressBar.textContent = `${percentage}%`;
        
        // Step-progress-bar update code removed as requested
        
        // Also update the progress percentage on the server
        fetch(`/mentorship/api/requests/${mentorshipId}/update_timeline/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                progress_percentage: percentage
            })
        })
        .catch(error => {
            console.error('Error updating progress percentage:', error);
        });
    }
}

// Function to toggle timeline text view
function toggleTimelineText(mentorshipId) {
    const timelineText = document.querySelector(`#mentorship${mentorshipId} .timeline-text`);
    const toggleButton = document.querySelector(`#toggle-text-${mentorshipId}`);
    
    if (timelineText.style.display === 'none') {
        timelineText.style.display = 'block';
        toggleButton.textContent = 'Hide Text View';
    } else {
        timelineText.style.display = 'none';
        toggleButton.textContent = 'Show Text View';
    }
}

// Initialize enhanced timeline displays when the DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // ... existing code ...
    
    // Initialize enhanced timeline displays
    document.querySelectorAll('.timeline-container').forEach(container => {
        const mentorshipId = container.closest('.accordion-collapse').id.replace('mentorship-', '');
        const timelineText = container.querySelector('.timeline-text').textContent;
        
        if (timelineText) {
            // Parse the timeline text to extract milestones
            const lines = timelineText.split('\n');
            let milestones = [];
            let inAdditionalNotes = false;
            
            lines.forEach(line => {
                line = line.trim();
                if (!line) return;
                
                if (line.startsWith('Additional Notes:')) {
                    inAdditionalNotes = true;
                    return;
                }
                
                if (inAdditionalNotes) {
                    return;
                }
                
                const weekDayMatch = line.match(/^Week\/Day\s+([^:]+):\s*(.+)$/);
                if (weekDayMatch) {
                    const period = weekDayMatch[1];
                    const description = weekDayMatch[2];
                    
                    // Extract status if available
                    let status = 'NOT_STARTED';
                    const statusMatch = description.match(/(.+)\s+\[([A-Z_]+)\]$/);
                    const cleanDescription = statusMatch ? statusMatch[1].trim() : description;
                    if (statusMatch) {
                        status = statusMatch[2];
                    }
                    
                    milestones.push({
                        period: period,
                        description: cleanDescription,
                        status: status
                    });
                }
            });
            
            // Update the enhanced timeline display
            updateEnhancedTimelineDisplay(mentorshipId, milestones);
        }
    });
});

// Function to show progress details modal
function showProgressDetails(mentorshipId) {
    try {
        // Validate mentorshipId
        if (!mentorshipId || mentorshipId === '') {
            console.error('Invalid mentorship ID');
            showToast('error', 'Error loading progress details: Invalid mentorship ID');
            return;
        }
        
        // Show progress details modal
        var progressDetailsModal = document.getElementById('progressDetailsModal');
        if (!progressDetailsModal) {
            console.error('Progress details modal element not found');
            showToast('error', 'Error loading progress details: Modal not found');
            return;
        }
        
        var modal = bootstrap.Modal.getInstance(progressDetailsModal) || new bootstrap.Modal(progressDetailsModal);
        
        // Log the mentorship ID to help with debugging
        console.log('Fetching details for mentorship ID:', mentorshipId);
        
        // Fetch mentorship data
        fetch(`/mentorship/api/requests/${mentorshipId}/`, {
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            if (!response.ok) {
                // More detailed error handling
                if (response.status === 404) {
                    throw new Error('Mentorship not found. It may have been deleted or you may not have access.');
                } else if (response.status === 403) {
                    throw new Error('Permission denied. You do not have access to this mentorship.');
                } else if (response.status >= 500) {
                    throw new Error('Server error. Please try again later.');
                } else {
                    // Try to get more details from the response if possible
                    return response.json()
                        .then(errData => {
                            throw new Error(errData.detail || errData.message || `Network response error: ${response.status} ${response.statusText}`);
                        })
                        .catch(jsonErr => {
                            // If we can't parse the JSON, just use the status
                            throw new Error(`Network response error: ${response.status} ${response.statusText}`);
                        });
                }
            }
            return response.json();
        })
        .then(data => {
            try {
                // Update progress percentage
                const progressPercentage = data.progress_percentage || 0;
                const progressBar = document.querySelector('#progressDetailsModal .progress-bar');
                const progressDisplay = document.querySelector('#progressDetailsModal .progress-percentage-display');
                
                if (progressBar) {
                    progressBar.style.width = `${progressPercentage}%`;
                    progressBar.setAttribute('aria-valuenow', progressPercentage);
                    progressBar.textContent = `${progressPercentage}%`;
                }
                
                if (progressDisplay) {
                    progressDisplay.textContent = `${progressPercentage}%`;
                }
                
                // Parse timeline milestones
                if (data.timeline_milestones) {
                    parseMilestonesForDetails(data.timeline_milestones, mentorshipId);
                } else {
                    // Clear milestone displays if no timeline
                    const elements = {
                        completed: document.getElementById('completed-milestones'),
                        inProgress: document.getElementById('in-progress-milestones'),
                        notStarted: document.getElementById('not-started-milestones'),
                        total: document.getElementById('total-milestones'),
                        container: document.getElementById('timeline-visual-container'),
                        tableBody: document.getElementById('milestone-table-body')
                    };
                    
                    // Safely update elements if they exist
                    if (elements.completed) elements.completed.textContent = '0';
                    if (elements.inProgress) elements.inProgress.textContent = '0';
                    if (elements.notStarted) elements.notStarted.textContent = '0';
                    if (elements.total) elements.total.textContent = '0';
                    
                    if (elements.container) {
                        elements.container.innerHTML = '<div class="text-center py-4 text-muted"><i class="fas fa-info-circle me-2"></i>No timeline milestones found</div>';
                    }
                    
                    if (elements.tableBody) {
                        elements.tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No milestones found</td></tr>';
                    }
                }
                
                // Show the modal
                modal.show();
            } catch (innerError) {
                console.error('Error processing mentorship data:', innerError);
                showToast('error', 'Error processing mentorship data');
            }
        })
        .catch(error => {
            console.error('Error fetching mentorship data:', error);
            // Show a more informative error message to the user
            showToast('error', `Failed to fetch progress details: ${error.message || 'Please try again.'}`);
            // Optionally close the modal if it's showing a loading state
            if (modal && typeof modal.hide === 'function') {
                modal.hide();
            }
        });
    } catch (error) {
        console.error('Error in showProgressDetails:', error);
        showToast('error', 'An unexpected error occurred');
    }
}

// Function to parse milestones for the details modal
function parseMilestonesForDetails(timelineText, mentorshipId) {
    try {
        if (!timelineText) {
            console.warn('No timeline text provided to parseMilestonesForDetails');
            return;
        }
        
        // Parse the timeline text to extract milestones
        const lines = timelineText.split('\n');
        let milestones = [];
        let inAdditionalNotes = false;
        
        lines.forEach(line => {
            line = line.trim();
            if (!line) return;
            
            if (line.startsWith('Additional Notes:')) {
                inAdditionalNotes = true;
                return;
            }
            
            if (inAdditionalNotes) {
                return;
            }
            
            const weekDayMatch = line.match(/^Week\/Day\s+([^:]+):\s*(.+)$/);
            if (weekDayMatch) {
                const period = weekDayMatch[1];
                const description = weekDayMatch[2];
                
                // Extract status if available
                let status = 'NOT_STARTED';
                const statusMatch = description.match(/(.+)\s+\[([A-Z_]+)\]$/);
                const cleanDescription = statusMatch ? statusMatch[1].trim() : description;
                if (statusMatch) {
                    status = statusMatch[2];
                }
                
                // Parse the period to get a position for the marker
                let position = 0;
                try {
                    if (period.includes('-')) {
                        const [start, end] = period.split('-').map(p => parseInt(p.trim()));
                        position = (start + end) / 2;
                    } else {
                        position = parseInt(period);
                    }
                    
                    // Handle NaN case
                    if (isNaN(position)) {
                        position = milestones.length + 1;
                    }
                } catch (error) {
                    console.warn('Error parsing period position:', error);
                    position = milestones.length + 1;
                }
                
                milestones.push({
                    period: period,
                    description: cleanDescription,
                    status: status,
                    position: position
                });
            }
        });
        
        // Sort milestones by position
        milestones.sort((a, b) => a.position - b.position);
        
        // Update milestone statistics
        const completedCount = milestones.filter(m => m.status === 'COMPLETED').length;
        const inProgressCount = milestones.filter(m => m.status === 'IN_PROGRESS').length;
        const notStartedCount = milestones.filter(m => m.status === 'NOT_STARTED').length;
        const totalCount = milestones.length;
        
        // Safely update DOM elements
        const elements = {
            completed: document.getElementById('completed-milestones'),
            inProgress: document.getElementById('in-progress-milestones'),
            notStarted: document.getElementById('not-started-milestones'),
            total: document.getElementById('total-milestones')
        };
        
        if (elements.completed) elements.completed.textContent = completedCount;
        if (elements.inProgress) elements.inProgress.textContent = inProgressCount;
        if (elements.notStarted) elements.notStarted.textContent = notStartedCount;
        if (elements.total) elements.total.textContent = totalCount;
        
        // Render timeline visualization
        renderTimelineVisualization(milestones);
        
        // Render milestone table
        renderMilestoneTable(milestones, mentorshipId);
    } catch (error) {
        console.error('Error parsing milestones:', error);
        showToast('error', 'Error parsing milestone data');
    }
}

// Function to render timeline visualization
function renderTimelineVisualization(milestones) {
    try {
        const container = document.getElementById('timeline-visual-container');
        if (!container) {
            console.error('Timeline container element not found');
            return;
        }
        
        container.innerHTML = '';
        
        if (!milestones || milestones.length === 0) {
            container.innerHTML = '<div class="text-center py-4 text-muted"><i class="fas fa-info-circle me-2"></i>No timeline milestones found</div>';
            return;
        }
        
        // Find the maximum position to scale properly
        const maxPosition = Math.max(...milestones.map(m => m.position));
        
        // Create the timeline container with enhanced styling
        const timelineContainer = document.createElement('div');
        timelineContainer.className = 'enhanced-timeline-container';
        container.appendChild(timelineContainer);
        
        // Create the timeline line
        const timelineLine = document.createElement('div');
        timelineLine.className = 'enhanced-timeline-line';
        timelineContainer.appendChild(timelineLine);
        
        // Create the progress fill
        const progressFill = document.createElement('div');
        progressFill.className = 'enhanced-timeline-progress-fill';
        timelineContainer.appendChild(progressFill);
        
        // Calculate progress percentage based on milestones
        const completedMilestones = milestones.filter(m => m.status === 'COMPLETED').length;
        const inProgressMilestones = milestones.filter(m => m.status === 'IN_PROGRESS').length;
        const progressPercentage = Math.round((completedMilestones + (inProgressMilestones * 0.5)) / milestones.length * 100);
        
        // Update the progress badge
        const progressBadge = document.getElementById('timeline-progress-badge');
        if (progressBadge) {
            progressBadge.textContent = `${progressPercentage}%`;
            
            // Update badge color based on progress
            progressBadge.className = 'badge';
            if (progressPercentage < 25) {
                progressBadge.classList.add('bg-danger');
            } else if (progressPercentage < 50) {
                progressBadge.classList.add('bg-warning');
            } else if (progressPercentage < 75) {
                progressBadge.classList.add('bg-info');
            } else if (progressPercentage < 100) {
                progressBadge.classList.add('bg-primary');
            } else {
                progressBadge.classList.add('bg-success');
            }
        }
        
        // Animate the progress fill
        setTimeout(() => {
            progressFill.style.width = `${progressPercentage}%`;
        }, 300);
        
        // Add padding to ensure markers don't overflow
        // Use 10% padding on each side to keep markers within bounds
        const paddingPercentage = 10;
        const usableWidth = 100 - (paddingPercentage * 2);
        
        // Add milestone markers with enhanced styling
        milestones.forEach((milestone, index) => {
            try {
                // Calculate position with padding to prevent overflow
                // Map the position from 0-100% to paddingPercentage-(100-paddingPercentage)%
                const rawPosition = (milestone.position / maxPosition) * 100;
                const adjustedPosition = (rawPosition * usableWidth / 100) + paddingPercentage;
                
                // Create milestone marker wrapper
                const markerWrapper = document.createElement('div');
                markerWrapper.className = 'enhanced-milestone-marker-wrapper';
                markerWrapper.style.left = `${adjustedPosition}%`;
                timelineContainer.appendChild(markerWrapper);
                
                // Create the actual marker
                const markerElement = document.createElement('div');
                markerElement.className = `enhanced-milestone-marker ${milestone.status.toLowerCase().replace('_', '-')}`;
                
                // Add milestone number inside marker
                markerElement.innerHTML = `<span>${index + 1}</span>`;
                markerWrapper.appendChild(markerElement);
                
                // Create tooltip with enhanced styling
                const tooltip = document.createElement('div');
                tooltip.className = 'enhanced-milestone-tooltip';
                
                let statusText = 'Not Started';
                let statusClass = 'not-started';
                if (milestone.status === 'IN_PROGRESS') {
                    statusText = 'In Progress';
                    statusClass = 'in-progress';
                } else if (milestone.status === 'COMPLETED') {
                    statusText = 'Completed';
                    statusClass = 'completed';
                }
                
                tooltip.innerHTML = `
                    <div class="tooltip-header">
                        <span class="tooltip-title">Week/Day ${milestone.period}</span>
                        <span class="tooltip-status ${statusClass}">${statusText}</span>
                    </div>
                    <div class="tooltip-body">${milestone.description}</div>
                `;
                
                markerWrapper.appendChild(tooltip);
                
                // Add click event to show milestone details
                markerWrapper.addEventListener('click', function() {
                    try {
                        // Highlight the corresponding row in the milestone table
                        const tableRows = document.querySelectorAll('#milestone-table-body tr');
                        tableRows.forEach((row, rowIndex) => {
                            if (rowIndex === index) {
                                row.classList.add('table-active');
                                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            } else {
                                row.classList.remove('table-active');
                            }
                        });
                    } catch (clickError) {
                        console.warn('Error in milestone click handler:', clickError);
                    }
                });
            } catch (milestoneError) {
                console.warn(`Error rendering milestone ${index}:`, milestoneError);
            }
        });
        
        // Add current position indicator if there are in-progress milestones
        if (inProgressMilestones > 0) {
            try {
                const currentPositionMarker = document.createElement('div');
                currentPositionMarker.className = 'enhanced-current-position-marker';
                currentPositionMarker.innerHTML = '<i class="fas fa-map-marker-alt"></i>';
                
                // Adjust the position of the current marker to match the progress fill
                const adjustedProgressPosition = (progressPercentage * usableWidth / 100) + paddingPercentage;
                currentPositionMarker.style.left = `${adjustedProgressPosition}%`;
                
                timelineContainer.appendChild(currentPositionMarker);
            } catch (markerError) {
                console.warn('Error adding current position marker:', markerError);
            }
        }
        
        // Removed the milestone labels below the timeline as requested
    } catch (error) {
        console.error('Error rendering timeline visualization:', error);
        const container = document.getElementById('timeline-visual-container');
        if (container) {
            container.innerHTML = '<div class="text-center py-4 text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error rendering timeline</div>';
        }
    }
}

// Function to render milestone table
function renderMilestoneTable(milestones, mentorshipId) {
    try {
        const tableBody = document.getElementById('milestone-table-body');
        if (!tableBody) {
            console.error('Milestone table body element not found');
            return;
        }
        
        tableBody.innerHTML = '';
        
        if (!milestones || milestones.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No milestones found</td></tr>';
            return;
        }
        
        milestones.forEach((milestone, index) => {
            try {
                const row = document.createElement('tr');
                
                let statusText = 'Not Started';
                let statusClass = 'not-started';
                if (milestone.status === 'IN_PROGRESS') {
                    statusText = 'In Progress';
                    statusClass = 'in-progress';
                } else if (milestone.status === 'COMPLETED') {
                    statusText = 'Completed';
                    statusClass = 'completed';
                }
                
                // Safely escape HTML to prevent XSS
                const safeDescription = milestone.description
                    ? milestone.description.replace(/</g, '&lt;').replace(/>/g, '&gt;')
                    : '';
                const safePeriod = milestone.period
                    ? milestone.period.replace(/</g, '&lt;').replace(/>/g, '&gt;')
                    : '';
                
                row.innerHTML = `
                    <td>Week/Day ${safePeriod}</td>
                    <td>${safeDescription}</td>
                    <td><span class="timeline-status-badge ${statusClass}">${statusText}</span></td>
                    <td>
                        <select class="form-select form-select-sm milestone-quick-status" 
                                data-period="${safePeriod}" 
                                data-description="${safeDescription}"
                                data-mentorship="${mentorshipId}"
                                onchange="updateQuickMilestoneStatus(this)">
                            <option value="NOT_STARTED" ${milestone.status === 'NOT_STARTED' ? 'selected' : ''}>Not Started</option>
                            <option value="IN_PROGRESS" ${milestone.status === 'IN_PROGRESS' ? 'selected' : ''}>In Progress</option>
                            <option value="COMPLETED" ${milestone.status === 'COMPLETED' ? 'selected' : ''}>Completed</option>
                        </select>
                    </td>
                `;
                
                tableBody.appendChild(row);
            } catch (rowError) {
                console.warn(`Error rendering milestone row ${index}:`, rowError);
            }
        });
    } catch (error) {
        console.error('Error rendering milestone table:', error);
        const tableBody = document.getElementById('milestone-table-body');
        if (tableBody) {
            tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error rendering milestone table</td></tr>';
        }
    }
}

// Function to update a single milestone status from the details modal
function updateQuickMilestoneStatus(selectElement) {
    try {
        const period = selectElement.getAttribute('data-period');
        const description = selectElement.getAttribute('data-description');
        const mentorshipId = selectElement.getAttribute('data-mentorship');
        const status = selectElement.value;
        
        // Validate required data
        if (!period || !mentorshipId || !status) {
            console.error('Missing required data for milestone update:', { period, mentorshipId, status });
            showToast('error', 'Missing required data for milestone update');
            return;
        }
        
        // Store the original select element and its parent for later reference
        const parentElement = selectElement.parentElement;
        const originalHtml = parentElement.innerHTML;
        
        // Create and insert a loading spinner that preserves the width of the original element
        const originalWidth = parentElement.offsetWidth;
        parentElement.innerHTML = `<div class="d-flex justify-content-center align-items-center" style="min-width: ${originalWidth}px;">
            <div class="spinner-border spinner-border-sm text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>`;
        
        // Skip the milestone update API and go directly to the timeline update
        // This avoids the need for milestone IDs which we don't have in the UI
        fetch(`/mentorship/api/requests/${mentorshipId}/update_timeline/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                update_milestones_in_timeline: true,
                milestone_statuses: [{
                    period: period,
                    description: description,
                    status: status
                }]
            })
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    try {
                        // Try to parse as JSON
                        const errorData = JSON.parse(text);
                        throw new Error(`Failed to update timeline: ${JSON.stringify(errorData)}`);
                    } catch (e) {
                        // If not JSON, use text
                        throw new Error(`Failed to update timeline: ${text || response.statusText}`);
                    }
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Timeline update successful:', data);
            showToast('success', 'Milestone status updated');
            
            // Update the UI to reflect the changes
            try {
                // Update the milestone status in the UI
                const milestoneMarkers = document.querySelectorAll('.enhanced-milestone-marker-wrapper');
                milestoneMarkers.forEach((marker, index) => {
                    const tooltip = marker.querySelector('.tooltip-status');
                    if (tooltip) {
                        const tooltipTitle = marker.querySelector('.tooltip-title');
                        if (tooltipTitle && tooltipTitle.textContent.includes(period)) {
                            // Update the status class
                            tooltip.className = 'tooltip-status';
                            tooltip.classList.add(status.toLowerCase().replace('_', '-'));
                            
                            // Update the status text
                            let statusText = 'Not Started';
                            if (status === 'IN_PROGRESS') statusText = 'In Progress';
                            if (status === 'COMPLETED') statusText = 'Completed';
                            tooltip.textContent = statusText;
                            
                            // Update the marker class
                            const markerElement = marker.querySelector('.enhanced-milestone-marker');
                            if (markerElement) {
                                markerElement.className = 'enhanced-milestone-marker';
                                markerElement.classList.add(status.toLowerCase().replace('_', '-'));
                            }
                        }
                    }
                });
                
                // Update the table row status
                const tableRows = document.querySelectorAll('#milestone-table-body tr');
                tableRows.forEach(row => {
                    const periodCell = row.querySelector('td:first-child');
                    if (periodCell && periodCell.textContent.includes(period)) {
                        const statusCell = row.querySelector('td:nth-child(3) .timeline-status-badge');
                        if (statusCell) {
                            statusCell.className = 'timeline-status-badge';
                            let statusClass = 'not-started';
                            let statusText = 'Not Started';
                            
                            if (status === 'IN_PROGRESS') {
                                statusClass = 'in-progress';
                                statusText = 'In Progress';
                            } else if (status === 'COMPLETED') {
                                statusClass = 'completed';
                                statusText = 'Completed';
                            }
                            
                            statusCell.classList.add(statusClass);
                            statusCell.textContent = statusText;
                        }
                    }
                });
                
                // Update the progress stats
                updateProgressStats();
            } catch (updateError) {
                console.warn('Error updating UI after status change:', updateError);
            } finally {
                // Always restore the select element with the updated value
                if (parentElement) {
                    parentElement.innerHTML = originalHtml;
                    // Re-select the current value
                    const newSelect = parentElement.querySelector('select');
                    if (newSelect) {
                        newSelect.value = status;
                        // Add a brief highlight effect to indicate the update was successful
                        newSelect.classList.add('border-success');
                        setTimeout(() => {
                            newSelect.classList.remove('border-success');
                        }, 1500);
                    }
                }
            }
        })
        .catch(error => {
            console.error('Error in milestone update process:', error);
            showToast('error', error.message || 'Failed to update milestone status');
            
            // Restore the original HTML
            if (parentElement) {
                parentElement.innerHTML = originalHtml;
                // Highlight the error
                const newSelect = parentElement.querySelector('select');
                if (newSelect) {
                    newSelect.classList.add('border-danger');
                    setTimeout(() => {
                        newSelect.classList.remove('border-danger');
                    }, 1500);
                }
            }
        });
    } catch (error) {
        console.error('Unexpected error in updateQuickMilestoneStatus:', error);
        showToast('error', 'An unexpected error occurred');
        
        // Try to restore the original state
        try {
            if (selectElement && selectElement.parentElement) {
                selectElement.parentElement.innerHTML = originalHtml;
            }
        } catch (e) {
            console.warn('Could not restore original HTML:', e);
        }
    }
}

// Function to update progress stats without refreshing the entire modal
function updateProgressStats() {
    try {
        const milestones = [];
        const tableRows = document.querySelectorAll('#milestone-table-body tr');
        
        // Collect milestone data from the table
        tableRows.forEach(row => {
            const statusBadge = row.querySelector('.timeline-status-badge');
            if (statusBadge) {
                let status = 'NOT_STARTED';
                if (statusBadge.classList.contains('in-progress')) status = 'IN_PROGRESS';
                if (statusBadge.classList.contains('completed')) status = 'COMPLETED';
                milestones.push({ status });
            }
        });
        
        // Calculate stats
        const completedCount = milestones.filter(m => m.status === 'COMPLETED').length;
        const inProgressCount = milestones.filter(m => m.status === 'IN_PROGRESS').length;
        const notStartedCount = milestones.filter(m => m.status === 'NOT_STARTED').length;
        const totalCount = milestones.length;
        
        // Update the stats display
        const elements = {
            completed: document.getElementById('completed-milestones'),
            inProgress: document.getElementById('in-progress-milestones'),
            notStarted: document.getElementById('not-started-milestones'),
            total: document.getElementById('total-milestones')
        };
        
        if (elements.completed) elements.completed.textContent = completedCount;
        if (elements.inProgress) elements.inProgress.textContent = inProgressCount;
        if (elements.notStarted) elements.notStarted.textContent = notStartedCount;
        if (elements.total) elements.total.textContent = totalCount;
        
        // Calculate progress percentage
        const progressPercentage = Math.round((completedCount + (inProgressCount * 0.5)) / totalCount * 100);
        
        // Update progress bar
        const progressBar = document.querySelector('#progressDetailsModal .progress-bar');
        const progressDisplay = document.querySelector('#progressDetailsModal .progress-percentage-display');
        const progressBadge = document.getElementById('timeline-progress-badge');
        
        if (progressBar) {
            progressBar.style.width = `${progressPercentage}%`;
            progressBar.setAttribute('aria-valuenow', progressPercentage);
            progressBar.textContent = `${progressPercentage}%`;
        }
        
        if (progressDisplay) {
            progressDisplay.textContent = `${progressPercentage}%`;
        }
        
        if (progressBadge) {
            progressBadge.textContent = `${progressPercentage}%`;
            
            // Update badge color based on progress
            progressBadge.className = 'badge';
            if (progressPercentage < 25) {
                progressBadge.classList.add('bg-danger');
            } else if (progressPercentage < 50) {
                progressBadge.classList.add('bg-warning');
            } else if (progressPercentage < 75) {
                progressBadge.classList.add('bg-info');
            } else if (progressPercentage < 100) {
                progressBadge.classList.add('bg-primary');
            } else {
                progressBadge.classList.add('bg-success');
            }
        }
        
        // Update progress fill in the timeline visualization
        const progressFill = document.querySelector('.enhanced-timeline-progress-fill');
        if (progressFill) {
            progressFill.style.width = `${progressPercentage}%`;
        }
        
        // Update current position marker if it exists
        const currentPositionMarker = document.querySelector('.enhanced-current-position-marker');
        if (currentPositionMarker && inProgressCount > 0) {
            // Calculate the adjusted position
            const paddingPercentage = 10;
            const usableWidth = 100 - (paddingPercentage * 2);
            const adjustedProgressPosition = (progressPercentage * usableWidth / 100) + paddingPercentage;
            currentPositionMarker.style.left = `${adjustedProgressPosition}%`;
        }
    } catch (error) {
        console.warn('Error updating progress stats:', error);
    }
}

// Function to update quick progress removed as it's no longer needed

// Add event listener to progress bars to show the details modal
document.addEventListener('DOMContentLoaded', function() {
    // Add click event to progress bars
    document.querySelectorAll('.progress').forEach(progressBar => {
        progressBar.addEventListener('click', function() {
            const mentorshipId = this.closest('.accordion-collapse').id.replace('mentorship-', '');
            showProgressDetails(mentorshipId);
        });
        
        // Add tooltip to progress bars
        const tooltip = document.createElement('div');
        tooltip.className = 'progress-tooltip';
        tooltip.textContent = 'Click for detailed progress';
        progressBar.appendChild(tooltip);
    });
});

// Function to load all timeline milestones
function loadAllTimelineMilestones() {
    document.querySelectorAll('[id^="timeline-milestones-"]').forEach(function(container) {
        const mentorshipId = container.id.replace('timeline-milestones-', '');
        const timelineText = document.querySelector(`#mentorship-${mentorshipId} .timeline-text`);
        if (timelineText && timelineText.textContent) {
            updateEnhancedTimelineDisplay(mentorshipId, parseTimelineText(timelineText.textContent));
        }
    });
    
    // Step-based progress tracker code removed as requested
}

// Function to check if a mentorship is completed
function isMentorshipCompleted(mentorship) {
    // Consider a mentorship completed if progress is 100% or all milestones are completed
    return mentorship.progress_percentage >= 100;
}

// Function to move completed mentorships to the finished section
function organizeCompletedMentorships() {
    const activeMentorshipsContainer = document.querySelector('.active-mentorships');
    const finishedMentorshipsContainer = document.querySelector('.finished-mentorships-content');
    
    if (!activeMentorshipsContainer || !finishedMentorshipsContainer) return;
    
    // Check each mentorship
    document.querySelectorAll('.mentorship-item').forEach(function(mentorshipItem) {
        const mentorshipId = mentorshipItem.getAttribute('data-mentorship-id');
        const progressBar = mentorshipItem.querySelector('.progress-bar');
        
        if (progressBar) {
            const progressPercentage = parseInt(progressBar.getAttribute('aria-valuenow') || 0);
            
            // If progress is 100%, move to finished section
            if (progressPercentage >= 100) {
                // Clone the item to avoid removing event listeners
                const clonedItem = mentorshipItem.cloneNode(true);
                finishedMentorshipsContainer.appendChild(clonedItem);
                
                // Add a completed badge
                const badge = document.createElement('span');
                badge.className = 'badge bg-success ms-2';
                badge.textContent = 'Completed';
                clonedItem.querySelector('.mentorship-title').appendChild(badge);
                
                // Hide the original item
                mentorshipItem.style.display = 'none';
            }
        }
    });
    
    // Show the finished mentorships section if there are any
    if (finishedMentorshipsContainer.children.length > 0) {
        document.querySelector('.finished-mentorships').style.display = 'block';
    } else {
        document.querySelector('.finished-mentorships').style.display = 'none';
    }
}

// Toggle finished mentorships visibility
function toggleFinishedMentorships() {
    const content = document.querySelector('.finished-mentorships-content');
    const toggleButton = document.querySelector('.finished-mentorships-toggle');
    
    if (content.classList.contains('show')) {
        content.classList.remove('show');
        toggleButton.innerHTML = '<i class="fas fa-chevron-down"></i> Show';
    } else {
        content.classList.add('show');
        toggleButton.innerHTML = '<i class="fas fa-chevron-up"></i> Hide';
    }
}

// Function to parse timeline text into milestone objects
function parseTimelineText(timelineText) {
    if (!timelineText) return [];
    
    const lines = timelineText.split('\n');
    let milestones = [];
    let inAdditionalNotes = false;
    
    lines.forEach(line => {
        line = line.trim();
        if (!line) return;
        
        if (line.startsWith('Additional Notes:')) {
            inAdditionalNotes = true;
            return;
        }
        
        if (inAdditionalNotes) {
            return;
        }
        
        const weekDayMatch = line.match(/^Week\/Day\s+([^:]+):\s*(.+)$/);
        if (weekDayMatch) {
            const period = weekDayMatch[1];
            const description = weekDayMatch[2];
            
            // Extract status if available
            let status = 'NOT_STARTED';
            const statusMatch = description.match(/(.+)\s+\[([A-Z_]+)\]$/);
            const cleanDescription = statusMatch ? statusMatch[1].trim() : description;
            if (statusMatch) {
                status = statusMatch[2];
            }
            
            milestones.push({
                period: period,
                description: cleanDescription,
                status: status
            });
        }
    });
    
    return milestones;
}

// Function to initialize all progress bars
function initializeProgressBars() {
    document.querySelectorAll('.progress-bar').forEach(progressBar => {
        const percentage = progressBar.dataset.percentage || '0';
        progressBar.style.width = `${percentage}%`;
        progressBar.setAttribute('aria-valuenow', percentage);
        progressBar.textContent = `${percentage}%`;
    });

    document.querySelectorAll('.progress-bar-skill').forEach((skillBar, index) => {
        const proficiency = skillBar.dataset.skillProficiency || '0';
        skillBar.style.width = `${proficiency}%`;
        skillBar.style.backgroundColor = getSkillColor(index);
    });
}

// Function to get color for skill progress bars
function getSkillColor(index) {
    const colors = [
        '#4e73df', // Primary
        '#1cc88a', // Success
        '#36b9cc', // Info
        '#f6c23e', // Warning
        '#e74a3b'  // Danger
    ];
    return colors[index % colors.length];
}

// Function to setup error handling
function setupErrorHandling() {
    $(document).ajaxError(function(event, jqXHR, settings, error) {
        console.error('AJAX Error:', error);
        showToast('Error', 'An error occurred. Please try again.', 'error');
    });
}

// Function to initialize Bootstrap components
function initializeBootstrapComponents() {
    // Initialize tooltips
    const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    tooltips.forEach(tooltip => new bootstrap.Tooltip(tooltip));

    // Initialize popovers
    const popovers = document.querySelectorAll('[data-bs-toggle="popover"]');
    popovers.forEach(popover => new bootstrap.Popover(popover));
}

// Function to setup mutation observer
function setupMutationObserver() {
    const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            if (mutation.type === 'childList' || mutation.type === 'attributes') {
                initializeProgressBars();
            }
        });
    });

    const config = { 
        attributes: true, 
        childList: true, 
        subtree: true 
    };

    document.querySelectorAll('.progress').forEach(progress => {
        observer.observe(progress, config);
    });
}

// Function to update mentorship status
function updateMentorshipStatus(mentorshipId, newStatus) {
    // Show a confirmation modal with reason input
    const statusLabels = {
        'PAUSED': 'Pause',
        'APPROVED': 'Resume',
        'COMPLETED': 'Complete',
        'CANCELLED': 'Cancel'
    };
    
    const actionLabel = statusLabels[newStatus] || 'Update';
    
    // Create and show modal
    const modalHtml = `
        <div class="modal fade" id="updateStatusModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">${actionLabel} Mentorship</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
                    <div class="modal-body">
                        <p>Are you sure you want to ${actionLabel.toLowerCase()} this mentorship?</p>
                        <div class="mb-3">
                            <label for="statusReason" class="form-label">Reason (optional)</label>
                            <textarea class="form-control" id="statusReason" rows="3" placeholder="Please provide a reason for this status change..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="confirmStatusUpdate">Confirm</button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Remove any existing modal
    const existingModal = document.getElementById('updateStatusModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add the modal to the DOM
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Initialize the modal
    const modal = new bootstrap.Modal(document.getElementById('updateStatusModal'));
    modal.show();
    
    // Handle confirmation
    document.getElementById('confirmStatusUpdate').addEventListener('click', function() {
        const reason = document.getElementById('statusReason').value;
        
        // Send AJAX request to update status
    $.ajax({
            url: `/mentorship/api/update-mentorship-status/${mentorshipId}/`,
        type: 'POST',
            data: JSON.stringify({ 
                status: newStatus,
                reason: reason
            }),
            contentType: 'application/json',
        success: function(response) {
                modal.hide();
                showToast('success', response.message);
                
                // Update UI based on the new status
                const mentorshipItem = document.querySelector(`.mentorship-item[data-mentorship-id="${mentorshipId}"]`);
                if (mentorshipItem) {
                    const statusBadge = mentorshipItem.querySelector('.badge');
                    if (statusBadge) {
                        // Update badge text and class
                        statusBadge.textContent = newStatus.charAt(0) + newStatus.slice(1).toLowerCase();
                        
                        // Remove existing status classes
                        statusBadge.classList.remove('bg-primary', 'bg-warning', 'bg-success', 'bg-danger');
                        
                        // Add appropriate class based on status
                        if (newStatus === 'PAUSED') {
                            statusBadge.classList.add('bg-warning');
                        } else if (newStatus === 'COMPLETED') {
                            statusBadge.classList.add('bg-success');
                            
                            // Move to finished mentorships section if completed or cancelled
                            const finishedSection = document.querySelector('.finished-mentorships-content');
                            if (finishedSection && (newStatus === 'COMPLETED' || newStatus === 'CANCELLED')) {
                                finishedSection.appendChild(mentorshipItem);
                                
                                // Show the finished mentorships section if it was hidden
                                document.querySelector('.finished-mentorships').style.display = 'block';
                            }
                        } else if (newStatus === 'CANCELLED') {
                            statusBadge.classList.add('bg-danger');
                            
                            // Move to finished mentorships section if completed or cancelled
                            const finishedSection = document.querySelector('.finished-mentorships-content');
                            if (finishedSection && (newStatus === 'COMPLETED' || newStatus === 'CANCELLED')) {
                                finishedSection.appendChild(mentorshipItem);
                                
                                // Show the finished mentorships section if it was hidden
                                document.querySelector('.finished-mentorships').style.display = 'block';
                            }
                        } else {
                            statusBadge.classList.add('bg-primary');
                        }
                    }
                    
                    // Update dropdown options based on new status
                    const dropdownMenu = mentorshipItem.querySelector('.dropdown-menu');
                    if (dropdownMenu) {
                        if (newStatus === 'PAUSED') {
                            dropdownMenu.innerHTML = `
                                <li><a class="dropdown-item" href="#" onclick="updateMentorshipStatus('${mentorshipId}', 'APPROVED')"><i class="fas fa-play me-2"></i> Resume Mentorship</a></li>
                                <li><a class="dropdown-item" href="#" onclick="updateMentorshipStatus('${mentorshipId}', 'COMPLETED')"><i class="fas fa-check-circle me-2"></i> Complete Mentorship</a></li>
                                <li><a class="dropdown-item" href="#" onclick="updateMentorshipStatus('${mentorshipId}', 'CANCELLED')"><i class="fas fa-times-circle me-2"></i> Cancel Mentorship</a></li>
                            `;
                        } else if (newStatus === 'APPROVED') {
                            dropdownMenu.innerHTML = `
                                <li><a class="dropdown-item" href="#" onclick="updateMentorshipStatus('${mentorshipId}', 'PAUSED')"><i class="fas fa-pause me-2"></i> Pause Mentorship</a></li>
                                <li><a class="dropdown-item" href="#" onclick="updateMentorshipStatus('${mentorshipId}', 'COMPLETED')"><i class="fas fa-check-circle me-2"></i> Complete Mentorship</a></li>
                                <li><a class="dropdown-item" href="#" onclick="updateMentorshipStatus('${mentorshipId}', 'CANCELLED')"><i class="fas fa-times-circle me-2"></i> Cancel Mentorship</a></li>
                            `;
                        }
                    }
                }
                
                // Reload the page if completed or cancelled to refresh the mentorship lists
                if (newStatus === 'COMPLETED' || newStatus === 'CANCELLED') {
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                }
            },
            error: function(xhr) {
                console.error('Error updating mentorship status:', xhr);
                showToast('error', xhr.responseJSON?.error || 'Failed to update mentorship status');
            }
        });
    });
}

// ... existing code ...
</script>

<!-- Timeline Modal -->
<div class="modal fade" id="timelineModal" tabindex="-1" aria-labelledby="timelineModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="timelineModalLabel">
                    <i class="fas fa-calendar-alt me-2"></i>Set Mentorship Timeline
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <form id="timelineForm">
                    <input type="hidden" id="mentorshipIdForTimeline">
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card shadow-sm border-0 h-100">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">
                                        <i class="fas fa-calendar-check me-2 text-primary"></i>Timeline Period
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <label for="expectedEndDate" class="form-label">Expected End Date</label>
                                    <div class="input-group mb-3">
                                        <span class="input-group-text bg-primary text-white">
                                            <i class="fas fa-flag-checkered"></i>
                                        </span>
                                        <input type="date" class="form-control form-control-lg" id="expectedEndDate" required onchange="calculateMentoringDays()">
                                    </div>
                                    <div class="form-text">Set the target date for completing this mentorship</div>
                                    <div id="mentoringDaysInfo" class="mt-3 alert alert-info d-flex align-items-center">
                                        <i class="fas fa-info-circle me-3 fs-4"></i>
                                        <span id="totalDaysText" class="fw-bold"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card shadow-sm border-0 h-100">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">
                                        <i class="fas fa-clipboard-list me-2 text-primary"></i>Predefined Templates
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <label for="templateSelector" class="form-label">Select a Template</label>
                                    <div class="input-group mb-3">
                                        <select class="form-select form-select-lg" id="templateSelector">
                                            <option value="" selected>Select a template (optional)</option>
                                            <option value="technical-8-week">8-Week Technical Mentorship</option>
                                            <option value="career-12-week">12-Week Career Development</option>
                                            <option value="research-project">Research Project Mentorship</option>
                                            <option value="startup-mentoring">Startup Mentoring</option>
                                            <option value="leadership-development">Leadership Development</option>
                                        </select>
                                        <button class="btn btn-primary px-4" type="button" id="applyTemplateBtn">
                                            <i class="fas fa-check me-2"></i>Apply
                                        </button>
                                    </div>
                                    <div class="form-text">Choose a template to automatically populate milestones based on best practices</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card shadow-sm border-0 mb-4">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="fas fa-map-marker-alt me-2 text-primary"></i>Timeline Milestones
                            </h6>
                            <button type="button" class="btn btn-primary btn-sm" id="add-milestone-btn">
                                <i class="fas fa-plus me-1"></i> Add Milestone
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="timeline-alert" class="alert alert-danger d-none">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <span id="timeline-alert-message"></span>
                            </div>
                            
                            <div id="milestones-container">
                                <!-- Milestone entries will be dynamically added here -->
                            </div>
                            
                            <!-- Hidden template for new milestone rows -->
                            <table id="milestone-template-table" style="display: none;">
                                <tbody>
                                    <tr class="milestone-row row mb-3 pb-3 border-bottom align-items-center">
                                        <td class="col-md-2">
                                            <label class="form-label d-md-none">Week/Day:</label>
                                            <input type="text" class="form-control milestone-period" placeholder="1-2" required>
                                        </td>
                                        <td class="col-md-3">
                                            <label class="form-label d-md-none">Date:</label>
                                            <div class="input-group">
                                                <input type="date" class="form-control milestone-date" onchange="validateMilestoneDate(this)">
                                                <span class="input-group-text date-toggle" onclick="toggleDateDisplay(this)">
                                                    <i class="fas fa-calendar-alt"></i>
                                                </span>
                                            </div>
                                        </td>
                                        <td class="col-md-6">
                                            <label class="form-label d-md-none">Description:</label>
                                            <input type="text" class="form-control milestone-description" placeholder="Milestone description" required>
                                        </td>
                                        <td class="col-md-1 text-center">
                                            <button type="button" class="btn btn-outline-danger remove-milestone-btn mt-md-0 mt-2">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="card shadow-sm border-0 mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="fas fa-sticky-note me-2 text-primary"></i>Additional Notes
                            </h6>
                        </div>
                        <div class="card-body">
                            <textarea class="form-control" id="timelineMilestones" rows="3" placeholder="Any additional notes or details about the timeline"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer bg-light justify-content-between">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary btn-lg px-4" id="saveTimeline" onclick="submitTimeline()">
                    <i class="fas fa-save me-2"></i>Save Timeline
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Update the initializeMilestoneButtons function to work with the new table layout
function initializeMilestoneButtons() {
    const addMilestoneBtn = document.getElementById('add-milestone-btn');
    if (addMilestoneBtn) {
        addMilestoneBtn.addEventListener('click', function() {
            const milestonesContainer = document.getElementById('milestones-container');
            const templateTable = document.getElementById('milestone-template-table');
            
            if (templateTable) {
                const templateRow = templateTable.querySelector('tr').cloneNode(true);
                
                // Add to the table
                milestonesContainer.appendChild(templateRow);
                
                // Add event listener to the remove button
                const removeBtn = templateRow.querySelector('.remove-milestone-btn');
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        const milestoneEntry = this.closest('.milestone-entry');
                        if (milestoneEntry && milestoneEntry.parentNode) {
                            // Check if this is the last milestone entry
                            const allEntries = milestonesContainer.querySelectorAll('.milestone-entry');
                            if (allEntries.length === 1) {
                                // If it's the last one, just clear the inputs instead of removing
                                const periodInput = milestoneEntry.querySelector('.milestone-period');
                                const descriptionInput = milestoneEntry.querySelector('.milestone-description');
                                const dateInput = milestoneEntry.querySelector('.milestone-date');
                                
                                if (periodInput) periodInput.value = '';
                                if (descriptionInput) descriptionInput.value = '';
                                if (dateInput) {
                                    dateInput.value = '';
                                    dateInput.classList.remove('is-invalid');
                                }
                            } else {
                                // Otherwise remove it
                                milestoneEntry.parentNode.removeChild(milestoneEntry);
                            }
                            
                            // Re-validate after changes
                            validateAllMilestoneDates();
                        }
                    });
                }
            } else {
                console.error("Template table not found");
            }
        });
    }
    
    // Add event listeners to existing remove buttons
    document.querySelectorAll('.remove-milestone-btn').forEach(button => {
        button.addEventListener('click', function() {
            const milestoneEntry = this.closest('.milestone-entry');
            const milestonesContainer = document.getElementById('milestones-container');
            
            if (milestoneEntry && milestoneEntry.parentNode) {
                // Check if this is the last milestone entry
                const allEntries = milestonesContainer.querySelectorAll('.milestone-entry');
                if (allEntries.length === 1) {
                    // If it's the last one, just clear the inputs instead of removing
                    const periodInput = milestoneEntry.querySelector('.milestone-period');
                    const descriptionInput = milestoneEntry.querySelector('.milestone-description');
                    const dateInput = milestoneEntry.querySelector('.milestone-date');
                    
                    if (periodInput) periodInput.value = '';
                    if (descriptionInput) descriptionInput.value = '';
                    if (dateInput) {
                        dateInput.value = '';
                        dateInput.classList.remove('is-invalid');
                    }
                } else {
                    // Otherwise remove it
                    milestoneEntry.parentNode.removeChild(milestoneEntry);
                }
                
                // Re-validate after changes
                validateAllMilestoneDates();
            }
        });
    });
}

// Function to apply a milestone template - updated for table layout
function applyMilestoneTemplate(templateId) {
    const template = milestoneTemplates[templateId];
    if (!template) {
        showToast('error', 'Template not found');
        return;
    }
    
    // Get end date to calculate milestone dates
    const expectedEndDateInput = document.getElementById('expectedEndDate');
    if (!expectedEndDateInput || !expectedEndDateInput.value) {
        // If end date is not set, set it automatically based on template
        setExpectedEndDateFromTemplate(templateId);
        
        if (!expectedEndDateInput.value) {
            showToast('warning', 'Could not set expected end date');
            return;
        }
    }
    
    // Clear existing milestones
    const milestonesContainer = document.getElementById('milestones-container');
    milestonesContainer.innerHTML = '';
    
    // Calculate dates based on the timeline span
    // Start from TOMORROW instead of today
    const startDate = new Date();
    startDate.setDate(startDate.getDate() + 1); // Add 1 day to get tomorrow
    startDate.setHours(0, 0, 0, 0);
    
    const endDate = new Date(expectedEndDateInput.value);
    endDate.setHours(0, 0, 0, 0);
    
    // Calculate total duration in days
    const totalDuration = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24));
    
    // Get the template's original duration
    const templateDuration = getTemplateDuration(templateId) - 7; // Subtract the buffer we added
    
    // Apply template milestones
    template.forEach((milestone, index) => {
        // Calculate adjusted day offset based on the actual timeline duration
        let adjustedDayOffset;
        
        if (templateDuration <= 0) {
            // Fallback: Distribute evenly if template duration is invalid
            adjustedDayOffset = Math.floor((totalDuration * index) / (template.length - 1));
        } else {
            // Scale the day offset proportionally to fit the actual timeline
            const scaleFactor = totalDuration / templateDuration;
            adjustedDayOffset = Math.floor(milestone.days * scaleFactor);
        }
        
        // Calculate milestone date
        const milestoneDate = new Date(startDate);
        milestoneDate.setDate(milestoneDate.getDate() + adjustedDayOffset);
        
        // Make sure the date doesn't exceed the end date
        const finalDate = milestoneDate > endDate ? endDate : milestoneDate;
        
        // Format date for the input
        const formattedDate = finalDate.toISOString().split('T')[0]; // YYYY-MM-DD format
        
        // Create new milestone entry - for the table layout
        const newRow = document.createElement('tr');
        newRow.className = 'milestone-entry';
        newRow.innerHTML = `
            <td style="width: 12%">
                <input type="text" class="form-control form-control-sm milestone-period" placeholder="1-2" required value="${milestone.period}">
            </td>
            <td style="width: 18%">
                <div class="input-group">
                    <input type="date" class="form-control form-control-sm milestone-date" onchange="validateMilestoneDate(this)" value="${formattedDate}">
                    <span class="input-group-text date-toggle" onclick="toggleDateDisplay(this)">
                        <i class="fas fa-calendar-alt"></i>
                    </span>
                </div>
            </td>
            <td style="width: 60%">
                <input type="text" class="form-control form-control-sm milestone-description" placeholder="Milestone description" required value="${milestone.description}">
            </td>
            <td style="width: 10%; text-align: center;">
                <button type="button" class="btn btn-outline-danger btn-sm remove-milestone-btn">
                    <i class="fas fa-times"></i>
                </button>
            </td>
        `;
        milestonesContainer.appendChild(newRow);
        
        // Add event listener to the remove button
        const removeBtn = newRow.querySelector('.remove-milestone-btn');
        removeBtn.addEventListener('click', function() {
            if (milestonesContainer.querySelectorAll('.milestone-entry').length > 1) {
                milestonesContainer.removeChild(newRow);
            } else {
                // Clear inputs if it's the last one
                const periodInput = newRow.querySelector('.milestone-period');
                const descriptionInput = newRow.querySelector('.milestone-description');
                const dateInput = newRow.querySelector('.milestone-date');
                
                if (periodInput) periodInput.value = '';
                if (descriptionInput) descriptionInput.value = '';
                if (dateInput) {
                    dateInput.value = '';
                    dateInput.classList.remove('is-invalid');
                }
            }
            validateAllMilestoneDates();
        });
    });
    
    // Validate all milestone dates
    validateAllMilestoneDates();
    
    showToast('success', `Applied ${template.length} milestones from template`);
}

// Ensure mentoringDaysInfo is visible by default
document.addEventListener('DOMContentLoaded', function() {
    // Update modal visibility handling
    const timelineModal = document.getElementById('timelineModal');
    if (timelineModal) {
        timelineModal.addEventListener('shown.bs.modal', function() {
            // Make info visible by default
            const mentoringDaysInfo = document.getElementById('mentoringDaysInfo');
            if (mentoringDaysInfo) {
                mentoringDaysInfo.classList.remove('d-none');
                // Set initial text if no date is selected
                if (!document.getElementById('expectedEndDate').value) {
                    document.getElementById('totalDaysText').textContent = 'Select an end date to see mentoring duration';
                }
            }
            
            // Calculate and show mentoring days if end date is already set
            calculateMentoringDays();
            
            // Validate all milestone dates
            setTimeout(validateAllMilestoneDates, 100);
        });
    }
});
</script>

<!-- Meeting Modal -->
<div class="modal fade" id="meetingModal" tabindex="-1" aria-labelledby="meetingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="meetingModalLabel">Schedule Meeting</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="meetingForm">
                    <input type="hidden" id="mentorshipIdForMeeting">
                    
                    <div class="mb-3">
                        <label for="meetingTitle" class="form-label">Meeting Title</label>
                        <input type="text" class="form-control" id="meetingTitle" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="meetingDate" class="form-label">Date & Time</label>
                        <input type="datetime-local" class="form-control" id="meetingDate" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="meetingLink" class="form-label"><i class="fas fa-video me-1"></i> Meeting Link</label>
                        <input type="url" class="form-control" id="meetingLink" placeholder="https://meet.google.com/... or https://zoom.us/..." required>
                        <div class="form-text">
                            Add a video call link (Zoom, Google Meet, etc.) that mentees can click to join the meeting directly.
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="meetingDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="meetingDescription" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitMeeting()">Schedule</button>
            </div>
        </div>
    </div>
</div>

<!-- Message Modal -->
<div class="modal fade" id="messageModal" tabindex="-1" aria-labelledby="messageModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="messageModalLabel">Send Message</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="messageForm">
                    <input type="hidden" id="mentorshipIdForMessage">
                    
                    <div class="mb-3">
                        <label for="messageContent" class="form-label">Message</label>
                        <textarea class="form-control" id="messageContent" rows="5" required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="messageAttachment" class="form-label">Attachment (optional)</label>
                        <input type="file" class="form-control" id="messageAttachment">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitMessage()">Send</button>
            </div>
        </div>
    </div>
</div>

<!-- Progress Modal -->
<div class="modal fade" id="progressModal" tabindex="-1" aria-labelledby="progressModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="progressModalLabel">Update Progress</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="progressForm">
                    <input type="hidden" id="mentorshipIdForProgress">
                    
                    <div class="mb-3">
                        <label for="progressTitle" class="form-label">Progress Title</label>
                        <input type="text" class="form-control" id="progressTitle" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="progressDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="progressDescription" rows="3" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitProgress()">Save Progress</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Styles -->
<style>
.toast-container {
    z-index: 9999; /* Increased from 1050 to ensure it's always on top */
}

.toast {
    min-width: 250px;
}

.toast-success {
    background-color: #d4edda;
    border-color: #c3e6cb;
    color: #155724;
}

.toast-error {
    background-color: #f8d7da;
    border-color: #f5c6cb;
    color: #721c24;
}

.toast-success .toast-header {
    background-color: #c3e6cb;
    color: #155724;
}

.toast-error .toast-header {
    background-color: #f5c6cb;
    color: #721c24;
}

/* Loading indicator styles */
.loading-spinner-container {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 38px; /* Standard height of a form-select element */
    background-color: rgba(255, 255, 255, 0.8);
    border-radius: 0.25rem;
}

/* Success and error highlight styles for form elements */
.border-success {
    border-color: #28a745 !important;
    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25) !important;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.border-danger {
    border-color: #dc3545 !important;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}
</style>

<!-- Timeline Status Modal -->
<div class="modal fade timeline-status-modal" id="timelineStatusModal" tabindex="-1" aria-labelledby="timelineStatusModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="timelineStatusModalLabel">Update Timeline Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="timelineStatusForm">
                    <input type="hidden" id="mentorshipIdForStatus">
                    
                    <div id="milestone-status-container">
                        <!-- Milestone status items will be loaded here -->
                        <div class="text-center py-3 text-muted" id="no-milestones-message">
                            <i class="fas fa-info-circle me-2"></i>No milestones found. Please set up a timeline first.
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveTimelineStatus()">Save Status</button>
            </div>
        </div>
    </div>
</div>

<!-- Progress Details Modal -->
<div class="modal fade" id="progressDetailsModal" tabindex="-1" aria-labelledby="progressDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="progressDetailsModalLabel">Mentorship Progress Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="progress-details-container">
                            <div class="progress-overview mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0">Overall Progress</h6>
                                    <span class="progress-percentage-display fs-4 fw-bold text-primary">0%</span>
                                </div>
                                <div class="progress progress-lg" style="height: 25px;">
                                    <div class="progress-bar progress-bar-animated progress-bar-striped bg-primary" 
                                         role="progressbar" style="width: 0%;" 
                                         aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                </div>
                            </div>
                            
                            <div class="progress-stats row text-center mb-4">
                                <div class="col-md-3">
                                    <div class="progress-stat-card bg-light p-3 rounded">
                                        <div class="stat-icon mb-2"><i class="fas fa-calendar-check text-success"></i></div>
                                        <div class="stat-value" id="completed-milestones">0</div>
                                        <div class="stat-label">Completed</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="progress-stat-card bg-light p-3 rounded">
                                        <div class="stat-icon mb-2"><i class="fas fa-spinner text-warning"></i></div>
                                        <div class="stat-value" id="in-progress-milestones">0</div>
                                        <div class="stat-label">In Progress</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="progress-stat-card bg-light p-3 rounded">
                                        <div class="stat-icon mb-2"><i class="fas fa-hourglass-start text-secondary"></i></div>
                                        <div class="stat-value" id="not-started-milestones">0</div>
                                        <div class="stat-label">Not Started</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="progress-stat-card bg-light p-3 rounded">
                                        <div class="stat-icon mb-2"><i class="fas fa-tasks text-primary"></i></div>
                                        <div class="stat-value" id="total-milestones">0</div>
                                        <div class="stat-label">Total Milestones</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="timeline-visualization mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>Timeline Visualization</h6>
                                    <span class="badge bg-primary" id="timeline-progress-badge">0%</span>
                                </div>
                                <p class="text-muted small mb-3">Track your mentorship progress through milestones. Click on any milestone for details.</p>
                                <div class="timeline-visual-container" id="timeline-visual-container">
                                    <!-- Timeline visualization will be rendered here -->
                                </div>
                            </div>
                            
                            <div class="milestone-list">
                                <h6>Milestones</h6>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Period</th>
                                                <th>Description</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="milestone-table-body">
                                            <!-- Milestone rows will be added here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Update Overall Progress section and Quick Note feature removed as requested -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                <!-- Update Progress and Update Milestones buttons removed as requested -->
            </div>
        </div>
    </div>
</div>

<!-- Progress Bar Tooltip/Popover Styles -->
<style>
/* Progress Bar Styles */
.progress {
    cursor: pointer;
    transition: all 0.3s ease;
    overflow: visible;
}

.progress:hover {
    box-shadow: 0 0 10px rgba(0,123,255,0.5);
}

.progress-bar {
    position: relative;
}

/* Progress Tooltip */
.progress-tooltip {
    position: absolute;
    top: -40px;
    right: 0;
    background-color: #343a40;
    color: white;
    padding: 5px 10px;
    border-radius: 4px;
    font-size: 0.8rem;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s;
    z-index: 1000;
    white-space: nowrap;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

.progress-tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    margin-left: -5px;
    border-width: 5px;
    border-style: solid;
    border-color: #343a40 transparent transparent transparent;
}

.progress:hover .progress-tooltip {
    opacity: 1;
    visibility: visible;
}

/* Progress Details Modal Styles */
.progress-lg {
    height: 25px !important;
    border-radius: 15px;
    overflow: hidden;
}

.progress-lg .progress-bar {
    line-height: 25px;
    font-weight: bold;
}

.progress-stat-card {
    transition: all 0.3s ease;
    border: 1px solid #dee2e6;
}

.progress-stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.stat-value {
    font-size: 1.8rem;
    font-weight: bold;
}

.timeline-visual-container {
    height: 150px;
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 15px 30px; /* Increased horizontal padding */
    position: relative;
    overflow: visible;
    margin: 15px 0 45px; /* Increased bottom margin to accommodate labels */
    border: 1px solid rgba(0,0,0,0.05);
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}

.milestone-marker {
    position: absolute;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    top: 50%;
    transform: translateY(-50%);
    cursor: pointer;
    transition: all 0.3s ease;
    z-index: 2;
}

.milestone-marker.not-started {
    background-color: #6c757d;
    border: 2px solid #fff;
}

.milestone-marker.in-progress {
    background-color: #ffc107;
    border: 2px solid #fff;
}

.milestone-marker.completed {
    background-color: #28a745;
    border: 2px solid #fff;
}

.milestone-marker:hover {
    transform: translateY(-50%) scale(1.2);
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
}

.milestone-line {
    position: absolute;
    height: 4px;
    background-color: #dee2e6;
    top: 50%;
    transform: translateY(-50%);
    z-index: 1;
    left: 0;
    right: 0;
}

.milestone-progress-fill {
    position: absolute;
    height: 4px;
    background: linear-gradient(90deg, #4481eb 0%, #04befe 100%);
    top: 50%;
    transform: translateY(-50%);
    z-index: 1;
    left: 0;
    width: 0%;
    transition: width 1s ease;
}

.milestone-tooltip {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background-color: #343a40;
    color: white;
    padding: 5px 10px;
    border-radius: 4px;
    font-size: 0.8rem;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s;
    z-index: 1000;
    white-space: nowrap;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    pointer-events: none;
}

.milestone-tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    margin-left: -5px;
    border-width: 5px;
    border-style: solid;
    border-color: #343a40 transparent transparent transparent;
}

.milestone-marker:hover .milestone-tooltip {
    opacity: 1;
    visibility: visible;
}

.timeline-status-badge {
    display: inline-block;
    padding: 0.25em 0.6em;
    font-size: 0.75em;
    font-weight: 700;
    line-height: 1;
    text-align: center;
    white-space: nowrap;
    vertical-align: baseline;
    border-radius: 0.25rem;
}

.timeline-status-badge.not-started {
    background-color: #6c757d;
    color: white;
}

.timeline-status-badge.in-progress {
    background-color: #ffc107;
    color: #212529;
}

.timeline-status-badge.completed {
    background-color: #28a745;
    color: white;
}
</style>

<!-- Schedule Meeting Modal -->
<div class="modal fade" id="scheduleMeetingModal" tabindex="-1" aria-labelledby="scheduleMeetingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="scheduleMeetingModalLabel">Schedule Meeting</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="scheduleMeetingForm" onsubmit="submitScheduleMeeting(event); return false;">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" id="mentorshipIdInput" name="mentorship_id">
                    <div class="mb-3">
                        <label for="meetingTitle" class="form-label">Meeting Title</label>
                        <input type="text" class="form-control" id="meetingTitle" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="meetingDate" class="form-label">Date & Time</label>
                        <input type="datetime-local" class="form-control" id="meetingDate" name="meeting_date" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="meetingLink" class="form-label">Meeting Link (optional)</label>
                        <input type="url" class="form-control" id="meetingLink" name="meeting_link" placeholder="https://meet.google.com/...">
                    </div>
                    <div class="mb-3">
                        <label for="meetingAgenda" class="form-label">Agenda</label>
                        <textarea class="form-control" id="meetingAgenda" name="agenda" rows="3" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Schedule Meeting</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Send Message Modal -->
<div class="modal fade" id="sendMessageModal" tabindex="-1" aria-labelledby="sendMessageModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="sendMessageModalLabel">Send Message</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="sendMessageForm" action="{% url 'mentorship:send_message' %}" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" id="messageRecipientId" name="recipient_id">
                    <div class="mb-3">
                        <label for="messageSubject" class="form-label">Subject</label>
                        <input type="text" class="form-control" id="messageSubject" name="subject" required>
                    </div>
                    <div class="mb-3">
                        <label for="messageContent" class="form-label">Message</label>
                        <textarea class="form-control" id="messageContent" name="content" rows="5" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-info text-white">Send Message</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div id="toast-container" class="toast-container position-fixed bottom-0 end-0 p-3"></div>

<!-- Template Handling Script -->
<script>
// Define predefined milestone templates
const milestoneTemplates = {
    'technical-8-week': [
        { period: '1', description: 'Introduction and skills assessment', days: 0 },
        { period: '2', description: 'Core concept review and learning path setup', days: 7 },
        { period: '3-4', description: 'Hands-on practice with fundamental skills', days: 14 },
        { period: '5', description: 'Mid-point assessment and progress review', days: 28 },
        { period: '6-7', description: 'Advanced topics and project implementation', days: 35 },
        { period: '8', description: 'Final review and future development planning', days: 49 }
    ],
    'career-12-week': [
        { period: '1', description: 'Career goals assessment and planning', days: 0 },
        { period: '2-3', description: 'Resume and portfolio enhancement', days: 7 },
        { period: '4-5', description: 'Personal branding and networking strategies', days: 21 },
        { period: '6', description: 'Mid-point review and strategy adjustment', days: 35 },
        { period: '7-8', description: 'Interview preparation and practice', days: 42 },
        { period: '9-10', description: 'Job search strategies and application process', days: 56 },
        { period: '11-12', description: 'Final assessment and long-term career planning', days: 70 }
    ],
    'research-project': [
        { period: '1', description: 'Research question definition and literature review', days: 0 },
        { period: '2', description: 'Methodology selection and planning', days: 7 },
        { period: '3-4', description: 'Data collection preparation', days: 14 },
        { period: '5-6', description: 'Data collection implementation', days: 28 },
        { period: '7-8', description: 'Data analysis', days: 42 },
        { period: '9', description: 'Results interpretation', days: 56 },
        { period: '10', description: 'Report/paper writing', days: 63 },
        { period: '11-12', description: 'Presentation preparation and delivery', days: 70 }
    ],
    'startup-mentoring': [
        { period: '1', description: 'Business idea validation and market research', days: 0 },
        { period: '2', description: 'Target audience and customer persona development', days: 7 },
        { period: '3', description: 'Business model canvas creation', days: 14 },
        { period: '4-5', description: 'MVP (Minimum Viable Product) planning', days: 21 },
        { period: '6-7', description: 'MVP development and testing', days: 35 },
        { period: '8', description: 'Initial marketing strategy', days: 49 },
        { period: '9-10', description: 'Funding options and pitch deck preparation', days: 56 },
        { period: '11-12', description: 'Launch strategy and growth planning', days: 70 }
    ],
    'leadership-development': [
        { period: '1', description: 'Leadership style assessment and strengths identification', days: 0 },
        { period: '2-3', description: 'Communication and interpersonal skills development', days: 7 },
        { period: '4', description: 'Team management and delegation strategies', days: 21 },
        { period: '5-6', description: 'Conflict resolution and problem solving', days: 28 },
        { period: '7', description: 'Emotional intelligence in leadership', days: 42 },
        { period: '8-9', description: 'Strategic thinking and decision making', days: 49 },
        { period: '10-11', description: 'Change management and organizational development', days: 63 },
        { period: '12', description: 'Personal leadership vision and ongoing growth plan', days: 77 }
    ]
};

// Function to get template duration in days
function getTemplateDuration(templateId) {
    const template = milestoneTemplates[templateId];
    if (!template || template.length === 0) return 0;
    
    // Find the milestone with the highest day value
    let maxDays = 0;
    template.forEach(milestone => {
        if (milestone.days > maxDays) {
            maxDays = milestone.days;
        }
    });
    
    // Add 7 days buffer to the end for final wrap-up
    return maxDays + 7;
}

// Function to set the expected end date based on template
function setExpectedEndDateFromTemplate(templateId) {
    const duration = getTemplateDuration(templateId);
    if (duration <= 0) return;
    
    const expectedEndDateInput = document.getElementById('expectedEndDate');
    if (!expectedEndDateInput) return;
    
    // Calculate end date as today + duration days
    const endDate = new Date();
    endDate.setDate(endDate.getDate() + duration);
    
    // Format the date for the input field (YYYY-MM-DD)
    const formattedDate = endDate.toISOString().split('T')[0];
    expectedEndDateInput.value = formattedDate;
    
    // Update the mentoring days display
    calculateMentoringDays();
}

// Function to apply a milestone template
function applyMilestoneTemplate(templateId) {
    const template = milestoneTemplates[templateId];
    if (!template) {
        showToast('error', 'Template not found');
        return;
    }
    
    // Get end date to calculate milestone dates
    const expectedEndDateInput = document.getElementById('expectedEndDate');
    if (!expectedEndDateInput || !expectedEndDateInput.value) {
        // If end date is not set, set it automatically based on template
        setExpectedEndDateFromTemplate(templateId);
        
        if (!expectedEndDateInput.value) {
            showToast('warning', 'Could not set expected end date');
            return;
        }
    }
    
    // Clear existing milestones
    const milestonesContainer = document.getElementById('milestones-container');
    milestonesContainer.innerHTML = '';
    
    // Calculate dates based on the timeline span
    // Start from TOMORROW instead of today
    const startDate = new Date();
    startDate.setDate(startDate.getDate() + 1); // Add 1 day to get tomorrow
    startDate.setHours(0, 0, 0, 0);
    
    const endDate = new Date(expectedEndDateInput.value);
    endDate.setHours(0, 0, 0, 0);
    
    // Calculate total duration in days
    const totalDuration = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24));
    
    // Get the template's original duration
    const templateDuration = getTemplateDuration(templateId) - 7; // Subtract the buffer we added
    
    // Apply template milestones
    template.forEach((milestone, index) => {
        // Calculate adjusted day offset based on the actual timeline duration
        let adjustedDayOffset;
        
        if (templateDuration <= 0) {
            // Fallback: Distribute evenly if template duration is invalid
            adjustedDayOffset = Math.floor((totalDuration * index) / (template.length - 1));
        } else {
            // Scale the day offset proportionally to fit the actual timeline
            const scaleFactor = totalDuration / templateDuration;
            adjustedDayOffset = Math.floor(milestone.days * scaleFactor);
        }
        
        // Calculate milestone date
        const milestoneDate = new Date(startDate);
        milestoneDate.setDate(milestoneDate.getDate() + adjustedDayOffset);
        
        // Make sure the date doesn't exceed the end date
        const finalDate = milestoneDate > endDate ? endDate : milestoneDate;
        
        // Format date for the input
        const formattedDate = finalDate.toISOString().split('T')[0]; // YYYY-MM-DD format
        
        // Create new milestone entry
        const newMilestone = document.createElement('div');
        newMilestone.className = 'milestone-entry mb-3';
        newMilestone.innerHTML = `
            <div class="row g-2">
                <div class="col">
                    <div class="input-group">
                        <span class="input-group-text">Week/Day</span>
                        <input type="text" class="form-control milestone-period" placeholder="1-2" required value="${milestone.period}">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="input-group">
                        <input type="date" class="form-control milestone-date" onchange="validateMilestoneDate(this)" value="${formattedDate}">
                        <span class="input-group-text date-toggle" onclick="toggleDateDisplay(this)">
                            <i class="fas fa-calendar-alt"></i>
                        </span>
                    </div>
                </div>
                <div class="col-md-6">
                    <input type="text" class="form-control milestone-description" placeholder="Introduction and goal setting" required value="${milestone.description}">
                </div>
                <div class="col-md-1 text-center">
                    <button type="button" class="btn btn-outline-danger remove-milestone-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        `;
        milestonesContainer.appendChild(newMilestone);
        
        // Add event listener to the remove button
        const removeBtn = newMilestone.querySelector('.remove-milestone-btn');
        removeBtn.addEventListener('click', function() {
            if (milestonesContainer.querySelectorAll('.milestone-entry').length > 1) {
                milestonesContainer.removeChild(newMilestone);
            } else {
                // Clear inputs if it's the last one
                const periodInput = newMilestone.querySelector('.milestone-period');
                const descriptionInput = newMilestone.querySelector('.milestone-description');
                const dateInput = newMilestone.querySelector('.milestone-date');
                
                if (periodInput) periodInput.value = '';
                if (descriptionInput) descriptionInput.value = '';
                if (dateInput) {
                    dateInput.value = '';
                    dateInput.classList.remove('is-invalid');
                }
            }
            validateAllMilestoneDates();
        });
    });
    
    // Validate all milestone dates
    validateAllMilestoneDates();
    
    showToast('success', `Applied ${template.length} milestones from template`);
}

// Add initialization for the template apply button
document.addEventListener('DOMContentLoaded', function() {
    // Initialize template selector to update expected end date on change
    const templateSelector = document.getElementById('templateSelector');
    if (templateSelector) {
        templateSelector.addEventListener('change', function() {
            if (this.value) {
                setExpectedEndDateFromTemplate(this.value);
            }
        });
    }
    
    // Initialize apply template button
    const applyTemplateBtn = document.getElementById('applyTemplateBtn');
    if (applyTemplateBtn) {
        applyTemplateBtn.addEventListener('click', function() {
            const templateSelector = document.getElementById('templateSelector');
            if (templateSelector && templateSelector.value) {
                applyMilestoneTemplate(templateSelector.value);
            } else {
                showToast('warning', 'Please select a template first');
            }
        });
    }
});
</script>

<!-- Find the script section for timeline handling and add these functions -->
<script>
// Function to add a new milestone
function addNewMilestone() {
    const milestonesContainer = document.getElementById('milestones-container');
    
    const milestoneRow = document.createElement('div');
    milestoneRow.className = 'milestone-row row mb-3 pb-3 border-bottom align-items-center';
    
    milestoneRow.innerHTML = `
        <div class="col-md-2">
            <label class="form-label d-md-none">Week/Day:</label>
            <input type="text" class="form-control milestone-period" placeholder="1-2" required>
        </div>
        <div class="col-md-3">
            <label class="form-label d-md-none">Date:</label>
            <div class="input-group">
                <input type="date" class="form-control milestone-date" onchange="validateMilestoneDate(this)">
                <span class="input-group-text date-toggle" onclick="toggleDateDisplay(this)">
                    <i class="fas fa-calendar-alt"></i>
                </span>
            </div>
        </div>
        <div class="col-md-6">
            <label class="form-label d-md-none">Description:</label>
            <input type="text" class="form-control milestone-description" placeholder="Milestone description" required>
        </div>
        <div class="col-md-1 text-center">
            <button type="button" class="btn btn-outline-danger remove-milestone-btn mt-md-0 mt-2">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    
    milestonesContainer.appendChild(milestoneRow);
    
    const removeBtn = milestoneRow.querySelector('.remove-milestone-btn');
    removeBtn.addEventListener('click', function() {
        removeMilestone(milestoneRow);
    });
}

// Function to remove a milestone
function removeMilestone(milestoneRow) {
    if (!milestoneRow) return;
    
    const milestonesContainer = document.getElementById('milestones-container');
    const allRows = milestonesContainer.querySelectorAll('.milestone-row');
    
    if (allRows.length <= 1) {
        // If it's the last row, just clear the inputs instead of removing
        const periodInput = milestoneRow.querySelector('.milestone-period');
        const descriptionInput = milestoneRow.querySelector('.milestone-description');
        const dateInput = milestoneRow.querySelector('.milestone-date');
        
        if (periodInput) periodInput.value = '';
        if (descriptionInput) descriptionInput.value = '';
        if (dateInput) {
            dateInput.value = '';
            dateInput.classList.remove('is-invalid');
        }
    } else {
        // Otherwise remove the row
        milestonesContainer.removeChild(milestoneRow);
    }
    
    // Re-validate after changes
    validateAllMilestoneDates();
}

// Initialize milestone buttons
document.addEventListener('DOMContentLoaded', function() {
    const timelineModal = document.getElementById('timelineModal');
    if (timelineModal) {
        timelineModal.addEventListener('shown.bs.modal', function() {
            // Initialize the add milestone button
            const addMilestoneBtn = document.getElementById('add-milestone-btn');
            if (addMilestoneBtn) {
                // Remove any existing event listeners
                const newBtn = addMilestoneBtn.cloneNode(true);
                addMilestoneBtn.parentNode.replaceChild(newBtn, addMilestoneBtn);
                
                // Add new event listener
                newBtn.addEventListener('click', addNewMilestone);
            }
            
            // Initialize existing remove buttons
            document.querySelectorAll('.remove-milestone-btn').forEach(button => {
                const newBtn = button.cloneNode(true);
                button.parentNode.replaceChild(newBtn, button);
                newBtn.addEventListener('click', function() {
                    removeMilestone(this.closest('.milestone-row'));
                });
            });
        });
    }
});

// Update the applyMilestoneTemplate function to use the new structure
const originalApplyMilestoneTemplate = applyMilestoneTemplate;
applyMilestoneTemplate = function(templateId) {
    const template = milestoneTemplates[templateId];
    if (!template) {
        showToast('error', 'Template not found');
        return;
    }
    
    // Get end date to calculate milestone dates
    const expectedEndDateInput = document.getElementById('expectedEndDate');
    if (!expectedEndDateInput || !expectedEndDateInput.value) {
        // If end date is not set, set it automatically based on template
        setExpectedEndDateFromTemplate(templateId);
        
        if (!expectedEndDateInput.value) {
            showToast('warning', 'Could not set expected end date');
            return;
        }
    }
    
    // Clear existing milestones
    const milestonesContainer = document.getElementById('milestones-container');
    milestonesContainer.innerHTML = '';
    
    // Calculate dates based on the timeline span
    // Start from TOMORROW instead of today
    const startDate = new Date();
    startDate.setDate(startDate.getDate() + 1); // Add 1 day to get tomorrow
    startDate.setHours(0, 0, 0, 0);
    
    const endDate = new Date(expectedEndDateInput.value);
    endDate.setHours(0, 0, 0, 0);
    
    // Calculate total duration in days
    const totalDuration = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24));
    
    // Get the template's original duration
    const templateDuration = getTemplateDuration(templateId) - 7; // Subtract the buffer we added
    
    // Apply template milestones
    template.forEach((milestone, index) => {
        // Calculate adjusted day offset based on the actual timeline duration
        let adjustedDayOffset;
        
        if (templateDuration <= 0) {
            // Fallback: Distribute evenly if template duration is invalid
            adjustedDayOffset = Math.floor((totalDuration * index) / (template.length - 1));
        } else {
            // Scale the day offset proportionally to fit the actual timeline
            const scaleFactor = totalDuration / templateDuration;
            adjustedDayOffset = Math.floor(milestone.days * scaleFactor);
        }
        
        // Calculate milestone date
        const milestoneDate = new Date(startDate);
        milestoneDate.setDate(milestoneDate.getDate() + adjustedDayOffset);
        
        // Make sure the date doesn't exceed the end date
        const finalDate = milestoneDate > endDate ? endDate : milestoneDate;
        
        // Format date for the input
        const formattedDate = finalDate.toISOString().split('T')[0]; // YYYY-MM-DD format
        
        // Create new milestone row
        const milestoneRow = document.createElement('div');
        milestoneRow.className = 'milestone-row row mb-3 pb-3 border-bottom align-items-center';
        
        milestoneRow.innerHTML = `
            <div class="col-md-2">
                <label class="form-label d-md-none">Week/Day:</label>
                <input type="text" class="form-control milestone-period" placeholder="1-2" value="${milestone.period}" required>
            </div>
            <div class="col-md-3">
                <label class="form-label d-md-none">Date:</label>
                <div class="input-group">
                    <input type="date" class="form-control milestone-date" value="${formattedDate}" onchange="validateMilestoneDate(this)">
                    <span class="input-group-text date-toggle" onclick="toggleDateDisplay(this)">
                        <i class="fas fa-calendar-alt"></i>
                    </span>
                </div>
            </div>
            <div class="col-md-6">
                <label class="form-label d-md-none">Description:</label>
                <input type="text" class="form-control milestone-description" placeholder="Milestone description" value="${milestone.description}" required>
            </div>
            <div class="col-md-1 text-center">
                <button type="button" class="btn btn-outline-danger remove-milestone-btn mt-md-0 mt-2">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        milestonesContainer.appendChild(milestoneRow);
        
        // Add event listener to the remove button
        const removeBtn = milestoneRow.querySelector('.remove-milestone-btn');
        removeBtn.addEventListener('click', function() {
            removeMilestone(milestoneRow);
        });
    });
    
    // Validate all milestone dates
    validateAllMilestoneDates();
    
    showToast('success', `Applied ${template.length} milestones from template`);
};

// Function to submit the timeline - update to use the new structure
const originalSubmitTimeline = submitTimeline;
submitTimeline = function() {
    // Check if the original function exists and call it if it does
    if (typeof originalSubmitTimeline === 'function') {
        // Check if we need to modify the data collection logic
        try {
            // Get all milestone entries
            const milestonesContainer = document.getElementById('milestones-container');
            const milestoneRows = milestonesContainer.querySelectorAll('.milestone-row');
            
            if (milestoneRows.length > 0) {
                // We have the new structure, so we'll override the data collection
                const expectedEndDateInput = document.getElementById('expectedEndDate');
                const mentorshipIdInput = document.getElementById('mentorshipIdForTimeline');
                const notesTextarea = document.getElementById('timelineMilestones');
                
                // Verify required fields
                if (!expectedEndDateInput || !expectedEndDateInput.value) {
                    showToast('error', 'Please set an expected end date');
                    return;
                }
                
                // Collect milestone data
                const milestones = [];
                let hasEmptyFields = false;
                
                milestoneRows.forEach(row => {
                    const periodInput = row.querySelector('.milestone-period');
                    const dateInput = row.querySelector('.milestone-date');
                    const descriptionInput = row.querySelector('.milestone-description');
                    
                    // Check if required fields are filled
                    if (!periodInput.value.trim() || !descriptionInput.value.trim()) {
                        hasEmptyFields = true;
                        return;
                    }
                    
                    milestones.push({
                        period: periodInput.value.trim(),
                        date: dateInput.value || '',
                        description: descriptionInput.value.trim()
                    });
                });
                
                if (hasEmptyFields) {
                    showToast('error', 'Please fill in all required milestone fields');
                    return;
                }
                
                if (milestones.length === 0) {
                    showToast('error', 'Please add at least one milestone');
                    return;
                }
                
                // Validate milestone dates
                if (!validateAllMilestoneDates()) {
                    return;
                }
                
                // Show loading state
                const saveButton = document.getElementById('saveTimeline');
                if (saveButton) {
                    saveButton.disabled = true;
                    saveButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Saving...';
                }
                
                // Send the data to the server
                fetch('/mentorship/set-timeline/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        mentorship_id: mentorshipIdInput ? mentorshipIdInput.value : '',
                        expected_end_date: expectedEndDateInput.value,
                        milestones: milestones,
                        notes: notesTextarea ? notesTextarea.value : ''
                    })
                })
                .then(response => {
                    // First check if the response is ok
                    if (!response.ok) {
                        // Try to get status code info to provide better error messages
                        const errorMsg = `Server error: ${response.status} ${response.statusText}`;
                        console.error(errorMsg);
                        throw new Error(errorMsg);
                    }
                    
                    // Check content type to avoid JSON parse errors
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        console.error('Response is not JSON. Content-Type:', contentType);
                        throw new Error('Server returned an invalid response format');
                    }
                    
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        showToast('success', 'Timeline saved successfully');
                        // Close the modal
                        const closeBtn = document.querySelector('#timelineModal .btn-close');
                        if (closeBtn) closeBtn.click();
                        // Refresh the page
                        setTimeout(() => window.location.reload(), 1000);
                    } else {
                        showToast('error', data.error || 'Failed to save timeline');
                        if (saveButton) {
                            saveButton.disabled = false;
                            saveButton.innerHTML = '<i class="fas fa-save me-2"></i>Save Timeline';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('error', `An error occurred while saving: ${error.message || 'Unknown error'}`);
                    if (saveButton) {
                        saveButton.disabled = false;
                        saveButton.innerHTML = '<i class="fas fa-save me-2"></i>Save Timeline';
                    }
                });
                
                // We've handled submission with the new structure
                return;
            }
        } catch (e) {
            console.error('Error detecting milestone structure:', e);
        }
        
        // Fall back to the original function if we couldn't handle it with the new structure
        return originalSubmitTimeline();
    }
    
    // If original function doesn't exist, show an error
    showToast('error', 'Timeline submission function not found');
};

function updateMeetingLink() {
    const meetingId = document.getElementById('editMeetingId').value;
    const meetingLink = document.getElementById('editMeetingLink').value;
    
    // Validate meeting link
    if (!meetingLink) {
        showToast('error', 'Please enter a meeting link');
        return;
    }
    
    // Validate that the meeting link is valid
    if (!meetingLink.startsWith('http://') && !meetingLink.startsWith('https://')) {
        showToast('error', 'Please enter a valid meeting link starting with http:// or https://');
        return;
    }
    
    fetch(`/mentorship/api/meetings/${meetingId}/`, {
        method: 'PATCH',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            meeting_link: meetingLink
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to update meeting link');
        }
        return response.json();
    })
    .then(data => {
        var editMeetingModal = document.getElementById('editMeetingModal');
        var modal = bootstrap.Modal.getInstance(editMeetingModal);
        if (modal) modal.hide();
        
        showToast('success', 'Meeting link updated successfully');
        setTimeout(() => location.reload(), 1500);
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Failed to update meeting link. Please try again.');
    });
}
</script>

// Function to handle schedule meeting form submission
function submitScheduleMeeting(event) {
    event.preventDefault();
    
    const mentorshipId = document.getElementById('mentorshipIdInput').value;
    const meetingTitle = document.getElementById('meetingTitle').value;
    const meetingDate = document.getElementById('meetingDate').value;
    const meetingLink = document.getElementById('meetingLink').value;
    const meetingAgenda = document.getElementById('meetingAgenda').value;
    
    // Validate required fields
    if (!mentorshipId || !meetingTitle || !meetingDate || !meetingAgenda) {
        showToast('error', 'Please fill out all required fields.');
        return;
    }
    
    // Create form data
    const formData = {
        mentorship: mentorshipId,
        title: meetingTitle,
        meeting_date: meetingDate,
        meeting_link: meetingLink,
        description: meetingAgenda,
        status: 'SCHEDULED'
    };
    
    // Submit using fetch API
    fetch('/mentorship/api/meetings/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to schedule meeting');
        }
        return response.json();
    })
    .then(data => {
        // Close the modal
        const scheduleMeetingModal = document.getElementById('scheduleMeetingModal');
        const modal = bootstrap.Modal.getInstance(scheduleMeetingModal);
        if (modal) modal.hide();
        
        // Show success message
        showToast('success', 'Meeting scheduled successfully!');
        
        // Reload the page after a short delay
        setTimeout(() => location.reload(), 1500);
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Failed to schedule meeting. Please try again.');
    });
}

// Function to parse existing timeline milestones when editing
function parseExistingMilestones(timelineText) {
    if (!timelineText) return;
    
    const milestonesContainer = document.getElementById('milestones-container');
    if (!milestonesContainer) {
        console.error('Milestones container not found');
        return;
    }

    // Clear existing milestone entries
    // Use the newer milestone-row class if it exists, otherwise fall back to milestone-entry
    const rowSelector = milestonesContainer.querySelector('.milestone-row') ? '.milestone-row' : '.milestone-entry';
    const existingEntries = milestonesContainer.querySelectorAll(rowSelector);
    
    // Remove all existing entries except the first one
    if (existingEntries.length > 0) {
        for (let i = 1; i < existingEntries.length; i++) {
            milestonesContainer.removeChild(existingEntries[i]);
        }
        
        // Reset the first entry
        const firstEntry = existingEntries[0];
        if (firstEntry) {
            const periodInput = firstEntry.querySelector('.milestone-period');
            const descriptionInput = firstEntry.querySelector('.milestone-description');
            
            if (periodInput) periodInput.value = '';
            if (descriptionInput) descriptionInput.value = '';
        }
    } else {
        // If no entries exist, try to add one using the new function
        if (typeof addNewMilestone === 'function') {
            console.log('Adding first milestone entry using addNewMilestone');
            addNewMilestone();
        } else {
            console.error('No milestone entries found and addNewMilestone function not available');
        }
    }
    
    // Parse the timeline text
    const lines = timelineText.split('\n');
    let additionalNotes = '';
    let inAdditionalNotes = false;
    
    lines.forEach((line, index) => {
        line = line.trim();
        if (!line) return;
        
        if (line.startsWith('Additional Notes:')) {
            inAdditionalNotes = true;
            return;
        }
        
        if (inAdditionalNotes) {
            additionalNotes += line + '\n';
            return;
        }
        
        const weekDayMatch = line.match(/^Week\/Day\s+([^:]+):\s*(.+)$/);
        if (weekDayMatch) {
            const period = weekDayMatch[1];
            let description = weekDayMatch[2];
            
            // Remove status if present
            if (description.includes('[')) {
                description = description.split('[')[0].trim();
            }
            
            // Use newer milestone-row class if it exists, otherwise fall back to milestone-entry
            const rowSelector = milestonesContainer.querySelector('.milestone-row') ? '.milestone-row' : '.milestone-entry';
            const existingEntries = milestonesContainer.querySelectorAll(rowSelector);
            
            if (index === 0 && existingEntries.length > 0) {
                // Use the first entry
                const firstEntry = existingEntries[0];
                if (firstEntry) {
                    const periodInput = firstEntry.querySelector('.milestone-period');
                    const descriptionInput = firstEntry.querySelector('.milestone-description');
                    
                    if (periodInput) periodInput.value = period;
                    if (descriptionInput) descriptionInput.value = description;
                }
            } else {
                // Add a new entry using the newer function if available
                if (typeof addNewMilestone === 'function') {
                    addNewMilestone();
                    
                    // Get the newly created row (should be the last one)
                    const newEntries = milestonesContainer.querySelectorAll(rowSelector);
                    if (newEntries.length > 0) {
                        const newEntry = newEntries[newEntries.length - 1];
                        const periodInput = newEntry.querySelector('.milestone-period');
                        const descriptionInput = newEntry.querySelector('.milestone-description');
                        
                        if (periodInput) periodInput.value = period;
                        if (descriptionInput) descriptionInput.value = description;
                    }
                } else {
                    // Fall back to using the add-milestone-btn click
                    const addMilestoneBtn = document.getElementById('add-milestone-btn');
                    if (addMilestoneBtn) {
                        addMilestoneBtn.click();
                        
                        // Find the new entry (should be the last one)
                        const allEntries = milestonesContainer.querySelectorAll(rowSelector);
                        if (allEntries.length > 0) {
                            const newEntry = allEntries[allEntries.length - 1];
                            if (newEntry) {
                                const periodInput = newEntry.querySelector('.milestone-period');
                                const descriptionInput = newEntry.querySelector('.milestone-description');
                                
                                if (periodInput) periodInput.value = period;
                                if (descriptionInput) descriptionInput.value = description;
                            } else {
                                console.error('Failed to create new milestone entry');
                            }
                        }
                    } else {
                        console.error('Add milestone button not found');
                    }
                }
            }
        }
    });
    
    // Update additional notes field
    if (additionalNotes) {
        const notesField = document.getElementById('timelineMilestones');
        if (notesField) {
            notesField.value = additionalNotes.trim();
        }
    }
}

// Function to set timeline
function setTimeline(mentorshipId) {
    // Show timeline modal
    var timelineModal = document.getElementById('timelineModal');
    if (!timelineModal) {
        console.error('Timeline modal element not found');
        showToast('error', 'Timeline modal not found. Please refresh the page and try again.');
        return;
    }
    
    var modal = bootstrap.Modal.getInstance(timelineModal) || new bootstrap.Modal(timelineModal);
    
    const mentorshipIdInput = document.getElementById('mentorshipIdForTimeline');
    if (!mentorshipIdInput) {
        console.error('Mentorship ID input element not found');
        showToast('error', 'Form elements not found. Please refresh the page and try again.');
        return;
    }
    mentorshipIdInput.value = mentorshipId;
    
    // Clear any previous error
    const errorContainer = document.getElementById('timeline-error-message');
    if (errorContainer) {
        errorContainer.classList.add('d-none');
    }
    
    // Fetch existing timeline data if available
    fetch(`/mentorship/api/requests/${mentorshipId}/`, {
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        const expectedEndDateInput = document.getElementById('expectedEndDate');
        if (expectedEndDateInput && data.expected_end_date) {
            expectedEndDateInput.value = data.expected_end_date.split('T')[0];
        }
        
        if (data.timeline_milestones) {
            parseExistingMilestones(data.timeline_milestones);
        } else {
            // Reset form if no existing timeline
            const milestonesContainer = document.getElementById('milestones-container');
            if (milestonesContainer) {
                const existingEntries = milestonesContainer.querySelectorAll('.milestone-entry');
                if (existingEntries.length > 0) {
                    // Keep only the first entry and reset it
                    for (let i = 1; i < existingEntries.length; i++) {
                        milestonesContainer.removeChild(existingEntries[i]);
                    }
                    const firstEntry = existingEntries[0];
                    if (firstEntry) {
                        const periodInput = firstEntry.querySelector('.milestone-period');
                        const descriptionInput = firstEntry.querySelector('.milestone-description');
                        if (periodInput) periodInput.value = '';
                        if (descriptionInput) descriptionInput.value = '';
                    }
                }
            }
            
            const timelineMilestonesInput = document.getElementById('timelineMilestones');
            if (timelineMilestonesInput) {
                timelineMilestonesInput.value = '';
            }
        }
        modal.show();
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Failed to fetch timeline data. Please try again.');
        modal.show(); // Show modal anyway
    });
}

// Modified submitTimeline function to include validation
function submitTimeline() {
    // Validate dates before submission
    validateAllMilestoneDates();
    
    // Get the timeline alert to check for errors
    const timelineAlert = document.getElementById('timeline-alert');
    if (timelineAlert && !timelineAlert.classList.contains('d-none')) {
        // There are validation errors, don't submit
        showToast('error', 'Please fix the timeline date errors before saving.');
        return;
    }
    
    // Original function continues here...
    const mentorshipId = document.getElementById('mentorshipIdForTimeline').value;
    const expectedEndDate = document.getElementById('expectedEndDate').value;
    const additionalNotes = document.getElementById('timelineMilestones').value;
    
    // Validate required fields
    if (!expectedEndDate) {
        showToast('error', 'Please select an expected end date');
        return;
    }
    
    // Collect all milestone entries
    const milestoneEntries = document.querySelectorAll('.milestone-entry');
    
    // Check if there are any milestone entries
    if (milestoneEntries.length === 0) {
        // Add a new milestone entry if none exist
        const addMilestoneBtn = document.getElementById('add-milestone-btn');
        if (addMilestoneBtn) {
            addMilestoneBtn.click();
            showToast('error', 'Please add at least one milestone with both period and description');
            return;
        }
    }
    
    let formattedMilestones = '';
    let hasValidMilestones = false;
    
    milestoneEntries.forEach(entry => {
        const periodInput = entry.querySelector('.milestone-period');
        const descriptionInput = entry.querySelector('.milestone-description');
        const dateInput = entry.querySelector('.milestone-date');
        
        if (!periodInput || !descriptionInput) return;
        
        const period = periodInput.value.trim();
        const description = descriptionInput.value.trim();
        const date = dateInput ? dateInput.value.trim() : '';
        
        if (period && description) {
            let formattedDescription = description;
            if (date) {
                formattedDescription = `${description} [Date: ${date}]`;
            }
            formattedMilestones += `Week/Day ${period}: ${formattedDescription}\n`;
            hasValidMilestones = true;
        } else if (period || description) {
            // If one field is filled but not the other, highlight the empty field
            if (!period) {
                periodInput.classList.add('is-invalid');
                setTimeout(() => periodInput.classList.remove('is-invalid'), 3000);
            }
            if (!description) {
                descriptionInput.classList.add('is-invalid');
                setTimeout(() => descriptionInput.classList.remove('is-invalid'), 3000);
            }
        }
    });
    
    if (!hasValidMilestones) {
        showToast('error', 'Please add at least one milestone with both period and description');
        return;
    }
    
    // Add additional notes if provided
    if (additionalNotes) {
        formattedMilestones += `\nAdditional Notes:\n${additionalNotes}`;
    }
    
    // Show loading state
    const submitButton = document.querySelector('#timelineModal .btn-primary');
    const originalText = submitButton.textContent;
    submitButton.disabled = true;
    submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
    
    fetch(`/mentorship/api/requests/${mentorshipId}/update_timeline/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            expected_end_date: expectedEndDate,
            timeline_milestones: formattedMilestones
        })
    })
    .then(async response => {
        if (!response.ok) {
            // Try to get error details from response
            const errorData = await response.json().catch(() => null);
            throw new Error(errorData?.detail || `Error: ${response.status} ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        var timelineModal = document.getElementById('timelineModal');
        var modal = bootstrap.Modal.getInstance(timelineModal);
        if (modal) modal.hide();
        
        showToast('success', 'Mentorship timeline updated successfully');
        setTimeout(() => location.reload(), 1500);
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', error.message || 'Failed to update timeline. Please try again.');
        
        // Reset button state
        submitButton.disabled = false;
        submitButton.innerHTML = originalText;
    });
}

// Enhance the timeline display with milestone markers
function enhanceTimelineDisplay() {
    document.querySelectorAll('.timeline-container').forEach(container => {
        const timelineText = container.querySelector('.timeline-text').textContent;
        const progressBar = container.querySelector('.progress');
        let progressPercentage = 0;
        
        // Get the progress percentage from the progress bar if it exists
        if (progressBar && progressBar.querySelector('.progress-bar')) {
            const progressBarStyle = progressBar.querySelector('.progress-bar').getAttribute('style');
            const percentMatch = progressBarStyle.match(/width:\s*(\d+)%/);
            if (percentMatch && percentMatch[1]) {
                progressPercentage = parseInt(percentMatch[1]);
            } else {
                // Fallback to aria-valuenow
                progressPercentage = parseInt(progressBar.querySelector('.progress-bar').getAttribute('aria-valuenow') || 0);
            }
        }
        
        if (!timelineText) return;
        
        // Parse the timeline text to extract milestones
        const lines = timelineText.split('\n');
        let milestones = [];
        let inAdditionalNotes = false;
        
        lines.forEach(line => {
            line = line.trim();
            if (!line) return;
            
            if (line.startsWith('Additional Notes:')) {
                inAdditionalNotes = true;
                return;
            }
            
            if (inAdditionalNotes) {
                return;
            }
            
            const weekDayMatch = line.match(/^Week\/Day\s+([^:]+):\s*(.+)$/);
            if (weekDayMatch) {
                const period = weekDayMatch[1];
                const description = weekDayMatch[2];
                
                // Extract status if available
                let status = 'NOT_STARTED';
                const statusMatch = description.match(/(.+)\s+\[([A-Z_]+)\]$/);
                const cleanDescription = statusMatch ? statusMatch[1].trim() : description;
                if (statusMatch) {
                    status = statusMatch[2];
                }
                
                // Parse the period to get a position for the marker
                let position = 0;
                if (period.includes('-')) {
                    const [start, end] = period.split('-').map(p => parseInt(p.trim()));
                    position = (start + end) / 2;
                } else {
                    position = parseInt(period);
                }
                
                milestones.push({
                    period: period,
                    description: cleanDescription,
                    status: status,
                    position: position
                });
            }
        });
        
        // Create thermometer-style progress bar if milestones exist
        if (milestones.length > 0) {
            // Find the maximum position to scale properly
            const maxPosition = Math.max(...milestones.map(m => m.position));
            
            // Sort milestones by position
            milestones.sort((a, b) => a.position - b.position);
            
            // Calculate completion status
            const totalMilestones = milestones.length;
            const completedMilestones = milestones.filter(m => m.status === 'COMPLETED').length;
            const inProgressMilestones = milestones.filter(m => m.status === 'IN_PROGRESS').length;
            
            // Calculate actual percentage based on milestone completion
            const calculatedPercentage = Math.round((completedMilestones + (inProgressMilestones * 0.5)) / totalMilestones * 100);
            
            // Use the calculated percentage if it's available, otherwise use the one from the progress bar
            const displayPercentage = calculatedPercentage || progressPercentage;
            
            // Create a thermometer-style progress container
            const thermometerContainer = document.createElement('div');
            thermometerContainer.style.position = 'relative';
            thermometerContainer.style.margin = '40px 0 60px';
            thermometerContainer.style.padding = '0 10px';
            
            // Add status text
            const statusElement = document.createElement('div');
            statusElement.style.position = 'absolute';
            statusElement.style.top = '-35px';
            statusElement.style.left = '10px';
            statusElement.style.fontSize = '0.85rem';
            statusElement.style.fontWeight = '500';
            statusElement.style.color = '#495057';
            
            let statusText = '';
            if (displayPercentage === 100) {
                statusText = 'Completed';
            } else if (displayPercentage > 0) {
                statusText = 'In Progress';
            } else {
                statusText = 'Not Started';
            }
            statusElement.textContent = statusText;
            thermometerContainer.appendChild(statusElement);
            
            // Add dates
            const datesContainer = document.createElement('div');
            datesContainer.style.display = 'flex';
            datesContainer.style.justifyContent = 'space-between';
            datesContainer.style.marginBottom = '10px';
            datesContainer.style.fontSize = '0.85rem';
            datesContainer.style.color = '#495057';
            datesContainer.style.fontWeight = '500';
            
            const startDateElement = container.closest('.card-body').querySelector('small:first-child');
            const endDateElement = container.closest('.card-body').querySelector('small:last-child');
            
            const startDate = startDateElement ? startDateElement.textContent.replace('Started: ', '') : 'Start';
            const endDate = endDateElement ? endDateElement.textContent.replace('Target End: ', '') : 'End';
            
            datesContainer.innerHTML = `
                <span>${startDate}</span>
                <span>${endDate}</span>
            `;
            
            thermometerContainer.appendChild(datesContainer);
            
            // Add percentage indicator
            const percentageElement = document.createElement('div');
            percentageElement.style.position = 'absolute';
            percentageElement.style.top = '-35px';
            percentageElement.style.right = '10px';
            percentageElement.style.backgroundColor = '#343a40';
            percentageElement.style.color = 'white';
            percentageElement.style.padding = '4px 10px';
            percentageElement.style.borderRadius = '20px';
            percentageElement.style.fontSize = '0.85rem';
            percentageElement.style.fontWeight = 'bold';
            percentageElement.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
            percentageElement.textContent = `${displayPercentage}%`;
            thermometerContainer.appendChild(percentageElement);
            
            // Create the thermometer track
            const trackElement = document.createElement('div');
            trackElement.style.height = '16px';
            trackElement.style.backgroundColor = '#e9ecef';
            trackElement.style.borderRadius = '8px';
            trackElement.style.position = 'relative';
            trackElement.style.boxShadow = 'inset 0 1px 3px rgba(0,0,0,0.1)';
            trackElement.style.overflow = 'hidden';
            
            // Create the thermometer fill
            const fillElement = document.createElement('div');
            fillElement.style.position = 'absolute';
            fillElement.style.top = '0';
            fillElement.style.left = '0';
            fillElement.style.height = '100%';
            fillElement.style.background = 'linear-gradient(90deg, #4481eb 0%, #04befe 100%)';
            fillElement.style.borderRadius = '8px';
            fillElement.style.transition = 'width 0.6s ease';
            fillElement.style.width = `${displayPercentage}%`;
            
            trackElement.appendChild(fillElement);
            thermometerContainer.appendChild(trackElement);
            
            // Add thermometer bulb
            const bulbElement = document.createElement('div');
            bulbElement.style.position = 'absolute';
            bulbElement.style.left = `${displayPercentage}%`;
            bulbElement.style.top = '8px';
            bulbElement.style.transform = 'translate(-50%, -50%)';
            bulbElement.style.width = '30px';
            bulbElement.style.height = '30px';
            bulbElement.style.background = 'linear-gradient(135deg, #4481eb 0%, #04befe 100%)';
            bulbElement.style.borderRadius = '50%';
            bulbElement.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
            bulbElement.style.zIndex = '2';
            bulbElement.style.border = '3px solid #fff';
            
            // Add shine effect to bulb
            const bulbShine = document.createElement('div');
            bulbShine.style.position = 'absolute';
            bulbShine.style.top = '50%';
            bulbShine.style.left = '50%';
            bulbShine.style.transform = 'translate(-50%, -50%)';
            bulbShine.style.width = '15px';
            bulbShine.style.height = '15px';
            bulbShine.style.background = 'rgba(255, 255, 255, 0.3)';
            bulbShine.style.borderRadius = '50%';
            
            bulbElement.appendChild(bulbShine);
            thermometerContainer.appendChild(bulbElement);
            
            // Create scale marks
            const scaleContainer = document.createElement('div');
            scaleContainer.style.position = 'absolute';
            scaleContainer.style.bottom = '-25px';
            scaleContainer.style.left = '0';
            scaleContainer.style.right = '0';
            
            // Add scale marks at 0%, 25%, 50%, 75%, and 100%
            [0, 25, 50, 75, 100].forEach(percent => {
                const scaleMark = document.createElement('div');
                scaleMark.style.position = 'absolute';
                scaleMark.style.width = '1px';
                scaleMark.style.height = '10px';
                scaleMark.style.backgroundColor = '#6c757d';
                scaleMark.style.bottom = '15px';
                scaleMark.style.left = `${percent}%`;
                
                const scaleLabel = document.createElement('div');
                scaleLabel.style.position = 'absolute';
                scaleLabel.style.transform = 'translateX(-50%)';
                scaleLabel.style.bottom = '0';
                scaleLabel.style.left = `${percent}%`;
                scaleLabel.style.fontSize = '0.75rem';
                scaleLabel.style.color = '#6c757d';
                scaleLabel.textContent = `${percent}%`;
                
                scaleContainer.appendChild(scaleMark);
                scaleContainer.appendChild(scaleLabel);
            });
            
            thermometerContainer.appendChild(scaleContainer);
            
            // Create milestone markers container
            const markersContainer = document.createElement('div');
            markersContainer.style.position = 'relative';
            markersContainer.style.height = '60px';
            markersContainer.style.marginTop = '10px';
            
            // Add milestone markers
            milestones.forEach((milestone, index) => {
                const position = (milestone.position / maxPosition) * 100;
                
                const markerElement = document.createElement('div');
                markerElement.style.position = 'absolute';
                markerElement.style.transform = 'translateX(-50%)';
                markerElement.style.left = `${position}%`;
                
                // Create marker line
                const markerLine = document.createElement('div');
                markerLine.style.width = '2px';
                markerLine.style.height = milestone.status === 'COMPLETED' ? '15px' : 
                                          milestone.status === 'IN_PROGRESS' ? '12px' : '10px';
                markerLine.style.backgroundColor = milestone.status === 'COMPLETED' ? '#28a745' : 
                                                  milestone.status === 'IN_PROGRESS' ? '#ffc107' : '#6c757d';
                markerLine.style.margin = '0 auto 5px';
                
                // Create marker dot
                const markerDot = document.createElement('div');
                markerDot.style.width = '24px';
                markerDot.style.height = '24px';
                markerDot.style.borderRadius = '50%';
                markerDot.style.backgroundColor = milestone.status === 'COMPLETED' ? '#28a745' : 
                                                 milestone.status === 'IN_PROGRESS' ? '#ffc107' : '#e9ecef';
                markerDot.style.border = '3px solid #fff';
                markerDot.style.boxShadow = milestone.status === 'COMPLETED' ? '0 0 0 2px rgba(40, 167, 69, 0.3)' : 
                                           milestone.status === 'IN_PROGRESS' ? '0 0 0 2px rgba(255, 193, 7, 0.3)' : '0 0 0 2px #e9ecef';
                markerDot.style.margin = '0 auto 8px';
                markerDot.style.position = 'relative';
                markerDot.style.zIndex = '3';
                markerDot.style.cursor = 'pointer';
                
                // Create marker label
                const markerLabel = document.createElement('div');
                markerLabel.style.fontSize = '0.8rem';
                markerLabel.style.color = '#495057';
                markerLabel.style.textAlign = 'center';
                markerLabel.style.maxWidth = '100px';
                markerLabel.style.overflow = 'hidden';
                markerLabel.style.textOverflow = 'ellipsis';
                markerLabel.style.whiteSpace = 'nowrap';
                markerLabel.style.fontWeight = '500';
                markerLabel.style.position = 'relative';
                markerLabel.textContent = `Day ${milestone.period}`;
                
                // Create tooltip
                const tooltip = document.createElement('div');
                tooltip.style.position = 'absolute';
                tooltip.style.bottom = '100%';
                tooltip.style.left = '50%';
                tooltip.style.transform = 'translateX(-50%)';
                tooltip.style.backgroundColor = '#343a40';
                tooltip.style.color = 'white';
                tooltip.style.padding = '8px 12px';
                tooltip.style.borderRadius = '4px';
                tooltip.style.fontSize = '0.8rem';
                tooltip.style.whiteSpace = 'nowrap';
                tooltip.style.opacity = '0';
                tooltip.style.visibility = 'hidden';
                tooltip.style.transition = 'opacity 0.3s, visibility 0.3s';
                tooltip.style.zIndex = '10';
                tooltip.style.pointerEvents = 'none';
                tooltip.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
                tooltip.style.minWidth = '150px';
                tooltip.style.textAlign = 'center';
                tooltip.style.marginBottom = '10px';
                
                let statusText = 'Not Started';
                if (milestone.status === 'IN_PROGRESS') {
                    statusText = 'In Progress';
                } else if (milestone.status === 'COMPLETED') {
                    statusText = 'Completed';
                }
                
                tooltip.innerHTML = `
                    <div>${milestone.description}</div>
                    <div style="margin-top: 5px; font-weight: bold; color: ${
                        milestone.status === 'COMPLETED' ? '#28a745' : 
                        milestone.status === 'IN_PROGRESS' ? '#ffc107' : '#6c757d'
                    }">
                        ${statusText}
                    </div>
                `;
                
                markerWrapper.appendChild(tooltip);
                
                // Add click event to show milestone details
                markerWrapper.addEventListener('click', function() {
                    try {
                        // Highlight the corresponding row in the milestone table
                        const tableRows = document.querySelectorAll('#milestone-table-body tr');
                        tableRows.forEach((row, rowIndex) => {
                            if (rowIndex === index) {
                                row.classList.add('table-active');
                                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            } else {
                                row.classList.remove('table-active');
                            }
                        });
                    } catch (clickError) {
                        console.warn('Error in milestone click handler:', clickError);
                    }
                });
            } catch (milestoneError) {
                console.warn(`Error rendering milestone ${index}:`, milestoneError);
            }
        });
        
        // Add current position indicator if there are in-progress milestones
        if (inProgressMilestones > 0) {
            try {
                const currentPositionMarker = document.createElement('div');
                currentPositionMarker.className = 'enhanced-current-position-marker';
                currentPositionMarker.innerHTML = '<i class="fas fa-map-marker-alt"></i>';
                
                // Adjust the position of the current marker to match the progress fill
                const adjustedProgressPosition = (progressPercentage * usableWidth / 100) + paddingPercentage;
                currentPositionMarker.style.left = `${adjustedProgressPosition}%`;
                
                timelineContainer.appendChild(currentPositionMarker);
            } catch (markerError) {
                console.warn('Error adding current position marker:', markerError);
            }
        }
        
        // Removed the milestone labels below the timeline as requested
    } catch (error) {
        console.error('Error rendering timeline visualization:', error);
        const container = document.getElementById('timeline-visual-container');
        if (container) {
            container.innerHTML = '<div class="text-center py-4 text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error rendering timeline</div>';
        }
    }
}

// Function to show the timeline status modal
function showTimelineStatusModal(mentorshipId) {
    // Show timeline status modal
    var statusModal = document.getElementById('timelineStatusModal');
    var modal = bootstrap.Modal.getInstance(statusModal) || new bootstrap.Modal(statusModal);
    document.getElementById('mentorshipIdForStatus').value = mentorshipId;
    
    // Fetch timeline milestones
    fetch(`/mentorship/api/requests/${mentorshipId}/`, {
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        loadTimelineMilestones(data.timeline_milestones, mentorshipId);
        modal.show();
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Failed to fetch timeline data. Please try again.');
        modal.show(); // Show modal anyway
    });
}

// Function to load timeline milestones
function loadTimelineMilestones(timelineText, mentorshipId) {
    const container = document.getElementById('milestone-status-container');
    const noMilestonesMessage = document.getElementById('no-milestones-message');
    
    // Clear existing content
    container.innerHTML = '';
    
    if (!timelineText) {
        container.appendChild(noMilestonesMessage);
        return;
    }
    
    // Parse the timeline text to extract milestones
    const lines = timelineText.split('\n');
    let milestones = [];
    let inAdditionalNotes = false;
    
    lines.forEach(line => {
        line = line.trim();
        if (!line) return;
        
        if (line.startsWith('Additional Notes:')) {
            inAdditionalNotes = true;
            return;
        }
        
        if (inAdditionalNotes) {
            return;
        }
        
        const weekDayMatch = line.match(/^Week\/Day\s+([^:]+):\s*(.+)$/);
        if (weekDayMatch) {
            const period = weekDayMatch[1];
            const description = weekDayMatch[2];
            
            // Extract status if available
            let status = 'NOT_STARTED';
            const statusMatch = description.match(/(.+)\s+\[([A-Z_]+)\]$/);
            const cleanDescription = statusMatch ? statusMatch[1].trim() : description;
            if (statusMatch) {
                status = statusMatch[2];
            }
            
            milestones.push({
                period: period,
                description: cleanDescription,
                status: status
            });
        }
    });
    
    if (milestones.length === 0) {
        container.appendChild(noMilestonesMessage);
        return;
    }
    
    // Create milestone status items
    milestones.forEach(milestone => {
        const statusItem = document.createElement('div');
        statusItem.className = 'milestone-status-item';
        
        statusItem.innerHTML = `
            <div class="milestone-title">Week/Day ${milestone.period}</div>
            <div class="milestone-description">${milestone.description}</div>
            <div class="form-group">
                <label class="form-label">Status</label>
                <select class="form-select milestone-status" data-period="${milestone.period}" data-description="${milestone.description}">
                    <option value="NOT_STARTED" ${milestone.status === 'NOT_STARTED' ? 'selected' : ''}>Not Started</option>
                    <option value="IN_PROGRESS" ${milestone.status === 'IN_PROGRESS' ? 'selected' : ''}>In Progress</option>
                    <option value="COMPLETED" ${milestone.status === 'COMPLETED' ? 'selected' : ''}>Completed</option>
                </select>
            </div>
        `;
        
        container.appendChild(statusItem);
    });
    
    // Also update the enhanced timeline display
    updateEnhancedTimelineDisplay(mentorshipId, milestones);
}

// Function to save timeline status
function saveTimelineStatus() {
    const mentorshipId = document.getElementById('mentorshipIdForStatus').value;
    
    // Collect milestone status updates
    const milestoneStatuses = [];
    document.querySelectorAll('.milestone-status').forEach(dropdown => {
        milestoneStatuses.push({
            period: dropdown.getAttribute('data-period'),
            description: dropdown.getAttribute('data-description'),
            status: dropdown.value
        });
    });
    
    // Update milestone statuses
    fetch('/mentorship/api/milestones/update_batch/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            mentorship: mentorshipId,
            milestones: milestoneStatuses
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to update milestone statuses');
        }
        return response.json();
    })
    .then(data => {
        // Then update the timeline text with status
        return fetch(`/mentorship/api/requests/${mentorshipId}/update_timeline/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                update_milestones_in_timeline: true,
                milestone_statuses: milestoneStatuses
            })
        });
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to update timeline');
        }
        return response.json();
    })
    .then(data => {
        var statusModal = document.getElementById('timelineStatusModal');
        var modal = bootstrap.Modal.getInstance(statusModal);
        if (modal) modal.hide();
        
        showToast('success', 'Timeline status updated successfully');
        setTimeout(() => location.reload(), 1500);
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Failed to update timeline status. Please try again.');
    });
}

// Function to update the enhanced timeline display
function updateEnhancedTimelineDisplay(mentorshipId, milestones) {
    const timelineContainer = document.getElementById(`timeline-milestones-${mentorshipId}`);
    if (!timelineContainer) return;
    
    // Clear existing content
    timelineContainer.innerHTML = '';
    
    // Sort milestones by period
    milestones.sort((a, b) => {
        const periodA = a.period.includes('-') ? 
            parseInt(a.period.split('-')[0]) : parseInt(a.period);
        const periodB = b.period.includes('-') ? 
            parseInt(b.period.split('-')[0]) : parseInt(b.period);
        return periodA - periodB;
    });
    
    // Create milestone cards
    milestones.forEach((milestone, index) => {
        const milestoneElement = document.createElement('div');
        milestoneElement.className = 'timeline-milestone';
        
        // Extract topics from description (if any)
        let description = milestone.description;
        let topics = [];
        
        // Check if description contains topics (bullet points)
        if (description.includes('')) {
            const parts = description.split('');
            description = parts[0].trim();
            topics = parts.slice(1).map(topic => topic.trim()).filter(topic => topic);
        }
        
        // Determine status class
        const statusClass = milestone.status.toLowerCase().replace('_', '-');
        
        // Create milestone card
        milestoneElement.innerHTML = `
            <div class="timeline-milestone-card">
                <div class="timeline-milestone-header ${statusClass}">
                    <span>Week/Day ${milestone.period}</span>
                    <span>${milestone.status === 'COMPLETED' ? 'Completed' : 
                           milestone.status === 'IN_PROGRESS' ? 'In Progress' : 'Not Started'}</span>
                </div>
                <div class="timeline-milestone-title">${description}</div>
                ${topics.length > 0 ? `
                <div class="timeline-milestone-topics">
                    <div class="timeline-milestone-topics-title">Topics/Activities:</div>
                    <ul>
                        ${topics.map(topic => `<li>${topic}</li>`).join('')}
                    </ul>
                </div>
                ` : ''}
                <select class="timeline-milestone-status-select" 
                        data-period="${milestone.period}" 
                        data-description="${milestone.description}"
                        onchange="updateMilestoneStatus(this, '${mentorshipId}')">
                    <option value="NOT_STARTED" ${milestone.status === 'NOT_STARTED' ? 'selected' : ''}>Not Started</option>
                    <option value="IN_PROGRESS" ${milestone.status === 'IN_PROGRESS' ? 'selected' : ''}>In Progress</option>
                    <option value="COMPLETED" ${milestone.status === 'COMPLETED' ? 'selected' : ''}>Completed</option>
                </select>
            </div>
            <div class="timeline-milestone-dot ${statusClass}"></div>
        `;
        
        timelineContainer.appendChild(milestoneElement);
    });
}

// Function to update a single milestone status directly from the timeline
function updateMilestoneStatus(selectElement, mentorshipId) {
    const period = selectElement.getAttribute('data-period');
    const description = selectElement.getAttribute('data-description');
    const status = selectElement.value;
    
    // Update milestone status
    fetch('/mentorship/api/milestones/update_batch/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            mentorship: mentorshipId,
            milestones: [{
                period: period,
                description: description,
                status: status
            }]
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to update milestone status');
        }
        return response.json();
    })
    .then(data => {
        // Then update the timeline text with status
        return fetch(`/mentorship/api/requests/${mentorshipId}/update_timeline/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                update_milestones_in_timeline: true,
                milestone_statuses: [{
                    period: period,
                    description: description,
                    status: status
                }]
            })
        });
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to update timeline');
        }
        return response.json();
    })
    .then(data => {
        showToast('success', 'Milestone status updated');
        
        // Update the UI without reloading
        const card = selectElement.closest('.timeline-milestone-card');
        const header = card.querySelector('.timeline-milestone-header');
        const dot = selectElement.closest('.timeline-milestone').querySelector('.timeline-milestone-dot');
        
        // Update status classes
        header.className = 'timeline-milestone-header';
        dot.className = 'timeline-milestone-dot';
        
        const statusClass = status.toLowerCase().replace('_', '-');
        header.classList.add(statusClass);
        dot.classList.add(statusClass);
        
        // Update status text
        const statusText = status === 'COMPLETED' ? 'Completed' : 
                          status === 'IN_PROGRESS' ? 'In Progress' : 'Not Started';
        header.querySelector('span:last-child').textContent = statusText;
        
        // Calculate new progress percentage
        calculateProgressPercentage(mentorshipId);
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Failed to update milestone status');
        
        // Reset the select to its previous value
        selectElement.value = selectElement.getAttribute('data-previous-value');
    });
    
    // Store the current value for potential rollback
    selectElement.setAttribute('data-previous-value', status);
}

// Function to calculate progress percentage based on milestone statuses
function calculateProgressPercentage(mentorshipId) {
    // Get all milestone status selects
    const selects = document.querySelectorAll(`#timeline-milestones-${mentorshipId} .timeline-milestone-status-select`);
    if (selects.length === 0) return;
    
    // Count completed and in-progress milestones
    let completed = 0;
    let inProgress = 0;
    
    selects.forEach(select => {
        if (select.value === 'COMPLETED') {
            completed++;
        } else if (select.value === 'IN_PROGRESS') {
            inProgress++;
        }
    });
    
    // Calculate percentage (completed + half of in-progress)
    const total = selects.length;
    const percentage = Math.round((completed + (inProgress * 0.5)) / total * 100);
    
    // Update progress bar
    const progressBar = document.querySelector(`#mentorship${mentorshipId} .progress-bar`);
    if (progressBar) {
        progressBar.style.width = `${percentage}%`;
        progressBar.setAttribute('aria-valuenow', percentage);
        progressBar.textContent = `${percentage}%`;
        
        // Step-progress-bar update code removed as requested
        
        // Also update the progress percentage on the server
        fetch(`/mentorship/api/requests/${mentorshipId}/update_timeline/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                progress_percentage: percentage
            })
        })
        .catch(error => {
            console.error('Error updating progress percentage:', error);
        });
    }
}

// Function to toggle timeline text view
function toggleTimelineText(mentorshipId) {
    const timelineText = document.querySelector(`#mentorship${mentorshipId} .timeline-text`);
    const toggleButton = document.querySelector(`#toggle-text-${mentorshipId}`);
    
    if (timelineText.style.display === 'none') {
        timelineText.style.display = 'block';
        toggleButton.textContent = 'Hide Text View';
    } else {
        timelineText.style.display = 'none';
        toggleButton.textContent = 'Show Text View';
    }
}

// Initialize enhanced timeline displays when the DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // ... existing code ...
    
    // Initialize enhanced timeline displays
    document.querySelectorAll('.timeline-container').forEach(container => {
        const mentorshipId = container.closest('.accordion-collapse').id.replace('mentorship-', '');
        const timelineText = container.querySelector('.timeline-text').textContent;
        
        if (timelineText) {
            // Parse the timeline text to extract milestones
            const lines = timelineText.split('\n');
            let milestones = [];
            let inAdditionalNotes = false;
            
            lines.forEach(line => {
                line = line.trim();
                if (!line) return;
                
                if (line.startsWith('Additional Notes:')) {
                    inAdditionalNotes = true;
                    return;
                }
                
                if (inAdditionalNotes) {
                    return;
                }
                
                const weekDayMatch = line.match(/^Week\/Day\s+([^:]+):\s*(.+)$/);
                if (weekDayMatch) {
                    const period = weekDayMatch[1];
                    const description = weekDayMatch[2];
                    
                    // Extract status if available
                    let status = 'NOT_STARTED';
                    const statusMatch = description.match(/(.+)\s+\[([A-Z_]+)\]$/);
                    const cleanDescription = statusMatch ? statusMatch[1].trim() : description;
                    if (statusMatch) {
                        status = statusMatch[2];
                    }
                    
                    milestones.push({
                        period: period,
                        description: cleanDescription,
                        status: status
                    });
                }
            });
            
            // Update the enhanced timeline display
            updateEnhancedTimelineDisplay(mentorshipId, milestones);
        }
    });
});

// Function to show progress details modal
function showProgressDetails(mentorshipId) {
    try {
        // Validate mentorshipId
        if (!mentorshipId || mentorshipId === '') {
            console.error('Invalid mentorship ID');
            showToast('error', 'Error loading progress details: Invalid mentorship ID');
            return;
        }
        
        // Show progress details modal
        var progressDetailsModal = document.getElementById('progressDetailsModal');
        if (!progressDetailsModal) {
            console.error('Progress details modal element not found');
            showToast('error', 'Error loading progress details: Modal not found');
            return;
        }
        
        var modal = bootstrap.Modal.getInstance(progressDetailsModal) || new bootstrap.Modal(progressDetailsModal);
        
        // Log the mentorship ID to help with debugging
        console.log('Fetching details for mentorship ID:', mentorshipId);
        
        // Fetch mentorship data
        fetch(`/mentorship/api/requests/${mentorshipId}/`, {
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            if (!response.ok) {
                // More detailed error handling
                if (response.status === 404) {
                    throw new Error('Mentorship not found. It may have been deleted or you may not have access.');
                } else if (response.status === 403) {
                    throw new Error('Permission denied. You do not have access to this mentorship.');
                } else if (response.status >= 500) {
                    throw new Error('Server error. Please try again later.');
                } else {
                    // Try to get more details from the response if possible
                    return response.json()
                        .then(errData => {
                            throw new Error(errData.detail || errData.message || `Network response error: ${response.status} ${response.statusText}`);
                        })
                        .catch(jsonErr => {
                            // If we can't parse the JSON, just use the status
{% extends "base.html" %}
{% load static %}
{% load mentorship_extras %}

{% block title %}Mentor Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/mentorship.css' %}">
<style>
    /* Dashboard Layout */
    .dashboard-container {
        padding: 2rem;
        width: 100%;
        max-width: 100%;
        margin: 0 auto;
    }
    
    /* Gradient Backgrounds */
    .bg-gradient-primary {
        background: linear-gradient(45deg, #4e73df 0%, #224abe 100%);
    }

    .bg-gradient-success {
        background: linear-gradient(45deg, #1cc88a 0%, #13855c 100%);
    }

    .bg-gradient-info {
        background: linear-gradient(45deg, #36b9cc 0%, #258391 100%);
    }

    .bg-gradient-warning {
        background: linear-gradient(45deg, #f6c23e 0%, #dda20a 100%);
    }
    
    /* Card Enhancements */
    .card {
        border: none;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        transition: transform 0.2s ease-in-out;
    }
    
    .card:hover {
        transform: translateY(-3px);
    }

    /* Stats Card Icons */
    .stats-icon {
        width: 3rem;
        height: 3rem;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
    }

    /* Mentorship Item Styles */
    .mentorship-item {
        border: none;
        margin-bottom: 1rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }

    .mentorship-item .accordion-button {
        padding: 1rem;
        background: #fff;
        border: none;
    }

    .mentorship-item .accordion-button:not(.collapsed) {
        background: #f8f9fa;
        color: #4e73df;
    }

    .mentorship-title {
        font-weight: 600;
        color: #5a5c69;
    }

    /* Progress Bars */
    .progress {
        height: 1rem;
        border-radius: 0.5rem;
        background-color: #eaecf4;
    }
    
    .progress-bar {
        border-radius: 0.5rem;
    }

    /* Timeline Styles */
    .timeline-visualization {
        padding: 1.5rem;
        background: #f8f9fa;
        border-radius: 0.5rem;
    }

    /* Buttons */
    .btn {
        padding: 0.375rem 1rem;
        font-weight: 500;
        border-radius: 0.5rem;
    }
    
    .btn-primary {
        background-color: #4e73df;
        border-color: #4e73df;
    }
    
    .btn-primary:hover {
        background-color: #2e59d9;
        border-color: #2653d4;
    }
    
    /* Badges */
    .badge {
        padding: 0.5em 0.75em;
        font-weight: 500;
        border-radius: 0.5rem;
    }

    /* Form Elements */
    .form-check-input:checked {
        background-color: #4e73df;
        border-color: #4e73df;
    }
    
    /* Responsive Adjustments */
    @media (max-width: 768px) {
        .dashboard-container {
            padding: 1rem;
        }

        .card {
            margin-bottom: 1rem;
        }
    }
    
    /* Enhanced Timeline Visualization Styles */
    .enhanced-timeline-container {
        height: 120px;
        padding: 15px 30px; /* Increased horizontal padding */
        position: relative;
        margin: 30px 0;
        overflow: visible;
    }

    .enhanced-timeline-line {
        position: absolute;
        height: 6px;
        background-color: #e9ecef;
        top: 50%;
        transform: translateY(-50%);
        z-index: 1;
        left: 0;
        right: 0;
        border-radius: 3px;
    }

    .enhanced-timeline-progress-fill {
        position: absolute;
        height: 6px;
        background: linear-gradient(90deg, #4e73df 0%, #36b9cc 100%);
        top: 50%;
        transform: translateY(-50%);
        z-index: 2;
        left: 0;
        width: 0%;
        transition: width 1s ease;
        border-radius: 3px;
        box-shadow: 0 0 10px rgba(78, 115, 223, 0.5);
    }

    .enhanced-milestone-marker-wrapper {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        z-index: 3;
        cursor: pointer;
    }

    .enhanced-milestone-marker {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
        transition: all 0.3s ease;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        position: relative;
    }

    .enhanced-milestone-marker.not-started {
        background-color: #6c757d;
        border: 2px solid #fff;
    }

    .enhanced-milestone-marker.in-progress {
        background-color: #f6c23e;
        border: 2px solid #fff;
    }

    .enhanced-milestone-marker.completed {
        background-color: #1cc88a;
        border: 2px solid #fff;
    }

    .enhanced-milestone-marker:hover {
        transform: scale(1.2);
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }

    .enhanced-milestone-labels {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        margin-top: 10px;
    }

    .enhanced-milestone-label {
        position: absolute;
        transform: translateX(-50%);
        font-size: 0.8rem;
        color: #495057;
        text-align: center;
        max-width: 100px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .enhanced-milestone-tooltip {
        position: absolute;
        bottom: 45px;
        left: 50%;
        transform: translateX(-50%) scale(0.9);
        background-color: white;
        color: #333;
        padding: 0;
        border-radius: 8px;
        font-size: 0.85rem;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        z-index: 1000;
        width: 220px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        pointer-events: none;
        border: 1px solid rgba(0,0,0,0.1);
        /* Ensure tooltip doesn't go off-screen */
        max-width: 90vw;
    }

    /* Adjust tooltip position for edge milestones */
    .enhanced-milestone-marker-wrapper:first-child .enhanced-milestone-tooltip {
        transform: translateX(-20%) scale(0.9);
    }
    
    .enhanced-milestone-marker-wrapper:first-child:hover .enhanced-milestone-tooltip {
        transform: translateX(-20%) scale(1);
    }
    
    .enhanced-milestone-marker-wrapper:last-child .enhanced-milestone-tooltip {
        transform: translateX(-80%) scale(0.9);
    }
    
    .enhanced-milestone-marker-wrapper:last-child:hover .enhanced-milestone-tooltip {
        transform: translateX(-80%) scale(1);
    }

    .enhanced-milestone-tooltip::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -8px;
        border-width: 8px;
        border-style: solid;
        border-color: white transparent transparent transparent;
    }
    
    /* Adjust arrow position for edge milestones */
    .enhanced-milestone-marker-wrapper:first-child .enhanced-milestone-tooltip::after {
        left: 20%;
    }
    
    .enhanced-milestone-marker-wrapper:last-child .enhanced-milestone-tooltip::after {
        left: 80%;
    }

    .enhanced-milestone-marker-wrapper:hover .enhanced-milestone-tooltip {
        opacity: 1;
        visibility: visible;
        transform: translateX(-50%) scale(1);
    }

    .tooltip-header {
        padding: 8px 12px;
        border-bottom: 1px solid rgba(0,0,0,0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #f8f9fa;
        border-radius: 8px 8px 0 0;
    }

    .tooltip-title {
        font-weight: bold;
        color: #495057;
    }

    .tooltip-status {
        font-size: 0.75rem;
        padding: 2px 6px;
        border-radius: 12px;
        font-weight: bold;
    }

    .tooltip-status.not-started {
        background-color: #e9ecef;
        color: #495057;
    }

    .tooltip-status.in-progress {
        background-color: #fff3cd;
        color: #856404;
    }

    .tooltip-status.completed {
        background-color: #d4edda;
        color: #155724;
    }

    .tooltip-body {
        padding: 10px 12px;
        line-height: 1.4;
    }

    .enhanced-current-position-marker {
        position: absolute;
        top: 0;
        transform: translateX(-50%);
        color: #e74a3b;
        font-size: 1.5rem;
        z-index: 4;
        filter: drop-shadow(0 2px 3px rgba(0,0,0,0.3));
        animation: bounce 2s infinite;
    }

    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% {
            transform: translateX(-50%) translateY(0);
        }
        40% {
            transform: translateX(-50%) translateY(-10px);
        }
        60% {
            transform: translateX(-50%) translateY(-5px);
        }
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .enhanced-timeline-container {
            height: 150px;
            margin: 40px 0;
            padding: 15px 20px;
        }
        
        .enhanced-milestone-label {
            font-size: 0.7rem;
        }
        
        .enhanced-milestone-tooltip {
            width: 180px;
        }
    }

    .timeline-visual-container {
        height: 150px;
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 15px 30px; /* Increased horizontal padding */
        position: relative;
        overflow: visible;
        margin: 15px 0 45px; /* Increased bottom margin to accommodate labels */
        border: 1px solid rgba(0,0,0,0.05);
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    /* Progress Bar Styles */
    .progress {
        cursor: pointer;
        transition: all 0.3s ease;
        overflow: visible;
    }

    .progress:hover {
        box-shadow: 0 0 10px rgba(0,123,255,0.5);
    }

    .progress-bar {
        position: relative;
    }

    /* Progress Tooltip */
    .progress-tooltip {
        position: absolute;
        top: -40px;
        right: 0;
        background-color: #343a40;
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.8rem;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
        z-index: 1000;
        white-space: nowrap;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .progress-tooltip::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: #343a40 transparent transparent transparent;
    }

    .progress:hover .progress-tooltip {
        opacity: 1;
        visibility: visible;
    }

    /* Progress Details Modal Styles */
    .progress-lg {
        height: 25px !important;
        border-radius: 15px;
        overflow: hidden;
    }

    .progress-lg .progress-bar {
        line-height: 25px;
        font-weight: bold;
    }

    .progress-stat-card {
        transition: all 0.3s ease;
        border: 1px solid #dee2e6;
    }

    .progress-stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .stat-value {
        font-size: 1.8rem;
        font-weight: bold;
    }
    
    .milestone-marker {
        position: absolute;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        transition: all 0.3s ease;
        z-index: 2;
    }

    .milestone-marker.not-started {
        background-color: #6c757d;
        border: 2px solid #fff;
    }

    .milestone-marker.in-progress {
        background-color: #ffc107;
        border: 2px solid #fff;
    }
    
    .milestone-marker.completed {
        background-color: #28a745;
        border: 2px solid #fff;
    }

    .milestone-marker:hover {
        transform: translateY(-50%) scale(1.2);
        box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }

    .milestone-line {
        position: absolute;
        height: 4px;
        background-color: #dee2e6;
        top: 50%;
        transform: translateY(-50%);
        z-index: 1;
        left: 0;
        right: 0;
    }

    .milestone-progress-fill {
        position: absolute;
        height: 4px;
        background: linear-gradient(90deg, #4481eb 0%, #04befe 100%);
        top: 50%;
        transform: translateY(-50%);
        z-index: 1;
        left: 0;
        width: 0%;
        transition: width 1s ease;
    }

    .milestone-tooltip {
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background-color: #343a40;
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.8rem;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
        z-index: 1000;
        white-space: nowrap;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        pointer-events: none;
    }

    .milestone-tooltip::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: #343a40 transparent transparent transparent;
    }

    .milestone-marker:hover .milestone-tooltip {
        opacity: 1;
        visibility: visible;
    }

    .timeline-status-badge {
        display: inline-block;
        padding: 0.25em 0.6em;
        font-size: 0.75em;
        font-weight: 700;
        line-height: 1;
        text-align: center;
        white-space: nowrap;
        vertical-align: baseline;
        border-radius: 0.25rem;
    }

    .timeline-status-badge.not-started {
        background-color: #6c757d;
        color: white;
    }

    .timeline-status-badge.in-progress {
        background-color: #ffc107;
        color: #212529;
    }

    .timeline-status-badge.completed {
        background-color: #28a745;
        color: white;
    }

    /* Loading indicator styles */
    .loading-spinner-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 38px; /* Standard height of a form-select element */
        background-color: rgba(255, 255, 255, 0.8);
        border-radius: 0.25rem;
    }

    /* Success and error highlight styles for form elements */
    .border-success {
        border-color: #28a745 !important;
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25) !important;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    .border-danger {
        border-color: #dc3545 !important;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
{% csrf_token %}
    <!-- Dashboard Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="d-flex align-items-center">
                {% if mentor.user.profile.avatar %}
                    <img src="{{ mentor.user.profile.avatar.url }}" alt="{{ mentor.user.get_full_name }}" class="rounded-circle me-3" style="width: 60px; height: 60px; object-fit: cover;">
                {% else %}
                    <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-3" style="width: 60px; height: 60px;">
                        <i class="fas fa-user fa-2x"></i>
                </div>
                {% endif %}
                <div>
                    <h2 class="mb-0">Welcome back, {{ mentor.user.get_full_name }}</h2>
                    <p class="text-muted mb-0">
                        <i class="fas fa-map-marker-alt me-1"></i> {{ mentor.user.profile.location|default:"Location not set" }}
                        {% if mentor.user.profile.current_position %}
                            <span class="mx-2">|</span>
                            <i class="fas fa-briefcase me-1"></i> {{ mentor.user.profile.current_position }}
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
        <div class="col-md-4 text-end d-flex align-items-center justify-content-end">
            <div class="me-3">
                <!-- Availability Toggle -->
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="availabilityToggle"
                           {% if mentor.accepting_mentees %}checked{% endif %}
                           data-mentor-id="{{ mentor.id }}"
                           onchange="toggleAvailability()">
                    <label class="form-check-label" for="availabilityToggle">
                        Accepting New Mentees
                    </label>
                </div>
            </div>
            <a href="{% url 'accounts:profile_detail' mentor.user.username %}" class="btn btn-outline-primary">
                <i class="fas fa-user-edit me-1"></i> Edit Profile
            </a>
        </div>
        </div>

        <!-- Stats Overview -->
    <div class="row mb-4">
            <div class="col-md-3">
            <div class="card bg-gradient-primary text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="rounded-circle bg-white bg-opacity-25 p-3">
                            <i class="fas fa-users fa-2x text-white"></i>
                        </div>
                        <h2 class="mb-0">{{ total_active_mentees }}</h2>
                    </div>
                    <h5 class="card-title mb-0">Active Mentees</h5>
                    <div class="progress bg-white bg-opacity-25 mt-3" style="height: 5px;">
                        <div class="progress-bar bg-white" style="width: {{ total_active_mentees|default:0|multiply:20 }}%"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
            <div class="card bg-gradient-warning text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="rounded-circle bg-white bg-opacity-25 p-3">
                            <i class="fas fa-clock fa-2x text-white"></i>
                        </div>
                        <h2 class="mb-0">{{ total_pending_requests }}</h2>
                    </div>
                    <h5 class="card-title mb-0">Pending Requests</h5>
                    <div class="progress bg-white bg-opacity-25 mt-3" style="height: 5px;">
                        <div class="progress-bar bg-white" style="width: {{ total_pending_requests|default:0|multiply:20 }}%"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
            <div class="card bg-gradient-info text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="rounded-circle bg-white bg-opacity-25 p-3">
                            <i class="fas fa-calendar-check fa-2x text-white"></i>
                        </div>
                        <h2 class="mb-0">{{ upcoming_meetings.count }}</h2>
                    </div>
                    <h5 class="card-title mb-0">Upcoming Meetings</h5>
                    <div class="progress bg-white bg-opacity-25 mt-3" style="height: 5px;">
                        <div class="progress-bar bg-white" style="width: {{ upcoming_meetings.count|default:0|multiply:20 }}%"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
            <div class="card bg-gradient-success text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="rounded-circle bg-white bg-opacity-25 p-3">
                            <i class="fas fa-envelope fa-2x text-white"></i>
                        </div>
                        <h2 class="mb-0">{{ unread_messages }}</h2>
                    </div>
                    <h5 class="card-title mb-0">Unread Messages</h5>
                    <div class="progress bg-white bg-opacity-25 mt-3" style="height: 5px;">
                        <div class="progress-bar bg-white" style="width: {{ unread_messages|default:0|multiply:20 }}%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="row">
            <!-- Left Column -->
            <div class="col-md-8">
                <!-- Pending Requests -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Pending Requests</h5>
                        {% if pending_requests %}
                        <span class="badge bg-warning">{{ pending_requests|length }}</span>
                        {% endif %}
                    </div>
                    <div class="card-body">
                    {% if pending_requests %}
                        <div class="list-group">
                        {% for request in pending_requests %}
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">{{ request.mentee.get_full_name }}</h6>
                                <small>{{ request.created_at|timesince }} ago</small>
                            </div>
                                <p class="mb-1">{{ request.message|truncatewords:30 }}</p>
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-success" onclick="updateStatus('{{ request.id }}', 'APPROVED')">
                                        Accept
                                </button>
                                    <button class="btn btn-sm btn-danger" onclick="updateStatus('{{ request.id }}', 'REJECTED')">
                                        Decline
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-muted">No pending requests</p>
                    {% endif %}
                </div>
            </div>

            <!-- Active Mentorships -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Active Mentorships</h5>
                </div>
                <div class="card-body">
                {% if active_mentorships %}
                    <div class="active-mentorships">
                    <div class="accordion" id="mentorshipAccordion">
                    {% for mentorship in active_mentorships %}
                            <div class="accordion-item mentorship-item" data-mentorship-id="{{ mentorship.id }}">
                            <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#mentorship-{{ mentorship.id }}" aria-expanded="false" aria-controls="mentorship-{{ mentorship.id }}">
                                        <span class="mentorship-title">{{ mentorship.mentee.get_full_name }}</span>
                                        <span class="badge bg-primary ms-2">{{ mentorship.get_status_display }}</span>
                                </button>
                            </h2>
                                <div id="mentorship-{{ mentorship.id }}" class="accordion-collapse collapse" data-bs-parent="#mentorshipAccordion">
                                    <div class="accordion-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                            <h6>Goals</h6>
                                            <ul class="list-unstyled">
                                                {% for goal in mentorship.mentorship_goals.all %}
                                                <li>
                                                    <i class="fas fa-check-circle text-{{ goal.status|lower }}"></i>
                                                    {{ goal.title }}
                                                </li>
                                                {% endfor %}
                                            </ul>
                                                    </div>
                                        <div class="col-md-6">
                                            <h6>Skills Progress</h6>
                                            {% for skill in mentorship.skill_progress.all %}
                                            <div class="mb-2">
                                                <small>{{ skill.skill_name }}</small>
                                                <div class="progress">
                                                        <div class="progress-bar progress-bar-skill-{{ forloop.counter }}" 
                                                             role="progressbar"
                                                        aria-valuemin="0"
                                                             aria-valuemax="100"
                                                             data-skill-proficiency="{{ skill.current_proficiency }}">
                                                        {{ skill.get_current_proficiency_display }}
                                                </div>
                                                    </div>
                                                        </div>
                    {% endfor %}
                                                    </div>
                                                </div>
                                    
                                    {% if mentorship.timeline_milestones %}
                                    <div class="mt-3">
                                        <h6>Timeline</h6>
                                            <div class="progress mb-2" style="height: 20px; cursor: pointer;" onclick="showProgressDetails('{{ mentorship.id }}')">
                                                <div class="progress-bar bg-success progress-bar-mentorship-{{ mentorship.id }}" 
                                                     role="progressbar"
                                                         aria-valuemin="0" 
                                                     aria-valuemax="100"
                                                     data-percentage="{{ mentorship.progress_percentage }}">
                                                        {{ mentorship.progress_percentage }}%
                                            </div>
                                                                        </div>
                                                
                                            <!-- Step-Based Progress Tracker removed as requested -->
                                                
                                            <div class="d-flex mt-3">
                                                <button class="btn btn-sm btn-primary me-2" onclick="showProgressDetails('{{ mentorship.id }}')">
                                                    <i class="fas fa-chart-line me-1"></i> View Progress
                                                </button>
                                                <!-- Update Status button removed as requested -->
                                                <button class="btn btn-sm btn-secondary" onclick="setTimeline('{{ mentorship.id }}')">
                                                    <i class="fas fa-calendar-alt me-1"></i> Set Timeline
                                                </button>
                                                <div class="dropdown ms-2">
                                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="mentorshipStatusDropdown{{ mentorship.id }}" data-bs-toggle="dropdown" aria-expanded="false">
                                                        <i class="fas fa-cog me-1"></i> Manage
                                                    </button>
                                                    <ul class="dropdown-menu" aria-labelledby="mentorshipStatusDropdown{{ mentorship.id }}">
                                                        {% if mentorship.status == 'PAUSED' %}
                                                        <li><a class="dropdown-item" href="#" onclick="updateMentorshipStatus('{{ mentorship.id }}', 'APPROVED')"><i class="fas fa-play me-2"></i> Resume Mentorship</a></li>
                                                        {% else %}
                                                        <li><a class="dropdown-item" href="#" onclick="updateMentorshipStatus('{{ mentorship.id }}', 'PAUSED')"><i class="fas fa-pause me-2"></i> Pause Mentorship</a></li>
                                                                        {% endif %}
                                                        <li><a class="dropdown-item" href="#" onclick="updateMentorshipStatus('{{ mentorship.id }}', 'COMPLETED')"><i class="fas fa-check-circle me-2"></i> Complete Mentorship</a></li>
                                                        <li><a class="dropdown-item" href="#" onclick="updateMentorshipStatus('{{ mentorship.id }}', 'CANCELLED')"><i class="fas fa-times-circle me-2"></i> Cancel Mentorship</a></li>
                                                    </ul>
                                                                    </div>
                                                                </div>
                                            
                                            <!-- Hidden timeline text for data storage -->
                                            <pre class="mb-0 small timeline-text" style="display: none;">{{ mentorship.timeline_milestones }}</pre>
                                                            </div>
                                                        {% else %}
                                    <div class="mt-3">
                                        <h6>Timeline</h6>
                                            <div class="progress mb-2" style="height: 20px;">
                                                <div class="progress-bar bg-secondary" role="progressbar" 
                                                     style="width: 0%" 
                                                     aria-valuenow="0" 
                                                     aria-valuemin="0" 
                                                     aria-valuemax="100">
                                                    0%
                                                    </div>
                                                </div>
                                            <div class="d-flex">
                                                <button class="btn btn-sm btn-success me-2" onclick="updateProgress('{{ mentorship.id }}')">
                                                        <i class="fas fa-chart-line me-1"></i> Update Progress
                                                </button>
                                                <button class="btn btn-sm btn-secondary" onclick="setTimeline('{{ mentorship.id }}')">
                                                    <i class="fas fa-calendar-alt me-1"></i> Set Timeline
                                                </button>
                                                <div class="dropdown ms-2">
                                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="mentorshipStatusDropdown{{ mentorship.id }}" data-bs-toggle="dropdown" aria-expanded="false">
                                                        <i class="fas fa-cog me-1"></i> Manage
                                                    </button>
                                                    <ul class="dropdown-menu" aria-labelledby="mentorshipStatusDropdown{{ mentorship.id }}">
                                                        {% if mentorship.status == 'PAUSED' %}
                                                        <li><a class="dropdown-item" href="#" onclick="updateMentorshipStatus('{{ mentorship.id }}', 'APPROVED')"><i class="fas fa-play me-2"></i> Resume Mentorship</a></li>
                                                        {% else %}
                                                        <li><a class="dropdown-item" href="#" onclick="updateMentorshipStatus('{{ mentorship.id }}', 'PAUSED')"><i class="fas fa-pause me-2"></i> Pause Mentorship</a></li>
                                                        {% endif %}
                                                        <li><a class="dropdown-item" href="#" onclick="updateMentorshipStatus('{{ mentorship.id }}', 'COMPLETED')"><i class="fas fa-check-circle me-2"></i> Complete Mentorship</a></li>
                                                        <li><a class="dropdown-item" href="#" onclick="updateMentorshipStatus('{{ mentorship.id }}', 'CANCELLED')"><i class="fas fa-times-circle me-2"></i> Cancel Mentorship</a></li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                {% endif %}
                                    
                                    <div class="mt-3">
                                        <button class="btn btn-sm btn-primary" onclick="scheduleMeeting('{{ mentorship.id }}')">
                                            Schedule Meeting
                                        </button>
                                        <button class="btn btn-sm btn-info" onclick="sendMessage('{{ mentorship.id }}')">
                                            Send Message
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Finished Mentorships Section -->
                    <div class="finished-mentorships" style="display: none;">
                        <div class="finished-mentorships-header">
                            <h5>Completed Mentorships</h5>
                            <span class="finished-mentorships-toggle" onclick="toggleFinishedMentorships()">
                                <i class="fas fa-chevron-down"></i> Show
                            </span>
                        </div>
                        <div class="finished-mentorships-content">
                            <!-- Completed mentorships will be moved here -->
                        </div>
                    </div>
                    {% else %}
                    <p class="text-muted">No active mentorships</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Right Column -->
    <div class="col-md-4">
        <!-- Upcoming Meetings -->
        <div class="card mb-4">
                <div class="card-header">
                <h5 class="mb-0">Upcoming Meetings</h5>
            </div>
            <div class="card-body">
                {% if upcoming_meetings %}
                    <div class="list-group">
                    {% for meeting in upcoming_meetings %}
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">{{ meeting.title }}</h6>
                                <small>{{ meeting.meeting_date|date:"M d, h:i a" }}</small>
                                </div>
                            <p class="mb-1">with {{ meeting.mentorship.mentee.get_full_name }}</p>
                            {% if meeting.meeting_link %}
                            <a href="{{ meeting.meeting_link }}" class="btn btn-primary mt-2 w-100" target="_blank">
                                <i class="fas fa-video me-1"></i> Join Meeting
                            </a>
                            <div class="form-text small mt-1 text-center">
                                Click to join the video call with your mentee
                            </div>
                            {% else %}
                            <div class="alert alert-warning mt-2 p-2 small">
                                <i class="fas fa-exclamation-triangle me-1"></i> No meeting link added
                                <button class="btn btn-sm btn-primary ms-2" onclick="editMeeting('{{ meeting.id }}')">
                                    <i class="fas fa-plus-circle me-1"></i> Add Link
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted">No upcoming meetings</p>
                {% endif %}
            </div>
        </div>

            <!-- Recent Progress -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Recent Progress Updates</h5>
                        </div>
                <div class="card-body">
                    {% if recent_progress %}
                    <div class="list-group">
                        {% for progress in recent_progress %}
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ progress.title }}</h6>
                                <small>{{ progress.created_at|timesince }} ago</small>
                            </div>
                            <p class="mb-1">{{ progress.description|truncatewords:20 }}</p>
                            <small>by {{ progress.mentorship.mentee.get_full_name }}</small>
                    </div>
                    {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted">No recent progress updates</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
</div>

<!-- JavaScript for Interactions -->
<script>
// Single DOMContentLoaded event listener
document.addEventListener('DOMContentLoaded', function() {
    // Initialize all progress bars
    initializeProgressBars();
    
    // Setup error handling for AJAX requests
    setupErrorHandling();
    
    // Initialize Bootstrap components
    initializeBootstrapComponents();
    
    // Initialize milestone buttons
    initializeMilestoneButtons();
    
    // Organize completed mentorships
    organizeCompletedMentorships();
    
    // Load timeline milestones for active mentorships (with debounce)
    setTimeout(() => {
        loadAllTimelineMilestones();
        enhanceTimelineDisplay();
    }, 100);
    
    // Setup mutation observer with throttle
    let timeout;
    const observer = new MutationObserver((mutations) => {
        if (timeout) {
            clearTimeout(timeout);
        }
        timeout = setTimeout(() => {
            updateProgressBars();
        }, 200);
    });
    
    // Observe progress bars with optimized config
    const progressBars = document.querySelectorAll('.progress');
    const config = { 
        attributes: true,
        attributeFilter: ['style']
    };
    
    progressBars.forEach(progress => {
        observer.observe(progress, config);
    });
    
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Initialize popovers
    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
    var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
        return new bootstrap.Popover(popoverTriggerEl);
    });
    
    // Initialize progress bars
    document.querySelectorAll('.progress-bar-mentorship').forEach(function(progressBar) {
        const percentage = progressBar.getAttribute('data-percentage');
        progressBar.style.width = `${percentage}%`;
        progressBar.setAttribute('aria-valuenow', percentage);
    });
    
    // Initialize skill progress bars
    document.querySelectorAll('[data-skill-proficiency]').forEach(function(progressBar) {
        const proficiency = progressBar.getAttribute('data-skill-proficiency');
        const percentage = (proficiency / 5) * 100;
        progressBar.style.width = `${percentage}%`;
        progressBar.setAttribute('aria-valuenow', percentage);
    });
    
    // Step-based progress tracker code removed as requested
});

// Function to initialize milestone buttons
function initializeMilestoneButtons() {
    const addMilestoneBtn = document.getElementById('add-milestone-btn');
    if (addMilestoneBtn) {
        addMilestoneBtn.addEventListener('click', function() {
            const milestonesContainer = document.getElementById('milestones-container');
            const template = document.getElementById('milestone-template');
            
            if (template) {
                const newMilestone = template.querySelector('.milestone-entry').cloneNode(true);
                
                // Add to the container
                milestonesContainer.appendChild(newMilestone);
                
                // Add event listener to the remove button
                const removeBtn = newMilestone.querySelector('.remove-milestone-btn');
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        const milestoneEntry = this.closest('.milestone-entry');
                        if (milestoneEntry && milestoneEntry.parentNode) {
                            // Check if this is the last milestone entry
                            const allEntries = milestonesContainer.querySelectorAll('.milestone-entry');
                            if (allEntries.length === 1) {
                                // If it's the last one, just clear the inputs instead of removing
                                const periodInput = milestoneEntry.querySelector('.milestone-period');
                                const descriptionInput = milestoneEntry.querySelector('.milestone-description');
                                const dateInput = milestoneEntry.querySelector('.milestone-date');
                                
                                if (periodInput) periodInput.value = '';
                                if (descriptionInput) descriptionInput.value = '';
                                if (dateInput) {
                                    dateInput.value = '';
                                    dateInput.classList.remove('is-invalid');
                                }
                            } else {
                                // Otherwise remove it
                                milestoneEntry.parentNode.removeChild(milestoneEntry);
                            }
                            
                            // Re-validate after changes
                            validateAllMilestoneDates();
                        }
                    });
                }
            } else {
                console.error("Milestone template not found");
            }
        });
    }
    
    // Add event listeners to existing remove buttons
    document.querySelectorAll('.remove-milestone-btn').forEach(button => {
        button.addEventListener('click', function() {
            const milestoneEntry = this.closest('.milestone-entry');
            const milestonesContainer = document.getElementById('milestones-container');
            
            if (milestoneEntry && milestoneEntry.parentNode) {
                // Check if this is the last milestone entry
                const allEntries = milestonesContainer.querySelectorAll('.milestone-entry');
                if (allEntries.length === 1) {
                    // If it's the last one, just clear the inputs instead of removing
                    const periodInput = milestoneEntry.querySelector('.milestone-period');
                    const descriptionInput = milestoneEntry.querySelector('.milestone-description');
                    const dateInput = milestoneEntry.querySelector('.milestone-date');
                    
                    if (periodInput) periodInput.value = '';
                    if (descriptionInput) descriptionInput.value = '';
                    if (dateInput) {
                        dateInput.value = '';
                        dateInput.classList.remove('is-invalid');
                    }
                } else {
                    // Otherwise remove it
                    milestoneEntry.parentNode.removeChild(milestoneEntry);
                }
                
                // Re-validate after changes
                validateAllMilestoneDates();
            }
        });
    });
}

// Function to calculate total mentoring days
function calculateMentoringDays() {
    const expectedEndDate = document.getElementById('expectedEndDate');
    const mentoringDaysInfo = document.getElementById('mentoringDaysInfo');
    const totalDaysText = document.getElementById('totalDaysText');
    
    if (!expectedEndDate || !expectedEndDate.value) {
        if (mentoringDaysInfo) mentoringDaysInfo.classList.add('d-none');
        return;
    }
    
    const endDate = new Date(expectedEndDate.value);
    const today = new Date();
    today.setHours(0, 0, 0, 0); // Reset hours to get exact days
    
    // Calculate difference in days
    const diffTime = endDate - today;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays < 0) {
        totalDaysText.textContent = `End date cannot be in the past. Please select a future date.`;
        mentoringDaysInfo.classList.remove('alert-info');
        mentoringDaysInfo.classList.add('alert-danger');
    } else {
        const weeks = Math.floor(diffDays / 7);
        const remainingDays = diffDays % 7;
        
        let timeMessage = '';
        if (weeks > 0) {
            timeMessage += `${weeks} week${weeks > 1 ? 's' : ''}`;
        }
        if (remainingDays > 0) {
            if (weeks > 0) timeMessage += ' and ';
            timeMessage += `${remainingDays} day${remainingDays > 1 ? 's' : ''}`;
        }
        
        totalDaysText.textContent = `Total mentoring time: ${diffDays} days (${timeMessage}).`;
        mentoringDaysInfo.classList.remove('alert-danger');
        mentoringDaysInfo.classList.add('alert-info');
        
        // Validate all milestone dates against this new end date
        validateAllMilestoneDates();
    }
    
    mentoringDaysInfo.classList.remove('d-none');
}

// Function to validate a single milestone date
function validateMilestoneDate(dateInput) {
    const expectedEndDateInput = document.getElementById('expectedEndDate');
    
    if (!expectedEndDateInput || !expectedEndDateInput.value) {
        showToast('warning', 'Please set an expected end date first');
        dateInput.classList.add('is-invalid');
        return false;
    }
    
    const endDate = new Date(expectedEndDateInput.value);
    endDate.setHours(23, 59, 59, 999); // End of the day
    
    const milestoneDate = new Date(dateInput.value);
    milestoneDate.setHours(0, 0, 0, 0); // Start of the day
    
    const today = new Date();
    today.setHours(0, 0, 0, 0); // Start of the day
    today.setDate(today.getDate() - 1); // Allow today by setting comparison to yesterday
    
    if (milestoneDate <= today) { // Using <= to compare with yesterday
        showToast('warning', 'Milestone date cannot be in the past');
        dateInput.classList.add('is-invalid');
        return false;
    }
    
    if (milestoneDate > endDate) {
        showToast('warning', 'Milestone date cannot be after the expected end date');
        dateInput.classList.add('is-invalid');
        return false;
    }
    
    dateInput.classList.remove('is-invalid');
    return true;
}

// Function to validate all milestone dates
function validateAllMilestoneDates() {
    const milestonesContainer = document.getElementById('milestones-container');
    const dateInputs = milestonesContainer.querySelectorAll('.milestone-date');
    
    let allValid = true;
    dateInputs.forEach(input => {
        if (input.value) {
            const isValid = validateMilestoneDate(input);
            if (!isValid) allValid = false;
        }
    });
    
    return allValid;
}

// Toggle between date picker and text input for date
function toggleDateDisplay(element) {
    const inputGroup = element.closest('.input-group');
    const dateInput = inputGroup.querySelector('.milestone-date');
    
    if (dateInput.type === 'date') {
        // Format the date for display as mm/dd/yyyy
        if (dateInput.value) {
            const date = new Date(dateInput.value);
            const formattedDate = `${(date.getMonth()+1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}/${date.getFullYear()}`;
            dateInput.type = 'text';
            dateInput.value = formattedDate;
        } else {
            dateInput.type = 'text';
            dateInput.placeholder = 'mm/dd/yyyy';
        }
    } else {
        dateInput.type = 'date';
    }
}

// Function to toggle availability
function toggleAvailability() {
    const toggle = document.getElementById('availabilityToggle');
    const isAvailable = toggle.checked;
    const mentorId = toggle.dataset.mentorId;
    
    // Debug logging
    console.log('Toggle availability with:', { mentorId, isAvailable });
    
    if (!mentorId) {
        console.error('No mentor ID found in data attribute');
        showToast('error', 'Failed to update availability: No mentor ID found');
        return;
    }

    $.ajax({
        url: `/mentorship/mentor/${mentorId}/toggle-availability/`,
        type: 'POST',
        data: JSON.stringify({ is_available: isAvailable }),
        contentType: 'application/json',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        beforeSend: function(xhr, settings) {
            console.log('Making request to:', settings.url);
        },
        success: function(response) {
            console.log('Toggle success:', response);
            showToast('success', `Availability ${response.accepting_mentees ? 'enabled' : 'disabled'} successfully`);
        },
        error: function(xhr, status, error) {
            console.error('Error toggling availability:', xhr.responseText || error);
            console.error('Status:', status);
            console.error('Status code:', xhr.status);
            let errorMessage = 'Failed to update availability';
            
            // Try to get more specific error message from response
            try {
                const errorData = JSON.parse(xhr.responseText);
                errorMessage = errorData.detail || errorData.message || errorMessage;
            } catch (e) {
                // If we can't parse the response, use the status text
                errorMessage = xhr.statusText ? `Error: ${xhr.statusText}` : errorMessage;
            }
            
            showToast('error', errorMessage);
            // Revert the toggle to its previous state
            toggle.checked = !isAvailable;
        }
    });
}

function updateStatus(requestId, status) {
    if (!confirm('Are you sure you want to update this request?')) {
        return;
    }

    $.ajax({
        url: `{% url "mentorship:update_request_status" 0 %}`.replace('0', requestId),
        type: 'POST',
        data: {
            'status': status,
            'csrfmiddlewaretoken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        success: function(response) {
            showToast('Success', response.message, 'success');
            setTimeout(() => window.location.reload(), 1500);
        },
        error: function(xhr, status, error) {
            showToast('Error', 'Failed to update request status', 'error');
        }
        });
}

function scheduleMeeting(mentorshipId) {
    const modal = new bootstrap.Modal(document.getElementById('scheduleMeetingModal'));
    document.getElementById('mentorshipIdInput').value = mentorshipId;
    modal.show();
}

function sendMessage(mentorshipId) {
    const modal = new bootstrap.Modal(document.getElementById('sendMessageModal'));
    document.getElementById('messageRecipientId').value = mentorshipId;
    modal.show();
}

function updateProgress(mentorshipId) {
    // Show progress update modal
    var progressModal = document.getElementById('progressModal');
    var modal = bootstrap.Modal.getInstance(progressModal) || new bootstrap.Modal(progressModal);
    document.getElementById('mentorshipIdForProgress').value = mentorshipId;
    
    // Fetch current progress percentage
    fetch(`/mentorship/api/requests/${mentorshipId}/`, {
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        // Set current progress percentage
        const progressSlider = document.getElementById('progressPercentage');
        const progressValue = document.getElementById('progressPercentageValue');
        if (progressSlider && progressValue && data.progress_percentage) {
            progressSlider.value = data.progress_percentage;
            progressValue.textContent = data.progress_percentage + '%';
        }
        
        modal.show();
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Failed to fetch current progress. Using default values.');
        modal.show(); // Show modal anyway
    });
}

// Submit progress form
function submitProgress() {
    const mentorshipId = document.getElementById('mentorshipIdForProgress').value;
    const progressTitle = document.getElementById('progressTitle').value;
    const progressDescription = document.getElementById('progressDescription').value;
    const progressPercentage = document.getElementById('progressPercentage').value;
    
    // First create the progress update
    fetch('/mentorship/api/progress/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            mentorship: mentorshipId,
            title: progressTitle,
            description: progressDescription
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to create progress update');
        }
        return response.json();
    })
    .then(data => {
        // Then update the progress percentage
        return fetch(`/mentorship/api/requests/${mentorshipId}/update_timeline/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                progress_percentage: progressPercentage
            })
        });
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to update progress percentage');
        }
        return response.json();
    })
    .then(data => {
        var progressModal = document.getElementById('progressModal');
        var modal = bootstrap.Modal.getInstance(progressModal);
        if (modal) modal.hide();
        
        showToast('success', 'Progress updated successfully');
        setTimeout(() => location.reload(), 1500);
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Failed to update progress. Please try again.');
    });
}

// Submit meeting form
function submitMeeting() {
    const mentorshipId = document.getElementById('mentorshipIdForMeeting').value;
    const meetingTitle = document.getElementById('meetingTitle').value;
    const meetingDate = document.getElementById('meetingDate').value;
    const meetingLink = document.getElementById('meetingLink').value;
    const meetingDescription = document.getElementById('meetingDescription')?.value || '';
    
    // Validate that required fields are filled
    if (!meetingTitle || !meetingDate || !meetingLink) {
        showToast('error', 'Please fill out all required fields, including the meeting link.');
        return;
    }
    
    // Validate that the meeting link is valid
    if (!meetingLink.startsWith('http://') && !meetingLink.startsWith('https://')) {
        showToast('error', 'Please enter a valid meeting link starting with http:// or https://');
        return;
    }
    
    fetch('/mentorship/api/meetings/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            mentorship: mentorshipId,
            title: meetingTitle,
            meeting_date: meetingDate,
            meeting_link: meetingLink,
            description: meetingDescription,
            status: 'SCHEDULED'
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to schedule meeting');
        }
        return response.json();
    })
    .then(data => {
        var meetingModal = document.getElementById('meetingModal');
        var modal = bootstrap.Modal.getInstance(meetingModal);
        if (modal) modal.hide();
        
        showToast('success', 'Meeting scheduled successfully with the link provided');
        setTimeout(() => location.reload(), 1500);
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Failed to schedule meeting. Please try again.');
    });
}

// Submit message form
function submitMessage() {
    const mentorshipId = document.getElementById('mentorshipIdForMessage').value;
    const messageContent = document.getElementById('messageContent').value;
    const messageAttachment = document.getElementById('messageAttachment').files[0];
    
    const formData = new FormData();
    formData.append('mentorship', mentorshipId);
    formData.append('content', messageContent);
    if (messageAttachment) {
        formData.append('attachment', messageAttachment);
    }
    
    fetch('/mentorship/api/messages/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to send message');
        }
        return response.json();
    })
    .then(data => {
        var messageModal = document.getElementById('messageModal');
        var modal = bootstrap.Modal.getInstance(messageModal);
        if (modal) modal.hide();
        
        showToast('success', 'Message sent successfully');
        setTimeout(() => location.reload(), 1500);
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Failed to send message. Please try again.');
    });
}

// Show toast notification
    function showToast(type, message) {
        const toast = document.createElement('div');
        toast.className = `toast toast-${type} show`;
        toast.innerHTML = `
            <div class="toast-header">
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
                <strong class="me-auto">${type === 'success' ? 'Success' : 'Error'}</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        `;
        
        // Add toast container if it doesn't exist
        let container = document.querySelector('.toast-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'toast-container';
            container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            container.style.zIndex = '9999'; // Increased from 1050 to ensure it's always on top
            document.body.appendChild(container);
        }
        
        container.appendChild(toast);
        
        // Initialize Bootstrap toast
        const bsToast = new bootstrap.Toast(toast, {
            autohide: true,
            delay: 3000
        });
        bsToast.show();
        
        // Remove toast after it's hidden
        toast.addEventListener('hidden.bs.toast', () => {
            toast.remove();
        });
    }

// CSRF Token helper
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Function to parse existing timeline milestones when editing
function parseExistingMilestones(timelineText) {
    if (!timelineText) return;
    
    const milestonesContainer = document.getElementById('milestones-container');
    if (!milestonesContainer) {
        console.error('Milestones container not found');
        return;
    }

    // Clear existing milestone entries
    // Use the newer milestone-row class if it exists, otherwise fall back to milestone-entry
    const rowSelector = milestonesContainer.querySelector('.milestone-row') ? '.milestone-row' : '.milestone-entry';
    const existingEntries = milestonesContainer.querySelectorAll(rowSelector);
    
    // Remove all existing entries except the first one
    if (existingEntries.length > 0) {
        for (let i = 1; i < existingEntries.length; i++) {
            milestonesContainer.removeChild(existingEntries[i]);
        }
        
        // Reset the first entry
        const firstEntry = existingEntries[0];
        if (firstEntry) {
            const periodInput = firstEntry.querySelector('.milestone-period');
            const descriptionInput = firstEntry.querySelector('.milestone-description');
            
            if (periodInput) periodInput.value = '';
            if (descriptionInput) descriptionInput.value = '';
        }
    } else {
        // If no entries exist, try to add one using the new function
        if (typeof addNewMilestone === 'function') {
            console.log('Adding first milestone entry using addNewMilestone');
            addNewMilestone();
        } else {
            console.error('No milestone entries found and addNewMilestone function not available');
        }
    }
    
    // Parse the timeline text
    const lines = timelineText.split('\n');
    let additionalNotes = '';
    let inAdditionalNotes = false;
    
    lines.forEach((line, index) => {
        line = line.trim();
        if (!line) return;
        
        if (line.startsWith('Additional Notes:')) {
            inAdditionalNotes = true;
            return;
        }
        
        if (inAdditionalNotes) {
            additionalNotes += line + '\n';
            return;
        }
        
        const weekDayMatch = line.match(/^Week\/Day\s+([^:]+):\s*(.+)$/);
        if (weekDayMatch) {
            const period = weekDayMatch[1];
            let description = weekDayMatch[2];
            
            // Remove status if present
            if (description.includes('[')) {
                description = description.split('[')[0].trim();
            }
            
            // Use newer milestone-row class if it exists, otherwise fall back to milestone-entry
            const rowSelector = milestonesContainer.querySelector('.milestone-row') ? '.milestone-row' : '.milestone-entry';
            const existingEntries = milestonesContainer.querySelectorAll(rowSelector);
            
            if (index === 0 && existingEntries.length > 0) {
                // Use the first entry
                const firstEntry = existingEntries[0];
                if (firstEntry) {
                    const periodInput = firstEntry.querySelector('.milestone-period');
                    const descriptionInput = firstEntry.querySelector('.milestone-description');
                    
                    if (periodInput) periodInput.value = period;
                    if (descriptionInput) descriptionInput.value = description;
                }
            } else {
                // Add a new entry using the newer function if available
                if (typeof addNewMilestone === 'function') {
                    addNewMilestone();
                    
                    // Get the newly created row (should be the last one)
                    const newEntries = milestonesContainer.querySelectorAll(rowSelector);
                    if (newEntries.length > 0) {
                        const newEntry = newEntries[newEntries.length - 1];
                        const periodInput = newEntry.querySelector('.milestone-period');
                        const descriptionInput = newEntry.querySelector('.milestone-description');
                        
                        if (periodInput) periodInput.value = period;
                        if (descriptionInput) descriptionInput.value = description;
                    }
                } else {
                    // Fall back to using the add-milestone-btn click
                    const addMilestoneBtn = document.getElementById('add-milestone-btn');
                    if (addMilestoneBtn) {
                        addMilestoneBtn.click();
                        
                        // Find the new entry (should be the last one)
                        const allEntries = milestonesContainer.querySelectorAll(rowSelector);
                        if (allEntries.length > 0) {
                            const newEntry = allEntries[allEntries.length - 1];
                            if (newEntry) {
                                const periodInput = newEntry.querySelector('.milestone-period');
                                const descriptionInput = newEntry.querySelector('.milestone-description');
                                
                                if (periodInput) periodInput.value = period;
                                if (descriptionInput) descriptionInput.value = description;
                            } else {
                                console.error('Failed to create new milestone entry');
                            }
                        }
                    } else {
                        console.error('Add milestone button not found');
                    }
                }
            }
        }
    });
    
    // Update additional notes field
    if (additionalNotes) {
        const notesField = document.getElementById('timelineMilestones');
        if (notesField) {
            notesField.value = additionalNotes.trim();
        }
    }
}

// Function to set timeline
function setTimeline(mentorshipId) {
    // Show timeline modal
    var timelineModal = document.getElementById('timelineModal');
    if (!timelineModal) {
        console.error('Timeline modal element not found');
        showToast('error', 'Timeline modal not found. Please refresh the page and try again.');
        return;
    }
    
    var modal = bootstrap.Modal.getInstance(timelineModal) || new bootstrap.Modal(timelineModal);
    
    const mentorshipIdInput = document.getElementById('mentorshipIdForTimeline');
    if (!mentorshipIdInput) {
        console.error('Mentorship ID input element not found');
        showToast('error', 'Form elements not found. Please refresh the page and try again.');
        return;
    }
    mentorshipIdInput.value = mentorshipId;
    
    // Clear any previous error
    const errorContainer = document.getElementById('timeline-error-message');
    if (errorContainer) {
        errorContainer.classList.add('d-none');
    }
    
    // Fetch existing timeline data if available
    fetch(`/mentorship/api/requests/${mentorshipId}/`, {
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        const expectedEndDateInput = document.getElementById('expectedEndDate');
        if (expectedEndDateInput && data.expected_end_date) {
            expectedEndDateInput.value = data.expected_end_date.split('T')[0];
        }
        
        if (data.timeline_milestones) {
            parseExistingMilestones(data.timeline_milestones);
        } else {
            // Reset form if no existing timeline
            const milestonesContainer = document.getElementById('milestones-container');
            if (milestonesContainer) {
                const existingEntries = milestonesContainer.querySelectorAll('.milestone-entry');
                if (existingEntries.length > 0) {
                    // Keep only the first entry and reset it
                    for (let i = 1; i < existingEntries.length; i++) {
                        milestonesContainer.removeChild(existingEntries[i]);
                    }
                    const firstEntry = existingEntries[0];
                    if (firstEntry) {
                        const periodInput = firstEntry.querySelector('.milestone-period');
                        const descriptionInput = firstEntry.querySelector('.milestone-description');
                        if (periodInput) periodInput.value = '';
                        if (descriptionInput) descriptionInput.value = '';
                    }
                }
            }
            
            const timelineMilestonesInput = document.getElementById('timelineMilestones');
            if (timelineMilestonesInput) {
                timelineMilestonesInput.value = '';
            }
        }
        modal.show();
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Failed to fetch timeline data. Please try again.');
        modal.show(); // Show modal anyway
    });
}

// Modified submitTimeline function to include validation
function submitTimeline() {
    // Validate dates before submission
    validateAllMilestoneDates();
    
    // Get the timeline alert to check for errors
    const timelineAlert = document.getElementById('timeline-alert');
    if (timelineAlert && !timelineAlert.classList.contains('d-none')) {
        // There are validation errors, don't submit
        showToast('error', 'Please fix the timeline date errors before saving.');
        return;
    }
    
    // Original function continues here...
    const mentorshipId = document.getElementById('mentorshipIdForTimeline').value;
    const expectedEndDate = document.getElementById('expectedEndDate').value;
    const additionalNotes = document.getElementById('timelineMilestones').value;
    
    // Validate required fields
    if (!expectedEndDate) {
        showToast('error', 'Please select an expected end date');
        return;
    }
    
    // Collect all milestone entries
    const milestoneEntries = document.querySelectorAll('.milestone-entry');
    
    // Check if there are any milestone entries
    if (milestoneEntries.length === 0) {
        // Add a new milestone entry if none exist
        const addMilestoneBtn = document.getElementById('add-milestone-btn');
        if (addMilestoneBtn) {
            addMilestoneBtn.click();
            showToast('error', 'Please add at least one milestone with both period and description');
            return;
        }
    }
    
    let formattedMilestones = '';
    let hasValidMilestones = false;
    
    milestoneEntries.forEach(entry => {
        const periodInput = entry.querySelector('.milestone-period');
        const descriptionInput = entry.querySelector('.milestone-description');
        const dateInput = entry.querySelector('.milestone-date');
        
        if (!periodInput || !descriptionInput) return;
        
        const period = periodInput.value.trim();
        const description = descriptionInput.value.trim();
        const date = dateInput ? dateInput.value.trim() : '';
        
        if (period && description) {
            let formattedDescription = description;
            if (date) {
                formattedDescription = `${description} [Date: ${date}]`;
            }
            formattedMilestones += `Week/Day ${period}: ${formattedDescription}\n`;
            hasValidMilestones = true;
        } else if (period || description) {
            // If one field is filled but not the other, highlight the empty field
            if (!period) {
                periodInput.classList.add('is-invalid');
                setTimeout(() => periodInput.classList.remove('is-invalid'), 3000);
            }
            if (!description) {
                descriptionInput.classList.add('is-invalid');
                setTimeout(() => descriptionInput.classList.remove('is-invalid'), 3000);
            }
        }
    });
    
    if (!hasValidMilestones) {
        showToast('error', 'Please add at least one milestone with both period and description');
        return;
    }
    
    // Add additional notes if provided
    if (additionalNotes) {
        formattedMilestones += `\nAdditional Notes:\n${additionalNotes}`;
    }
    
    // Show loading state
    const submitButton = document.querySelector('#timelineModal .btn-primary');
    const originalText = submitButton.textContent;
    submitButton.disabled = true;
    submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
    
    fetch(`/mentorship/api/requests/${mentorshipId}/update_timeline/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            expected_end_date: expectedEndDate,
            timeline_milestones: formattedMilestones
        })
    })
    .then(async response => {
        if (!response.ok) {
            // Try to get error details from response
            const errorData = await response.json().catch(() => null);
            throw new Error(errorData?.detail || `Error: ${response.status} ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        var timelineModal = document.getElementById('timelineModal');
        var modal = bootstrap.Modal.getInstance(timelineModal);
        if (modal) modal.hide();
        
        showToast('success', 'Mentorship timeline updated successfully');
        setTimeout(() => location.reload(), 1500);
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', error.message || 'Failed to update timeline. Please try again.');
        
        // Reset button state
        submitButton.disabled = false;
        submitButton.innerHTML = originalText;
    });
}

// Enhance the timeline display with milestone markers
function enhanceTimelineDisplay() {
    document.querySelectorAll('.timeline-container').forEach(container => {
        const timelineText = container.querySelector('.timeline-text').textContent;
        const progressBar = container.querySelector('.progress');
        let progressPercentage = 0;
        
        // Get the progress percentage from the progress bar if it exists
        if (progressBar && progressBar.querySelector('.progress-bar')) {
            const progressBarStyle = progressBar.querySelector('.progress-bar').getAttribute('style');
            const percentMatch = progressBarStyle.match(/width:\s*(\d+)%/);
            if (percentMatch && percentMatch[1]) {
                progressPercentage = parseInt(percentMatch[1]);
            } else {
                // Fallback to aria-valuenow
                progressPercentage = parseInt(progressBar.querySelector('.progress-bar').getAttribute('aria-valuenow') || 0);
            }
        }
        
        if (!timelineText) return;
        
        // Parse the timeline text to extract milestones
        const lines = timelineText.split('\n');
        let milestones = [];
        let inAdditionalNotes = false;
        
        lines.forEach(line => {
            line = line.trim();
            if (!line) return;
            
            if (line.startsWith('Additional Notes:')) {
                inAdditionalNotes = true;
                return;
            }
            
            if (inAdditionalNotes) {
                return;
            }
            
            const weekDayMatch = line.match(/^Week\/Day\s+([^:]+):\s*(.+)$/);
            if (weekDayMatch) {
                const period = weekDayMatch[1];
                const description = weekDayMatch[2];
                
                // Extract status if available
                let status = 'NOT_STARTED';
                const statusMatch = description.match(/(.+)\s+\[([A-Z_]+)\]$/);
                const cleanDescription = statusMatch ? statusMatch[1].trim() : description;
                if (statusMatch) {
                    status = statusMatch[2];
                }
                
                // Parse the period to get a position for the marker
                let position = 0;
                if (period.includes('-')) {
                    const [start, end] = period.split('-').map(p => parseInt(p.trim()));
                    position = (start + end) / 2;
                } else {
                    position = parseInt(period);
                }
                
                milestones.push({
                    period: period,
                    description: cleanDescription,
                    status: status,
                    position: position
                });
            }
        });
        
        // Create thermometer-style progress bar if milestones exist
        if (milestones.length > 0) {
            // Find the maximum position to scale properly
            const maxPosition = Math.max(...milestones.map(m => m.position));
            
            // Sort milestones by position
            milestones.sort((a, b) => a.position - b.position);
            
            // Calculate completion status
            const totalMilestones = milestones.length;
            const completedMilestones = milestones.filter(m => m.status === 'COMPLETED').length;
            const inProgressMilestones = milestones.filter(m => m.status === 'IN_PROGRESS').length;
            
            // Calculate actual percentage based on milestone completion
            const calculatedPercentage = Math.round((completedMilestones + (inProgressMilestones * 0.5)) / totalMilestones * 100);
            
            // Use the calculated percentage if it's available, otherwise use the one from the progress bar
            const displayPercentage = calculatedPercentage || progressPercentage;
            
            // Create a thermometer-style progress container
            const thermometerContainer = document.createElement('div');
            thermometerContainer.style.position = 'relative';
            thermometerContainer.style.margin = '40px 0 60px';
            thermometerContainer.style.padding = '0 10px';
            
            // Add status text
            const statusElement = document.createElement('div');
            statusElement.style.position = 'absolute';
            statusElement.style.top = '-35px';
            statusElement.style.left = '10px';
            statusElement.style.fontSize = '0.85rem';
            statusElement.style.fontWeight = '500';
            statusElement.style.color = '#495057';
            
            let statusText = '';
            if (displayPercentage === 100) {
                statusText = 'Completed';
            } else if (displayPercentage > 0) {
                statusText = 'In Progress';
            } else {
                statusText = 'Not Started';
            }
            statusElement.textContent = statusText;
            thermometerContainer.appendChild(statusElement);
            
            // Add dates
            const datesContainer = document.createElement('div');
            datesContainer.style.display = 'flex';
            datesContainer.style.justifyContent = 'space-between';
            datesContainer.style.marginBottom = '10px';
            datesContainer.style.fontSize = '0.85rem';
            datesContainer.style.color = '#495057';
            datesContainer.style.fontWeight = '500';
            
            const startDateElement = container.closest('.card-body').querySelector('small:first-child');
            const endDateElement = container.closest('.card-body').querySelector('small:last-child');
            
            const startDate = startDateElement ? startDateElement.textContent.replace('Started: ', '') : 'Start';
            const endDate = endDateElement ? endDateElement.textContent.replace('Target End: ', '') : 'End';
            
            datesContainer.innerHTML = `
                <span>${startDate}</span>
                <span>${endDate}</span>
            `;
            
            thermometerContainer.appendChild(datesContainer);
            
            // Add percentage indicator
            const percentageElement = document.createElement('div');
            percentageElement.style.position = 'absolute';
            percentageElement.style.top = '-35px';
            percentageElement.style.right = '10px';
            percentageElement.style.backgroundColor = '#343a40';
            percentageElement.style.color = 'white';
            percentageElement.style.padding = '4px 10px';
            percentageElement.style.borderRadius = '20px';
            percentageElement.style.fontSize = '0.85rem';
            percentageElement.style.fontWeight = 'bold';
            percentageElement.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
            percentageElement.textContent = `${displayPercentage}%`;
            thermometerContainer.appendChild(percentageElement);
            
            // Create the thermometer track
            const trackElement = document.createElement('div');
            trackElement.style.height = '16px';
            trackElement.style.backgroundColor = '#e9ecef';
            trackElement.style.borderRadius = '8px';
            trackElement.style.position = 'relative';
            trackElement.style.boxShadow = 'inset 0 1px 3px rgba(0,0,0,0.1)';
            trackElement.style.overflow = 'hidden';
            
            // Create the thermometer fill
            const fillElement = document.createElement('div');
            fillElement.style.position = 'absolute';
            fillElement.style.top = '0';
            fillElement.style.left = '0';
            fillElement.style.height = '100%';
            fillElement.style.background = 'linear-gradient(90deg, #4481eb 0%, #04befe 100%)';
            fillElement.style.borderRadius = '8px';
            fillElement.style.transition = 'width 0.6s ease';
            fillElement.style.width = `${displayPercentage}%`;
            
            trackElement.appendChild(fillElement);
            thermometerContainer.appendChild(trackElement);
            
            // Add thermometer bulb
            const bulbElement = document.createElement('div');
            bulbElement.style.position = 'absolute';
            bulbElement.style.left = `${displayPercentage}%`;
            bulbElement.style.top = '8px';
            bulbElement.style.transform = 'translate(-50%, -50%)';
            bulbElement.style.width = '30px';
            bulbElement.style.height = '30px';
            bulbElement.style.background = 'linear-gradient(135deg, #4481eb 0%, #04befe 100%)';
            bulbElement.style.borderRadius = '50%';
            bulbElement.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
            bulbElement.style.zIndex = '2';
            bulbElement.style.border = '3px solid #fff';
            
            // Add shine effect to bulb
            const bulbShine = document.createElement('div');
            bulbShine.style.position = 'absolute';
            bulbShine.style.top = '50%';
            bulbShine.style.left = '50%';
            bulbShine.style.transform = 'translate(-50%, -50%)';
            bulbShine.style.width = '15px';
            bulbShine.style.height = '15px';
            bulbShine.style.background = 'rgba(255, 255, 255, 0.3)';
            bulbShine.style.borderRadius = '50%';
            
            bulbElement.appendChild(bulbShine);
            thermometerContainer.appendChild(bulbElement);
            
            // Create scale marks
            const scaleContainer = document.createElement('div');
            scaleContainer.style.position = 'absolute';
            scaleContainer.style.bottom = '-25px';
            scaleContainer.style.left = '0';
            scaleContainer.style.right = '0';
            
            // Add scale marks at 0%, 25%, 50%, 75%, and 100%
            [0, 25, 50, 75, 100].forEach(percent => {
                const scaleMark = document.createElement('div');
                scaleMark.style.position = 'absolute';
                scaleMark.style.width = '1px';
                scaleMark.style.height = '10px';
                scaleMark.style.backgroundColor = '#6c757d';
                scaleMark.style.bottom = '15px';
                scaleMark.style.left = `${percent}%`;
                
                const scaleLabel = document.createElement('div');
                scaleLabel.style.position = 'absolute';
                scaleLabel.style.transform = 'translateX(-50%)';
                scaleLabel.style.bottom = '0';
                scaleLabel.style.left = `${percent}%`;
                scaleLabel.style.fontSize = '0.75rem';
                scaleLabel.style.color = '#6c757d';
                scaleLabel.textContent = `${percent}%`;
                
                scaleContainer.appendChild(scaleMark);
                scaleContainer.appendChild(scaleLabel);
            });
            
            thermometerContainer.appendChild(scaleContainer);
            
            // Create milestone markers container
            const markersContainer = document.createElement('div');
            markersContainer.style.position = 'relative';
            markersContainer.style.height = '60px';
            markersContainer.style.marginTop = '10px';
            
            // Add milestone markers
            milestones.forEach((milestone, index) => {
                const position = (milestone.position / maxPosition) * 100;
                
                const markerElement = document.createElement('div');
                markerElement.style.position = 'absolute';
                markerElement.style.transform = 'translateX(-50%)';
                markerElement.style.left = `${position}%`;
                
                // Create marker line
                const markerLine = document.createElement('div');
                markerLine.style.width = '2px';
                markerLine.style.height = milestone.status === 'COMPLETED' ? '15px' : 
                                          milestone.status === 'IN_PROGRESS' ? '12px' : '10px';
                markerLine.style.backgroundColor = milestone.status === 'COMPLETED' ? '#28a745' : 
                                                  milestone.status === 'IN_PROGRESS' ? '#ffc107' : '#6c757d';
                markerLine.style.margin = '0 auto 5px';
                
                // Create marker dot
                const markerDot = document.createElement('div');
                markerDot.style.width = '24px';
                markerDot.style.height = '24px';
                markerDot.style.borderRadius = '50%';
                markerDot.style.backgroundColor = milestone.status === 'COMPLETED' ? '#28a745' : 
                                                 milestone.status === 'IN_PROGRESS' ? '#ffc107' : '#e9ecef';
                markerDot.style.border = '3px solid #fff';
                markerDot.style.boxShadow = milestone.status === 'COMPLETED' ? '0 0 0 2px rgba(40, 167, 69, 0.3)' : 
                                           milestone.status === 'IN_PROGRESS' ? '0 0 0 2px rgba(255, 193, 7, 0.3)' : '0 0 0 2px #e9ecef';
                markerDot.style.margin = '0 auto 8px';
                markerDot.style.position = 'relative';
                markerDot.style.zIndex = '3';
                markerDot.style.cursor = 'pointer';
                
                // Create marker label
                const markerLabel = document.createElement('div');
                markerLabel.style.fontSize = '0.8rem';
                markerLabel.style.color = '#495057';
                markerLabel.style.textAlign = 'center';
                markerLabel.style.maxWidth = '100px';
                markerLabel.style.overflow = 'hidden';
                markerLabel.style.textOverflow = 'ellipsis';
                markerLabel.style.whiteSpace = 'nowrap';
                markerLabel.style.fontWeight = '500';
                markerLabel.style.position = 'relative';
                markerLabel.textContent = `Day ${milestone.period}`;
                
                // Create tooltip
                const tooltip = document.createElement('div');
                tooltip.style.position = 'absolute';
                tooltip.style.bottom = '100%';
                tooltip.style.left = '50%';
                tooltip.style.transform = 'translateX(-50%)';
                tooltip.style.backgroundColor = '#343a40';
                tooltip.style.color = 'white';
                tooltip.style.padding = '8px 12px';
                tooltip.style.borderRadius = '4px';
                tooltip.style.fontSize = '0.8rem';
                tooltip.style.whiteSpace = 'nowrap';
                tooltip.style.opacity = '0';
                tooltip.style.visibility = 'hidden';
                tooltip.style.transition = 'opacity 0.3s, visibility 0.3s';
                tooltip.style.zIndex = '10';
                tooltip.style.pointerEvents = 'none';
                tooltip.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
                tooltip.style.minWidth = '150px';
                tooltip.style.textAlign = 'center';
                tooltip.style.marginBottom = '10px';
                
                let statusText = 'Not Started';
                if (milestone.status === 'IN_PROGRESS') {
                    statusText = 'In Progress';
                } else if (milestone.status === 'COMPLETED') {
                    statusText = 'Completed';
                }
                
                tooltip.innerHTML = `
                    <div>${milestone.description}</div>
                    <div style="margin-top: 5px; font-weight: bold; color: ${
                        milestone.status === 'COMPLETED' ? '#28a745' : 
                        milestone.status === 'IN_PROGRESS' ? '#ffc107' : '#6c757d'
                    }">
                        ${statusText}
                    </div>
                `;
                
                // Add tooltip arrow
                const tooltipArrow = document.createElement('div');
                tooltipArrow.style.position = 'absolute';
                tooltipArrow.style.top = '100%';
                tooltipArrow.style.left = '50%';
                tooltipArrow.style.transform = 'translateX(-50%)';
                tooltipArrow.style.borderWidth = '6px';
                tooltipArrow.style.borderStyle = 'solid';
                tooltipArrow.style.borderColor = '#343a40 transparent transparent transparent';
                
                tooltip.appendChild(tooltipArrow);
                
                // Show tooltip on hover
                markerDot.addEventListener('mouseenter', () => {
                    tooltip.style.opacity = '1';
                    tooltip.style.visibility = 'visible';
                });
                
                markerDot.addEventListener('mouseleave', () => {
                    tooltip.style.opacity = '0';
                    tooltip.style.visibility = 'hidden';
                });
                
                markerElement.appendChild(tooltip);
                markerElement.appendChild(markerLine);
                markerElement.appendChild(markerDot);
                markerElement.appendChild(markerLabel);
                
                markersContainer.appendChild(markerElement);
            });
            
            thermometerContainer.appendChild(markersContainer);
            
            // Replace the original progress bar with our thermometer version
            if (progressBar) {
                progressBar.style.display = 'none';
                progressBar.parentNode.insertBefore(thermometerContainer, progressBar.nextSibling);
            } else {
                // If no progress bar exists, just add it to the container
                container.insertBefore(thermometerContainer, container.firstChild);
            }
            
            // Hide the original timeline text
            const timelineTextElement = container.querySelector('.timeline-text');
            timelineTextElement.style.display = 'none';
            
            // Add a button to toggle the original text
            const toggleButton = document.createElement('button');
            toggleButton.className = 'btn btn-sm btn-outline-secondary mt-2';
            toggleButton.textContent = 'Show Original Timeline';
            toggleButton.addEventListener('click', function() {
                if (timelineTextElement.style.display === 'none') {
                    timelineTextElement.style.display = 'block';
                    this.textContent = 'Hide Original Timeline';
                } else {
                    timelineTextElement.style.display = 'none';
                    this.textContent = 'Show Original Timeline';
                }
            });
            
            thermometerContainer.parentNode.insertBefore(toggleButton, thermometerContainer.nextSibling);
        }
    });
}

// Function to show the timeline status modal
function showTimelineStatusModal(mentorshipId) {
    // Show timeline status modal
    var statusModal = document.getElementById('timelineStatusModal');
    var modal = bootstrap.Modal.getInstance(statusModal) || new bootstrap.Modal(statusModal);
    document.getElementById('mentorshipIdForStatus').value = mentorshipId;
    
    // Fetch timeline milestones
    fetch(`/mentorship/api/requests/${mentorshipId}/`, {
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        loadTimelineMilestones(data.timeline_milestones, mentorshipId);
        modal.show();
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Failed to fetch timeline data. Please try again.');
        modal.show(); // Show modal anyway
    });
}

// Function to load timeline milestones
function loadTimelineMilestones(timelineText, mentorshipId) {
    const container = document.getElementById('milestone-status-container');
    const noMilestonesMessage = document.getElementById('no-milestones-message');
    
    // Clear existing content
    container.innerHTML = '';
    
    if (!timelineText) {
        container.appendChild(noMilestonesMessage);
        return;
    }
    
    // Parse the timeline text to extract milestones
    const lines = timelineText.split('\n');
    let milestones = [];
    let inAdditionalNotes = false;
    
    lines.forEach(line => {
        line = line.trim();
        if (!line) return;
        
        if (line.startsWith('Additional Notes:')) {
            inAdditionalNotes = true;
            return;
        }
        
        if (inAdditionalNotes) {
            return;
        }
        
        const weekDayMatch = line.match(/^Week\/Day\s+([^:]+):\s*(.+)$/);
        if (weekDayMatch) {
            const period = weekDayMatch[1];
            const description = weekDayMatch[2];
            
            // Extract status if available
            let status = 'NOT_STARTED';
            const statusMatch = description.match(/(.+)\s+\[([A-Z_]+)\]$/);
            const cleanDescription = statusMatch ? statusMatch[1].trim() : description;
            if (statusMatch) {
                status = statusMatch[2];
            }
            
            milestones.push({
                period: period,
                description: cleanDescription,
                status: status
            });
        }
    });
    
    if (milestones.length === 0) {
        container.appendChild(noMilestonesMessage);
        return;
    }
    
    // Create milestone status items
    milestones.forEach(milestone => {
        const statusItem = document.createElement('div');
        statusItem.className = 'milestone-status-item';
        
        statusItem.innerHTML = `
            <div class="milestone-title">Week/Day ${milestone.period}</div>
            <div class="milestone-description">${milestone.description}</div>
            <div class="form-group">
                <label class="form-label">Status</label>
                <select class="form-select milestone-status" data-period="${milestone.period}" data-description="${milestone.description}">
                    <option value="NOT_STARTED" ${milestone.status === 'NOT_STARTED' ? 'selected' : ''}>Not Started</option>
                    <option value="IN_PROGRESS" ${milestone.status === 'IN_PROGRESS' ? 'selected' : ''}>In Progress</option>
                    <option value="COMPLETED" ${milestone.status === 'COMPLETED' ? 'selected' : ''}>Completed</option>
                </select>
            </div>
        `;
        
        container.appendChild(statusItem);
    });
    
    // Also update the enhanced timeline display
    updateEnhancedTimelineDisplay(mentorshipId, milestones);
}

// Function to save timeline status
function saveTimelineStatus() {
    const mentorshipId = document.getElementById('mentorshipIdForStatus').value;
    
    // Collect milestone status updates
    const milestoneStatuses = [];
    document.querySelectorAll('.milestone-status').forEach(dropdown => {
        milestoneStatuses.push({
            period: dropdown.getAttribute('data-period'),
            description: dropdown.getAttribute('data-description'),
            status: dropdown.value
        });
    });
    
    // Update milestone statuses
    fetch('/mentorship/api/milestones/update_batch/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            mentorship: mentorshipId,
            milestones: milestoneStatuses
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to update milestone statuses');
        }
        return response.json();
    })
    .then(data => {
        // Then update the timeline text with status
        return fetch(`/mentorship/api/requests/${mentorshipId}/update_timeline/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                update_milestones_in_timeline: true,
                milestone_statuses: milestoneStatuses
            })
        });
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to update timeline');
        }
        return response.json();
    })
    .then(data => {
        var statusModal = document.getElementById('timelineStatusModal');
        var modal = bootstrap.Modal.getInstance(statusModal);
        if (modal) modal.hide();
        
        showToast('success', 'Timeline status updated successfully');
        setTimeout(() => location.reload(), 1500);
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Failed to update timeline status. Please try again.');
    });
}

// Function to update the enhanced timeline display
function updateEnhancedTimelineDisplay(mentorshipId, milestones) {
    const timelineContainer = document.getElementById(`timeline-milestones-${mentorshipId}`);
    if (!timelineContainer) return;
    
    // Clear existing content
    timelineContainer.innerHTML = '';
    
    // Sort milestones by period
    milestones.sort((a, b) => {
        const periodA = a.period.includes('-') ? 
            parseInt(a.period.split('-')[0]) : parseInt(a.period);
        const periodB = b.period.includes('-') ? 
            parseInt(b.period.split('-')[0]) : parseInt(b.period);
        return periodA - periodB;
    });
    
    // Create milestone cards
    milestones.forEach((milestone, index) => {
        const milestoneElement = document.createElement('div');
        milestoneElement.className = 'timeline-milestone';
        
        // Extract topics from description (if any)
        let description = milestone.description;
        let topics = [];
        
        // Check if description contains topics (bullet points)
        if (description.includes('')) {
            const parts = description.split('');
            description = parts[0].trim();
            topics = parts.slice(1).map(topic => topic.trim()).filter(topic => topic);
        }
        
        // Determine status class
        const statusClass = milestone.status.toLowerCase().replace('_', '-');
        
        // Create milestone card
        milestoneElement.innerHTML = `
            <div class="timeline-milestone-card">
                <div class="timeline-milestone-header ${statusClass}">
                    <span>Week/Day ${milestone.period}</span>
                    <span>${milestone.status === 'COMPLETED' ? 'Completed' : 
                           milestone.status === 'IN_PROGRESS' ? 'In Progress' : 'Not Started'}</span>
                </div>
                <div class="timeline-milestone-title">${description}</div>
                ${topics.length > 0 ? `
                <div class="timeline-milestone-topics">
                    <div class="timeline-milestone-topics-title">Topics/Activities:</div>
                    <ul>
                        ${topics.map(topic => `<li>${topic}</li>`).join('')}
                    </ul>
                </div>
                ` : ''}
                <select class="timeline-milestone-status-select" 
                        data-period="${milestone.period}" 
                        data-description="${milestone.description}"
                        onchange="updateMilestoneStatus(this, '${mentorshipId}')">
                    <option value="NOT_STARTED" ${milestone.status === 'NOT_STARTED' ? 'selected' : ''}>Not Started</option>
                    <option value="IN_PROGRESS" ${milestone.status === 'IN_PROGRESS' ? 'selected' : ''}>In Progress</option>
                    <option value="COMPLETED" ${milestone.status === 'COMPLETED' ? 'selected' : ''}>Completed</option>
                </select>
            </div>
            <div class="timeline-milestone-dot ${statusClass}"></div>
        `;
        
        timelineContainer.appendChild(milestoneElement);
    });
}

// Function to update a single milestone status directly from the timeline
function updateMilestoneStatus(selectElement, mentorshipId) {
    const period = selectElement.getAttribute('data-period');
    const description = selectElement.getAttribute('data-description');
    const status = selectElement.value;
    
    // Update milestone status
    fetch('/mentorship/api/milestones/update_batch/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            mentorship: mentorshipId,
            milestones: [{
                period: period,
                description: description,
                status: status
            }]
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to update milestone status');
        }
        return response.json();
    })
    .then(data => {
        // Then update the timeline text with status
        return fetch(`/mentorship/api/requests/${mentorshipId}/update_timeline/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                update_milestones_in_timeline: true,
                milestone_statuses: [{
                    period: period,
                    description: description,
                    status: status
                }]
            })
        });
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to update timeline');
        }
        return response.json();
    })
    .then(data => {
        showToast('success', 'Milestone status updated');
        
        // Update the UI without reloading
        const card = selectElement.closest('.timeline-milestone-card');
        const header = card.querySelector('.timeline-milestone-header');
        const dot = selectElement.closest('.timeline-milestone').querySelector('.timeline-milestone-dot');
        
        // Update status classes
        header.className = 'timeline-milestone-header';
        dot.className = 'timeline-milestone-dot';
        
        const statusClass = status.toLowerCase().replace('_', '-');
        header.classList.add(statusClass);
        dot.classList.add(statusClass);
        
        // Update status text
        const statusText = status === 'COMPLETED' ? 'Completed' : 
                          status === 'IN_PROGRESS' ? 'In Progress' : 'Not Started';
        header.querySelector('span:last-child').textContent = statusText;
        
        // Calculate new progress percentage
        calculateProgressPercentage(mentorshipId);
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Failed to update milestone status');
        
        // Reset the select to its previous value
        selectElement.value = selectElement.getAttribute('data-previous-value');
    });
    
    // Store the current value for potential rollback
    selectElement.setAttribute('data-previous-value', status);
}

// Function to calculate progress percentage based on milestone statuses
function calculateProgressPercentage(mentorshipId) {
    // Get all milestone status selects
    const selects = document.querySelectorAll(`#timeline-milestones-${mentorshipId} .timeline-milestone-status-select`);
    if (selects.length === 0) return;
    
    // Count completed and in-progress milestones
    let completed = 0;
    let inProgress = 0;
    
    selects.forEach(select => {
        if (select.value === 'COMPLETED') {
            completed++;
        } else if (select.value === 'IN_PROGRESS') {
            inProgress++;
        }
    });
    
    // Calculate percentage (completed + half of in-progress)
    const total = selects.length;
    const percentage = Math.round((completed + (inProgress * 0.5)) / total * 100);
    
    // Update progress bar
    const progressBar = document.querySelector(`#mentorship${mentorshipId} .progress-bar`);
    if (progressBar) {
        progressBar.style.width = `${percentage}%`;
        progressBar.setAttribute('aria-valuenow', percentage);
        progressBar.textContent = `${percentage}%`;
        
        // Step-progress-bar update code removed as requested
        
        // Also update the progress percentage on the server
        fetch(`/mentorship/api/requests/${mentorshipId}/update_timeline/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                progress_percentage: percentage
            })
        })
        .catch(error => {
            console.error('Error updating progress percentage:', error);
        });
    }
}

// Function to toggle timeline text view
function toggleTimelineText(mentorshipId) {
    const timelineText = document.querySelector(`#mentorship${mentorshipId} .timeline-text`);
    const toggleButton = document.querySelector(`#toggle-text-${mentorshipId}`);
    
    if (timelineText.style.display === 'none') {
        timelineText.style.display = 'block';
        toggleButton.textContent = 'Hide Text View';
    } else {
        timelineText.style.display = 'none';
        toggleButton.textContent = 'Show Text View';
    }
}

// Initialize enhanced timeline displays when the DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // ... existing code ...
    
    // Initialize enhanced timeline displays
    document.querySelectorAll('.timeline-container').forEach(container => {
        const mentorshipId = container.closest('.accordion-collapse').id.replace('mentorship-', '');
        const timelineText = container.querySelector('.timeline-text').textContent;
        
        if (timelineText) {
            // Parse the timeline text to extract milestones
            const lines = timelineText.split('\n');
            let milestones = [];
            let inAdditionalNotes = false;
            
            lines.forEach(line => {
                line = line.trim();
                if (!line) return;
                
                if (line.startsWith('Additional Notes:')) {
                    inAdditionalNotes = true;
                    return;
                }
                
                if (inAdditionalNotes) {
                    return;
                }
                
                const weekDayMatch = line.match(/^Week\/Day\s+([^:]+):\s*(.+)$/);
                if (weekDayMatch) {
                    const period = weekDayMatch[1];
                    const description = weekDayMatch[2];
                    
                    // Extract status if available
                    let status = 'NOT_STARTED';
                    const statusMatch = description.match(/(.+)\s+\[([A-Z_]+)\]$/);
                    const cleanDescription = statusMatch ? statusMatch[1].trim() : description;
                    if (statusMatch) {
                        status = statusMatch[2];
                    }
                    
                    milestones.push({
                        period: period,
                        description: cleanDescription,
                        status: status
                    });
                }
            });
            
            // Update the enhanced timeline display
            updateEnhancedTimelineDisplay(mentorshipId, milestones);
        }
    });
});

// Function to show progress details modal
function showProgressDetails(mentorshipId) {
    try {
        // Validate mentorshipId
        if (!mentorshipId || mentorshipId === '') {
            console.error('Invalid mentorship ID');
            showToast('error', 'Error loading progress details: Invalid mentorship ID');
            return;
        }
        
        // Show progress details modal
        var progressDetailsModal = document.getElementById('progressDetailsModal');
        if (!progressDetailsModal) {
            console.error('Progress details modal element not found');
            showToast('error', 'Error loading progress details: Modal not found');
            return;
        }
        
        var modal = bootstrap.Modal.getInstance(progressDetailsModal) || new bootstrap.Modal(progressDetailsModal);
        
        // Log the mentorship ID to help with debugging
        console.log('Fetching details for mentorship ID:', mentorshipId);
        
        // Fetch mentorship data
        fetch(`/mentorship/api/requests/${mentorshipId}/`, {
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            if (!response.ok) {
                // More detailed error handling
                if (response.status === 404) {
                    throw new Error('Mentorship not found. It may have been deleted or you may not have access.');
                } else if (response.status === 403) {
                    throw new Error('Permission denied. You do not have access to this mentorship.');
                } else if (response.status >= 500) {
                    throw new Error('Server error. Please try again later.');
                } else {
                    // Try to get more details from the response if possible
                    return response.json()
                        .then(errData => {
                            throw new Error(errData.detail || errData.message || `Network response error: ${response.status} ${response.statusText}`);
                        })
                        .catch(jsonErr => {
                            // If we can't parse the JSON, just use the status
                            throw new Error(`Network response error: ${response.status} ${response.statusText}`);
                        });
                }
            }
            return response.json();
        })
        .then(data => {
            try {
                // Update progress percentage
                const progressPercentage = data.progress_percentage || 0;
                const progressBar = document.querySelector('#progressDetailsModal .progress-bar');
                const progressDisplay = document.querySelector('#progressDetailsModal .progress-percentage-display');
                
                if (progressBar) {
                    progressBar.style.width = `${progressPercentage}%`;
                    progressBar.setAttribute('aria-valuenow', progressPercentage);
                    progressBar.textContent = `${progressPercentage}%`;
                }
                
                if (progressDisplay) {
                    progressDisplay.textContent = `${progressPercentage}%`;
                }
                
                // Parse timeline milestones
                if (data.timeline_milestones) {
                    parseMilestonesForDetails(data.timeline_milestones, mentorshipId);
                } else {
                    // Clear milestone displays if no timeline
                    const elements = {
                        completed: document.getElementById('completed-milestones'),
                        inProgress: document.getElementById('in-progress-milestones'),
                        notStarted: document.getElementById('not-started-milestones'),
                        total: document.getElementById('total-milestones'),
                        container: document.getElementById('timeline-visual-container'),
                        tableBody: document.getElementById('milestone-table-body')
                    };
                    
                    // Safely update elements if they exist
                    if (elements.completed) elements.completed.textContent = '0';
                    if (elements.inProgress) elements.inProgress.textContent = '0';
                    if (elements.notStarted) elements.notStarted.textContent = '0';
                    if (elements.total) elements.total.textContent = '0';
                    
                    if (elements.container) {
                        elements.container.innerHTML = '<div class="text-center py-4 text-muted"><i class="fas fa-info-circle me-2"></i>No timeline milestones found</div>';
                    }
                    
                    if (elements.tableBody) {
                        elements.tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No milestones found</td></tr>';
                    }
                }
                
                // Show the modal
                modal.show();
            } catch (innerError) {
                console.error('Error processing mentorship data:', innerError);
                showToast('error', 'Error processing mentorship data');
            }
        })
        .catch(error => {
            console.error('Error fetching mentorship data:', error);
            // Show a more informative error message to the user
            showToast('error', `Failed to fetch progress details: ${error.message || 'Please try again.'}`);
            // Optionally close the modal if it's showing a loading state
            if (modal && typeof modal.hide === 'function') {
                modal.hide();
            }
        });
    } catch (error) {
        console.error('Error in showProgressDetails:', error);
        showToast('error', 'An unexpected error occurred');
    }
}

// Function to parse milestones for the details modal
function parseMilestonesForDetails(timelineText, mentorshipId) {
    try {
        if (!timelineText) {
            console.warn('No timeline text provided to parseMilestonesForDetails');
            return;
        }
        
        // Parse the timeline text to extract milestones
        const lines = timelineText.split('\n');
        let milestones = [];
        let inAdditionalNotes = false;
        
        lines.forEach(line => {
            line = line.trim();
            if (!line) return;
            
            if (line.startsWith('Additional Notes:')) {
                inAdditionalNotes = true;
                return;
            }
            
            if (inAdditionalNotes) {
                return;
            }
            
            const weekDayMatch = line.match(/^Week\/Day\s+([^:]+):\s*(.+)$/);
            if (weekDayMatch) {
                const period = weekDayMatch[1];
                const description = weekDayMatch[2];
                
                // Extract status if available
                let status = 'NOT_STARTED';
                const statusMatch = description.match(/(.+)\s+\[([A-Z_]+)\]$/);
                const cleanDescription = statusMatch ? statusMatch[1].trim() : description;
                if (statusMatch) {
                    status = statusMatch[2];
                }
                
                // Parse the period to get a position for the marker
                let position = 0;
                try {
                    if (period.includes('-')) {
                        const [start, end] = period.split('-').map(p => parseInt(p.trim()));
                        position = (start + end) / 2;
                    } else {
                        position = parseInt(period);
                    }
                    
                    // Handle NaN case
                    if (isNaN(position)) {
                        position = milestones.length + 1;
                    }
                } catch (error) {
                    console.warn('Error parsing period position:', error);
                    position = milestones.length + 1;
                }
                
                milestones.push({
                    period: period,
                    description: cleanDescription,
                    status: status,
                    position: position
                });
            }
        });
        
        // Sort milestones by position
        milestones.sort((a, b) => a.position - b.position);
        
        // Update milestone statistics
        const completedCount = milestones.filter(m => m.status === 'COMPLETED').length;
        const inProgressCount = milestones.filter(m => m.status === 'IN_PROGRESS').length;
        const notStartedCount = milestones.filter(m => m.status === 'NOT_STARTED').length;
        const totalCount = milestones.length;
        
        // Safely update DOM elements
        const elements = {
            completed: document.getElementById('completed-milestones'),
            inProgress: document.getElementById('in-progress-milestones'),
            notStarted: document.getElementById('not-started-milestones'),
            total: document.getElementById('total-milestones')
        };
        
        if (elements.completed) elements.completed.textContent = completedCount;
        if (elements.inProgress) elements.inProgress.textContent = inProgressCount;
        if (elements.notStarted) elements.notStarted.textContent = notStartedCount;
        if (elements.total) elements.total.textContent = totalCount;
        
        // Render timeline visualization
        renderTimelineVisualization(milestones);
        
        // Render milestone table
        renderMilestoneTable(milestones, mentorshipId);
    } catch (error) {
        console.error('Error parsing milestones:', error);
        showToast('error', 'Error parsing milestone data');
    }
}

// Function to render timeline visualization
function renderTimelineVisualization(milestones) {
    try {
        const container = document.getElementById('timeline-visual-container');
        if (!container) {
            console.error('Timeline container element not found');
            return;
        }
        
        container.innerHTML = '';
        
        if (!milestones || milestones.length === 0) {
            container.innerHTML = '<div class="text-center py-4 text-muted"><i class="fas fa-info-circle me-2"></i>No timeline milestones found</div>';
            return;
        }
        
        // Find the maximum position to scale properly
        const maxPosition = Math.max(...milestones.map(m => m.position));
        
        // Create the timeline container with enhanced styling
        const timelineContainer = document.createElement('div');
        timelineContainer.className = 'enhanced-timeline-container';
        container.appendChild(timelineContainer);
        
        // Create the timeline line
        const timelineLine = document.createElement('div');
        timelineLine.className = 'enhanced-timeline-line';
        timelineContainer.appendChild(timelineLine);
        
        // Create the progress fill
        const progressFill = document.createElement('div');
        progressFill.className = 'enhanced-timeline-progress-fill';
        timelineContainer.appendChild(progressFill);
        
        // Calculate progress percentage based on milestones
        const completedMilestones = milestones.filter(m => m.status === 'COMPLETED').length;
        const inProgressMilestones = milestones.filter(m => m.status === 'IN_PROGRESS').length;
        const progressPercentage = Math.round((completedMilestones + (inProgressMilestones * 0.5)) / milestones.length * 100);
        
        // Update the progress badge
        const progressBadge = document.getElementById('timeline-progress-badge');
        if (progressBadge) {
            progressBadge.textContent = `${progressPercentage}%`;
            
            // Update badge color based on progress
            progressBadge.className = 'badge';
            if (progressPercentage < 25) {
                progressBadge.classList.add('bg-danger');
            } else if (progressPercentage < 50) {
                progressBadge.classList.add('bg-warning');
            } else if (progressPercentage < 75) {
                progressBadge.classList.add('bg-info');
            } else if (progressPercentage < 100) {
                progressBadge.classList.add('bg-primary');
            } else {
                progressBadge.classList.add('bg-success');
            }
        }
        
        // Animate the progress fill
        setTimeout(() => {
            progressFill.style.width = `${progressPercentage}%`;
        }, 300);
        
        // Add padding to ensure markers don't overflow
        // Use 10% padding on each side to keep markers within bounds
        const paddingPercentage = 10;
        const usableWidth = 100 - (paddingPercentage * 2);
        
        // Add milestone markers with enhanced styling
        milestones.forEach((milestone, index) => {
            try {
                // Calculate position with padding to prevent overflow
                // Map the position from 0-100% to paddingPercentage-(100-paddingPercentage)%
                const rawPosition = (milestone.position / maxPosition) * 100;
                const adjustedPosition = (rawPosition * usableWidth / 100) + paddingPercentage;
                
                // Create milestone marker wrapper
                const markerWrapper = document.createElement('div');
                markerWrapper.className = 'enhanced-milestone-marker-wrapper';
                markerWrapper.style.left = `${adjustedPosition}%`;
                timelineContainer.appendChild(markerWrapper);
                
                // Create the actual marker
                const markerElement = document.createElement('div');
                markerElement.className = `enhanced-milestone-marker ${milestone.status.toLowerCase().replace('_', '-')}`;
                
                // Add milestone number inside marker
                markerElement.innerHTML = `<span>${index + 1}</span>`;
                markerWrapper.appendChild(markerElement);
                
                // Create tooltip with enhanced styling
                const tooltip = document.createElement('div');
                tooltip.className = 'enhanced-milestone-tooltip';
                
                let statusText = 'Not Started';
                let statusClass = 'not-started';
                if (milestone.status === 'IN_PROGRESS') {
                    statusText = 'In Progress';
                    statusClass = 'in-progress';
                } else if (milestone.status === 'COMPLETED') {
                    statusText = 'Completed';
                    statusClass = 'completed';
                }
                
                tooltip.innerHTML = `
                    <div class="tooltip-header">
                        <span class="tooltip-title">Week/Day ${milestone.period}</span>
                        <span class="tooltip-status ${statusClass}">${statusText}</span>
                    </div>
                    <div class="tooltip-body">${milestone.description}</div>
                `;
                
                markerWrapper.appendChild(tooltip);
                
                // Add click event to show milestone details
                markerWrapper.addEventListener('click', function() {
                    try {
                        // Highlight the corresponding row in the milestone table
                        const tableRows = document.querySelectorAll('#milestone-table-body tr');
                        tableRows.forEach((row, rowIndex) => {
                            if (rowIndex === index) {
                                row.classList.add('table-active');
                                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            } else {
                                row.classList.remove('table-active');
                            }
                        });
                    } catch (clickError) {
                        console.warn('Error in milestone click handler:', clickError);
                    }
                });
            } catch (milestoneError) {
                console.warn(`Error rendering milestone ${index}:`, milestoneError);
            }
        });
        
        // Add current position indicator if there are in-progress milestones
        if (inProgressMilestones > 0) {
            try {
                const currentPositionMarker = document.createElement('div');
                currentPositionMarker.className = 'enhanced-current-position-marker';
                currentPositionMarker.innerHTML = '<i class="fas fa-map-marker-alt"></i>';
                
                // Adjust the position of the current marker to match the progress fill
                const adjustedProgressPosition = (progressPercentage * usableWidth / 100) + paddingPercentage;
                currentPositionMarker.style.left = `${adjustedProgressPosition}%`;
                
                timelineContainer.appendChild(currentPositionMarker);
            } catch (markerError) {
                console.warn('Error adding current position marker:', markerError);
            }
        }
        
        // Removed the milestone labels below the timeline as requested
    } catch (error) {
        console.error('Error rendering timeline visualization:', error);
        const container = document.getElementById('timeline-visual-container');
        if (container) {
            container.innerHTML = '<div class="text-center py-4 text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error rendering timeline</div>';
        }
    }
}

// Function to render milestone table
function renderMilestoneTable(milestones, mentorshipId) {
    try {
        const tableBody = document.getElementById('milestone-table-body');
        if (!tableBody) {
            console.error('Milestone table body element not found');
            return;
        }
        
        tableBody.innerHTML = '';
        
        if (!milestones || milestones.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No milestones found</td></tr>';
            return;
        }
        
        milestones.forEach((milestone, index) => {
            try {
                const row = document.createElement('tr');
                
                let statusText = 'Not Started';
                let statusClass = 'not-started';
                if (milestone.status === 'IN_PROGRESS') {
                    statusText = 'In Progress';
                    statusClass = 'in-progress';
                } else if (milestone.status === 'COMPLETED') {
                    statusText = 'Completed';
                    statusClass = 'completed';
                }
                
                // Safely escape HTML to prevent XSS
                const safeDescription = milestone.description
                    ? milestone.description.replace(/</g, '&lt;').replace(/>/g, '&gt;')
                    : '';
                const safePeriod = milestone.period
                    ? milestone.period.replace(/</g, '&lt;').replace(/>/g, '&gt;')
                    : '';
                
                row.innerHTML = `
                    <td>Week/Day ${safePeriod}</td>
                    <td>${safeDescription}</td>
                    <td><span class="timeline-status-badge ${statusClass}">${statusText}</span></td>
                    <td>
                        <select class="form-select form-select-sm milestone-quick-status" 
                                data-period="${safePeriod}" 
                                data-description="${safeDescription}"
                                data-mentorship="${mentorshipId}"
                                onchange="updateQuickMilestoneStatus(this)">
                            <option value="NOT_STARTED" ${milestone.status === 'NOT_STARTED' ? 'selected' : ''}>Not Started</option>
                            <option value="IN_PROGRESS" ${milestone.status === 'IN_PROGRESS' ? 'selected' : ''}>In Progress</option>
                            <option value="COMPLETED" ${milestone.status === 'COMPLETED' ? 'selected' : ''}>Completed</option>
                        </select>
                    </td>
                `;
                
                tableBody.appendChild(row);
            } catch (rowError) {
                console.warn(`Error rendering milestone row ${index}:`, rowError);
            }
        });
    } catch (error) {
        console.error('Error rendering milestone table:', error);
        const tableBody = document.getElementById('milestone-table-body');
        if (tableBody) {
            tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error rendering milestone table</td></tr>';
        }
    }
}

// Function to update a single milestone status from the details modal
function updateQuickMilestoneStatus(selectElement) {
    try {
        const period = selectElement.getAttribute('data-period');
        const description = selectElement.getAttribute('data-description');
        const mentorshipId = selectElement.getAttribute('data-mentorship');
        const status = selectElement.value;
        
        // Validate required data
        if (!period || !mentorshipId || !status) {
            console.error('Missing required data for milestone update:', { period, mentorshipId, status });
            showToast('error', 'Missing required data for milestone update');
            return;
        }
        
        // Store the original select element and its parent for later reference
        const parentElement = selectElement.parentElement;
        const originalHtml = parentElement.innerHTML;
        
        // Create and insert a loading spinner that preserves the width of the original element
        const originalWidth = parentElement.offsetWidth;
        parentElement.innerHTML = `<div class="d-flex justify-content-center align-items-center" style="min-width: ${originalWidth}px;">
            <div class="spinner-border spinner-border-sm text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>`;
        
        // Skip the milestone update API and go directly to the timeline update
        // This avoids the need for milestone IDs which we don't have in the UI
        fetch(`/mentorship/api/requests/${mentorshipId}/update_timeline/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                update_milestones_in_timeline: true,
                milestone_statuses: [{
                    period: period,
                    description: description,
                    status: status
                }]
            })
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    try {
                        // Try to parse as JSON
                        const errorData = JSON.parse(text);
                        throw new Error(`Failed to update timeline: ${JSON.stringify(errorData)}`);
                    } catch (e) {
                        // If not JSON, use text
                        throw new Error(`Failed to update timeline: ${text || response.statusText}`);
                    }
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Timeline update successful:', data);
            showToast('success', 'Milestone status updated');
            
            // Update the UI to reflect the changes
            try {
                // Update the milestone status in the UI
                const milestoneMarkers = document.querySelectorAll('.enhanced-milestone-marker-wrapper');
                milestoneMarkers.forEach((marker, index) => {
                    const tooltip = marker.querySelector('.tooltip-status');
                    if (tooltip) {
                        const tooltipTitle = marker.querySelector('.tooltip-title');
                        if (tooltipTitle && tooltipTitle.textContent.includes(period)) {
                            // Update the status class
                            tooltip.className = 'tooltip-status';
                            tooltip.classList.add(status.toLowerCase().replace('_', '-'));
                            
                            // Update the status text
                            let statusText = 'Not Started';
                            if (status === 'IN_PROGRESS') statusText = 'In Progress';
                            if (status === 'COMPLETED') statusText = 'Completed';
                            tooltip.textContent = statusText;
                            
                            // Update the marker class
                            const markerElement = marker.querySelector('.enhanced-milestone-marker');
                            if (markerElement) {
                                markerElement.className = 'enhanced-milestone-marker';
                                markerElement.classList.add(status.toLowerCase().replace('_', '-'));
                            }
                        }
                    }
                });
                
                // Update the table row status
                const tableRows = document.querySelectorAll('#milestone-table-body tr');
                tableRows.forEach(row => {
                    const periodCell = row.querySelector('td:first-child');
                    if (periodCell && periodCell.textContent.includes(period)) {
                        const statusCell = row.querySelector('td:nth-child(3) .timeline-status-badge');
                        if (statusCell) {
                            statusCell.className = 'timeline-status-badge';
                            let statusClass = 'not-started';
                            let statusText = 'Not Started';
                            
                            if (status === 'IN_PROGRESS') {
                                statusClass = 'in-progress';
                                statusText = 'In Progress';
                            } else if (status === 'COMPLETED') {
                                statusClass = 'completed';
                                statusText = 'Completed';
                            }
                            
                            statusCell.classList.add(statusClass);
                            statusCell.textContent = statusText;
                        }
                    }
                });
                
                // Update the progress stats
                updateProgressStats();
            } catch (updateError) {
                console.warn('Error updating UI after status change:', updateError);
            } finally {
                // Always restore the select element with the updated value
                if (parentElement) {
                    parentElement.innerHTML = originalHtml;
                    // Re-select the current value
                    const newSelect = parentElement.querySelector('select');
                    if (newSelect) {
                        newSelect.value = status;
                        // Add a brief highlight effect to indicate the update was successful
                        newSelect.classList.add('border-success');
                        setTimeout(() => {
                            newSelect.classList.remove('border-success');
                        }, 1500);
                    }
                }
            }
        })
        .catch(error => {
            console.error('Error in milestone update process:', error);
            showToast('error', error.message || 'Failed to update milestone status');
            
            // Restore the original HTML
            if (parentElement) {
                parentElement.innerHTML = originalHtml;
                // Highlight the error
                const newSelect = parentElement.querySelector('select');
                if (newSelect) {
                    newSelect.classList.add('border-danger');
                    setTimeout(() => {
                        newSelect.classList.remove('border-danger');
                    }, 1500);
                }
            }
        });
    } catch (error) {
        console.error('Unexpected error in updateQuickMilestoneStatus:', error);
        showToast('error', 'An unexpected error occurred');
        
        // Try to restore the original state
        try {
            if (selectElement && selectElement.parentElement) {
                selectElement.parentElement.innerHTML = originalHtml;
            }
        } catch (e) {
            console.warn('Could not restore original HTML:', e);
        }
    }
}

// Function to update progress stats without refreshing the entire modal
function updateProgressStats() {
    try {
        const milestones = [];
        const tableRows = document.querySelectorAll('#milestone-table-body tr');
        
        // Collect milestone data from the table
        tableRows.forEach(row => {
            const statusBadge = row.querySelector('.timeline-status-badge');
            if (statusBadge) {
                let status = 'NOT_STARTED';
                if (statusBadge.classList.contains('in-progress')) status = 'IN_PROGRESS';
                if (statusBadge.classList.contains('completed')) status = 'COMPLETED';
                milestones.push({ status });
            }
        });
        
        // Calculate stats
        const completedCount = milestones.filter(m => m.status === 'COMPLETED').length;
        const inProgressCount = milestones.filter(m => m.status === 'IN_PROGRESS').length;
        const notStartedCount = milestones.filter(m => m.status === 'NOT_STARTED').length;
        const totalCount = milestones.length;
        
        // Update the stats display
        const elements = {
            completed: document.getElementById('completed-milestones'),
            inProgress: document.getElementById('in-progress-milestones'),
            notStarted: document.getElementById('not-started-milestones'),
            total: document.getElementById('total-milestones')
        };
        
        if (elements.completed) elements.completed.textContent = completedCount;
        if (elements.inProgress) elements.inProgress.textContent = inProgressCount;
        if (elements.notStarted) elements.notStarted.textContent = notStartedCount;
        if (elements.total) elements.total.textContent = totalCount;
        
        // Calculate progress percentage
        const progressPercentage = Math.round((completedCount + (inProgressCount * 0.5)) / totalCount * 100);
        
        // Update progress bar
        const progressBar = document.querySelector('#progressDetailsModal .progress-bar');
        const progressDisplay = document.querySelector('#progressDetailsModal .progress-percentage-display');
        const progressBadge = document.getElementById('timeline-progress-badge');
        
        if (progressBar) {
            progressBar.style.width = `${progressPercentage}%`;
            progressBar.setAttribute('aria-valuenow', progressPercentage);
            progressBar.textContent = `${progressPercentage}%`;
        }
        
        if (progressDisplay) {
            progressDisplay.textContent = `${progressPercentage}%`;
        }
        
        if (progressBadge) {
            progressBadge.textContent = `${progressPercentage}%`;
            
            // Update badge color based on progress
            progressBadge.className = 'badge';
            if (progressPercentage < 25) {
                progressBadge.classList.add('bg-danger');
            } else if (progressPercentage < 50) {
                progressBadge.classList.add('bg-warning');
            } else if (progressPercentage < 75) {
                progressBadge.classList.add('bg-info');
            } else if (progressPercentage < 100) {
                progressBadge.classList.add('bg-primary');
            } else {
                progressBadge.classList.add('bg-success');
            }
        }
        
        // Update progress fill in the timeline visualization
        const progressFill = document.querySelector('.enhanced-timeline-progress-fill');
        if (progressFill) {
            progressFill.style.width = `${progressPercentage}%`;
        }
        
        // Update current position marker if it exists
        const currentPositionMarker = document.querySelector('.enhanced-current-position-marker');
        if (currentPositionMarker && inProgressCount > 0) {
            // Calculate the adjusted position
            const paddingPercentage = 10;
            const usableWidth = 100 - (paddingPercentage * 2);
            const adjustedProgressPosition = (progressPercentage * usableWidth / 100) + paddingPercentage;
            currentPositionMarker.style.left = `${adjustedProgressPosition}%`;
        }
    } catch (error) {
        console.warn('Error updating progress stats:', error);
    }
}

// Function to update quick progress removed as it's no longer needed

// Add event listener to progress bars to show the details modal
document.addEventListener('DOMContentLoaded', function() {
    // Add click event to progress bars
    document.querySelectorAll('.progress').forEach(progressBar => {
        progressBar.addEventListener('click', function() {
            const mentorshipId = this.closest('.accordion-collapse').id.replace('mentorship-', '');
            showProgressDetails(mentorshipId);
        });
        
        // Add tooltip to progress bars
        const tooltip = document.createElement('div');
        tooltip.className = 'progress-tooltip';
        tooltip.textContent = 'Click for detailed progress';
        progressBar.appendChild(tooltip);
    });
});

// Function to load all timeline milestones
function loadAllTimelineMilestones() {
    document.querySelectorAll('[id^="timeline-milestones-"]').forEach(function(container) {
        const mentorshipId = container.id.replace('timeline-milestones-', '');
        const timelineText = document.querySelector(`#mentorship-${mentorshipId} .timeline-text`);
        if (timelineText && timelineText.textContent) {
            updateEnhancedTimelineDisplay(mentorshipId, parseTimelineText(timelineText.textContent));
        }
    });
    
    // Step-based progress tracker code removed as requested
}

// Function to check if a mentorship is completed
function isMentorshipCompleted(mentorship) {
    // Consider a mentorship completed if progress is 100% or all milestones are completed
    return mentorship.progress_percentage >= 100;
}

// Function to move completed mentorships to the finished section
function organizeCompletedMentorships() {
    const activeMentorshipsContainer = document.querySelector('.active-mentorships');
    const finishedMentorshipsContainer = document.querySelector('.finished-mentorships-content');
    
    if (!activeMentorshipsContainer || !finishedMentorshipsContainer) return;
    
    // Check each mentorship
    document.querySelectorAll('.mentorship-item').forEach(function(mentorshipItem) {
        const mentorshipId = mentorshipItem.getAttribute('data-mentorship-id');
        const progressBar = mentorshipItem.querySelector('.progress-bar');
        
        if (progressBar) {
            const progressPercentage = parseInt(progressBar.getAttribute('aria-valuenow') || 0);
            
            // If progress is 100%, move to finished section
            if (progressPercentage >= 100) {
                // Clone the item to avoid removing event listeners
                const clonedItem = mentorshipItem.cloneNode(true);
                finishedMentorshipsContainer.appendChild(clonedItem);
                
                // Add a completed badge
                const badge = document.createElement('span');
                badge.className = 'badge bg-success ms-2';
                badge.textContent = 'Completed';
                clonedItem.querySelector('.mentorship-title').appendChild(badge);
                
                // Hide the original item
                mentorshipItem.style.display = 'none';
            }
        }
    });
    
    // Show the finished mentorships section if there are any
    if (finishedMentorshipsContainer.children.length > 0) {
        document.querySelector('.finished-mentorships').style.display = 'block';
    } else {
        document.querySelector('.finished-mentorships').style.display = 'none';
    }
}

// Toggle finished mentorships visibility
function toggleFinishedMentorships() {
    const content = document.querySelector('.finished-mentorships-content');
    const toggleButton = document.querySelector('.finished-mentorships-toggle');
    
    if (content.classList.contains('show')) {
        content.classList.remove('show');
        toggleButton.innerHTML = '<i class="fas fa-chevron-down"></i> Show';
    } else {
        content.classList.add('show');
        toggleButton.innerHTML = '<i class="fas fa-chevron-up"></i> Hide';
    }
}

// Function to parse timeline text into milestone objects
function parseTimelineText(timelineText) {
    if (!timelineText) return [];
    
    const lines = timelineText.split('\n');
    let milestones = [];
    let inAdditionalNotes = false;
    
    lines.forEach(line => {
        line = line.trim();
        if (!line) return;
        
        if (line.startsWith('Additional Notes:')) {
            inAdditionalNotes = true;
            return;
        }
        
        if (inAdditionalNotes) {
            return;
        }
        
        const weekDayMatch = line.match(/^Week\/Day\s+([^:]+):\s*(.+)$/);
        if (weekDayMatch) {
            const period = weekDayMatch[1];
            const description = weekDayMatch[2];
            
            // Extract status if available
            let status = 'NOT_STARTED';
            const statusMatch = description.match(/(.+)\s+\[([A-Z_]+)\]$/);
            const cleanDescription = statusMatch ? statusMatch[1].trim() : description;
            if (statusMatch) {
                status = statusMatch[2];
            }
            
            milestones.push({
                period: period,
                description: cleanDescription,
                status: status
            });
        }
    });
    
    return milestones;
}

// Function to initialize all progress bars
function initializeProgressBars() {
    document.querySelectorAll('.progress-bar').forEach(progressBar => {
        const percentage = progressBar.dataset.percentage || '0';
        progressBar.style.width = `${percentage}%`;
        progressBar.setAttribute('aria-valuenow', percentage);
        progressBar.textContent = `${percentage}%`;
    });

    document.querySelectorAll('.progress-bar-skill').forEach((skillBar, index) => {
        const proficiency = skillBar.dataset.skillProficiency || '0';
        skillBar.style.width = `${proficiency}%`;
        skillBar.style.backgroundColor = getSkillColor(index);
    });
}

// Function to get color for skill progress bars
function getSkillColor(index) {
    const colors = [
        '#4e73df', // Primary
        '#1cc88a', // Success
        '#36b9cc', // Info
        '#f6c23e', // Warning
        '#e74a3b'  // Danger
    ];
    return colors[index % colors.length];
}

// Function to setup error handling
function setupErrorHandling() {
    $(document).ajaxError(function(event, jqXHR, settings, error) {
        console.error('AJAX Error:', error);
        showToast('Error', 'An error occurred. Please try again.', 'error');
    });
}

// Function to initialize Bootstrap components
function initializeBootstrapComponents() {
    // Initialize tooltips
    const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    tooltips.forEach(tooltip => new bootstrap.Tooltip(tooltip));

    // Initialize popovers
    const popovers = document.querySelectorAll('[data-bs-toggle="popover"]');
    popovers.forEach(popover => new bootstrap.Popover(popover));
}

// Function to setup mutation observer
function setupMutationObserver() {
    const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            if (mutation.type === 'childList' || mutation.type === 'attributes') {
                initializeProgressBars();
            }
        });
    });

    const config = { 
        attributes: true, 
        childList: true, 
        subtree: true 
    };

    document.querySelectorAll('.progress').forEach(progress => {
        observer.observe(progress, config);
    });
}

// Function to update mentorship status
function updateMentorshipStatus(mentorshipId, newStatus) {
    // Show a confirmation modal with reason input
    const statusLabels = {
        'PAUSED': 'Pause',
        'APPROVED': 'Resume',
        'COMPLETED': 'Complete',
        'CANCELLED': 'Cancel'
    };
    
    const actionLabel = statusLabels[newStatus] || 'Update';
    
    // Create and show modal
    const modalHtml = `
        <div class="modal fade" id="updateStatusModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">${actionLabel} Mentorship</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
                    <div class="modal-body">
                        <p>Are you sure you want to ${actionLabel.toLowerCase()} this mentorship?</p>
                        <div class="mb-3">
                            <label for="statusReason" class="form-label">Reason (optional)</label>
                            <textarea class="form-control" id="statusReason" rows="3" placeholder="Please provide a reason for this status change..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="confirmStatusUpdate">Confirm</button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Remove any existing modal
    const existingModal = document.getElementById('updateStatusModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add the modal to the DOM
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Initialize the modal
    const modal = new bootstrap.Modal(document.getElementById('updateStatusModal'));
    modal.show();
    
    // Handle confirmation
    document.getElementById('confirmStatusUpdate').addEventListener('click', function() {
        const reason = document.getElementById('statusReason').value;
        
        // Send AJAX request to update status
    $.ajax({
            url: `/mentorship/api/update-mentorship-status/${mentorshipId}/`,
        type: 'POST',
            data: JSON.stringify({ 
                status: newStatus,
                reason: reason
            }),
            contentType: 'application/json',
        success: function(response) {
                modal.hide();
                showToast('success', response.message);
                
                // Update UI based on the new status
                const mentorshipItem = document.querySelector(`.mentorship-item[data-mentorship-id="${mentorshipId}"]`);
                if (mentorshipItem) {
                    const statusBadge = mentorshipItem.querySelector('.badge');
                    if (statusBadge) {
                        // Update badge text and class
                        statusBadge.textContent = newStatus.charAt(0) + newStatus.slice(1).toLowerCase();
                        
                        // Remove existing status classes
                        statusBadge.classList.remove('bg-primary', 'bg-warning', 'bg-success', 'bg-danger');
                        
                        // Add appropriate class based on status
                        if (newStatus === 'PAUSED') {
                            statusBadge.classList.add('bg-warning');
                        } else if (newStatus === 'COMPLETED') {
                            statusBadge.classList.add('bg-success');
                            
                            // Move to finished mentorships section if completed or cancelled
                            const finishedSection = document.querySelector('.finished-mentorships-content');
                            if (finishedSection && (newStatus === 'COMPLETED' || newStatus === 'CANCELLED')) {
                                finishedSection.appendChild(mentorshipItem);
                                
                                // Show the finished mentorships section if it was hidden
                                document.querySelector('.finished-mentorships').style.display = 'block';
                            }
                        } else if (newStatus === 'CANCELLED') {
                            statusBadge.classList.add('bg-danger');
                            
                            // Move to finished mentorships section if completed or cancelled
                            const finishedSection = document.querySelector('.finished-mentorships-content');
                            if (finishedSection && (newStatus === 'COMPLETED' || newStatus === 'CANCELLED')) {
                                finishedSection.appendChild(mentorshipItem);
                                
                                // Show the finished mentorships section if it was hidden
                                document.querySelector('.finished-mentorships').style.display = 'block';
                            }
                        } else {
                            statusBadge.classList.add('bg-primary');
                        }
                    }
                    
                    // Update dropdown options based on new status
                    const dropdownMenu = mentorshipItem.querySelector('.dropdown-menu');
                    if (dropdownMenu) {
                        if (newStatus === 'PAUSED') {
                            dropdownMenu.innerHTML = `
                                <li><a class="dropdown-item" href="#" onclick="updateMentorshipStatus('${mentorshipId}', 'APPROVED')"><i class="fas fa-play me-2"></i> Resume Mentorship</a></li>
                                <li><a class="dropdown-item" href="#" onclick="updateMentorshipStatus('${mentorshipId}', 'COMPLETED')"><i class="fas fa-check-circle me-2"></i> Complete Mentorship</a></li>
                                <li><a class="dropdown-item" href="#" onclick="updateMentorshipStatus('${mentorshipId}', 'CANCELLED')"><i class="fas fa-times-circle me-2"></i> Cancel Mentorship</a></li>
                            `;
                        } else if (newStatus === 'APPROVED') {
                            dropdownMenu.innerHTML = `
                                <li><a class="dropdown-item" href="#" onclick="updateMentorshipStatus('${mentorshipId}', 'PAUSED')"><i class="fas fa-pause me-2"></i> Pause Mentorship</a></li>
                                <li><a class="dropdown-item" href="#" onclick="updateMentorshipStatus('${mentorshipId}', 'COMPLETED')"><i class="fas fa-check-circle me-2"></i> Complete Mentorship</a></li>
                                <li><a class="dropdown-item" href="#" onclick="updateMentorshipStatus('${mentorshipId}', 'CANCELLED')"><i class="fas fa-times-circle me-2"></i> Cancel Mentorship</a></li>
                            `;
                        }
                    }
                }
                
                // Reload the page if completed or cancelled to refresh the mentorship lists
                if (newStatus === 'COMPLETED' || newStatus === 'CANCELLED') {
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                }
            },
            error: function(xhr) {
                console.error('Error updating mentorship status:', xhr);
                showToast('error', xhr.responseJSON?.error || 'Failed to update mentorship status');
            }
        });
    });
}

// ... existing code ...
</script>

<!-- Timeline Modal -->
<div class="modal fade" id="timelineModal" tabindex="-1" aria-labelledby="timelineModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="timelineModalLabel">
                    <i class="fas fa-calendar-alt me-2"></i>Set Mentorship Timeline
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <form id="timelineForm">
                    <input type="hidden" id="mentorshipIdForTimeline">
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card shadow-sm border-0 h-100">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">
                                        <i class="fas fa-calendar-check me-2 text-primary"></i>Timeline Period
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <label for="expectedEndDate" class="form-label">Expected End Date</label>
                                    <div class="input-group mb-3">
                                        <span class="input-group-text bg-primary text-white">
                                            <i class="fas fa-flag-checkered"></i>
                                        </span>
                                        <input type="date" class="form-control form-control-lg" id="expectedEndDate" required onchange="calculateMentoringDays()">
                                    </div>
                                    <div class="form-text">Set the target date for completing this mentorship</div>
                                    <div id="mentoringDaysInfo" class="mt-3 alert alert-info d-flex align-items-center">
                                        <i class="fas fa-info-circle me-3 fs-4"></i>
                                        <span id="totalDaysText" class="fw-bold"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card shadow-sm border-0 h-100">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">
                                        <i class="fas fa-clipboard-list me-2 text-primary"></i>Predefined Templates
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <label for="templateSelector" class="form-label">Select a Template</label>
                                    <div class="input-group mb-3">
                                        <select class="form-select form-select-lg" id="templateSelector">
                                            <option value="" selected>Select a template (optional)</option>
                                            <option value="technical-8-week">8-Week Technical Mentorship</option>
                                            <option value="career-12-week">12-Week Career Development</option>
                                            <option value="research-project">Research Project Mentorship</option>
                                            <option value="startup-mentoring">Startup Mentoring</option>
                                            <option value="leadership-development">Leadership Development</option>
                                        </select>
                                        <button class="btn btn-primary px-4" type="button" id="applyTemplateBtn">
                                            <i class="fas fa-check me-2"></i>Apply
                                        </button>
                                    </div>
                                    <div class="form-text">Choose a template to automatically populate milestones based on best practices</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card shadow-sm border-0 mb-4">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="fas fa-map-marker-alt me-2 text-primary"></i>Timeline Milestones
                            </h6>
                            <button type="button" class="btn btn-primary btn-sm" id="add-milestone-btn">
                                <i class="fas fa-plus me-1"></i> Add Milestone
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="timeline-alert" class="alert alert-danger d-none">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <span id="timeline-alert-message"></span>
                            </div>
                            
                            <div id="milestones-container">
                                <!-- Milestone entries will be dynamically added here -->
                            </div>
                            
                            <!-- Hidden template for new milestone rows -->
                            <table id="milestone-template-table" style="display: none;">
                                <tbody>
                                    <tr class="milestone-row row mb-3 pb-3 border-bottom align-items-center">
                                        <td class="col-md-2">
                                            <label class="form-label d-md-none">Week/Day:</label>
                                            <input type="text" class="form-control milestone-period" placeholder="1-2" required>
                                        </td>
                                        <td class="col-md-3">
                                            <label class="form-label d-md-none">Date:</label>
                                            <div class="input-group">
                                                <input type="date" class="form-control milestone-date" onchange="validateMilestoneDate(this)">
                                                <span class="input-group-text date-toggle" onclick="toggleDateDisplay(this)">
                                                    <i class="fas fa-calendar-alt"></i>
                                                </span>
                                            </div>
                                        </td>
                                        <td class="col-md-6">
                                            <label class="form-label d-md-none">Description:</label>
                                            <input type="text" class="form-control milestone-description" placeholder="Milestone description" required>
                                        </td>
                                        <td class="col-md-1 text-center">
                                            <button type="button" class="btn btn-outline-danger remove-milestone-btn mt-md-0 mt-2">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="card shadow-sm border-0 mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="fas fa-sticky-note me-2 text-primary"></i>Additional Notes
                            </h6>
                        </div>
                        <div class="card-body">
                            <textarea class="form-control" id="timelineMilestones" rows="3" placeholder="Any additional notes or details about the timeline"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer bg-light justify-content-between">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary btn-lg px-4" id="saveTimeline" onclick="submitTimeline()">
                    <i class="fas fa-save me-2"></i>Save Timeline
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Update the initializeMilestoneButtons function to work with the new table layout
function initializeMilestoneButtons() {
    const addMilestoneBtn = document.getElementById('add-milestone-btn');
    if (addMilestoneBtn) {
        addMilestoneBtn.addEventListener('click', function() {
            const milestonesContainer = document.getElementById('milestones-container');
            const templateTable = document.getElementById('milestone-template-table');
            
            if (templateTable) {
                const templateRow = templateTable.querySelector('tr').cloneNode(true);
                
                // Add to the table
                milestonesContainer.appendChild(templateRow);
                
                // Add event listener to the remove button
                const removeBtn = templateRow.querySelector('.remove-milestone-btn');
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        const milestoneEntry = this.closest('.milestone-entry');
                        if (milestoneEntry && milestoneEntry.parentNode) {
                            // Check if this is the last milestone entry
                            const allEntries = milestonesContainer.querySelectorAll('.milestone-entry');
                            if (allEntries.length === 1) {
                                // If it's the last one, just clear the inputs instead of removing
                                const periodInput = milestoneEntry.querySelector('.milestone-period');
                                const descriptionInput = milestoneEntry.querySelector('.milestone-description');
                                const dateInput = milestoneEntry.querySelector('.milestone-date');
                                
                                if (periodInput) periodInput.value = '';
                                if (descriptionInput) descriptionInput.value = '';
                                if (dateInput) {
                                    dateInput.value = '';
                                    dateInput.classList.remove('is-invalid');
                                }
                            } else {
                                // Otherwise remove it
                                milestoneEntry.parentNode.removeChild(milestoneEntry);
                            }
                            
                            // Re-validate after changes
                            validateAllMilestoneDates();
                        }
                    });
                }
            } else {
                console.error("Template table not found");
            }
        });
    }
    
    // Add event listeners to existing remove buttons
    document.querySelectorAll('.remove-milestone-btn').forEach(button => {
        button.addEventListener('click', function() {
            const milestoneEntry = this.closest('.milestone-entry');
            const milestonesContainer = document.getElementById('milestones-container');
            
            if (milestoneEntry && milestoneEntry.parentNode) {
                // Check if this is the last milestone entry
                const allEntries = milestonesContainer.querySelectorAll('.milestone-entry');
                if (allEntries.length === 1) {
                    // If it's the last one, just clear the inputs instead of removing
                    const periodInput = milestoneEntry.querySelector('.milestone-period');
                    const descriptionInput = milestoneEntry.querySelector('.milestone-description');
                    const dateInput = milestoneEntry.querySelector('.milestone-date');
                    
                    if (periodInput) periodInput.value = '';
                    if (descriptionInput) descriptionInput.value = '';
                    if (dateInput) {
                        dateInput.value = '';
                        dateInput.classList.remove('is-invalid');
                    }
                } else {
                    // Otherwise remove it
                    milestoneEntry.parentNode.removeChild(milestoneEntry);
                }
                
                // Re-validate after changes
                validateAllMilestoneDates();
            }
        });
    });
}

// Function to apply a milestone template - updated for table layout
function applyMilestoneTemplate(templateId) {
    const template = milestoneTemplates[templateId];
    if (!template) {
        showToast('error', 'Template not found');
        return;
    }
    
    // Get end date to calculate milestone dates
    const expectedEndDateInput = document.getElementById('expectedEndDate');
    if (!expectedEndDateInput || !expectedEndDateInput.value) {
        // If end date is not set, set it automatically based on template
        setExpectedEndDateFromTemplate(templateId);
        
        if (!expectedEndDateInput.value) {
            showToast('warning', 'Could not set expected end date');
            return;
        }
    }
    
    // Clear existing milestones
    const milestonesContainer = document.getElementById('milestones-container');
    milestonesContainer.innerHTML = '';
    
    // Calculate dates based on the timeline span
    // Start from TOMORROW instead of today
    const startDate = new Date();
    startDate.setDate(startDate.getDate() + 1); // Add 1 day to get tomorrow
    startDate.setHours(0, 0, 0, 0);
    
    const endDate = new Date(expectedEndDateInput.value);
    endDate.setHours(0, 0, 0, 0);
    
    // Calculate total duration in days
    const totalDuration = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24));
    
    // Get the template's original duration
    const templateDuration = getTemplateDuration(templateId) - 7; // Subtract the buffer we added
    
    // Apply template milestones
    template.forEach((milestone, index) => {
        // Calculate adjusted day offset based on the actual timeline duration
        let adjustedDayOffset;
        
        if (templateDuration <= 0) {
            // Fallback: Distribute evenly if template duration is invalid
            adjustedDayOffset = Math.floor((totalDuration * index) / (template.length - 1));
        } else {
            // Scale the day offset proportionally to fit the actual timeline
            const scaleFactor = totalDuration / templateDuration;
            adjustedDayOffset = Math.floor(milestone.days * scaleFactor);
        }
        
        // Calculate milestone date
        const milestoneDate = new Date(startDate);
        milestoneDate.setDate(milestoneDate.getDate() + adjustedDayOffset);
        
        // Make sure the date doesn't exceed the end date
        const finalDate = milestoneDate > endDate ? endDate : milestoneDate;
        
        // Format date for the input
        const formattedDate = finalDate.toISOString().split('T')[0]; // YYYY-MM-DD format
        
        // Create new milestone entry - for the table layout
        const newRow = document.createElement('tr');
        newRow.className = 'milestone-entry';
        newRow.innerHTML = `
            <td style="width: 12%">
                <input type="text" class="form-control form-control-sm milestone-period" placeholder="1-2" required value="${milestone.period}">
            </td>
            <td style="width: 18%">
                <div class="input-group">
                    <input type="date" class="form-control form-control-sm milestone-date" onchange="validateMilestoneDate(this)" value="${formattedDate}">
                    <span class="input-group-text date-toggle" onclick="toggleDateDisplay(this)">
                        <i class="fas fa-calendar-alt"></i>
                    </span>
                </div>
            </td>
            <td style="width: 60%">
                <input type="text" class="form-control form-control-sm milestone-description" placeholder="Milestone description" required value="${milestone.description}">
            </td>
            <td style="width: 10%; text-align: center;">
                <button type="button" class="btn btn-outline-danger btn-sm remove-milestone-btn">
                    <i class="fas fa-times"></i>
                </button>
            </td>
        `;
        milestonesContainer.appendChild(newRow);
        
        // Add event listener to the remove button
        const removeBtn = newRow.querySelector('.remove-milestone-btn');
        removeBtn.addEventListener('click', function() {
            if (milestonesContainer.querySelectorAll('.milestone-entry').length > 1) {
                milestonesContainer.removeChild(newRow);
            } else {
                // Clear inputs if it's the last one
                const periodInput = newRow.querySelector('.milestone-period');
                const descriptionInput = newRow.querySelector('.milestone-description');
                const dateInput = newRow.querySelector('.milestone-date');
                
                if (periodInput) periodInput.value = '';
                if (descriptionInput) descriptionInput.value = '';
                if (dateInput) {
                    dateInput.value = '';
                    dateInput.classList.remove('is-invalid');
                }
            }
            validateAllMilestoneDates();
        });
    });
    
    // Validate all milestone dates
    validateAllMilestoneDates();
    
    showToast('success', `Applied ${template.length} milestones from template`);
}

// Ensure mentoringDaysInfo is visible by default
document.addEventListener('DOMContentLoaded', function() {
    // Update modal visibility handling
    const timelineModal = document.getElementById('timelineModal');
    if (timelineModal) {
        timelineModal.addEventListener('shown.bs.modal', function() {
            // Make info visible by default
            const mentoringDaysInfo = document.getElementById('mentoringDaysInfo');
            if (mentoringDaysInfo) {
                mentoringDaysInfo.classList.remove('d-none');
                // Set initial text if no date is selected
                if (!document.getElementById('expectedEndDate').value) {
                    document.getElementById('totalDaysText').textContent = 'Select an end date to see mentoring duration';
                }
            }
            
            // Calculate and show mentoring days if end date is already set
            calculateMentoringDays();
            
            // Validate all milestone dates
            setTimeout(validateAllMilestoneDates, 100);
        });
    }
});
</script>

<!-- Meeting Modal -->
<div class="modal fade" id="meetingModal" tabindex="-1" aria-labelledby="meetingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="meetingModalLabel">Schedule Meeting</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="meetingForm">
                    <input type="hidden" id="mentorshipIdForMeeting">
                    
                    <div class="mb-3">
                        <label for="meetingTitle" class="form-label">Meeting Title</label>
                        <input type="text" class="form-control" id="meetingTitle" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="meetingDate" class="form-label">Date & Time</label>
                        <input type="datetime-local" class="form-control" id="meetingDate" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="meetingLink" class="form-label"><i class="fas fa-video me-1"></i> Meeting Link</label>
                        <input type="url" class="form-control" id="meetingLink" placeholder="https://meet.google.com/... or https://zoom.us/..." required>
                        <div class="form-text">
                            Add a video call link (Zoom, Google Meet, etc.) that mentees can click to join the meeting directly.
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="meetingDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="meetingDescription" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitMeeting()">Schedule</button>
            </div>
        </div>
    </div>
</div>

<!-- Message Modal -->
<div class="modal fade" id="messageModal" tabindex="-1" aria-labelledby="messageModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="messageModalLabel">Send Message</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="messageForm">
                    <input type="hidden" id="mentorshipIdForMessage">
                    
                    <div class="mb-3">
                        <label for="messageContent" class="form-label">Message</label>
                        <textarea class="form-control" id="messageContent" rows="5" required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="messageAttachment" class="form-label">Attachment (optional)</label>
                        <input type="file" class="form-control" id="messageAttachment">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitMessage()">Send</button>
            </div>
        </div>
    </div>
</div>

<!-- Progress Modal -->
<div class="modal fade" id="progressModal" tabindex="-1" aria-labelledby="progressModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="progressModalLabel">Update Progress</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="progressForm">
                    <input type="hidden" id="mentorshipIdForProgress">
                    
                    <div class="mb-3">
                        <label for="progressTitle" class="form-label">Progress Title</label>
                        <input type="text" class="form-control" id="progressTitle" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="progressDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="progressDescription" rows="3" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitProgress()">Save Progress</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Styles -->
<style>
.toast-container {
    z-index: 9999; /* Increased from 1050 to ensure it's always on top */
}

.toast {
    min-width: 250px;
}

.toast-success {
    background-color: #d4edda;
    border-color: #c3e6cb;
    color: #155724;
}

.toast-error {
    background-color: #f8d7da;
    border-color: #f5c6cb;
    color: #721c24;
}

.toast-success .toast-header {
    background-color: #c3e6cb;
    color: #155724;
}

.toast-error .toast-header {
    background-color: #f5c6cb;
    color: #721c24;
}

/* Loading indicator styles */
.loading-spinner-container {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 38px; /* Standard height of a form-select element */
    background-color: rgba(255, 255, 255, 0.8);
    border-radius: 0.25rem;
}

/* Success and error highlight styles for form elements */
.border-success {
    border-color: #28a745 !important;
    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25) !important;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.border-danger {
    border-color: #dc3545 !important;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}
</style>

<!-- Timeline Status Modal -->
<div class="modal fade timeline-status-modal" id="timelineStatusModal" tabindex="-1" aria-labelledby="timelineStatusModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="timelineStatusModalLabel">Update Timeline Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="timelineStatusForm">
                    <input type="hidden" id="mentorshipIdForStatus">
                    
                    <div id="milestone-status-container">
                        <!-- Milestone status items will be loaded here -->
                        <div class="text-center py-3 text-muted" id="no-milestones-message">
                            <i class="fas fa-info-circle me-2"></i>No milestones found. Please set up a timeline first.
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveTimelineStatus()">Save Status</button>
            </div>
        </div>
    </div>
</div>

<!-- Progress Details Modal -->
<div class="modal fade" id="progressDetailsModal" tabindex="-1" aria-labelledby="progressDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="progressDetailsModalLabel">Mentorship Progress Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="progress-details-container">
                            <div class="progress-overview mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0">Overall Progress</h6>
                                    <span class="progress-percentage-display fs-4 fw-bold text-primary">0%</span>
                                </div>
                                <div class="progress progress-lg" style="height: 25px;">
                                    <div class="progress-bar progress-bar-animated progress-bar-striped bg-primary" 
                                         role="progressbar" style="width: 0%;" 
                                         aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                </div>
                            </div>
                            
                            <div class="progress-stats row text-center mb-4">
                                <div class="col-md-3">
                                    <div class="progress-stat-card bg-light p-3 rounded">
                                        <div class="stat-icon mb-2"><i class="fas fa-calendar-check text-success"></i></div>
                                        <div class="stat-value" id="completed-milestones">0</div>
                                        <div class="stat-label">Completed</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="progress-stat-card bg-light p-3 rounded">
                                        <div class="stat-icon mb-2"><i class="fas fa-spinner text-warning"></i></div>
                                        <div class="stat-value" id="in-progress-milestones">0</div>
                                        <div class="stat-label">In Progress</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="progress-stat-card bg-light p-3 rounded">
                                        <div class="stat-icon mb-2"><i class="fas fa-hourglass-start text-secondary"></i></div>
                                        <div class="stat-value" id="not-started-milestones">0</div>
                                        <div class="stat-label">Not Started</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="progress-stat-card bg-light p-3 rounded">
                                        <div class="stat-icon mb-2"><i class="fas fa-tasks text-primary"></i></div>
                                        <div class="stat-value" id="total-milestones">0</div>
                                        <div class="stat-label">Total Milestones</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="timeline-visualization mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>Timeline Visualization</h6>
                                    <span class="badge bg-primary" id="timeline-progress-badge">0%</span>
                                </div>
                                <p class="text-muted small mb-3">Track your mentorship progress through milestones. Click on any milestone for details.</p>
                                <div class="timeline-visual-container" id="timeline-visual-container">
                                    <!-- Timeline visualization will be rendered here -->
                                </div>
                            </div>
                            
                            <div class="milestone-list">
                                <h6>Milestones</h6>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Period</th>
                                                <th>Description</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="milestone-table-body">
                                            <!-- Milestone rows will be added here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Update Overall Progress section and Quick Note feature removed as requested -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                <!-- Update Progress and Update Milestones buttons removed as requested -->
            </div>
        </div>
    </div>
</div>

<!-- Progress Bar Tooltip/Popover Styles -->
<style>
/* Progress Bar Styles */
.progress {
    cursor: pointer;
    transition: all 0.3s ease;
    overflow: visible;
}

.progress:hover {
    box-shadow: 0 0 10px rgba(0,123,255,0.5);
}

.progress-bar {
    position: relative;
}

/* Progress Tooltip */
.progress-tooltip {
    position: absolute;
    top: -40px;
    right: 0;
    background-color: #343a40;
    color: white;
    padding: 5px 10px;
    border-radius: 4px;
    font-size: 0.8rem;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s;
    z-index: 1000;
    white-space: nowrap;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

.progress-tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    margin-left: -5px;
    border-width: 5px;
    border-style: solid;
    border-color: #343a40 transparent transparent transparent;
}

.progress:hover .progress-tooltip {
    opacity: 1;
    visibility: visible;
}

/* Progress Details Modal Styles */
.progress-lg {
    height: 25px !important;
    border-radius: 15px;
    overflow: hidden;
}

.progress-lg .progress-bar {
    line-height: 25px;
    font-weight: bold;
}

.progress-stat-card {
    transition: all 0.3s ease;
    border: 1px solid #dee2e6;
}

.progress-stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.stat-value {
    font-size: 1.8rem;
    font-weight: bold;
}

.timeline-visual-container {
    height: 150px;
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 15px 30px; /* Increased horizontal padding */
    position: relative;
    overflow: visible;
    margin: 15px 0 45px; /* Increased bottom margin to accommodate labels */
    border: 1px solid rgba(0,0,0,0.05);
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}

.milestone-marker {
    position: absolute;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    top: 50%;
    transform: translateY(-50%);
    cursor: pointer;
    transition: all 0.3s ease;
    z-index: 2;
}

.milestone-marker.not-started {
    background-color: #6c757d;
    border: 2px solid #fff;
}

.milestone-marker.in-progress {
    background-color: #ffc107;
    border: 2px solid #fff;
}

.milestone-marker.completed {
    background-color: #28a745;
    border: 2px solid #fff;
}

.milestone-marker:hover {
    transform: translateY(-50%) scale(1.2);
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
}

.milestone-line {
    position: absolute;
    height: 4px;
    background-color: #dee2e6;
    top: 50%;
    transform: translateY(-50%);
    z-index: 1;
    left: 0;
    right: 0;
}

.milestone-progress-fill {
    position: absolute;
    height: 4px;
    background: linear-gradient(90deg, #4481eb 0%, #04befe 100%);
    top: 50%;
    transform: translateY(-50%);
    z-index: 1;
    left: 0;
    width: 0%;
    transition: width 1s ease;
}

.milestone-tooltip {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background-color: #343a40;
    color: white;
    padding: 5px 10px;
    border-radius: 4px;
    font-size: 0.8rem;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s;
    z-index: 1000;
    white-space: nowrap;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    pointer-events: none;
}

.milestone-tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    margin-left: -5px;
    border-width: 5px;
    border-style: solid;
    border-color: #343a40 transparent transparent transparent;
}

.milestone-marker:hover .milestone-tooltip {
    opacity: 1;
    visibility: visible;
}

.timeline-status-badge {
    display: inline-block;
    padding: 0.25em 0.6em;
    font-size: 0.75em;
    font-weight: 700;
    line-height: 1;
    text-align: center;
    white-space: nowrap;
    vertical-align: baseline;
    border-radius: 0.25rem;
}

.timeline-status-badge.not-started {
    background-color: #6c757d;
    color: white;
}

.timeline-status-badge.in-progress {
    background-color: #ffc107;
    color: #212529;
}

.timeline-status-badge.completed {
    background-color: #28a745;
    color: white;
}
</style>

<!-- Schedule Meeting Modal -->
<div class="modal fade" id="scheduleMeetingModal" tabindex="-1" aria-labelledby="scheduleMeetingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="scheduleMeetingModalLabel">Schedule Meeting</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="scheduleMeetingForm" onsubmit="submitScheduleMeeting(event); return false;">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" id="mentorshipIdInput" name="mentorship_id">
                    <div class="mb-3">
                        <label for="meetingTitle" class="form-label">Meeting Title</label>
                        <input type="text" class="form-control" id="meetingTitle" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="meetingDate" class="form-label">Date & Time</label>
                        <input type="datetime-local" class="form-control" id="meetingDate" name="meeting_date" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="meetingLink" class="form-label">Meeting Link (optional)</label>
                        <input type="url" class="form-control" id="meetingLink" name="meeting_link" placeholder="https://meet.google.com/...">
                    </div>
                    <div class="mb-3">
                        <label for="meetingAgenda" class="form-label">Agenda</label>
                        <textarea class="form-control" id="meetingAgenda" name="agenda" rows="3" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Schedule Meeting</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Send Message Modal -->
<div class="modal fade" id="sendMessageModal" tabindex="-1" aria-labelledby="sendMessageModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="sendMessageModalLabel">Send Message</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="sendMessageForm" action="{% url 'mentorship:send_message' %}" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" id="messageRecipientId" name="recipient_id">
                    <div class="mb-3">
                        <label for="messageSubject" class="form-label">Subject</label>
                        <input type="text" class="form-control" id="messageSubject" name="subject" required>
                    </div>
                    <div class="mb-3">
                        <label for="messageContent" class="form-label">Message</label>
                        <textarea class="form-control" id="messageContent" name="content" rows="5" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-info text-white">Send Message</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div id="toast-container" class="toast-container position-fixed bottom-0 end-0 p-3"></div>

<!-- Template Handling Script -->
<script>
// Define predefined milestone templates
const milestoneTemplates = {
    'technical-8-week': [
        { period: '1', description: 'Introduction and skills assessment', days: 0 },
        { period: '2', description: 'Core concept review and learning path setup', days: 7 },
        { period: '3-4', description: 'Hands-on practice with fundamental skills', days: 14 },
        { period: '5', description: 'Mid-point assessment and progress review', days: 28 },
        { period: '6-7', description: 'Advanced topics and project implementation', days: 35 },
        { period: '8', description: 'Final review and future development planning', days: 49 }
    ],
    'career-12-week': [
        { period: '1', description: 'Career goals assessment and planning', days: 0 },
        { period: '2-3', description: 'Resume and portfolio enhancement', days: 7 },
        { period: '4-5', description: 'Personal branding and networking strategies', days: 21 },
        { period: '6', description: 'Mid-point review and strategy adjustment', days: 35 },
        { period: '7-8', description: 'Interview preparation and practice', days: 42 },
        { period: '9-10', description: 'Job search strategies and application process', days: 56 },
        { period: '11-12', description: 'Final assessment and long-term career planning', days: 70 }
    ],
    'research-project': [
        { period: '1', description: 'Research question definition and literature review', days: 0 },
        { period: '2', description: 'Methodology selection and planning', days: 7 },
        { period: '3-4', description: 'Data collection preparation', days: 14 },
        { period: '5-6', description: 'Data collection implementation', days: 28 },
        { period: '7-8', description: 'Data analysis', days: 42 },
        { period: '9', description: 'Results interpretation', days: 56 },
        { period: '10', description: 'Report/paper writing', days: 63 },
        { period: '11-12', description: 'Presentation preparation and delivery', days: 70 }
    ],
    'startup-mentoring': [
        { period: '1', description: 'Business idea validation and market research', days: 0 },
        { period: '2', description: 'Target audience and customer persona development', days: 7 },
        { period: '3', description: 'Business model canvas creation', days: 14 },
        { period: '4-5', description: 'MVP (Minimum Viable Product) planning', days: 21 },
        { period: '6-7', description: 'MVP development and testing', days: 35 },
        { period: '8', description: 'Initial marketing strategy', days: 49 },
        { period: '9-10', description: 'Funding options and pitch deck preparation', days: 56 },
        { period: '11-12', description: 'Launch strategy and growth planning', days: 70 }
    ],
    'leadership-development': [
        { period: '1', description: 'Leadership style assessment and strengths identification', days: 0 },
        { period: '2-3', description: 'Communication and interpersonal skills development', days: 7 },
        { period: '4', description: 'Team management and delegation strategies', days: 21 },
        { period: '5-6', description: 'Conflict resolution and problem solving', days: 28 },
        { period: '7', description: 'Emotional intelligence in leadership', days: 42 },
        { period: '8-9', description: 'Strategic thinking and decision making', days: 49 },
        { period: '10-11', description: 'Change management and organizational development', days: 63 },
        { period: '12', description: 'Personal leadership vision and ongoing growth plan', days: 77 }
    ]
};

// Function to get template duration in days
function getTemplateDuration(templateId) {
    const template = milestoneTemplates[templateId];
    if (!template || template.length === 0) return 0;
    
    // Find the milestone with the highest day value
    let maxDays = 0;
    template.forEach(milestone => {
        if (milestone.days > maxDays) {
            maxDays = milestone.days;
        }
    });
    
    // Add 7 days buffer to the end for final wrap-up
    return maxDays + 7;
}

// Function to set the expected end date based on template
function setExpectedEndDateFromTemplate(templateId) {
    const duration = getTemplateDuration(templateId);
    if (duration <= 0) return;
    
    const expectedEndDateInput = document.getElementById('expectedEndDate');
    if (!expectedEndDateInput) return;
    
    // Calculate end date as today + duration days
    const endDate = new Date();
    endDate.setDate(endDate.getDate() + duration);
    
    // Format the date for the input field (YYYY-MM-DD)
    const formattedDate = endDate.toISOString().split('T')[0];
    expectedEndDateInput.value = formattedDate;
    
    // Update the mentoring days display
    calculateMentoringDays();
}

// Function to apply a milestone template
function applyMilestoneTemplate(templateId) {
    const template = milestoneTemplates[templateId];
    if (!template) {
        showToast('error', 'Template not found');
        return;
    }
    
    // Get end date to calculate milestone dates
    const expectedEndDateInput = document.getElementById('expectedEndDate');
    if (!expectedEndDateInput || !expectedEndDateInput.value) {
        // If end date is not set, set it automatically based on template
        setExpectedEndDateFromTemplate(templateId);
        
        if (!expectedEndDateInput.value) {
            showToast('warning', 'Could not set expected end date');
            return;
        }
    }
    
    // Clear existing milestones
    const milestonesContainer = document.getElementById('milestones-container');
    milestonesContainer.innerHTML = '';
    
    // Calculate dates based on the timeline span
    // Start from TOMORROW instead of today
    const startDate = new Date();
    startDate.setDate(startDate.getDate() + 1); // Add 1 day to get tomorrow
    startDate.setHours(0, 0, 0, 0);
    
    const endDate = new Date(expectedEndDateInput.value);
    endDate.setHours(0, 0, 0, 0);
    
    // Calculate total duration in days
    const totalDuration = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24));
    
    // Get the template's original duration
    const templateDuration = getTemplateDuration(templateId) - 7; // Subtract the buffer we added
    
    // Apply template milestones
    template.forEach((milestone, index) => {
        // Calculate adjusted day offset based on the actual timeline duration
        let adjustedDayOffset;
        
        if (templateDuration <= 0) {
            // Fallback: Distribute evenly if template duration is invalid
            adjustedDayOffset = Math.floor((totalDuration * index) / (template.length - 1));
        } else {
            // Scale the day offset proportionally to fit the actual timeline
            const scaleFactor = totalDuration / templateDuration;
            adjustedDayOffset = Math.floor(milestone.days * scaleFactor);
        }
        
        // Calculate milestone date
        const milestoneDate = new Date(startDate);
        milestoneDate.setDate(milestoneDate.getDate() + adjustedDayOffset);
        
        // Make sure the date doesn't exceed the end date
        const finalDate = milestoneDate > endDate ? endDate : milestoneDate;
        
        // Format date for the input
        const formattedDate = finalDate.toISOString().split('T')[0]; // YYYY-MM-DD format
        
        // Create new milestone entry
        const newMilestone = document.createElement('div');
        newMilestone.className = 'milestone-entry mb-3';
        newMilestone.innerHTML = `
            <div class="row g-2">
                <div class="col">
                    <div class="input-group">
                        <span class="input-group-text">Week/Day</span>
                        <input type="text" class="form-control milestone-period" placeholder="1-2" required value="${milestone.period}">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="input-group">
                        <input type="date" class="form-control milestone-date" onchange="validateMilestoneDate(this)" value="${formattedDate}">
                        <span class="input-group-text date-toggle" onclick="toggleDateDisplay(this)">
                            <i class="fas fa-calendar-alt"></i>
                        </span>
                    </div>
                </div>
                <div class="col-md-6">
                    <input type="text" class="form-control milestone-description" placeholder="Introduction and goal setting" required value="${milestone.description}">
                </div>
                <div class="col-md-1 text-center">
                    <button type="button" class="btn btn-outline-danger remove-milestone-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        `;
        milestonesContainer.appendChild(newMilestone);
        
        // Add event listener to the remove button
        const removeBtn = newMilestone.querySelector('.remove-milestone-btn');
        removeBtn.addEventListener('click', function() {
            if (milestonesContainer.querySelectorAll('.milestone-entry').length > 1) {
                milestonesContainer.removeChild(newMilestone);
            } else {
                // Clear inputs if it's the last one
                const periodInput = newMilestone.querySelector('.milestone-period');
                const descriptionInput = newMilestone.querySelector('.milestone-description');
                const dateInput = newMilestone.querySelector('.milestone-date');
                
                if (periodInput) periodInput.value = '';
                if (descriptionInput) descriptionInput.value = '';
                if (dateInput) {
                    dateInput.value = '';
                    dateInput.classList.remove('is-invalid');
                }
            }
            validateAllMilestoneDates();
        });
    });
    
    // Validate all milestone dates
    validateAllMilestoneDates();
    
    showToast('success', `Applied ${template.length} milestones from template`);
}

// Add initialization for the template apply button
document.addEventListener('DOMContentLoaded', function() {
    // Initialize template selector to update expected end date on change
    const templateSelector = document.getElementById('templateSelector');
    if (templateSelector) {
        templateSelector.addEventListener('change', function() {
            if (this.value) {
                setExpectedEndDateFromTemplate(this.value);
            }
        });
    }
    
    // Initialize apply template button
    const applyTemplateBtn = document.getElementById('applyTemplateBtn');
    if (applyTemplateBtn) {
        applyTemplateBtn.addEventListener('click', function() {
            const templateSelector = document.getElementById('templateSelector');
            if (templateSelector && templateSelector.value) {
                applyMilestoneTemplate(templateSelector.value);
            } else {
                showToast('warning', 'Please select a template first');
            }
        });
    }
});
</script>

<!-- Find the script section for timeline handling and add these functions -->
<script>
// Function to add a new milestone
function addNewMilestone() {
    const milestonesContainer = document.getElementById('milestones-container');
    
    const milestoneRow = document.createElement('div');
    milestoneRow.className = 'milestone-row row mb-3 pb-3 border-bottom align-items-center';
    
    milestoneRow.innerHTML = `
        <div class="col-md-2">
            <label class="form-label d-md-none">Week/Day:</label>
            <input type="text" class="form-control milestone-period" placeholder="1-2" required>
        </div>
        <div class="col-md-3">
            <label class="form-label d-md-none">Date:</label>
            <div class="input-group">
                <input type="date" class="form-control milestone-date" onchange="validateMilestoneDate(this)">
                <span class="input-group-text date-toggle" onclick="toggleDateDisplay(this)">
                    <i class="fas fa-calendar-alt"></i>
                </span>
            </div>
        </div>
        <div class="col-md-6">
            <label class="form-label d-md-none">Description:</label>
            <input type="text" class="form-control milestone-description" placeholder="Milestone description" required>
        </div>
        <div class="col-md-1 text-center">
            <button type="button" class="btn btn-outline-danger remove-milestone-btn mt-md-0 mt-2">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    
    milestonesContainer.appendChild(milestoneRow);
    
    const removeBtn = milestoneRow.querySelector('.remove-milestone-btn');
    removeBtn.addEventListener('click', function() {
        removeMilestone(milestoneRow);
    });
}

// Function to remove a milestone
function removeMilestone(milestoneRow) {
    if (!milestoneRow) return;
    
    const milestonesContainer = document.getElementById('milestones-container');
    const allRows = milestonesContainer.querySelectorAll('.milestone-row');
    
    if (allRows.length <= 1) {
        // If it's the last row, just clear the inputs instead of removing
        const periodInput = milestoneRow.querySelector('.milestone-period');
        const descriptionInput = milestoneRow.querySelector('.milestone-description');
        const dateInput = milestoneRow.querySelector('.milestone-date');
        
        if (periodInput) periodInput.value = '';
        if (descriptionInput) descriptionInput.value = '';
        if (dateInput) {
            dateInput.value = '';
            dateInput.classList.remove('is-invalid');
        }
    } else {
        // Otherwise remove the row
        milestonesContainer.removeChild(milestoneRow);
    }
    
    // Re-validate after changes
    validateAllMilestoneDates();
}

// Initialize milestone buttons
document.addEventListener('DOMContentLoaded', function() {
    const timelineModal = document.getElementById('timelineModal');
    if (timelineModal) {
        timelineModal.addEventListener('shown.bs.modal', function() {
            // Initialize the add milestone button
            const addMilestoneBtn = document.getElementById('add-milestone-btn');
            if (addMilestoneBtn) {
                // Remove any existing event listeners
                const newBtn = addMilestoneBtn.cloneNode(true);
                addMilestoneBtn.parentNode.replaceChild(newBtn, addMilestoneBtn);
                
                // Add new event listener
                newBtn.addEventListener('click', addNewMilestone);
            }
            
            // Initialize existing remove buttons
            document.querySelectorAll('.remove-milestone-btn').forEach(button => {
                const newBtn = button.cloneNode(true);
                button.parentNode.replaceChild(newBtn, button);
                newBtn.addEventListener('click', function() {
                    removeMilestone(this.closest('.milestone-row'));
                });
            });
        });
    }
});

// Update the applyMilestoneTemplate function to use the new structure
const originalApplyMilestoneTemplate = applyMilestoneTemplate;
applyMilestoneTemplate = function(templateId) {
    const template = milestoneTemplates[templateId];
    if (!template) {
        showToast('error', 'Template not found');
        return;
    }
    
    // Get end date to calculate milestone dates
    const expectedEndDateInput = document.getElementById('expectedEndDate');
    if (!expectedEndDateInput || !expectedEndDateInput.value) {
        // If end date is not set, set it automatically based on template
        setExpectedEndDateFromTemplate(templateId);
        
        if (!expectedEndDateInput.value) {
            showToast('warning', 'Could not set expected end date');
            return;
        }
    }
    
    // Clear existing milestones
    const milestonesContainer = document.getElementById('milestones-container');
    milestonesContainer.innerHTML = '';
    
    // Calculate dates based on the timeline span
    // Start from TOMORROW instead of today
    const startDate = new Date();
    startDate.setDate(startDate.getDate() + 1); // Add 1 day to get tomorrow
    startDate.setHours(0, 0, 0, 0);
    
    const endDate = new Date(expectedEndDateInput.value);
    endDate.setHours(0, 0, 0, 0);
    
    // Calculate total duration in days
    const totalDuration = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24));
    
    // Get the template's original duration
    const templateDuration = getTemplateDuration(templateId) - 7; // Subtract the buffer we added
    
    // Apply template milestones
    template.forEach((milestone, index) => {
        // Calculate adjusted day offset based on the actual timeline duration
        let adjustedDayOffset;
        
        if (templateDuration <= 0) {
            // Fallback: Distribute evenly if template duration is invalid
            adjustedDayOffset = Math.floor((totalDuration * index) / (template.length - 1));
        } else {
            // Scale the day offset proportionally to fit the actual timeline
            const scaleFactor = totalDuration / templateDuration;
            adjustedDayOffset = Math.floor(milestone.days * scaleFactor);
        }
        
        // Calculate milestone date
        const milestoneDate = new Date(startDate);
        milestoneDate.setDate(milestoneDate.getDate() + adjustedDayOffset);
        
        // Make sure the date doesn't exceed the end date
        const finalDate = milestoneDate > endDate ? endDate : milestoneDate;
        
        // Format date for the input
        const formattedDate = finalDate.toISOString().split('T')[0]; // YYYY-MM-DD format
        
        // Create new milestone row
        const milestoneRow = document.createElement('div');
        milestoneRow.className = 'milestone-row row mb-3 pb-3 border-bottom align-items-center';
        
        milestoneRow.innerHTML = `
            <div class="col-md-2">
                <label class="form-label d-md-none">Week/Day:</label>
                <input type="text" class="form-control milestone-period" placeholder="1-2" value="${milestone.period}" required>
            </div>
            <div class="col-md-3">
                <label class="form-label d-md-none">Date:</label>
                <div class="input-group">
                    <input type="date" class="form-control milestone-date" value="${formattedDate}" onchange="validateMilestoneDate(this)">
                    <span class="input-group-text date-toggle" onclick="toggleDateDisplay(this)">
                        <i class="fas fa-calendar-alt"></i>
                    </span>
                </div>
            </div>
            <div class="col-md-6">
                <label class="form-label d-md-none">Description:</label>
                <input type="text" class="form-control milestone-description" placeholder="Milestone description" value="${milestone.description}" required>
            </div>
            <div class="col-md-1 text-center">
                <button type="button" class="btn btn-outline-danger remove-milestone-btn mt-md-0 mt-2">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        milestonesContainer.appendChild(milestoneRow);
        
        // Add event listener to the remove button
        const removeBtn = milestoneRow.querySelector('.remove-milestone-btn');
        removeBtn.addEventListener('click', function() {
            removeMilestone(milestoneRow);
        });
    });
    
    // Validate all milestone dates
    validateAllMilestoneDates();
    
    showToast('success', `Applied ${template.length} milestones from template`);
};

// Function to submit the timeline - update to use the new structure
const originalSubmitTimeline = submitTimeline;
submitTimeline = function() {
    // Check if the original function exists and call it if it does
    if (typeof originalSubmitTimeline === 'function') {
        // Check if we need to modify the data collection logic
        try {
            // Get all milestone entries
            const milestonesContainer = document.getElementById('milestones-container');
            const milestoneRows = milestonesContainer.querySelectorAll('.milestone-row');
            
            if (milestoneRows.length > 0) {
                // We have the new structure, so we'll override the data collection
                const expectedEndDateInput = document.getElementById('expectedEndDate');
                const mentorshipIdInput = document.getElementById('mentorshipIdForTimeline');
                const notesTextarea = document.getElementById('timelineMilestones');
                
                // Verify required fields
                if (!expectedEndDateInput || !expectedEndDateInput.value) {
                    showToast('error', 'Please set an expected end date');
                    return;
                }
                
                // Collect milestone data
                const milestones = [];
                let hasEmptyFields = false;
                
                milestoneRows.forEach(row => {
                    const periodInput = row.querySelector('.milestone-period');
                    const dateInput = row.querySelector('.milestone-date');
                    const descriptionInput = row.querySelector('.milestone-description');
                    
                    // Check if required fields are filled
                    if (!periodInput.value.trim() || !descriptionInput.value.trim()) {
                        hasEmptyFields = true;
                        return;
                    }
                    
                    milestones.push({
                        period: periodInput.value.trim(),
                        date: dateInput.value || '',
                        description: descriptionInput.value.trim()
                    });
                });
                
                if (hasEmptyFields) {
                    showToast('error', 'Please fill in all required milestone fields');
                    return;
                }
                
                if (milestones.length === 0) {
                    showToast('error', 'Please add at least one milestone');
                    return;
                }
                
                // Validate milestone dates
                if (!validateAllMilestoneDates()) {
                    return;
                }
                
                // Show loading state
                const saveButton = document.getElementById('saveTimeline');
                if (saveButton) {
                    saveButton.disabled = true;
                    saveButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Saving...';
                }
                
                // Send the data to the server
                fetch('/mentorship/set-timeline/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        mentorship_id: mentorshipIdInput ? mentorshipIdInput.value : '',
                        expected_end_date: expectedEndDateInput.value,
                        milestones: milestones,
                        notes: notesTextarea ? notesTextarea.value : ''
                    })
                })
                .then(response => {
                    // First check if the response is ok
                    if (!response.ok) {
                        // Try to get status code info to provide better error messages
                        const errorMsg = `Server error: ${response.status} ${response.statusText}`;
                        console.error(errorMsg);
                        throw new Error(errorMsg);
                    }
                    
                    // Check content type to avoid JSON parse errors
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        console.error('Response is not JSON. Content-Type:', contentType);
                        throw new Error('Server returned an invalid response format');
                    }
                    
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        showToast('success', 'Timeline saved successfully');
                        // Close the modal
                        const closeBtn = document.querySelector('#timelineModal .btn-close');
                        if (closeBtn) closeBtn.click();
                        // Refresh the page
                        setTimeout(() => window.location.reload(), 1000);
                    } else {
                        showToast('error', data.error || 'Failed to save timeline');
                        if (saveButton) {
                            saveButton.disabled = false;
                            saveButton.innerHTML = '<i class="fas fa-save me-2"></i>Save Timeline';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('error', `An error occurred while saving: ${error.message || 'Unknown error'}`);
                    if (saveButton) {
                        saveButton.disabled = false;
                        saveButton.innerHTML = '<i class="fas fa-save me-2"></i>Save Timeline';
                    }
                });
                
                // We've handled submission with the new structure
                return;
            }
        } catch (e) {
            console.error('Error detecting milestone structure:', e);
        }
        
        // Fall back to the original function if we couldn't handle it with the new structure
        return originalSubmitTimeline();
    }
    
    // If original function doesn't exist, show an error
    showToast('error', 'Timeline submission function not found');
};

function updateMeetingLink() {
    const meetingId = document.getElementById('editMeetingId').value;
    const meetingLink = document.getElementById('editMeetingLink').value;
    
    // Validate meeting link
    if (!meetingLink) {
        showToast('error', 'Please enter a meeting link');
        return;
    }
    
    // Validate that the meeting link is valid
    if (!meetingLink.startsWith('http://') && !meetingLink.startsWith('https://')) {
        showToast('error', 'Please enter a valid meeting link starting with http:// or https://');
        return;
    }
    
    fetch(`/mentorship/api/meetings/${meetingId}/`, {
        method: 'PATCH',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            meeting_link: meetingLink
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to update meeting link');
        }
        return response.json();
    })
    .then(data => {
        var editMeetingModal = document.getElementById('editMeetingModal');
        var modal = bootstrap.Modal.getInstance(editMeetingModal);
        if (modal) modal.hide();
        
        showToast('success', 'Meeting link updated successfully');
        setTimeout(() => location.reload(), 1500);
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Failed to update meeting link. Please try again.');
    });
}
</script>

</div> <!-- Close container -->
{% endblock %}