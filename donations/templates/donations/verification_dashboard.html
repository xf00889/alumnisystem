{% extends 'donations/base_donations.html' %}
{% load static %}
{% load humanize %}
{% load i18n %}

{% block title %}{% trans "Enhanced Verification Dashboard" %} - NORSU Alumni{% endblock %}

{% block page_header %}{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="{% url 'donations:campaign_list' %}">{% trans "Campaigns" %}</a></li>
<li class="breadcrumb-item active">{% trans "Verification" %}</li>
{% endblock %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
    /* System Color Scheme */
    :root {
        /* Primary Colors */
        --primary-color: #2b3c6b;
        
        /* Secondary Colors */
        --secondary-color: #4a5568;
        
        /* UI Colors */
        --ui-background: #f7fafc;
        --ui-surface: #ffffff;
        --ui-border: #e2e8f0;
        --ui-hover: #edf2f7;
        
        /* Text Colors */
        --text-primary: #2d3748;
        --text-secondary: #718096;
        --text-muted: #a0aec0;
        --text-light: #ffffff;
        
        /* Feedback Colors */
        --feedback-success: #48bb78;
        --feedback-warning: #ed8936;
        --feedback-error: #e53e3e;
        --feedback-info: #4299e1;
        
        /* Shadows */
        --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
        --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
        
        /* Border Radius */
        --radius-sm: 0.25rem;
        --radius-md: 0.375rem;
        --radius-lg: 0.5rem;
    }
    
    body {
        background-color: var(--ui-background);
        font-size: 0.875rem;
        font-family: 'Poppins', sans-serif;
    }
    
    .container-fluid {
        padding: 1.5rem;
        max-width: 1200px;
        margin: 0 auto;
    }

    /* Header Section */
    .directory-header {
        background: var(--primary-color);
        color: var(--text-light);
        padding: 2rem;
        border-radius: var(--radius-md);
        margin-bottom: 1.5rem;
        box-shadow: var(--shadow-sm);
        text-align: center;
        font-family: 'Poppins', sans-serif;
    }
    
    .directory-title {
        font-size: 2rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        font-family: 'Poppins', sans-serif;
    }
    
    .directory-subtitle {
        opacity: 0.9;
        font-size: 1rem;
        margin: 0;
        font-family: 'Poppins', sans-serif;
    }

    /* Search Section */
    .search-section {
        background: var(--ui-surface);
        padding: 2rem;
        border-radius: var(--radius-md);
        margin-bottom: 1.5rem;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--ui-border);
        font-family: 'Poppins', sans-serif;
    }
    
    .search-form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        align-items: end;
    }
    
    .search-group {
        display: flex;
        flex-direction: column;
    }
    
    .search-label {
        font-weight: 500;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
        font-family: 'Poppins', sans-serif;
    }
    
    .search-input,
    .search-select {
        border: 1px solid var(--ui-border);
        border-radius: var(--radius-sm);
        padding: 0.75rem;
        font-size: 0.875rem;
        font-family: 'Poppins', sans-serif;
        background: var(--ui-surface);
        color: var(--text-primary);
        transition: all 0.3s ease;
    }
    
    .search-input:focus,
    .search-select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(43, 60, 107, 0.1);
    }
    
    .search-button,
    .clear-button {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: var(--radius-sm);
        font-size: 0.875rem;
        font-weight: 500;
        font-family: 'Poppins', sans-serif;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }
    
    .search-button {
        background: var(--primary-color);
        color: var(--text-light);
    }
    
    .search-button:hover {
        background: var(--secondary-color);
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }
    
    .clear-button {
        background: var(--feedback-error);
        color: var(--text-light);
    }
    
    .clear-button:hover {
        background: #c53030;
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
        color: var(--text-light);
        text-decoration: none;
    }


    /* Table styling */
    .verification-table {
        font-size: 0.875rem;
        font-family: 'Poppins', sans-serif;
        background: var(--ui-surface);
        border-radius: var(--radius-md);
        overflow: hidden;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--ui-border);
    }
    
    .verification-table thead th {
        background-color: var(--primary-color);
        color: var(--text-light);
        font-weight: 600;
        border-bottom: none;
        padding: 1rem 0.75rem;
        font-family: 'Poppins', sans-serif;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
    }
    
    .verification-table tbody tr {
        border-bottom: 1px solid var(--ui-border);
        transition: all 0.3s ease;
    }
    
    .verification-table tbody tr:hover {
        background-color: var(--ui-hover);
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .verification-table tbody tr:last-child {
        border-bottom: none;
    }
    
    .verification-table td {
        padding: 1rem 0.75rem;
        vertical-align: middle;
        font-family: 'Poppins', sans-serif;
        border: none;
    }
    
    .donor-info {
        line-height: 1.2;
    }
    
    .donor-name {
        font-weight: 700;
        font-size: 1.05rem;
        color: var(--text-primary);
    }
    
    .donor-email {
        font-size: 0.75rem;
        color: var(--text-secondary);
    }
    
    .campaign-link {
        color: var(--primary-color);
        text-decoration: none;
        font-weight: 600;
    }
    
    .campaign-link:hover {
        text-decoration: underline;
    }

    /* Action buttons */
    .btn-approve,
    .btn-reject,
    .btn-disputed,
    .btn-view-proof {
        padding: 0.5rem 0.75rem;
        border: none;
        border-radius: var(--radius-sm);
        font-size: 0.75rem;
        font-weight: 600;
        font-family: 'Poppins', sans-serif;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        margin: 0 0.125rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        min-width: 32px;
        justify-content: center;
    }
    
    .btn-approve {
        background: #10b981;
        color: var(--text-light);
    }
    
    .btn-approve:hover {
        background: #059669;
        color: var(--text-light);
        text-decoration: none;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
    }
    
    .btn-reject {
        background: #ef4444;
        color: var(--text-light);
    }
    
    .btn-reject:hover {
        background: #dc2626;
        color: var(--text-light);
        text-decoration: none;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
    }
    
    .btn-disputed {
        background: #8b5cf6;
        color: var(--text-light);
    }
    
    .btn-disputed:hover {
        background: #7c3aed;
        color: var(--text-light);
        text-decoration: none;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(139, 92, 246, 0.3);
    }
    
    .btn-view-proof {
        background: #3b82f6;
        color: var(--text-light);
    }
    
    .btn-view-proof:hover {
        background: #2563eb;
        color: var(--text-light);
        text-decoration: none;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
    }

    /* Status badges */
    .status-badge {
        padding: 0.375rem 0.75rem;
        border-radius: var(--radius-sm);
        font-size: 0.75rem;
        font-weight: 600;
        font-family: 'Poppins', sans-serif;
        text-transform: uppercase;
        letter-spacing: 0.025em;
        display: inline-block;
        min-width: 80px;
        text-align: center;
    }
    
    .status-completed {
        background: #10b981;
        color: var(--text-light);
        box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
    }
    
    .status-failed {
        background: #ef4444;
        color: var(--text-light);
        box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
    }
    
    .status-pending {
        background: #f59e0b;
        color: var(--text-light);
        box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
    }
    
    .status-disputed {
        background: #8b5cf6;
        color: var(--text-light);
        box-shadow: 0 2px 4px rgba(139, 92, 246, 0.3);
    }

    /* Pagination */
    .pagination-section {
        background: var(--ui-surface);
        padding: 1.5rem;
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--ui-border);
        margin-bottom: 1.5rem;
        font-family: 'Poppins', sans-serif;
    }
    
    .pagination {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin: 0;
        padding: 0;
        list-style: none;
    }
    
    .page-item {
        margin: 0;
    }
    
    .page-link {
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--ui-border);
        border-radius: var(--radius-sm);
        color: var(--text-primary);
        text-decoration: none;
        font-size: 0.875rem;
        font-family: 'Poppins', sans-serif;
        transition: all 0.3s ease;
        background: var(--ui-surface);
    }
    
    .page-link:hover {
        background: var(--ui-hover);
        border-color: var(--primary-color);
        color: var(--primary-color);
        text-decoration: none;
    }
    
    .page-item.active .page-link {
        background: var(--primary-color);
        border-color: var(--primary-color);
        color: var(--text-light);
    }

    /* Empty State */
    .empty-state {
        background: var(--ui-surface);
        padding: 4rem 2rem;
        border-radius: var(--radius-md);
        text-align: center;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--ui-border);
        font-family: 'Poppins', sans-serif;
    }
    
    .empty-state i {
        font-size: 4rem;
        color: var(--text-muted);
        margin-bottom: 1rem;
    }
    
    .empty-state h3 {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
        font-family: 'Poppins', sans-serif;
    }
    
    .empty-state p {
        color: var(--text-secondary);
        font-size: 1rem;
        margin: 0;
        font-family: 'Poppins', sans-serif;
    }

    /* Tab styling */
    .nav-tabs {
        border-bottom: 2px solid var(--ui-border);
        margin-bottom: 0;
    }
    
    .nav-tabs .nav-link {
        border: none;
        border-radius: var(--radius-sm) var(--radius-sm) 0 0;
        color: var(--text-secondary);
        font-weight: 500;
        padding: 0.75rem 1.25rem;
        transition: all 0.3s ease;
        background: transparent;
        margin-right: 0.25rem;
    }
    
    .nav-tabs .nav-link:hover {
        border-color: transparent;
        background: var(--ui-hover);
        color: var(--text-primary);
    }
    
    .nav-tabs .nav-link.active {
        background: var(--ui-surface);
        color: var(--primary-color);
        border-color: var(--ui-border) var(--ui-border) var(--ui-surface);
        font-weight: 600;
        box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .nav-tabs .nav-link .badge {
        font-size: 0.65rem;
        padding: 0.25rem 0.5rem;
        border-radius: 10px;
    }

    /* Bulk actions styling */
    .btn-group .btn {
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.025em;
        font-size: 0.75rem;
    }
    
    .btn-group .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .container-fluid {
            padding: 1rem;
        }
        
        .search-form {
            grid-template-columns: 1fr;
        }
        
        
        .directory-header {
            padding: 1.5rem;
        }
        
        .directory-title {
            font-size: 1.5rem;
        }
        
        .verification-table {
            font-size: 0.8rem;
        }
        
        .btn-approve,
        .btn-reject,
        .btn-disputed,
        .btn-view-proof {
            padding: 0.375rem 0.5rem;
            font-size: 0.7rem;
        }
    }
</style>
{% endblock %}

{% block donations_content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="directory-header">
        <h1 class="directory-title">{% trans "Donation Verifications" %}</h1>
        <p class="directory-subtitle">{% trans "Manage donation verification, approvals, and auditing" %}</p>
    </div>

    <!-- Search Section -->
    <div class="search-section">
        <form method="get" class="search-form">
            <div class="search-group">
                <label class="search-label" for="search">{% trans "Search" %}</label>
                <input type="search" 
                       id="search"
                       name="search"
                       class="search-input" 
                       placeholder="{% trans 'Name, email, reference, transaction ID...' %}"
                       value="{{ search }}">
            </div>
            <div class="search-group">
                <label class="search-label" for="campaign">{% trans "Campaign" %}</label>
                <select id="campaign" name="campaign" class="search-select">
                    <option value="">{% trans "All Campaigns" %}</option>
                    {% for campaign in campaigns %}
                    <option value="{{ campaign.id }}" {% if campaign_filter == campaign.id|stringformat:"s" %}selected{% endif %}>{{ campaign.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="search-group">
                <label class="search-label" for="date_from">{% trans "From Date" %}</label>
                <input type="date" class="search-input" id="date_from" name="date_from" value="{{ date_from }}">
            </div>
            <div class="search-group">
                <label class="search-label" for="date_to">{% trans "To Date" %}</label>
                <input type="date" class="search-input" id="date_to" name="date_to" value="{{ date_to }}">
            </div>
            <div>
                <button type="submit" class="search-button">
                    <i class="fas fa-search"></i> {% trans "Search" %}
                    </button>
                </div>
            {% if search or campaign_filter or date_from or date_to %}
            <div>
                <a href="{% url 'donations:verification_dashboard' %}" class="clear-button">
                    <i class="fas fa-times"></i> {% trans "Clear" %}
                </a>
            </div>
            {% endif %}
        </form>
</div>



<!-- Tabbed Interface -->
    <div class="search-section">
        <div class="mb-3">
            <ul class="nav nav-tabs" id="verification-tabs" role="tablist">
            <li class="nav-item" role="presentation">
                <a class="nav-link {% if current_tab == 'pending' %}active{% endif %}"
                   href="?tab=pending{% if search %}&search={{ search }}{% endif %}{% if campaign_filter %}&campaign={{ campaign_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">
                    <i class="fas fa-clock me-2"></i>
                    {% trans "Pending" %}
                    <span class="badge bg-warning ms-1">{{ stats.pending_count }}</span>
                </a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link {% if current_tab == 'completed' %}active{% endif %}"
                   href="?tab=completed{% if search %}&search={{ search }}{% endif %}{% if campaign_filter %}&campaign={{ campaign_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">
                    <i class="fas fa-check-circle me-2"></i>
                    {% trans "Completed" %}
                    <span class="badge bg-success ms-1">{{ stats.completed_count }}</span>
                </a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link {% if current_tab == 'failed' %}active{% endif %}"
                   href="?tab=failed{% if search %}&search={{ search }}{% endif %}{% if campaign_filter %}&campaign={{ campaign_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">
                    <i class="fas fa-times-circle me-2"></i>
                    {% trans "Failed" %}
                    <span class="badge bg-danger ms-1">{{ stats.failed_count }}</span>
                </a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link {% if current_tab == 'disputed' %}active{% endif %}"
                   href="?tab=disputed{% if search %}&search={{ search }}{% endif %}{% if campaign_filter %}&campaign={{ campaign_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">
                    <i class="fas fa-question-circle me-2"></i>
                    {% trans "Disputed" %}
                    <span class="badge bg-warning ms-1">{{ stats.disputed_count }}</span>
                </a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link {% if current_tab == 'all' %}active{% endif %}"
                   href="?tab=all{% if search %}&search={{ search }}{% endif %}{% if campaign_filter %}&campaign={{ campaign_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">
                    <i class="fas fa-list me-2"></i>
                    {% trans "All" %}
                </a>
            </li>
        </ul>
    </div>

        <!-- Bulk Actions Bar -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <span class="text-muted">
                    {% trans "Showing" %} {{ page_obj.start_index }}-{{ page_obj.end_index }}
                    {% trans "of" %} {{ page_obj.paginator.count }} {% trans "donations" %}
                </span>
            </div>
            <div class="d-flex gap-2">
                <!-- Sorting -->
                <div class="dropdown">
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-sort me-1"></i>{% trans "Sort" %}
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="?{{ request.GET.urlencode }}&sort=-created_at">{% trans "Newest First" %}</a></li>
                        <li><a class="dropdown-item" href="?{{ request.GET.urlencode }}&sort=created_at">{% trans "Oldest First" %}</a></li>
                        <li><a class="dropdown-item" href="?{{ request.GET.urlencode }}&sort=-amount">{% trans "Highest Amount" %}</a></li>
                        <li><a class="dropdown-item" href="?{{ request.GET.urlencode }}&sort=amount">{% trans "Lowest Amount" %}</a></li>
                    </ul>
                </div>

                <!-- Bulk Actions -->
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-success btn-sm" onclick="bulkAction('completed')" disabled id="bulk-approve">
                        <i class="fas fa-check me-1"></i>{% trans "Approve Selected" %}
                    </button>
                    <button type="button" class="btn btn-danger btn-sm" onclick="bulkAction('failed')" disabled id="bulk-reject">
                        <i class="fas fa-times me-1"></i>{% trans "Reject Selected" %}
                    </button>
                </div>
            </div>
        </div>


        {% if page_obj %}
            <div class="table-responsive">
                <table class="table verification-table" id="donations-table">
                    <thead>
                        <tr>
                            <th style="width: 40px;">
                                <input type="checkbox" class="form-check-input" id="select-all-checkbox">
                            </th>
                            <th>{% trans "Donor" %}</th>
                            <th>{% trans "Campaign" %}</th>
                            <th>{% trans "Amount" %}</th>
                            <th>{% trans "Reference" %}</th>
                            <th>{% trans "Date" %}</th>
                            <th>{% trans "Status" %}</th>
                            <th>{% trans "Proof" %}</th>
                            <th>{% trans "Actions" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for donation in page_obj %}
                        <tr id="donation-{{ donation.pk }}" class="donation-row">
                            <td>
                                {% if current_tab == 'pending' %}
                                <input type="checkbox" class="form-check-input donation-checkbox" value="{{ donation.pk }}">
                                {% endif %}
                            </td>
                            <td>
                                <div class="donor-info">
                                        {% if donation.is_anonymous %}
                                            <span class="text-muted">{% trans "Anonymous" %}</span>
                                        {% elif donation.donor %}
                                        <div class="donor-name">{{ donation.donor.get_full_name }}</div>
                                        <div class="donor-email">{{ donation.donor.email }}</div>
                                        {% else %}
                                        <div class="donor-name">{{ donation.donor_name }}</div>
                                        <div class="donor-email">{{ donation.donor_email }}</div>
                                        {% endif %}
                                </div>
                            </td>
                            <td>
                                <span class="campaign-link">{{ donation.campaign.name|truncatechars:25 }}</span>
                            </td>
                            <td>
                                <span class="fw-bold" style="color: var(--feedback-success);">₱{{ donation.amount|intcomma }}</span>
                            </td>
                            <td>
                                <code class="small">{{ donation.reference_number }}</code>
                                {% if donation.gcash_transaction_id %}
                                <br><small class="text-muted">{{ donation.gcash_transaction_id }}</small>
                                {% endif %}
                            </td>
                            <td>
                                <span title="{{ donation.created_at }}">{{ donation.created_at|timesince }} {% trans "ago" %}</span>
                                {% if donation.verification_date %}
                                <br><small class="text-muted">{% trans "Verified:" %} {{ donation.verification_date|timesince }} {% trans "ago" %}</small>
                                {% endif %}
                            </td>
                            <td>
                                {% if donation.status == 'completed' %}
                                    <span class="status-badge status-completed">{{ donation.get_status_display }}</span>
                                {% elif donation.status == 'failed' %}
                                    <span class="status-badge status-failed">{{ donation.get_status_display }}</span>
                                {% elif donation.status == 'disputed' %}
                                    <span class="status-badge status-disputed">{{ donation.get_status_display }}</span>
                                {% elif donation.status == 'pending_verification' %}
                                    <span class="status-badge status-pending">{{ donation.get_status_display }}</span>
                                {% else %}
                                    <span class="status-badge" style="background: var(--text-muted); color: var(--text-light);">{{ donation.get_status_display }}</span>
                                {% endif %}
                                {% if donation.verified_by %}
                                <br><small class="text-muted">{% trans "by" %} {{ donation.verified_by.get_full_name }}</small>
                                {% endif %}
                            </td>
                            <td>
                                {% if donation.payment_proof %}
                                    <button class="btn-view-proof"
                                            onclick="viewProof('{{ donation.payment_proof.url }}', '{{ donation.reference_number }}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                {% else %}
                                    <span class="text-muted small">{% trans "No proof" %}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if donation.status == 'pending_verification' %}
                                <div class="btn-group" role="group">
                                    <button class="btn-approve"
                                            onclick="verifyDonation({{ donation.pk }}, 'completed')"
                                            title="{% trans 'Approve' %}">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button class="btn-reject"
                                            onclick="verifyDonation({{ donation.pk }}, 'failed')"
                                            title="{% trans 'Reject' %}">
                                        <i class="fas fa-times"></i>
                                    </button>
                                    <button class="btn-disputed"
                                            onclick="verifyDonation({{ donation.pk }}, 'disputed')"
                                            title="{% trans 'Mark as Disputed' %}">
                                        <i class="fas fa-question"></i>
                                    </button>
                                </div>
                                {% else %}
                                <span class="text-muted small">{% trans "No actions" %}</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            {% if page_obj.has_other_pages %}
        <div class="pagination-section">
            <nav aria-label="{% trans 'Donations pagination' %}">
                <ul class="pagination">
                    {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}">
                                <i class="fas fa-chevron-left"></i>
                            </a>
                        </li>
                    {% endif %}

                    {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                            <li class="page-item active">
                                <span class="page-link">{{ num }}</span>
                            </li>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ num }}{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}">{{ num }}</a>
                            </li>
                        {% endif %}
                    {% endfor %}

                    {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}">
                                <i class="fas fa-chevron-right"></i>
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
            </div>
        {% endif %}
                                {% else %}
        <div class="empty-state">
            <i class="fas fa-search"></i>
            <h3>{% trans "No donations found" %}</h3>
            <p>{% trans "Try adjusting your filters or search criteria." %}</p>
            </div>
        {% endif %}
</div>


<!-- Enhanced Image Modal -->
<div class="modal fade" id="proofModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-image me-2"></i>
                    {% trans "Payment Proof" %} - <span id="proofReference"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="proofImage" src="" alt="Payment Proof" class="img-fluid rounded shadow">
                <div class="mt-3">
                    <button class="btn btn-outline-primary" onclick="downloadProof()">
                        <i class="fas fa-download me-1"></i>{% trans "Download" %}
                    </button>
                    <button class="btn btn-outline-secondary" onclick="openInNewTab()">
                        <i class="fas fa-external-link-alt me-1"></i>{% trans "Open in New Tab" %}
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Action Modal -->
<div class="modal fade" id="bulkActionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-tasks me-2"></i>
                    {% trans "Bulk Action Confirmation" %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="bulkActionMessage"></p>
                <div class="mb-3">
                    <label for="bulkNotes" class="form-label">{% trans "Notes (Optional)" %}</label>
                    <textarea class="form-control" id="bulkNotes" rows="3" placeholder="{% trans 'Add notes for this bulk action...' %}"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                <button type="button" class="btn btn-primary" id="confirmBulkAction">{% trans "Confirm" %}</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Checkbox functionality
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const donationCheckboxes = document.querySelectorAll('.donation-checkbox');
    const bulkApproveBtn = document.getElementById('bulk-approve');
    const bulkRejectBtn = document.getElementById('bulk-reject');

    // Select all functionality
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            donationCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateBulkActionButtons();
        });
    }

    // Individual checkbox functionality
    donationCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateBulkActionButtons();
            updateSelectAllCheckbox();
        });
    });

    function updateBulkActionButtons() {
        const checkedBoxes = document.querySelectorAll('.donation-checkbox:checked');
        const hasSelection = checkedBoxes.length > 0;

        if (bulkApproveBtn) bulkApproveBtn.disabled = !hasSelection;
        if (bulkRejectBtn) bulkRejectBtn.disabled = !hasSelection;
    }

    function updateSelectAllCheckbox() {
        if (selectAllCheckbox) {
            const checkedCount = document.querySelectorAll('.donation-checkbox:checked').length;
            const totalCount = donationCheckboxes.length;

            selectAllCheckbox.checked = checkedCount === totalCount && totalCount > 0;
            selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < totalCount;
        }
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl+A to select all
        if (e.ctrlKey && e.key === 'a' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
            e.preventDefault();
            selectAll();
        }

        // Ctrl+D to deselect all
        if (e.ctrlKey && e.key === 'd') {
            e.preventDefault();
            selectNone();
        }

        // Ctrl+Enter to approve selected
        if (e.ctrlKey && e.key === 'Enter') {
            e.preventDefault();
            bulkAction('completed');
        }

        // Ctrl+Delete to reject selected
        if (e.ctrlKey && e.key === 'Delete') {
            e.preventDefault();
            bulkAction('failed');
        }
    });

    // Auto-refresh every 30 seconds
    setInterval(function() {
        // Only refresh if no modals are open and no checkboxes are selected
        const openModals = document.querySelectorAll('.modal.show');
        const selectedCheckboxes = document.querySelectorAll('.donation-checkbox:checked');

        if (openModals.length === 0 && selectedCheckboxes.length === 0) {
            // Subtle refresh indicator
            const refreshIndicator = document.createElement('div');
            refreshIndicator.className = 'position-fixed top-0 end-0 m-3 alert alert-info alert-dismissible fade show';
            refreshIndicator.innerHTML = '<i class="fas fa-sync-alt fa-spin me-2"></i>{% trans "Refreshing..." %}';
            document.body.appendChild(refreshIndicator);

            setTimeout(() => {
                location.reload();
            }, 1000);
        }
    }, 30000);
});

// Global variables for modal functionality
let currentProofUrl = '';
let currentBulkAction = '';
let selectedDonations = [];

function viewProof(imageUrl, referenceNumber) {
    currentProofUrl = imageUrl;
    document.getElementById('proofImage').src = imageUrl;
    document.getElementById('proofReference').textContent = referenceNumber || '';
    new bootstrap.Modal(document.getElementById('proofModal')).show();
}

function downloadProof() {
    if (currentProofUrl) {
        const link = document.createElement('a');
        link.href = currentProofUrl;
        link.download = 'payment_proof_' + Date.now() + '.jpg';
        link.click();
    }
}

function openInNewTab() {
    if (currentProofUrl) {
        window.open(currentProofUrl, '_blank');
    }
}

function selectAll() {
    const checkboxes = document.querySelectorAll('.donation-checkbox');
    checkboxes.forEach(checkbox => checkbox.checked = true);
    document.getElementById('select-all-checkbox').checked = true;
    updateBulkActionButtons();
}

function selectNone() {
    const checkboxes = document.querySelectorAll('.donation-checkbox');
    checkboxes.forEach(checkbox => checkbox.checked = false);
    document.getElementById('select-all-checkbox').checked = false;
    updateBulkActionButtons();
}

function clearFilters() {
    window.location.href = window.location.pathname;
}

function exportData() {
    const params = new URLSearchParams(window.location.search);
    params.set('export', 'csv');
    window.location.href = window.location.pathname + '?' + params.toString();
}

function bulkAction(action) {
    const checkedBoxes = document.querySelectorAll('.donation-checkbox:checked');
    if (checkedBoxes.length === 0) {
        Swal.fire({
            title: '{% trans "No Selection" %}',
            text: '{% trans "Please select at least one donation." %}',
            icon: 'warning',
            confirmButtonColor: '#ffc107'
        });
        return;
    }

    selectedDonations = Array.from(checkedBoxes).map(cb => cb.value);
    currentBulkAction = action;

    const actionText = action === 'completed' ? '{% trans "approve" %}' : '{% trans "reject" %}';
    const message = `{% trans "Are you sure you want to" %} ${actionText} ${selectedDonations.length} {% trans "selected donations?" %}`;

    document.getElementById('bulkActionMessage').textContent = message;
    document.getElementById('bulkNotes').value = '';

    const modal = new bootstrap.Modal(document.getElementById('bulkActionModal'));
    modal.show();

    document.getElementById('confirmBulkAction').onclick = function() {
        performBulkAction();
        modal.hide();
    };
}

function performBulkAction() {
    const notes = document.getElementById('bulkNotes').value;

    const formData = new FormData();
    formData.append('action', currentBulkAction);
    formData.append('donation_ids', JSON.stringify(selectedDonations));
    formData.append('notes', notes);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

    // Show loading state
    const loadingToast = showToast('{% trans "Processing bulk action..." %}', 'info', false);

    fetch('/donations/bulk-verify/', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        // Check if response is ok and content type is JSON
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Response is not JSON');
        }
        
        return response.json();
    })
    .then(data => {
        loadingToast.hide();
        if (data.status === 'success') {
            Swal.fire({
                title: '{% trans "Success!" %}',
                text: `{% trans "Successfully processed" %} ${data.processed_count} {% trans "donations" %}`,
                icon: 'success',
                confirmButtonColor: '#28a745',
                timer: 2000,
                showConfirmButton: true
            }).then(() => {
                location.reload();
            });
        } else {
            Swal.fire({
                title: '{% trans "Error" %}',
                text: data.message,
                icon: 'error',
                confirmButtonColor: '#dc3545'
            });
        }
    })
    .catch(error => {
        loadingToast.hide();
        console.error('Error:', error);
        Swal.fire({
            title: '{% trans "Error" %}',
            text: '{% trans "An error occurred. Please try again." %}',
            icon: 'error',
            confirmButtonColor: '#dc3545'
        });
    });
}

function verifyDonation(donationId, status) {
    const actionText = status === 'completed' ? '{% trans "approve" %}' : 
                      status === 'failed' ? '{% trans "reject" %}' : 
                      '{% trans "mark as disputed" %}';
    
    // Show SweetAlert confirmation with input for notes
    Swal.fire({
        title: `{% trans "Confirm" %} ${actionText}`,
        html: `
            <div class="text-start">
                <p class="mb-3">{% trans "Are you sure you want to" %} <strong>${actionText}</strong> {% trans "this donation?" %}</p>
                <div class="form-group">
                    <label for="verification-notes" class="form-label">{% trans "Verification Notes (Optional)" %}</label>
                    <textarea id="verification-notes" class="form-control" rows="3" 
                              placeholder="{% trans 'Add any notes about this verification...' %}"></textarea>
                </div>
            </div>
        `,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: `{% trans "Yes," %} ${actionText}`,
        cancelButtonText: '{% trans "Cancel" %}',
        confirmButtonColor: status === 'completed' ? '#28a745' : status === 'failed' ? '#dc3545' : '#ffc107',
        cancelButtonColor: '#6c757d',
        reverseButtons: true,
        preConfirm: () => {
            const notes = document.getElementById('verification-notes').value;
            return { notes: notes || '' };
        }
    }).then((result) => {
        if (result.isConfirmed) {
            const notes = result.value.notes;

    const formData = new FormData();
    formData.append('status', status);
            formData.append('verification_notes', notes);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

    // Show loading state on button
    const buttons = document.querySelectorAll(`#donation-${donationId} button`);
    buttons.forEach(btn => btn.disabled = true);

    fetch(`/donations/verify-donation/${donationId}/`, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        // Check if response is ok and content type is JSON
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Response is not JSON');
        }
        
        return response.json();
    })
    .then(data => {
        if (data.status === 'success') {
                    // Show success SweetAlert
                    Swal.fire({
                        title: '{% trans "Success!" %}',
                        text: `{% trans "Donation" %} ${actionText} {% trans "successfully" %}`,
                        icon: 'success',
                        confirmButtonColor: '#28a745',
                        timer: 2000,
                        showConfirmButton: true
                    });
                    
            // Remove row with animation
            const row = document.getElementById(`donation-${donationId}`);
            if (row) {
                row.style.transition = 'opacity 0.3s ease';
                row.style.opacity = '0';
                setTimeout(() => {
                    row.remove();
                    // Update counts
                    updateStatsCounts();
                }, 300);
            }
        } else {
            buttons.forEach(btn => btn.disabled = false);
                    Swal.fire({
                        title: '{% trans "Error" %}',
                        text: data.message,
                        icon: 'error',
                        confirmButtonColor: '#dc3545'
                    });
        }
    })
    .catch(error => {
        buttons.forEach(btn => btn.disabled = false);
        console.error('Error:', error);
                Swal.fire({
                    title: '{% trans "Error" %}',
                    text: '{% trans "An error occurred. Please try again." %}',
                    icon: 'error',
                    confirmButtonColor: '#dc3545'
                });
            });
        }
    });
}

function updateStatsCounts() {
    // Update the pending count badge
    const pendingBadge = document.querySelector('.nav-link[href*="tab=pending"] .badge');
    if (pendingBadge) {
        const currentCount = parseInt(pendingBadge.textContent);
        if (currentCount > 0) {
            pendingBadge.textContent = currentCount - 1;
        }
    }
}

function showToast(message, type = 'info', autoHide = true) {
    const toastContainer = document.getElementById('toast-container') || createToastContainer();

    const toastId = 'toast-' + Date.now();
    const bgClass = type === 'success' ? 'bg-success' : type === 'error' ? 'bg-danger' : 'bg-info';
    const icon = type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : 'info-circle';

    const toastHtml = `
        <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-${icon} me-2"></i>${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;

    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, { autohide: autoHide, delay: 5000 });

    toast.show();

    toastElement.addEventListener('hidden.bs.toast', function() {
        toastElement.remove();
    });

    return toast;
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toast-container';
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.style.zIndex = '9999';
    document.body.appendChild(container);
    return container;
}
</script>
{% endblock %}
