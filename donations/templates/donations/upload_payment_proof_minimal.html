{% extends 'donations/base_donation_form.html' %}
{% load static %}
{% load humanize %}
{% load i18n %}

{% block title %}{% trans "Upload Payment Proof" %} - NORSU Alumni{% endblock %}

{% block donation_header %}
<h1><i class="fas fa-upload me-2"></i>{% trans "Upload Payment Proof" %}</h1>
<p>{% trans "Submit your payment confirmation for verification." %}</p>
{% endblock %}

{% block donation_content %}
<!-- Progress Indicator -->
<div class="card mb-4">
    <div class="card-body py-3">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <div class="progress-step completed me-3">
                    <span class="step-number">1</span>
                </div>
                <div class="d-none d-md-block">
                    <small class="text-muted">{% trans "Donation Created" %}</small>
                </div>
            </div>

            <div class="progress-line completed flex-grow-1 mx-3"></div>

            <div class="d-flex align-items-center">
                <div class="progress-step completed me-3">
                    <span class="step-number">2</span>
                </div>
                <div class="d-none d-md-block">
                    <small class="text-muted">{% trans "Payment Made" %}</small>
                </div>
            </div>

            <div class="progress-line active flex-grow-1 mx-3"></div>

            <div class="d-flex align-items-center">
                <div class="progress-step active me-3">
                    <span class="step-number">3</span>
                </div>
                <div class="d-none d-md-block">
                    <small class="fw-bold text-primary">{% trans "Upload Proof" %}</small>
                </div>
            </div>

            <div class="progress-line flex-grow-1 mx-3"></div>

            <div class="d-flex align-items-center">
                <div class="progress-step">
                    <span class="step-number">4</span>
                </div>
                <div class="d-none d-md-block">
                    <small class="text-muted">{% trans "Verification" %}</small>
                </div>
            </div>
        </div>

        <!-- Mobile Progress Text -->
        <div class="d-md-none text-center mt-2">
            <small class="fw-bold text-primary">{% trans "Step 3 of 4: Upload Proof" %}</small>
        </div>
    </div>
</div>

<!-- Upload Form Card -->
<div class="card mb-4">
    <div class="card-header d-flex align-items-center">
        <h5 class="card-title mb-0">
            <i class="fas fa-upload me-2"></i>
            {% trans "Upload Payment Proof" %}
        </h5>
    </div>
    <div class="card-body">
        <!-- Donation Summary -->
        <div class="alert alert-info mb-4">
            <h5 class="alert-heading">{% trans "Donation Details" %}</h5>
            <hr>
            <div class="row">
                <div class="col-md-6">
                    <strong>{% trans "Campaign:" %}</strong> {{ donation.campaign.name }}<br>
                    <strong>{% trans "Amount:" %}</strong> â‚±{{ donation.amount|intcomma }}<br>
                </div>
                <div class="col-md-6">
                    <strong>{% trans "Reference Number:" %}</strong> 
                    <span class="badge bg-dark fs-6">{{ donation.reference_number }}</span><br>
                    <strong>{% trans "Status:" %}</strong> 
                    <span class="badge bg-warning">{{ donation.get_status_display }}</span>
                </div>
            </div>
        </div>

        <!-- Instructions -->
        <div class="alert alert-warning mb-4">
            <h6><i class="fas fa-info-circle me-2"></i>{% trans "Upload Instructions" %}</h6>
            <ul class="mb-0">
                <li>{% trans "Upload a clear screenshot of your GCash payment confirmation" %}</li>
                <li>{% trans "Make sure the amount, date, and reference number are visible" %}</li>
                <li>{% trans "Accepted formats: JPG, PNG (max 5MB)" %}</li>
                <li>{% trans "Your donation will be verified within 24 hours" %}</li>
            </ul>
        </div>

        <!-- Upload Form -->
        <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
            {% csrf_token %}
            
            {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {% for error in form.non_field_errors %}
                    {{ error }}
                {% endfor %}
            </div>
            {% endif %}
            
            <div class="mb-4">
                <label for="{{ form.payment_proof.id_for_label }}" class="form-label">
                    <strong>{% trans "Payment Screenshot" %} *</strong>
                </label>
                {{ form.payment_proof }}
                {% if form.payment_proof.help_text %}
                    <div class="form-text">{{ form.payment_proof.help_text }}</div>
                {% endif %}
                {% if form.payment_proof.errors %}
                    <div class="invalid-feedback d-block">
                        {% for error in form.payment_proof.errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                {% endif %}
            </div>

            <div class="mb-4">
                <label for="{{ form.gcash_transaction_id.id_for_label }}" class="form-label">
                    <strong>{% trans "GCash Transaction ID" %}</strong> 
                    <small class="text-muted">({% trans "Optional" %})</small>
                </label>
                {{ form.gcash_transaction_id }}
                {% if form.gcash_transaction_id.help_text %}
                    <div class="form-text">{{ form.gcash_transaction_id.help_text }}</div>
                {% endif %}
                {% if form.gcash_transaction_id.errors %}
                    <div class="invalid-feedback d-block">
                        {% for error in form.gcash_transaction_id.errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                {% endif %}
            </div>


            <!-- Hidden donor_email field for security -->
            {{ form.donor_email }}

            <!-- Preview Area -->
            <div id="imagePreview" class="mb-4" style="display: none;">
                <label class="form-label"><strong>{% trans "Preview" %}</strong></label>
                <div class="border rounded p-3 text-center">
                    <img id="previewImg" src="" alt="Preview" class="img-fluid" style="max-height: 300px;">
                </div>
            </div>

            <!-- Submit Buttons -->
            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-success btn-lg py-3" id="uploadBtn">
                    <i class="fas fa-upload me-2"></i>
                    <span class="fw-bold">{% trans "Upload Payment Proof" %}</span>
                    <div class="small mt-1">{% trans "Submit for verification" %}</div>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Navigation -->
<div class="text-center">
    <a href="{% url 'donations:payment_instructions' pk=donation.pk %}" class="btn btn-outline-secondary me-2">
        <i class="fas fa-arrow-left me-2"></i>{% trans "Back to Instructions" %}
    </a>
    <a href="{% url 'donations:campaign_detail' slug=donation.campaign.slug %}" class="btn btn-outline-primary">
        <i class="fas fa-home me-2"></i>{% trans "Back to Campaign" %}
    </a>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('id_payment_proof');
    const imagePreview = document.getElementById('imagePreview');
    const previewImg = document.getElementById('previewImg');
    const uploadBtn = document.getElementById('uploadBtn');
    const form = document.querySelector('.needs-validation');

    // File input validation and preview
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Check file size (5MB limit)
                if (file.size > 5 * 1024 * 1024) {
                    Swal.fire({
                        title: 'File Too Large',
                        text: 'Please select a file smaller than 5MB',
                        icon: 'error',
                        confirmButtonColor: '#2b3c6b'
                    });
                    fileInput.value = '';
                    imagePreview.style.display = 'none';
                    return;
                }

                // Check file type
                const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
                if (!allowedTypes.includes(file.type)) {
                    Swal.fire({
                        title: 'Invalid File Type',
                        text: 'Please select a JPG, PNG, or GIF image file',
                        icon: 'error',
                        confirmButtonColor: '#2b3c6b'
                    });
                    fileInput.value = '';
                    imagePreview.style.display = 'none';
                    return;
                }

                // Show preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    imagePreview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                imagePreview.style.display = 'none';
            }
        });
    }

    // Form validation
    if (form) {
        form.addEventListener('submit', function(e) {
            if (!form.checkValidity()) {
                e.preventDefault();
                e.stopPropagation();
            }
            form.classList.add('was-validated');
        });
    }

    // Form submission with AJAX and SweetAlert
    if (form && uploadBtn) {
        form.addEventListener('submit', function(e) {
            e.preventDefault(); // Prevent default form submission
            
            console.log('Form submit event triggered');
            console.log('Form validity:', form.checkValidity());
            
            if (!form.checkValidity()) {
                console.log('Form is invalid, preventing submission');
                form.classList.add('was-validated');
                return;
            }
            
            console.log('Form is valid, submitting via AJAX');
            
            // Show loading state
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Uploading...';
            
            // Prepare form data
            const formData = new FormData(form);
            console.log('Form data:', formData);
            
            // Submit via AJAX
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error('Response is not JSON');
                }
                
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                
                if (data.success) {
                    // Show success SweetAlert
                    Swal.fire({
                        title: 'ðŸŽ‰ Donation Submitted Successfully!',
                        html: `
                            <div class="text-center">
                                <i class="fas fa-check-circle text-success mb-3" style="font-size: 4rem;"></i>
                                <p class="mb-3">${data.message}</p>
                                <div class="alert alert-info">
                                    <strong>Thank you for your generous donation!</strong><br>
                                    Your contribution makes a real difference in our community.
                                </div>
                                <p class="text-muted small">
                                    You will receive an email confirmation once your donation is verified.<br>
                                    <strong>You will be redirected to our events page to explore more opportunities to help.</strong>
                                </p>
                            </div>
                        `,
                        icon: 'success',
                        confirmButtonText: 'View Events',
                        confirmButtonColor: '#2b3c6b',
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        showConfirmButton: true,
                        timer: null
                    }).then(() => {
                        // Redirect to confirmation page
                        if (data.redirect_url) {
                            window.location.href = data.redirect_url;
                        } else {
                            window.location.reload();
                        }
                    });
                } else {
                    // Show error SweetAlert
                    Swal.fire({
                        title: 'Upload Failed',
                        text: data.message || 'Please try again',
                        icon: 'error',
                        confirmButtonColor: '#2b3c6b'
                    });
                    
                    // Reset button
                    uploadBtn.disabled = false;
                    uploadBtn.innerHTML = '<i class="fas fa-upload me-2"></i><span class="fw-bold">Upload Payment Proof</span><div class="small mt-1">Submit for verification</div>';
                }
            })
            .catch(error => {
                console.error('Upload error:', error);
                
                // Show error SweetAlert
                Swal.fire({
                    title: 'Upload Failed',
                    text: 'An error occurred while uploading. Please try again.',
                    icon: 'error',
                    confirmButtonColor: '#2b3c6b'
                });
                
                // Reset button
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = '<i class="fas fa-upload me-2"></i><span class="fw-bold">Upload Payment Proof</span><div class="small mt-1">Submit for verification</div>';
            });
        });
    }
});
</script>
{% endblock %}