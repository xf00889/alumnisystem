{% extends 'donations/base_donations.html' %}
{% load static %}
{% load humanize %}
{% load i18n %}

{% block title %}{% trans "Upload Payment Proof" %} - NORSU Alumni{% endblock %}

{% block page_header %}{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="{% url 'donations:campaign_list' %}">{% trans "Campaigns" %}</a></li>
<li class="breadcrumb-item"><a href="{% url 'donations:campaign_detail' slug=donation.campaign.slug %}">{{ donation.campaign.name }}</a></li>
<li class="breadcrumb-item"><a href="{% url 'donations:payment_instructions' pk=donation.pk %}">{% trans "Payment Instructions" %}</a></li>
<li class="breadcrumb-item active">{% trans "Upload Proof" %}</li>
{% endblock %}

{% block donations_content %}
<div class="col-12">
  <!-- Welcome Header -->
  <div class="welcome-header mt-3">
    <div class="d-flex align-items-center justify-content-between">
      <div>
        <h4>{% trans "Upload Payment Proof" %}</h4>
        <p>{% trans "Submit your payment confirmation for verification." %}</p>
      </div>
      <div>
        <a href="{% url 'donations:payment_instructions' pk=donation.pk %}" class="btn btn-outline-light btn-sm">
          <i class="fas fa-arrow-left me-2"></i>{% trans "Back to Instructions" %}
        </a>
      </div>
    </div>
  </div>

  <!-- Progress Indicator -->
  <div class="row mb-4">
    <div class="col-12">
        <div class="dashboard-card">
            <div class="card-body py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <div class="progress-step completed me-3">
                            <span class="step-number">1</span>
                        </div>
                        <div class="d-none d-md-block">
                            <small class="text-muted">{% trans "Donation Created" %}</small>
                        </div>
                    </div>

                    <div class="progress-line completed flex-grow-1 mx-3"></div>

                    <div class="d-flex align-items-center">
                        <div class="progress-step completed me-3">
                            <span class="step-number">2</span>
                        </div>
                        <div class="d-none d-md-block">
                            <small class="text-muted">{% trans "Payment Made" %}</small>
                        </div>
                    </div>

                    <div class="progress-line flex-grow-1 mx-3"></div>

                    <div class="d-flex align-items-center">
                        <div class="progress-step active me-3">
                            <span class="step-number">3</span>
                        </div>
                        <div class="d-none d-md-block">
                            <small class="fw-bold text-primary">{% trans "Upload Proof" %}</small>
                        </div>
                    </div>

                    <div class="progress-line flex-grow-1 mx-3"></div>

                    <div class="d-flex align-items-center">
                        <div class="progress-step">
                            <span class="step-number">4</span>
                        </div>
                        <div class="d-none d-md-block">
                            <small class="text-muted">{% trans "Verification" %}</small>
                        </div>
                    </div>
                </div>

                <!-- Mobile Progress Text -->
                <div class="d-md-none text-center mt-2">
                    <small class="fw-bold text-primary">{% trans "Step 3 of 4: Upload Proof" %}</small>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="dashboard-card">
            <div class="card-header d-flex align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-upload me-2"></i>
                    {% trans "Upload Payment Proof" %}
                </h5>
            </div>
            <div class="card-body">
                <!-- Donation Summary -->
                <div class="alert alert-info mb-4">
                    <h5 class="alert-heading">{% trans "Donation Details" %}</h5>
                    <hr>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>{% trans "Campaign:" %}</strong> {{ donation.campaign.name }}<br>
                            <strong>{% trans "Amount:" %}</strong> â‚±{{ donation.amount|intcomma }}<br>
                        </div>
                        <div class="col-md-6">
                            <strong>{% trans "Status:" %}</strong> 
                            <span class="badge bg-warning">{{ donation.get_status_display }}</span>
                        </div>
                    </div>
                </div>

                <!-- Instructions -->
                <div class="alert alert-warning mb-4">
                    <h6><i class="fas fa-info-circle me-2"></i>{% trans "Upload Instructions" %}</h6>
                    <ul class="mb-0">
                        <li>{% trans "Upload a clear screenshot of your GCash payment confirmation" %}</li>
                        <li>{% trans "Make sure the amount, date, and reference number are visible" %}</li>
                        <li>{% trans "Accepted formats: JPG, PNG (max 5MB)" %}</li>
                        <li>{% trans "Your donation will be verified within 24 hours" %}</li>
                    </ul>
                </div>

                <!-- Upload Form -->
                <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
                    {% csrf_token %}
                    
                    <div class="mb-4">
                        <label for="{{ form.payment_proof.id_for_label }}" class="form-label">
                            <strong>{% trans "Payment Screenshot" %} *</strong>
                        </label>
                        {{ form.payment_proof }}
                        {% if form.payment_proof.help_text %}
                            <div class="form-text">{{ form.payment_proof.help_text }}</div>
                        {% endif %}
                        {% if form.payment_proof.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.payment_proof.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="mb-4">
                        <label for="{{ form.reference_number.id_for_label }}" class="form-label">
                            <strong>{% trans "Reference Number" %} *</strong>
                            <i class="fas fa-info-circle text-muted ms-1"
                               data-bs-toggle="tooltip"
                               data-bs-placement="top"
                               title="{% trans 'Enter your GCash transaction reference number (required)' %}"></i>
                        </label>
                        {{ form.reference_number }}
                        {% if form.reference_number.help_text %}
                            <div class="form-text">{{ form.reference_number.help_text }}</div>
                        {% endif %}
                        {% if form.reference_number.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.reference_number.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Preview Area -->
                    <div id="imagePreview" class="mb-4" style="display: none;">
                        <label class="form-label"><strong>{% trans "Preview" %}</strong></label>
                        <div class="border rounded p-3 text-center">
                            <img id="previewImg" src="" alt="Preview" class="img-fluid" style="max-height: 300px;">
                        </div>
                    </div>

                    <!-- Submit Buttons -->
                    <div class="text-center">
                        <button type="submit" class="btn btn-primary btn-lg me-3">
                            <i class="fas fa-upload me-2"></i>
                            {% trans "Submit Payment Proof" %}
                        </button>
                        <a href="{% url 'donations:payment_instructions' pk=donation.pk %}" 
                           class="btn btn-outline-primary">
                            <i class="fas fa-arrow-left me-2"></i>
                            {% trans "Back to Instructions" %}
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('{{ form.payment_proof.id_for_label }}');
    const imagePreview = document.getElementById('imagePreview');
    const previewImg = document.getElementById('previewImg');

    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            // Check file size (5MB limit)
            if (file.size > 5 * 1024 * 1024) {
                Swal.fire({
                    title: '{% trans "File Too Large" %}',
                    text: '{% trans "Please select a file smaller than 5MB" %}',
                    icon: 'error',
                    confirmButtonColor: '#2b3c6b'
                });
                fileInput.value = '';
                imagePreview.style.display = 'none';
                return;
            }

            // Check file type
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
            if (!allowedTypes.includes(file.type)) {
                Swal.fire({
                    title: '{% trans "Invalid File Type" %}',
                    text: '{% trans "Please select a JPG, PNG, or GIF image file" %}',
                    icon: 'error',
                    confirmButtonColor: '#2b3c6b'
                });
                fileInput.value = '';
                imagePreview.style.display = 'none';
                return;
            }

            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImg.src = e.target.result;
                imagePreview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else {
            imagePreview.style.display = 'none';
        }
    });

    // Form validation and submission
    const form = document.querySelector('.needs-validation');
    const submitBtn = form.querySelector('button[type="submit"]');
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!form.checkValidity()) {
            form.classList.add('was-validated');
            return;
        }
        
        // Get form data for confirmation
        const formData = new FormData(form);
        const paymentProof = formData.get('payment_proof');
        const referenceNumber = formData.get('reference_number') || 'Not provided';
        const fileName = paymentProof ? paymentProof.name : 'No file selected';
        
        // Show SweetAlert confirmation
        Swal.fire({
            title: '{% trans "Confirm Payment Proof Upload" %}',
            html: `
                <div class="text-start">
                    <div class="alert alert-info mb-3">
                        <h6 class="alert-heading">{% trans "Upload Summary" %}</h6>
                        <hr>
                        <p class="mb-1"><strong>{% trans "File:" %}</strong> ${fileName}</p>
                        <p class="mb-1"><strong>{% trans "Reference Number:" %}</strong> ${referenceNumber}</p>
                        <p class="mb-0"><strong>{% trans "Status:" %}</strong> {% trans "Pending Verification" %}</p>
                    </div>
                    <p class="text-muted small">
                        {% trans "Please review your payment proof details above. Once submitted, your donation will be queued for verification within 24 hours." %}
                    </p>
                </div>
            `,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: '{% trans "Yes, Upload Payment Proof" %}',
            cancelButtonText: '{% trans "Cancel" %}',
            confirmButtonColor: '#2b3c6b',
            cancelButtonColor: '#6c757d',
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                // Disable submit button and show loading state
                submitBtn.disabled = true;
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>{% trans "Uploading..." %}';
                
                // Send AJAX request
                fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Response data:', data);
                    
                    if (data.success) {
                        // Show success SweetAlert
                        Swal.fire({
                            title: 'ðŸŽ‰ Payment Proof Uploaded Successfully!',
                            html: `
                                <div class="text-center">
                                    <i class="fas fa-check-circle text-success mb-3" style="font-size: 4rem;"></i>
                                    <p class="mb-3">${data.message}</p>
                                    <div class="alert alert-info">
                                        <strong>Thank you for your generous donation!</strong><br>
                                        Your contribution makes a real difference in our community.
                                    </div>
                                    <p class="text-muted small">
                                        Your donation will be verified within 24 hours.<br>
                                        <strong>You will receive an email confirmation once verified.</strong>
                                    </p>
                                </div>
                            `,
                            icon: 'success',
                            confirmButtonText: '{% trans "Continue" %}',
                            confirmButtonColor: '#2b3c6b',
                            allowOutsideClick: false,
                            allowEscapeKey: false,
                            showConfirmButton: true,
                            timer: null
                        }).then(() => {
                            // Redirect to confirmation page
                            if (data.redirect_url) {
                                window.location.href = data.redirect_url;
                            } else {
                                window.location.reload();
                            }
                        });
                    } else {
                        // Show error SweetAlert
                        Swal.fire({
                            title: '{% trans "Upload Failed" %}',
                            text: data.message || '{% trans "Please try again" %}',
                            icon: 'error',
                            confirmButtonColor: '#2b3c6b'
                        });
                        
                        // Reset button
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                    }
                })
                .catch(error => {
                    console.error('Upload error:', error);
                    
                    // Show error SweetAlert
                    Swal.fire({
                        title: '{% trans "Upload Failed" %}',
                        text: '{% trans "An error occurred while uploading. Please try again." %}',
                        icon: 'error',
                        confirmButtonColor: '#2b3c6b'
                    });
                    
                    // Reset button
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                });
            }
        });
    });
});
</script>
{% endblock %}
