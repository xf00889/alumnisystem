{% extends 'donations/base_donations.html' %}
{% load static %}
{% load humanize %}
{% load i18n %}

{% block title %}{% trans "Upload Payment Proof" %} - NORSU Alumni{% endblock %}

{% block page_header %}{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="{% url 'donations:campaign_list' %}">{% trans "Campaigns" %}</a></li>
<li class="breadcrumb-item"><a href="{% url 'donations:campaign_detail' slug=donation.campaign.slug %}">{{ donation.campaign.name }}</a></li>
<li class="breadcrumb-item"><a href="{% url 'donations:payment_instructions' pk=donation.pk %}">{% trans "Payment Instructions" %}</a></li>
<li class="breadcrumb-item active">{% trans "Upload Proof" %}</li>
{% endblock %}

{% block donations_content %}
<div class="col-12">
  <!-- Welcome Header -->
  <div class="welcome-header mt-3">
    <div class="d-flex align-items-center justify-content-between">
      <div>
        <h4>{% trans "Upload Payment Proof" %}</h4>
        <p>{% trans "Submit your payment confirmation for verification." %}</p>
      </div>
      <div>
        <a href="{% url 'donations:payment_instructions' pk=donation.pk %}" class="btn btn-outline-light btn-sm">
          <i class="fas fa-arrow-left me-2"></i>{% trans "Back to Instructions" %}
        </a>
      </div>
    </div>
  </div>

  <!-- Progress Indicator -->
  <div class="row mb-4">
    <div class="col-12">
        <div class="dashboard-card">
            <div class="card-body py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <div class="progress-step completed me-3">
                            <span class="step-number">1</span>
                        </div>
                        <div class="d-none d-md-block">
                            <small class="text-muted">{% trans "Donation Created" %}</small>
                        </div>
                    </div>

                    <div class="progress-line completed flex-grow-1 mx-3"></div>

                    <div class="d-flex align-items-center">
                        <div class="progress-step completed me-3">
                            <span class="step-number">2</span>
                        </div>
                        <div class="d-none d-md-block">
                            <small class="text-muted">{% trans "Payment Made" %}</small>
                        </div>
                    </div>

                    <div class="progress-line flex-grow-1 mx-3"></div>

                    <div class="d-flex align-items-center">
                        <div class="progress-step active me-3">
                            <span class="step-number">3</span>
                        </div>
                        <div class="d-none d-md-block">
                            <small class="fw-bold text-primary">{% trans "Upload Proof" %}</small>
                        </div>
                    </div>

                    <div class="progress-line flex-grow-1 mx-3"></div>

                    <div class="d-flex align-items-center">
                        <div class="progress-step">
                            <span class="step-number">4</span>
                        </div>
                        <div class="d-none d-md-block">
                            <small class="text-muted">{% trans "Verification" %}</small>
                        </div>
                    </div>
                </div>

                <!-- Mobile Progress Text -->
                <div class="d-md-none text-center mt-2">
                    <small class="fw-bold text-primary">{% trans "Step 3 of 4: Upload Proof" %}</small>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="dashboard-card">
            <div class="card-header d-flex align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-upload me-2"></i>
                    {% trans "Upload Payment Proof" %}
                </h5>
            </div>
            <div class="card-body">
                <!-- Donation Summary -->
                <div class="alert alert-info mb-4">
                    <h5 class="alert-heading">{% trans "Donation Details" %}</h5>
                    <hr>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>{% trans "Campaign:" %}</strong> {{ donation.campaign.name }}<br>
                            <strong>{% trans "Amount:" %}</strong> â‚±{{ donation.amount|intcomma }}<br>
                        </div>
                        <div class="col-md-6">
                            <strong>{% trans "Reference Number:" %}</strong> 
                            <span class="badge bg-dark fs-6">{{ donation.reference_number }}</span><br>
                            <strong>{% trans "Status:" %}</strong> 
                            <span class="badge bg-warning">{{ donation.get_status_display }}</span>
                        </div>
                    </div>
                </div>

                <!-- Instructions -->
                <div class="alert alert-warning mb-4">
                    <h6><i class="fas fa-info-circle me-2"></i>{% trans "Upload Instructions" %}</h6>
                    <ul class="mb-0">
                        <li>{% trans "Upload a clear screenshot of your GCash payment confirmation" %}</li>
                        <li>{% trans "Make sure the amount, date, and reference number are visible" %}</li>
                        <li>{% trans "Accepted formats: JPG, PNG (max 5MB)" %}</li>
                        <li>{% trans "Your donation will be verified within 24 hours" %}</li>
                    </ul>
                </div>

                <!-- Upload Form -->
                <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
                    {% csrf_token %}
                    
                    <div class="mb-4">
                        <label for="{{ form.payment_proof.id_for_label }}" class="form-label">
                            <strong>{% trans "Payment Screenshot" %} *</strong>
                        </label>
                        {{ form.payment_proof }}
                        {% if form.payment_proof.help_text %}
                            <div class="form-text">{{ form.payment_proof.help_text }}</div>
                        {% endif %}
                        {% if form.payment_proof.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.payment_proof.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="mb-4">
                        <label for="{{ form.gcash_transaction_id.id_for_label }}" class="form-label">
                            <strong>{% trans "GCash Transaction ID" %}</strong> 
                            <small class="text-muted">({% trans "Optional" %})</small>
                        </label>
                        {{ form.gcash_transaction_id }}
                        {% if form.gcash_transaction_id.help_text %}
                            <div class="form-text">{{ form.gcash_transaction_id.help_text }}</div>
                        {% endif %}
                        {% if form.gcash_transaction_id.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.gcash_transaction_id.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Preview Area -->
                    <div id="imagePreview" class="mb-4" style="display: none;">
                        <label class="form-label"><strong>{% trans "Preview" %}</strong></label>
                        <div class="border rounded p-3 text-center">
                            <img id="previewImg" src="" alt="Preview" class="img-fluid" style="max-height: 300px;">
                        </div>
                    </div>

                    <!-- Submit Buttons -->
                    <div class="text-center">
                        <button type="submit" class="btn btn-primary btn-lg me-3">
                            <i class="fas fa-upload me-2"></i>
                            {% trans "Submit Payment Proof" %}
                        </button>
                        <a href="{% url 'donations:payment_instructions' pk=donation.pk %}" 
                           class="btn btn-outline-primary">
                            <i class="fas fa-arrow-left me-2"></i>
                            {% trans "Back to Instructions" %}
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('{{ form.payment_proof.id_for_label }}');
    const imagePreview = document.getElementById('imagePreview');
    const previewImg = document.getElementById('previewImg');

    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            // Check file size (5MB limit)
            if (file.size > 5 * 1024 * 1024) {
                alert('{% trans "File size must be less than 5MB." %}');
                fileInput.value = '';
                imagePreview.style.display = 'none';
                return;
            }

            // Check file type
            if (!file.type.startsWith('image/')) {
                alert('{% trans "Please select an image file." %}');
                fileInput.value = '';
                imagePreview.style.display = 'none';
                return;
            }

            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImg.src = e.target.result;
                imagePreview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else {
            imagePreview.style.display = 'none';
        }
    });

    // Form validation
    const form = document.querySelector('.needs-validation');
    form.addEventListener('submit', function(e) {
        if (!form.checkValidity()) {
            e.preventDefault();
            e.stopPropagation();
        }
        form.classList.add('was-validated');
    });
});
</script>
{% endblock %}
